<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Leo's notes</title><meta name="author" content="Leo Liu"><meta name="copyright" content="Leo Liu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="Leo&#39;s notes">
<meta property="og:url" content="https://liule8.github.io/page/29/index.html">
<meta property="og:site_name" content="Leo&#39;s notes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liule8.github.io/images/avatar.png">
<meta property="article:author" content="Leo Liu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liule8.github.io/images/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liule8.github.io/page/29/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2021-11-21 12:44:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">404</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">84</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">51</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Leo's notes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Leo's notes</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://github.com/LIULE8" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:leo.liu.scau@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/3184b070.html" title="MySQL实战宝典之表结构-非结构存储">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL实战宝典之表结构-非结构存储"></a></div><div class="recent-post-info"><a class="article-title" href="/post/3184b070.html" title="MySQL实战宝典之表结构-非结构存储">MySQL实战宝典之表结构-非结构存储</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-23T13:08:32.000Z" title="发表于 2021-08-23 13:08:32">2021-08-23</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></span></div><div class="content">非结构存储：用好 JSON 这张牌
MySQL 数据库中常见的 3 种类型：数字类型、字符串类型和日期类型。然而，它们都属于传统关系型设计的范畴。
关系型的结构化存储存在一定的弊端，因为它需要预先定义好所有的列以及列对应的类型。但是业务在发展过程中，或许需要扩展单个列的描述功能，这时，如果能用好 JSON 数据类型，那就能打通关系型和非关系型数据的存储之间的界限，为业务提供更好的架构选择。
当然，很多同学在用 JSON 数据类型时会遇到各种各样的问题，其中最容易犯的误区就是将类型 JSON 简单理解成字符串类型。
JSON 数据类型
JSON（JavaScript Object Notation）主要用于互联网应用服务之间的数据交换。MySQL 支持RFC 7159定义的 JSON 规范，主要有JSON 对象和JSON 数组两种类型。下面就是 JSON 对象，主要用来存储图片的相关信息：
12345678910111213&#123; &quot;Image&quot;: &#123;   &quot;Width&quot;: 800,   &quot;Height&quot;: 60 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/1b2b8e94.html" title="ConcurrentHashMap源码">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ConcurrentHashMap源码"></a></div><div class="recent-post-info"><a class="article-title" href="/post/1b2b8e94.html" title="ConcurrentHashMap源码">ConcurrentHashMap源码</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-23T09:44:19.000Z" title="发表于 2021-08-23 09:44:19">2021-08-23</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E5%B9%B6%E5%8F%91/">并发</a></span></div><div class="content">12345678910111213141516171819202122/** * 支持检索和的完全并发的哈希表，并且期望有高并发性的更新。这个类遵循与&#123;@link java.util.Hashtable&#125;相同的功能规范，并包含与 &#123;@code * Hashtable&#125;每个方法相对应的方法版本。然而，即使所有操作都是线程安全的，检索操作也不需要锁定，而且不支持以阻止所有访问的方式锁定整个表。 * 在依赖于其线程安全而不是其同步细节的程序中，这个类与 &#123;@code Hashtable&#125; 完全可互操作。 * * &lt;p&gt;检索操作(包括&#123;@code get&#125;)通常不会阻塞，因此可能会与更新操作(包括&#123;@code put&#125;和&#123;@code remove&#125;)重叠。 * 检索反映最近完成的更新操作在开始时所持有的结果。(更正式地说，对给定键的更新操作与对该键的任何(非空)检索报告更新值的happens-before关系。 * 对于聚合操作，如&#123;@code putA ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/961b2abb.html" title="RESTful会被新版GraphQL干掉吗？">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RESTful会被新版GraphQL干掉吗？"></a></div><div class="recent-post-info"><a class="article-title" href="/post/961b2abb.html" title="RESTful会被新版GraphQL干掉吗？">RESTful会被新版GraphQL干掉吗？</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-21T14:28:13.000Z" title="发表于 2021-08-21 14:28:13">2021-08-21</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right"></i><a class="article-meta__categories" href="/categories/Spring/Spring-GraphQL/">Spring GraphQL</a></span></div><div class="content">RESTful会被新版GraphQL干掉吗？
Spring 社区正式宣布 Spring GraphQL 成为其家族的顶级项目，并发布了 1.0 里程碑版本。

而此时也正逢 GraphQL Java 诞生 6 周年，可以说 Spring GraphQL 的核心价值便是将 GraphQL Java 集成到了 Spring 生态中。

一直以来，都少不了 GraphQL 与 RESTful 这两种前后端交互 Web API 的对比讨论。那么在新模式下，RESTful 会被这个新版 GraphQL 超越甚至替代吗？会为你接下来的工作、业务带来新变化吗？
想要 GraphQL 落地，就需要采用对应的开发框架。将基于 Spring GraphQL 这款崭新的开发框架，给出精简而又完整的原创性案例代码，并展示其开发流程和实战技巧，而这些代码完全可以直接应用到你的日常开发中。
新版 GraphQL：从 Java 走向 Spring
我们知道，GraphQL 是一种理念和规范，它并不直接提供开发工具和框架。
而 GraphQL Java 是基于 Java 开发的一个 GraphQL 实现库，但这个实现 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/f9c8ec75.html" title="MySQL实战宝典之表结构-日期类型">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL实战宝典之表结构-日期类型"></a></div><div class="recent-post-info"><a class="article-title" href="/post/f9c8ec75.html" title="MySQL实战宝典之表结构-日期类型">MySQL实战宝典之表结构-日期类型</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-20T13:50:00.000Z" title="发表于 2021-08-20 13:50:00">2021-08-20</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></span></div><div class="content">日期类型：TIMESTAMP 可能是巨坑
几乎每张业务表都带有一个日期列，用于记录每条记录产生和变更的时间。比如用户表会有一个日期列记录用户注册的时间、用户最后登录的时间。又比如，电商行业中的订单表（核心业务表）会有一个订单产生的时间列，当支付时间超过订单产生的时间，这个订单可能会被系统自动取消。
日期类型虽然常见，但在表结构设计中也容易犯错，比如很多开发同学都倾向使用整型存储日期类型，同时也会忽略不同日期类型对于性能可能存在的潜在影响。所以有必要认真学习，举一反三，在自己的业务中做好日期类型的设计。
日期类型
MySQL 数据库中常见的日期类型有 YEAR、DATE、TIME、DATETIME、TIMESTAMEP。因为业务绝大部分场景都需要将日期精确到秒，所以在表结构设计中，常见使用的日期类型为DATETIME 和 TIMESTAMP。接下来，我就带你深入了解这两种类型，以及它们在设计中的应用实战。
DATETIME
类型 DATETIME 最终展现的形式为：YYYY-MM-DD HH：MM：SS，固定占用 8 个字节。
从 MySQL 5.6 版本开始，DATETIME 类型支持 ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/f174740f.html" title="ConcurrentHashMap面试指南">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ConcurrentHashMap面试指南"></a></div><div class="recent-post-info"><a class="article-title" href="/post/f174740f.html" title="ConcurrentHashMap面试指南">ConcurrentHashMap面试指南</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-20T11:55:48.000Z" title="发表于 2021-08-20 11:55:48">2021-08-20</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E5%B9%B6%E5%8F%91/">并发</a></span></div><div class="content">ConcurrentHashMap面试指南

ConcurrentHashMap涉及的知识点：HashMap，HashTable，UnSafe，CAS，数组+链表，Segment，ReentrantLock（非公平锁，公平锁），红黑树。

大多数程序员都是业务开发者，在面试官眼里，如果没有 3 到 5 年的开发经验，未必能围绕底层源码，全面掌握并展示线程和排查 OOM 问题等技能。但如果求职者能够通过 ConcurrentHashMap 这个切入点全面展示技能，那么就能很大程度上提升面试成功的可能性。
接下来，就从底层源码和技术面试这两个角度，全面分析下 ConcurrentHashMap 对象。
首先会通过底层源码，从线程并发角度，分析读写 ConcurrentHashMap 对象的详细做法，然后，在此基础上教你如何在面试中展示这方面的亮点；不仅如此，还会教你在面试中展示“通过分析源码排查 OOM 问题”的说辞。
先看数据结构，其中包含面试必问点 volatile
ConcurrentHashMap 是以键值对的形式存储数据，在 JDK 1.8 及之上的版本里，ConcurrentH ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/9536ebb4.html" title="MySQL实战宝典之表结构-字符串类型">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL实战宝典之表结构-字符串类型"></a></div><div class="recent-post-info"><a class="article-title" href="/post/9536ebb4.html" title="MySQL实战宝典之表结构-字符串类型">MySQL实战宝典之表结构-字符串类型</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-19T09:58:03.000Z" title="发表于 2021-08-19 09:58:03">2021-08-19</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></span></div><div class="content">字符串类型：不能忽略的 COLLATION
字符串类型在表结构设计时也比较常见，它通常用于描述具体的信息。
MySQL 数据库的字符串类型有 CHAR、VARCHAR、BINARY、BLOB、TEXT、ENUM、SET。不同的类型在业务设计、数据库性能方面的表现完全不同，其中最常使用的是 CHAR、VARCHAR。
CHAR 和 VARCHAR 的定义
CHAR(N) 用来保存固定长度的字符，N 的范围是 0 ~ 255，请牢记，N 表示的是字符，而不是字节。VARCHAR(N) 用来保存变长字符，N 的范围为 0 ~ 65536， N 表示字符。
在超出 65536 个字符的情况下，可以考虑使用更大的字符类型 TEXT 或 BLOB，两者最大存储长度为 4G，其区别是 BLOB 没有字符集属性，纯属二进制存储。
和 Oracle、Microsoft SQL Server 等传统关系型数据库不同的是，MySQL 数据库的 VARCHAR 字符类型，最大能够存储 65536 个字符，所以在 MySQL 数据库下，绝大部分场景使用类型 VARCHAR 就足够了。
字符集
在表结构设计中，除 ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/23263e59.html" title="MySQL实战宝典之表结构-数字类型">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL实战宝典之表结构-数字类型"></a></div><div class="recent-post-info"><a class="article-title" href="/post/23263e59.html" title="MySQL实战宝典之表结构-数字类型">MySQL实战宝典之表结构-数字类型</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-18T13:04:30.000Z" title="发表于 2021-08-18 13:04:30">2021-08-18</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><i class="fas fa-angle-right"></i><a class="article-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/">MySQL</a></span></div><div class="content">数字类型：避免自增踩坑
在进行表结构设计时，数字类型是最为常见的类型之一，但要用好数字类型并不如想象得那么简单，比如：


怎么设计一个互联网海量并发业务的自增主键？用 INT 就够了？


怎么设计账户的余额？用 DECIMAL 类型就万无一失了吗？


以上全错！
数字类型看似简单，但在表结构架构设计中很容易出现上述“设计上思考不全面”的问题（特别是在海量并发的互联网场景下）。
数字类型
整型类型
MySQL 数据库支持 SQL 标准支持的整型类型：INT、SMALLINT。此外，MySQL 数据库也支持诸如 TINYINT、MEDIUMINT 和 BIGINT 整型类型（表 1 显示了各种整型所占用的存储空间及取值范围）：



类型
占用空间
最小值 - 最大值【signed】
最小值 - 最大值 【unsigned】




TINYINT
1
-128 ~ 127
0 ~ 255


SMALLINT
2
-32768 ~ 32767
0 ~ 65535


MEDIUMINT
3
-8388608 ~ 8388607
0 ~ 16777215


INT
4
-21474 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/9d682204.html" title="高并发下 MQ 如何保证顺序消费">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高并发下 MQ 如何保证顺序消费"></a></div><div class="recent-post-info"><a class="article-title" href="/post/9d682204.html" title="高并发下 MQ 如何保证顺序消费">高并发下 MQ 如何保证顺序消费</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-18T10:58:56.000Z" title="发表于 2021-08-18 10:58:56">2021-08-18</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/MQ/">MQ</a></span></div><div class="content">高并发下 MQ 如何保证顺序消费？

前提：
关于消息队列中的时序问题。是因为有一些程序员只会简单地写“生产”跟“消费”的代码，但对 MQ 的一些注意事项都不甚明了。

MQ 本身就是为了“分布式”与“高并发”设计的中间件，但这两个场景本身就决定了：一些小问题就很容易引起大麻烦。所以如果你不能对 MQ 的特性了如指掌，那么写出来的代码一旦上了生产，就会引发生产事故，而且还是不易排查的那种。
所以今天就聊聊 MQ 特性中的一点——如何保证顺序？以及如何应对意外事件的处理，避免事故的发生。
时序的业务场景
我们在使用消息队列时都知道，写出生产端与消费端的 happy path 代码并不难，难点往往在于 MQ 的几个要点：不丢消息、重试、延时、幂等、时序等，这几个要点往往逻辑复杂。


前面说的 happy path 的代码，只需要 20% 的时间就能满足 80% 的场景；


但是后面这些要点，却需要用 80% 的时间满足剩下 20% 的场景。


来看一下 MQ 的简单示意图：


这里面有 3 个生产者，分别生产 Data1、Data2、Data3 三条消息到 MQ；


而后三个消费 ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/6f886fe9.html" title="应用性能分析之亲和线程模型">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="应用性能分析之亲和线程模型"></a></div><div class="recent-post-info"><a class="article-title" href="/post/6f886fe9.html" title="应用性能分析之亲和线程模型">应用性能分析之亲和线程模型</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-18T09:33:55.000Z" title="发表于 2021-08-18 09:33:55">2021-08-18</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">应用性能分析</a></span></div><div class="content">亲和线程模型：分布式链路追踪，学习 SkyWalking 就够了

SkyWalking 的线程监控设计：SkyWalking 使用字节码增强技术实现了监控，通常的场景下在应用服务的启动命令中，增加探针属性就能完成接入 SkyWalking 的 APM 监控。

这样简单的部署方案最大化地提升了接入效率，但也让开发人员越来越忽略对 SkyWalking 的学习。久而久之，当接入 SkyWalking 出现问题时，大家解决问题的能力就越来越低了。遇到最多的问题就是：多线程怎么串联链路，日志里面的全链路 ID 怎么打印不出来？这些问题的本质原因便是没有掌握好对线程的监控。
工作线程、任务线程、线程池是如何配合的？
经常用了两个关键词来描述线程，那就是工作线程和任务线程。
这两个词来自 Java 并发框架包（java.util.concurrent）中的线程池执行器类（ThreadPoolExecutor），其中当前正在执行 runWorker 方法的线程是工作线程；在 runWorker 不停循环，从等待执行队列中获取的对象为任务线程。
接下来，看下工作线程和任务线程是如何配合，并在线程池 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/e66c7272.html" title="应用性能分析之资源节点树Sentinel">     <img class="post_bg" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="应用性能分析之资源节点树Sentinel"></a></div><div class="recent-post-info"><a class="article-title" href="/post/e66c7272.html" title="应用性能分析之资源节点树Sentinel">应用性能分析之资源节点树Sentinel</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-08-18T09:33:55.000Z" title="发表于 2021-08-18 09:33:55">2021-08-18</time></span><span class="article-meta"><span class="article-meta__separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/categories/%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/">应用性能分析</a></span></div><div class="content">资源节点树：通过 Sentinel 无侵入实现流量链生成规则
什么叫“侵入”？什么叫“无侵入”？
在学习 Sentinel，讨论无侵入监控时，你可能会问：Sentinel 不是“无侵入”的啊，接入 Sentinel 是需要引入客户端 jar 包的？

其实 Sentinel 是体感“无侵入”，而代码“侵入”的。

目前很多说法是：像 SkyWalking 这种 APM 工具，通过探针实现字节码增强的方式才叫作“无侵入”，这样的理解是错误的。
我们知道 APM 工具的实现方案有两种：一种是黑盒方案，另一种是标记方案。当今开源的 APM 工具都是使用标记方案实现，所以对应用服务是有侵入的。
而“侵入”的意思是：APM 客户端工具会向应用服务内部织入监控代码，这一点我们可以通过对应用服务进行远程调试，或是对 Class 文件进行反解析来证实。
那之所以有同学会有“只有 SkyWalking 这类通过探针实现的 APM 工具才是无侵入”的错觉，归根结底是使用 APM 产品时的不同“体感”所致。
我们可以将侵入度按照不同“体感”，划分为以下两种。


第一种以 SkyWalking 为代表的零接 ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/28/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/#content-inner">28</a><span class="page-number current">29</span><a class="page-number" href="/page/30/#content-inner">30</a><span class="space">&hellip;</span><a class="page-number" href="/page/41/#content-inner">41</a><a class="extend next" rel="next" href="/page/30/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Leo Liu</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">404</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">84</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">51</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/liule8"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/LIULE8" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:leo.liu.scau@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">这里是公告</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/ddaa6102.html" title="数据结构与算法之基础篇-深度和广度优先搜索"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之基础篇-深度和广度优先搜索"/></a><div class="content"><a class="title" href="/post/ddaa6102.html" title="数据结构与算法之基础篇-深度和广度优先搜索">数据结构与算法之基础篇-深度和广度优先搜索</a><time datetime="2021-11-21T18:54:00.000Z" title="发表于 2021-11-21 18:54:00">2021-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/b06ae19b.html" title="数据结构与算法之基础篇-图的表示"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之基础篇-图的表示"/></a><div class="content"><a class="title" href="/post/b06ae19b.html" title="数据结构与算法之基础篇-图的表示">数据结构与算法之基础篇-图的表示</a><time datetime="2021-11-21T18:20:33.000Z" title="发表于 2021-11-21 18:20:33">2021-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/fda95ae0.html" title="数据结构与算法之基础篇-堆的应用"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之基础篇-堆的应用"/></a><div class="content"><a class="title" href="/post/fda95ae0.html" title="数据结构与算法之基础篇-堆的应用">数据结构与算法之基础篇-堆的应用</a><time datetime="2021-11-21T11:20:45.000Z" title="发表于 2021-11-21 11:20:45">2021-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/5376b67c.html" title="数据结构与算法之基础篇-堆和堆排序"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之基础篇-堆和堆排序"/></a><div class="content"><a class="title" href="/post/5376b67c.html" title="数据结构与算法之基础篇-堆和堆排序">数据结构与算法之基础篇-堆和堆排序</a><time datetime="2021-11-21T10:12:51.000Z" title="发表于 2021-11-21 10:12:51">2021-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/a79999eb.html" title="数据结构与算法之基础篇-递归树"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之基础篇-递归树"/></a><div class="content"><a class="title" href="/post/a79999eb.html" title="数据结构与算法之基础篇-递归树">数据结构与算法之基础篇-递归树</a><time datetime="2021-11-20T19:27:51.000Z" title="发表于 2021-11-20 19:27:51">2021-11-20</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            <a class="card-more-btn" href="/categories/" title="查看更多">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JDK/"><span class="card-category-list-name">JDK</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JDK/JDK8/"><span class="card-category-list-name">JDK8</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JVM/"><span class="card-category-list-name">JVM</span><span class="card-category-list-count">6</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Java/"><span class="card-category-list-name">Java</span><span class="card-category-list-count">83</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="card-category-list-name">多线程</span><span class="card-category-list-count">81</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JavaScript/"><span class="card-category-list-name">JavaScript</span><span class="card-category-list-count">3</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/MQ/"><span class="card-category-list-name">MQ</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/MyBatis/"><span class="card-category-list-name">MyBatis</span><span class="card-category-list-count">1</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/Spring/" style="font-size: 1.4em; color: rgb(57, 89, 195)">Spring</a><a href="/tags/JPA/" style="font-size: 1.15em; color: rgb(68, 191, 120)">JPA</a><a href="/tags/Spring-Data/" style="font-size: 1.33em; color: rgb(72, 116, 15)">Spring Data</a><a href="/tags/Vue/" style="font-size: 1.17em; color: rgb(171, 35, 58)">Vue</a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" style="font-size: 1.15em; color: rgb(139, 19, 122)">面向对象设计原则</a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 1.17em; color: rgb(23, 187, 15)">架构</a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.33em; color: rgb(189, 186, 177)">算法</a><a href="/tags/UML/" style="font-size: 1.17em; color: rgb(97, 43, 156)">UML</a><a href="/tags/%E9%94%81/" style="font-size: 1.17em; color: rgb(131, 1, 56)">锁</a><a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 1.15em; color: rgb(161, 122, 68)">集合</a><a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 1.17em; color: rgb(21, 21, 154)">并发</a><a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 1.22em; color: rgb(189, 181, 41)">注解</a><a href="/tags/Spring-Data-Jpa/" style="font-size: 1.36em; color: rgb(80, 129, 62)">Spring Data Jpa</a><a href="/tags/JVM/" style="font-size: 1.24em; color: rgb(133, 91, 114)">JVM</a><a href="/tags/Java/" style="font-size: 1.45em; color: rgb(54, 94, 22)">Java</a><a href="/tags/CompletableFuture/" style="font-size: 1.15em; color: rgb(92, 130, 120)">CompletableFuture</a><a href="/tags/Future/" style="font-size: 1.15em; color: rgb(31, 0, 9)">Future</a><a href="/tags/JavaScript/" style="font-size: 1.15em; color: rgb(161, 74, 69)">JavaScript</a><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 1.43em; color: rgb(35, 16, 98)">并发编程</a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 1.43em; color: rgb(36, 178, 36)">线程</a><a href="/tags/MySQL/" style="font-size: 1.31em; color: rgb(61, 92, 7)">MySQL</a><a href="/tags/I-O%E6%A8%A1%E5%9E%8B/" style="font-size: 1.38em; color: rgb(3, 181, 8)">I\O模型</a><a href="/tags/Netty/" style="font-size: 1.38em; color: rgb(47, 64, 64)">Netty</a><a href="/tags/Socket%E7%BC%96%E7%A8%8B/" style="font-size: 1.38em; color: rgb(72, 138, 50)">Socket编程</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.17em; color: rgb(75, 88, 72)">数据库</a><a href="/tags/Oracle/" style="font-size: 1.17em; color: rgb(163, 87, 43)">Oracle</a><a href="/tags/SQL/" style="font-size: 1.17em; color: rgb(55, 62, 20)">SQL</a><a href="/tags/pageable/" style="font-size: 1.15em; color: rgb(51, 130, 69)">pageable</a><a href="/tags/RestTemplate/" style="font-size: 1.15em; color: rgb(63, 151, 146)">RestTemplate</a><a href="/tags/Spark/" style="font-size: 1.27em; color: rgb(103, 40, 172)">Spark</a><a href="/tags/String/" style="font-size: 1.29em; color: rgb(132, 199, 192)">String</a><a href="/tags/Springboot/" style="font-size: 1.2em; color: rgb(123, 157, 197)">Springboot</a><a href="/tags/Annotation/" style="font-size: 1.17em; color: rgb(110, 130, 188)">Annotation</a><a href="/tags/JpaSpecificationExecutor/" style="font-size: 1.2em; color: rgb(188, 27, 195)">JpaSpecificationExecutor</a><a href="/tags/%E4%B9%90%E8%A7%82%E9%94%81/" style="font-size: 1.15em; color: rgb(142, 187, 184)">乐观锁</a><a href="/tags/Spring-Security/" style="font-size: 1.27em; color: rgb(91, 9, 7)">Spring Security</a><a href="/tags/Transaction/" style="font-size: 1.15em; color: rgb(13, 196, 130)">Transaction</a><a href="/tags/redis/" style="font-size: 1.15em; color: rgb(48, 16, 119)">redis</a><a href="/tags/Join/" style="font-size: 1.15em; color: rgb(73, 23, 67)">Join</a><a href="/tags/Time/" style="font-size: 1.15em; color: rgb(4, 89, 168)">Time</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/11/"><span class="card-archive-list-date">十一月 2021</span><span class="card-archive-list-count">63</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/10/"><span class="card-archive-list-date">十月 2021</span><span class="card-archive-list-count">105</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/09/"><span class="card-archive-list-date">九月 2021</span><span class="card-archive-list-count">106</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/08/"><span class="card-archive-list-date">八月 2021</span><span class="card-archive-list-count">27</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/07/"><span class="card-archive-list-date">七月 2021</span><span class="card-archive-list-count">21</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/06/"><span class="card-archive-list-date">六月 2021</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/04/"><span class="card-archive-list-date">四月 2021</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/02/"><span class="card-archive-list-date">二月 2021</span><span class="card-archive-list-count">4</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">404</div></div><div class="webinfo-item"><div class="item-name">本站总字数 :</div><div class="item-count">1286.2k</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2021-11-21T12:44:29.976Z"></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Leo Liu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function subtitleType () {
  fetch('https://api.btstu.cn/yan/api.php?charset=utf-8&encode=json')
    .then(response => response.json())
    .then(data => {
      if (true) {
        var sub = "".length == 0 ? new Array() : "".split(',')
        var both = sub.unshift(data.text)
        typed = new Typed('#subtitle', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('subtitle').innerHTML = data.text
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.jsdelivr.net/npm/typed.js/lib/typed.min.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>