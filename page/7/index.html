<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Leo's notes</title><meta name="author" content="Leo Liu"><meta name="copyright" content="Leo Liu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="Leo&#39;s notes">
<meta property="og:url" content="https://liule8.github.io/page/7/index.html">
<meta property="og:site_name" content="Leo&#39;s notes">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liule8.github.io/images/avatar.png">
<meta property="article:author" content="Leo Liu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liule8.github.io/images/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liule8.github.io/page/7/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: false,
  isHome: true,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2021-11-07 12:50:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">368</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">83</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">46</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Leo's notes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Leo's notes</h1><div id="site-subtitle"><span id="subtitle"></span></div><div id="site_social_icons"><a class="social-icon" href="https://github.com/LIULE8" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:leo.liu.scau@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/6b1cef6d.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-动态代理">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之自定义RPC-动态代理"></a></div><div class="recent-post-info"><a class="article-title" href="/post/6b1cef6d.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-动态代理">Netty 核心原理剖析与 RPC 实践之自定义RPC-动态代理</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:32:48.000Z" title="发表于 2021-10-14 20:32:48">2021-10-14</time></span></div><div class="content">动态代理：为用户屏蔽 RPC 调用的底层细节
动态代理在 RPC 框架的实现中起到了至关重要的作用，它可以帮助用户屏蔽 RPC 调用时底层网络通信、服务发现、负载均衡等具体细节，这些对用户来说并没有什么意义。你在平时项目开发中使用 RPC 框架的时候，只需要调用接口方法，然后就拿到了返回结果，你是否好奇 RPC 框架是如何完成整个调用流程的呢？今天我们就一起来完成 RPC 框架的最后一部分内容：RPC 请求调用和处理，看看如何使用动态代理机制完成这个神奇的操作。

源码参考地址：mini-rpc

动态代理基础
为什么需要代理模式呢？代理模式的优势是可以很好地遵循设计模式中的开放封闭原则，对扩展开发，对修改关闭。你不需要关注目标类的实现细节，通过代理模式可以在不修改目标类的情况下，增强目标类功能的行为。Spring AOP 是 Java 动态代理机制的经典运用，我们在项目开发中经常使用 AOP 技术完成一些切面服务，如耗时监控、事务管理、权限校验等，所有操作都是通过切面扩展实现的，不需要对源代码有所侵入。
动态代理是一种代理模式，它提供了一种能够在运行时动态构建代理类以及动态调用目标方 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/41305e1a.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-服务治理">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之自定义RPC-服务治理"></a></div><div class="recent-post-info"><a class="article-title" href="/post/41305e1a.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-服务治理">Netty 核心原理剖析与 RPC 实践之自定义RPC-服务治理</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:32:11.000Z" title="发表于 2021-10-14 20:32:11">2021-10-14</time></span></div><div class="content">服务治理：服务发现与负载均衡机制的实现
在分布式系统中，服务消费者和服务提供者都存在多个节点，如果服务提供者出现部分机器节点负载过高，那么可能会导致该节点上接收的请求处理超时，从而导致服务提供者整体可用率下降。所以 RPC 框架需要实现合理的负载均衡算法，那么如何控制流量能够均匀地分摊到每个服务提供者呢？

源码参考地址：mini-rpc

注册中心选型
服务消费者在发起 RPC 调用之前，需要知道服务提供者有哪些节点是可用的，而且服务提供者节点会存在上线和下线的情况。所以服务消费者需要感知服务提供者的节点列表的动态变化，在 RPC 框架中一般采用注册中心来实现服务的注册和发现。
目前主流的注册中心有 ZooKeeper、Eureka、Etcd、Consul、Nacos 等，选择一个高性能、高可用的注册中心对 RPC 框架至关重要。说到高可用自然离不开 CAP 理论，一致性 Consistency、可用性 Availability 和分区容忍性 Partition tolerance 是无法同时满足的，注册中心一般分为 CP 类型注册中心和 AP 类型注册中心。使用最为广泛的 Zook ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/612074c.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-远程通信">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之自定义RPC-远程通信"></a></div><div class="recent-post-info"><a class="article-title" href="/post/612074c.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-远程通信">Netty 核心原理剖析与 RPC 实践之自定义RPC-远程通信</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:31:08.000Z" title="发表于 2021-10-14 20:31:08">2021-10-14</time></span></div><div class="content">远程通信：通信协议设计以及编解码的实现
之前我们搭建了服务提供者和服务消费者的基本框架，现在我们可以建立两个模块之间的通信机制了。通过向 ChannelPipeline 添加自定义的业务处理器，来完成 RPC 框架的远程通信机制。需要实现的主要功能如下：

服务消费者实现协议编码，向服务提供者发送调用数据。
服务提供者收到数据后解码，然后向服务消费者发送响应数据，暂时忽略 RPC 请求是如何被调用的。
服务消费者收到响应数据后成功返回。


源码参考地址：mini-rpc

RPC 通信方案设计
结合目标，接下来我们对 RPC 请求调用和结果响应两个过程分别进行详细拆解分析。首先看下 RPC 请求调用的过程，如下图所示。

RPC 请求的过程对于服务消费者来说是出站操作，对于服务提供者来说是入站操作。数据发送前，服务消费者将 RPC 请求信息封装成 MiniRpcProtocol 对象，然后通过编码器 MiniRpcEncoder 进行二进制编码，最后直接向发送至远端即可。服务提供者收到请求数据后，将二进制数据交给解码器 MiniRpcDecoder，解码后再次生成 MiniRpcPr ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/abea707c.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-服务发布与订阅">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之自定义RPC-服务发布与订阅"></a></div><div class="recent-post-info"><a class="article-title" href="/post/abea707c.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-服务发布与订阅">Netty 核心原理剖析与 RPC 实践之自定义RPC-服务发布与订阅</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:30:25.000Z" title="发表于 2021-10-14 20:30:25">2021-10-14</time></span></div><div class="content">服务发布与订阅：搭建生产者和消费者的基础框架
我们开始动手开发一个完整的 RPC 框架原型，通过实践学习，你不仅可以熟悉 RPC 的实现原理，而且可以对之前 Netty 基础知识加深理解，同样在工作中也可以学以致用。
我会从服务发布与订阅、远程通信、服务治理、动态代理四个方面详细地介绍一个通用 RPC 框架的实现过程。

源码参考地址：mini-rpc

环境搭建
工欲善其事必先利其器，首先我们需要搭建我们的开发环境，这是每个程序员的必备技能。以下是我的本机环境清单，仅供参考。

操作系统：MacOS Big Sur，11.0.1。
集成开发工具：IntelliJ IDEA 2020.3，当然你也可以选择 eclipse。
项目技术栈：SpringBoot 2.1.12.RELEASE + JDK 1.8.0_221 + Netty 4.1.42.Final。
项目依赖管理工具：Maven 3.5.4，你可以独立安装 Maven 或者使用 IDEA 的集成版，独立安装的 Maven 需要配置 MAVEN_HOME 和 PATH 环境变量。
注册中心：Zookeeeper 3.4.14， ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/92e189d1.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-架构设计">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之自定义RPC-架构设计"></a></div><div class="recent-post-info"><a class="article-title" href="/post/92e189d1.html" title="Netty 核心原理剖析与 RPC 实践之自定义RPC-架构设计">Netty 核心原理剖析与 RPC 实践之自定义RPC-架构设计</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:29:42.000Z" title="发表于 2021-10-14 20:29:42">2021-10-14</time></span></div><div class="content">架构设计：如何实现一个高性能分布式 RPC 框架
前面我们由浅入深地讲解了 Netty 的基础知识和实现原理，并对 Netty 的核心源码进行了剖析，相信你已经体会到了 Netty 的强大之处。本身学习一门技术是一个比较漫长的过程，恭喜你坚持了下来。纸上得来终觉浅，绝知此事要躬行。你是不是已经迫不及待想在项目中使用 Netty 了呢？接下来我会带着你完成一个相对完整的 RPC 框架原型，帮助你加深对 Netty 的理解，希望你能亲自动手跟我一起完成它。
我先来说说，为什么要选择 RPC 框架作为实战项目。RPC 框架是大型企业高频使用的一种中间件框架，用于解决分布式系统中服务之间的调用问题。RPC 框架设计很多重要的知识点，如线程模型、通信协议设计、同步/异步调用、负载均衡等，对于提高我们的技术综合能力有非常大的帮助。
实战需要达到什么样的目标呢？市面上有较多出名的 RPC 框架，例如 Dubbo、Thrift、gRPC 等，RPC 框架本身是非常复杂的，我们不可能面面俱到，而是抓住 RPC 框架的核心流程以及必备的组件，开发一个功能比较丰富的小型 RPC 框架。麻雀虽小，五脏俱全。
 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/236ad504.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-高性能无锁队列 Mpsc Queue">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之核心源码解析-高性能无锁队列 Mpsc Queue"></a></div><div class="recent-post-info"><a class="article-title" href="/post/236ad504.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-高性能无锁队列 Mpsc Queue">Netty 核心原理剖析与 RPC 实践之核心源码解析-高性能无锁队列 Mpsc Queue</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:28:50.000Z" title="发表于 2021-10-14 20:28:50">2021-10-14</time></span></div><div class="content">技巧篇：高性能无锁队列 Mpsc Queue
在前面的源码分析中，NioEventLoop 线程以及时间轮 HashedWheelTimer 的任务队列中都出现了 Mpsc Queue 的身影。这又是 Netty 使用的什么 “黑科技” 呢？为什么不使用 JDK 原生的队列呢？Mpsc Queue 应该在什么场景下使用呢？
JDK 原生并发队列
在介绍 Mpsc Queue 之前，我们先回顾下 JDK 原生队列的工作原理。JDK 并发队列按照实现方式可以分为阻塞队列和非阻塞队列两种类型，阻塞队列是基于锁实现的，非阻塞队列是基于 CAS 操作实现的。JDK 中包含多种阻塞和非阻塞的队列实现，如下图所示。

队列是一种 FIFO（先进先出）的数据结构，JDK 中定义了 java.util.Queue 的队列接口，与 List、Set 接口类似，java.util.Queue 也继承于 Collection 集合接口。此外，JDK 还提供了一种双端队列接口 java.util.Deque，我们最常用的 LinkedList 就是实现了 Deque 接口。下面我们简单说说上图中的每个队列的特点 ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/83ace552.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-时间轮 HashedWheelTimer">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之核心源码解析-时间轮 HashedWheelTimer"></a></div><div class="recent-post-info"><a class="article-title" href="/post/83ace552.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-时间轮 HashedWheelTimer">Netty 核心原理剖析与 RPC 实践之核心源码解析-时间轮 HashedWheelTimer</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:27:36.000Z" title="发表于 2021-10-14 20:27:36">2021-10-14</time></span></div><div class="content">技巧篇：延迟任务处理神器之时间轮 HashedWheelTimer
Netty 中有很多场景依赖定时任务实现，比较典型的有客户端连接的超时控制、通信双方连接的心跳检测等场景。在学习 Netty Reactor 线程模型时，我们知道 NioEventLoop 不仅负责处理 I/O 事件，而且兼顾执行任务队列中的任务，其中就包括定时任务。为了实现高性能的定时任务调度，Netty 引入了时间轮算法驱动定时任务的执行。

时间轮到底是什么呢？
为什么 Netty 一定要用时间轮来处理定时任务呢？
JDK 原生的实现方案不能满足要求吗？


说明：本文参考的 Netty 源码版本为 4.1.42.Final。

定时任务的基础知识
首先，我们先了解下什么是定时任务？定时器有非常多的使用场景，大家在平时工作中应该经常遇到，例如生成月统计报表、财务对账、会员积分结算、邮件推送等，都是定时器的使用场景。定时器一般有三种表现形式：按固定周期定时执行、延迟一定时间后执行、指定某个时刻执行。
定时器的本质是设计一种数据结构，能够存储和调度任务集合，而且 deadline 越近的任务拥有更高的优先级。那么定时 ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/a16fcef7.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-FastThreadLocal">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之核心源码解析-FastThreadLocal"></a></div><div class="recent-post-info"><a class="article-title" href="/post/a16fcef7.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-FastThreadLocal">Netty 核心原理剖析与 RPC 实践之核心源码解析-FastThreadLocal</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:25:43.000Z" title="发表于 2021-10-14 20:25:43">2021-10-14</time></span></div><div class="content">技巧篇：Netty 的 FastThreadLocal 究竟比 ThreadLocal 快在哪儿？
在前面的源码解析中，我们都有在源码中发现 FastThreadLocal 的身影。顾名思义，Netty 作为高性能的网络通信框架，FastThreadLocal 是比 JDK 自身的 ThreadLocal 性能更高的通信框架。FastThreadLocal 到底比 ThreadLocal 快在哪里呢？

说明：本文参考的 Netty 源码版本为 4.1.42.Final。

JDK ThreadLocal 基本原理
JDK ThreadLocal 不仅是高频的面试知识点，而且在日常工作中也是常用一种工具，所以首先我们先学习下 Java 原生的 ThreadLocal 的实现原理，可以帮助我们更好地对比和理解 Netty 的 FastThreadLocal。
如果你需要变量在多线程之间隔离，或者在同线程内的类和方法中共享，那么 ThreadLocal 大显身手的时候就到了。ThreadLocal 可以理解为线程本地变量，它是 Java 并发编程中非常重要的一个类。ThreadLocal  ...</div></div></div><div class="recent-post-item"><div class="post_cover left_radius"><a href="/post/384beead.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-一个网络请求在 Netty 中的旅程">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之核心源码解析-一个网络请求在 Netty 中的旅程"></a></div><div class="recent-post-info"><a class="article-title" href="/post/384beead.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-一个网络请求在 Netty 中的旅程">Netty 核心原理剖析与 RPC 实践之核心源码解析-一个网络请求在 Netty 中的旅程</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:25:43.000Z" title="发表于 2021-10-14 20:25:43">2021-10-14</time></span></div><div class="content">源码篇：一个网络请求在 Netty 中的旅程
通过前面的学习，我们知道 Netty 在服务端启动时会为创建 NioServerSocketChannel，当客户端新连接接入时又会创建 NioSocketChannel，不管是服务端还是客户端 Channel，在创建时都会初始化自己的 ChannelPipeline。如果把 Netty 比作成一个生产车间，那么 Reactor 线程无疑是车间的中央管控系统，ChannelPipeline 可以看作是车间的流水线，将原材料按顺序进行一步步加工，然后形成一个完整的产品。

说明：本文参考的 Netty 源码版本为 4.1.42.Final。

事件处理机制回顾
首先我们以服务端接入客户端新连接为例，并结合前面学习的知识点，一起复习下 Netty 的事件处理流程，如下图所示。

Netty 服务端启动后，BossEventLoopGroup 会负责监听客户端的 Accept 事件。当有客户端新连接接入时，BossEventLoopGroup 中的 NioEventLoop 首先会新建客户端 Channel，然后在 NioServerSocket ...</div></div></div><div class="recent-post-item"><div class="post_cover right_radius"><a href="/post/985b540c.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-解密 Netty Reactor 线程模型">     <img class="post_bg" src="/images/posts/cover/netty.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Netty 核心原理剖析与 RPC 实践之核心源码解析-解密 Netty Reactor 线程模型"></a></div><div class="recent-post-info"><a class="article-title" href="/post/985b540c.html" title="Netty 核心原理剖析与 RPC 实践之核心源码解析-解密 Netty Reactor 线程模型">Netty 核心原理剖析与 RPC 实践之核心源码解析-解密 Netty Reactor 线程模型</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2021-10-14T20:25:00.000Z" title="发表于 2021-10-14 20:25:00">2021-10-14</time></span></div><div class="content">源码篇：解密 Netty Reactor 线程模型
我们知道 Reactor 线程模型是 Netty 实现高性能的核心所在，在 Netty 中 EventLoop 是 Reactor 线程模型的核心处理引擎，那么 EventLoop 到底是如何实现的呢？又是如何保证高性能和线程安全性的呢？

说明：本文参考的 Netty 源码版本为 4.1.42.Final。

Reactor 线程执行的主流程
在《事件调度层：为什么 EventLoop 是 Netty 的精髓》 中，我们介绍了 EventLoop 的概貌，因为 Netty 是基于 NIO 实现的，所以推荐使用 NioEventLoop 实现，我们再次通过 NioEventLoop 的核心入口 run() 方法回顾 Netty Reactor 线程模型执行的主流程，并以此为基础继续深入研究 NioEventLoop 的逻辑细节。
1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253protect ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/6/#content-inner"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/#content-inner">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/#content-inner">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/#content-inner">37</a><a class="extend next" rel="next" href="/page/8/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Leo Liu</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">368</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">83</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">46</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/liule8"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/LIULE8" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:leo.liu.scau@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">这里是公告</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/2a7649c3.html" title="Spark实战之基础-如何选择 Spark 编程语言以及部署 Spark"><img src="/images/posts/cover/spark.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark实战之基础-如何选择 Spark 编程语言以及部署 Spark"/></a><div class="content"><a class="title" href="/post/2a7649c3.html" title="Spark实战之基础-如何选择 Spark 编程语言以及部署 Spark">Spark实战之基础-如何选择 Spark 编程语言以及部署 Spark</a><time datetime="2021-11-07T16:59:51.000Z" title="发表于 2021-11-07 16:59:51">2021-11-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/99c2f5e4.html" title="Spark实战之基础-解析 Spark 数据处理与分析场景"><img src="/images/posts/cover/spark.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark实战之基础-解析 Spark 数据处理与分析场景"/></a><div class="content"><a class="title" href="/post/99c2f5e4.html" title="Spark实战之基础-解析 Spark 数据处理与分析场景">Spark实战之基础-解析 Spark 数据处理与分析场景</a><time datetime="2021-11-07T12:44:45.000Z" title="发表于 2021-11-07 12:44:45">2021-11-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/abfe544b.html" title="Spark实战之基础-YARN"><img src="/images/posts/cover/spark.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark实战之基础-YARN"/></a><div class="content"><a class="title" href="/post/abfe544b.html" title="Spark实战之基础-YARN">Spark实战之基础-YARN</a><time datetime="2021-11-06T16:26:00.000Z" title="发表于 2021-11-06 16:26:00">2021-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/69b6c9e6.html" title="Spark实战之基础-Hadoop"><img src="/images/posts/cover/spark.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark实战之基础-Hadoop"/></a><div class="content"><a class="title" href="/post/69b6c9e6.html" title="Spark实战之基础-Hadoop">Spark实战之基础-Hadoop</a><time datetime="2021-11-06T16:01:21.000Z" title="发表于 2021-11-06 16:01:21">2021-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/bf0f3957.html" title="Spark实战之基础-MapReduce"><img src="/images/posts/cover/spark.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark实战之基础-MapReduce"/></a><div class="content"><a class="title" href="/post/bf0f3957.html" title="Spark实战之基础-MapReduce">Spark实战之基础-MapReduce</a><time datetime="2021-11-06T15:18:05.000Z" title="发表于 2021-11-06 15:18:05">2021-11-06</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            <a class="card-more-btn" href="/categories/" title="查看更多">
    <i class="fas fa-angle-right"></i></a>
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JDK/"><span class="card-category-list-name">JDK</span><span class="card-category-list-count">4</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JDK/JDK8/"><span class="card-category-list-name">JDK8</span><span class="card-category-list-count">4</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Java/"><span class="card-category-list-name">Java</span><span class="card-category-list-count">83</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Java/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="card-category-list-name">多线程</span><span class="card-category-list-count">81</span></a></li></ul></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/JavaScript/"><span class="card-category-list-name">JavaScript</span><span class="card-category-list-count">3</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/MQ/"><span class="card-category-list-name">MQ</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Spring/"><span class="card-category-list-name">Spring</span><span class="card-category-list-count">55</span></a><ul class="card-category-list child"><li class="card-category-list-item "><a class="card-category-list-link" href="/categories/Spring/Spring-Data/"><span class="card-category-list-name">Spring Data</span><span class="card-category-list-count">33</span></a></li></ul></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/tags/Spring/" style="font-size: 1.41em; color: rgb(159, 180, 151)">Spring</a><a href="/tags/JPA/" style="font-size: 1.15em; color: rgb(136, 35, 118)">JPA</a><a href="/tags/Spring-Data/" style="font-size: 1.35em; color: rgb(43, 9, 107)">Spring Data</a><a href="/tags/Vue/" style="font-size: 1.17em; color: rgb(77, 134, 53)">Vue</a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/" style="font-size: 1.15em; color: rgb(127, 100, 173)">面向对象设计原则</a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 1.17em; color: rgb(175, 138, 169)">架构</a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.27em; color: rgb(192, 154, 4)">算法</a><a href="/tags/UML/" style="font-size: 1.17em; color: rgb(81, 181, 177)">UML</a><a href="/tags/%E9%94%81/" style="font-size: 1.17em; color: rgb(44, 5, 0)">锁</a><a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 1.15em; color: rgb(79, 95, 188)">集合</a><a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 1.17em; color: rgb(8, 190, 11)">并发</a><a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 1.21em; color: rgb(188, 160, 169)">注解</a><a href="/tags/Spring-Data-Jpa/" style="font-size: 1.37em; color: rgb(6, 157, 86)">Spring Data Jpa</a><a href="/tags/JVM/" style="font-size: 1.25em; color: rgb(115, 198, 16)">JVM</a><a href="/tags/Java/" style="font-size: 1.45em; color: rgb(92, 85, 188)">Java</a><a href="/tags/CompletableFuture/" style="font-size: 1.15em; color: rgb(175, 194, 90)">CompletableFuture</a><a href="/tags/Future/" style="font-size: 1.15em; color: rgb(199, 22, 77)">Future</a><a href="/tags/JavaScript/" style="font-size: 1.15em; color: rgb(195, 157, 66)">JavaScript</a><a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 1.43em; color: rgb(182, 169, 100)">并发编程</a><a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 1.43em; color: rgb(86, 122, 171)">线程</a><a href="/tags/MySQL/" style="font-size: 1.33em; color: rgb(42, 194, 44)">MySQL</a><a href="/tags/I-O%E6%A8%A1%E5%9E%8B/" style="font-size: 1.39em; color: rgb(87, 198, 91)">I\O模型</a><a href="/tags/Netty/" style="font-size: 1.39em; color: rgb(151, 51, 85)">Netty</a><a href="/tags/Socket%E7%BC%96%E7%A8%8B/" style="font-size: 1.39em; color: rgb(66, 79, 112)">Socket编程</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.17em; color: rgb(47, 146, 129)">数据库</a><a href="/tags/Oracle/" style="font-size: 1.17em; color: rgb(6, 31, 97)">Oracle</a><a href="/tags/SQL/" style="font-size: 1.17em; color: rgb(24, 6, 41)">SQL</a><a href="/tags/pageable/" style="font-size: 1.15em; color: rgb(62, 81, 70)">pageable</a><a href="/tags/RestTemplate/" style="font-size: 1.15em; color: rgb(137, 132, 143)">RestTemplate</a><a href="/tags/Spark/" style="font-size: 1.23em; color: rgb(183, 80, 89)">Spark</a><a href="/tags/String/" style="font-size: 1.31em; color: rgb(170, 114, 119)">String</a><a href="/tags/Springboot/" style="font-size: 1.19em; color: rgb(35, 115, 118)">Springboot</a><a href="/tags/Annotation/" style="font-size: 1.17em; color: rgb(12, 107, 145)">Annotation</a><a href="/tags/JpaSpecificationExecutor/" style="font-size: 1.19em; color: rgb(132, 100, 24)">JpaSpecificationExecutor</a><a href="/tags/%E4%B9%90%E8%A7%82%E9%94%81/" style="font-size: 1.15em; color: rgb(42, 45, 121)">乐观锁</a><a href="/tags/Spring-Security/" style="font-size: 1.29em; color: rgb(154, 160, 96)">Spring Security</a><a href="/tags/Transaction/" style="font-size: 1.15em; color: rgb(36, 43, 66)">Transaction</a><a href="/tags/redis/" style="font-size: 1.15em; color: rgb(1, 120, 118)">redis</a><a href="/tags/Join/" style="font-size: 1.15em; color: rgb(143, 155, 31)">Join</a><a href="/tags/Time/" style="font-size: 1.15em; color: rgb(96, 94, 196)">Time</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="fas fa-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/11/"><span class="card-archive-list-date">十一月 2021</span><span class="card-archive-list-count">27</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/10/"><span class="card-archive-list-date">十月 2021</span><span class="card-archive-list-count">105</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/09/"><span class="card-archive-list-date">九月 2021</span><span class="card-archive-list-count">106</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/08/"><span class="card-archive-list-date">八月 2021</span><span class="card-archive-list-count">27</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/07/"><span class="card-archive-list-date">七月 2021</span><span class="card-archive-list-count">21</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/06/"><span class="card-archive-list-date">六月 2021</span><span class="card-archive-list-count">3</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/04/"><span class="card-archive-list-date">四月 2021</span><span class="card-archive-list-count">1</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2021/02/"><span class="card-archive-list-date">二月 2021</span><span class="card-archive-list-count">4</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">368</div></div><div class="webinfo-item"><div class="item-name">本站总字数 :</div><div class="item-count">1137k</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2021-11-07T12:50:44.405Z"></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Leo Liu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function subtitleType () {
  fetch('https://api.btstu.cn/yan/api.php?charset=utf-8&encode=json')
    .then(response => response.json())
    .then(data => {
      if (true) {
        var sub = "".length == 0 ? new Array() : "".split(',')
        var both = sub.unshift(data.text)
        typed = new Typed('#subtitle', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('subtitle').innerHTML = data.text
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.jsdelivr.net/npm/typed.js/lib/typed.min.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>