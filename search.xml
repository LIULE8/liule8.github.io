<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CAS</title>
    <url>/2020/09/06/CAS%E6%80%9D%E6%83%B3/</url>
    <content><![CDATA[<h1 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h1><h2 id="ä»€ä¹ˆæ˜¯CAS"><a href="#ä»€ä¹ˆæ˜¯CAS" class="headerlink" title="ä»€ä¹ˆæ˜¯CAS"></a>ä»€ä¹ˆæ˜¯CAS</h2><ul>
<li>CAS å…¨ç§° compare and swap (æ¯”è¾ƒå¹¶æ›¿æ¢)ï¼Œæ˜¯ç”¨åœ¨çº¿ç¨‹å¹¶å‘ç®—æ³•é‡Œå¸¸è§çš„ä¸€ç§æ€æƒ³</li>
<li>CAS æ˜¯åŸå­æ“ä½œï¼Œä¿è¯å¹¶å‘å®‰å…¨ï¼Œä½†ä¸ä¿è¯å¹¶å‘åŒæ­¥</li>
</ul>
<h2 id="CASåŸç†"><a href="#CASåŸç†" class="headerlink" title="CASåŸç†"></a>CASåŸç†</h2><p>CAS å°±æ˜¯å°†å†…å­˜å€¼æ›´æ–°ä¸ºéœ€è¦çš„å€¼æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæ¡ä»¶ï¼Œå†…å­˜å€¼å¿…é¡»ä¸æœŸæœ›å€¼ç›¸åŒ</p>
<blockquote>
<p>æœŸæœ›å€¼ Eã€å†…å­˜å€¼Mã€æ›´æ–°å€¼Uï¼Œå½“E == Mçš„æ—¶å€™å°†Mæ›´æ–°ä¸ºU</p>
</blockquote>
<h2 id="CASåº”ç”¨"><a href="#CASåº”ç”¨" class="headerlink" title="CASåº”ç”¨"></a>CASåº”ç”¨</h2><ol>
<li>æ•°æ®åº“å¸¸è§çš„ä¹è§‚é”å®ç°æ–¹å¼ï¼Œä½¿ç”¨ç‰ˆæœ¬å·version</li>
<li>JAVAé‡Œçš„åŸå­ç±»</li>
</ol>
<h2 id="CASä¼˜ç¼ºç‚¹"><a href="#CASä¼˜ç¼ºç‚¹" class="headerlink" title="CASä¼˜ç¼ºç‚¹"></a>CASä¼˜ç¼ºç‚¹</h2><h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><p>ç”¨æ¥å®ç°éé˜»å¡çš„è½»é‡çº§çš„ä¹è§‚é”ï¼Œé€šè¿‡CPUæŒ‡ä»¤å®ç°ï¼Œåœ¨èµ„æºç«äº‰ä¸æ¿€çƒˆçš„æƒ…å†µä¸‹æ€§èƒ½é«˜</p>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li><p>ABA é—®é¢˜ï¼šçº¿ç¨‹Cã€Dï¼Œçº¿ç¨‹Då°†Aä¿®æ”¹ä¸ºBååˆä¿®æ”¹ä¸ºAï¼Œæ­¤æ—¶Cçº¿ç¨‹ä»¥ä¸ºAæ²¡æœ‰æ”¹å˜è¿‡</p>
<p>JAVAçš„åŸå­ç±»AtomicStampedReferenceï¼Œé€šè¿‡<strong>æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬</strong>æ¥ä¿è¯CASçš„æ­£ç¡®æ€§ï¼ˆå…¶ä»–æƒ…å†µä¹Ÿå¯ä»¥é€šè¿‡å¢åŠ ç‰ˆæœ¬å·æ¥è§£å†³ABAé—®é¢˜ï¼‰</p>
</li>
<li><p>è‡ªæ—‹æ—¶é—´è¿‡é•¿(ä¸€ç›´ä¸èƒ½æ›´æ–°)ï¼Œ<strong>æ¶ˆè€—CPUèµ„æº</strong>ï¼Œ å¦‚æœèµ„æºç«äº‰æ¿€çƒˆï¼Œå¤šçº¿ç¨‹è‡ªæ—‹é•¿æ—¶é—´æ¶ˆè€—èµ„æº</p>
</li>
</ol>
]]></content>
      <categories>
        <category>é”</category>
        <category>ä¹è§‚é”</category>
      </categories>
      <tags>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>CollectionUtilså·¥å…·ç±»</title>
    <url>/2020/10/13/CollectionUtils%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
    <content><![CDATA[<h1 id="CollectionUtilså·¥å…·ç±»"><a href="#CollectionUtilså·¥å…·ç±»" class="headerlink" title="CollectionUtilså·¥å…·ç±»"></a>CollectionUtilså·¥å…·ç±»</h1><p><a href="https://mvnrepository.com/artifact/org.apache.commons/commons-collections4">Apache Commons Collections</a> ä½¿æ“ä½œé›†åˆæ—¶ï¼Œä»£ç æ›´åŠ ç®€æ´</p>
<h2 id="å¸¸ç”¨API"><a href="#å¸¸ç”¨API" class="headerlink" title="å¸¸ç”¨API"></a>å¸¸ç”¨API</h2><p>å…ƒç´ ä¸ä¸ºnullæ—¶ï¼Œå‘é›†åˆæ·»åŠ å…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.addIgnoreNull(targetList, targetObject);</span><br></pre></td></tr></table></figure>

<p>å°†ä¸¤ä¸ªå·²æ’åºçš„é›†åˆaå’Œbåˆå¹¶ä¸ºä¸€ä¸ªå·²æ’åºçš„åˆ—è¡¨ï¼Œä¿ç•™å…ƒç´ çš„è‡ªç„¶é¡ºåº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.collate(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b)</span><br></pre></td></tr></table></figure>

<p>å°†ä¸¤ä¸ªå·²æ’åºçš„é›†åˆaå’Œbåˆå¹¶åˆ°ä¸€ä¸ªå·²æ’åºçš„åˆ—è¡¨ä¸­ï¼Œæ ¹æ®æ¯”è¾ƒå™¨é¡ºåº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.collate(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b, Comparator&lt;? <span class="keyword">super</span> O&gt; c)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå‚æ•°æ˜¯nullï¼Œåˆ™è¿”å›ä¸å¯å˜çš„ç©ºé›†åˆï¼ˆ<code>new EmptyList&lt;&gt;()</code>ï¼‰ï¼Œå¦åˆ™è¿”å›å‚æ•°æœ¬èº«</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.emptyIfNull(Collection&lt;T&gt; collection)</span><br></pre></td></tr></table></figure>

<p>ç©ºå®‰å…¨æ£€æŸ¥æŒ‡å®šçš„é›†åˆæ˜¯å¦ä¸ºç©º</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.isEmpty(Collection&lt;?&gt; coll)</span><br><span class="line">CollectionUtils.isNotEmpty(Collection&lt;?&gt; coll)</span><br></pre></td></tr></table></figure>

<p>åè½¬ç»™å®šæ•°ç»„çš„é¡ºåº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.reverseArray(Object[] array)</span><br></pre></td></tr></table></figure>

<p>å·®é›†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.subtract(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b)</span><br></pre></td></tr></table></figure>

<p>å¹¶é›†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.union(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b)</span><br></pre></td></tr></table></figure>

<p>äº¤é›†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.intersection(Collection a, Collection b)</span><br></pre></td></tr></table></figure>

<p>äº¤é›†çš„è¡¥é›†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CollectionUtils.disjunction(Collection a, Collection b)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>å·¥å…·ç±»</category>
      </categories>
      <tags>
        <tag>é›†åˆ</tag>
      </tags>
  </entry>
  <entry>
    <title>JDK å†…ç½®æ³¨è§£</title>
    <url>/2020/09/08/JDK%20%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="SuppressWarnings"><a href="#SuppressWarnings" class="headerlink" title="@SuppressWarnings"></a>@SuppressWarnings</h1><p><strong>èŒƒå›´</strong>ï¼šç±»ã€å­—æ®µã€æ–¹æ³•ã€å‚æ•°ã€æ„é€ æ–¹æ³•ï¼Œä»¥åŠå±€éƒ¨å˜é‡ä¸Šã€‚</p>
<p><strong>ä½œç”¨</strong>ï¼šå‘Šè¯‰ç¼–è¯‘å™¨å¿½ç•¥æŒ‡å®šçš„è­¦å‘Šï¼Œä¸ç”¨åœ¨ç¼–è¯‘å®Œæˆåå‡ºç°è­¦å‘Šä¿¡æ¯ã€‚</p>
<p><strong>å‚æ•°</strong>ï¼š</p>
<ol>
<li>deprecationï¼šå¿½ç•¥è¿‡æ—¶</li>
<li>rawtypesï¼šå¿½ç•¥ç±»å‹å®‰å…¨</li>
<li>unusedï¼šå¿½ç•¥ä¸ä½¿ç”¨</li>
<li>uncheckedï¼šå¿½ç•¥å®‰å…¨æ£€æŸ¥</li>
<li>nullï¼šå¿½ç•¥ç©ºæŒ‡é’ˆ</li>
<li>allï¼šå¿½ç•¥æ‰€æœ‰</li>
</ol>
<p><strong>ä¾‹å­</strong>ï¼š<code>@SuppressWarnings(&quot;unchecked&quot;, &quot;deprecation&quot;)</code></p>
]]></content>
      <categories>
        <category>æ³¨è§£</category>
      </categories>
      <tags>
        <tag>æ³¨è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>JPAç”¨æ³•</title>
    <url>/2020/09/06/JPA%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<h1 id="æŸ¥è¯¢ç”¨æ³•"><a href="#æŸ¥è¯¢ç”¨æ³•" class="headerlink" title="æŸ¥è¯¢ç”¨æ³•"></a>æŸ¥è¯¢ç”¨æ³•</h1><h2 id="å®ä½“"><a href="#å®ä½“" class="headerlink" title="å®ä½“"></a>å®ä½“</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">// æ‹¥æœ‰çº§è”ç»´æŠ¤çš„ä¸€æ–¹ï¼Œå‚è€ƒhttp://westerly-lzh.github.io/cn/2014/12/JPA-CascadeType-Explaining/</span></span><br><span class="line">    <span class="meta">@OneToOne(cascade = CascadeType.ALL)</span> </span><br><span class="line">    <span class="meta">@JoinColumn(foreignKey = @ForeignKey(name = &quot;none&quot;, value = ConstraintMode.NO_CONSTRAINT))</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeDetail detail;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne(fetch = FetchType.LAZY)</span> </span><br><span class="line">    <span class="comment">// è®¾ç½®å¤–é”®çš„é—®é¢˜ï¼Œå‚è€ƒhttp://mario1412.github.io/2016/06/27/JPA%E4%B8%AD%E5%B1%8F%E8%94%BD%E5%AE%9E%E4%BD%93%E9%97%B4%E5%A4%96%E9%94%AE/</span></span><br><span class="line">    <span class="meta">@JoinColumn(name = &quot;jobId&quot;, foreignKey = @ForeignKey(name = &quot;none&quot;, value = ConstraintMode.NO_CONSTRAINT))</span></span><br><span class="line">    <span class="keyword">private</span> Job job;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeDetail</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mappedBy åªæœ‰åœ¨åŒå‘å…³è”çš„æ—¶å€™è®¾ç½®ï¼Œè¡¨ç¤ºå…³ç³»ç»´æŠ¤çš„ä¸€ç«¯ï¼Œå¦åˆ™ä¼šç”Ÿæˆä¸­é—´è¡¨A_B</span></span><br><span class="line">    <span class="meta">@OneToMany(targetEntity = Employee.class, mappedBy = &quot;job&quot;)</span> </span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ @JoinColumn ä¸­çš„ @ForeignKey ä¸ç„¶ä¼šç”Ÿæˆå¤–é”®</span></span><br><span class="line">    <span class="meta">@org</span>.hibernate.annotations.ForeignKey(name = <span class="string">&quot;none&quot;</span>) </span><br><span class="line">    <span class="keyword">private</span> Set&lt;Employee&gt; employees;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Specification-å¤æ‚æŸ¥è¯¢"><a href="#Specification-å¤æ‚æŸ¥è¯¢" class="headerlink" title="Specification å¤æ‚æŸ¥è¯¢"></a>Specification å¤æ‚æŸ¥è¯¢</h2><p>JPAå¤æ‚æŸ¥è¯¢æ¥å£ <code>JpaSpecificationExecutor</code> æ¥å£ï¼Œå¯ä»¥å®Œæˆå„ç§å¤æ‚æŸ¥è¯¢ï¼Œé…åˆ JAVA 8çš„æ–°ç‰¹æ€§ï¼Œä½¿ç”¨èµ·æ¥ç‰¹åˆ«çš„æ–¹ä¾¿ï¼Œä¸€èˆ¬ç”¨äºå•è¡¨çš„å¤æ‚æŸ¥è¯¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @param search   æŸ¥è¯¢å±æ€§</span></span><br><span class="line"><span class="comment"> * @param pageable åˆ†é¡µå’Œæ’åº</span></span><br><span class="line"><span class="comment"> * @return åˆ†é¡µæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Employee&gt; <span class="title">pageBySearch</span><span class="params">(EmployeeSearch search, Pageable pageable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> employeeDao.findAll((Specification&lt;Employee&gt;) (root, criteriaQuery, criteriaBuilder) -&gt; &#123;</span><br><span class="line">        List&lt;Predicate&gt; predicates = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        Optional&lt;EmployeeSearch&gt; optional = Optional.ofNullable(search);</span><br><span class="line">        <span class="comment">// æ ¹æ® employee id æŸ¥è¯¢</span></span><br><span class="line">        optional.map(EmployeeSearch::getEmployeeId).ifPresent(id -&gt; &#123;</span><br><span class="line">            predicates.add(criteriaBuilder.equal(root.get(Employee_.id), id));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// æ ¹æ® employee detail name æ¨¡ç³ŠæŸ¥è¯¢</span></span><br><span class="line">        optional.map(EmployeeSearch::getEmployeeName).ifPresent(name -&gt; &#123;</span><br><span class="line">            Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT);</span><br><span class="line">            predicates.add(criteriaBuilder.like(join.get(EmployeeDetail_.name),</span><br><span class="line">                    <span class="string">&quot;%&quot;</span> + name + <span class="string">&quot;%&quot;</span>));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// æ ¹æ®èŒä½åæŸ¥è¯¢</span></span><br><span class="line">        optional.map(EmployeeSearch::getJobName).ifPresent(name -&gt; &#123;</span><br><span class="line">            Join&lt;Employee, Job&gt; join = root.join(Employee_.job, JoinType.LEFT);</span><br><span class="line">            predicates.add(criteriaBuilder.equal(join.get(Job_.name), name));</span><br><span class="line">        &#125;);</span><br><span class="line">        Predicate[] array = <span class="keyword">new</span> Predicate[predicates.size()];</span><br><span class="line">        <span class="keyword">return</span> criteriaBuilder.and(predicates.toArray(array));</span><br><span class="line">    &#125;, pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼š</p>
<ol>
<li>é’ˆå¯¹æœ‰å¤–é”®å…³è”çš„è¡¨çš„æŸ¥è¯¢æ¡ä»¶ï¼Œéœ€è¦ä½¿ç”¨å·¦è”æ¥ï¼›å¦‚ä¸Šé¢çš„ employee detail name æ¨¡ç³ŠæŸ¥è¯¢</li>
<li>å¦‚æœç›´æ¥ <code>get(Employee_.detail).get(EmployeeDetail_.name)</code> ï¼Œå°±æ˜¯æ— æ¡ä»¶å†…è”ï¼Œç›¸å½“äº cross joinï¼Œä¼šäº§ç”Ÿç¬›å¡å°”ç§¯</li>
</ol>
</blockquote>
<h2 id="Criteria-æŸ¥è¯¢"><a href="#Criteria-æŸ¥è¯¢" class="headerlink" title="Criteria æŸ¥è¯¢"></a>Criteria æŸ¥è¯¢</h2><h3 id="æ™®é€šçš„æŸ¥è¯¢"><a href="#æ™®é€šçš„æŸ¥è¯¢" class="headerlink" title="æ™®é€šçš„æŸ¥è¯¢"></a>æ™®é€šçš„æŸ¥è¯¢</h3><p>è¿”å›ç»“æœç±»å‹ï¼šentity / Object[] / tuple / DTO</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PersistenceContext</span></span><br><span class="line"><span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Search age gt or eq the parameter</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> age</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Employee&gt; <span class="title">listByAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">    CriteriaBuilder cb = em.getCriteriaBuilder();</span><br><span class="line">    CriteriaQuery&lt;Employee&gt; query = cb.createQuery(Employee.class);</span><br><span class="line">    <span class="comment">// è®¾ç½®æŸ¥è¯¢æ ¹ï¼Œå¯ä»¥æ ¹æ®æŸ¥è¯¢çš„ç±»å‹è®¾ç½®ä¸åŒçš„ å°±æ˜¯ Form è¯­å¥ åé¢çš„ entity</span></span><br><span class="line">    Root&lt;Employee&gt; root = query.from(Employee.class); </span><br><span class="line">    List&lt;Predicate&gt; predicates = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">// è¿è¡¨æŸ¥è¯¢ä½¿ç”¨å·¦è¿æ¥</span></span><br><span class="line">    Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT);</span><br><span class="line">    predicates.add(cb.gt(join.get(EmployeeDetail_.age), age));</span><br><span class="line">    predicates.add(cb.equal(join.get(EmployeeDetail_.age), age));</span><br><span class="line">    <span class="comment">// è®¾ç½®æ’åºè§„åˆ™</span></span><br><span class="line">    query.orderBy(cb.asc(root.get(Employee_.id)));</span><br><span class="line">    query.where(predicates.toArray(<span class="keyword">new</span> Predicate[predicates.size()]));</span><br><span class="line">    <span class="keyword">return</span> em.createQuery(query).getResultList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è¿”å›DTOå¯¹è±¡"><a href="#è¿”å›DTOå¯¹è±¡" class="headerlink" title="è¿”å›DTOå¯¹è±¡"></a>è¿”å›DTOå¯¹è±¡</h4><p>å› ä¸ºä¸æ˜¯ä¸€ä¸ªEntityï¼Œåˆ™éœ€è¦åšä¸€äº›ç‰¹æ®Šçš„æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ æ„é€ å‡½æ•° è£…è½½æŸ¥è¯¢å‡ºæ¥çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;EmployeeResult&gt; <span class="title">findEmployee</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CriteriaBuilder cb = em.getCriteriaBuilder();</span><br><span class="line">    CriteriaQuery&lt;EmployeeResult&gt; query = cb.createQuery(EmployeeResult.class);</span><br><span class="line">    <span class="comment">// è®¾ç½®æŸ¥è¯¢æ ¹ï¼Œå¯ä»¥æ ¹æ®æŸ¥è¯¢çš„ç±»å‹è®¾ç½®ä¸åŒçš„</span></span><br><span class="line">    Root&lt;Employee&gt; root = query.from(Employee.class); </span><br><span class="line">    Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ„é€ å‡½æ•° CriteriaBuilder.construct æ¥å®Œæˆè£…è½½æ•°æ®</span></span><br><span class="line">    query.select(cb.construct(EmployeeResult.class, join.get(EmployeeDetail_.name), join.get(EmployeeDetail_.age)));</span><br><span class="line">    <span class="comment">// è®¾ç½®æ’åºè§„åˆ™</span></span><br><span class="line">    Order order = cb.asc(root.get(Employee_.id));</span><br><span class="line">    query.orderBy(order);</span><br><span class="line">    TypedQuery typedQuery = em.createQuery(query); <span class="comment">// TypedQueryæ‰§è¡ŒæŸ¥è¯¢ä¸è·å–å…ƒæ¨¡å‹å®ä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> typedQuery.getResultList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>query.select(CriteriaBuilder.construct())</code> è¿™ç§æ–¹å¼</p>
<p> å°±ç›¸å½“äº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">query.mutipleSelect(</span><br><span class="line">      join.get(EmployeeDetail_.name), </span><br><span class="line">      join.get(EmployeeDetail_.age));</span><br></pre></td></tr></table></figure>

<p>è€Œä¸”é¡ºåºå¿…é¡»å’ŒDTOçš„æ„é€ æ–¹æ³•çš„å‚æ•°é¡ºåºä¸€è‡´æ‰è¡Œ</p>
</blockquote>
<h4 id="è¿”å›Object"><a href="#è¿”å›Object" class="headerlink" title="è¿”å›Object[]"></a>è¿”å›Object[]</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">criteriaQuery.select(criteriaBuilder.array(root.get(xxx),join.get(xxx)));</span><br></pre></td></tr></table></figure>



<h3 id="å…ƒæ¨¡å‹æŸ¥è¯¢"><a href="#å…ƒæ¨¡å‹æŸ¥è¯¢" class="headerlink" title="å…ƒæ¨¡å‹æŸ¥è¯¢"></a>å…ƒæ¨¡å‹æŸ¥è¯¢</h3><p>å…ƒæ¨¡å‹å®ä¾‹é€šè¿‡è°ƒç”¨ <code>EntityManager.getMetamodel</code> æ–¹æ³•è·å¾—ï¼Œ<code>EntityType&lt;Employee&gt;</code>çš„å…ƒæ¨¡å‹å®ä¾‹é€šè¿‡è°ƒç”¨<code>Metamodel.entity(Employee.class)</code>è€Œè·å¾—ï¼Œå…¶è¢«ä¼ å…¥ <code>CriteriaQuery.from</code> è·å¾—æŸ¥è¯¢æ ¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Metamodel metamodel = em.getMetamodel();</span><br><span class="line">EntityType&lt;Employee&gt; Employee_ = metamodel.entity(Employee.class);</span><br><span class="line">Root&lt;Employee&gt; empRoot = criteriaQuery.from(Employee_);</span><br></pre></td></tr></table></figure>

<h3 id="TupleæŸ¥è¯¢"><a href="#TupleæŸ¥è¯¢" class="headerlink" title="TupleæŸ¥è¯¢"></a>TupleæŸ¥è¯¢</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†ç»„ç»Ÿè®¡é‡åæ•°é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Tuple&gt; <span class="title">groupByName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    CriteriaBuilder cb = em.getCriteriaBuilder();</span><br><span class="line">    CriteriaQuery&lt;Tuple&gt; query = cb.createTupleQuery();</span><br><span class="line">    Root&lt;Employee&gt; root = query.from(Employee.class);</span><br><span class="line">    Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT);</span><br><span class="line">    query.groupBy(join.get(EmployeeDetail_.name));</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        query.having(cb.like(join.get(EmployeeDetail_.name), <span class="string">&quot;%&quot;</span> + name + <span class="string">&quot;%&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    query.select(cb.tuple(join.get(EmployeeDetail_.name), cb.count(root)));</span><br><span class="line">    <span class="keyword">return</span> em.createQuery(query).getResultList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æè¿°ï¼šå¯¹äºBigDecimalè¿™ç§å¯¹è±¡åœ¨HQLé‡Œæ²¡æœ‰æ„é€ æ–¹æ³•çš„ã€‚å¯ä»¥ä½¿ç”¨æŸ¥è¯¢Objectå†å¼ºè½¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BigDecimal <span class="title">findRemainRefundableAmount</span><span class="params">(String orderNo)</span> </span>&#123;</span><br><span class="line">   CriteriaBuilder builder = entityManager.getCriteriaBuilder();</span><br><span class="line">    <span class="comment">// è¿”å›å€¼ç±»å‹è®¾ç½®ä¸ºObject</span></span><br><span class="line">   CriteriaQuery&lt;Object&gt; query = builder.createQuery(Object.class);</span><br><span class="line">   Root&lt;Account&gt; root = query.from(Account.class);</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢çš„æ—¶å€™å†è¿›è¡Œå¼ºè½¬</span></span><br><span class="line">   <span class="keyword">return</span> (BigDecimal) entityManager.createQuery(query).getSingleResult();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h2><p>å†™æ³•1ï¼šè¿™ç§å†™æ³•ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥æ’å…¶ä»–è¡¨çš„å­—æ®µï¼ˆuserRoot -&gt;  accountRoot ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">criteriaQuery.orderBy(builder.desc(userRoot.get(<span class="string">&quot;createTime&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>å†™æ³•2ï¼šè¿™ç§ä¼˜ç‚¹ï¼Œå¯ä»¥å°†ç›´æ¥å°†å‚æ•°çš„Pageableé‡Œé¢çš„sortå¯¹è±¡ä¹‹é—´æ’åº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">criteriaQuery.orderBy(QueryUtils.toOrders(pageable.getSort(), userRoot, builder));</span><br></pre></td></tr></table></figure>

<p>å†™æ³•3ï¼šæœ€å¸¸ç”¨çš„å†™æ³•ï¼Œå¯¹å¤šä¸ªå­—æ®µæ’åº<code>List&lt;Order&gt;</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">criteriaQuery.orderBy(orderList);</span><br></pre></td></tr></table></figure>



<h1 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h1><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://blog.wuwii.com/jpa-specification.html">JPA ä½¿ç”¨ Specification å¤æ‚æŸ¥è¯¢å’Œ Criteria æŸ¥è¯¢</a></p>
]]></content>
      <categories>
        <category>JPA</category>
      </categories>
      <tags>
        <tag>JPA</tag>
        <tag>Spring Data JPA</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM æ ¸å¿ƒæŠ€æœ¯</title>
    <url>/2020/10/19/JVM%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/</url>
    <content><![CDATA[<h1 id="JVM-åŸºç¡€çŸ¥è¯†"><a href="#JVM-åŸºç¡€çŸ¥è¯†" class="headerlink" title="JVM åŸºç¡€çŸ¥è¯†"></a>JVM åŸºç¡€çŸ¥è¯†</h1><h2 id="ä»€ä¹ˆæ˜¯-JVM"><a href="#ä»€ä¹ˆæ˜¯-JVM" class="headerlink" title="ä»€ä¹ˆæ˜¯ JVM"></a>ä»€ä¹ˆæ˜¯ JVM</h2><p>JVM æ˜¯ Java Virtual Machineï¼ˆ Java è™šæ‹Ÿæœºï¼‰çš„ç¼©å†™ï¼Œæ˜¯é€šè¿‡åœ¨å®é™…çš„è®¡ç®—æœºä¸Šä»¿çœŸæ¨¡æ‹Ÿå„ç§è®¡ç®—æœºåŠŸèƒ½æ¥å®ç°çš„ã€‚ç”±<strong>ä¸€å¥—å­—èŠ‚ç æŒ‡ä»¤é›†ã€ä¸€ç»„å¯„å­˜å™¨ã€ä¸€ä¸ªæ ˆã€ä¸€ä¸ªåƒåœ¾å›æ”¶å †å’Œä¸€ä¸ªå­˜å‚¨æ–¹æ³•åŸŸç­‰</strong>ç»„æˆã€‚JVM å±è”½äº†ä¸æ“ä½œç³»ç»Ÿå¹³å°ç›¸å…³çš„ä¿¡æ¯ï¼Œä½¿å¾— Java ç¨‹åºåªéœ€è¦ç”Ÿæˆåœ¨ Java è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ç›®æ ‡ä»£ç ï¼ˆå­—èŠ‚ç ï¼‰ï¼Œå°±å¯åœ¨å¤šç§å¹³å°ä¸Šä¸åŠ ä¿®æ”¹çš„è¿è¡Œï¼Œè¿™ä¹Ÿæ˜¯ Java èƒ½å¤Ÿâ€œ<strong>ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œçš„</strong>â€åŸå› ã€‚</p>
<h2 id="JREã€JDK-å’Œ-JVM-çš„å…³ç³»"><a href="#JREã€JDK-å’Œ-JVM-çš„å…³ç³»" class="headerlink" title="JREã€JDK å’Œ JVM çš„å…³ç³»"></a>JREã€JDK å’Œ JVM çš„å…³ç³»</h2><ul>
<li><p><strong>JVMï¼ˆ Java Virtual Machineï¼Œ Java è™šæ‹Ÿæœºï¼‰</strong>æ˜¯ JRE çš„ä¸€éƒ¨åˆ†ã€‚JVM ä¸»è¦å·¥ä½œæ˜¯è§£é‡Šè‡ªå·±çš„æŒ‡ä»¤é›†ï¼ˆå³å­—èŠ‚ç ï¼‰å¹¶æ˜ å°„åˆ°æœ¬åœ°çš„CPUæŒ‡ä»¤é›†å’ŒOSçš„ç³»ç»Ÿè°ƒç”¨ã€‚Java è¯­è¨€æ˜¯è·¨å¹³å°è¿è¡Œçš„ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¼šæœ‰ä¸åŒçš„ JVM æ˜ å°„è§„åˆ™ï¼Œä½¿ä¹‹ä¸æ“ä½œç³»ç»Ÿæ— å…³ï¼Œå®Œæˆè·¨å¹³å°æ€§ã€‚</p>
</li>
<li><p><strong>JREï¼ˆ Java Runtime Environmentï¼Œ Java è¿è¡Œç¯å¢ƒï¼‰</strong>ï¼šåœ¨ Java å¹³å°ï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½è¦åœ¨ JRE ä¸‹æ‰èƒ½å¤Ÿè¿è¡Œã€‚åŒ…æ‹¬ JVM å’Œ Java æ ¸å¿ƒç±»åº“å’Œæ”¯æŒæ–‡ä»¶ã€‚</p>
</li>
<li><p><strong>JDKï¼ˆ Java Development Kitï¼ŒJava å¼€å‘å·¥å…·åŒ…ï¼‰</strong>ï¼šæ˜¯ç”¨æ¥ç¼–è¯‘ã€è°ƒè¯• Java ç¨‹åºçš„å¼€å‘å·¥å…·åŒ…ï¼ŒåŒ…æ‹¬ Java å·¥å…·ï¼ˆ javac/java/jdb ç­‰ï¼‰å’Œ Java åŸºç¡€çš„ç±»åº“ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ“Œ åŒ…å«å…³ç³»ï¼šJVM &lt; JRE &lt; JDK</p>
</blockquote>
<h2 id="JVM-åŸç†"><a href="#JVM-åŸç†" class="headerlink" title="JVM åŸç†"></a>JVM åŸç†</h2><h3 id="Java-ä½“ç³»ç»“æ„ä»‹ç»"><a href="#Java-ä½“ç³»ç»“æ„ä»‹ç»" class="headerlink" title="Java ä½“ç³»ç»“æ„ä»‹ç»"></a>Java ä½“ç³»ç»“æ„ä»‹ç»</h3><p><img src="http://image.leonote.cn/20201030134056.png" alt=""></p>
<ul>
<li>Class Loaderï¼ˆç±»åŠ è½½å™¨ï¼‰ï¼šç”¨äºè£…è½½ .class æ–‡ä»¶ã€‚</li>
<li>Execution Engineï¼ˆæ‰§è¡Œå¼•æ“ï¼‰ï¼šç”¨äºæ‰§è¡Œå­—èŠ‚ç æˆ–è€…æœ¬åœ°æ–¹æ³•ã€‚</li>
<li>è¿è¡Œæ—¶æ•°æ®åŒºï¼šæ–¹æ³•åŒºã€å †ã€java æ ˆã€pc å¯„å­˜å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆã€‚</li>
</ul>
<h3 id="JVM-ç”Ÿå‘½å‘¨æœŸä»‹ç»"><a href="#JVM-ç”Ÿå‘½å‘¨æœŸä»‹ç»" class="headerlink" title="JVM ç”Ÿå‘½å‘¨æœŸä»‹ç»"></a>JVM ç”Ÿå‘½å‘¨æœŸä»‹ç»</h3><p>Java å®ä¾‹å¯¹åº”ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„ Java ç¨‹åºï¼ˆ<strong>è¿›ç¨‹çº§åˆ«</strong>ï¼‰</p>
<ol>
<li><p><strong>å¯åŠ¨</strong></p>
<p>å¯åŠ¨ä¸€ä¸ª Java ç¨‹åºï¼Œä¸€ä¸ª JVM å®ä¾‹å°±äº§ç”Ÿã€‚æ‹¥æœ‰ </p>
<p><code>public static void main(String[] args)</code> å‡½æ•°çš„ class å¯ä»¥ä½œä¸º JVM å®ä¾‹è¿è¡Œçš„èµ·ç‚¹ã€‚</p>
</li>
<li><p><strong>è¿è¡Œ</strong></p>
<p>main() ä½œä¸ºç¨‹åºåˆå§‹çº¿ç¨‹çš„èµ·ç‚¹ï¼Œä»»ä½•å…¶ä»–çº¿ç¨‹å‡å¯ç”±è¯¥çº¿ç¨‹å¯åŠ¨ã€‚</p>
<p>JVM å†…éƒ¨æœ‰ä¸¤ç§çº¿ç¨‹ï¼šå®ˆæŠ¤çº¿ç¨‹å’Œéå®ˆæŠ¤çº¿ç¨‹ï¼Œmain() å±äºéå®ˆæŠ¤çº¿ç¨‹ï¼Œå®ˆæŠ¤çº¿ç¨‹é€šå¸¸ç”± JVM ä½¿ç”¨ï¼Œç¨‹åºå¯ä»¥æŒ‡å®šåˆ›å»ºçš„çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚</p>
</li>
<li><p><strong>æ¶ˆäº¡</strong></p>
<p>å½“ç¨‹åºä¸­çš„æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹éƒ½ç»ˆæ­¢æ—¶ï¼ŒJVM æ‰é€€å‡ºï¼›è‹¥å®‰å…¨ç®¡ç†å™¨å…è®¸ï¼Œç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ Runtime ç±»æˆ–è€… <code>System.exit()</code> æ¥é€€å‡ºã€‚</p>
</li>
</ol>
<p>JVM æ‰§è¡Œå¼•æ“å®ä¾‹åˆ™å¯¹åº”äº†å±äºç”¨æˆ·è¿è¡Œç¨‹åºçº¿ç¨‹ï¼Œå®ƒæ˜¯çº¿ç¨‹çº§åˆ«çš„ã€‚</p>
<h2 id="JVM-ç±»åŠ è½½å™¨"><a href="#JVM-ç±»åŠ è½½å™¨" class="headerlink" title="JVM ç±»åŠ è½½å™¨"></a>JVM ç±»åŠ è½½å™¨</h2><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://juejin.im/post/6844904114543919111">ç±»åŠ è½½å™¨</a></p>
<h3 id="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ç±»çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"></a>ç±»çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="http://image.leonote.cn/20201030162432.png" alt=""></p>
<ol>
<li><p><strong>è£…è½½ï¼ˆloadingï¼‰</strong>ï¼š</p>
<p>è´Ÿè´£æ‰¾åˆ° Class æ–‡ä»¶å¹¶åŠ è½½è‡³ JVM ä¸­ï¼ŒJVM é€šè¿‡ç±»åã€ç±»æ‰€åœ¨çš„åŒ…åã€ClassLoaderå®Œæˆç±»çš„åŠ è½½ã€‚å› æ­¤ï¼Œæ ‡è¯†ä¸€ä¸ªè¢«åŠ è½½äº†çš„ç±»ï¼šç±»å + åŒ…å + ClassLoader å®ä¾‹ IDã€‚</p>
</li>
<li><p><strong>é“¾æ¥ï¼ˆlinkingï¼‰</strong>ï¼š</p>
<ol>
<li><p>éªŒè¯ï¼ˆVerifyingï¼‰ï¼šéªŒè¯ Class æ–‡ä»¶çš„æ ¼å¼ä»¥åŠä¾èµ–ï¼Œä¿è¯ JVM èƒ½å¤Ÿæ‰§è¡Œ</p>
</li>
<li><p>å‡†å¤‡ï¼ˆPreparingï¼‰ï¼šä¸ºç”± static ä¿®é¥°çš„æˆå‘˜å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤çš„åˆå§‹å€¼</p>
<p>é»˜è®¤åˆå§‹å€¼å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…«ç§åŸºæœ¬æ•°æ®ç±»å‹é»˜è®¤çš„åˆå§‹å€¼æ˜¯0</li>
<li>å¼•ç”¨ç±»å‹é»˜è®¤çš„åˆå§‹å€¼æ˜¯ null</li>
<li>æœ‰ static final ä¿®é¥°çš„ä¼šç›´æ¥èµ‹å€¼</li>
</ul>
</li>
<li><p>è§£æï¼ˆResolvingï¼‰ï¼šæŠŠå¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p>
<p>å³ JVM ä¼šå°†æ‰€æœ‰çš„ç±»æˆ–æ¥å£åã€å­—æ®µåã€æ–¹æ³•åè½¬æ¢ä¸ºå…·ä½“çš„å†…å­˜åœ°å€</p>
</li>
</ol>
</li>
<li><p><strong>åˆå§‹åŒ–ï¼ˆInitializingï¼‰</strong>ï¼š</p>
<p>è´Ÿè´£å°†ç±»ä¸­çš„é™æ€å˜é‡ï¼ˆç±»å˜é‡ï¼‰èµ‹å€¼çš„è¿‡ç¨‹ï¼Œå³åªæœ‰ static ä¿®é¥°çš„æ‰èƒ½è¢«åˆå§‹åŒ–ã€‚</p>
<blockquote>
<p>æ‰§è¡Œé¡ºåºï¼šçˆ¶ç±»é™æ€åŸŸæˆ–ç€é™æ€ä»£ç å—ï¼Œç„¶åæ˜¯å­ç±»é™æ€åŸŸæˆ–è€…å­ç±»é™æ€ä»£ç å—</p>
</blockquote>
</li>
<li><p><strong>ä½¿ç”¨ï¼ˆUsingï¼‰</strong>ï¼š </p>
<ol>
<li><p>å¯¹è±¡å®ä¾‹åŒ–ï¼šæ‰§è¡Œç±»ä¸­æ„é€ å‡½æ•°çš„å†…å®¹</p>
<p>å¦‚æœå­˜åœ¨çˆ¶ç±»ï¼ŒJVM ä¼šé€šè¿‡æ˜¾ç¤ºæˆ–è€…éšç¤ºçš„æ–¹å¼å…ˆæ‰§è¡Œçˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œåœ¨å †å†…å­˜ä¸­ä¸ºçˆ¶ç±»çš„å®ä¾‹å˜é‡å¼€è¾Ÿç©ºé—´ï¼Œå¹¶èµ‹äºˆé»˜è®¤çš„åˆå§‹å€¼ï¼Œç„¶ååœ¨æ ¹æ®æ„é€ å‡½æ•°çš„ä»£ç å†…å®¹å°†çœŸæ­£çš„å€¼èµ‹äºˆå®ä¾‹å˜é‡æœ¬èº«ï¼Œç„¶åï¼Œå¼•ç”¨å˜é‡è·å–å¯¹è±¡çš„é¦–åœ°å€ï¼Œé€šè¿‡æ“ä½œå¯¹è±¡æ¥è°ƒç”¨å®ä¾‹å˜é‡å’Œæ–¹æ³•</p>
</li>
<li><p>åƒåœ¾æ”¶é›†ï¼šå½“å¯¹è±¡ä¸å†è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šè¢«è™šæ‹Ÿæœºæ ‡ä¸Šç‰¹åˆ«çš„åƒåœ¾è®°å·ï¼Œåœ¨å †ä¸­ç­‰å¾… GC å›æ”¶</p>
</li>
<li><p>å¯¹è±¡ç»ˆç»“ï¼šå¯¹è±¡è¢« GC å›æ”¶åï¼Œå¯¹è±¡å°±ä¸å†å­˜åœ¨ï¼Œå¯¹è±¡çš„ç”Ÿå‘½ä¹Ÿå°±èµ°åˆ°äº†å°½å¤´</p>
</li>
</ol>
</li>
<li><p><strong>å¸è½½ï¼ˆUnloadingï¼‰</strong>ï¼š</p>
<p>å³ç±»çš„ç”Ÿå‘½å‘¨æœŸèµ°åˆ°äº†æœ€åä¸€æ­¥ï¼Œç¨‹åºä¸­ä¸å†æœ‰è¯¥ç±»çš„å¼•ç”¨ï¼Œè¯¥ç±»ä¹Ÿå°±ä¼šè¢« JVM æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œä»æ­¤ç”Ÿå‘½ç»“æŸâ€¦</p>
</li>
</ol>
<h3 id="ç±»åˆå§‹åŒ–é¡ºåº"><a href="#ç±»åˆå§‹åŒ–é¡ºåº" class="headerlink" title="ç±»åˆå§‹åŒ–é¡ºåº"></a>ç±»åˆå§‹åŒ–é¡ºåº</h3><blockquote>
<p>ç±»åˆå§‹åŒ–çš„ä¸€äº›è§„åˆ™ï¼š</p>
<ol>
<li>ç±»ä»é¡¶è‡³åº•çš„é¡ºåºåˆå§‹åŒ–ï¼Œæ‰€ä»¥å£°æ˜åœ¨é¡¶éƒ¨çš„å­—æ®µçš„æ—©äºåº•éƒ¨çš„å­—æ®µåˆå§‹åŒ– </li>
<li>è¶…ç±»æ—©äºå­ç±»å’Œè¡ç”Ÿç±»çš„åˆå§‹åŒ– </li>
<li>å¦‚æœç±»çš„åˆå§‹åŒ–æ˜¯ç”±äºè®¿é—®é™æ€åŸŸè€Œè§¦å‘ï¼Œé‚£ä¹ˆåªæœ‰å£°æ˜é™æ€åŸŸçš„ç±»æ‰è¢«åˆå§‹åŒ–ï¼Œè€Œä¸ä¼šè§¦å‘è¶…ç±»çš„åˆå§‹åŒ–æˆ–è€…å­ç±»çš„</li>
<li>åˆå§‹åŒ–å³ä½¿é™æ€åŸŸè¢«å­ç±»æˆ–å­æ¥å£æˆ–è€…å®ƒçš„å®ç°ç±»æ‰€å¼•ç”¨ </li>
<li>æ¥å£åˆå§‹åŒ–ä¸ä¼šå¯¼è‡´çˆ¶æ¥å£çš„åˆå§‹åŒ–</li>
<li>é™æ€åŸŸçš„åˆå§‹åŒ–æ˜¯åœ¨ç±»çš„é™æ€åˆå§‹åŒ–æœŸé—´ï¼Œéé™æ€åŸŸçš„åˆå§‹åŒ–æ—¶åœ¨ç±»çš„å®ä¾‹åˆ›å»ºæœŸé—´ã€‚è¿™æ„å‘³è¿™é™æ€åŸŸåˆå§‹åŒ–åœ¨éé™æ€åŸŸä¹‹å‰</li>
<li>éé™æ€åŸŸé€šè¿‡æ„é€ å™¨åˆå§‹åŒ–ï¼Œå­ç±»åœ¨åšä»»ä½•åˆå§‹åŒ–ä¹‹å‰æ„é€ å™¨ä¼šéšå«åœ°è°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ï¼Œä»–ä¿è¯äº†éé™æ€æˆ–å®ä¾‹å˜é‡ï¼ˆçˆ¶ç±»ï¼‰åˆå§‹åŒ–æ—©äºå­ç±»</li>
</ol>
</blockquote>
<h3 id="ç±»çš„åŠ è½½æ—¶æœº"><a href="#ç±»çš„åŠ è½½æ—¶æœº" class="headerlink" title="ç±»çš„åŠ è½½æ—¶æœº"></a>ç±»çš„åŠ è½½æ—¶æœº</h3><ol>
<li>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–ç”¨æˆ·æŒ‡å®šçš„ä¸»ç±»ï¼Œå°±æ˜¯å¯åŠ¨æ‰§è¡Œçš„ main æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼›</li>
<li>å½“é‡åˆ°ç”¨ä»¥æ–°å»ºç›®æ ‡ç±»å®ä¾‹çš„ new æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ– new æŒ‡ä»¤çš„ç›®æ ‡ç±»ï¼Œå°±æ˜¯ new ä¸€ä¸ªç±»çš„æ—¶å€™è¦åˆå§‹åŒ–ï¼› </li>
<li>å½“é‡åˆ°è°ƒç”¨é™æ€æ–¹æ³•çš„æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ–è¯¥é™æ€æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼›</li>
<li>å½“é‡åˆ°è®¿é—®é™æ€å­—æ®µçš„æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ–è¯¥é™æ€å­—æ®µæ‰€åœ¨çš„ç±»ï¼›</li>
<li>å­ç±»çš„åˆå§‹åŒ–ä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ï¼›</li>
<li>å¦‚æœä¸€ä¸ªæ¥å£å®šä¹‰äº† default æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥å®ç°æˆ–è€…é—´æ¥å®ç°è¯¥æ¥å£çš„ç±»çš„åˆå§‹åŒ–ï¼Œ ä¼š è§¦å‘è¯¥æ¥å£çš„åˆå§‹åŒ–ï¼›</li>
<li>ä½¿ç”¨åå°„ API å¯¹æŸä¸ªç±»è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ–è¿™ä¸ªç±»ï¼Œå…¶å®è·Ÿå‰é¢ä¸€æ ·ï¼Œåå°„è°ƒç”¨ è¦ä¹ˆæ˜¯å·²ç»æœ‰å®ä¾‹äº†ï¼Œè¦ä¹ˆæ˜¯é™æ€æ–¹æ³•ï¼Œéƒ½éœ€è¦åˆå§‹åŒ–ï¼›</li>
<li>å½“åˆæ¬¡è°ƒç”¨ MethodHandle å®ä¾‹æ—¶ï¼Œåˆå§‹åŒ–è¯¥ MethodHandle æŒ‡å‘çš„æ–¹æ³•æ‰€åœ¨çš„ç±»ã€‚</li>
</ol>
<h3 id="ä¸ä¼šåˆå§‹åŒ–ï¼ˆå¯èƒ½ä¼šåŠ è½½ï¼‰"><a href="#ä¸ä¼šåˆå§‹åŒ–ï¼ˆå¯èƒ½ä¼šåŠ è½½ï¼‰" class="headerlink" title="ä¸ä¼šåˆå§‹åŒ–ï¼ˆå¯èƒ½ä¼šåŠ è½½ï¼‰"></a>ä¸ä¼šåˆå§‹åŒ–ï¼ˆå¯èƒ½ä¼šåŠ è½½ï¼‰</h3><h3 id="ä¸‰ç±»åŠ è½½å™¨"><a href="#ä¸‰ç±»åŠ è½½å™¨" class="headerlink" title="ä¸‰ç±»åŠ è½½å™¨"></a>ä¸‰ç±»åŠ è½½å™¨</h3><h3 id="æ˜¾ç¤ºå½“å‰-ClassLoader-åŠ è½½äº†å“ªäº›-Jar"><a href="#æ˜¾ç¤ºå½“å‰-ClassLoader-åŠ è½½äº†å“ªäº›-Jar" class="headerlink" title="æ˜¾ç¤ºå½“å‰ ClassLoader åŠ è½½äº†å“ªäº› Jar?"></a>æ˜¾ç¤ºå½“å‰ ClassLoader åŠ è½½äº†å“ªäº› Jar?</h3><h3 id="è‡ªå®šä¹‰-ClassLoader"><a href="#è‡ªå®šä¹‰-ClassLoader" class="headerlink" title="è‡ªå®šä¹‰ ClassLoader"></a>è‡ªå®šä¹‰ ClassLoader</h3><h3 id="æ·»åŠ å¼•ç”¨ç±»çš„å‡ ç§æ–¹å¼"><a href="#æ·»åŠ å¼•ç”¨ç±»çš„å‡ ç§æ–¹å¼" class="headerlink" title="æ·»åŠ å¼•ç”¨ç±»çš„å‡ ç§æ–¹å¼"></a>æ·»åŠ å¼•ç”¨ç±»çš„å‡ ç§æ–¹å¼</h3><h2 id="JVM-å†…å­˜æ¨¡å‹"><a href="#JVM-å†…å­˜æ¨¡å‹" class="headerlink" title="JVM å†…å­˜æ¨¡å‹"></a>JVM å†…å­˜æ¨¡å‹</h2><h3 id="JVM-å†…å­˜ç»“æ„"><a href="#JVM-å†…å­˜ç»“æ„" class="headerlink" title="JVM å†…å­˜ç»“æ„"></a>JVM å†…å­˜ç»“æ„</h3><h3 id="JVM-å†…å­˜æ•´ä½“ç»“æ„"><a href="#JVM-å†…å­˜æ•´ä½“ç»“æ„" class="headerlink" title="JVM å†…å­˜æ•´ä½“ç»“æ„"></a>JVM å†…å­˜æ•´ä½“ç»“æ„</h3><h3 id="JVM-æ ˆå†…å­˜ç»“æ„"><a href="#JVM-æ ˆå†…å­˜ç»“æ„" class="headerlink" title="JVM æ ˆå†…å­˜ç»“æ„"></a>JVM æ ˆå†…å­˜ç»“æ„</h3><h3 id="JVMé˜Ÿå†…å­˜ç»“æ„"><a href="#JVMé˜Ÿå†…å­˜ç»“æ„" class="headerlink" title="JVMé˜Ÿå†…å­˜ç»“æ„"></a>JVMé˜Ÿå†…å­˜ç»“æ„</h3><h3 id="CPUä¸å†…å­˜è¡Œä¸º"><a href="#CPUä¸å†…å­˜è¡Œä¸º" class="headerlink" title="CPUä¸å†…å­˜è¡Œä¸º"></a>CPUä¸å†…å­˜è¡Œä¸º</h3><h3 id="å°ç»“ï¼šä»€ä¹ˆæ˜¯-JMM"><a href="#å°ç»“ï¼šä»€ä¹ˆæ˜¯-JMM" class="headerlink" title="å°ç»“ï¼šä»€ä¹ˆæ˜¯ JMM ?"></a>å°ç»“ï¼šä»€ä¹ˆæ˜¯ JMM ?</h3><h2 id="JAVA-å­—èŠ‚ç "><a href="#JAVA-å­—èŠ‚ç " class="headerlink" title="JAVA å­—èŠ‚ç "></a>JAVA å­—èŠ‚ç </h2><h3 id="å‚è€ƒèµ„æ–™-1"><a href="#å‚è€ƒèµ„æ–™-1" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://juejin.im/post/6844903939112976391">JAVAå­—èŠ‚ç çš„æ¢ç§˜</a></p>
<p><a href="https://juejin.im/post/6844903588716609543">è½»æ¾çœ‹æ‡‚JAVAå­—èŠ‚ç </a></p>
<h3 id="ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿ</h3><p>å­—èŠ‚ç ç”±å•å­—èŠ‚çš„æŒ‡ä»¤ç»„æˆï¼Œç†è®ºä¸Šæœ€å¤šæ”¯æŒ256ä¸ªæ“ä½œç ï¼ˆopcodeï¼‰ï¼Œå®é™…ä¸ŠJavaåªä½¿ç”¨äº†200å·¦å³çš„æ“ä½œç ï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œç åˆ™ä¿ç•™ç»™è°ƒè¯•æ“ä½œ</p>
<p>æ ¹æ®æŒ‡ä»¤çš„æ€§è´¨ï¼Œä¸»è¦åˆ†ä¸ºå››ä¸ªå¤§ç±»ï¼š</p>
<ol>
<li>æ ˆæ“ä½œæŒ‡ä»¤ï¼ŒåŒ…æ‹¬ä¸å±€éƒ¨å˜é‡äº¤äº’çš„æŒ‡ä»¤</li>
<li>ç¨‹åºæµç¨‹æ§åˆ¶æŒ‡ä»¤</li>
<li>å¯¹è±¡æ“ä½œæŒ‡ä»¤ï¼ŒåŒ…æ‹¬æ–¹æ³•è°ƒç”¨æŒ‡ä»¤</li>
<li>ç®—æœ¯è¿ç®—ä»¥åŠç±»å‹è½¬æ¢æŒ‡ä»¤</li>
</ol>
<h3 id="ç”Ÿæˆå­—èŠ‚ç "><a href="#ç”Ÿæˆå­—èŠ‚ç " class="headerlink" title="ç”Ÿæˆå­—èŠ‚ç "></a>ç”Ÿæˆå­—èŠ‚ç </h3><h3 id="æœ€ç®€å•çš„å­—èŠ‚ç "><a href="#æœ€ç®€å•çš„å­—èŠ‚ç " class="headerlink" title="æœ€ç®€å•çš„å­—èŠ‚ç "></a>æœ€ç®€å•çš„å­—èŠ‚ç </h3><h3 id="å¤æ‚ç‚¹çš„ä¾‹å­"><a href="#å¤æ‚ç‚¹çš„ä¾‹å­" class="headerlink" title="å¤æ‚ç‚¹çš„ä¾‹å­"></a>å¤æ‚ç‚¹çš„ä¾‹å­</h3><h3 id="å­—èŠ‚ç çš„è¿è¡Œæ—¶ç»“æ„"><a href="#å­—èŠ‚ç çš„è¿è¡Œæ—¶ç»“æ„" class="headerlink" title="å­—èŠ‚ç çš„è¿è¡Œæ—¶ç»“æ„"></a>å­—èŠ‚ç çš„è¿è¡Œæ—¶ç»“æ„</h3><h3 id="ä»åŠ©è®°ç¬¦åˆ°äºŒè¿›åˆ¶"><a href="#ä»åŠ©è®°ç¬¦åˆ°äºŒè¿›åˆ¶" class="headerlink" title="ä»åŠ©è®°ç¬¦åˆ°äºŒè¿›åˆ¶"></a>ä»åŠ©è®°ç¬¦åˆ°äºŒè¿›åˆ¶</h3><h3 id="å››åˆ™è¿è¡Œçš„ä¾‹å­"><a href="#å››åˆ™è¿è¡Œçš„ä¾‹å­" class="headerlink" title="å››åˆ™è¿è¡Œçš„ä¾‹å­"></a>å››åˆ™è¿è¡Œçš„ä¾‹å­</h3><h3 id="æ•°å€¼å¤„ç†ä¸æœ¬åœ°å˜é‡è¡¨"><a href="#æ•°å€¼å¤„ç†ä¸æœ¬åœ°å˜é‡è¡¨" class="headerlink" title="æ•°å€¼å¤„ç†ä¸æœ¬åœ°å˜é‡è¡¨"></a>æ•°å€¼å¤„ç†ä¸æœ¬åœ°å˜é‡è¡¨</h3><h3 id="ç®—æ•°æ“ä½œä¸ç±»å‹è½¬æ¢"><a href="#ç®—æ•°æ“ä½œä¸ç±»å‹è½¬æ¢" class="headerlink" title="ç®—æ•°æ“ä½œä¸ç±»å‹è½¬æ¢"></a>ç®—æ•°æ“ä½œä¸ç±»å‹è½¬æ¢</h3><h3 id="ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯æ§åˆ¶"><a href="#ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯æ§åˆ¶" class="headerlink" title="ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯æ§åˆ¶"></a>ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯æ§åˆ¶</h3><h3 id="æ–¹æ³•è°ƒç”¨çš„æŒ‡ä»¤"><a href="#æ–¹æ³•è°ƒç”¨çš„æŒ‡ä»¤" class="headerlink" title="æ–¹æ³•è°ƒç”¨çš„æŒ‡ä»¤"></a>æ–¹æ³•è°ƒç”¨çš„æŒ‡ä»¤</h3><ul>
<li>invokestaticï¼šé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæŒ‡ä»¤ç”¨äºè°ƒç”¨æŸä¸ªç±»çš„é™æ€æ–¹æ³•ï¼Œè¿™æ˜¯æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ä¸­æœ€å¿«çš„ä¸€ä¸ªã€‚</li>
<li>invokespecialï¼šç”¨æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºè°ƒç”¨åŒä¸€ä¸ªç±»ä¸­çš„ private æ–¹æ³•, ä»¥åŠå¯è§çš„è¶…ç±»æ–¹æ³•ã€‚ </li>
<li>invokevirtualï¼šå¦‚æœæ˜¯å…·ä½“ç±»å‹çš„ç›®æ ‡å¯¹è±¡ï¼Œinvokevirtual ç”¨äºè°ƒç”¨å…¬å…±ï¼Œå—ä¿æŠ¤å’Œ package çº§çš„ç§æœ‰æ–¹æ³•ã€‚ </li>
<li>invokeinterfaceï¼šå½“é€šè¿‡æ¥å£å¼•ç”¨æ¥è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°†ä¼šç¼–è¯‘ä¸º invokeinterface æŒ‡ä»¤ã€‚</li>
<li>invokedynamicï¼šJDK7 æ–°å¢åŠ çš„æŒ‡ä»¤ï¼Œæ˜¯å®ç°â€œåŠ¨æ€ç±»å‹è¯­è¨€â€ï¼ˆDynamically Typed Languageï¼‰æ”¯æŒè€Œè¿›è¡Œçš„å‡çº§æ”¹è¿›ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ JDK8 ä»¥åæ”¯æŒ lambda è¡¨è¾¾å¼çš„å®ç°åŸºç¡€ã€‚</li>
</ul>
<h3 id="ä¸€ä¸ªåŠ¨æ€ä¾‹å­"><a href="#ä¸€ä¸ªåŠ¨æ€ä¾‹å­" class="headerlink" title="ä¸€ä¸ªåŠ¨æ€ä¾‹å­"></a>ä¸€ä¸ªåŠ¨æ€ä¾‹å­</h3><h2 id="JVM-å¯åŠ¨å‚æ•°"><a href="#JVM-å¯åŠ¨å‚æ•°" class="headerlink" title="JVM å¯åŠ¨å‚æ•°"></a>JVM å¯åŠ¨å‚æ•°</h2><h3 id="ç³»ç»Ÿå±æ€§"><a href="#ç³»ç»Ÿå±æ€§" class="headerlink" title="ç³»ç»Ÿå±æ€§"></a>ç³»ç»Ÿå±æ€§</h3><h3 id="è¿è¡Œæ¨¡å¼"><a href="#è¿è¡Œæ¨¡å¼" class="headerlink" title="è¿è¡Œæ¨¡å¼"></a>è¿è¡Œæ¨¡å¼</h3><h3 id="å †å†…å­˜"><a href="#å †å†…å­˜" class="headerlink" title="å †å†…å­˜"></a>å †å†…å­˜</h3><h3 id="GCç›¸å…³"><a href="#GCç›¸å…³" class="headerlink" title="GCç›¸å…³"></a>GCç›¸å…³</h3><h3 id="åˆ†æè¯Šæ–­"><a href="#åˆ†æè¯Šæ–­" class="headerlink" title="åˆ†æè¯Šæ–­"></a>åˆ†æè¯Šæ–­</h3><h3 id="JavaAgents"><a href="#JavaAgents" class="headerlink" title="JavaAgents"></a>JavaAgents</h3>]]></content>
      <tags>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaScript forå¾ªç¯å†™æ³•</title>
    <url>/2020/11/10/JavaScript%20for%E5%BE%AA%E7%8E%AF%E5%86%99%E6%B3%95/</url>
    <content><![CDATA[<h1 id="JavaScript-forå¾ªç¯å†™æ³•"><a href="#JavaScript-forå¾ªç¯å†™æ³•" class="headerlink" title="JavaScript forå¾ªç¯å†™æ³•"></a>JavaScript forå¾ªç¯å†™æ³•</h1><h2 id="ç®€å•-for-å¾ªç¯"><a href="#ç®€å•-for-å¾ªç¯" class="headerlink" title="ç®€å• for å¾ªç¯"></a>ç®€å• for å¾ªç¯</h2><p>ä¸‹é¢å…ˆæ¥çœ‹çœ‹å¤§å®¶æœ€å¸¸è§çš„ä¸€ç§å†™æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; iã€€&lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(arr[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æ•°ç»„é•¿åº¦åœ¨å¾ªç¯è¿‡ç¨‹ä¸­ä¸ä¼šæ”¹å˜æ—¶ï¼Œæˆ‘ä»¬åº”å°†æ•°ç»„é•¿åº¦ç”¨å˜é‡å­˜å‚¨èµ·æ¥ï¼Œè¿™æ ·ä¼šè·å¾—æ›´å¥½çš„æ•ˆç‡ï¼Œä¸‹é¢æ˜¯æ”¹è¿›çš„å†™æ³•ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>, len = arr.length; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(arr[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="for-in"><a href="#for-in" class="headerlink" title="for-in"></a>for-in</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ for-in æ¥éå†ä¸€éæ•°ç»„çš„å†…å®¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> index;</span><br><span class="line"><span class="keyword">for</span>(index <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;arr[&quot;</span> + index + <span class="string">&quot;] = &quot;</span> + arr[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">arr[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">arr[<span class="number">2</span>] = <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>ä½†è¿™ä¹ˆåšå¾€å¾€ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<p><strong>for-in çš„çœŸç›¸</strong></p>
<p>for-in å¾ªç¯éå†çš„æ˜¯å¯¹è±¡çš„å±æ€§ï¼Œè€Œä¸æ˜¯æ•°ç»„çš„ç´¢å¼•ã€‚å› æ­¤ï¼Œ for-in éå†çš„å¯¹è±¡ä¾¿ä¸å±€é™äºæ•°ç»„ï¼Œè¿˜å¯ä»¥éå†å¯¹è±¡ã€‚ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">    fname: <span class="string">&quot;san&quot;</span>,</span><br><span class="line">    lname: <span class="string">&quot;zhang&quot;</span>,</span><br><span class="line">    age: <span class="number">99</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> info;</span><br><span class="line"><span class="keyword">for</span>(info <span class="keyword">in</span> person) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;person[&quot;</span> + info + <span class="string">&quot;] = &quot;</span> + person[info]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">person[fname] = san</span><br><span class="line">person[lname] = zhang</span><br><span class="line">person[age] = <span class="number">99</span></span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ for-in éå†å±æ€§çš„é¡ºåºå¹¶ä¸ç¡®å®šï¼Œå³è¾“å‡ºçš„ç»“æœé¡ºåºä¸å±æ€§åœ¨å¯¹è±¡ä¸­çš„é¡ºåºæ— å…³ï¼Œä¹Ÿä¸å±æ€§çš„å­—æ¯é¡ºåºæ— å…³ï¼Œä¸å…¶ä»–ä»»ä½•é¡ºåºä¹Ÿæ— å…³ã€‚</p>
<p><strong>Array çš„çœŸç›¸</strong></p>
<p>Array åœ¨ JavaScript ä¸­æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ Array çš„ç´¢å¼•æ˜¯å±æ€§åã€‚äº‹å®ä¸Šï¼Œ JavaScript ä¸­çš„ â€œarrayâ€ æœ‰äº›è¯¯å¯¼æ€§ï¼Œ JavaScript ä¸­çš„ Array å¹¶ä¸åƒå¤§éƒ¨åˆ†å…¶ä»–è¯­è¨€çš„æ•°ç»„ã€‚é¦–å…ˆï¼Œ JavaScript ä¸­çš„ Array åœ¨å†…å­˜ä¸Šå¹¶ä¸è¿ç»­ï¼Œå…¶æ¬¡ï¼Œ Array çš„ç´¢å¼•å¹¶ä¸æ˜¯æŒ‡åç§»é‡ã€‚å®é™…ä¸Šï¼Œ Array çš„ç´¢å¼•ä¹Ÿä¸æ˜¯ Number ç±»å‹ï¼Œè€Œæ˜¯ String ç±»å‹çš„ã€‚æˆ‘ä»¬å¯ä»¥æ­£ç¡®ä½¿ç”¨å¦‚ arr[0] çš„å†™æ³•çš„åŸå› æ˜¯è¯­è¨€å¯ä»¥è‡ªåŠ¨å°† Number ç±»å‹çš„ 0 è½¬æ¢æˆ String ç±»å‹çš„ â€œ0â€³ ã€‚æ‰€ä»¥ï¼Œåœ¨ JavaScript ä¸­ä»æ¥å°±æ²¡æœ‰ Array çš„ç´¢å¼•ï¼Œè€Œåªæœ‰ç±»ä¼¼ â€œ0â€³ ã€ â€œ1â€³ ç­‰ç­‰çš„å±æ€§ã€‚æœ‰è¶£çš„æ˜¯ï¼Œæ¯ä¸ª Array å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª length çš„å±æ€§ï¼Œå¯¼è‡´å…¶è¡¨ç°åœ°æ›´åƒå…¶ä»–è¯­è¨€çš„æ•°ç»„ã€‚ä½†ä¸ºä»€ä¹ˆåœ¨éå† Array å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰è¾“å‡º length è¿™ä¸€æ¡å±æ€§å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º for-in åªèƒ½éå†â€œå¯æšä¸¾çš„å±æ€§â€ï¼Œ length å±äºä¸å¯æšä¸¾å±æ€§ï¼Œå®é™…ä¸Šï¼Œ Array å¯¹è±¡è¿˜æœ‰è®¸å¤šå…¶ä»–ä¸å¯æšä¸¾çš„å±æ€§ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹çœ‹ç”¨ for-in æ¥å¾ªç¯æ•°ç»„çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å‰é¢éå†æ•°ç»„çš„ä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.name = <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> index;</span><br><span class="line"><span class="keyword">for</span>(index <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;arr[&quot;</span> + index + <span class="string">&quot;] = &quot;</span> + arr[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœæ˜¯ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">arr[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">arr[<span class="number">2</span>] = <span class="number">3</span></span><br><span class="line">arr[name] = Hello world</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹åˆ° for-in å¾ªç¯è®¿é—®äº†æˆ‘ä»¬æ–°å¢çš„ â€œnameâ€ å±æ€§ï¼Œå› ä¸º for-in éå†äº†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œè€Œä¸ä»…ä»…æ˜¯â€œç´¢å¼•â€ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„è¾“å‡ºçš„ç´¢å¼•å€¼ï¼Œå³ â€œ0â€³ã€ â€œ1â€³ã€ â€œ2â€³ä¸æ˜¯ Number ç±»å‹çš„ï¼Œè€Œæ˜¯ String ç±»å‹çš„ï¼Œå› ä¸ºå…¶å°±æ˜¯ä½œä¸ºå±æ€§è¾“å‡ºï¼Œè€Œä¸æ˜¯ç´¢å¼•ã€‚é‚£æ˜¯ä¸æ˜¯è¯´ä¸åœ¨æˆ‘ä»¬çš„ Array å¯¹è±¡ä¸­æ·»åŠ æ–°çš„å±æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥åªè¾“å‡ºæ•°ç»„ä¸­çš„å†…å®¹äº†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å› ä¸º for-in ä¸ä»…ä»…éå† array è‡ªèº«çš„å±æ€§ï¼Œå…¶è¿˜éå† array åŸå‹é“¾ä¸Šçš„æ‰€æœ‰å¯æšä¸¾çš„å±æ€§ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Array</span>.prototype.fatherName = <span class="string">&quot;Father&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.name = <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> index;</span><br><span class="line"><span class="keyword">for</span>(index <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;arr[&quot;</span> + index + <span class="string">&quot;] = &quot;</span> + arr[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœæ˜¯ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">arr[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">arr[<span class="number">2</span>] = <span class="number">3</span></span><br><span class="line">arr[name] = Hello world</span><br><span class="line">arr[fatherName] = Father</span><br></pre></td></tr></table></figure>

<p>å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° for-in å¹¶ä¸é€‚åˆç”¨æ¥éå† Array ä¸­çš„å…ƒç´ ï¼Œå…¶æ›´é€‚åˆéå†å¯¹è±¡ä¸­çš„å±æ€§ï¼Œè¿™ä¹Ÿæ˜¯å…¶è¢«åˆ›é€ å‡ºæ¥çš„åˆè¡·ã€‚å´æœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå°±æ˜¯ç¨€ç–æ•°ç»„ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> key;</span><br><span class="line"><span class="keyword">const</span> arr = [];</span><br><span class="line">arr[<span class="number">0</span>] = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">arr[<span class="number">100</span>] = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">arr[<span class="number">10000</span>] = <span class="string">&quot;c&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(key <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    <span class="keyword">if</span>(arr.hasOwnProperty(key)  &amp;&amp;    </span><br><span class="line">        /^<span class="number">0</span>$|^[<span class="number">1</span>-<span class="number">9</span>]\d*$/.test(key) &amp;&amp;    </span><br><span class="line">        key &lt;= <span class="number">4294967294</span>               </span><br><span class="line">        ) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(arr[key]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for-in åªä¼šéå†å­˜åœ¨çš„å®ä½“ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ for-in éå†äº†3æ¬¡ï¼ˆéå†å±æ€§åˆ†åˆ«ä¸ºâ€0â€³ã€ â€œ100â€³ã€ â€œ10000â€³çš„å…ƒç´ ï¼Œæ™®é€š for å¾ªç¯åˆ™ä¼šéå† 10001 æ¬¡ï¼‰ã€‚æ‰€ä»¥ï¼Œåªè¦å¤„ç†å¾—å½“ï¼Œ for-in åœ¨éå† Array ä¸­å…ƒç´ ä¹Ÿèƒ½å‘æŒ¥å·¨å¤§ä½œç”¨ã€‚</p>
<p>ä¸ºäº†é¿å…é‡å¤åŠ³åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥åŒ…è£…ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arrayHasOwnIndex</span>(<span class="params">array, prop</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array.hasOwnProperty(prop) &amp;&amp; </span><br><span class="line">        /^<span class="number">0</span>$|^[<span class="number">1</span>-<span class="number">9</span>]\d*$/.test(prop) &amp;&amp; </span><br><span class="line">        prop &lt;= <span class="number">4294967294</span>; <span class="comment">// 2^32 - 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    <span class="keyword">if</span> (arrayHasOwnIndex(arr, key)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(arr[key]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>for-in æ€§èƒ½</strong></p>
<p>æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œæ¯æ¬¡è¿­ä»£æ“ä½œä¼šåŒæ—¶æœç´¢å®ä¾‹æˆ–è€…åŸå‹å±æ€§ï¼Œ for-in å¾ªç¯çš„æ¯æ¬¡è¿­ä»£éƒ½ä¼šäº§ç”Ÿæ›´å¤šå¼€é”€ï¼Œå› æ­¤è¦æ¯”å…¶ä»–å¾ªç¯ç±»å‹æ…¢ï¼Œä¸€èˆ¬é€Ÿåº¦ä¸ºå…¶ä»–ç±»å‹å¾ªç¯çš„ 1/7ã€‚å› æ­¤ï¼Œé™¤éæ˜ç¡®éœ€è¦è¿­ä»£ä¸€ä¸ªå±æ€§æ•°é‡æœªçŸ¥çš„å¯¹è±¡ï¼Œå¦åˆ™åº”é¿å…ä½¿ç”¨ for-in å¾ªç¯ã€‚å¦‚æœéœ€è¦éå†ä¸€ä¸ªæ•°é‡æœ‰é™çš„å·²çŸ¥å±æ€§åˆ—è¡¨ï¼Œä½¿ç”¨å…¶ä»–å¾ªç¯ä¼šæ›´å¿«ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="string">&quot;prop1&quot;</span>: <span class="string">&quot;value1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;prop2&quot;</span>: <span class="string">&quot;value2&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> props = [<span class="string">&quot;prop1&quot;</span>, <span class="string">&quot;prop2&quot;</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; props.length; i++) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(obj[props[i]]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç ä¸­ï¼Œå°†å¯¹è±¡çš„å±æ€§éƒ½å­˜å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç›¸å¯¹äº for-in æŸ¥æ‰¾æ¯ä¸€ä¸ªå±æ€§ï¼Œè¯¥ä»£ç åªå…³æ³¨ç»™å®šçš„å±æ€§ï¼ŒèŠ‚çœäº†å¾ªç¯çš„å¼€é”€å’Œæ—¶é—´ã€‚</p>
<h2 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h2><p>åœ¨ ES5 ä¸­ï¼Œå¼•å…¥äº†æ–°çš„å¾ªç¯ï¼Œå³ forEach å¾ªç¯ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.forEach(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>forEach æ–¹æ³•ä¸ºæ•°ç»„ä¸­å«æœ‰æœ‰æ•ˆå€¼çš„æ¯ä¸€é¡¹æ‰§è¡Œä¸€æ¬¡ callback å‡½æ•°ï¼Œé‚£äº›å·²åˆ é™¤ï¼ˆä½¿ç”¨ delete æ–¹æ³•ç­‰æƒ…å†µï¼‰æˆ–è€…ä»æœªèµ‹å€¼çš„é¡¹å°†è¢«è·³è¿‡ï¼ˆä¸åŒ…æ‹¬é‚£äº›å€¼ä¸º undefined æˆ– null çš„é¡¹ï¼‰ã€‚ callback å‡½æ•°ä¼šè¢«ä¾æ¬¡ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>æ•°ç»„å½“å‰é¡¹çš„å€¼ï¼›</li>
<li>æ•°ç»„å½“å‰é¡¹çš„ç´¢å¼•ï¼›</li>
<li>æ•°ç»„å¯¹è±¡æœ¬èº«ï¼›</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒforEach éå†çš„èŒƒå›´åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ callback å‰å°±ä¼šç¡®å®šã€‚è°ƒç”¨forEach åæ·»åŠ åˆ°æ•°ç»„ä¸­çš„é¡¹ä¸ä¼šè¢« callback è®¿é—®åˆ°ã€‚å¦‚æœå·²ç»å­˜åœ¨çš„å€¼è¢«æ”¹å˜ï¼Œåˆ™ä¼ é€’ç»™ callback çš„å€¼æ˜¯ forEach éå†åˆ°ä»–ä»¬é‚£ä¸€åˆ»çš„å€¼ã€‚å·²åˆ é™¤çš„é¡¹ä¸ä¼šè¢«éå†åˆ°ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [];</span><br><span class="line">arr[<span class="number">0</span>] = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">arr[<span class="number">3</span>] = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">arr[<span class="number">10</span>] = <span class="string">&quot;c&quot;</span>;</span><br><span class="line">arr.name = <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line">arr.forEach(<span class="function">(<span class="params">data, index, array</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data, index, array);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a <span class="number">0</span> [<span class="string">&quot;a&quot;</span>, <span class="number">3</span>: <span class="string">&quot;b&quot;</span>, <span class="number">10</span>: <span class="string">&quot;c&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;Hello world&quot;</span>]</span><br><span class="line">b <span class="number">3</span> [<span class="string">&quot;a&quot;</span>, <span class="number">3</span>: <span class="string">&quot;b&quot;</span>, <span class="number">10</span>: <span class="string">&quot;c&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;Hello world&quot;</span>]</span><br><span class="line">c <span class="number">10</span> [<span class="string">&quot;a&quot;</span>, <span class="number">3</span>: <span class="string">&quot;b&quot;</span>, <span class="number">10</span>: <span class="string">&quot;c&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;Hello world&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ index æ˜¯ Number ç±»å‹ï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šåƒ for-in ä¸€æ ·éå†åŸå‹é“¾ä¸Šçš„å±æ€§ã€‚</p>
<p>æ‰€ä»¥ï¼Œä½¿ç”¨ forEach æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸“é—¨åœ°å£°æ˜ index å’Œéå†çš„å…ƒç´ ï¼Œå› ä¸ºè¿™äº›éƒ½ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°ã€‚</p>
<p>å¦å¤–ï¼ŒforEach å°†ä¼šéå†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä½†æ˜¯ ES5 å®šä¹‰äº†ä¸€äº›å…¶ä»–æœ‰ç”¨çš„æ–¹æ³•ï¼Œä¸‹é¢æ˜¯ä¸€éƒ¨åˆ†ï¼š</p>
<ul>
<li>every: å¾ªç¯åœ¨ç¬¬ä¸€æ¬¡ return false åè¿”å›</li>
<li>some: å¾ªç¯åœ¨ç¬¬ä¸€æ¬¡ return true åè¿”å›</li>
<li>filter: è¿”å›ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œè¯¥æ•°ç»„å†…çš„å…ƒç´ æ»¡è¶³å›è°ƒå‡½æ•°</li>
<li>map: å°†åŸæ•°ç»„ä¸­çš„å…ƒç´ å¤„ç†åå†è¿”å›</li>
<li>reduce: å¯¹æ•°ç»„ä¸­çš„å…ƒç´ ä¾æ¬¡å¤„ç†ï¼Œå°†ä¸Šæ¬¡å¤„ç†ç»“æœä½œä¸ºä¸‹æ¬¡å¤„ç†çš„è¾“å…¥ï¼Œæœ€åå¾—åˆ°æœ€ç»ˆç»“æœã€‚</li>
</ul>
<p><strong>forEach æ€§èƒ½</strong></p>
<p>åœ¨ä¸åŒæµè§ˆå™¨ä¸‹æµ‹è¯•çš„ç»“æœéƒ½æ˜¯ forEach çš„é€Ÿåº¦ä¸å¦‚ forã€‚å¦‚æœå¤§å®¶æŠŠæµ‹è¯•ä»£ç æ”¾åœ¨æ§åˆ¶å°çš„è¯ï¼Œå¯èƒ½ä¼šå¾—åˆ°ä¸ä¸€æ ·çš„ç»“æœï¼Œä¸»è¦åŸå› æ˜¯æ§åˆ¶å°çš„æ‰§è¡Œç¯å¢ƒä¸çœŸå®çš„ä»£ç æ‰§è¡Œç¯å¢ƒæœ‰æ‰€åŒºåˆ«ã€‚</p>
<h2 id="for-of"><a href="#for-of" class="headerlink" title="for-of"></a>for-of</h2><p>å…ˆæ¥çœ‹ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> data <span class="keyword">of</span> arr) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœæ˜¯ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ºä»€ä¹ˆè¦å¼•è¿› for-ofï¼Ÿ</strong></p>
<p>è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ES6ä¹‹å‰çš„ 3 ç§ for å¾ªç¯æœ‰ä»€ä¹ˆç¼ºé™·ï¼š</p>
<ul>
<li>forEach ä¸èƒ½ break å’Œ returnï¼›</li>
<li>for-in ç¼ºç‚¹æ›´åŠ æ˜æ˜¾ï¼Œå®ƒä¸ä»…éå†æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œè¿˜ä¼šéå†è‡ªå®šä¹‰çš„å±æ€§ï¼Œç”šè‡³åŸå‹é“¾ä¸Šçš„å±æ€§éƒ½è¢«è®¿é—®åˆ°ã€‚è€Œä¸”ï¼Œéå†æ•°ç»„å…ƒç´ çš„é¡ºåºå¯èƒ½æ˜¯éšæœºçš„ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œé‰´äºä»¥ä¸Šç§ç§ç¼ºé™·ï¼Œæˆ‘ä»¬éœ€è¦æ”¹è¿›åŸå…ˆçš„ for å¾ªç¯ã€‚ä½† ES6 ä¸ä¼šç ´åä½ å·²ç»å†™å¥½çš„ JS ä»£ç ã€‚ç›®å‰ï¼Œæˆåƒä¸Šä¸‡çš„ Web ç½‘ç«™ä¾èµ– for-in å¾ªç¯ï¼Œå…¶ä¸­ä¸€äº›ç½‘ç«™ç”šè‡³å°†å…¶ç”¨äºæ•°ç»„éå†ã€‚å¦‚æœæƒ³é€šè¿‡ä¿®æ­£ for-in å¾ªç¯å¢åŠ æ•°ç»„éå†æ”¯æŒä¼šè®©è¿™ä¸€åˆ‡å˜å¾—æ›´åŠ æ··ä¹±ï¼Œå› æ­¤ï¼Œæ ‡å‡†å§”å‘˜ä¼šåœ¨ ES6 ä¸­å¢åŠ äº†ä¸€ç§æ–°çš„å¾ªç¯è¯­æ³•æ¥è§£å†³ç›®å‰çš„é—®é¢˜ï¼Œå³ for-of ã€‚</p>
<p>é‚£ for-of åˆ°åº•å¯ä»¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<ul>
<li>è·Ÿ forEach ç›¸æ¯”ï¼Œå¯ä»¥æ­£ç¡®å“åº” break, continue, returnã€‚</li>
<li>for-of å¾ªç¯ä¸ä»…æ”¯æŒæ•°ç»„ï¼Œè¿˜æ”¯æŒå¤§å¤šæ•°ç±»æ•°ç»„å¯¹è±¡ï¼Œä¾‹å¦‚ DOM nodelist å¯¹è±¡ã€‚</li>
<li>for-of å¾ªç¯ä¹Ÿæ”¯æŒå­—ç¬¦ä¸²éå†ï¼Œå®ƒå°†å­—ç¬¦ä¸²è§†ä¸ºä¸€ç³»åˆ— Unicode å­—ç¬¦æ¥è¿›è¡Œéå†ã€‚</li>
<li>for-of ä¹Ÿæ”¯æŒ Map å’Œ Set ï¼ˆä¸¤è€…å‡ä¸º ES6 ä¸­æ–°å¢çš„ç±»å‹ï¼‰å¯¹è±¡éå†ã€‚</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œfor-of å¾ªç¯æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š</p>
<ul>
<li>è¿™æ˜¯æœ€ç®€æ´ã€æœ€ç›´æ¥çš„éå†æ•°ç»„å…ƒç´ çš„è¯­æ³•ã€‚</li>
<li>è¿™ä¸ªæ–¹æ³•é¿å¼€äº† for-in å¾ªç¯çš„æ‰€æœ‰ç¼ºé™·ã€‚</li>
<li>ä¸ forEach ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥æ­£ç¡®å“åº” breakã€continue å’Œ return è¯­å¥ã€‚</li>
<li>å…¶ä¸ä»…å¯ä»¥éå†æ•°ç»„ï¼Œè¿˜å¯ä»¥éå†ç±»æ•°ç»„å¯¹è±¡å’Œå…¶ä»–å¯è¿­ä»£å¯¹è±¡ã€‚</li>
</ul>
<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfor-ofå¾ªç¯ä¸æ”¯æŒæ™®é€šå¯¹è±¡ï¼Œä½†å¦‚æœä½ æƒ³è¿­ä»£ä¸€ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œä½ å¯ä»¥ç”¨ for-in å¾ªç¯ï¼ˆè¿™ä¹Ÿæ˜¯å®ƒçš„æœ¬èŒå·¥ä½œï¼‰ã€‚</p>
<p>æœ€åè¦è¯´çš„æ˜¯ï¼ŒES6 å¼•è¿›çš„å¦ä¸€ä¸ªæ–¹å¼ä¹Ÿèƒ½å®ç°éå†æ•°ç»„çš„å€¼ï¼Œé‚£å°±æ˜¯ Iteratorã€‚ä¸Šä¸ªä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="keyword">const</span> iter = arr[<span class="built_in">Symbol</span>.iterator]();</span><br><span class="line"></span><br><span class="line">iter.next() <span class="comment">// &#123; value: &#x27;a&#x27;, done: false &#125;</span></span><br><span class="line">iter.next() <span class="comment">// &#123; value: &#x27;b&#x27;, done: false &#125;</span></span><br><span class="line">iter.next() <span class="comment">// &#123; value: &#x27;c&#x27;, done: false &#125;</span></span><br><span class="line">iter.next() <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å‰ç«¯</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracleçš„ä¸€äº›å¸¸ç”¨SQL</title>
    <url>/2020/11/05/Oracle%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8SQL/</url>
    <content><![CDATA[<h1 id="Oracleçš„ä¸€äº›å¸¸ç”¨SQL"><a href="#Oracleçš„ä¸€äº›å¸¸ç”¨SQL" class="headerlink" title="Oracleçš„ä¸€äº›å¸¸ç”¨SQL"></a>Oracleçš„ä¸€äº›å¸¸ç”¨SQL</h1><h2 id="æŸ¥å¤–é”®å»ºåœ¨å“ªä¸ªè¡¨ä¸Š"><a href="#æŸ¥å¤–é”®å»ºåœ¨å“ªä¸ªè¡¨ä¸Š" class="headerlink" title="æŸ¥å¤–é”®å»ºåœ¨å“ªä¸ªè¡¨ä¸Š"></a>æŸ¥å¤–é”®å»ºåœ¨å“ªä¸ªè¡¨ä¸Š</h2><p>æœ‰æ—¶å€™åˆ é™¤æŸå¼ è¡¨è®°å½•çš„æ—¶å€™ï¼Œä¼šæŠ¥é”™å¤–é”®çº¦æŸä¸èƒ½åˆ é™¤ã€‚</p>
<p>å¦‚æœä¸äº†è§£è¡¨ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æŸ¥è¯¢åˆ°å¤–é”®æ˜¯å»ºåœ¨å“ªå¼ è¡¨ä¸Šçš„ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> dba_constraints <span class="keyword">where</span> constraint_name<span class="operator">=</span><span class="string">&#x27;xxx&#x27;</span> <span class="keyword">and</span> constraint_type <span class="operator">=</span> <span class="string">&#x27;R&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h2 id="åœ¨åƒåœ¾æ¡¶æŸ¥è¢«åˆ é™¤çš„è¡¨"><a href="#åœ¨åƒåœ¾æ¡¶æŸ¥è¢«åˆ é™¤çš„è¡¨" class="headerlink" title="åœ¨åƒåœ¾æ¡¶æŸ¥è¢«åˆ é™¤çš„è¡¨"></a>åœ¨åƒåœ¾æ¡¶æŸ¥è¢«åˆ é™¤çš„è¡¨</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> object_name, original_name, partition_name, type, ts_name, createtime, droptime</span><br><span class="line"><span class="keyword">from</span> recyclebin</span><br><span class="line"><span class="comment">-- where original_name = &#x27;extra_charge_detail&#x27;</span></span><br><span class="line"><span class="keyword">where</span> to_date(droptime, <span class="string">&#x27;yyyy-mm-dd hh24:mi:ss&#x27;</span>) <span class="operator">&gt;=</span> sysdate <span class="operator">-</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">and</span> type <span class="operator">=</span> <span class="string">&#x27;table&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> droptime <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>

<h3 id="å›æ»šè¢«åˆ é™¤çš„è¡¨"><a href="#å›æ»šè¢«åˆ é™¤çš„è¡¨" class="headerlink" title="å›æ»šè¢«åˆ é™¤çš„è¡¨"></a>å›æ»šè¢«åˆ é™¤çš„è¡¨</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> &quot;BIN$l5cbNm6DbqDgU54w3gpQfA==$0&quot;;</span><br><span class="line">FLASHBACK <span class="keyword">TABLE</span> &quot;BIN$l5l+JWZRPQ7gU54w3goSNw==$0&quot; <span class="keyword">TO</span> BEFORE <span class="keyword">DROP</span>;</span><br><span class="line">FLASHBACK <span class="keyword">TABLE</span> user2 <span class="keyword">TO</span> BEFORE <span class="keyword">DROP</span> rename <span class="keyword">to</span> user2_v2; <span class="comment">-- é‡å‘½å å¦‚æœå·²ç»æ–°å»ºäº†åŒåè¡¨</span></span><br></pre></td></tr></table></figure>





<h2 id="å°†Clobè½¬æˆå­—ç¬¦ä¸²"><a href="#å°†Clobè½¬æˆå­—ç¬¦ä¸²" class="headerlink" title="å°†Clobè½¬æˆå­—ç¬¦ä¸²"></a>å°†Clobè½¬æˆå­—ç¬¦ä¸²</h2><p>WM_CONCAT å‡½æ•°å‡ºæ¥çš„æ•°æ®æ˜¯clobç±»å‹çš„ï¼Œç»„åˆæˆçš„æ•°æ®è‡ªåŠ¨ç”¨<code>&#39;,&#39;</code>åˆ†å‰²</p>
<h3 id="æ–¹å¼ä¸€"><a href="#æ–¹å¼ä¸€" class="headerlink" title="æ–¹å¼ä¸€"></a>æ–¹å¼ä¸€</h3><p>to_char å‡½æ•° é•¿åº¦åªèƒ½åˆ°4000ï¼Œè¶…å‡ºä¼šæˆªå–</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> O.UUID, O.SOURCE, TO_CHAR(WM_CONCAT(OI.REQ_NO)) <span class="keyword">AS</span> REQNOS</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">ORDER</span> O</span><br><span class="line">         <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ORDER_DETAIL OI <span class="keyword">ON</span> O.UUID <span class="operator">=</span> OI.ORDER_UUID</span><br><span class="line"><span class="keyword">WHERE</span> OI.REQ_NO <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> O.UUID, O.SOURCE;</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹å¼äºŒ"><a href="#æ–¹å¼äºŒ" class="headerlink" title="æ–¹å¼äºŒ"></a>æ–¹å¼äºŒ</h3><p>dbms_lob.substr å‡½æ•° å¯ä»¥æŒ‡å®šé•¿åº¦ï¼Œè¶…å‡ºä¼šæˆªå–</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> O.UUID, O.SOURCE, DBMS_LOB.SUBSTR((WM_CONCAT(OI.REQ_NO), <span class="number">8000</span>)) <span class="keyword">AS</span> REQNOS</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">ORDER</span> O</span><br><span class="line">         <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ORDER_DETAIL OI <span class="keyword">ON</span> O.UUID <span class="operator">=</span> OI.ORDER_UUID</span><br><span class="line"><span class="keyword">WHERE</span> OI.REQ_NO <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> O.UUID, O.SOURCE;</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹å¼ä¸‰"><a href="#æ–¹å¼ä¸‰" class="headerlink" title="æ–¹å¼ä¸‰"></a>æ–¹å¼ä¸‰</h3><p>ç”¨ä»£ç è½¬æ¢</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  Reader is = ((Clob)tuple[i]).getCharacterStream();<span class="comment">// å¾—åˆ°æµ</span></span><br><span class="line">  BufferedReader br = <span class="keyword">new</span> BufferedReader(is);</span><br><span class="line">  String s = br.readLine();</span><br><span class="line">  StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"><span class="comment">// æ‰§è¡Œå¾ªç¯å°†å­—ç¬¦ä¸²å…¨éƒ¨å–å‡ºä»˜å€¼ç»™StringBufferç”±StringBufferè½¬æˆSTRING</span></span><br><span class="line">  <span class="keyword">while</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">    sb.append(s);</span><br><span class="line">    s = br.readLine();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sb.toString();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>Oracle</category>
      </categories>
      <tags>
        <tag>æ•°æ®åº“</tag>
        <tag>Oracle</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Oracleçš„åŸºç¡€çŸ¥è¯†</title>
    <url>/2020/09/22/Oracle%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<h1 id="Oracle-çš„åŸºç¡€çŸ¥è¯†"><a href="#Oracle-çš„åŸºç¡€çŸ¥è¯†" class="headerlink" title="Oracle çš„åŸºç¡€çŸ¥è¯†"></a>Oracle çš„åŸºç¡€çŸ¥è¯†</h1><h2 id="æ•°æ®åº“è®¾è®¡"><a href="#æ•°æ®åº“è®¾è®¡" class="headerlink" title="æ•°æ®åº“è®¾è®¡"></a>æ•°æ®åº“è®¾è®¡</h2><blockquote>
<p> æ•°æ®åº“è®¾è®¡æ˜¯ç”»å‡ºæ•°æ®åº“çš„ERå›¾ï¼Œé€šè¿‡ERå›¾ç”Ÿæˆ sql å»ºåº“ä»£ç (DDL)</p>
<p> ç”Ÿæˆçš„å»ºåº“ä»£ç çš„çº¦æŸéƒ½æ˜¯è¿½åŠ çš„ï¼Œæ–¹ä¾¿åˆ°æ—¶åˆ é™¤</p>
</blockquote>
<h2 id="SQLç±»å‹"><a href="#SQLç±»å‹" class="headerlink" title="SQLç±»å‹"></a>SQLç±»å‹</h2><ul>
<li>DQLï¼šæ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œå…³é”®å­— selectï¼Œ åŠŸèƒ½ï¼šæŸ¥è¯¢</li>
<li>DMLï¼šæ•°æ®æ“ä½œè¯­è¨€ï¼Œå…³é”®å­— insertã€deleteã€updateï¼ŒåŠŸèƒ½ï¼šæ“ä½œæ•°æ®</li>
<li>DDLï¼šæ•°æ®å®šä¹‰è¯­è¨€ï¼Œå…³é”®å­— createã€dropã€alterï¼ŒåŠŸèƒ½ï¼šæ“ä½œæ•°æ®åº“å¯¹è±¡</li>
<li>DCLï¼šæ•°æ®æ§åˆ¶è¯­è¨€ï¼Œå…³é”®å­— grantã€revokeï¼ŒåŠŸèƒ½ï¼šç”¨æˆ·æˆæƒæ’¤æƒ</li>
<li>TCLï¼šäº‹åŠ¡æ§åˆ¶è¯­è¨€ï¼Œå…³é”®å­— commitã€rollbackã€savepointï¼ŒåŠŸèƒ½ï¼šäº‹åŠ¡å¤„ç†</li>
</ul>
<h2 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">select [distinct]&#123;* | &lt;å­—æ®µå&gt; | è¡¨å.*&#125; from &lt;è¡¨å&gt;</span><br><span class="line"><span class="comment">-- 1. ç»™è¡¨ä¸€ä¸ªåˆ«å</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp e;</span><br><span class="line"><span class="comment">-- 2. ç»™è¿”å›å­—æ®µä¸€ä¸ªåˆ«å</span></span><br><span class="line"><span class="keyword">select</span> emp.ename <span class="keyword">as</span> å‘˜å·¥å <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<h3 id="æ¡ä»¶æŸ¥è¯¢"><a href="#æ¡ä»¶æŸ¥è¯¢" class="headerlink" title="æ¡ä»¶æŸ¥è¯¢"></a>æ¡ä»¶æŸ¥è¯¢</h3><p>where å…³é”®å­—</p>
<h4 id="æŸ¥è¯¢è¿ç®—ç¬¦"><a href="#æŸ¥è¯¢è¿ç®—ç¬¦" class="headerlink" title="æŸ¥è¯¢è¿ç®—ç¬¦"></a>æŸ¥è¯¢è¿ç®—ç¬¦</h4><h5 id="å¯¹æ¯”è¿ç®—ç¬¦"><a href="#å¯¹æ¯”è¿ç®—ç¬¦" class="headerlink" title="å¯¹æ¯”è¿ç®—ç¬¦"></a>å¯¹æ¯”è¿ç®—ç¬¦</h5><table>
<thead>
<tr>
<th>è¿ç®—ç¬¦</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>=</td>
<td>ç­‰å·ï¼›oracle é‡Œé¢çš„èµ‹å€¼è¯­å¥æ˜¯=:</td>
</tr>
<tr>
<td>&gt;</td>
<td>å¤§äº</td>
</tr>
<tr>
<td>&lt;</td>
<td>å°äº</td>
</tr>
<tr>
<td>&gt;=</td>
<td>å¤§äºç­‰äº</td>
</tr>
<tr>
<td>&lt;=</td>
<td>å°äºç­‰äº</td>
</tr>
<tr>
<td>&lt;&gt;</td>
<td>ä¸ç­‰äºï¼Œä¹Ÿå¯ä»¥ç”¨ !=</td>
</tr>
<tr>
<td>is</td>
<td>ä¸€èˆ¬ç”¨äºåˆ¤ç©º is nullï¼Œis not null</td>
</tr>
<tr>
<td>in</td>
<td>é›†åˆ</td>
</tr>
<tr>
<td>between ..and ..</td>
<td>åœ¨..ä¹‹é—´</td>
</tr>
<tr>
<td>like</td>
<td>æ¨¡ç³ŠæŸ¥è¯¢</td>
</tr>
</tbody></table>
<blockquote>
<p><code>&lt;&gt;</code> æ˜¯æ ‡å‡† sql çš„ä¸ç­‰äºï¼Œä»»ä½•å…³ç³»å‹æ•°æ®åº“éƒ½æ”¯æŒï¼Œ<code>!=</code> åªæœ‰éƒ¨åˆ†æ•°æ®åº“æ”¯æŒ</p>
</blockquote>
<h5 id="é€»è¾‘è¿ç®—ç¬¦"><a href="#é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="é€»è¾‘è¿ç®—ç¬¦"></a>é€»è¾‘è¿ç®—ç¬¦</h5><table>
<thead>
<tr>
<th>è¿ç®—ç¬¦</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>and</td>
<td>ä¸</td>
</tr>
<tr>
<td>or</td>
<td>æˆ–</td>
</tr>
<tr>
<td>not</td>
<td>é</td>
</tr>
</tbody></table>
<h3 id="æ¨¡ç³ŠæŸ¥è¯¢"><a href="#æ¨¡ç³ŠæŸ¥è¯¢" class="headerlink" title="æ¨¡ç³ŠæŸ¥è¯¢"></a>æ¨¡ç³ŠæŸ¥è¯¢</h3><ol>
<li><p>æŸ¥è¯¢å‘˜å·¥çš„åå­—æœ‰ A æˆ–è€… E çš„å‘˜å·¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="keyword">like</span> <span class="string">&#x27;%A%&#x27;</span> <span class="keyword">or</span> ename <span class="keyword">like</span> <span class="string">&#x27;%E%&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥è¯¢ç¬¬ä¸‰ä¸ªå­—ç¬¦æ˜¯ A çš„å‘˜å·¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="keyword">like</span> <span class="string">&#x27;__A%&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥è¯¢å‘˜å·¥åæœ‰ _ çš„å‘˜å·¥ï¼Œéœ€è¦è½¬ä¹‰ï¼›escape æ˜¯ä¸€ä¸ªå®šä¹‰è½¬ä¹‰å­—ç¬¦çš„æ„æ€</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">where</span> ename <span class="keyword">like</span> <span class="string">&#x27;%\_%&#x27;</span> <span class="keyword">escape</span> <span class="string">&#x27;\&#x27;</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="åˆ†ç»„æŸ¥è¯¢"><a href="#åˆ†ç»„æŸ¥è¯¢" class="headerlink" title="åˆ†ç»„æŸ¥è¯¢"></a>åˆ†ç»„æŸ¥è¯¢</h3><p>ä»¥æŸä¸ªå­—æ®µä½œä¸ºåˆ†ç±»çš„æ¡ä»¶ç»Ÿè®¡éœ€æ±‚ï¼Œæœ‰æ¡ä»¶å°±éœ€è¦ç”¨åˆ° having ç­›é€‰</p>
<p>æŸ¥è¯¢è¯­å¥çš„å…³é”®å­—çš„ä¼˜å…ˆçº§åˆ«é—®é¢˜ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> <span class="operator">&gt;</span> <span class="keyword">where</span> <span class="operator">&gt;</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="operator">&gt;</span> <span class="keyword">having</span> <span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">&gt;</span> <span class="keyword">order</span> <span class="keyword">by</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç»“è®ºï¼š</p>
<p>åˆ†ç»„å‰ï¼šç¡®å®šçš„æ¡ä»¶ä½¿ç”¨ whereï¼Œ</p>
<p>åˆ†ç»„åï¼šç¡®å®šçš„æ¡ä»¶ä½¿ç”¨ having</p>
<p>åŸå› å°±æ˜¯ where çš„ä¼˜å…ˆçº§å¤§äº group by</p>
</blockquote>
<h3 id="å¤šè¡¨æŸ¥è¯¢"><a href="#å¤šè¡¨æŸ¥è¯¢" class="headerlink" title="å¤šè¡¨æŸ¥è¯¢"></a>å¤šè¡¨æŸ¥è¯¢</h3><h4 id="ç¬›å¡å°”ç§¯"><a href="#ç¬›å¡å°”ç§¯" class="headerlink" title="ç¬›å¡å°”ç§¯"></a>ç¬›å¡å°”ç§¯</h4><blockquote>
<p>ç¬›å¡å°”ç§¯æ˜¯ä¸¤ä¸ªé›†åˆXå’ŒYçš„ç›´ç§¯ï¼Œè¡¨ç¤ºä¸ºX*Yï¼›</p>
<p>Xé›†åˆçš„æ¯ä¸ªå…ƒç´ å’ŒYé›†åˆçš„æ¯ä¸ªå…ƒç´ æ‰€å½¢æˆçš„æœ‰åºå¯¹é›†åˆå°±æ˜¯Xå’ŒYçš„ç¬›å¡å°”ç§¯</p>
</blockquote>
<h4 id="ç­‰å€¼è¿æ¥"><a href="#ç­‰å€¼è¿æ¥" class="headerlink" title="ç­‰å€¼è¿æ¥"></a>ç­‰å€¼è¿æ¥</h4><p>å½“æ¡ä»¶ä¸ºâ€œ=â€çš„è¿æ¥ä¸ºç­‰å€¼è¿æ¥ï¼Œæ˜¯è¿æ¥å±æ€§å€¼ç›¸ç­‰çš„é‚£äº›å…ƒç»„ï¼›</p>
<p>å…¶ç»“æœæ˜¯è¿æ¥çš„è¡¨çš„æ‰€æœ‰åˆ—ï¼ŒåŒ…æ‹¬é‡å¤åˆ—ï¼Œç›¸å½“äº<strong>å†…è¿æ¥</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> emp, dept</span><br><span class="line"><span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno;</span><br></pre></td></tr></table></figure>

<h4 id="ä¸ç­‰å€¼è¿æ¥"><a href="#ä¸ç­‰å€¼è¿æ¥" class="headerlink" title="ä¸ç­‰å€¼è¿æ¥"></a>ä¸ç­‰å€¼è¿æ¥</h4><p>ä¸¤ä¸ªè¡¨ä¸­ç›¸å…³çš„ä¸¤åˆ—è¿›è¡Œä¸ç­‰è¿æ¥ï¼›</p>
<p>æ¯”è¾ƒç¬¦å·ä¸€èˆ¬ä¸º &lt;&gt;ã€&gt;ã€&lt;ã€&gt;=ã€&lt;=ã€LIKEã€INã€BETWEENâ€¦AND</p>
<h4 id="å†…è¿æ¥"><a href="#å†…è¿æ¥" class="headerlink" title="å†…è¿æ¥"></a>å†…è¿æ¥</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> emp <span class="keyword">inner</span> <span class="keyword">join</span> dept</span><br><span class="line"><span class="keyword">on</span> emp.deptno <span class="operator">=</span> dept.deptno;</span><br></pre></td></tr></table></figure>

<h4 id="å¤–è¿æ¥"><a href="#å¤–è¿æ¥" class="headerlink" title="å¤–è¿æ¥"></a>å¤–è¿æ¥</h4><p>å¤–è¿æ¥å°±æ˜¯è¿æ¥ä¸¤ä¸ªè¡¨ï¼Œæ ¹æ®å·¦å¤–è¿˜æ˜¯å³å¤–è¿æ¥ï¼ŒåŸºè¡¨çš„å­—æ®µä¼šå…¨éƒ¨æ˜¾ç¤ºï¼›</p>
<p>å¦‚æœå­—æ®µä¸å¯¹åº”ï¼ŒéåŸºè¡¨çš„è¡¨æ‰€æœ‰çš„å­—æ®µå€¼ä¼šè®¾ä¸ºnull</p>
<h5 id="å·¦å¤–è¿æ¥"><a href="#å·¦å¤–è¿æ¥" class="headerlink" title="å·¦å¤–è¿æ¥"></a>å·¦å¤–è¿æ¥</h5><p>å·¦è¾¹çš„è¡¨ä½œä¸ºåŸºè¡¨ï¼Œå³è¡¨å¦‚æœ‰å·¦è¡¨ä¸å¯¹åº”çš„å­—æ®µåˆ™è®¾ä¸ºnull</p>
<h5 id="å³å¤–è¿æ¥"><a href="#å³å¤–è¿æ¥" class="headerlink" title="å³å¤–è¿æ¥"></a>å³å¤–è¿æ¥</h5><p>å³è¾¹çš„è¡¨ä½œä¸ºåŸºè¡¨ï¼Œå·¦è¡¨å¦‚æœ‰å³è¡¨ä¸å¯¹åº”çš„å­—æ®µåˆ™è®¾ä¸ºnull</p>
<blockquote>
<p>Oracle å¤–è¿æ¥çš„ç‰¹æ®Šå†™æ³•ï¼ˆé¸¡è‚‹ï¼‰</p>
<p> ç­‰å€¼æŸ¥è¯¢çš„æ¡ä»¶ä¸ŠåŠ ä¸€ä¸ª(+)è¡¨ç¤ºä¸æ˜¯åŸºè¡¨ï¼Œåˆ™ä¸åŠ (+)æ‰æ˜¯åŸºè¡¨</p>
<p><strong>å³å¤–è¿æ¥</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> emp.<span class="operator">*</span>, dept.dname</span><br><span class="line"><span class="keyword">from</span> emp,dept</span><br><span class="line"><span class="keyword">where</span> emp.deptno(<span class="operator">+</span>) <span class="operator">=</span> dept.deptno;</span><br></pre></td></tr></table></figure>

<p> <strong>å·¦å¤–è¿æ¥</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> emp.<span class="operator">*</span>, dept.dname</span><br><span class="line"><span class="keyword">from</span> emp,dept</span><br><span class="line"><span class="keyword">where</span> emp.deptno <span class="operator">=</span> dept.deptno(<span class="operator">+</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="è‡ªè¿æ¥"><a href="#è‡ªè¿æ¥" class="headerlink" title="è‡ªè¿æ¥"></a>è‡ªè¿æ¥</h4><h3 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h3><blockquote>
<p>è¯­æ³•ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="operator">|</span> å­—æ®µ </span><br><span class="line"><span class="keyword">from</span> <span class="operator">&lt;</span>è¡¨å<span class="operator">&gt;</span></span><br><span class="line">[<span class="keyword">where</span> <span class="operator">&lt;</span>æ¡ä»¶<span class="operator">&gt;</span>]</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="operator">&lt;</span>å­—æ®µ<span class="number">1</span>, å­—æ®µ<span class="number">2</span><span class="operator">&gt;</span> <span class="keyword">desc</span> <span class="operator">|</span> <span class="keyword">asc</span></span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>æŸ¥è¯¢å‘˜å·¥çš„ä¿¡æ¯ï¼ŒæŒ‰éƒ¨é—¨ç¼–å·æ’åºï¼Œå†æŒ‰å·¥èµ„æ’åº</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> deptno, sal;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŸ¥è¯¢å‘˜å·¥çš„ä¿¡æ¯ï¼ŒæŒ‰éƒ¨é—¨ç¼–å·æ’åº(æ­£åº)åï¼Œå†æŒ‰å·¥èµ„æ’åº(å€’åº)</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> deptno, sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æŒ‰å‘˜å·¥çš„å¥–é‡‘æ’åºï¼Œå€’åºçš„æ—¶å€™ï¼Œnull æ”¾åœ¨åé¢</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> comm <span class="keyword">desc</span> nulls <span class="keyword">first</span>; <span class="comment">-- å°†nullå€¼æ”¾åœ¨æœ€å‰</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> comm <span class="keyword">desc</span> nulls <span class="keyword">last</span>; <span class="comment">-- å°†nullå€¼æ”¾åœ¨æœ€å</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><h3 id="å•è¡Œå‡½æ•°"><a href="#å•è¡Œå‡½æ•°" class="headerlink" title="å•è¡Œå‡½æ•°"></a>å•è¡Œå‡½æ•°</h3><h4 id="æ•°ç»„å‡½æ•°"><a href="#æ•°ç»„å‡½æ•°" class="headerlink" title="æ•°ç»„å‡½æ•°"></a>æ•°ç»„å‡½æ•°</h4><h6 id="å››èˆäº”å…¥å‡½æ•°"><a href="#å››èˆäº”å…¥å‡½æ•°" class="headerlink" title="å››èˆäº”å…¥å‡½æ•°"></a>å››èˆäº”å…¥å‡½æ•°</h6><blockquote>
<p>round(åŸå€¼, ç²¾åº¦)</p>
</blockquote>
<p>æ±‚å‘˜å·¥çš„å¹³å‡å·¥èµ„ï¼Œä¿ç•™ä¸¤ä½å°æ•°</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å¦‚æœç²¾åº¦æ˜¯æ­£æ•°ï¼Œç²¾ç¡®çš„æ˜¯å°æ•°ä»å°æ•°ç‚¹ç¬¬ä¸€ä½å¼€å§‹ï¼Œå¾€å³ç§»</span></span><br><span class="line"><span class="keyword">select</span> round(<span class="built_in">avg</span>(sal), <span class="number">2</span>) <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<p>å¦‚ï¼šå¹³å‡å·¥èµ„ = 2073.214</p>
<p>â€‹       round(å¹³å‡å·¥èµ„, 2) = 2073.21  </p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å¦‚æœç²¾åº¦æ˜¯è´Ÿæ•°ï¼Œç²¾ç¡®çš„æ˜¯ä»ä¸ªä½å¼€å§‹ï¼Œå¾€å·¦ç§»</span></span><br><span class="line"><span class="keyword">select</span> round(<span class="built_in">avg</span>(sal), <span class="number">-1</span>), <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<p>å¦‚ï¼šå¹³å‡å·¥èµ„ = 2073.214</p>
<p>â€‹        round(å¹³å‡å·¥èµ„, -1) = 2070</p>
<p>â€‹        round(å¹³å‡å·¥èµ„, -2) = 2100</p>
<p>â€‹        round(å¹³å‡å·¥èµ„, -3) = 2000</p>
<p>â€‹        round(å¹³å‡å·¥èµ„, -4) = 0</p>
<h6 id="æˆªå–å‡½æ•°"><a href="#æˆªå–å‡½æ•°" class="headerlink" title="æˆªå–å‡½æ•°"></a>æˆªå–å‡½æ•°</h6><blockquote>
<p> trunc(åŸå€¼, ç²¾åº¦)  </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- å’Œå››èˆäº”å…¥å·®ä¸å¤šåŒºåˆ«å°±æ˜¯ä¸ä¼šå‘ä¸Šè¿›ä½ï¼Œå°±æ˜¯æˆªå–ç²¾åº¦çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">select</span> trunc(<span class="built_in">avg</span>(sal), <span class="number">2</span>) <span class="built_in">avg</span>(sal) <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<h4 id="å­—ç¬¦å‡½æ•°"><a href="#å­—ç¬¦å‡½æ•°" class="headerlink" title="å­—ç¬¦å‡½æ•°"></a>å­—ç¬¦å‡½æ•°</h4><p>æŸ¥è¯¢å‘˜å·¥çš„å§“åï¼Œæ ¼å¼ä¸º â€˜å‘˜å·¥å:å§“åâ€™</p>
<p>æ–¹å¼ä¸€ï¼šä½¿ç”¨ || è¿æ¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;å‘˜å·¥å:&#x27;</span> <span class="operator">||</span> ename <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<p>æ–¹å¼äºŒï¼šä½¿ç”¨ concat å‡½æ•°</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> concat(<span class="string">&#x27;å‘˜å·¥å:&#x27;</span>, ename) <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<h5 id="é•¿åº¦å‡½æ•°"><a href="#é•¿åº¦å‡½æ•°" class="headerlink" title="é•¿åº¦å‡½æ•°"></a>é•¿åº¦å‡½æ•°</h5><blockquote>
<p>length(åŸå€¼)</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ename, length(ename) <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<h5 id="æ›¿æ¢å‡½æ•°"><a href="#æ›¿æ¢å‡½æ•°" class="headerlink" title="æ›¿æ¢å‡½æ•°"></a>æ›¿æ¢å‡½æ•°</h5><blockquote>
<p>replace(c1, c2, c3)</p>
<ul>
<li>c1ï¼šåŸå€¼</li>
<li>c2ï¼šéœ€è¦æ›¿æ¢çš„å€¼</li>
<li>c3ï¼šæ–°å€¼</li>
</ul>
</blockquote>
<p>å°† my name is leo çš„ my ä¿®æ”¹ä¸º your</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> replace(<span class="string">&#x27;my name is leo&#x27;</span>, <span class="string">&#x27;my&#x27;</span>, <span class="string">&#x27;your&#x27;</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å› ä¸ºè¿™ä¸ªä¿®æ”¹æ²¡æœ‰è¡¨ï¼Œæ‰€ä»¥ç»™å®ƒä¸€ä¸ªä¸´æ—¶è¡¨ dual</p>
</blockquote>
<h4 id="æ—¶é—´å‡½æ•°"><a href="#æ—¶é—´å‡½æ•°" class="headerlink" title="æ—¶é—´å‡½æ•°"></a>æ—¶é—´å‡½æ•°</h4><p>è·å–ç³»ç»Ÿå½“å‰æ—¶é—´</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> sysdate <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="æœˆä»½å¯¹æ¯”å‡½æ•°"><a href="#æœˆä»½å¯¹æ¯”å‡½æ•°" class="headerlink" title="æœˆä»½å¯¹æ¯”å‡½æ•°"></a>æœˆä»½å¯¹æ¯”å‡½æ•°</h5><blockquote>
<p>months_between(d1, d2)</p>
<ul>
<li>d1 &lt; d2ï¼Œè¿”å›è´Ÿæ•°</li>
<li>d1 = d2ï¼Œè¿”å› 0</li>
<li>d1 &gt; d2ï¼Œè¿”å›æ­£æ•°</li>
<li>è¿”å›å€¼ï¼šä¸¤ä¸ªæ—¥æœŸçš„æœˆä»½é—´éš”</li>
<li>ä½œç”¨ï¼š<ul>
<li>ç”¨äºè®¡ç®—ä¸¤ä¸ªæ—¥æœŸé—´éš”çš„æœˆä»½æ•°</li>
<li>å¯¹æ¯”ä¸¤ä¸ªæ—¥æœŸçš„å¤§å°</li>
</ul>
</li>
</ul>
</blockquote>
<p>2018-06-26 ä¸ 2020-09-22 ç›¸éš”å¤šå°‘ä¸ªæœˆ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> months_between( </span><br><span class="line">    		to_date(<span class="string">&#x27;2018-06-26&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd&#x27;</span>),</span><br><span class="line">    		to_date(<span class="string">&#x27;2020-09-22&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd&#x27;</span>)) </span><br><span class="line"><span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="æœˆä»½å¢åŠ å‡½æ•°"><a href="#æœˆä»½å¢åŠ å‡½æ•°" class="headerlink" title="æœˆä»½å¢åŠ å‡½æ•°"></a>æœˆä»½å¢åŠ å‡½æ•°</h5><blockquote>
<p>add_months(åŸå€¼, å¢åŠ çš„æœˆä»½æ•°)</p>
</blockquote>
<p>ç»™å½“å‰æ—¥æœŸåŠ ä¸‰ä¸ªæœˆ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> add_months(sysdate, <span class="number">3</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<p>ç»™å½“å‰æ—¥æœŸå‡ä¸‰ä¸ªæœˆ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> add_months(sysdate, <span class="number">-3</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="æ—¥æœŸæˆªå–å‡½æ•°"><a href="#æ—¥æœŸæˆªå–å‡½æ•°" class="headerlink" title="æ—¥æœŸæˆªå–å‡½æ•°"></a>æ—¥æœŸæˆªå–å‡½æ•°</h5><blockquote>
<p>extract( ç±»å‹ from æ—¶é—´|æ—¥æœŸ)</p>
<p>ç±»å‹åŒ…æ‹¬ï¼š</p>
<ul>
<li>year</li>
<li>month</li>
<li>day</li>
<li>hour</li>
<li>minute</li>
<li>second</li>
</ul>
</blockquote>
<p>æˆªå–å¹´</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> sysdate) <span class="keyword">from</span> dual;           </span><br></pre></td></tr></table></figure>

<p> æˆªå–æœˆ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">month</span> <span class="keyword">from</span> sysdate);</span><br></pre></td></tr></table></figure>

<p>æˆªå–æ—¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">day</span> <span class="keyword">from</span> sysdate);</span><br></pre></td></tr></table></figure>

<p>æˆªå–æ—¶</p>
<p>æ–¹å¼ä¸€ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">hour</span> <span class="keyword">from</span> </span><br><span class="line">               to_timestamp(<span class="string">&#x27;2020-09-22 13:12:20&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd hh24:mi:ss&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<p>æ–¹å¼äºŒï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">hour</span> <span class="keyword">from</span> <span class="type">timestamp</span><span class="string">&#x27;2020-09-22 13:12:20&#x27;</span>) </span><br><span class="line"><span class="keyword">from</span> dual; </span><br></pre></td></tr></table></figure>

<p>æˆªå–åˆ†</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">minute</span> <span class="keyword">from</span> <span class="type">timestamp</span><span class="string">&#x27;2020-09-22 13:12:20)</span></span><br><span class="line"><span class="string">from dual;</span></span><br></pre></td></tr></table></figure>

<p>æˆªå–ç§’</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">extract</span>(<span class="keyword">second</span> <span class="keyword">from</span> <span class="type">timestamp</span><span class="string">&#x27;2020-09-22 13:12:20)</span></span><br><span class="line"><span class="string">from dual;</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢ 1981 å¹´å…¥èŒçš„å‘˜å·¥</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> emp </span><br><span class="line"><span class="keyword">where</span> <span class="built_in">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> HIRE_DATE) <span class="operator">=</span> <span class="number">1981</span>;</span><br></pre></td></tr></table></figure>

<h4 id="è½¬æ¢å‡½æ•°"><a href="#è½¬æ¢å‡½æ•°" class="headerlink" title="è½¬æ¢å‡½æ•°"></a>è½¬æ¢å‡½æ•°</h4><h5 id="å­—ç¬¦ä¸²è½¬æˆæ—¥æœŸ"><a href="#å­—ç¬¦ä¸²è½¬æˆæ—¥æœŸ" class="headerlink" title="å­—ç¬¦ä¸²è½¬æˆæ—¥æœŸ"></a>å­—ç¬¦ä¸²è½¬æˆæ—¥æœŸ</h5><blockquote>
<p>to_date(åŸå€¼, â€˜æ ¼å¼â€™);</p>
<p>å¹´ï¼šyyyy<br>æœˆï¼šmm<br>æ—¥ï¼šdd<br>æ—¶ï¼šhh è¡¨ç¤ºä½¿ç”¨12å°æ—¶åˆ¶ï¼Œhh24 è¡¨ç¤ºä½¿ç”¨24å°æ—¶åˆ¶<br>åˆ†ï¼šmi<br>ç§’ï¼šss</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> to_date(<span class="string">&#x27;2020-09-22&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd&#x27;</span>) <span class="keyword">from</span> dual;       </span><br><span class="line"><span class="keyword">select</span> to_date(<span class="string">&#x27;2020/09/22&#x27;</span>, <span class="string">&#x27;yyyy/mm/dd&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"><span class="keyword">select</span> to_date(<span class="string">&#x27;09/22/2020&#x27;</span>, <span class="string">&#x27;mm/dd/yyyy&#x27;</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="å­—ç¬¦ä¸²è½¬æ—¶é—´"><a href="#å­—ç¬¦ä¸²è½¬æ—¶é—´" class="headerlink" title="å­—ç¬¦ä¸²è½¬æ—¶é—´"></a>å­—ç¬¦ä¸²è½¬æ—¶é—´</h5><blockquote>
<p>to_timestamp(åŸå€¼, â€˜æ ¼å¼â€™)</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> to_timestamp(<span class="string">&#x27;2020-09-22 13:12:20&#x27;</span>, <span class="string">&#x27;yyyy-mm-dd hh24:mi:ss&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="å…¶ä»–æ•°æ®ç±»å‹è½¬æˆå­—ç¬¦"><a href="#å…¶ä»–æ•°æ®ç±»å‹è½¬æˆå­—ç¬¦" class="headerlink" title="å…¶ä»–æ•°æ®ç±»å‹è½¬æˆå­—ç¬¦"></a>å…¶ä»–æ•°æ®ç±»å‹è½¬æˆå­—ç¬¦</h5><blockquote>
<p>to_char(åŸå€¼, â€˜æ ¼å¼â€™)</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> to_char(sysdate, <span class="string">&#x27;yyyy-mm-dd&#x27;</span>) <span class="keyword">from</span> dual;</span><br><span class="line"><span class="keyword">select</span> to_char(sysdate, <span class="string">&#x27;yyyy/mm/dd&#x27;</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="å°†å­—ç¬¦æ ¼å¼è½¬æˆæ•°å€¼æ ¼å¼"><a href="#å°†å­—ç¬¦æ ¼å¼è½¬æˆæ•°å€¼æ ¼å¼" class="headerlink" title="å°†å­—ç¬¦æ ¼å¼è½¬æˆæ•°å€¼æ ¼å¼"></a>å°†å­—ç¬¦æ ¼å¼è½¬æˆæ•°å€¼æ ¼å¼</h5><blockquote>
<p>to_number(åŸå€¼, æ ¼å¼)</p>
<p>oracleé‡Œé¢ï¼Œæ•°å€¼å ä½ç¬¦ä½¿ç”¨9</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">to</span> number(<span class="string">&#x27;$8,898,765&#x27;</span>, <span class="string">&#x27;$9,999,999&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h4 id="é€šç”¨å‡½æ•°"><a href="#é€šç”¨å‡½æ•°" class="headerlink" title="é€šç”¨å‡½æ•°"></a>é€šç”¨å‡½æ•°</h4><h5 id="ç©ºå¤„ç†å‡½æ•°"><a href="#ç©ºå¤„ç†å‡½æ•°" class="headerlink" title="ç©ºå¤„ç†å‡½æ•°"></a>ç©ºå¤„ç†å‡½æ•°</h5><blockquote>
<p>nvl(åŸå€¼, æ›¿æ¢å€¼)</p>
<p>å¦‚æœåŸå€¼ä¸ºnullï¼Œé‚£ä¹ˆå°±è‡ªåŠ¨è½¬æˆæ›¿æ¢å€¼ï¼Œæ›¿æ¢å€¼çš„ç±»å‹å¿…é¡»å’Œæ•°æ®è¡¨å­—æ®µå£°æ˜çš„å…¼å®¹</p>
</blockquote>
<p>æŸ¥è¯¢å‘˜å·¥çš„å¥–é‡‘ï¼Œå¦‚æœå¥–é‡‘ä¸º nullï¼Œé‚£ä¹ˆä¿®æ”¹ä¸º 0</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ename, bonus, nvl(bonus, <span class="number">0</span>) <span class="keyword">from</span> emp;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nvl2(åŸå€¼, æ›¿æ¢å€¼1, æ›¿æ¢å€¼2)</p>
<p>å¦‚æœåŸå€¼ä¸ä¸ºç©ºï¼Œæ›¿æ¢æˆæ›¿æ¢å€¼1ï¼Œå¦åˆ™æ›¿æ¢æˆæ›¿æ¢å€¼2</p>
</blockquote>
<p>æŸ¥è¯¢å‘˜å·¥çš„å¥–é‡‘ï¼Œå¦‚æœå¥–é‡‘ä¸º null ï¼Œé‚£ä¹ˆä¿®æ”¹ä¸º 0ï¼Œä½¿ç”¨ nvl2 å®ç°</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ename, bonus, nvl2(bonus, bonus, <span class="number">0</span>) <span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<h5 id="æ¡ä»¶å‡½æ•°"><a href="#æ¡ä»¶å‡½æ•°" class="headerlink" title="æ¡ä»¶å‡½æ•°"></a>æ¡ä»¶å‡½æ•°</h5><blockquote>
<p>decode(åŸå€¼, â€˜å€¼1â€™, â€˜ç¿»è¯‘å€¼1â€™, â€˜å€¼2â€™, â€˜ç¿»è¯‘å€¼2â€™, â€˜é»˜è®¤å€¼â€™)</p>
<p>ä¸€ä¸ªæ ¹æ®å€¼æ¥åˆ¤æ–­è¾“å‡ºçš„ä¿¡æ¯ï¼›ç±»ä¼¼äº if / else</p>
</blockquote>
<p>æŸ¥è¯¢å‘˜å·¥çš„å§“åå’Œå‘˜å·¥çš„éƒ¨é—¨ç¼–å·ï¼›</p>
<p>å¦‚æœç¼–å·ä¸º10ï¼Œè¿”å›ç»¼åˆéƒ¨ï¼Œå¦‚æœç¼–å·ä¸º20ï¼Œè¿”å›ç ”å‘éƒ¨ï¼Œå¦‚æœç¼–å·ä¸º30ï¼Œè¿”å›é”€å”®éƒ¨ï¼Œå…¶ä»–è¿”å›ï¼ŒäººåŠ›èµ„æºéƒ¨</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ename decode(deptno, <span class="number">10</span>, <span class="string">&#x27;ç»¼åˆéƒ¨&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;ç ”å‘éƒ¨&#x27;</span>, <span class="number">30</span>, <span class="string">&#x27;é”€å”®éƒ¨&#x27;</span>, <span class="string">&#x27;äººåŠ›èµ„æºéƒ¨&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> dual;</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢å‘˜å·¥çš„å¥–é‡‘ï¼Œå¦‚æœå¥–é‡‘ä¸º nullï¼Œé‚£ä¹ˆä¿®æ”¹ä¸º â€˜æ²¡å¥–é‡‘â€™</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> decode(comm, <span class="string">&#x27;null&#x27;</span>, <span class="string">&#x27;æ²¡å¥–é‡‘&#x27;</span>, bonus);</span><br></pre></td></tr></table></figure>

<h3 id="å¤šè¡Œå‡½æ•°"><a href="#å¤šè¡Œå‡½æ•°" class="headerlink" title="å¤šè¡Œå‡½æ•°"></a>å¤šè¡Œå‡½æ•°</h3><blockquote>
<p>å¤šè¡Œå‡½æ•°ä¹Ÿå«<strong>èšåˆå‡½æ•°</strong></p>
<ul>
<li>max()ï¼šæœ€å¤§å€¼</li>
<li>min()ï¼šæœ€å°å€¼</li>
<li>avg()ï¼šå¹³å‡å€¼</li>
<li>count()ï¼šç»Ÿè®¡ä¸ªæ•°</li>
<li>sum()ï¼šæ±‚å’Œ</li>
</ul>
</blockquote>
]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>Oracle</category>
      </categories>
      <tags>
        <tag>æ•°æ®åº“</tag>
        <tag>Oracle</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Pageableåˆ†é¡µ</title>
    <url>/2020/08/19/Pageable/</url>
    <content><![CDATA[<p>JpaRepositoryæä¾›äº†ä¸¤ä¸ªå’Œåˆ†é¡µå’Œæ’åºæœ‰å…³çš„æŸ¥è¯¢</p>
<p><code>List findAll(Sort sort)</code>: æŒ‰ç…§æŒ‡å®šé¡ºåºæ’åºè¿”å›æ‰€æœ‰å®ä½“</p>
<p><code>List findAll(Pageable pageable)</code>: åˆ†é¡µæŸ¥è¯¢</p>
<h2 id="Sort"><a href="#Sort" class="headerlink" title="Sort"></a>Sort</h2><p>Sort å¯¹è±¡ç”¨æ¥æŒ‡ç¤ºæ’åºï¼Œé»˜è®¤é‡‡ç”¨å‡åºæ’åº</p>
<p><code>Sort sort = new Sort(&quot;id&quot;);</code> // id æ˜¯ å±æ€§å</p>
<p><code>Sort sort = new Sort(Direction.DESC,&quot;id&quot;);</code></p>
<h2 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h2><p>Pageæ¥å£å¯ä»¥è·å¾—</p>
<ol>
<li><p>å½“å‰é¡µé¢çš„è®°å½•</p>
</li>
<li><p>æ€»é¡µæ•°</p>
</li>
<li><p>æ€»è®°å½•æ•°</p>
</li>
<li><p>æ˜¯å¦æœ‰ä¸Šä¸€é¡µæˆ–ä¸‹ä¸€é¡µç­‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getTotalPages</span><span class="params">()</span> æ€»çš„é¡µæ•°</span></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">getTotalElements</span><span class="params">()</span> è¿”å›æ€»æ•°</span></span><br><span class="line"><span class="function">List <span class="title">getContent</span><span class="params">()</span> è¿”å›æ­¤æ¬¡æŸ¥è¯¢çš„ç»“æœé›†</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>Spring Data åˆ†é¡µæŸ¥è¯¢æ€»æ˜¯è¿”å›Pageå¯¹è±¡</p>
<h2 id="Pageable"><a href="#Pageable" class="headerlink" title="Pageable"></a>Pageable</h2><p>Pageable æ¥å£ç”¨äºæ„é€ ç¿»é¡µæŸ¥è¯¢ï¼ŒPageRequest æ˜¯å…¶å®ç°ç±»ï¼Œå®ƒä¸ä»…ä»…æ”¯æŒåˆ†é¡µï¼Œè¿˜æ”¯æŒæ’åº(å•å­—æ®µ/å¤šå­—æ®µå‡æ”¯æŒ)</p>
<p><code>public static PageRequest of(int page, int size);</code></p>
<p><code>public static PageRequest of(int page, int size, Sort sort);</code></p>
<blockquote>
<p>page: èµ·å§‹é¡µï¼Œä»0å¼€å§‹</p>
<p>size: é¡µå¤§å°ï¼Œä¸€é¡µçš„è¡Œæ•°</p>
</blockquote>
<h2 id="PageableDefault"><a href="#PageableDefault" class="headerlink" title="@PageableDefault"></a>@PageableDefault</h2><p>Controllerå±‚å¯ä»¥ç›´æ¥ä½¿ç”¨Pageableæ¥æ”¶å‚æ•°ï¼Œå¦‚æœè¦è®¾ç½®é»˜è®¤å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨</p>
<p><code>@PageableDefault</code>æ³¨è§£</p>
<p>å‚æ•°ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PageableDefault(page = 0, value = 6, sort = &#123;&quot;createdTime&quot;&#125;, direction = Sort.Direction.DESC)</span> Pageable pageable</span><br></pre></td></tr></table></figure>

<p>RESTfulæ¥å£çš„ä¾‹å­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8882&#x2F;api&#x2F;v1&#x2F;questionBanks&#x2F;byEnterprise?sort&#x3D;id%2Cdesc&amp;page&#x3D;0&amp;size&#x3D;2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è§£é‡Šï¼š</p>
<p>apiæ¥å£æ’åºå­—æ®µåé¢ä¼ çš„æ˜¯[,asc/desc]</p>
<p>ä¾‹å¦‚è¦æ’åºçš„æ˜¯idå±æ€§ï¼Œåˆ™ id,desc</p>
<p>å¦‚æœæ˜¯å‡åºçš„è¯ï¼Œå¯ä»¥ç›´æ¥å†™å±æ€§åã€‚</p>
</blockquote>
<h2 id="Orderå’ŒSortçš„è½¬æ¢"><a href="#Orderå’ŒSortçš„è½¬æ¢" class="headerlink" title="Orderå’ŒSortçš„è½¬æ¢"></a>Orderå’ŒSortçš„è½¬æ¢</h2><p>ç”¨EntityManageræŸ¥è¯¢çš„æ—¶å€™ï¼Œæ’åºçš„ç±»å‹æ˜¯<code>javax.persistence.criteria.Order</code></p>
<p>æ‰€ä»¥éœ€è¦å°†Sortå¯¹è±¡è½¬æˆOrderå¯¹è±¡:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;javax.persistence.criteria.Order&gt; QueryUtils.toOrders(Sort, Root, CriteriaBuilder)</span><br></pre></td></tr></table></figure>

<h2 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h2><p>Springçš„web Pageableåˆ†é¡µï¼Œé¡µå¤§å°è®°å½•é»˜è®¤åªæ”¯æŒ2000ï¼Œå¦‚æœè¦è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">pageable:</span></span><br><span class="line">        <span class="attr">max-page-size:</span> <span class="number">10000</span> <span class="comment"># è®¾ç½®é¡µå¤§å°</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>pageable</tag>
      </tags>
  </entry>
  <entry>
    <title>RestTemplateæ¥æ”¶æ³›å‹å‚æ•°</title>
    <url>/2019/09/28/RestTemplate%E6%8E%A5%E6%94%B6%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0/</url>
    <content><![CDATA[<h1 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h1><p>ä½¿ç”¨restTemplateçš„postForObjectç­‰æ–¹æ³•ä¸èƒ½æ­£ç¡®æ¥æ”¶é™¤äº†Stringçš„å…¶ä»–æ³›å‹çš„å‚æ•°</p>
<blockquote>
<p>å¦‚ï¼šMap&lt;String, UserDTO&gt;ï¼›List&lt;UserDTO&gt;ä¸­çš„UserDTOä¼šè‡ªåŠ¨ç”¨LinkedHashMapæ¥æ”¶ï¼Œä»è€Œå˜æˆ Map&lt;String, LinkedHashMap&gt; å’Œ List&lt;LinkedHashMap&gt;ï¼Œå¯¼è‡´æ¥æ”¶ç«¯ä¸èƒ½æ­£ç¡®æ¥æ”¶å‚æ•°</p>
</blockquote>
<h1 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h1><p>ä½¿ç”¨ParameterizedTypeReference&lt;T&gt;æŒ‡å®šæ³›å‹ï¼Œå°±å¯ä»¥æ­£ç¡®æ¥æ”¶æ•°æ®äº†</p>
<h2 id="ä¾‹å­1"><a href="#ä¾‹å­1" class="headerlink" title="ä¾‹å­1"></a>ä¾‹å­1</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParameterizedTypeReference&lt;Map&lt;String, UserDTO&gt;&gt; typeRef = <span class="keyword">new</span> ParameterizedTypeReference&lt;Map&lt;String, UserDTO&gt;&gt;() &#123;&#125;;</span><br><span class="line">    ResponseEntity&lt;Map&lt;String, UserDTO&gt;&gt; responseEntity = restTemplate.exchange(requestUrl, HttpMethod.POST, <span class="keyword">new</span> HttpEntity&lt;&gt;(params), typeRef);</span><br><span class="line">    Map&lt;String, UserDTO&gt; list = responseEntity.getBody();</span><br></pre></td></tr></table></figure>



<h2 id="ä¾‹å­2"><a href="#ä¾‹å­2" class="headerlink" title="ä¾‹å­2"></a>ä¾‹å­2</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParameterizedTypeReference&lt;List&lt;UserDTO&gt;&gt; typeRef = <span class="keyword">new</span> ParameterizedTypeReference&lt;List&lt;UserDTO&gt;&gt;() &#123;&#125;;</span><br><span class="line">  ResponseEntity&lt;List&lt;UserDTO&gt;&gt; responseEntity = restTemplate.exchange(requestUrl, HttpMethod.POST, <span class="keyword">new</span> HttpEntity&lt;&gt;(params), typeRef);</span><br><span class="line">  List&lt;UserDTO&gt; list = responseEntity.getBody();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>RestTemplate</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Security (äºŒ) WebSecurityConfigurerå’Œfilterçš„é…ç½®</title>
    <url>/2020/05/30/Spring%20Security%20(%E4%BA%8C)%20WebSecurityConfigurer%E5%92%8Cfilter%E7%9A%84%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<blockquote>
<p>ã€è½¬è½½ã€‘</p>
<p>ä½œè€…ï¼šCcww</p>
<p>é“¾æ¥ï¼š<a href="https://juejin.im/post/5d0b1eb35188252f921b1535">https://juejin.im/post/5d0b1eb35188252f921b1535</a></p>
</blockquote>
<h1 id="Spring-Securityï¼ˆäºŒï¼‰â€“WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº"><a href="#Spring-Securityï¼ˆäºŒï¼‰â€“WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº" class="headerlink" title="Spring Securityï¼ˆäºŒï¼‰â€“WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº"></a>Spring Securityï¼ˆäºŒï¼‰â€“WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº</h1><p>â€ƒâ€ƒåœ¨è®¤è¯è¿‡ç¨‹å’Œè®¿é—®æˆæƒå‰å¿…é¡»äº†è§£spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬è¦æ±‚æ‰€æœ‰ç”¨æˆ·éƒ½ç»è¿‡èº«ä»½éªŒè¯ï¼Ÿ Spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬æƒ³è¦æ”¯æŒåŸºäºè¡¨å•çš„èº«ä»½éªŒè¯ï¼Ÿå› æ­¤å¿…é¡»äº†è§£WebSecurityConfigurerAdapteré…ç½®ç±»å¦‚ä½•å·¥ä½œçš„ã€‚è€Œä¸”ä¹Ÿå¿…é¡»äº†è§£æ¸…æ¥šfilterçš„é¡ºåºï¼Œæ‰èƒ½æ›´å¥½äº†è§£å…¶è°ƒç”¨å·¥ä½œæµç¨‹ã€‚</p>
<h2 id="WebSecurityConfigurerAdapter"><a href="#WebSecurityConfigurerAdapter" class="headerlink" title="WebSecurityConfigurerAdapter"></a>WebSecurityConfigurerAdapter</h2><p>â€ƒâ€ƒåœ¨ä½¿ç”¨ <code>WebSecurityConfigurerAdapter</code> å‰ï¼Œå…ˆäº†è§£ Spring security configã€‚<br>â€ƒâ€ƒSpring security config å…·æœ‰ä¸‰ä¸ªæ¨¡å—ï¼Œä¸€å…±æœ‰3ä¸ª builderï¼Œè®¤è¯ç›¸å…³çš„ <code>AuthenticationManagerBuilder</code> å’Œwebç›¸å…³çš„ <code>WebSecurity</code>ã€<code>HttpSecurity</code>ã€‚</p>
<ol>
<li><p><code>AuthenticationManagerBuilder</code>ï¼šç”¨æ¥é…ç½®å…¨å±€çš„è®¤è¯ç›¸å…³çš„ä¿¡æ¯ï¼Œå…¶å®å°±æ˜¯<code>AuthenticationProvider</code>å’Œ<code>UserDetailsService</code>ï¼Œå‰è€…æ˜¯è®¤è¯æœåŠ¡æä¾›å•†ï¼Œåè€…æ˜¯ç”¨æˆ·è¯¦æƒ…æŸ¥è¯¢æœåŠ¡ï¼›</p>
</li>
<li><p><code>WebSecurity</code>ï¼š å…¨å±€è¯·æ±‚å¿½ç•¥è§„åˆ™é…ç½®ï¼ˆæ¯”å¦‚è¯´é™æ€æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´æ³¨å†Œé¡µé¢ï¼‰ã€å…¨å±€<code>HttpFirewall</code>é…ç½®ã€æ˜¯å¦debugé…ç½®ã€å…¨å±€<code>SecurityFilterChain</code>é…ç½®ã€<code>privilegeEvaluator</code>ã€<code>expressionHandler</code>ã€<code>securityInterceptor</code>ï¼›</p>
</li>
<li><p><code>HttpSecurity</code>ï¼šå…·ä½“çš„æƒé™æ§åˆ¶è§„åˆ™é…ç½®ã€‚ä¸€ä¸ªè¿™ä¸ªé…ç½®ç›¸å½“äºxmlé…ç½®ä¸­çš„ä¸€ä¸ªæ ‡ç­¾ã€‚å„ç§å…·ä½“çš„è®¤è¯æœºåˆ¶çš„ç›¸å…³é…ç½®ï¼Œ<code>OpenIDLoginConfigurer</code>ã€<code>AnonymousConfigurer</code>ã€<code>FormLoginConfigurer</code>ã€<code>HttpBasicConfigurer</code>ç­‰ã€‚</p>
<p>â€ƒâ€ƒ<code>WebSecurityConfigurerAdapter</code>æä¾›äº†ç®€æ´æ–¹å¼æ¥åˆ›å»º<code>WebSecurityConfigurer</code>ï¼Œå…¶ä½œä¸ºåŸºç±»ï¼Œå¯é€šè¿‡å®ç°è¯¥ç±»è‡ªå®šä¹‰é…ç½®ç±»ï¼Œä¸»è¦é‡å†™è¿™ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>â€ƒâ€ƒè€Œä¸”å…¶è‡ªåŠ¨ä»<code>SpringFactoriesLoader</code>æŸ¥æ‰¾<code>AbstractHttpConfigurer</code>è®©æˆ‘ä»¬å»æ‰©å±•ï¼Œæƒ³è¦å®ç°å¿…é¡»åˆ›å»ºä¸€ä¸ª<code>AbstractHttpConfigurer</code>çš„æ‰©å±•ç±»ï¼Œå¹¶åœ¨classpathè·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶META-INF/spring.factoriesã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer</span> = <span class="string">sample.MyClassThatExtendsAbstractHttpConfigurer</span></span><br></pre></td></tr></table></figure>

<p>å…¶æºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.initåˆå§‹åŒ–ï¼šè·å–HttpSecurityå’Œé…ç½®FilterSecurityInterceptoræ‹¦æˆªå™¨åˆ°WebSecurity</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> WebSecurity web)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="comment">//è·å–HttpSecurity</span></span><br><span class="line">   <span class="keyword">final</span> HttpSecurity http = getHttp();</span><br><span class="line">   <span class="comment">//é…ç½®FilterSecurityInterceptoræ‹¦æˆªå™¨åˆ°WebSecurity</span></span><br><span class="line">   web.addSecurityFilterChainBuilder(http).postBuildAction(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       FilterSecurityInterceptor securityInterceptor = http</span><br><span class="line">               .getSharedObject(FilterSecurityInterceptor.class);</span><br><span class="line">       web.securityInterceptor(securityInterceptor);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;</span><br><span class="line">   .....</span><br><span class="line"><span class="comment">//2.è·å–HttpSecurityçš„è¿‡ç¨‹</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> HttpSecurity <span class="title">getHttp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (http != <span class="keyword">null</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> http;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   DefaultAuthenticationEventPublisher eventPublisher = objectPostProcessor</span><br><span class="line">           .postProcess(<span class="keyword">new</span> DefaultAuthenticationEventPublisher());</span><br><span class="line">   localConfigureAuthenticationBldr.authenticationEventPublisher(eventPublisher);</span><br><span class="line"></span><br><span class="line">   AuthenticationManager authenticationManager = authenticationManager();</span><br><span class="line">   authenticationBuilder.parentAuthenticationManager(authenticationManager);</span><br><span class="line">   Map&lt;Class&lt;? extends Object&gt;, Object&gt; sharedObjects = createSharedObjects();</span><br><span class="line"></span><br><span class="line">   http = <span class="keyword">new</span> HttpSecurity(objectPostProcessor, authenticationBuilder,</span><br><span class="line">           sharedObjects);</span><br><span class="line">   <span class="keyword">if</span> (!disableDefaults) &#123;</span><br><span class="line">     <span class="comment">// é»˜è®¤çš„HttpSecurityçš„é…ç½®</span></span><br><span class="line">     http</span><br><span class="line">             <span class="comment">//æ·»åŠ  CSRF æ”¯æŒï¼Œä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œé»˜è®¤å¯ç”¨ï¼Œç¦ç”¨csrf().disable()</span></span><br><span class="line">             .csrf().and()</span><br><span class="line">             <span class="comment">//æ·»åŠ WebAsyncManagerIntegrationFilter</span></span><br><span class="line">             .addFilter(<span class="keyword">new</span> WebAsyncManagerIntegrationFilter())</span><br><span class="line">             <span class="comment">//å…è®¸é…ç½®å¼‚å¸¸å¤„ç†</span></span><br><span class="line">             .exceptionHandling().and()</span><br><span class="line">             <span class="comment">//å°†å®‰å…¨æ ‡å¤´æ·»åŠ åˆ°å“åº”</span></span><br><span class="line">             .headers().and()</span><br><span class="line">             <span class="comment">//å…è®¸é…ç½®ä¼šè¯ç®¡ç†</span></span><br><span class="line">             .sessionManagement().and()</span><br><span class="line">             <span class="comment">//HttpServletRequestä¹‹é—´çš„SecurityContextHolderåˆ›å»ºsecurityContextç®¡ç†</span></span><br><span class="line">             .securityContext().and()</span><br><span class="line">             <span class="comment">//å…è®¸é…ç½®è¯·æ±‚ç¼“å­˜</span></span><br><span class="line">             .requestCache().and()</span><br><span class="line">             <span class="comment">//å…è®¸é…ç½®åŒ¿åç”¨æˆ·</span></span><br><span class="line">             .anonymous().and()</span><br><span class="line">             <span class="comment">//HttpServletRequestdçš„æ–¹æ³•å’Œå±æ€§æ³¨å†Œåœ¨SecurityContextä¸­</span></span><br><span class="line">             .servletApi().and()</span><br><span class="line">             <span class="comment">//ä½¿ç”¨é»˜è®¤ç™»å½•é¡µé¢</span></span><br><span class="line">             .apply(<span class="keyword">new</span> DefaultLoginPageConfigurer&lt;&gt;()).and()</span><br><span class="line">             <span class="comment">//æä¾›æ³¨é”€æ”¯æŒ</span></span><br><span class="line">             .logout();</span><br><span class="line">     <span class="comment">// @formatter:on</span></span><br><span class="line">     ClassLoader classLoader = <span class="keyword">this</span>.context.getClassLoader();</span><br><span class="line">     List&lt;AbstractHttpConfigurer&gt; defaultHttpConfigurers =</span><br><span class="line">             SpringFactoriesLoader.loadFactories(AbstractHttpConfigurer.class, classLoader);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">for</span>(AbstractHttpConfigurer configurer : defaultHttpConfigurers) &#123;</span><br><span class="line">       http.apply(configurer);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   configure(http);</span><br><span class="line">   <span class="keyword">return</span> http;</span><br><span class="line"> &#125;</span><br><span class="line">   .....</span><br><span class="line"> <span class="comment">//3.å¯é‡å†™æ–¹æ³•å®ç°è‡ªå®šä¹‰çš„HttpSecurity   </span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   logger.debug(<span class="string">&quot;Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity).&quot;</span>);</span><br><span class="line"></span><br><span class="line">   http</span><br><span class="line">           .authorizeRequests()</span><br><span class="line">           .anyRequest().authenticated()</span><br><span class="line">           .and()</span><br><span class="line">           .formLogin().and()</span><br><span class="line">           .httpBasic();</span><br><span class="line"> &#125;</span><br><span class="line">   .....</span><br></pre></td></tr></table></figure>

<p>   â€ƒâ€ƒä»æºç initåˆå§‹åŒ–æ¨¡å—ä¸­çš„â€œè·å–<code>HttpSecurity</code>â€å’Œâ€œé…ç½®<code>FilterSecurityInterceptor</code>æ‹¦æˆªå™¨åˆ°<code>WebSecurity</code>â€ä¸­å¯ä»¥çœ‹å‡ºï¼Œæƒ³è¦spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬è¦æ±‚æ‰€æœ‰ç”¨æˆ·éƒ½ç»è¿‡èº«ä»½éªŒè¯ï¼Ÿ Spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬æƒ³è¦æ”¯æŒåŸºäºè¡¨å•çš„èº«ä»½éªŒè¯ï¼Ÿåªè¦é‡å†™<code>protected void configure(HttpSecurity http) throws Exception</code>æ–¹æ³•å³å¯ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ç†è§£<code>HttpSecurity</code>çš„æ–¹æ³•çš„ä½œç”¨ï¼Œå¦‚ä½•è¿›è¡Œé…ç½®ã€‚ä¸‹ä¸€èŠ‚æ¥è®¨è®º<code>HttpSecurity</code>ã€‚</p>
<h2 id="HttpSecurity"><a href="#HttpSecurity" class="headerlink" title="HttpSecurity"></a>HttpSecurity</h2><p>â€ƒâ€ƒ<code>HttpSecurity</code>åŸºäºWebçš„å®‰å…¨æ€§å…è®¸ä¸ºç‰¹å®šçš„httpè¯·æ±‚è¿›è¡Œé…ç½®ã€‚å…¶æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œåˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„å¦‚ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th align="left">æ–¹æ³•</th>
<th align="left">è¯´æ˜</th>
<th align="left">ä½¿ç”¨æ¡ˆä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td align="left">csrf()</td>
<td align="left">æ·»åŠ  CSRF æ”¯æŒï¼Œä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œé»˜è®¤å¯ç”¨</td>
<td align="left">ç¦ç”¨ï¼šcsrf().disable()</td>
</tr>
<tr>
<td align="left">openidLogin()</td>
<td align="left">ç”¨äºåŸºäº OpenId çš„éªŒè¯</td>
<td align="left">openidLogin().permitAll();</td>
</tr>
<tr>
<td align="left">authorizeRequests()</td>
<td align="left">å¼€å¯ä½¿ç”¨HttpServletRequestè¯·æ±‚çš„è®¿é—®é™åˆ¶</td>
<td align="left">authorizeRequests().anyRequest().authenticated()</td>
</tr>
<tr>
<td align="left">formLogin()</td>
<td align="left">å¼€å¯è¡¨å•çš„èº«ä»½éªŒè¯ï¼Œå¦‚æœæœªæŒ‡å®šFormLoginConfigurer#loginPage(String)ï¼Œåˆ™å°†ç”Ÿæˆé»˜è®¤ç™»å½•é¡µé¢</td>
<td align="left">formLogin().loginPage(â€œ/authentication/loginâ€).failureUrl(â€œ/authentication/login?failedâ€)</td>
</tr>
<tr>
<td align="left">oauth2Login()</td>
<td align="left">å¼€å¯OAuth 2.0æˆ–OpenID Connect 1.0èº«ä»½éªŒè¯</td>
<td align="left">authorizeRequests()..anyRequest().authenticated()..and().oauth2Login()</td>
</tr>
<tr>
<td align="left">rememberMe()</td>
<td align="left">å¼€å¯é…ç½®â€œè®°ä½æˆ‘â€çš„éªŒè¯</td>
<td align="left">authorizeRequests().antMatchers(â€œ/**â€).hasRole(â€œUSERâ€).and().formLogin().permitAll().and().rememberMe()</td>
</tr>
<tr>
<td align="left">addFilter()</td>
<td align="left">æ·»åŠ è‡ªå®šä¹‰çš„filter</td>
<td align="left">addFilter(new CustomFilter())</td>
</tr>
<tr>
<td align="left">addFilterAt()</td>
<td align="left">åœ¨æŒ‡å®šfilterç›¸åŒä½ç½®ä¸Šæ·»åŠ è‡ªå®šä¹‰filter</td>
<td align="left">addFilterAt(new CustomFilter(), UsernamePasswordAuthenticationFilter.class)</td>
</tr>
<tr>
<td align="left">addFilterAfter()</td>
<td align="left">åœ¨æŒ‡å®šfilterä½ç½®åæ·»åŠ è‡ªå®šä¹‰filter</td>
<td align="left">addFilterAfter(new CustomFilter(), UsernamePasswordAuthenticationFilter.class)</td>
</tr>
<tr>
<td align="left">requestMatchers()</td>
<td align="left">å¼€å¯é…ç½®HttpSecurityï¼Œä»…å½“RequestMatcherç›¸åŒ¹é…æ—¶å¼€å¯</td>
<td align="left">requestMatchers().antMatchers(â€œ/api/**â€)</td>
</tr>
<tr>
<td align="left">antMatchers()</td>
<td align="left">å…¶å¯ä»¥ä¸authorizeRequests()ã€RequestMatcheråŒ¹é…ï¼Œå¦‚ï¼šrequestMatchers().antMatchers(â€œ/api/**â€)</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">logout()</td>
<td align="left">æ·»åŠ é€€å‡ºç™»å½•æ”¯æŒã€‚å½“ä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œè¿™å°†è‡ªåŠ¨åº”ç”¨ã€‚é»˜è®¤æƒ…å†µæ˜¯ï¼Œè®¿é—®URLâ€/ logoutâ€ï¼Œä½¿HTTP Sessionæ— æ•ˆæ¥æ¸…é™¤ç”¨æˆ·ï¼Œæ¸…é™¤å·²é…ç½®çš„ä»»ä½•#rememberMe()èº«ä»½éªŒè¯ï¼Œæ¸…é™¤SecurityContextHolderï¼Œç„¶åé‡å®šå‘åˆ°â€/login?successâ€</td>
<td align="left">logout().deleteCookies(â€œremoveâ€).invalidateHttpSession(false).logoutUrl(â€œ/custom-logoutâ€).logoutSuccessUrl(â€œ/logout-successâ€);</td>
</tr>
</tbody></table>
<p><code>HttpSecurity</code>è¿˜æœ‰å¾ˆå¤šæ–¹æ³•ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œå»é…ç½®<code>HttpSecurity</code>ã€‚ç”±äºå¤ªå¤šè¿™è¾¹å°±ä¸ä¸€ä¸€è¯´æ˜ï¼Œæœ‰å…´è¶£å¯å»ç ”ç©¶ã€‚</p>
<h2 id="WebSecurityConfigurerAdapter-ä½¿ç”¨"><a href="#WebSecurityConfigurerAdapter-ä½¿ç”¨" class="headerlink" title="WebSecurityConfigurerAdapter ä½¿ç”¨"></a>WebSecurityConfigurerAdapter ä½¿ç”¨</h2><p><code>WebSecurityConfigurerAdapter</code>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> MyFilterSecurityInterceptor myFilterSecurityInterceptor;</span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;    </span><br><span class="line">     http</span><br><span class="line">     <span class="comment">//request è®¾ç½®</span></span><br><span class="line">     .authorizeRequests()   <span class="comment">//http.authorizeRequests() æ–¹æ³•ä¸­çš„è‡ªå®šä¹‰åŒ¹é…</span></span><br><span class="line">     .antMatchers(<span class="string">&quot;/resources/**&quot;</span>, <span class="string">&quot;/signup&quot;</span>, <span class="string">&quot;/about&quot;</span>).permitAll() <span class="comment">// æŒ‡å®šæ‰€æœ‰ç”¨æˆ·è¿›è¡Œè®¿é—®æŒ‡å®šçš„url          </span></span><br><span class="line">     .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)  <span class="comment">//æŒ‡å®šå…·æœ‰ç‰¹å®šæƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ç‰¹å®šç›®å½•ï¼ŒhasRole()æ–¹æ³•æŒ‡å®šç”¨æˆ·æƒé™ï¼Œä¸”ä¸éœ€å‰ç¼€ â€œROLE_â€œ  </span></span><br><span class="line">     .antMatchers(<span class="string">&quot;/db/**&quot;</span>).access(<span class="string">&quot;hasRole(&#x27;ADMIN&#x27;) and hasRole(&#x27;DBA&#x27;)&quot;</span>)<span class="comment">//          </span></span><br><span class="line">     .anyRequest().authenticated()  <span class="comment">//ä»»ä½•è¯·æ±‚æ²¡åŒ¹é…çš„éƒ½éœ€è¦è¿›è¡ŒéªŒè¯                                           </span></span><br><span class="line">     .and()        <span class="comment">//loginè®¾ç½®  è‡ªå®šä¹‰ç™»å½•é¡µé¢ä¸”å…è®¸æ‰€æœ‰ç”¨æˆ·ç™»å½•</span></span><br><span class="line">     .formLogin()      </span><br><span class="line">     .loginPage(<span class="string">&quot;/login&quot;</span>) <span class="comment">//The updated configuration specifies the location of the log in page  æŒ‡å®šè‡ªå®šä¹‰ç™»å½•é¡µé¢</span></span><br><span class="line">     .permitAll(); <span class="comment">// å…è®¸æ‰€æœ‰ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢. The formLogin().permitAll() æ–¹æ³•</span></span><br><span class="line">     .and </span><br><span class="line">     .logout()  <span class="comment">//logouts è®¾ç½®                                                              </span></span><br><span class="line">     .logoutUrl(<span class="string">&quot;/my/logout&quot;</span>)  <span class="comment">// æŒ‡å®šæ³¨é”€è·¯å¾„                                              </span></span><br><span class="line">     .logoutSuccessUrl(<span class="string">&quot;/my/index&quot;</span>) <span class="comment">//æŒ‡å®šæˆåŠŸæ³¨é”€åè·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢                                        </span></span><br><span class="line">     .logoutSuccessHandler(logoutSuccessHandler)  <span class="comment">//æŒ‡å®šæˆåŠŸæ³¨é”€åå¤„ç†ç±» å¦‚æœä½¿ç”¨äº†logoutSuccessHandler()çš„è¯ï¼Œ logoutSuccessUrl()å°±ä¼šå¤±æ•ˆ                                </span></span><br><span class="line">     .invalidateHttpSession(<span class="keyword">true</span>)  <span class="comment">// httpSessionæ˜¯å¦æœ‰æ•ˆæ—¶é—´ï¼Œå¦‚æœä½¿ç”¨äº† SecurityContextLogoutHandlerï¼Œå…¶å°†è¢«è¦†ç›–                                        </span></span><br><span class="line">     .addLogoutHandler(logoutHandler)  <span class="comment">//åœ¨æœ€åå¢åŠ é»˜è®¤çš„æ³¨é”€å¤„ç†ç±»LogoutHandler                </span></span><br><span class="line">     .deleteCookies(cookieNamesToClear);<span class="comment">//æŒ‡å®šæ³¨é”€æˆåŠŸåremove cookies</span></span><br><span class="line">     <span class="comment">//å¢åŠ åœ¨FilterSecurityInterceptorå‰æ·»åŠ è‡ªå®šä¹‰çš„myFilterSecurityInterceptor</span></span><br><span class="line">     http.addFilterBefore(myFilterSecurityInterceptor, FilterSecurityInterceptor.class);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NOTEï¼šæ­¤ç¤ºä¾‹åªä¾›å‚è€ƒ</p>
</blockquote>
<h2 id="filter-é¡ºåº"><a href="#filter-é¡ºåº" class="headerlink" title="filter é¡ºåº"></a>filter é¡ºåº</h2><p>Spring Security filteré¡ºåºï¼š</p>
<table>
<thead>
<tr>
<th align="left">Filter Class</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ChannelProcessingFilter</td>
<td align="left">è®¿é—®åè®®æ§åˆ¶è¿‡æ»¤å™¨ï¼Œå¯èƒ½ä¼šå°†æˆ‘ä»¬é‡æ–°å®šå‘åˆ°å¦å¤–ä¸€ç§åè®®,ä»httpè½¬æ¢æˆhttps</td>
</tr>
<tr>
<td align="left">SecurityContextPersistenceFilter</td>
<td align="left">åˆ›å»ºSecurityContextå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œrequestç»“æŸæ—¶æ¸…ç©ºSecurityContextHolder</td>
</tr>
<tr>
<td align="left">ConcurrentSessionFilter</td>
<td align="left">å¹¶å‘è®¿é—®æ§åˆ¶è¿‡æ»¤å™¨,ä¸»è¦åŠŸèƒ½ï¼šSessionRegistryä¸­è·å–SessionInformationæ¥åˆ¤æ–­sessionæ˜¯å¦è¿‡æœŸï¼Œä»è€Œå®ç°å¹¶å‘è®¿é—®æ§åˆ¶ã€‚</td>
</tr>
<tr>
<td align="left">HeaderWriterFilter</td>
<td align="left">ç»™http responseæ·»åŠ ä¸€äº›Header</td>
</tr>
<tr>
<td align="left">CsrfFilter</td>
<td align="left">è·¨åŸŸè¿‡æ»¤å™¨ï¼Œè·¨ç«™è¯·æ±‚ä¼ªé€ ä¿æŠ¤Filter</td>
</tr>
<tr>
<td align="left">LogoutFilter</td>
<td align="left">å¤„ç†é€€å‡ºç™»å½•çš„Filter</td>
</tr>
<tr>
<td align="left">X509AuthenticationFilter</td>
<td align="left">æ·»åŠ X509é¢„æˆæƒå¤„ç†æœºåˆ¶æ”¯æŒ</td>
</tr>
<tr>
<td align="left">CasAuthenticationFilter</td>
<td align="left">è®¤è¯filterï¼Œç»è¿‡è¿™äº›è¿‡æ»¤å™¨åSecurityContextHolderä¸­å°†åŒ…å«ä¸€ä¸ªå®Œå…¨ç»„è£…å¥½çš„Authenticationå¯¹è±¡ï¼Œä»è€Œä½¿åç»­é‰´æƒèƒ½æ­£å¸¸æ‰§è¡Œ</td>
</tr>
<tr>
<td align="left">UsernamePasswordAuthenticationFilter</td>
<td align="left">è®¤è¯çš„filterï¼Œç»è¿‡è¿™äº›è¿‡æ»¤å™¨åSecurityContextHolderä¸­å°†åŒ…å«ä¸€ä¸ªå®Œå…¨ç»„è£…å¥½çš„Authenticationå¯¹è±¡ï¼Œä»è€Œä½¿åç»­é‰´æƒèƒ½æ­£å¸¸æ‰§è¡Œã€‚è¡¨å•è®¤è¯æ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªè®¤è¯æ–¹å¼ã€‚</td>
</tr>
<tr>
<td align="left">BasicAuthenticationFilter</td>
<td align="left">è®¤è¯filterï¼Œç»è¿‡è¿™äº›è¿‡æ»¤å™¨åSecurityContextHolderä¸­å°†åŒ…å«ä¸€ä¸ªå®Œå…¨ç»„è£…å¥½çš„Authenticationå¯¹è±¡ï¼Œä»è€Œä½¿åç»­é‰´æƒèƒ½æ­£å¸¸æ‰§è¡Œ</td>
</tr>
<tr>
<td align="left">SecurityContextHolderAwareRequestFilter</td>
<td align="left">æ­¤è¿‡æ»¤å™¨å¯¹ServletRequestè¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ï¼Œä½¿å¾—requestå…·æœ‰æ›´åŠ ä¸°å¯Œçš„API</td>
</tr>
<tr>
<td align="left">JaasApiIntegrationFilter</td>
<td align="left">(JAAS)è®¤è¯æ–¹å¼filter</td>
</tr>
<tr>
<td align="left">RememberMeAuthenticationFilter</td>
<td align="left">è®°å¿†è®¤è¯å¤„ç†è¿‡æ»¤å™¨ï¼Œå³æ˜¯å¦‚æœå‰é¢è®¤è¯è¿‡æ»¤å™¨æ²¡æœ‰å¯¹å½“å‰çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¯ç”¨äº†RememberMeåŠŸèƒ½ï¼Œä¼šä»cookieä¸­è§£æå‡ºç”¨æˆ·ï¼Œå¹¶è¿›è¡Œè®¤è¯å¤„ç†ï¼Œä¹‹ååœ¨SecurityContextHolderä¸­å­˜å…¥ä¸€ä¸ªAuthenticationå¯¹è±¡ã€‚</td>
</tr>
<tr>
<td align="left">AnonymousAuthenticationFilter</td>
<td align="left">åŒ¿åè®¤è¯å¤„ç†è¿‡æ»¤å™¨ï¼Œå½“SecurityContextHolderä¸­è®¤è¯ä¿¡æ¯ä¸ºç©º,åˆ™ä¼šåˆ›å»ºä¸€ä¸ªåŒ¿åç”¨æˆ·å­˜å…¥åˆ°SecurityContextHolderä¸­</td>
</tr>
<tr>
<td align="left">SessionManagementFilter</td>
<td align="left">ä¼šè¯ç®¡ç†Filterï¼ŒæŒä¹…åŒ–ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Œå¯ä»¥ä¿å­˜åˆ°sessionä¸­ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åˆ°cookieæˆ–è€…redisä¸­</td>
</tr>
<tr>
<td align="left">ExceptionTranslationFilter</td>
<td align="left">å¼‚å¸¸å¤„ç†è¿‡æ»¤å™¨ï¼Œä¸»è¦æ‹¦æˆªåç»­è¿‡æ»¤å™¨ï¼ˆFilterSecurityInterceptorï¼‰æ“ä½œä¸­æŠ›å‡ºçš„å¼‚å¸¸ã€‚</td>
</tr>
<tr>
<td align="left">FilterSecurityInterceptor</td>
<td align="left">å®‰å…¨æ‹¦æˆªè¿‡æ»¤å™¨ç±»ï¼Œè·å–å½“å‰è¯·æ±‚urlå¯¹åº”çš„ConfigAttributeï¼Œå¹¶è°ƒç”¨accessDecisionManagerè¿›è¡Œè®¿é—®æˆæƒå†³ç­–ã€‚</td>
</tr>
</tbody></table>
<p><strong>spring securityçš„é»˜è®¤filteré“¾:</strong></p>
<blockquote>
<p> SecurityContextPersistenceFilter<br>-&gt;HeaderWriterFilter<br>-&gt;LogoutFilter<br>-&gt;UsernamePasswordAuthenticationFilter<br>-&gt;RequestCacheAwareFilter<br>-&gt;SecurityContextHolderAwareRequestFilter<br>-&gt;SessionManagementFilter<br>-&gt;ExceptionTranslationFilter<br>-&gt;FilterSecurityInterceptor</p>
</blockquote>
<p>åœ¨ä¸ŠèŠ‚æˆ‘ä»¬å·²åˆ†æäº†æ ¸å¿ƒçš„filteræºç ä»¥åŠåŠŸèƒ½ã€‚å¯å›çœ‹ä¸ŠèŠ‚æºç åˆ†ææ›´åŠ æ·±å…¥çš„äº†è§£å„ä¸ªfilterå·¥ä½œåŸç†ã€‚</p>
<h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>â€ƒâ€ƒåœ¨è®¤è¯å’Œè®¿é—®æˆæƒè¿‡ç¨‹å‰ï¼Œé¦–å…ˆå¿…é¡»è¿›è¡ŒWebSecurityConfigurerç¬¦åˆè‡ªèº«åº”ç”¨çš„security Configurerï¼Œä¹Ÿè¦æ¸…æ¥šfilteré“¾çš„å…ˆåé¡ºåºï¼Œæ‰èƒ½æ›´å¥½ç†è§£spring securityçš„å·¥ä½œåŸç†ä»¥åŠåœ¨é¡¹ç›®ä¸­å‡ºç°çš„é—®é¢˜å®šä½ã€‚</p>
]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Transaction</title>
    <url>/2020/09/08/Spring%20Transaction/</url>
    <content><![CDATA[<h1 id="åªè¯»äº‹åŠ¡è®¾ç½®"><a href="#åªè¯»äº‹åŠ¡è®¾ç½®" class="headerlink" title="åªè¯»äº‹åŠ¡è®¾ç½®"></a>åªè¯»äº‹åŠ¡è®¾ç½®</h1><ol>
<li><p>JDBC æŒ‡å®šåªè¯»äº‹åŠ¡çš„è®¾ç½®ï¼š<code>connection.setReadOnly(true)</code></p>
</li>
<li><p>Hibernate åªè¯»äº‹åŠ¡çš„è®¾ç½®ï¼š<code>session.setFlushMode(FlushMode.NEVER)</code></p>
</li>
<li><p>Spring åªè¯»äº‹åŠ¡è®¾ç½®ï¼š</p>
<p><code>@Transactional(readOnly = true)</code></p>
<p><code>&lt;tx:method name=&quot;search*&quot; read-only=&quot;true&quot; /&gt;</code> </p>
</li>
</ol>
<blockquote>
<p>read-only å¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®åº“éƒ½æ”¯æŒçš„ï¼Œä¸åŒçš„æ•°æ®åº“ä¸‹ä¼šæœ‰ä¸åŒçš„ç»“æœï¼ˆä¾‹å¦‚ï¼šå¯¹ Mysql ç”Ÿæ•ˆï¼Œå¯¹ Oracle ä¸ç”Ÿæ•ˆï¼‰ã€‚</p>
<p>è®¾ç½®äº†read-only åï¼Œconnection éƒ½ä¼šè¢«èµ‹äºˆ read-onlyï¼ˆå¸Œæœ›æ•°æ®åº“é©±åŠ¨å¼€å¯åªè¯»ä¼˜åŒ–ï¼Œä¸ä¸€å®šç”Ÿæ•ˆï¼‰ ï¼Œä¸åº”è¯¥æŠŠ read-onlyä½œä¸ºæ‰“å¼€åªè¯»äº‹åŠ¡çš„åˆ¤æ–­ã€‚</p>
<p>åœ¨ORMæ¡†æ¶ä¸­ï¼Œè®¾ç½®äº†read-onlyä¼šèµ‹äºˆä¸€äº›é¢å¤–çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚åœ¨ Hibernate ä¸­ï¼Œä¼šè¢«ç¦æ­¢ flush ç­‰ã€‚</p>
</blockquote>
<p>Oracle 11.2 çš„<a href="https://docs.oracle.com/cd/B19306_01/java.102/b14355/apxtips.htm#i1007231">æ–‡æ¡£</a>ä¸­è¡¨æ˜Oracle JDBC Driver ä¸æ”¯æŒ read-only connections</p>
<p><img src="http://image.leonote.cn/image-20200908104224212.png" alt="image-20200908104224212"></p>
]]></content>
      <categories>
        <category>Transaction</category>
      </categories>
      <tags>
        <tag>Transaction</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa ä»€ä¹ˆæ˜¯ Spring Data Rest</title>
    <url>/2021/01/30/SpringDataJpa%E4%B9%8BSpringDataRest/</url>
    <content><![CDATA[<h1 id="Spring-Data-Rest-æ˜¯ä»€ä¹ˆ-å’Œ-JPA-æ˜¯ä»€ä¹ˆå…³ç³»"><a href="#Spring-Data-Rest-æ˜¯ä»€ä¹ˆ-å’Œ-JPA-æ˜¯ä»€ä¹ˆå…³ç³»" class="headerlink" title="Spring Data Rest æ˜¯ä»€ä¹ˆ å’Œ JPA æ˜¯ä»€ä¹ˆå…³ç³»?"></a>Spring Data Rest æ˜¯ä»€ä¹ˆ å’Œ JPA æ˜¯ä»€ä¹ˆå…³ç³»?</h1><h2 id="Spring-Data-Rest-Demo"><a href="#Spring-Data-Rest-Demo" class="headerlink" title="Spring Data Rest Demo"></a>Spring Data Rest Demo</h2><p>é€šè¿‡ä»¥ä¸‹å››ä¸ªæ­¥éª¤æ¼”ç¤ºä¸€ä¸‹ Spring Data Rest çš„æ•ˆæœã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šé€šè¿‡ gradle å¼•å…¥ç›¸å…³çš„ jar ä¾èµ–</strong>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-jpa&#x27;</span></span><br><span class="line"><span class="comment">// spring data restçš„ä¾èµ–ï¼Œç”±äºä½¿ç”¨çš„æ˜¯spring bootï¼Œæ‰€ä»¥åªéœ€è¦æ·»åŠ starterå³å¯</span></span><br><span class="line">implementation(<span class="string">&quot;org.springframework.boot:spring-boot-starter-data-rest&quot;</span>)</span><br><span class="line"><span class="comment">//æ·»åŠ swaggeræ–¹ä¾¿çœ‹å¾—å‡ºæ¥ï¼Œç”Ÿæˆäº†å“ªäº›apiæ¥å£</span></span><br><span class="line">implementation <span class="string">&#x27;io.springfox:springfox-boot-starter:3.0.0&#x27;</span></span><br><span class="line"><span class="comment">// swagger å¯¹spring data restæ”¯æŒéœ€è¦æ·»åŠ  springfox-data-rest</span></span><br><span class="line">implementation <span class="string">&#x27;io.springfox:springfox-data-rest:3.0.0&#x27;</span></span><br></pre></td></tr></table></figure>

<p>æ·»åŠ å®Œä¾èµ–ä¹‹åï¼Œå¯ä»¥é€šè¿‡ gradle çš„ä¾èµ–è§†å›¾çœ‹ä¸€ä¸‹éƒ½ç”¨äº†å“ªäº› jar åŒ…ã€‚</p>
<p><img src="http://image.leonote.cn//20210130165502.jpg" alt=""></p>
<p>é€šè¿‡ä¸Šå›¾å¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ° spring-data-rest çš„ jar åŒ…å¼•å…¥æƒ…å†µï¼Œä»¥åŠä¾èµ–çš„ spring-data-jpa å’Œ Swaggerã€‚</p>
<p><strong>ç¬¬äºŒæ­¥ï¼šåœ¨é¡¹ç›®é‡Œé¢æ·»åŠ  SpringFoxConfiguration å¼€å¯ Swagger</strong>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringFoxConfiguration</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ application.properties æŒ‡å®šä¸€ä¸ª base-pathï¼Œä»¥æ–¹ä¾¿å’Œè‡ªå·±çš„ api è¿›è¡ŒåŒºåˆ†</strong>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯ä»¥é€šè¿‡spring data resté‡Œé¢æä¾›çš„é…ç½®é¡¹ï¼ŒæŒ‡å®šbast-path</span></span><br><span class="line"><span class="meta">spring.data.rest.base-path</span>=<span class="string">api/rest/v2</span></span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20210130165729.jpg" alt=""></p>
<p>è¿™æ—¶æ‰“å¼€ Swagger çœ‹ä¸€ä¸‹ï¼š<a href="http://127.0.0.1:8087/swagger-ui/">http://127.0.0.1:8087/swagger-ui/</a></p>
<p><img src="http://image.leonote.cn//20210130165856.jpg" alt=""></p>
<p>ç”±äº Demo çš„é¡¹ç›®ç»“æ„æ˜¯ä¸‹å›¾æ‰€ç¤ºè¿™æ ·çš„ã€‚</p>
<p><img src="http://image.leonote.cn//20210130165941.jpg" alt=""></p>
<p>ä½ ä¼šå‘ç°æœ‰å‡ ä¸ª Repository ä¼šç”Ÿæˆå‡ ä¸ªå¯¹åº”çš„ Rest åè®®çš„ APIï¼Œé™¤äº†åŸºæœ¬çš„ CRUDï¼Œä¾‹å¦‚ UserInfoRespository è‡ªå®šä¹‰çš„æ–¹æ³•å®ƒä»¬ä¹Ÿä¼šå¸®æˆ‘ä»¬å±•ç¤ºå‡ºæ¥ã€‚è€Œ Room å®ä½“å› ä¸ºæ²¡æœ‰å¯¹åº”çš„ Repositoryï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¯¹åº”çš„ Rest é£æ ¼ API ç”Ÿæˆã€‚</p>
<p>é€šè¿‡è¿™ä¸ª Demo å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœè¦åšä¸€ä¸ª Rest é£æ ¼çš„ Server API é¡¹ç›®ï¼Œåªéœ€è¦æŠŠå¯¹åº”çš„ Entity å’Œ Repository å»ºå¥½ï¼Œå°±å¯ä»¥ç›´æ¥æ‹¥æœ‰äº†æ‰€æœ‰çš„ CRUD çš„ API äº†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ã€‚</p>
<h2 id="Spring-Data-Rest-åŸºæœ¬ç”¨æ³•"><a href="#Spring-Data-Rest-åŸºæœ¬ç”¨æ³•" class="headerlink" title="Spring Data Rest åŸºæœ¬ç”¨æ³•"></a>Spring Data Rest åŸºæœ¬ç”¨æ³•</h2><p>é€šè¿‡ Demo å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼ŒSpring Data Rest çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯æŠŠ Spring Data Resositories é‡Œå¯¹å¤–æš´éœ²çš„æ–¹æ³•ç”Ÿæˆå¯¹åº”çš„ APIï¼Œå¦‚ä¸Šé¢çš„ <code>AddressRepository</code>ï¼Œé‡Œé¢å¯¹åº”çš„å®ä½“æ˜¯ Addressï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddressRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Address</span>, <span class="title">Long</span>&gt;</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒå¸®æˆ‘ä»¬ç”Ÿæˆçš„ API æœ‰ä¸‹å›¾æ‰€ç¤ºçš„è¿™äº›ã€‚</p>
<p><img src="http://image.leonote.cn//20210130170309.jpg" alt=""></p>
<p>ä» swagger å¯ä»¥çœ‹åˆ° Spring Data Rest çš„å‡ ç‚¹ç”¨æ³•ã€‚</p>
<h3 id="è¯­ä¹‰åŒ–çš„æ–¹æ³•"><a href="#è¯­ä¹‰åŒ–çš„æ–¹æ³•" class="headerlink" title="è¯­ä¹‰åŒ–çš„æ–¹æ³•"></a>è¯­ä¹‰åŒ–çš„æ–¹æ³•</h3><p>æŠŠå®ä½“è½¬åŒ–æˆå¤æ•°çš„å½¢å¼ï¼Œç”ŸæˆåŸºæœ¬çš„ PATCHã€GETã€PUTã€POSTã€DELETE å¸¦æœ‰è¯­ä¹‰çš„ Rest ç›¸åº”çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬çš„å­èµ„æºæœ‰å¦‚ä¸‹å‡ ä¸ªã€‚</p>
<ul>
<li><p>GETï¼šè¿”å›å•ä¸ªå®ä½“</p>
</li>
<li><p>PUTï¼šæ›´æ–°èµ„æº</p>
</li>
<li><p>PATCHï¼šä¸ PUT ç±»ä¼¼ï¼Œä½†éƒ¨åˆ†æ˜¯æ›´æ–°èµ„æºçŠ¶æ€</p>
</li>
<li><p>DELETEï¼šåˆ é™¤æš´éœ²çš„èµ„æº</p>
</li>
<li><p>POSTï¼šä»ç»™å®šçš„è¯·æ±‚æ­£æ–‡åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä½“</p>
</li>
</ul>
<h3 id="é»˜è®¤çš„çŠ¶æ€ç çš„æ”¯æŒ"><a href="#é»˜è®¤çš„çŠ¶æ€ç çš„æ”¯æŒ" class="headerlink" title="é»˜è®¤çš„çŠ¶æ€ç çš„æ”¯æŒ"></a>é»˜è®¤çš„çŠ¶æ€ç çš„æ”¯æŒ</h3><ul>
<li><p>200 OKï¼šé€‚ç”¨äºçº¯ç²¹çš„ GET è¯·æ±‚</p>
</li>
<li><p>201 Createdï¼šé’ˆå¯¹åˆ›å»ºæ–°èµ„æºçš„ POST å’Œ PUT è¯·æ±‚</p>
</li>
<li><p>204 No Contentï¼šå¯¹äº PUTã€PATCH å’Œ DELETE è¯·æ±‚</p>
</li>
<li><p>401 æ²¡æœ‰è®¤è¯</p>
</li>
<li><p>403 æ²¡æœ‰æƒé™ï¼Œæ‹’ç»è®¿é—®</p>
</li>
<li><p>404 æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„èµ„æº</p>
</li>
</ul>
<h3 id="åˆ†é¡µæ”¯æŒ"><a href="#åˆ†é¡µæ”¯æŒ" class="headerlink" title="åˆ†é¡µæ”¯æŒ"></a>åˆ†é¡µæ”¯æŒ</h3><p>é€šè¿‡ Swaggerï¼Œå¯ä»¥çœ‹åˆ°å…¶å®Œå…¨å¯¹åˆ†é¡µå’Œæ’åºè¿›è¡Œæ”¯æŒï¼Œå®Œå…¨å…¼å®¹ Spring Data JPA çš„åˆ†é¡µå’Œæ’åºçš„å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130170639.jpg" alt=""></p>
<h3 id="é€šè¿‡-RepositoryRestResource-æ”¹å˜èµ„æºçš„-metaData"><a href="#é€šè¿‡-RepositoryRestResource-æ”¹å˜èµ„æºçš„-metaData" class="headerlink" title="é€šè¿‡ @RepositoryRestResource æ”¹å˜èµ„æºçš„ metaData"></a>é€šè¿‡ @RepositoryRestResource æ”¹å˜èµ„æºçš„ metaData</h3><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource(</span></span><br><span class="line"><span class="meta">      exported = true, //èµ„æºæ˜¯å¦æš´éœ²ï¼Œé»˜è®¤true</span></span><br><span class="line"><span class="meta">      path = &quot;users&quot;,//èµ„æºæš´éœ²çš„pathè®¿é—®è·¯å¾„ï¼Œé»˜è®¤å®ä½“åå­—+s</span></span><br><span class="line"><span class="meta">      collectionResourceRel = &quot;userInfo&quot;,//èµ„æºåå­—ï¼Œé»˜è®¤å®ä½“åå­—</span></span><br><span class="line"><span class="meta">      collectionResourceDescription = @Description(&quot;ç”¨æˆ·åŸºæœ¬ä¿¡æ¯èµ„æº&quot;),//èµ„æºæè¿°</span></span><br><span class="line"><span class="meta">      itemResourceRel = &quot;userDetail&quot;,//å–èµ„æºè¯¦æƒ…çš„Itemåå­—</span></span><br><span class="line"><span class="meta">      itemResourceDescription = @Description(&quot;ç”¨æˆ·è¯¦æƒ…&quot;)</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>

<p>å°†å…¶æ”¾ç½®åœ¨ UserInfoRepository ä¸Šé¢æµ‹è¯•ä¸€ä¸‹ï¼Œä»£ç å˜æ›´å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource(</span></span><br><span class="line"><span class="meta">      exported = true,</span></span><br><span class="line"><span class="meta">      path = &quot;users&quot;,</span></span><br><span class="line"><span class="meta">      collectionResourceRel = &quot;userInfo&quot;,</span></span><br><span class="line"><span class="meta">      collectionResourceDescription = @Description(&quot;ç”¨æˆ·èµ„æº&quot;),</span></span><br><span class="line"><span class="meta">      itemResourceRel = &quot;userDetail&quot;,</span></span><br><span class="line"><span class="meta">      itemResourceDescription = @Description(&quot;ç”¨æˆ·è¯¦æƒ…&quot;)</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶é€šè¿‡ Swagger å¯ä»¥çœ‹åˆ°ï¼Œurl çš„ path ä¸Šé¢å˜æˆäº† usersï¼Œè€Œ body é‡Œé¢çš„èµ„æºåå­—å˜æˆäº† userInfoï¼Œå– itemResource çš„ URL æè¿°å˜æˆäº† userDetailï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130171017.jpg" alt=""></p>
<p>@RepositoryRestResource æ˜¯ä½¿ç”¨åœ¨ Repository ç±»ä¸Šé¢çš„å…¨å±€è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹å…·ä½“çš„ Repsitory é‡Œé¢çš„æ¯ä¸ªæ–¹æ³•è¿›è¡Œå•ç‹¬è®¾ç½®ï¼Œè¿™å°±æ˜¯å¦å¤–ä¸€ä¸ªæ³¨è§£ï¼š@RestResourceã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestResource(</span></span><br><span class="line"><span class="meta">      exported = true,//æ˜¯å¦æš´éœ²ç»™Search</span></span><br><span class="line"><span class="meta">      path = &quot;findCities&quot;,//Searchåé¢çš„pathè·¯å¾„</span></span><br><span class="line"><span class="meta">      rel = &quot;cities&quot;//èµ„æºåå­—</span></span><br><span class="line"><span class="meta">)</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å°†å…¶ç”¨äº ***Repository çš„æ–¹æ³•ä¸­å’Œ @Entity çš„å®ä½“å…³ç³»ä¸Šï¼Œé‚£ä¹ˆåœ¨ address çš„ findByAddress æ–¹æ³•ä¸Šé¢åšä¸€ä¸ªæµ‹è¯•ï¼Œçœ‹çœ‹ä¼šå˜æˆä»€ä¹ˆæ ·ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddressRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Address</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">    <span class="meta">@RestResource(</span></span><br><span class="line"><span class="meta">            exported = true,//æ˜¯å¦æš´éœ²ç»™Search</span></span><br><span class="line"><span class="meta">            path = &quot;findCities&quot;,//Searchåé¢çš„pathè·¯å¾„</span></span><br><span class="line"><span class="meta">            rel = &quot;cities&quot;//èµ„æºåå­—</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function">Page&lt;Address&gt; <span class="title">findByAddress</span><span class="params">(<span class="meta">@Param(&quot;address&quot;)</span> String address, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€ Swagger çœ‹ä¸€ä¸‹ç»“æœï¼Œä¼šå‘ç° search åé¢çš„ path è·¯å¾„è¢«è‡ªå®šä¹‰äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130171243.jpg" alt=""></p>
<p>åŒæ—¶è¿™ä¸ªæ³¨è§£ä¹Ÿå¯ä»¥é…ç½®åœ¨å…³è”å…³ç³»ä¸Šï¼Œå¦‚ @OneToMany ç­‰ã€‚å¦‚æœä¸æƒ³æŸäº›æ–¹æ³•æš´éœ²æˆ RestAPIï¼Œå°±ç›´æ¥æ·»åŠ  @RestResource(exported = false) è¿™ä¸€æ³¨è§£å³å¯ï¼Œä¾‹å¦‚ä¸€äº›åˆ é™¤æ–¹æ³•ç­‰ã€‚</p>
<h3 id="spring-data-rest-çš„é…ç½®é¡¹æ”¯æŒ"><a href="#spring-data-rest-çš„é…ç½®é¡¹æ”¯æŒ" class="headerlink" title="spring data rest çš„é…ç½®é¡¹æ”¯æŒ"></a>spring data rest çš„é…ç½®é¡¹æ”¯æŒ</h3><p>è¿™ä¸ªå¯ä»¥ç›´æ¥åœ¨ application.properties é‡Œé¢é…ç½®ï¼Œåœ¨ IDEA é‡Œé¢è¾“å…¥å‰ç¼€çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰å¦‚ä¸‹æç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130171536.jpg" alt=""></p>
<p>å¯¹åº”çš„æè¿°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130171651.jpg" alt=""></p>
<h2 id="è¿”å›ç»“æœå¯¹-Jackson-çš„æ”¯æŒ"><a href="#è¿”å›ç»“æœå¯¹-Jackson-çš„æ”¯æŒ" class="headerlink" title="è¿”å›ç»“æœå¯¹ Jackson çš„æ”¯æŒ"></a>è¿”å›ç»“æœå¯¹ Jackson çš„æ”¯æŒ</h2><p>é€šè¿‡ jackson çš„æ³¨è§£ï¼Œå¯ä»¥æ”¹å˜ rest api çš„å±æ€§çš„åå­—ï¼Œæˆ–è€…å¿½ç•¥å…·ä½“çš„æŸä¸ªå±æ€§ã€‚åœ¨ address çš„å®ä½“é‡Œé¢ï¼Œæ”¹å˜ä¸€ä¸‹å±æ€§ city çš„åå­—ï¼ŒåŒæ—¶å¿½ç•¥ address å±æ€§ï¼Œä»£ç ä¼šå˜æˆå¦‚ä¸‹æ‰€ç¤ºçš„æ ·å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;userInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@JsonProperty(&quot;myCity&quot;)</span> <span class="comment">//æ”¹å˜JSONå“åº”çš„å±æ€§åå­—</span></span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="meta">@JsonIgnore</span> <span class="comment">//JSONè§£æçš„æ—¶å€™å¿½ç•¥æŸä¸ªå±æ€§</span></span><br><span class="line">   <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ Swagger é‡Œé¢çš„ Description å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰çš„èµ„æºçš„æè¿°å‘ç”Ÿäº†å˜åŒ–ï¼Œå­—æ®µåå˜æˆäº† myCityï¼Œaddress å±æ€§æ²¡æœ‰äº†ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130171841.jpg" alt=""></p>
<p>Spring Data Rest è¿”å› ResponseBody çš„åŸç†å’Œæ¥æ”¶ RequestBody çš„åŸç†éƒ½æ˜¯åŸºäº JSON æ ¼å¼çš„</p>
<h2 id="Spring-Data-Rest-å’Œ-Spring-Data-JPA-çš„å…³ç³»"><a href="#Spring-Data-Rest-å’Œ-Spring-Data-JPA-çš„å…³ç³»" class="headerlink" title="Spring Data Rest å’Œ Spring Data JPA çš„å…³ç³»"></a>Spring Data Rest å’Œ Spring Data JPA çš„å…³ç³»</h2><ol>
<li><p>Spring Data JPA åŸºäº JPA åè®®æä¾›äº†ä¸€å¥—æ ‡å‡†çš„ Repository çš„æ“ä½œç»Ÿä¸€æ¥å£ï¼Œæ–¹æ³•åå’Œ @Query éƒ½æ˜¯æœ‰å›ºå®šè¯­æ³•å’Œçº¦å®šçš„è§„åˆ™çš„ã€‚</p>
</li>
<li><p>Spring Data Rest åˆ©ç”¨ JPA çš„çº¦å®šå’Œè¯­æ³•ï¼Œåˆ©ç”¨ Java åå°„ã€åŠ¨æ€ä»£ç†ç­‰æœºåˆ¶ï¼Œå¾ˆå®¹æ˜“å¯ä»¥ç”Ÿæˆä¸€å¥—æ ‡å‡†çš„ rest é£æ ¼çš„ API åè®®æ“ä½œã€‚</p>
</li>
<li><p>ä¹Ÿå°±æ˜¯è¯´ JPA åˆ¶å®šåè®®å’Œæ ‡å‡†ï¼ŒSpring Data Rest åŸºäºè¿™å¥—åè®®ç”Ÿæˆ rest é£æ ¼çš„ Controllerã€‚</p>
</li>
</ol>
<blockquote>
<p>ğŸ¯JPA çš„åº”ç”¨é¢†åŸŸå…¶å®æœ‰å¾ˆå¤šï¼Œåœ¨å†™ä¸€äº›åŸºäºå®ä½“çš„æ¡†æ¶æ—¶å°±å¯ä»¥å‚è€ƒ Spring Data Rest çš„åšæ³•ã€‚ä¾‹å¦‚ <a href="https://jsonapi.org/format/">yahoo å›¢é˜Ÿè®¾è®¡çš„ JSONAPI åè®®</a>ï¼Œä»¥åŠ <a href="https://github.com/yahoo/elide/blob/master/translations/zh/README.md">Elide çš„å®ç°</a>ï¼Œä¹Ÿæ˜¯åŸºäº JPA çš„å®ä½“æ³¨è§£æ¥å®ç°çš„ã€‚</p>
<p>ç”šè‡³ Spring åœ¨ç ”ç©¶çš„ graph QLï¼Œä¹Ÿå¯ä»¥åŸºäºçº¦å®šçš„å®ä½“æ¥åšå¾ˆå¤šäº‹æƒ…ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa ä¹è§‚é”ä¸é‡è¯•æœºåˆ¶</title>
    <url>/2020/11/10/SpringDataJpa%E4%B9%90%E8%A7%82%E9%94%81%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-ä¹è§‚é”ä¸é‡è¯•æœºåˆ¶"><a href="#Spring-Data-Jpa-ä¹è§‚é”ä¸é‡è¯•æœºåˆ¶" class="headerlink" title="Spring Data Jpa ä¹è§‚é”ä¸é‡è¯•æœºåˆ¶"></a>Spring Data Jpa ä¹è§‚é”ä¸é‡è¯•æœºåˆ¶</h1><h2 id="ä»€ä¹ˆæ˜¯ä¹è§‚é”"><a href="#ä»€ä¹ˆæ˜¯ä¹è§‚é”" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¹è§‚é”"></a>ä»€ä¹ˆæ˜¯ä¹è§‚é”</h2><p>ä¹è§‚é”åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¸¸ç”¨ï¼Œå®ƒæ²¡æœ‰åŠ é”ã€æ²¡æœ‰é˜»å¡ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä»¥åŠé«˜å¹¶å‘çš„æƒ…å†µä¸‹ CPU çš„åˆ©ç”¨ç‡æ˜¯æœ€é«˜çš„ï¼Œååé‡ä¹Ÿæ˜¯æœ€å¤§çš„ã€‚</p>
<p>è€Œ Java Persistence API åè®®ä¹Ÿå¯¹ä¹è§‚é”çš„æ“ä½œåšäº†è§„å®šï¼šé€šè¿‡æŒ‡å®š <code>@Version</code> å­—æ®µå¯¹æ•°æ®å¢åŠ ç‰ˆæœ¬å·æ§åˆ¶ï¼Œè¿›è€Œåœ¨æ›´æ–°çš„æ—¶å€™åˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦æœ‰å˜åŒ–ã€‚å¦‚æœæ²¡æœ‰å˜åŒ–å°±ç›´æ¥æ›´æ–°ï¼›å¦‚æœæœ‰å˜åŒ–ï¼Œå°±ä¼šæ›´æ–°å¤±è´¥å¹¶æŠ›å‡ºâ€œOptimisticLockExceptionâ€å¼‚å¸¸ã€‚æˆ‘ä»¬ç”¨ SQL è¡¨ç¤ºä¸€ä¸‹ä¹è§‚é”çš„åšæ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> uid, name, version <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">update <span class="keyword">user</span> <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;jack&#x27;</span>, version<span class="operator">=</span>version<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> version<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>å‡è®¾æœ¬æ¬¡æŸ¥è¯¢çš„ version=1ï¼Œåœ¨æ›´æ–°æ“ä½œæ—¶ï¼ŒåŠ ä¸Šè¿™æ¬¡æŸ¥å‡ºæ¥çš„ Versionï¼Œè¿™æ ·å’Œæˆ‘ä»¬ä¸Šä¸€ä¸ªç‰ˆæœ¬ç›¸åŒï¼Œå°±ä¼šæ›´æ–°æˆåŠŸï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°äº’ç›¸è¦†ç›–çš„é—®é¢˜ï¼Œä¿è¯äº†æ•°æ®çš„åŸå­æ€§ã€‚</p>
<p>è¿™å°±æ˜¯ä¹è§‚é”åœ¨æ•°æ®åº“é‡Œé¢çš„åº”ç”¨ã€‚</p>
<h2 id="ä¹è§‚é”çš„å®ç°æ–¹æ³•"><a href="#ä¹è§‚é”çš„å®ç°æ–¹æ³•" class="headerlink" title="ä¹è§‚é”çš„å®ç°æ–¹æ³•"></a>ä¹è§‚é”çš„å®ç°æ–¹æ³•</h2><p>JPA åè®®è§„å®šï¼Œæƒ³è¦å®ç°ä¹è§‚é”å¯ä»¥é€šè¿‡ <code>@Version</code> æ³¨è§£æ ‡æ³¨åœ¨æŸä¸ªå­—æ®µä¸Šé¢ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–åˆ° DB å³å¯ã€‚å…¶æ”¯æŒçš„ç±»å‹æœ‰å¦‚ä¸‹å››ç§ï¼š</p>
<ul>
<li><p>Integer</p>
</li>
<li><p>Short</p>
</li>
<li><p>Long</p>
</li>
<li><p>java.sql.Timestamp</p>
</li>
</ul>
<p>è¿™æ ·å°±å¯ä»¥å®Œæˆä¹è§‚é”çš„æ“ä½œã€‚æˆ‘æ¯”è¾ƒæ¨èä½¿ç”¨ Integer ç±»å‹çš„å­—æ®µï¼Œå› ä¸ºè¿™æ ·è¯­ä¹‰æ¯”è¾ƒæ¸…æ™°ã€ç®€å•ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šSpring Data JPA é‡Œé¢æœ‰ä¸¤ä¸ª <code>@Version</code> æ³¨è§£</p>
<p>è¯·ä½¿ç”¨ @javax.persistence.Version</p>
<p>è€Œä¸æ˜¯ @org.springframework.data.annotation.Version</p>
</blockquote>
<h3 id="Version-çš„ç”¨æ³•"><a href="#Version-çš„ç”¨æ³•" class="headerlink" title="@Version çš„ç”¨æ³•"></a>@Version çš„ç”¨æ³•</h3><p><strong>1. å®ä½“é‡Œé¢æ·»åŠ å¸¦ <code>@Version</code> æ³¨è§£çš„æŒä¹…åŒ–å­—æ®µ</strong></p>
<p>ç›´æ¥åœ¨è¿™ä¸ª BaseEntity åŸºç±»é‡Œé¢æ·»åŠ  <code>@Version</code> å³å¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªå­—æ®µæ”¾åœ¨ sub-class-entity é‡Œé¢ã€‚æ¨èæ”¾åœ¨åŸºç±»é‡Œé¢ï¼Œå› ä¸ºè¿™æ®µé€»è¾‘æ˜¯å…¬å…±çš„å­—æ®µã€‚æ”¹åŠ¨å®Œä¹‹åæˆ‘ä»¬çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="meta">@Version</span></span><br><span class="line">   <span class="keyword">private</span> Integer version;</span><br><span class="line">   <span class="comment">//......å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä¸Šä¸€è¯¾æ—¶è®²è§£çš„ auditing å­—æ®µï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆçœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2. ç”¨ UserInfo å®ä½“ç»§æ‰¿ BaseEntity</strong>ï¼Œå°±å¯ä»¥å®ç° <code>@Version</code> çš„æ•ˆæœï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3. åˆ›å»º UserInfoRepository</strong>ï¼Œæ–¹ä¾¿è¿›è¡Œ DB æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>4. åˆ›å»º UserInfoService å’Œ UserInfoServiceImpl</strong>ï¼Œç”¨æ¥æ¨¡æ‹Ÿ Service çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ® UserId äº§ç”Ÿçš„ä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">UserInfo <span class="title">calculate</span><span class="params">(Long userId)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ® UserId äº§ç”Ÿçš„ä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span>   </span><br><span class="line">   <span class="meta">@Transactional</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfo <span class="title">calculate</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">      UserInfo userInfo = userInfoRepository.getOne(userId);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//æ¨¡æ‹Ÿå¤æ‚çš„ä¸šåŠ¡è®¡ç®—é€»è¾‘è€—æ—¶æ“ä½œï¼›</span></span><br><span class="line">         Thread.sleep(<span class="number">500</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      userInfo.setAges(userInfo.getAges()+<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">return</span> userInfoRepository.saveAndFlush(userInfo);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>@Transactional</code> å¼€å¯äº‹åŠ¡ï¼Œå¹¶ä¸”åœ¨æŸ¥è¯¢æ–¹æ³•åé¢æ¨¡æ‹Ÿå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œç”¨æ¥å‘ˆç°å¤šçº¿ç¨‹çš„å¹¶å‘é—®é¢˜ã€‚</p>
<p><strong>5. æµ‹è¯•ç”¨ä¾‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span></span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses=UserInfoServiceImpl.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceTest</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//åŠ ä¸€æ¡æ•°æ®</span></span><br><span class="line">      UserInfo userInfo = userInfoRepository.save(UserInfo.builder().ages(<span class="number">20</span>).telephone(<span class="string">&quot;1233456&quot;</span>).build());</span><br><span class="line">      <span class="comment">//éªŒè¯ä¸€ä¸‹æ•°æ®åº“é‡Œé¢çš„å€¼</span></span><br><span class="line">      Assertions.assertEquals(<span class="number">0</span>, userInfo.getVersion());</span><br><span class="line">      Assertions.assertEquals(<span class="number">20</span>, userInfo.getAges());</span><br><span class="line">      userInfoService.calculate(<span class="number">1L</span>);</span><br><span class="line">      <span class="comment">//éªŒè¯ä¸€ä¸‹æ›´æ–°æˆåŠŸçš„å€¼</span></span><br><span class="line">      UserInfo u2 =  userInfoRepository.getOne(<span class="number">1L</span>);</span><br><span class="line">      Assertions.assertEquals(<span class="number">1</span>, u2.getVersion());</span><br><span class="line">      Assertions.assertEquals(<span class="number">21</span>, u2.getAges());</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="meta">@Rollback(false)</span></span><br><span class="line">   <span class="meta">@Transactional(propagation = Propagation.NEVER)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVersionException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//åŠ ä¸€æ¡æ•°æ®</span></span><br><span class="line">  userInfoRepository.saveAndFlush(UserInfo.builder().ages(<span class="number">20</span>).telephone(<span class="string">&quot;1233456&quot;</span>).build());</span><br><span class="line">      <span class="comment">//æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡</span></span><br><span class="line">      <span class="keyword">new</span> Thread(() -&gt; userInfoService.calculate(<span class="number">1L</span>)).start();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         Thread.sleep(<span class="number">10L</span>);<span class="comment">//</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¼šå‘ç”Ÿä¹è§‚é”å¼‚å¸¸ï¼›</span></span><br><span class="line">      Exception exception = Assertions.assertThrows(ObjectOptimisticLockingFailureException.class, () -&gt; &#123;</span><br><span class="line">         userInfoService.calculate(<span class="number">1L</span>);</span><br><span class="line">         <span class="comment">//æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡</span></span><br><span class="line">      &#125;);</span><br><span class="line">      System.out.println(exception);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„æµ‹è¯•å¾—åˆ°çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ testVersion()ï¼Œä¼šå‘ç°åœ¨ save çš„æ—¶å€™ï¼Œ Version ä¼šè‡ªåŠ¨ +1ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä¸º 0ï¼›update çš„æ—¶å€™ä¹Ÿä¼šé™„å¸¦ Version æ¡ä»¶ã€‚é€šè¿‡ä¸‹å›¾çš„ SQLï¼Œä¹Ÿå¯ä»¥çœ‹åˆ° Version çš„å˜åŒ–ã€‚</p>
<p><img src="http://image.leonote.cn/20201110160559.png" alt=""></p>
<p>è€Œå½“é¢æˆ‘ä»¬è°ƒç”¨ testVersionException() æµ‹è¯•æ–¹æ³•çš„æ—¶å€™ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹æ¨¡æ‹Ÿä¸¤ä¸ªå¹¶å‘æƒ…å†µï¼Œä¼šå‘ç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å–åˆ°äº†å†å²æ•°æ®ï¼Œå¹¶åœ¨ç¨åéƒ½å¯¹å†å²æ•°æ®è¿›è¡Œäº†æ›´æ–°ã€‚</p>
<p>ç”±æ­¤ä½ ä¼šå‘ç°ï¼Œç¬¬äºŒæ¬¡æµ‹è¯•çš„ç»“æœæ˜¯ä¹è§‚é”å¼‚å¸¸ï¼Œæ›´æ–°ä¸æˆåŠŸã€‚è¯·çœ‹ä¸€ä¸‹æµ‹è¯•çš„æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20201110160714.png" alt=""></p>
<p>é€šè¿‡æ—¥å¿—åˆä¼šå‘ç°ï¼Œä¸¤ä¸ª SQL åŒæ—¶æ›´æ–°çš„æ—¶å€™ï¼ŒVersion æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯å®ƒå¯¼è‡´äº†ä¹è§‚é”å¼‚å¸¸ã€‚</p>
<blockquote>
<p>ğŸ“Œæ³¨æ„ï¼šä¹è§‚é”å¼‚å¸¸ä¸ä»…ä»…æ˜¯åŒä¸€ä¸ªæ–¹æ³•å¤šçº¿ç¨‹æ‰ä¼šå‡ºç°çš„é—®é¢˜ï¼Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•è€Œé‡‡ç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼›ä¸åŒçš„æ–¹æ³•ã€ä¸åŒçš„é¡¹ç›®ï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´ä¹è§‚é”å¼‚å¸¸ã€‚ä¹è§‚é”çš„æœ¬è´¨æ˜¯ SQL å±‚é¢å‘ç”Ÿçš„ï¼Œå’Œä½¿ç”¨çš„æ¡†æ¶ã€æŠ€æœ¯æ²¡æœ‰å…³ç³»ã€‚</p>
</blockquote>
<h3 id="Version-å¯¹-Save-æ–¹æ³•çš„å½±å“"><a href="#Version-å¯¹-Save-æ–¹æ³•çš„å½±å“" class="headerlink" title="@Version å¯¹ Save æ–¹æ³•çš„å½±å“"></a>@Version å¯¹ Save æ–¹æ³•çš„å½±å“</h3><p>é€šè¿‡ä¸Šé¢çš„å®ä¾‹å‘ç°ï¼Œ<code>@Version</code> åº•å±‚å®ç°é€»è¾‘å’Œ <code>@EntityListeners</code> ä¸€ç‚¹å…³ç³»æ²¡æœ‰ï¼Œåº•å±‚æ˜¯é€šè¿‡ Hibernate åˆ¤æ–­å®ä½“é‡Œé¢æ˜¯å¦æœ‰ <code>@Version</code> çš„æŒä¹…åŒ–å­—æ®µï¼Œåˆ©ç”¨ä¹è§‚é”æœºåˆ¶æ¥åˆ›å»ºå’Œä½¿ç”¨ Version çš„å€¼ã€‚</p>
<p>å› æ­¤ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼šJava Persistence API è´Ÿè´£åˆ¶å®šåè®®ï¼ŒHibernate è´Ÿè´£å®ç°é€»è¾‘ï¼ŒSpring Data JPA è´Ÿè´£å°è£…å’Œä½¿ç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹ Save å¯¹è±¡çš„æ—¶å€™ï¼Œå¦‚ä½•åˆ¤æ–­æ˜¯æ–°å¢çš„è¿˜æ˜¯ merge çš„é€»è¾‘å‘¢ï¼Ÿ</p>
<p><strong>isNew åˆ¤æ–­çš„é€»è¾‘</strong><br>é€šè¿‡æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥ SimpleJpaRepository.class çš„ Save æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°å¦‚ä¸‹å›¾æ˜¾ç¤ºçš„ç•Œé¢ï¼š</p>
<p><img src="http://image.leonote.cn/20201110161206.png" alt=""></p>
<p>ç„¶åï¼Œæˆ‘ä»¬è¿›å…¥ JpaMetamodelEntityInformation.class çš„ isNew æ–¹æ³•ä¸­ï¼Œåˆä¼šçœ‹åˆ°ä¸‹å›¾æ˜¾ç¤ºçš„ç•Œé¢ï¼š</p>
<p><img src="http://image.leonote.cn/20201110161539.png" alt=""></p>
<p>å…¶ä¸­ï¼Œç¬¬ä¸€æ®µé€»è¾‘ï¼Œåˆ¤æ–­å…¶ä¸­æ˜¯å¦æœ‰ <code>@Version</code> æ ‡æ³¨çš„å±æ€§ï¼Œå¹¶ä¸”è¯¥å±æ€§æ˜¯å¦ä¸ºåŸºç¡€ç±»å‹ã€‚å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œè°ƒç”¨ <code>super.isNew(entity)</code> æ–¹æ³•ï¼Œè€Œ super.isNew é‡Œé¢åªåˆ¤æ–­äº† ID å­—æ®µæ˜¯å¦æœ‰å€¼ã€‚</p>
<p>ç¬¬äºŒæ®µé€»è¾‘ï¼Œå¦‚æœæœ‰ <code>@Version</code> å­—æ®µï¼Œé‚£ä¹ˆçœ‹çœ‹è¿™ä¸ªå­—æ®µæ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæ²¡æœ‰å°±è¿”å› trueï¼Œå¦‚æœæœ‰å€¼åˆ™è¿”å› falseã€‚</p>
<blockquote>
<p>ğŸ¯ ç»“è®ºï¼šå¦‚æœæœ‰ <code>@Version</code> æ³¨è§£çš„å­—æ®µï¼Œå°±ä»¥ <code>@Version</code> å­—æ®µæ¥åˆ¤æ–­ save / updateï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±ä»¥ <code>@ID</code> å­—æ®µæ˜¯å¦æœ‰å€¼æ¥åˆ¤æ–­ save / updateã€‚</p>
</blockquote>
<p>æ³¨æ„ï¼šè™½ç„¶çœ‹åˆ°çš„æ˜¯ merge æ–¹æ³•ï¼Œä½†æ˜¯ä¸ä¸€å®šä¼šæ‰§è¡Œ update æ“ä½œï¼Œmerge æ–¹æ³•ä¼šåˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºæ¸¸ç¦»çŠ¶æ€ï¼Œä»¥åŠæœ‰æ—  ID å€¼ã€‚å®ƒä¼šå…ˆè§¦å‘ä¸€æ¡ select è¯­å¥ï¼Œå¹¶æ ¹æ® ID æŸ¥ä¸€ä¸‹è¿™æ¡è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè™½ç„¶ ID å’Œ Version å­—æ®µéƒ½æœ‰å€¼ï¼Œä½†ä¹Ÿåªæ˜¯æ‰§è¡Œ insert è¯­å¥ï¼›å¦‚æœæœ¬æ¡ ID è®°å½•å­˜åœ¨ï¼Œæ‰ä¼šæ‰§è¡Œ update çš„ sqlã€‚è‡³äºè¿™ä¸ªå…·ä½“çš„ insert å’Œ update çš„ sqlã€ä¼ é€’çš„å‚æ•°æ˜¯ä»€ä¹ˆã€‚</p>
<p>æ€»ä¹‹ï¼Œå¦‚æœä½¿ç”¨çº¯ç²¹çš„ saveOrUpdate æ–¹æ³•ï¼Œé‚£ä¹ˆå®Œå…¨ä¸éœ€è¦è‡ªå·±å†™è¿™ä¸€æ®µé€»è¾‘ï¼Œåªè¦ä¿è¯ ID å’Œ Version å­˜åœ¨è¯¥æœ‰çš„å€¼å°±å¯ä»¥äº†ï¼ŒJPA ä¼šå¸®æˆ‘ä»¬å®ç°å‰©ä¸‹çš„é€»è¾‘ã€‚</p>
<p>å®é™…å·¥ä½œä¸­ï¼Œç‰¹åˆ«æ˜¯åˆ†å¸ƒå¼æ›´æ–°çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“ç¢°åˆ°ä¹è§‚é”ï¼Œè¿™æ—¶å€™è¿˜è¦ç»“åˆé‡è¯•æœºåˆ¶æ‰èƒ½å®Œç¾è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚</p>
<p>å…ˆäº†è§£ä¸€ä¸‹ Spring æ”¯æŒçš„é‡è¯•æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>
<h2 id="é‡è¯•æœºåˆ¶è¯¦è§£"><a href="#é‡è¯•æœºåˆ¶è¯¦è§£" class="headerlink" title="é‡è¯•æœºåˆ¶è¯¦è§£"></a>é‡è¯•æœºåˆ¶è¯¦è§£</h2><p>Spring å…¨å®¶æ¡¶é‡Œé¢æä¾›äº†<code>@Retryable</code> çš„æ³¨è§£ï¼Œä¼šå¸®æˆ‘ä»¬è¿›è¡Œé‡è¯•ã€‚ä¸‹é¢çœ‹ä¸€ä¸ª <code>@Retryable</code> çš„ä¾‹å­ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šåˆ©ç”¨ gradle å¼•å…¥ spring-retry çš„ä¾èµ– jarï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">implementation &#39;org.springframework.retry:spring-retry&#39;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šåœ¨ UserInfoServiceImpl çš„æ–¹æ³•ä¸­æ·»åŠ  <code>@Retryable</code> æ³¨è§£ï¼Œå°±å¯ä»¥å®ç°é‡è¯•çš„æœºåˆ¶äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn/20201111084449.png" alt=""></p>
<p>ç¬¬ä¸‰æ­¥ï¼šæ–°å¢ä¸€ä¸ª RetryConfiguration å¹¶æ·»åŠ  <code>@EnableRetry</code> æ³¨è§£ï¼Œæ˜¯ä¸ºäº†å¼€å¯é‡è¯•æœºåˆ¶ï¼Œä½¿ <code>@Retryable</code> ç”Ÿæ•ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableRetry</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RetryConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šæµ‹è¯•ç”¨ä¾‹æµ‹è¯•ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span></span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses=UserInfoServiceImpl.class)</span></span><br><span class="line"><span class="meta">@Import(RetryConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceRetryTest</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="meta">@Rollback(false)</span></span><br><span class="line">   <span class="meta">@Transactional(propagation = Propagation.NEVER)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRetryable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//åŠ ä¸€æ¡æ•°æ®</span></span><br><span class="line">    userInfoRepository.saveAndFlush(UserInfo.builder().ages(<span class="number">20</span>).telephone(<span class="string">&quot;1233456&quot;</span>).build());</span><br><span class="line">      <span class="comment">//æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡</span></span><br><span class="line">      <span class="keyword">new</span> Thread(() -&gt; userInfoService.calculate(<span class="number">1L</span>)).start();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         Thread.sleep(<span class="number">10L</span>);<span class="comment">//</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡ï¼Œç”±äºåŠ äº†@EnableRetryï¼Œæ‰€ä»¥è¿™æ¬¡ä¹Ÿä¼šæˆåŠŸ</span></span><br><span class="line">      UserInfo userInfo = userInfoService.calculate(<span class="number">1L</span>);</span><br><span class="line">      <span class="comment">//ç»è¿‡äº†ä¸¤æ¬¡è®¡ç®—ï¼Œå¹´é¾„å˜æˆäº† 22</span></span><br><span class="line">      Assertions.assertEquals(<span class="number">22</span>,userInfo.getAges());</span><br><span class="line">      Assertions.assertEquals(<span class="number">2</span>,userInfo.getVersion());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æµ‹è¯•ç”¨ä¾‹é‡Œé¢æ‰§è¡Œ <code>@Import(RetryConfiguration.class)</code>ï¼Œè¿™æ ·å°±å¼€å¯äº†é‡è¯•æœºåˆ¶ï¼Œç„¶åç»§ç»­åœ¨é‡Œé¢æ¨¡æ‹Ÿäº†ä¸¤æ¬¡çº¿ç¨‹è°ƒç”¨ï¼Œå‘ç°ç¬¬äºŒæ¬¡å‘ç”Ÿäº†ä¹è§‚é”å¼‚å¸¸ä¹‹åä¾ç„¶æˆåŠŸäº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯å¤±è´¥äº†ä¸€æ¬¡ä¹‹ååˆè¿›è¡Œäº†é‡è¯•ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡æˆåŠŸäº†ã€‚</p>
<p>é€šè¿‡æ¡ˆä¾‹å‘ç° Retry çš„é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦åˆ©ç”¨ <code>@Retryable</code> æ³¨è§£å³å¯</p>
<h3 id="Retryable-è¯¦ç»†ç”¨æ³•"><a href="#Retryable-è¯¦ç»†ç”¨æ³•" class="headerlink" title="@Retryable è¯¦ç»†ç”¨æ³•"></a>@Retryable è¯¦ç»†ç”¨æ³•</h3><p>å…¶æºç é‡Œé¢æä¾›äº†å¾ˆå¤šæ–¹æ³•ï¼Œçœ‹ä¸‹é¢è¿™ä¸ªå›¾ç‰‡ã€‚</p>
<p><img src="http://image.leonote.cn/20201111085808.png" alt=""></p>
<p>ä¸‹é¢å¯¹å¸¸ç”¨çš„ <code>@Retryable</code> æ³¨è§£ä¸­çš„å‚æ•°åšä¸€ä¸‹è¯´æ˜ï¼š</p>
<ul>
<li><p>maxAttemptsï¼šæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 3ï¼Œå¦‚æœè¦è®¾ç½®çš„é‡è¯•æ¬¡æ•°ä¸º 3ï¼Œå¯ä»¥ä¸å†™ï¼›</p>
</li>
<li><p>valueï¼šæŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ‰ä¼šé‡è¯•ï¼›</p>
</li>
<li><p>includeï¼šå’Œ value ä¸€æ ·ï¼Œé»˜è®¤ä¸ºç©ºï¼Œå½“ exclude ä¹Ÿä¸ºç©ºæ—¶ï¼Œé»˜è®¤å¼‚å¸¸ï¼›</p>
</li>
<li><p>excludeï¼šæŒ‡å®šä¸å¤„ç†çš„å¼‚å¸¸ï¼›</p>
</li>
<li><p>backoffï¼šé‡è¯•ç­‰å¾…ç­–ç•¥ï¼Œé»˜è®¤ä½¿ç”¨ <code>@Backoff</code> çš„ valueï¼Œé»˜è®¤ä¸º 1sï¼Œè¯·çœ‹ä¸‹é¢è¿™ä¸ªå›¾ã€‚</p>
<p><img src="http://image.leonote.cn/20201111090105.png" alt=""></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>value=delayï¼šéš”å¤šå°‘æ¯«ç§’åé‡è¯•ï¼Œé»˜è®¤ä¸º 1000Lï¼Œå•ä½æ˜¯æ¯«ç§’ï¼›</li>
<li>multiplierï¼ˆæŒ‡å®šå»¶è¿Ÿå€æ•°ï¼‰é»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºå›ºå®šæš‚åœ 1 ç§’åè¿›è¡Œé‡è¯•ï¼Œå¦‚æœæŠŠ multiplier è®¾ç½®ä¸º 1.5ï¼Œåˆ™ç¬¬ä¸€æ¬¡é‡è¯•ä¸º 1.5 ç§’ï¼Œç¬¬äºŒæ¬¡ä¸º 3 ç§’ï¼Œç¬¬ä¸‰æ¬¡ä¸º 4.5 ç§’ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äº @Retryable æ‰©å±•çš„ä½¿ç”¨ä¾‹å­ï¼Œå…·ä½“çœ‹ä¸€ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Retryable( value = SQLException.class,</span></span><br><span class="line"><span class="meta">        maxAttempts = 2, backoff = @Backoff(delay = 100))</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">retryServiceWithCustomization</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜ç¡®æŒ‡å®š <code>SQLException.class</code> å¼‚å¸¸çš„æ—¶å€™éœ€è¦é‡è¯•ä¸¤æ¬¡ï¼Œæ¯æ¬¡ä¸­é—´é—´éš” 100 æ¯«ç§’ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyService</span> </span>&#123; </span><br><span class="line">  <span class="meta">@Retryable( value = SQLException.class, maxAttemptsExpression = &quot;$&#123;retry.maxAttempts&#125;&quot;,</span></span><br><span class="line"><span class="meta">            backoff = @Backoff(delayExpression = &quot;$&#123;retry.maxDelay&#125;&quot;))</span> </span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">retryServiceWithExternalizedConfiguration</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥åˆ©ç”¨ SpEL è¡¨è¾¾å¼è¯»å–é…ç½®æ–‡ä»¶é‡Œé¢çš„å€¼ã€‚</p>
<p>å¦‚æœä½ é‡åˆ°æ›´å¤æ‚çš„åœºæ™¯ï¼Œå¯ä»¥åˆ° GitHub ä¸­çœ‹ä¸€ä¸‹å®˜æ–¹çš„  <a href="https://github.com/spring-projects/spring-retry">Retryableæ–‡æ¡£</a>ã€‚</p>
<h2 id="ä¹è§‚é”-é‡è¯•æœºåˆ¶çš„æœ€ä½³å®è·µ"><a href="#ä¹è§‚é”-é‡è¯•æœºåˆ¶çš„æœ€ä½³å®è·µ" class="headerlink" title="ä¹è§‚é”+é‡è¯•æœºåˆ¶çš„æœ€ä½³å®è·µ"></a>ä¹è§‚é”+é‡è¯•æœºåˆ¶çš„æœ€ä½³å®è·µ</h2><p>å»ºè®®ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retryable(value = ObjectOptimisticLockingFailureException.class, </span></span><br><span class="line"><span class="meta">           backoff = @Backoff(multiplier = 1.5, random = true))</span></span><br></pre></td></tr></table></figure>


<p>è¿™é‡Œæ˜ç¡®æŒ‡å®š <code>ObjectOptimisticLockingFailureException.class</code> ç­‰ä¹è§‚é”å¼‚å¸¸è¦è¿›è¡Œé‡è¯•ï¼Œå¦‚æœå¼•èµ·å…¶ä»–å¼‚å¸¸çš„è¯ï¼Œé‡è¯•ä¹Ÿä¼šå¤±è´¥ï¼Œæ²¡æœ‰æ„ä¹‰ï¼›è€Œ backoff é‡‡ç”¨éšæœº +1.5 å€çš„ç³»æ•°ï¼Œè¿™æ ·åŸºæœ¬å¾ˆå°‘ä¼šå‡ºç°è¿ç»­ 3 æ¬¡ä¹è§‚é”å¼‚å¸¸çš„æƒ…å†µï¼Œå¹¶ä¸”ä¹Ÿå¾ˆéš¾å‘ç”Ÿ<strong>é‡è¯•é£æš´</strong>è€Œå¼•èµ·<strong>ç³»ç»Ÿé‡è¯•å´©æºƒ</strong>çš„é—®é¢˜ã€‚</p>
<h2 id="æ‚²è§‚é”çš„ç±»å‹æ€ä¹ˆå®ç°ï¼Ÿ-ä¸æ¨èä½¿ç”¨"><a href="#æ‚²è§‚é”çš„ç±»å‹æ€ä¹ˆå®ç°ï¼Ÿ-ä¸æ¨èä½¿ç”¨" class="headerlink" title="æ‚²è§‚é”çš„ç±»å‹æ€ä¹ˆå®ç°ï¼Ÿ(ä¸æ¨èä½¿ç”¨)"></a>æ‚²è§‚é”çš„ç±»å‹æ€ä¹ˆå®ç°ï¼Ÿ(ä¸æ¨èä½¿ç”¨)</h2><p>Java Persistence API 2.0 åè®®é‡Œé¢æœ‰ä¸€ä¸ª LockModeType æšä¸¾å€¼ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰å®ƒæ”¯æŒçš„ä¹è§‚é”å’Œæ‚²è§‚é”çš„å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">LockModeType</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//ç­‰åŒäºOPTIMISTICï¼Œé»˜è®¤ï¼Œç”¨æ¥å…¼å®¹2.0ä¹‹å‰çš„åè®®</span></span><br><span class="line">    READ,</span><br><span class="line">    <span class="comment">//ç­‰åŒäºOPTIMISTIC_FORCE_INCREMENTï¼Œç”¨æ¥å…¼å®¹2.0ä¹‹å‰çš„åè®®</span></span><br><span class="line">    WRITE,</span><br><span class="line">    <span class="comment">//ä¹è§‚é”ï¼Œé»˜è®¤ï¼Œ2.0åè®®æ–°å¢</span></span><br><span class="line">    OPTIMISTIC,</span><br><span class="line">    <span class="comment">//ä¹è§‚å†™é”ï¼Œå¼ºåˆ¶versionåŠ 1ï¼Œ2.0åè®®æ–°å¢</span></span><br><span class="line">    OPTIMISTIC_FORCE_INCREMENT,</span><br><span class="line">    <span class="comment">//æ‚²è§‚è¯»é” 2.0åè®®æ–°å¢</span></span><br><span class="line">    PESSIMISTIC_READ,</span><br><span class="line">    <span class="comment">//æ‚²è§‚å†™é”ï¼Œversionä¸å˜ï¼Œ2.0åè®®æ–°å¢</span></span><br><span class="line">    PESSIMISTIC_WRITE,</span><br><span class="line">    <span class="comment">//æ‚²è§‚å†™é”ï¼Œversionä¼šæ–°å¢ï¼Œ2.0åè®®æ–°å¢</span></span><br><span class="line">    PESSIMISTIC_FORCE_INCREMENT,</span><br><span class="line">    <span class="comment">//2.0åè®®æ–°å¢æ— é”çŠ¶æ€</span></span><br><span class="line">    NONE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªéœ€è¦åœ¨è‡ªå·±çš„ Repository é‡Œé¢è¦†ç›–çˆ¶ç±»çš„ Repository æ–¹æ³•ï¼Œç„¶åæ·»åŠ  <code>@Lock</code> æ³¨è§£å¹¶æŒ‡å®š LockModeType å³å¯æ”¯æŒæ‚²è§‚é”ï¼Œè¯·çœ‹å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Lock(LockModeType.PESSIMISTIC_WRITE)</span></span><br><span class="line">    <span class="function">Optional&lt;UserInfo&gt; <span class="title">findById</span><span class="params">(Long userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserInfoRepository é‡Œé¢è¦†ç›–äº†çˆ¶ç±»çš„ findById æ–¹æ³•ï¼Œå¹¶æŒ‡å®šé”çš„ç±»å‹ä¸ºæ‚²è§‚é”ã€‚å¦‚æœå°† service æ”¹è°ƒç”¨ä¸ºæ‚²è§‚é”çš„æ–¹æ³•ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201111091507.png" alt=""></p>
<p>ç„¶åå†æ‰§è¡Œä¸Šé¢æµ‹è¯•ä¸­ testRetryable çš„æ–¹æ³•ï¼Œè·‘å®Œæµ‹è¯•ç”¨ä¾‹çš„ç»“æœä¾ç„¶æ˜¯é€šè¿‡çš„ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20201111091615.png" alt=""></p>
<p>åˆšæ‰çš„ä¸²è¡Œæ“ä½œå®Œå…¨å˜æˆäº†å¹¶è¡Œæ“ä½œã€‚æ‰€ä»¥å°‘äº†ä¸€æ¬¡ Retry çš„è¿‡ç¨‹ï¼Œç»“æœè¿˜æ˜¯ä¸€æ ·çš„ã€‚</p>
<blockquote>
<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¦æ…ç”¨æ‚²è§‚é”ï¼Œå› ä¸ºå®ƒæ˜¯é˜»å¡çš„ï¼Œä¸€æ—¦å‘ç”ŸæœåŠ¡å¼‚å¸¸ï¼Œå¯èƒ½ä¼šé€ æˆæ­»é”çš„ç°è±¡ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>ä¹è§‚é”</tag>
      </tags>
  </entry>
  <entry>
    <title>spring data jpa å¦‚ä½•å®ç°åŠ¨æ€éƒ¨åˆ†æ›´æ–°</title>
    <url>/2019/12/08/SpringDataJpa%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<p>åˆ›å»ºè¡¨ <code>contact</code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `contact` (</span><br><span class="line">    `id` <span class="type">int</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `mobile` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `address` <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    `create_time` datetime,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå®ä½“ <code>Contact</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity(name = &quot;contact&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Contact</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Column(name = &quot;create_time&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å‡è®¾å‰ç«¯ä¿®æ”¹äº†æŸä¸ªç”¨æˆ·çš„<strong><em>è”ç³»ç”µè¯</em></strong>ï¼Œéœ€è¦æ›´æ–°æ•°æ®åº“ä¸­æŸä¸ªç”¨æˆ·çš„è”ç³»ç”µè¯ï¼š</p>
<p>å‰ç«¯çš„ <code>json</code> ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;å¼ ä¸‰&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mobile&quot;</span>: <span class="string">&quot;13522222222&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;å¹¿ä¸œçœ&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åå°æ‰§è¡Œçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(contact.getId() != <span class="keyword">null</span>)&#123;</span><br><span class="line">  contactRepository.save(contact);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç›´æ¥æ‰§è¡Œè¿™æ®µä»£ç ï¼Œä¼šæŠŠä¹‹å‰çš„<code>create_time</code>ä¿¡æ¯ç½®ä¸º<code>null</code></p>
</blockquote>
<p>åŸå› ï¼š<code>Spring Data Jpa</code> å¯¹Entityçš„æ›´æ–°æ˜¯å¯¹ä¸»é”®ä»¥å¤–çš„æ‰€æœ‰å­—æ®µæ›´æ–°ï¼Œè€Œä¸æ˜¯ä¼ çš„å‚æ•°æ›´æ–°ï¼Œæ‰§è¡Œçš„<code>sql</code>æ˜¯ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">update contact <span class="keyword">set</span> name<span class="operator">=</span>?, mobile<span class="operator">=</span>?, address<span class="operator">=</span>?, create_time<span class="operator">=</span>? <span class="keyword">where</span> id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>



<p><code>Spring Data Jpa</code> saveæ–¹æ³•çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;S extends T&gt; <span class="function">S <span class="title">save</span><span class="params">(S entity)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (entityInformation.isNew(entity)) &#123;</span><br><span class="line">			em.persist(entity);</span><br><span class="line">			<span class="keyword">return</span> entity;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> em.merge(entity);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p><code>Spring Data Jpa</code> ä¼šä¾æ®ä¸»é”®å…ˆæ‰§è¡Œä¸€è¾¹æŸ¥è¯¢ï¼Œå¦‚æœä¸å­˜åœ¨è¿™æ¡è®°å½•åˆ™æ‰§è¡Œæ’å…¥ï¼Œå¦‚æœå­˜åœ¨åˆ™æ‰§è¡Œè¦†ç›–æ“ä½œã€‚</p>
<blockquote>
<p>ä½†æ˜¯è¿™é‡Œå°±æœ‰é—®é¢˜äº†ï¼Œ<code>Spring Data Jpa</code> æ— æ³•ç†è§£å¼€å‘è€…çš„æ„å›¾ï¼Œ</p>
<p>å³å¼€å‘è€…åˆ°åº•æ˜¯æƒ³ç”¨<code>NULL</code>å€¼è¦†ç›–åŸå€¼ï¼Œè¿˜æ˜¯æƒ³é‡åˆ°<code>NULL</code>å€¼è€Œå¿½ç•¥ã€‚</p>
</blockquote>
<p>å¯¹äºéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨<code>@Query</code>å’Œ<code>@Modify</code>æ³¨è§£æ‰‹å†™<code>sql</code>æ¥è¿›è¡Œéƒ¨åˆ†æ›´æ–°ï¼Œ</p>
<p>ä½†æ˜¯åŠ¨æ€æ›´æ–°æ— æ³•åšåˆ°ã€‚</p>
<blockquote>
<p><strong>ä»€ä¹ˆæ˜¯åŠ¨æ€æ›´æ–°?</strong></p>
<p>ä¸æ˜¯å¯¹æ•°æ®è®°å½•çš„æ‰€æœ‰å­—æ®µæ•´ä½“æ›´æ–°ï¼Œè€Œæ˜¯ç›´åˆ°è¿è¡Œæ—¶æ‰ç¡®å®šå“ªä¸ªæˆ–è€…å“ªäº›å­—æ®µä¼šè¢«æ›´æ–°</p>
<p>å¦‚ï¼š</p>
<ol>
<li>åªæ›´æ”¹äº†<code>mobile</code>ï¼Œæ‰§è¡Œçš„æ˜¯ï¼š<code>update contact set mobile=? where id=?</code></li>
<li>æ›´æ”¹äº†<code>mobile</code>å’Œ<code>address</code>ï¼Œæ‰§è¡Œçš„æ˜¯ï¼š<code>update contact set mobile=?, address=? where id=?</code></li>
</ol>
</blockquote>
<p>ä½¿ç”¨<code>@DynamicUpdate</code> </p>
<p>åœ¨å®ä½“ç±»ä¸Šä½¿ç”¨æ³¨è§£<code>@DynamicUpdate</code>æ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£æ˜¯ç”±hibernateæä¾›çš„</p>
<p>è¿™æ—¶å°±å¯ä»¥å®ç°åŠ¨æ€æ›´æ–°äº†ï¼Œåœ¨è¿è¡Œæ—¶ä¿®æ”¹å“ªäº›å­—æ®µï¼Œä¼šåŠ¨æ€ç”Ÿæˆå¯¹åº”çš„<code>sql</code>ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨æ— æ³•ç†è§£å¼€å‘è€…å¯¹äº<code>NULL</code>å€¼çš„æ„å›¾ã€‚é»˜è®¤æ˜¯å¦‚æœåŸå€¼ä¸ä¸º <code>NULL</code> , åˆ™ç”¨<code>NULL</code>å€¼è¦†ç›–ï¼Œå¦‚æœæƒ³è¦å®ç°ä¸è¦†ç›–åŸå€¼ï¼Œéœ€è¦è‡ªè¡Œå®ç°æ¥å£æˆ–è€…å·¥å…·ç±»ã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Springbootå¼€å¯Gizpå‹ç¼©</title>
    <url>/2021/01/02/Springboot%E5%BC%80%E5%90%AFGizp%E5%8E%8B%E7%BC%A9/</url>
    <content><![CDATA[<h1 id="Springbootå¼€å¯Gizpå‹ç¼©"><a href="#Springbootå¼€å¯Gizpå‹ç¼©" class="headerlink" title="Springbootå¼€å¯Gizpå‹ç¼©"></a>Springbootå¼€å¯Gizpå‹ç¼©</h1><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><blockquote>
<p>åœ¨ä¼˜åŒ–æ¥å£æ—¶é—´çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°å¾ˆå¤šæ¥å£çš„<code>Content Download</code>æ—¶é—´è¾ƒé•¿ï¼Œé™¤äº†ç½‘ç»œé—®é¢˜ï¼Œå°±æ˜¯æ¥å£è¯·æ±‚çš„æ•°æ®å¤ªå¤§äº†ï¼Œæœ‰çš„è¾¾åˆ°äº†å‡ ç™¾kbã€‚æ§åˆ¶è¿”å›å‚æ•°æ”¶æ•ˆç”šå¾®ï¼Œè¿™æ—¶å¼€å¯ Gzip å°±éå¸¸æœ‰ç”¨äº†ï¼Œå¯ä»¥å‹ç¼©æ¥å£è¯·æ±‚çš„æ•°æ®ï¼Œä¸€èˆ¬çš„<code>json</code>æ–‡æœ¬å‹ç¼©æ¯”ç‡å¾ˆå¤§ï¼Œå¼€å¯ä¹‹åæ¥å£æ—¶é—´å¤§å¹…ä¸‹é™ï¼</p>
</blockquote>
<h2 id="å¯ç”¨æ­¥éª¤"><a href="#å¯ç”¨æ­¥éª¤" class="headerlink" title="å¯ç”¨æ­¥éª¤"></a>å¯ç”¨æ­¥éª¤</h2><p>Spring boot é¡¹ç›®é…ç½®æ¯”è¾ƒç®€å•ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>é»˜è®¤åªå‹ç¼© Http <strong>body **è¶…è¿‡</strong>2KB**çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹é…ç½®ä¿®æ”¹é»˜è®¤å±æ€§</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">min-response-size:</span> <span class="string">1KB</span></span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨å“åº”å†…å®¹ç±»å‹ä¸ºä»¥ä¸‹å†…å®¹æ—¶æ‰ä¼šå‹ç¼©å“åº”</p>
<ul>
<li><code>text/html</code></li>
<li><code>text/xml</code></li>
<li><code>text/plain</code></li>
<li><code>text/css</code></li>
</ul>
<p>æ¥å£è¿”å›çš„æ˜¯ json æ•°æ®ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸‹é¢çš„é…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">compression:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">mime-types:</span> <span class="string">application/json</span></span><br></pre></td></tr></table></figure>

<h3 id="å¦‚ä½•æŸ¥çœ‹-Gzip-æ˜¯å¦å¼€å¯æˆåŠŸ"><a href="#å¦‚ä½•æŸ¥çœ‹-Gzip-æ˜¯å¦å¼€å¯æˆåŠŸ" class="headerlink" title="å¦‚ä½•æŸ¥çœ‹ Gzip æ˜¯å¦å¼€å¯æˆåŠŸ"></a>å¦‚ä½•æŸ¥çœ‹ Gzip æ˜¯å¦å¼€å¯æˆåŠŸ</h3><p>Google æµè§ˆå™¨æ‰“å¼€F12ï¼Œåˆ‡æ¢åˆ° NetWork ä¸‹ï¼Œå³é”®è¡¨å¤´é€‰æ‹© Response Headers ä¸‹çš„<code>Content-Encoding</code>ï¼Œå¦‚æœå¼€å¯äº†Gzipï¼Œå¯¹åº”æ¥å£ä¸­çš„<code>Content-Encoding</code>ä¸­ä¼šæœ‰æ˜¾ç¤ºã€‚</p>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong> åœ¨åŒæ—¶å¼€å¯ https å’Œ http çš„å·¥ç¨‹ä¸­ï¼ŒGzip é…ç½®åªå¯¹ä¸»ç«¯å£ç”Ÿæ•ˆï¼</p>
</blockquote>
<h3 id="å¯ç”¨åçš„æ•ˆæœ"><a href="#å¯ç”¨åçš„æ•ˆæœ" class="headerlink" title="å¯ç”¨åçš„æ•ˆæœ"></a>å¯ç”¨åçš„æ•ˆæœ</h3><p>å¼€å¯å‰ï¼šæ•°æ® Size ä¸º 511KBï¼Œå³ä¾§æ—¶é—´è“è‰²éƒ¨åˆ†ï¼ˆContent Downloadï¼‰è¾ƒé•¿</p>
<p><img src="http://image.leonote.cn/20210104111107.png" alt=""></p>
<p>å¼€å¯å‰ï¼šæ•°æ® Size ä¸º 21.3KBï¼ŒContent-Encoding ä¸­æ˜¾ç¤º Gzipï¼Œå³ä¾§æ—¶é—´è“è‰²éƒ¨åˆ†æ¶ˆå¤±</p>
<p><img src="http://image.leonote.cn/20210104111124.png" alt=""></p>
<p>å¯¹æ¯”æ•ˆæœéå¸¸æ˜æ˜¾ï¼Œæ¥å£æ—¶é—´ç”±<code>1.03s</code>é™åˆ°<code>164ms</code>ï¼Œå®Œç¾ï¼</p>
]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>Springboot</tag>
        <tag>Annotation</tag>
      </tags>
  </entry>
  <entry>
    <title>Springbootçš„@Conditionalæ³¨è§£</title>
    <url>/2019/09/20/Springboot%E7%9A%84@Conditional%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="Conditional"><a href="#Conditional" class="headerlink" title="@Conditional"></a><code>@Conditional</code></h1><blockquote>
<p>å®˜æ–¹æ–‡æ¡£å®šä¹‰ï¼šâ€œIndicates that a component is only eligible for registration when all specified conditions matchâ€ï¼Œæ„æ€æ˜¯åªæœ‰æ»¡è¶³ä¸€äº›åˆ—æ¡ä»¶ä¹‹åæ‰åˆ›å»ºbeanã€‚</p>
<p>æ‰€ä»¥Springbootåˆ©ç”¨<code>@Conditional</code>æ³¨è§£æ¥ç¡®å®šæ˜¯å¦è¦åŠ è½½è¯¥å®ä¾‹</p>
</blockquote>
<h2 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.context.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Documented;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Conditional &#123;</span><br><span class="line">	Class&lt;? extends Condition&gt;[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä½¿ç”¨çš„ä½ç½®:</p>
<ol>
<li>ç±»çº§åˆ«å¯ä»¥æ”¾åœ¨æ³¨æ ‡è¯†æœ‰<code>@Component</code>ï¼ˆåŒ…å«<code>@Configuration</code>ï¼‰çš„ç±»ä¸Š</li>
<li>ä½œä¸ºä¸€ä¸ª<code>meta-annotation</code>ï¼Œç»„æˆè‡ªå®šä¹‰æ³¨è§£</li>
<li>æ–¹æ³•çº§åˆ«å¯ä»¥æ”¾åœ¨æ ‡è¯†ç”±<code>@Bean</code>çš„æ–¹æ³•ä¸Š</li>
</ol>
</blockquote>
<h1 id="Conditionalæ‹“å±•æ³¨è§£"><a href="#Conditionalæ‹“å±•æ³¨è§£" class="headerlink" title="@Conditionalæ‹“å±•æ³¨è§£"></a><code>@Conditional</code>æ‹“å±•æ³¨è§£</h1><ol>
<li><code>@ConditionalOnBean</code>: å½“ä¸”ä»…å½“Springbootå®¹å™¨å­˜åœ¨æŒ‡å®šçš„bean classes and/or bean namesï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®ä¾‹ã€‚</li>
<li><code>@ConditionalOnMissingBean</code>: å½“ä¸”ä»…å½“Springbootå®¹å™¨ä¸å­˜åœ¨æŒ‡å®šçš„bean classes and/or bean namesï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®ä¾‹</li>
<li><code>@ConditionalOnClass</code>ï¼šå’Œ<code>@ConditionalOnBean</code>ç±»ä¼¼ï¼Œå½“classpathä¸­å­˜åœ¨æŒ‡å®šçš„classæˆ–className</li>
<li><code>@ConditionalOnMissingClass</code>ï¼šå’Œ<code>@ConditionalOnMissingBean</code>ç±»ä¼¼ï¼Œå½“classpathä¸­å­˜åœ¨æŒ‡å®šçš„classæˆ–className</li>
<li><code>@ConditionalOnProperty</code>ï¼šå½“ä¸”ä»…å½“application.properties/application.ymlå­˜åœ¨æŒ‡å®šçš„é…ç½®é¡¹æ—¶ï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®ä¾‹</li>
<li><code>@ConditionalOnJava</code>ï¼šæŒ‡å®šJDKçš„ç‰ˆæœ¬</li>
<li><code>@ConditionalOnExpression</code>ï¼šè¡¨è¾¾å¼ç”¨${..}=falseç­‰æ¥è¡¨ç¤º</li>
<li><code>@ConditionalOnJndi</code>ï¼šJNDIå­˜åœ¨è¯¥é¡¹æ—¶åˆ›å»º</li>
<li><code>@ConditionalOnResource</code>ï¼šåœ¨classpathä¸‹å­˜åœ¨æŒ‡å®šçš„resourceæ—¶åˆ›å»º</li>
<li><code>@ConditionalOnSingleCandidate</code> å½“å®¹å™¨ä¸­æŒ‡å®šçš„classä»…å­˜åœ¨ä¸€ä¸ªbeançš„æ—¶å€™ï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®ä¾‹</li>
<li><code>@ConditionalOnWebApplication</code>ï¼šåœ¨webç¯å¢ƒä¸‹åˆ›å»º</li>
</ol>
]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>Springboot</tag>
        <tag>Annotation</tag>
      </tags>
  </entry>
  <entry>
    <title>Springç¼“å­˜æ³¨è§£</title>
    <url>/2019/12/04/Spring%E7%BC%93%E5%AD%98%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<blockquote>
<p>Spring 3.1 å¼•å…¥äº†åŸºäºæ³¨è§£çš„ç¼“å­˜æŠ€æœ¯ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå¯¹ç¼“å­˜ä½¿ç”¨çš„æŠ½è±¡ï¼Œé€šè¿‡åœ¨æ—¢æœ‰ä»£ç ä¸­æ·»åŠ å°‘é‡å®ƒå®šä¹‰çš„å„ç§æ³¨è§£ï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°ç¼“å­˜æ–¹æ³•çš„è¿”å›å¯¹è±¡çš„æ•ˆæœã€‚</p>
<p>Spring çš„ç¼“å­˜æŠ€æœ¯è¿˜å…·å¤‡ç›¸å½“çš„çµæ´»æ€§ï¼Œä¸ä»…èƒ½å¤Ÿä½¿ç”¨ SpELï¼ˆSpring Expression Languageï¼‰æ¥å®šä¹‰ç¼“å­˜çš„ key å’Œå„ç§ conditionï¼Œè¿˜æä¾›å¼€ç®±å³ç”¨çš„ç¼“å­˜ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆã€‚</p>
</blockquote>
<h1 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ³¨è§£</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>æ³¨è§£</tag>
        <tag>Spring</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Springè‡ªå®šä¹‰æ³¨è§£</title>
    <url>/2019/09/05/Spring%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h1><blockquote>
<p>åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šä½¿ç”¨å¾ˆå¤šçš„æ³¨è§£ï¼Œä½†æ˜¯æ¡†æ¶è‡ªæœ‰çš„æ³¨è§£å¹¶ä¸æ˜¯æ€»èƒ½æ»¡è¶³æˆ‘ä»¬å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šè‡ªå®šä¹‰æ³¨è§£æ¥æ»¡è¶³éœ€æ±‚ã€‚æ ¹æ®æ³¨è§£ä½¿ç”¨çš„ä½ç½®ï¼Œåˆ†æˆå­—æ®µæ³¨è§£ã€æ–¹æ³•ã€ç±»æ³¨è§£æ¥ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰æ³¨è§£ã€‚</p>
</blockquote>
<h1 id="å­—æ®µæ³¨è§£"><a href="#å­—æ®µæ³¨è§£" class="headerlink" title="å­—æ®µæ³¨è§£"></a>å­—æ®µæ³¨è§£</h1><blockquote>
<p>å­—æ®µæ³¨è§£ä¸€èˆ¬æ˜¯ç”¨äºæ ¡éªŒå­—æ®µæ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå…¶ä¸­hibernate-validateä¾èµ–å°±æä¾›äº†å¾ˆå¤šå¸¸ç”¨çš„æ ¡éªŒæ³¨è§£ ï¼Œå¦‚<code>@NotNull</code>ã€<code>@Range</code>ç­‰ï¼Œå¯ä»¥è§£å†³å¸¸è§çš„ä¸šåŠ¡åœºæ™¯ã€‚ç„¶è€Œå¦‚æœæƒ³è¦æ ¡éªŒè·Ÿä¸šåŠ¡å¼ºç›¸å…³çš„éœ€æ±‚ï¼Œé‚£ä¹ˆå·²æœ‰çš„æ³¨è§£å°±ä¸æ»¡è¶³äº†ã€‚ä¾‹å¦‚ï¼šä¼ å…¥çš„å‚æ•°éœ€è¦åˆ¤æ–­æ˜¯å¦åœ¨æŒ‡å®šçš„Stringé›†åˆä¸­ï¼ˆä¸šåŠ¡æšä¸¾é›†åˆä¹Ÿå¯ï¼‰ã€‚</p>
</blockquote>
<h3 id="è‡ªå®šä¹‰æ³¨è§£-Check"><a href="#è‡ªå®šä¹‰æ³¨è§£-Check" class="headerlink" title="è‡ªå®šä¹‰æ³¨è§£@Check"></a>è‡ªå®šä¹‰æ³¨è§£<code>@Check</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åªå…è®¸ç”¨åœ¨ç±»çš„å­—æ®µä¸Š</span></span><br><span class="line"><span class="meta">@Target(&#123; ElementType.FIELD&#125;)</span> </span><br><span class="line"><span class="comment">//æ³¨è§£ä¿ç•™åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åå°„è·å¾—å®šä¹‰åœ¨æŸä¸ªç±»ä¸Šçš„æ‰€æœ‰æ³¨è§£</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span> </span><br><span class="line"><span class="comment">//æŒ‡å®šä¸æ³¨è§£å…³è”çš„éªŒè¯å™¨</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = ParamConstraintValidated.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Check &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆæ³•çš„å‚æ•°å€¼</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    String[] paramValues();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æç¤ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> &quot;å‚æ•°ä¸ä¸ºæŒ‡å®šå€¼&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><code>@Target</code> å®šä¹‰æ³¨è§£çš„ä½¿ç”¨ä½ç½®ï¼Œç”¨æ¥è¯´æ˜è¯¥æ³¨è§£å¯ä»¥è¢«å£°æ˜åœ¨é‚£äº›å…ƒç´ ä¸Šã€‚</strong></p>
<ul>
<li><code>ElementType.TYPE</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜åœ¨ä¸€ä¸ª<strong><em>ç±»</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.FIELD</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜åœ¨ä¸€ä¸ª<strong><em>ç±»çš„å­—æ®µ</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.METHOD</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜åœ¨ä¸€ä¸ª<strong><em>ç±»çš„æ–¹æ³•</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.PARAMETER</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜åœ¨ä¸€ä¸ª<strong><em>æ–¹æ³•å‚æ•°</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.CONSTRUCTOR</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½å£°æ˜åœ¨ä¸€ä¸ª<strong><em>ç±»çš„æ„é€ æ–¹æ³•</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.LOCAL_VARIABLE</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½å£°æ˜åœ¨ä¸€ä¸ª<strong><em>å±€éƒ¨å˜é‡</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.ANNOTATION_TYPE</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½å£°æ˜åœ¨ä¸€ä¸ª<strong><em>æ³¨è§£ç±»å‹</em></strong>ä¸Šã€‚</li>
<li><code>ElementType.PACKAGE</code>ï¼šè¯´æ˜è¯¥æ³¨è§£åªèƒ½å£°æ˜åœ¨ä¸€ä¸ª<strong><em>åŒ…å</em></strong>ä¸Š</li>
</ul>
<p><strong><code>@Constraint</code> é€šè¿‡ä½¿ç”¨<code>validatedBy</code>æ¥æŒ‡å®šä¸æ³¨è§£å…³è”çš„éªŒè¯å™¨</strong></p>
<p><strong><code>@Retention</code>ç”¨æ¥è¯´æ˜è¯¥æ³¨è§£ç±»çš„ç”Ÿå‘½å‘¨æœŸã€‚</strong></p>
<ul>
<li><code>RetentionPolicy.SOURCE</code>: æ³¨è§£åªä¿ç•™åœ¨<strong><em>æºæ–‡ä»¶</em></strong>ä¸­</li>
<li><code>RetentionPolicy.CLASS</code> : æ³¨è§£ä¿ç•™åœ¨<strong><em>classæ–‡ä»¶</em></strong>ä¸­ï¼Œåœ¨åŠ è½½åˆ°JVMè™šæ‹Ÿæœºæ—¶ä¸¢å¼ƒ</li>
<li><code>RetentionPolicy.RUNTIME</code>: æ³¨è§£ä¿ç•™<strong><em>åœ¨ç¨‹åºè¿è¡ŒæœŸé—´</em></strong>ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åå°„è·å¾—å®šä¹‰åœ¨æŸä¸ªç±»ä¸Šçš„æ‰€æœ‰æ³¨è§£ã€‚</li>
</ul>
</blockquote>
<h3 id="å®šä¹‰å¤„ç†-Checkçš„éªŒè¯å™¨ç±»"><a href="#å®šä¹‰å¤„ç†-Checkçš„éªŒè¯å™¨ç±»" class="headerlink" title="å®šä¹‰å¤„ç†@Checkçš„éªŒè¯å™¨ç±»"></a>å®šä¹‰å¤„ç†<code>@Check</code>çš„éªŒè¯å™¨ç±»</h3><p>éªŒè¯å™¨ç±»éœ€è¦å®ç°<code>ConstraintValidator</code>æ³›å‹æ¥å£</p>
<blockquote>
<p>ç¬¬ä¸€ä¸ªæ³›å‹å‚æ•°ç±»å‹ï¼šæ ¡éªŒçš„æ³¨è§£ã€‚</p>
<p>ç¬¬äºŒä¸ªæ³›å‹å‚æ•°Objectï¼šæ ¡éªŒå­—æ®µç±»å‹ã€‚</p>
<p>éœ€è¦å®ç°<code>initialize</code>å’Œ<code>isValid</code>æ–¹æ³•ï¼Œ<code>isValid</code>æ–¹æ³•ä¸ºæ ¡éªŒé€»è¾‘ï¼Œ<code>initialize</code>æ–¹æ³•åˆå§‹åŒ–å·¥ä½œ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParamConstraintValidated</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">Check</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆæ³•çš„å‚æ•°å€¼ï¼Œä»æ³¨è§£ä¸­è·å–</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; paramValues;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Check constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–æ—¶è·å–æ³¨è§£ä¸Šçš„å€¼</span></span><br><span class="line">        paramValues = Arrays.asList(constraintAnnotation.paramValues());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object o, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (paramValues.contains(o)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸åœ¨æŒ‡å®šçš„å‚æ•°åˆ—è¡¨ä¸­</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h3><p>å®šä¹‰ä¸€ä¸ªå®ä½“ç±»ï¼Œå¯¹sexå­—æ®µåŠ æ ¡éªŒï¼Œå…¶å€¼å¿…é¡»ä¸ºwomanæˆ–è€…man</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å§“å</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ€§åˆ« man or women</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Check(paramValues = &#123;&quot;man&quot;, &quot;woman&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨éœ€è¦æ£€éªŒçš„å¯¹è±¡ä¸ŠåŠ ä¸Š<code>@Validated</code>æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController(&quot;/api/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">test</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="æ–¹æ³•ã€ç±»æ³¨è§£"><a href="#æ–¹æ³•ã€ç±»æ³¨è§£" class="headerlink" title="æ–¹æ³•ã€ç±»æ³¨è§£"></a>æ–¹æ³•ã€ç±»æ³¨è§£</h1><blockquote>
<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°è¿‡è¿™æ ·çš„éœ€æ±‚ï¼Œå¦‚åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·çš„æ‰èƒ½è®¿é—®è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•æˆ–æŸä¸ªå…·ä½“çš„æ–¹æ³•ã€æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™å…ˆä¸ä»æ•°æ®åº“æŸ¥æ‰¾ï¼Œå…ˆä»<code>guava cache</code>ä¸­æŸ¥æ‰¾ï¼Œåœ¨ä»<code>redis</code>æŸ¥æ‰¾ï¼Œæœ€åæŸ¥æ‰¾<code>mysql</code>ï¼ˆå¤šçº§ç¼“å­˜ï¼‰ã€‚</p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ³¨è§£å»å®Œæˆè¿™ä¸ªè¦æ±‚ï¼š</p>
<ul>
<li><p>ç¬¬ä¸€ä¸ªåœºæ™¯ï¼šå®šä¹‰ç±»ä¼¼<code>Spring Security</code>ä¸‹çš„<code>@PreAuthorize</code>ä¸€æ ·çš„åŠŸèƒ½çš„æƒé™æ ¡éªŒçš„æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">- <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;)&quot;)</span> </span><br><span class="line">- <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;ADMIN&#x27;)&quot;)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬äºŒä¸ªåœºæ™¯ï¼šå®šä¹‰ç±»ä¼¼<code>Spring-data-redis</code>ä¸‹çš„<code>@Cacheable</code>çš„æ³¨è§£</p>
</li>
</ul>
</blockquote>
<h2 id="æƒé™æ³¨è§£"><a href="#æƒé™æ³¨è§£" class="headerlink" title="æƒé™æ³¨è§£"></a>æƒé™æ³¨è§£</h2><h3 id="è‡ªå®šä¹‰æ³¨è§£-PermissionCheck"><a href="#è‡ªå®šä¹‰æ³¨è§£-PermissionCheck" class="headerlink" title="è‡ªå®šä¹‰æ³¨è§£@PermissionCheck"></a>è‡ªå®šä¹‰æ³¨è§£<code>@PermissionCheck</code></h3><p>è¯¥æ³¨è§£çš„ä½œç”¨èŒƒå›´ä¸ºç±»æˆ–è€…æ–¹æ³•ä¸Š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PermissionCheck &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºkey</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function">String <span class="title">resourceKey</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®šä¹‰å¤„ç†-PermissionCheckçš„æ‹¦æˆªå™¨ç±»"><a href="#å®šä¹‰å¤„ç†-PermissionCheckçš„æ‹¦æˆªå™¨ç±»" class="headerlink" title="å®šä¹‰å¤„ç†@PermissionCheckçš„æ‹¦æˆªå™¨ç±»"></a>å®šä¹‰å¤„ç†<code>@PermissionCheck</code>çš„æ‹¦æˆªå™¨ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionCheckInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å™¨å¤„ç†ä¹‹å‰è°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HandlerMethod handlerMethod = (HandlerMethod)handler;</span><br><span class="line">        PermissionCheck permission = findPermissionCheck(handlerMethod);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰æ·»åŠ æƒé™æ³¨è§£åˆ™ç›´æ¥è·³è¿‡å…è®¸è®¿é—®</span></span><br><span class="line">        <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–æ³¨è§£ä¸­çš„å€¼</span></span><br><span class="line">        String resourceKey = permission.resourceKey();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO æƒé™æ ¡éªŒä¸€èˆ¬éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡æŸ¥è¯¢æ•°æ®åº“è¿›è¡Œæƒé™æ ¡éªŒ</span></span><br><span class="line">        <span class="comment">//TODO è¿™é‡Œåªè¿›è¡Œç®€å•æ¼”ç¤ºï¼Œå¦‚æœresourceKeyä¸ºtestKeyåˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™ä¸é€šè¿‡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testKey&quot;</span>.equals(resourceKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®handlerMethodè¿”å›æ³¨è§£ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handlerMethod æ–¹æ³•å¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> PermissionCheckæ³¨è§£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PermissionCheck <span class="title">findPermissionCheck</span><span class="params">(HandlerMethod handlerMethod)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//åœ¨æ–¹æ³•ä¸Šå¯»æ‰¾æ³¨è§£</span></span><br><span class="line">        PermissionCheck permission = handlerMethod.getMethodAnnotation(PermissionCheck.class);</span><br><span class="line">        <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//åœ¨ç±»ä¸Šå¯»æ‰¾æ³¨è§£</span></span><br><span class="line">            permission = handlerMethod.getBeanType().getAnnotation(PermissionCheck.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> permission;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/api/test&quot;)</span></span><br><span class="line"><span class="meta">@PermissionCheck(resourceKey = &quot;test&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">testPermissionCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼“å­˜æ³¨è§£"><a href="#ç¼“å­˜æ³¨è§£" class="headerlink" title="ç¼“å­˜æ³¨è§£"></a>ç¼“å­˜æ³¨è§£</h2><h3 id="è‡ªå®šä¹‰æ³¨è§£-CustomCache"><a href="#è‡ªå®šä¹‰æ³¨è§£-CustomCache" class="headerlink" title="è‡ªå®šä¹‰æ³¨è§£@CustomCache"></a>è‡ªå®šä¹‰æ³¨è§£<code>@CustomCache</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CustomCache &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç¼“å­˜çš„keyå€¼</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®šä¹‰å¤„ç†-CustomCacheçš„åˆ‡é¢ç±»"><a href="#å®šä¹‰å¤„ç†-CustomCacheçš„åˆ‡é¢ç±»" class="headerlink" title="å®šä¹‰å¤„ç† @CustomCacheçš„åˆ‡é¢ç±»"></a>å®šä¹‰å¤„ç† <code>@CustomCache</code>çš„åˆ‡é¢ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomCacheAspect</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ³¨è§£è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customCache æ³¨è§£</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›ä¸­çš„å€¼</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.test.annotation.CustomCache)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">dealProcess</span><span class="params">(ProceedingJoinPoint pjd, CustomCache customCache)</span> </span>&#123;</span><br><span class="line">        Object result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (customCache.key() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//TODO throw error</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//TODO ä¸šåŠ¡åœºæ™¯ä¼šæ¯”è¿™ä¸ªå¤æ‚çš„å¤šï¼Œä¼šæ¶‰åŠå‚æ•°çš„è§£æå¦‚keyå¯èƒ½æ˜¯#&#123;id&#125;è¿™äº›ï¼Œæ•°æ®æŸ¥è¯¢</span></span><br><span class="line">        <span class="comment">//TODO è¿™é‡Œåšç®€å•æ¼”ç¤ºï¼Œå¦‚æœkeyä¸ºtestKeyåˆ™è¿”å›hello world</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;testKey&quot;</span>.equals(customCache.key())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello word&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ‰§è¡Œç›®æ ‡æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = pjd.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å› ä¸ºç¼“å­˜æ³¨è§£éœ€è¦åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥æ²¡æœ‰é€šè¿‡æ‹¦æˆªå™¨å¤„ç†è¿™ä¸ªæ³¨è§£ï¼Œè€Œæ˜¯é€šè¿‡ä½¿ç”¨åˆ‡é¢åœ¨æ‰§è¡Œæ–¹æ³•ä¹‹å‰å¯¹æ³¨è§£è¿›è¡Œå¤„ç†ã€‚å¦‚æœæ³¨è§£æ²¡æœ‰è¿”å›å€¼ï¼Œå°†ä¼šè¿”å›æ–¹æ³•ä¸­çš„å€¼ã€‚</p>
</blockquote>
<h3 id="æµ‹è¯•-2"><a href="#æµ‹è¯•-2" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/api/cache&quot;)</span></span><br><span class="line"><span class="meta">@CustomCache(key = &quot;test&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">testCustomCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;don&#x27;t hit cache&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>æ³¨è§£</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>æ³¨è§£</tag>
        <tag>Spring</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>String.join()</title>
    <url>/2020/09/10/StringJoiner/</url>
    <content><![CDATA[<h1 id="String-join"><a href="#String-join" class="headerlink" title="String.join()"></a>String.join()</h1><blockquote>
<p>JDK8 é‡è½½äº†joinæ–¹æ³•</p>
</blockquote>
<p><img src="http://image.leonote.cn/image-20200911103925509.png" alt="image-20200911103925509"></p>
<h1 id="SpringJoiner"><a href="#SpringJoiner" class="headerlink" title="SpringJoiner"></a>SpringJoiner</h1><h2 id="æ„é€ å‡½æ•°è¯¦ç»†ä¿¡æ¯"><a href="#æ„é€ å‡½æ•°è¯¦ç»†ä¿¡æ¯" class="headerlink" title="æ„é€ å‡½æ•°è¯¦ç»†ä¿¡æ¯"></a>æ„é€ å‡½æ•°è¯¦ç»†ä¿¡æ¯</h2><p><code>public StringJoiner (CharSequence  delimiter, CharSequence  prefixï¼ŒCharSequence  suffix )</code></p>
<p>å‚æ•°ï¼š</p>
<ol>
<li><p>delimiter - æ·»åŠ åˆ°çš„æ¯ä¸ªå…ƒç´ ä¹‹é—´è¦ä½¿ç”¨çš„å­—ç¬¦åºåˆ—</p>
</li>
<li><p>prefix - å¼€å¤´ä½¿ç”¨çš„å­—ç¬¦åºåˆ—</p>
</li>
<li><p>suffix - æœ€åä½¿ç”¨çš„å­—ç¬¦åºåˆ—</p>
<p>å¦‚æœ prefixï¼Œdelimiter æˆ– suffix  æ˜¯ null,  åˆ™æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p>
</li>
</ol>
<p>ä¸¾ä¾‹ï¼šå­—ç¬¦ä¸²<code>&quot;[George:Sally:Fred]&quot;</code>å¯ä»¥æ„é€ å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringJoiner sj = <span class="keyword">new</span> StringJoiner(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;[&quot;</span>, <span class="string">&quot;]&quot;</span>);</span><br><span class="line">sj.add(<span class="string">&quot;George&quot;</span>).add(<span class="string">&quot;Sally&quot;</span>).add(<span class="string">&quot;Fred&quot;</span>);</span><br><span class="line">String desiredString = sj.toString();</span><br></pre></td></tr></table></figure>


]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>String</tag>
        <tag>Join</tag>
      </tags>
  </entry>
  <entry>
    <title>Stringçš„å¸¸è§é—®é¢˜</title>
    <url>/2019/09/06/String%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="åŒå¼•å·å’Œæ„é€ å™¨ä¸¤ç§å½¢å¼åˆ›å»ºå­—ç¬¦ä¸²çš„åŒºåˆ«"><a href="#åŒå¼•å·å’Œæ„é€ å™¨ä¸¤ç§å½¢å¼åˆ›å»ºå­—ç¬¦ä¸²çš„åŒºåˆ«" class="headerlink" title="åŒå¼•å·å’Œæ„é€ å™¨ä¸¤ç§å½¢å¼åˆ›å»ºå­—ç¬¦ä¸²çš„åŒºåˆ«"></a>åŒå¼•å·å’Œæ„é€ å™¨ä¸¤ç§å½¢å¼åˆ›å»ºå­—ç¬¦ä¸²çš„åŒºåˆ«</h1><h2 id="ä¾‹å­1"><a href="#ä¾‹å­1" class="headerlink" title="ä¾‹å­1"></a>ä¾‹å­1</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String a = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line">String b = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line">System.out.println(a == b);  <span class="comment">// True</span></span><br><span class="line">System.out.println(a.equals(b)); <span class="comment">// True</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>a == b</code> ç»“æœä¸º trueï¼Œæ˜¯å› ä¸º a å’Œ b éƒ½æŒ‡å‘ <strong>æ–¹æ³•åŒº(method area)</strong> åŒä¸€ä¸ªå­—ç¬¦ä¸²æ–‡å­—ï¼Œå†…å­˜å¼•ç”¨æ˜¯åŒä¸€ä¸ªã€‚</p>
<p>å½“å¤šæ¬¡åˆ›å»ºç›¸åŒçš„å­—ç¬¦ä¸²æ–‡å­—æ—¶ï¼Œåªå­˜å‚¨æ¯ä¸ªä¸åŒå­—ç¬¦ä¸²å€¼çš„ä¸€ä¸ªå‰¯æœ¬ã€‚è¿™ä¸ªå«åš<strong>å­—ç¬¦ä¸²ç•™é©»/ç•™ç”¨</strong>ï¼ŒJava ä¸­æ‰€æœ‰ç¼–è¯‘æœŸå­—ç¬¦ä¸²å¸¸é‡éƒ½ä¼šè¢«è‡ªåŠ¨ç•™é©»ã€‚</p>
</blockquote>
<h2 id="ä¾‹å­2"><a href="#ä¾‹å­2" class="headerlink" title="ä¾‹å­2"></a>ä¾‹å­2</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String c = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>);</span><br><span class="line">String d = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>);</span><br><span class="line">System.out.println(c == d);  <span class="comment">// False</span></span><br><span class="line">System.out.println(c.equals(d)); <span class="comment">// True</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>c==d</code> ç»“æœä¸º falseï¼Œå› ä¸º c å’Œ d çš„å¼•ç”¨æŒ‡å‘<strong>å †</strong>ä¸­ä¸åŒçš„å¯¹è±¡ï¼Œ<code>ä¸åŒçš„å¯¹è±¡è‚¯å®šæœ‰ä¸åŒçš„å†…å­˜å¼•ç”¨</code></p>
</blockquote>
<p>ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œç”¨å›¾å½¢æ¥ç†è§£çš„è¯æ˜¯ï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-09-05_16-16-45.png" alt=""></p>
<blockquote>
<p>ä¸€ä¸ªæ˜¯åœ¨<code>æ–¹æ³•åŒº</code>ï¼Œä¸€ä¸ªæ˜¯åœ¨<code>å †</code>ä¸­ï¼Œ è¿™æ˜¯JVMæ¨¡å‹çš„ä¸¤ä¸ªä¸åŒçš„åŒºåŸŸã€‚</p>
<p>JVMæ¨¡å‹çš„å›¾ï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-09-05_16-21-11.png" alt=""></p>
<p>æ‰€æœ‰newçš„å¯¹è±¡éƒ½åœ¨Heapä¸­ã€‚</p>
</blockquote>
<h2 id="è¿è¡ŒæœŸå­—ç¬¦ä¸²ç•™é©»"><a href="#è¿è¡ŒæœŸå­—ç¬¦ä¸²ç•™é©»" class="headerlink" title="è¿è¡ŒæœŸå­—ç¬¦ä¸²ç•™é©»"></a>è¿è¡ŒæœŸå­—ç¬¦ä¸²ç•™é©»</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String c = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>).intern();</span><br><span class="line">String d = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>).intern();</span><br><span class="line">System.out.println(c == d);  <span class="comment">// True</span></span><br><span class="line">System.out.println(c.equals(d)); <span class="comment">// True</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>c == d</code> ç»“æœä¸º trueï¼Œ intern (è‹±æ–‡æœ‰æ‹˜ç•™ï¼Œè½¯ç¦çš„æ„æ€)çš„ä½œç”¨äº†ï¼Œé€šè¿‡è°ƒç”¨ intern()æ–¹æ³•ï¼Œå°±å¥½æ¯”æŠŠåˆ›å»ºçš„å­—ç¬¦ä¸²æ‹˜ç•™åœ¨æ–¹æ³•åŒºä¸€æ ·äº†</p>
</blockquote>
<p>åœ¨é¢è¯•æ—¶ç”šè‡³è¿˜ä¼šé—®ä½ ä¸‹é¢ä»£ç åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String d = <span class="keyword">new</span> String(<span class="string">&quot;abcd&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>å¦‚æœæ–¹æ³•åŒºé‡Œæœ‰<code>&quot;abcd&quot;</code>ï¼Œ åˆ™åªåˆ›å»ºä¸€ä¸ªnew Stringå¯¹è±¡</li>
<li>å¦‚æœæ–¹æ³•åŒºé‡Œæ²¡æœ‰<code>&quot;abcd&quot;</code>ï¼Œåˆ™åˆ›å»ºä¸¤ä¸ªå­—ç¬¦ä¸²å¯¹è±¡<ul>
<li>ä¸€ä¸ªæ˜¯æ–¹æ³•åŒºçš„<code>&quot;abcd&quot;</code></li>
<li>ä¸€ä¸ªæ˜¯å †çš„<code>new String(&quot;abcd&quot;)</code></li>
</ul>
</li>
</ol>
</blockquote>
<p>æ‰€ä»¥ï¼Œ<strong>æ­£å¸¸æƒ…å†µ</strong>ä¸‹æ²¡å¿…è¦ä½¿ç”¨æ„é€ å™¨åˆ›å»ºå¯¹è±¡ï¼Œå› ä¸ºè¿™å¾ˆå¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé¢å¤–çš„æ²¡ç”¨çš„å¯¹è±¡ã€‚</p>
<p>ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String s = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line">s = s.concat(<span class="string">&quot;ef&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn/Snipaste_2019-09-05_16-32-07.png" alt=""></p>
<p>å½“åœ¨å­—ç¬¦ä¸² s åé¢æ‹¼æ¥å­—ç¬¦ä¸²<code>&quot;ef&quot;</code>æ—¶ï¼Œä¼šåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°† s çš„å¼•ç”¨æŒ‡å‘æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œç”±äº String åˆ›å»ºçš„æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œæ‰€ä»¥ <strong>String ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¸ä¼šæ”¹å˜å®ƒè‡ªèº«ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²(å¿«æ‰“å¼€ä½ çš„ IDEï¼Œçœ‹çœ‹æ˜¯å¦æ¯ä¸ªæ“ä½œString çš„æ–¹æ³•æœ€åéƒ½æ˜¯è¿”å›æœ‰ return new String å­—æ ·)</strong>ï¼Œåˆ°è¿™é‡Œä½ åº”è¯¥ç†è§£äº†ä¸€ä¸ªé“ç†:</p>
<blockquote>
<p>å¦‚æœéœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²è¢«ä¿®æ”¹ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿ç”¨ <code>StringBuffer</code> æˆ–è€… <code>StringBuilder</code>ï¼Œå¦åˆ™ï¼Œç”±äºæ¯æ¬¡æ“ä½œå­—ç¬¦ä¸²éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œæ—§çš„å¯¹è±¡ä¸ä¼šæœ‰å¼•ç”¨æŒ‡å‘å®ƒï¼Œè¿™æ ·æˆ‘ä»¬ä¼šæµªè´¹å¾ˆå¤šåƒåœ¾å›æ”¶çš„æ—¶é—´</p>
</blockquote>
<h1 id="ä¸ºä»€ä¹ˆ-String-ç±»è¢«-final-ä¿®é¥°"><a href="#ä¸ºä»€ä¹ˆ-String-ç±»è¢«-final-ä¿®é¥°" class="headerlink" title="ä¸ºä»€ä¹ˆ String ç±»è¢« final ä¿®é¥°"></a>ä¸ºä»€ä¹ˆ String ç±»è¢« final ä¿®é¥°</h1><h2 id="å­—ç¬¦ä¸²æ± çš„éœ€æ±‚"><a href="#å­—ç¬¦ä¸²æ± çš„éœ€æ±‚" class="headerlink" title="å­—ç¬¦ä¸²æ± çš„éœ€æ±‚"></a>å­—ç¬¦ä¸²æ± çš„éœ€æ±‚</h2><p>å­—ç¬¦ä¸²æ± (String intern pool) æ˜¯<strong><em>æ–¹æ³•åŒº</em></strong>ä¸­çš„ä¸€ä¸ªç‰¹æ®Šå­˜å‚¨åŒºåŸŸã€‚å½“åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æœè¯¥å­—ç¬¦ä¸²å·²ç»å­˜åœ¨äºæ± ä¸­ï¼Œé‚£ä¹ˆè¿”å›ç°æœ‰å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚æ‰€ä»¥è¯´ï¼Œå¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆæ”¹å˜ä¸€ä¸ªå¼•ç”¨çš„å€¼ï¼Œå°†å¯¼è‡´åŸæœ¬æŒ‡å‘è¯¥å€¼çš„å¼•ç”¨è·å–åˆ°é”™è¯¯çš„å€¼ã€‚</p>
<h2 id="ç¼“å­˜-hashcode"><a href="#ç¼“å­˜-hashcode" class="headerlink" title="ç¼“å­˜ hashcode"></a>ç¼“å­˜ <code>hashcode</code></h2><p>å­—ç¬¦ä¸²çš„<code>hashcode</code>åœ¨Javaä¸­ç»å¸¸ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨<code>HashMap</code>æˆ–<code>HashSet</code>ä¸­ã€‚ä¸å¯å˜ä¿è¯<code>hashcode</code>å§‹ç»ˆæ˜¯ç›¸åŒçš„ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸æ‹…å¿ƒæ›´æ”¹çš„æƒ…å†µä¸‹å…‘ç°å®ƒã€‚è¿™æ„å‘³ç€ï¼Œä¸éœ€è¦æ¯æ¬¡ä½¿ç”¨<code>hashcode</code>æ—¶éƒ½è®¡ç®—å®ƒã€‚è¿™æ ·æ›´æœ‰æ•ˆç‡ã€‚æ‰€ä»¥ä½ ä¼šåœ¨ String ç±»ä¸­çœ‹åˆ°ä¸‹é¢çš„æˆå‘˜å˜é‡çš„å®šä¹‰:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Cache the hash code for the string */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> hash; <span class="comment">// Default to 0</span></span><br></pre></td></tr></table></figure>

<h2 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h2><p>Stringè¢«å¹¿æ³›ç”¨ä½œè®¸å¤šjavaç±»çš„å‚æ•°ï¼Œä¾‹å¦‚ç½‘ç»œè¿æ¥ã€æ‰“å¼€æ–‡ä»¶ç­‰ã€‚å¦‚æœå­—ç¬¦ä¸²ä¸æ˜¯ä¸å¯å˜çš„ï¼Œè¿æ¥æˆ–æ–‡ä»¶å°†è¢«æ›´æ”¹ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨å¨èƒã€‚è¯¥æ–¹æ³•è®¤ä¸ºå®ƒè¿æ¥åˆ°ä¸€å°æœºå™¨ä¸Šï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰ã€‚<strong>å¯å˜å­—ç¬¦ä¸²ä¹Ÿå¯èƒ½å¯¼è‡´åå°„ä¸­çš„å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå‚æ•°æ˜¯å­—ç¬¦ä¸²</strong>ã€‚</p>
<h2 id="ä¸å¯å˜å¯¹è±¡å¤©ç”Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„"><a href="#ä¸å¯å˜å¯¹è±¡å¤©ç”Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„" class="headerlink" title="ä¸å¯å˜å¯¹è±¡å¤©ç”Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„"></a>ä¸å¯å˜å¯¹è±¡å¤©ç”Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„</h2><p>ç”±äºä¸å¯å˜å¯¹è±¡ä¸èƒ½è¢«æ›´æ”¹ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´è‡ªç”±å…±äº«ã€‚è¿™æ¶ˆé™¤äº†åŒæ­¥çš„éœ€æ±‚ã€‚</p>
<p>æ€»ä¹‹ï¼Œå‡ºäºæ•ˆç‡å’Œå®‰å…¨æ€§çš„è€ƒè™‘ï¼ŒString è¢«è®¾è®¡ä¸ºä¸å¯å˜çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å¯å˜ç±»æ˜¯é¦–é€‰çš„åŸå› ã€‚</p>
<h1 id="é™„åŠ è¯´æ˜"><a href="#é™„åŠ è¯´æ˜" class="headerlink" title="é™„åŠ è¯´æ˜"></a>é™„åŠ è¯´æ˜</h1><p>å…³äºä¸å¯å˜å¯¹è±¡å’Œä¸å¯å˜å¼•ç”¨æ€»æ˜¯æä¸æ¸…æ¥š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> User user = <span class="keyword">new</span> User();</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç æŒ‡çš„æ˜¯ user å¼•ç”¨ä¸èƒ½è¢«æ›´æ”¹æŒ‡å‘å†…å­˜çš„å…¶ä»–åœ°å€ï¼Œä½†æ˜¯ç”±äº User æ˜¯å¯å˜å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ user çš„ setter æ–¹æ³•ä¿®æ”¹å…¶å±æ€§</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>String</tag>
      </tags>
  </entry>
  <entry>
    <title>Time ç›¸å…³çš„ç±»</title>
    <url>/2020/11/05/Time%20Class/</url>
    <content><![CDATA[<h2 id="Timeç›¸å…³ç±»"><a href="#Timeç›¸å…³ç±»" class="headerlink" title="Timeç›¸å…³ç±»"></a>Timeç›¸å…³ç±»</h2><p>â€‹    java.timeåŒ…ä¸­çš„æ˜¯ç±»æ˜¯<strong>ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨</strong>çš„ã€‚æ–°çš„æ—¶é—´åŠæ—¥æœŸAPIä½äºjava.timeä¸­</p>
<ul>
<li>Instantâ€”â€”å®ƒä»£è¡¨çš„æ˜¯æ—¶é—´æˆ³</li>
<li>LocalDateâ€”â€”ä¸åŒ…å«å…·ä½“æ—¶é—´çš„æ—¥æœŸï¼Œæ¯”å¦‚2014-01-14ã€‚å®ƒå¯ä»¥ç”¨æ¥å­˜å‚¨ç”Ÿæ—¥ï¼Œå‘¨å¹´çºªå¿µæ—¥ï¼Œå…¥èŒæ—¥æœŸç­‰ã€‚</li>
<li>LocalTimeâ€”â€”å®ƒä»£è¡¨çš„æ˜¯ä¸å«æ—¥æœŸçš„æ—¶é—´</li>
<li>LocalDateTimeâ€”â€”å®ƒåŒ…å«äº†æ—¥æœŸåŠæ—¶é—´ï¼Œä¸è¿‡è¿˜æ˜¯æ²¡æœ‰åç§»ä¿¡æ¯æˆ–è€…è¯´æ—¶åŒºã€‚</li>
<li>ZonedDateTimeâ€”â€”è¿™æ˜¯ä¸€ä¸ªåŒ…å«æ—¶åŒºçš„å®Œæ•´çš„æ—¥æœŸæ—¶é—´ï¼Œåç§»é‡æ˜¯ä»¥UTC/æ ¼æ—å¨æ²»æ—¶é—´ä¸ºåŸºå‡†çš„ã€‚</li>
</ul>
<h2 id="JDK8æ˜¯å¦‚ä½•å¤„ç†æ—¶é—´åŠæ—¥æœŸçš„"><a href="#JDK8æ˜¯å¦‚ä½•å¤„ç†æ—¶é—´åŠæ—¥æœŸçš„" class="headerlink" title="JDK8æ˜¯å¦‚ä½•å¤„ç†æ—¶é—´åŠæ—¥æœŸçš„"></a>JDK8æ˜¯å¦‚ä½•å¤„ç†æ—¶é—´åŠæ—¥æœŸçš„</h2><h3 id="1-å¤„ç†æ—¥æœŸ"><a href="#1-å¤„ç†æ—¥æœŸ" class="headerlink" title="1. å¤„ç†æ—¥æœŸ"></a>1. å¤„ç†æ—¥æœŸ</h3><p>â€‹    LocalDateç±»ï¼Œèƒ½ç”¨æ¥è¡¨ç¤ºä»Šå¤©çš„æ—¥æœŸã€‚è¿™ä¸ªç±»ä¸java.util.Dateç•¥æœ‰ä¸åŒï¼Œå› ä¸ºå®ƒåªåŒ…å«æ—¥æœŸï¼Œæ²¡æœ‰æ—¶é—´ã€‚</p>
<p>â€‹    MonthDayç±»ï¼Œè¿™ä¸ªç±»ç”±æœˆæ—¥ç»„åˆï¼Œä¸åŒ…å«å¹´ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥ä»£è¡¨æ¯å¹´é‡å¤å‡ºç°çš„ä¸€äº›æ—¥æœŸæˆ–å…¶ä»–ç»„åˆã€‚æ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”å®ƒè¿˜æ˜¯ä¸€ä¸ªå€¼ç±»ï¼ˆvalue classï¼‰ã€‚</p>
<p>â€‹    YearMonthç±»ï¼Œè¿™ä¸ªç±»æœ‰å¹´æœˆç»„åˆï¼Œä¸åŒ…å«æ—¥ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥æŸ¥æ‰¾è¿™ä¸ªæœˆåœ¨æŸä¸€å¹´é‡Œæœ‰å¤šå°‘å¤©ã€‚</p>
<p>â€‹    Periodç±»ï¼Œè®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ã€å‘¨ã€æœˆã€å¹´ã€‚</p>
<h4 id="1-1-è·å–å½“å¤©çš„æ—¥æœŸ"><a href="#1-1-è·å–å½“å¤©çš„æ—¥æœŸ" class="headerlink" title="1.1 è·å–å½“å¤©çš„æ—¥æœŸ"></a>1.1 è·å–å½“å¤©çš„æ—¥æœŸ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + today);</span><br><span class="line"><span class="comment">// ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15</span></span><br></pre></td></tr></table></figure>

<p>â€‹    åˆ›å»ºçš„æ—¥æœŸä¸åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œå¹¶ä¸”æ ¼å¼åŒ–äº†æ—¥æœŸã€‚</p>
<h4 id="1-2-è·å–å½“å‰çš„å¹´æœˆæ—¥"><a href="#1-2-è·å–å½“å‰çš„å¹´æœˆæ—¥" class="headerlink" title="1.2 è·å–å½“å‰çš„å¹´æœˆæ—¥"></a>1.2 è·å–å½“å‰çš„å¹´æœˆæ—¥</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line"><span class="keyword">int</span> year = today.getYear();</span><br><span class="line"><span class="keyword">int</span> month = today.getMonthValue();</span><br><span class="line"><span class="keyword">int</span> day = today.getDayOfMonth();</span><br><span class="line">System.out.println(<span class="string">&quot;å¹´ï¼š&quot;</span> + year + <span class="string">&quot;\næœˆï¼š&quot;</span> + month + <span class="string">&quot;\næ—¥ï¼š&quot;</span> + day);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¹´ï¼š2019</span></span><br><span class="line"><span class="comment"> * æœˆï¼š1</span></span><br><span class="line"><span class="comment"> * æ—¥ï¼š15</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h4 id="1-3-è·å–æŸä¸ªç‰¹å®šçš„æ—¥æœŸ"><a href="#1-3-è·å–æŸä¸ªç‰¹å®šçš„æ—¥æœŸ" class="headerlink" title="1.3 è·å–æŸä¸ªç‰¹å®šçš„æ—¥æœŸ"></a>1.3 è·å–æŸä¸ªç‰¹å®šçš„æ—¥æœŸ</h4><p>â€‹    é€šè¿‡ of æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºå‡ºä»»æ„ä¸€ä¸ªæ—¥æœŸï¼Œå®ƒæ¥å—å¹´æœˆæ—¥çš„å‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªç­‰ä»·çš„LocalDateå®ä¾‹ã€‚</p>
<p>â€‹    åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œéœ€è¦çš„æ—¥æœŸä½ å¡«å†™ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆï¼Œä¸åƒä¹‹å‰çš„APIä¸­æœˆä»½å¿…é¡»ä»0å¼€å§‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.of(<span class="number">2018</span>,<span class="number">12</span>,<span class="number">15</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + today);</span><br><span class="line"><span class="comment">// ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ï¼š2018-12-15</span></span><br></pre></td></tr></table></figure>

<h4 id="1-4-æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸ç­‰"><a href="#1-4-æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸ç­‰" class="headerlink" title="1.4 æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸ç­‰"></a>1.4 æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸ç­‰</h4><p>â€‹    LocalDateé‡å†™äº†equalsæ–¹æ³•æ¥è¿›è¡Œæ—¥æœŸçš„æ¯”è¾ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.of(<span class="number">2019</span>,<span class="number">1</span>,<span class="number">15</span>);</span><br><span class="line">LocalDate now = LocalDate.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ä»Šå¤©çš„æ—¥æœŸæ˜¯2019-1-15å—ï¼š&quot;</span> + today.equals(now));</span><br><span class="line"><span class="comment">// ä»Šå¤©çš„æ—¥æœŸæ˜¯2019-1-15å—ï¼štrue</span></span><br></pre></td></tr></table></figure>

<h4 id="1-5-å¦‚ä½•æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚ç”Ÿæ—¥"><a href="#1-5-å¦‚ä½•æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚ç”Ÿæ—¥" class="headerlink" title="1.5 å¦‚ä½•æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚ç”Ÿæ—¥"></a>1.5 å¦‚ä½•æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚ç”Ÿæ—¥</h4><p>åœ¨javaä¸­è¿˜æœ‰ä¸€ä¸ªä¸æ—¶é—´æ—¥æœŸç›¸å…³çš„ä»»åŠ¡å°±æ˜¯æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚æ¯æœˆçš„è´¦å•æ—¥</p>
<p>ä½¿ç”¨MonthDayç±»åˆ¤æ–­æ˜¯å¦æ˜¯æŸä¸ªèŠ‚æ—¥æˆ–è€…é‡å¤äº‹ä»¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate dateOfBirth = LocalDate.of(<span class="number">1997</span>,<span class="number">4</span>,<span class="number">13</span>);</span><br><span class="line">LocalDate now = LocalDate.now();</span><br><span class="line">MonthDay birthDay = MonthDay.of(dateOfBirth.getMonth(), dateOfBirth.getDayOfMonth());</span><br><span class="line">MonthDay currentMonthDay = MonthDay.from(now);</span><br><span class="line"><span class="keyword">if</span> (currentMonthDay.equals(birthDay))&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»Šå¤©æ˜¯ä½ çš„ç”Ÿæ—¥&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;å¯¹ä¸èµ·ï¼Œä»Šå¤©ä¸æ˜¯ä½ çš„ç”Ÿæ—¥&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¯¹ä¸èµ·ï¼Œä»Šå¤©ä¸æ˜¯ä½ çš„ç”Ÿæ—¥</span></span><br></pre></td></tr></table></figure>

<p>â€‹    MonthDayåªå­˜å‚¨äº†æœˆæ—¥ï¼Œå¯¹æ¯”ä¸¤ä¸ªæ—¥æœŸçš„æœˆæ—¥å³å¯çŸ¥é“æ˜¯å¦é‡å¤</p>
<h4 id="1-6-è·å–1å‘¨åçš„æ—¥æœŸ"><a href="#1-6-è·å–1å‘¨åçš„æ—¥æœŸ" class="headerlink" title="1.6 è·å–1å‘¨åçš„æ—¥æœŸ"></a>1.6 è·å–1å‘¨åçš„æ—¥æœŸ</h4><p>â€‹    è¿™ä¸ªä¸ä½¿ç”¨LocalTimeè·å–2å°æ—¶åçš„æ—¶é—´çš„ä¾‹å­å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬è·å–çš„æ˜¯1å‘¨åçš„æ—¥æœŸã€‚</p>
<p>â€‹    LocalDateæ˜¯ç”¨æ¥è¡¨ç¤ºæ— æ—¶é—´çš„æ—¥æœŸï¼Œä»–æœ‰ä¸€ä¸ªplus()æ–¹æ³•å¯ä»¥ç”¨æ¥å¢åŠ æ—¥ï¼Œæ˜ŸæœŸï¼Œæœˆã€‚</p>
<p>â€‹    ChronoUnitåˆ™ç”¨æ¥è¡¨ç¤ºæ—¶é—´å•ä½ï¼ŒLocalDateä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤ä»»ä½•ä¿®æ”¹æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + today);</span><br><span class="line">LocalDate oneToDay = today.plus(<span class="number">1</span>, ChronoUnit.WEEKS);</span><br><span class="line">System.out.println(<span class="string">&quot;ä¸€å‘¨åçš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + oneToDay);</span><br><span class="line"><span class="comment">//ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15</span></span><br><span class="line"><span class="comment">//ä¸€å‘¨åçš„æ—¥æœŸæ˜¯ï¼š2019-01-22</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥å¢åŠ ä¸€ä¸ªæœˆï¼Œä¸€å¹´ï¼Œä¸€å°æ—¶ï¼Œä¸€åˆ†ç­‰ç­‰</p>
</blockquote>
<h4 id="1-7-ä¸€å¹´å‰çš„æ—¥æœŸ"><a href="#1-7-ä¸€å¹´å‰çš„æ—¥æœŸ" class="headerlink" title="1.7 ä¸€å¹´å‰çš„æ—¥æœŸ"></a>1.7 ä¸€å¹´å‰çš„æ—¥æœŸ</h4><p>â€‹    ä½¿ç”¨LocalDateçš„plus()æ–¹æ³•æ¥ç»™æ—¥æœŸå¢åŠ æ—¥å‘¨æœˆï¼Œ</p>
<p>â€‹    ç°åœ¨æˆ‘ä»¬ç”¨minus()æ–¹æ³•æ¥ç»™æ—¥æœŸå‡å°‘æ—¥å‘¨æœˆï¼Œå¾€å‰æ‰¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + today);</span><br><span class="line">LocalDate previousYear = today.minus(<span class="number">1</span>, ChronoUnit.YEARS);</span><br><span class="line">System.out.println(<span class="string">&quot;ä¸€å¹´å‰çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + previousYear);</span><br><span class="line"><span class="comment">//ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15</span></span><br><span class="line"><span class="comment">//ä¸€å¹´å‰çš„æ—¥æœŸæ˜¯ï¼š2018-01-15</span></span><br></pre></td></tr></table></figure>

<h4 id="1-8-å¦‚ä½•åˆ¤æ–­æŸä¸ªæ—¥æœŸåœ¨å¦ä¸€ä¸ªæ—¥æœŸçš„å‰é¢è¿˜æ˜¯åé¢"><a href="#1-8-å¦‚ä½•åˆ¤æ–­æŸä¸ªæ—¥æœŸåœ¨å¦ä¸€ä¸ªæ—¥æœŸçš„å‰é¢è¿˜æ˜¯åé¢" class="headerlink" title="1.8 å¦‚ä½•åˆ¤æ–­æŸä¸ªæ—¥æœŸåœ¨å¦ä¸€ä¸ªæ—¥æœŸçš„å‰é¢è¿˜æ˜¯åé¢"></a>1.8 å¦‚ä½•åˆ¤æ–­æŸä¸ªæ—¥æœŸåœ¨å¦ä¸€ä¸ªæ—¥æœŸçš„å‰é¢è¿˜æ˜¯åé¢</h4><p>â€‹     LocalDateç±»ä¸­ä½¿ç”¨isBefore()ã€isAfter()ã€equals()æ–¹æ³•æ¥æ¯”è¾ƒä¸¤ä¸ªæ—¥æœŸã€‚</p>
<p>â€‹    å¦‚æœè°ƒç”¨æ–¹æ³•çš„é‚£ä¸ªæ—¥æœŸæ¯”ç»™å®šçš„æ—¥æœŸè¦æ—©çš„è¯ï¼ŒisBefore()æ–¹æ³•ä¼šè¿”å›trueã€‚</p>
<p>â€‹    å¦‚æœè°ƒç”¨æ–¹æ³•çš„é‚£ä¸ªæ—¥æœŸæ¯”ç»™å®šçš„æ—¥æœŸè¦æ™šçš„è¯ï¼ŒisAfter()æ–¹æ³•ä¼šè¿”å›trueã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + today);</span><br><span class="line">LocalDate tomorrow = today.plus(<span class="number">1</span>, ChronoUnit.DAYS);</span><br><span class="line">System.out.println(<span class="string">&quot;æ˜å¤©çš„æ—¥æœŸæ˜¯ï¼š&quot;</span> + tomorrow);</span><br><span class="line">System.out.println(<span class="string">&quot;æ—¥æœŸï¼š&quot;</span> + tomorrow + <span class="string">&quot;æ˜¯å¦åœ¨æ—¥æœŸï¼š&quot;</span> + today + <span class="string">&quot;ä¹‹åï¼š&quot;</span> + tomorrow.isAfter(today));</span><br><span class="line">System.out.println(<span class="string">&quot;æ—¥æœŸï¼š&quot;</span> + tomorrow + <span class="string">&quot;æ˜¯å¦åœ¨æ—¥æœŸï¼š&quot;</span> + today + <span class="string">&quot;ä¹‹å‰ï¼š&quot;</span> + tomorrow.isBefore(today));</span><br><span class="line"><span class="comment">//ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15</span></span><br><span class="line"><span class="comment">//æ˜å¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-16</span></span><br><span class="line"><span class="comment">//æ—¥æœŸï¼š2019-01-16æ˜¯å¦åœ¨æ—¥æœŸï¼š2019-01-15ä¹‹åï¼štrue</span></span><br><span class="line"><span class="comment">//æ—¥æœŸï¼š2019-01-16æ˜¯å¦åœ¨æ—¥æœŸï¼š2019-01-15ä¹‹å‰ï¼šfalse</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>java8ä¸­æ¯”è¾ƒæ—¥æœŸéå¸¸ç®€å•ï¼Œä¸å†éœ€è¦ä½¿ç”¨Calendarè¿™æ ·å¦å¤–çš„ç±»æ¥å®Œæˆç±»ä¼¼çš„ä»»åŠ¡äº†</p>
</blockquote>
<h4 id="1-9-å¦‚ä½•è¡¨ç¤ºå›ºå®šçš„æ—¥æœŸï¼Œæ¯”å¦‚ä¿¡ç”¨å¡è¿‡æœŸæ—¶é—´"><a href="#1-9-å¦‚ä½•è¡¨ç¤ºå›ºå®šçš„æ—¥æœŸï¼Œæ¯”å¦‚ä¿¡ç”¨å¡è¿‡æœŸæ—¶é—´" class="headerlink" title="1.9 å¦‚ä½•è¡¨ç¤ºå›ºå®šçš„æ—¥æœŸï¼Œæ¯”å¦‚ä¿¡ç”¨å¡è¿‡æœŸæ—¶é—´"></a>1.9 å¦‚ä½•è¡¨ç¤ºå›ºå®šçš„æ—¥æœŸï¼Œæ¯”å¦‚ä¿¡ç”¨å¡è¿‡æœŸæ—¶é—´</h4><p>æ­£å¦‚MonthDayè¡¨ç¤ºçš„æ˜¯æŸä¸ªé‡å¤å‡ºç°çš„æ—¥å­ï¼ŒYearMonthæ˜¯å¦å¤–ä¸€ä¸ªç»„åˆï¼Œä»£è¡¨çš„æ˜¯åƒä¿¡ç”¨å¡è¿˜æ¬¾æ—¥ï¼Œå®šæœŸå­˜æ¬¾åˆ°æœŸæ—¥ï¼Œoptionsåˆ°æœŸæ—¥è¿™ç±»çš„æ—¥æœŸã€‚ä½ å¯ä»¥ç”¨è¿™ä¸ªç±»æ‰¾å‡ºè¿™ä¸ªæœˆæœ‰å¤šå°‘å¤©ï¼ŒLengthOfMonth()è¿™ä¸ªæ–¹æ³•è¿”å›çš„æ˜¯è¿™ä¸ªYearMonthå®ä¾‹æœ‰å¤šå°‘å¤©ï¼Œè¿™å¯¹äºæ£€æŸ¥2æœˆæ˜¯å¦æ¶¦2æœˆå¾ˆæœ‰ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">YearMonth currentYearMonth = YearMonth.now();</span><br><span class="line">System.out.printf(<span class="string">&quot;ä»Šå¹´è¿™ä¸ªæœˆ %s: æœ‰ %d å¤©%n&quot;</span>, currentYearMonth, currentYearMonth.lengthOfMonth());</span><br><span class="line">YearMonth creditCardExpiry = YearMonth.of(<span class="number">2018</span>, Month.FEBRUARY);</span><br><span class="line">System.out.printf(<span class="string">&quot;ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ %s %n&quot;</span>, creditCardExpiry);</span><br><span class="line"><span class="comment">//ä»Šå¹´è¿™ä¸ªæœˆ 2019-01: æœ‰ 31 å¤©</span></span><br><span class="line"><span class="comment">//ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ 2018-02 </span></span><br></pre></td></tr></table></figure>

<h4 id="1-10-å¦‚ä½•åœ¨java8ä¸­æ£€æŸ¥é—°å¹´"><a href="#1-10-å¦‚ä½•åœ¨java8ä¸­æ£€æŸ¥é—°å¹´" class="headerlink" title="1.10 å¦‚ä½•åœ¨java8ä¸­æ£€æŸ¥é—°å¹´"></a>1.10 å¦‚ä½•åœ¨java8ä¸­æ£€æŸ¥é—°å¹´</h4><p>â€‹    LocalDateç±»ç”±ä¸€ä¸ªisLeapYear()æ–¹æ³•æ¥è¿”å›å½“å‰LocalDateå¯¹åº”çš„é‚£å¹´æ˜¯å¦æ˜¯é—°å¹´</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate now = LocalDate.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ä»Šå¤©æ˜¯ä¸æ˜¯é—°å¹´ï¼š&quot;</span> + now.isLeapYear());</span><br><span class="line"><span class="comment">//ä»Šå¤©æ˜¯ä¸æ˜¯é—°å¹´ï¼šfalse</span></span><br></pre></td></tr></table></figure>

<h4 id="1-11-ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ï¼Œå¤šå°‘æœˆ"><a href="#1-11-ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ï¼Œå¤šå°‘æœˆ" class="headerlink" title="1.11 ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ï¼Œå¤šå°‘æœˆ"></a>1.11 ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ï¼Œå¤šå°‘æœˆ</h4><p>è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ã€å‘¨ã€æœˆã€å¹´ã€‚</p>
<p>å¯ä»¥ç”¨java.time.Periodç±»å®Œæˆè¯¥åŠŸèƒ½ã€‚</p>
<p>ä¸‹é¢ä¾‹å­ä¸­å°†è®¡ç®—æ—¥æœŸä¸å°†æ¥çš„æ—¥æœŸä¹‹é—´ä¸€å…±æœ‰å‡ ä¸ªæœˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate today = LocalDate.now();</span><br><span class="line">LocalDate date = LocalDate.of(<span class="number">2018</span>, Month.MARCH, <span class="number">14</span>);</span><br><span class="line">Period periodToNextJavaRelease = Period.between(today, date);</span><br><span class="line">System.out.printf(<span class="string">&quot;æ—¥æœŸ%så’Œæ—¥æœŸ%sç›¸å·®%sæœˆ &quot;</span>, today, date, periodToNextJavaRelease.getMonths());</span><br><span class="line"><span class="comment">//æ—¥æœŸ2019-01-15å’Œæ—¥æœŸ2018-03-14ç›¸å·®-10æœˆ </span></span><br></pre></td></tr></table></figure>



<h3 id="2-å¤„ç†æ—¶é—´"><a href="#2-å¤„ç†æ—¶é—´" class="headerlink" title="2. å¤„ç†æ—¶é—´"></a>2. å¤„ç†æ—¶é—´</h3><p>â€‹    LocalTimeç±»ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯hh:mm:ss:nnnï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ä¸åŒ…å«æ—¥æœŸçš„</p>
<h4 id="2-1-è·å–å½“å‰æ—¶é—´"><a href="#2-1-è·å–å½“å‰æ—¶é—´" class="headerlink" title="2.1 è·å–å½“å‰æ—¶é—´"></a>2.1 è·å–å½“å‰æ—¶é—´</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalTime localTime = LocalTime.now();</span><br><span class="line">System.out.println(localTime);</span><br><span class="line"><span class="comment">// 15:18:30.974</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-å¢åŠ æ—¶é—´é‡Œé¢çš„å°æ—¶æ•°"><a href="#2-2-å¢åŠ æ—¶é—´é‡Œé¢çš„å°æ—¶æ•°" class="headerlink" title="2.2 å¢åŠ æ—¶é—´é‡Œé¢çš„å°æ—¶æ•°"></a>2.2 å¢åŠ æ—¶é—´é‡Œé¢çš„å°æ—¶æ•°</h4><p>â€‹    å¾ˆå¤šæ—¶å€™éœ€è¦å¯¹æ—¶é—´è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚åŠ ä¸€ä¸ªå°æ—¶æ¥è®¡ç®—ä¹‹åçš„æ—¶é—´ï¼Œjava8æä¾›äº†æ›´æ–¹ä¾¿çš„æ–¹æ³• å¦‚plusHoursï¼Œè¿™äº›æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„LocalTimeå®ä¾‹çš„å¼•ç”¨ï¼Œå› ä¸ºLocalTimeæ˜¯ä¸å¯å˜çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalTime localTime = LocalTime.now();</span><br><span class="line">System.out.println(<span class="string">&quot;ç°åœ¨çš„æ—¶é—´æ˜¯ï¼š&quot;</span> + localTime);</span><br><span class="line">LocalTime two = localTime.plusHours(<span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;ä¸¤ä¸ªå°æ—¶åçš„æ—¶é—´æ˜¯ï¼š&quot;</span> + two);</span><br><span class="line">System.out.println(<span class="string">&quot;è¿™æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼š&quot;</span> + localTime.equals(two));</span><br><span class="line"><span class="comment">//ç°åœ¨çš„æ—¶é—´æ˜¯ï¼š15:21:42.518</span></span><br><span class="line"><span class="comment">//ä¸¤ä¸ªå°æ—¶åçš„æ—¶é—´æ˜¯ï¼š17:21:42.518</span></span><br><span class="line"><span class="comment">//è¿™æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼šfalse</span></span><br></pre></td></tr></table></figure>



<h3 id="3-å¤„ç†æ—¶åŒº"><a href="#3-å¤„ç†æ—¶åŒº" class="headerlink" title="3. å¤„ç†æ—¶åŒº"></a>3. å¤„ç†æ—¶åŒº</h3><p>â€‹    java8ä¸­ä¸ä»…å°†æ—¥æœŸå’Œæ—¶é—´è¿›è¡Œäº†åˆ†ç¦»ï¼ŒåŒæ—¶è¿˜æœ‰æ—¶åŒºã€‚æ¯”å¦‚ZonIdä»£è¡¨çš„æ˜¯æŸä¸ªç‰¹å®šæ—¶åŒºï¼ŒZonedDateTimeä»£è¡¨å¸¦æ—¶åŒºçš„æ—¶é—´ï¼Œç­‰åŒäºä»¥å‰çš„GregorianCalendarç±»ã€‚ä½¿ç”¨è¯¥ç±»ï¼Œå¯ä»¥å°†æœ¬åœ°æ—¶é—´è½¬æ¢æˆå¦ä¸€ä¸ªæ—¶åŒºä¸­çš„å¯¹åº”æ—¶é—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDateTime localDateTime = LocalDateTime.now();</span><br><span class="line">ZoneId darWin = ZoneId.of(ZoneId.SHORT_IDS.get(<span class="string">&quot;ACT&quot;</span>));</span><br><span class="line">ZonedDateTime dateTimeInDarwin = ZonedDateTime.of(localDateTime, darWin);</span><br><span class="line">System.out.println(<span class="string">&quot;ç°åœ¨æ—¶åŒºçš„æ—¶é—´å’Œç‰¹å®šæ—¶åŒºçš„æ—¶é—´ï¼š&quot;</span> + dateTimeInDarwin);</span><br><span class="line"><span class="comment">//ç°åœ¨æ—¶åŒºçš„æ—¶é—´å’Œç‰¹å®šæ—¶åŒºçš„æ—¶é—´ï¼š2019-01-15T15:58:31.859+09:30[Australia/Darwin]</span></span><br></pre></td></tr></table></figure>



<h3 id="4-è·å–æ—¶é—´æˆ³"><a href="#4-è·å–æ—¶é—´æˆ³" class="headerlink" title="4. è·å–æ—¶é—´æˆ³"></a>4. è·å–æ—¶é—´æˆ³</h3><p>Instantç±»ç”±ä¸€ä¸ªé™æ€çš„å·¥å‚æ–¹æ³•now()å¯ä»¥è¿”å›å½“å‰æ—¶é—´æˆ³</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Instant timestamp = Instant.now();</span><br><span class="line">System.out.println(<span class="string">&quot;å½“å‰çš„æ—¶é—´æˆ³æ˜¯ï¼š&quot;</span> + timestamp);</span><br><span class="line"><span class="comment">//å½“å‰çš„æ—¶é—´æˆ³æ˜¯ï¼š2019-01-15T08:27:59.561Z</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å½“å‰æ—¶é—´æˆ³æ˜¯åŒ…å«æ—¥æœŸå’Œæ—¶é—´çš„ï¼Œä¸java.util.Dateå¾ˆç±»ä¼¼ï¼Œäº‹å®ä¸ŠInstantå°±æ˜¯java8ä»¥å‰çš„Dateï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªä¸¤ä¸ªç±»ä¸­çš„æ–¹æ³•åœ¨è¿™ä¸¤ä¸ªç±»å‹ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œæ¯”å¦‚Date.from(Instant)å°±æ˜¯ç”¨æ¥æŠŠInstantè½¬æ¢æˆjava.util.dateçš„ï¼Œè€ŒDateã€‚toInstant()å°±æ˜¯å°†Dateè½¬æ¢æˆInstantçš„</p>
</blockquote>
<h3 id="5-å…¨æ–°çš„æ—¥æœŸæ—¶é—´æ ¼å¼å™¨DateTimeFormatter"><a href="#5-å…¨æ–°çš„æ—¥æœŸæ—¶é—´æ ¼å¼å™¨DateTimeFormatter" class="headerlink" title="5.å…¨æ–°çš„æ—¥æœŸæ—¶é—´æ ¼å¼å™¨DateTimeFormatter"></a>5.å…¨æ–°çš„æ—¥æœŸæ—¶é—´æ ¼å¼å™¨DateTimeFormatter</h3><p>â€‹    åœ¨java8ä¹‹å‰ï¼Œæ—¶é—´æ—¥æœŸçš„æ ¼å¼åŒ–éå¸¸éº»çƒ¦ï¼Œç»å¸¸ä½¿ç”¨SimpleDateFormatæ¥è¿›è¡Œæ ¼å¼åŒ–ï¼Œä½†æ˜¯SimpleDateFormatå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>â€‹    åœ¨java8ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªå…¨æ–°çš„<strong>çº¿ç¨‹å®‰å…¨çš„æ—¥æœŸä¸æ—¶é—´æ ¼å¼å™¨==DateTimeFormatter==</strong>ã€‚å¹¶ä¸”é¢„å®šä¹‰å¥½äº†æ ¼å¼ã€‚</p>
<h4 id="5-1-é¢„ç½®çš„æ ¼å¼å™¨æ¥æ ¼å¼åŒ–æ—¥æœŸ"><a href="#5-1-é¢„ç½®çš„æ ¼å¼å™¨æ¥æ ¼å¼åŒ–æ—¥æœŸ" class="headerlink" title="5.1 é¢„ç½®çš„æ ¼å¼å™¨æ¥æ ¼å¼åŒ–æ—¥æœŸ"></a>5.1 é¢„ç½®çš„æ ¼å¼å™¨æ¥æ ¼å¼åŒ–æ—¥æœŸ</h4><p>â€‹    æœ¬ä¾‹ä¸­ä½¿ç”¨çš„BASICISODATEæ ¼å¼ä¼šå°†20160414æ ¼å¼åŒ–æˆ2016-04-14</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String dayAfterTomorrow = <span class="string">&quot;20180116&quot;</span>;</span><br><span class="line">LocalDate formatted = LocalDate.parse(dayAfterTomorrow, DateTimeFormatter.BASIC_ISO_DATE);</span><br><span class="line">System.out.printf(<span class="string">&quot;å­—ç¬¦ %s æ ¼å¼åŒ–åçš„æ—¥æœŸæ ¼å¼æ˜¯ %s %n&quot;</span>,dayAfterTomorrow,formatted);</span><br><span class="line"><span class="comment">//å­—ç¬¦ 20180116 æ ¼å¼åŒ–åçš„æ—¥æœŸæ ¼å¼æ˜¯ 2018-01-16 </span></span><br></pre></td></tr></table></figure>



<h4 id="5-2-è‡ªå®šä¹‰æ ¼å¼å™¨æ¥è§£ææ—¥æœŸ"><a href="#5-2-è‡ªå®šä¹‰æ ¼å¼å™¨æ¥è§£ææ—¥æœŸ" class="headerlink" title="5.2 è‡ªå®šä¹‰æ ¼å¼å™¨æ¥è§£ææ—¥æœŸ"></a>5.2 è‡ªå®šä¹‰æ ¼å¼å™¨æ¥è§£ææ—¥æœŸ</h4><p>â€‹    æˆ‘ä»¬ä½¿ç”¨äº†é¢„ç½®çš„æ—¶é—´æ—¥æœŸæ ¼å¼å™¨æ¥è§£ææ—¥æœŸå­—ç¬¦ä¸²äº†ï¼Œä½†æ˜¯æœ‰æ—¶é¢„ç½®çš„ä¸èƒ½æ»¡è¶³çš„æ—¶å€™å°±éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼å™¨äº†ï¼Œä¸‹é¢çš„ä¾‹å­ä¸­çš„æ—¥æœŸæ ¼å¼æ˜¯â€MM dd yyyyâ€.ä½ å¯ä»¥ç»™DateTimeFormatterçš„ofPatterné™æ€æ–¹æ³•()ä¼ å…¥ä»»ä½•çš„æ¨¡å¼ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªæ¨¡å¼çš„å­—é¢é‡ä¸å‰ä¾‹ä¸­æ˜¯ç›¸åŒçš„ã€‚æ¯”å¦‚Mä»£è¡¨æœˆï¼Œmä»ä»£è¡¨åˆ†ï¼Œæ— æ•ˆçš„æ¨¡å¼ä¼šæŠ›å¼‚å¸¸DateTimeParseExceptionã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String day = <span class="string">&quot;01 15 2019&quot;</span>;</span><br><span class="line">DateTimeFormatter formatter = DateTimeFormatter.ofPattern(<span class="string">&quot;MM dd yyyy&quot;</span>);</span><br><span class="line">LocalDate holiday = LocalDate.parse(day, formatter);</span><br><span class="line">System.out.printf(<span class="string">&quot;å­—ç¬¦ %s è½¬æ¢æˆåŠŸåçš„æ—¥æœŸæ˜¯ %s%n&quot;</span>, day, holiday);</span><br><span class="line"><span class="comment">//å­—ç¬¦ 01 15 2019 è½¬æ¢æˆåŠŸåçš„æ—¥æœŸæ˜¯ 2019-01-15</span></span><br></pre></td></tr></table></figure>



<p>20ã€å¯¹æ—¥æœŸè¿›è¡Œæ ¼å¼åŒ–ï¼Œè½¬æ¢æˆå­—ç¬¦ä¸²</p>
<p>â€‹    æˆ‘ä»¬ä¸»è¦æ˜¯å¯¹æ—¥æœŸå­—ç¬¦ä¸²æ¥è¿›è¡Œè§£æè½¬æ¢æˆæ—¥æœŸï¼Œåœ¨è¿™ä¸ªä¾‹å­æˆ‘ä»¬ç›¸åï¼Œæ˜¯æŠŠæ—¥æœŸè½¬æ¢æˆå­—ç¬¦ã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸ªLocalDateTimeç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬è¦æŠŠä»–è½¬æ¢æˆä¸€ä¸ªæ ¼å¼åŒ–å¥½çš„æ—¥æœŸä¸²ï¼Œä¸å‰ä¾‹ç›¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä»éœ€è¦åˆ¶å®šæ¨¡å¼ä¸²å»åˆ›å»ºä¸€ä¸ªDateTimeFormatterç±»çš„å®ä¾‹ï¼Œä½†è°ƒç”¨çš„æ˜¯LocalDate.format()ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªä»£è¡¨å½“å‰æ—¥æœŸçš„å­—ç¬¦ä¸²ï¼Œå¯¹åº”çš„æ¨¡å¼å°±æ˜¯ä¼ å…¥çš„DateTimeFormatterå®ä¾‹ä¸­å®šä¹‰å¥½çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDateTime arrivalDate = LocalDateTime.now();</span><br><span class="line">DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(<span class="string">&quot;MM dd yyyy HH:mm a&quot;</span>);</span><br><span class="line">String format = arrivalDate.format(dateTimeFormatter);</span><br><span class="line">System.out.println(<span class="string">&quot;è½¬æ¢åçš„æ—¥æœŸ:&quot;</span> + format);</span><br><span class="line"><span class="comment">//è½¬æ¢åçš„æ—¥æœŸ:01 15 2019 17:30 PM</span></span><br></pre></td></tr></table></figure>



<h2 id="java8ä¸­æ—¥æœŸä¸æ—¶é—´APIçš„å‡ ä¸ªå…³é”®ç‚¹"><a href="#java8ä¸­æ—¥æœŸä¸æ—¶é—´APIçš„å‡ ä¸ªå…³é”®ç‚¹" class="headerlink" title="java8ä¸­æ—¥æœŸä¸æ—¶é—´APIçš„å‡ ä¸ªå…³é”®ç‚¹"></a>java8ä¸­æ—¥æœŸä¸æ—¶é—´APIçš„å‡ ä¸ªå…³é”®ç‚¹</h2><p>å›é¡¾ä¸€ä¸‹</p>
<p>â—å®ƒæä¾›äº†javax.time.ZoneIdç”¨æ¥å¤„ç†æ—¶åŒºã€‚</p>
<p>â—å®ƒæä¾›äº†LocalDateä¸LocalTimeç±»</p>
<p>â—Java 8ä¸­æ–°çš„æ—¶é—´ä¸æ—¥æœŸAPIä¸­çš„æ‰€æœ‰ç±»éƒ½æ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™ä¸ä¹‹å‰çš„Dateä¸Calendar APIä¸­çš„æ°å¥½ç›¸åï¼Œé‚£é‡Œé¢åƒjava.util.Dateä»¥åŠSimpleDateFormatè¿™äº›å…³é”®çš„ç±»éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>â—æ–°çš„æ—¶é—´ä¸æ—¥æœŸAPIä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯å®ƒå®šä¹‰æ¸…æ¥šäº†åŸºæœ¬çš„æ—¶é—´ä¸æ—¥æœŸçš„æ¦‚å¿µï¼Œæ¯”æ–¹è¯´ï¼Œç¬æ—¶æ—¶é—´ï¼ŒæŒç»­æ—¶é—´ï¼Œæ—¥æœŸï¼Œæ—¶é—´ï¼Œæ—¶åŒºä»¥åŠæ—¶é—´æ®µã€‚å®ƒä»¬éƒ½æ˜¯åŸºäºISOæ—¥å†ä½“ç³»çš„ã€‚</p>
<p><strong>æ¯ä¸ªJavaå¼€å‘äººå‘˜éƒ½åº”è¯¥è‡³å°‘äº†è§£è¿™å¥—æ–°çš„APIä¸­çš„è¿™äº”ä¸ªç±»ï¼š</strong></p>
<p>â—Instant å®ƒä»£è¡¨çš„æ˜¯æ—¶é—´æˆ³ï¼Œæ¯”å¦‚2016-04-14T14:20:13.592Zï¼Œè¿™å¯ä»¥ä»java.time.Clockç±»ä¸­è·å–ï¼Œåƒè¿™æ ·ï¼š Instant current = Clock.system(ZoneId.of(â€œAsia/Tokyoâ€)).instant();</p>
<p>â—LocalDate å®ƒè¡¨ç¤ºçš„æ˜¯ä¸å¸¦æ—¶é—´çš„æ—¥æœŸï¼Œæ¯”å¦‚2016-04-14ã€‚å®ƒå¯ä»¥ç”¨æ¥å­˜å‚¨ç”Ÿæ—¥ï¼Œå‘¨å¹´çºªå¿µæ—¥ï¼Œå…¥èŒæ—¥æœŸç­‰ã€‚</p>
<p>â—LocalTime - å®ƒè¡¨ç¤ºçš„æ˜¯ä¸å¸¦æ—¥æœŸçš„æ—¶é—´</p>
<p>â—LocalDateTime - å®ƒåŒ…å«äº†æ—¶é—´ä¸æ—¥æœŸï¼Œä¸è¿‡æ²¡æœ‰å¸¦æ—¶åŒºçš„åç§»é‡</p>
<p>â—ZonedDateTime - è¿™æ˜¯ä¸€ä¸ªå¸¦æ—¶åŒºçš„å®Œæ•´æ—¶é—´ï¼Œå®ƒæ ¹æ®UTC/æ ¼æ—å¨æ²»æ—¶é—´æ¥è¿›è¡Œæ—¶åŒºè°ƒæ•´</p>
<p>â—è¿™ä¸ªåº“çš„ä¸»åŒ…æ˜¯java.timeï¼Œé‡Œé¢åŒ…å«äº†ä»£è¡¨æ—¥æœŸï¼Œæ—¶é—´ï¼Œç¬æ—¶ä»¥åŠæŒç»­æ—¶é—´çš„ç±»ã€‚å®ƒæœ‰ä¸¤ä¸ªå­packageï¼Œä¸€ä¸ªæ˜¯java.time.foramtï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆç”¨é€”å°±å¾ˆæ˜æ˜¾äº†ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯java.time.temporalï¼Œå®ƒèƒ½ä»æ›´ä½å±‚é¢å¯¹å„ä¸ªå­—æ®µè¿›è¡Œè®¿é—®ã€‚</p>
<p>â—æ—¶åŒºæŒ‡çš„æ˜¯åœ°çƒä¸Šå…±äº«åŒä¸€æ ‡å‡†æ—¶é—´çš„åœ°åŒºã€‚æ¯ä¸ªæ—¶åŒºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªåœ°åŒº/åŸå¸‚(Asia/Tokyo)çš„æ ¼å¼ä»¥åŠä»æ ¼æ—å¨æ²»æ—¶é—´å¼€å§‹çš„ä¸€ä¸ªåç§»æ—¶é—´ã€‚æ¯”å¦‚è¯´ï¼Œä¸œäº¬çš„åç§»æ—¶é—´å°±æ˜¯+09:00ã€‚</p>
<p>â—OffsetDateTimeç±»å®é™…ä¸ŠåŒ…å«äº†LocalDateTimeä¸ZoneOffsetã€‚å®ƒç”¨æ¥è¡¨ç¤ºä¸€ä¸ªåŒ…å«æ ¼æ—å¨æ²»æ—¶é—´åç§»é‡ï¼ˆ+/-å°æ—¶ï¼šåˆ†ï¼Œæ¯”å¦‚+06:00æˆ–è€… -08ï¼š00ï¼‰çš„å®Œæ•´çš„æ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰åŠæ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼Œçº³ç§’ï¼‰ã€‚</p>
<p>â—DateTimeFormatterç±»ç”¨äºåœ¨Javaä¸­è¿›è¡Œæ—¥æœŸçš„æ ¼å¼åŒ–ä¸è§£æã€‚ä¸SimpleDateFormatä¸åŒï¼Œå®ƒæ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œå¯ä»¥èµ‹å€¼ç»™ä¸€ä¸ªé™æ€å˜é‡ã€‚DateTimeFormatterç±»æä¾›äº†è®¸å¤šé¢„å®šä¹‰çš„æ ¼å¼å™¨ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±æƒ³è¦çš„æ ¼å¼ã€‚å½“ç„¶äº†ï¼Œæ ¹æ®çº¦å®šï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªparse()æ–¹æ³•æ˜¯ç”¨äºå°†å­—ç¬¦ä¸²è½¬æ¢æˆæ—¥æœŸçš„ï¼Œå¦‚æœè½¬æ¢æœŸé—´å‡ºç°ä»»ä½•é”™è¯¯ï¼Œå®ƒä¼šæŠ›å‡ºDateTimeParseExceptionå¼‚å¸¸ã€‚ç±»ä¼¼çš„ï¼ŒDateFormatterç±»ä¹Ÿæœ‰ä¸€ä¸ªç”¨äºæ ¼å¼åŒ–æ—¥æœŸçš„format()æ–¹æ³•ï¼Œå®ƒå‡ºé”™çš„è¯åˆ™ä¼šæŠ›å‡ºDateTimeExceptionå¼‚å¸¸ã€‚</p>
<p>â—å†è¯´ä¸€å¥ï¼Œâ€œMMM d yyyyâ€ä¸â€œMMm dd yyyyâ€è¿™ä¸¤ä¸ªæ—¥æœŸæ ¼å¼ä¹Ÿç•¥æœ‰ä¸åŒï¼Œå‰è€…èƒ½è¯†åˆ«å‡ºâ€Jan 2 2014â€ä¸â€Jan 14 2014â€è¿™ä¸¤ä¸ªä¸²ï¼Œè€Œåè€…å¦‚æœä¼ è¿›æ¥çš„æ˜¯â€Jan 2 2014â€åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒæœŸæœ›æœˆä»½å¤„ä¼ è¿›æ¥çš„æ˜¯ä¸¤ä¸ªå­—ç¬¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨å¤©ä¸ºä¸ªä½æ•°çš„æƒ…å†µä¸‹ï¼Œä½ å¾—åœ¨å‰é¢è¡¥0ï¼Œæ¯”å¦‚â€Jan 2 2014â€åº”è¯¥æ”¹ä¸ºâ€Jan 02 2014â€ã€‚</p>
]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>Time</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»Ÿä¸€å»ºæ¨¡è¯­è¨€(UML)</title>
    <url>/2020/09/19/UML/</url>
    <content><![CDATA[<h1 id="ç»Ÿä¸€å»ºæ¨¡è¯­è¨€-UML"><a href="#ç»Ÿä¸€å»ºæ¨¡è¯­è¨€-UML" class="headerlink" title="ç»Ÿä¸€å»ºæ¨¡è¯­è¨€(UML)"></a>ç»Ÿä¸€å»ºæ¨¡è¯­è¨€(UML)</h1><h2 id="ä»€ä¹ˆæ˜¯æ¨¡å‹"><a href="#ä»€ä¹ˆæ˜¯æ¨¡å‹" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¨¡å‹"></a>ä»€ä¹ˆæ˜¯æ¨¡å‹</h2><p>æ¨¡å‹æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„å®Œæ•´çš„æŠ½è±¡ã€‚äººä»¬å¯¹æŸä¸ªé¢†åŸŸç‰¹å®šé—®é¢˜çš„æ±‚è§£åŠè§£å†³æ–¹æ¡ˆï¼Œå¯¹å®ƒä»¬çš„ç†è§£å’Œè®¤è¯†éƒ½è•´å«åœ¨æ¨¡å‹ä¸­ã€‚é€šå¸¸ï¼Œå¼€å‘ä¸€ä¸ªè®¡ç®—æœºç³»ç»Ÿæ˜¯ä¸ºäº†è§£å†³æŸä¸ªé¢†åŸŸç‰¹å®šé—®é¢˜ï¼Œé—®é¢˜çš„æ±‚è§£è¿‡ç¨‹ï¼Œå°±æ˜¯ä»é¢†åŸŸé—®é¢˜åˆ°è®¡ç®—æœºç³»ç»Ÿçš„æ˜ å°„ã€‚</p>
<p><img src="http://image.leonote.cn//20200919102631.png" alt=""></p>
<h2 id="ä¸ºä»€ä¹ˆè¦å»ºé€ æ¨¡å‹"><a href="#ä¸ºä»€ä¹ˆè¦å»ºé€ æ¨¡å‹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å»ºé€ æ¨¡å‹"></a>ä¸ºä»€ä¹ˆè¦å»ºé€ æ¨¡å‹</h2><ol>
<li>å»ºé€ ä¼ ç»Ÿæ¨¡å‹çš„ç›®çš„<ul>
<li>ä¸ºäº†è¯æ˜æŸä»¶äº‹ç‰©èƒ½å¦å·¥ä½œ</li>
<li>å‰æï¼šå»ºé€ æ¨¡å‹çš„æˆæœ¬è¿œè¿œä½äºå»ºé€ å®ç‰©çš„æˆæœ¬<ul>
<li>é€ é£æœº</li>
<li>é€ é«˜æ¥¼</li>
</ul>
</li>
</ul>
</li>
<li>å»ºé€ è½¯ä»¶æ¨¡å‹çš„ç›®çš„<ul>
<li>ä¸ºäº†ä¸ä»–äººæ²Ÿé€š</li>
<li>ä¸ºäº†ä¿å­˜è½¯ä»¶è®¾è®¡çš„æœ€ç»ˆæˆæœ</li>
<li>å‰æï¼šé™¤éæ¨¡å‹æ¯”ä»£ç æ›´è¯´æ˜é—®é¢˜</li>
</ul>
</li>
</ol>
<h2 id="é€šç”¨æ¨¡å‹å…ƒç´ "><a href="#é€šç”¨æ¨¡å‹å…ƒç´ " class="headerlink" title="é€šç”¨æ¨¡å‹å…ƒç´ "></a>é€šç”¨æ¨¡å‹å…ƒç´ </h2><p>æ¨¡å‹å…ƒç´ æ˜¯UMLæ„é€ ç³»ç»Ÿçš„å„ç§å…ƒç´ ï¼Œæ˜¯UMLæ„å»ºæ¨¡å‹çš„åŸºæœ¬å•ä½ã€‚</p>
<h3 id="åŸºå…ƒç´ "><a href="#åŸºå…ƒç´ " class="headerlink" title="åŸºå…ƒç´ "></a>åŸºå…ƒç´ </h3><p>æ˜¯ç”±UMLå®šä¹‰çš„æ¨¡å‹å…ƒç´ ï¼Œå¦‚ï¼šç±»ã€ç»“ç‚¹ã€æ„ä»¶ã€æ³¨é‡Šã€å…³è”ã€ä¾èµ–å’Œæ³›åŒ–(ç»§æ‰¿)ç­‰</p>
<p>å…³è”å…³ç³»åˆ†ç±»ï¼š</p>
<p><img src="http://image.leonote.cn//20200919105246.png" alt=""></p>
<ul>
<li>æ³›åŒ–(ç»§æ‰¿) - ç±»ä¸ç±»ï¼Œæ¥å£ä¸æ¥å£çš„å…³ç³»</li>
<li>å®ç° - æ˜¯ä¸€ç§ç±»ä¸æ¥å£çš„å…³ç³»</li>
<li>ç»„åˆ - æ˜¯æ•´ä½“ä¸éƒ¨åˆ†ï¼Œæ˜¯â€œhas-aâ€å…³ç³»ï¼Œä½†éƒ¨åˆ†<strong>ä¸èƒ½ç¦»å¼€</strong>æ•´ä½“è€Œå•ç‹¬å­˜åœ¨<ul>
<li>å…¬å¸å’Œéƒ¨é—¨æ˜¯æ•´ä½“å’Œéƒ¨åˆ†çš„å…³ç³»ï¼Œæ²¡æœ‰å…¬å¸å°±ä¸å­˜åœ¨éƒ¨é—¨</li>
<li>ä¹Ÿæ˜¯ä¸€ç§å…³è”å…³ç³»ï¼Œæ¯”èšåˆæ›´å¼ºå…³è”</li>
</ul>
</li>
<li>èšåˆ - æ˜¯æ•´ä½“ä¸éƒ¨åˆ†ï¼Œæ˜¯â€œcontains-aâ€å…³ç³»ï¼Œä¸”éƒ¨åˆ†<strong>å¯ä»¥ç¦»å¼€</strong>æ•´ä½“è€Œå•ç‹¬å­˜åœ¨<ul>
<li>è½¦å’Œè½®èƒæ˜¯æ•´ä½“å’Œéƒ¨åˆ†çš„å…³ç³»ï¼Œè½®èƒç¦»å¼€è½¦ä»ç„¶å¯ä»¥å­˜åœ¨</li>
<li>ä¹Ÿæ˜¯ä¸€ç§å…³è”å…³ç³»ï¼Œæ˜¯å¼ºå…³è”</li>
</ul>
</li>
<li>å…³è” - æ˜¯ä¸€ç§æ‹¥æœ‰çš„å…³ç³»ï¼Œå®ƒä½¿ä¸€ä¸ªç±»çŸ¥é“å¦ä¸€ä¸ªç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œ<ul>
<li>[ä»£ç è¡¨ç°] æˆå‘˜å˜é‡</li>
</ul>
</li>
<li>ä¾èµ– - æ˜¯ä¸€ç§ä½¿ç”¨çš„å…³ç³»ï¼Œå³ä¸€ä¸ªç±»çš„å®ç°éœ€è¦å¦ä¸€ä¸ªç±»çš„ååŠ©ï¼Œå°½é‡ä¸è¦åŒå‘ä¾èµ–<ul>
<li>[ä»£ç è¡¨ç°] å±€éƒ¨å˜é‡ã€æ–¹æ³•çš„å‚æ•°æˆ–è€…å¯¹é™æ€æ–¹æ³•çš„è°ƒç”¨</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>å„ç§å…³ç³»çš„å¼ºå¼±é¡ºåºï¼š</strong> æ³›åŒ– = å®ç° &gt; ç»„åˆ &gt; èšåˆ &gt; å…³è” &gt; ä¾èµ–</p>
</blockquote>
<h3 id="æ„é€ å‹å…ƒç´ "><a href="#æ„é€ å‹å…ƒç´ " class="headerlink" title="æ„é€ å‹å…ƒç´ "></a>æ„é€ å‹å…ƒç´ </h3><p>åœ¨åŸºå…ƒç´ çš„åŸºç¡€ä¸Šå¢åŠ äº†æ–°çš„å®šä¹‰è€Œæ„é€ çš„æ–°çš„æ¨¡å‹å…ƒç´ ï¼Œå…è®¸ç”¨æˆ·è‡ªå®šä¹‰</p>
<p>æ„é€ å‹å…ƒç´ ç”¨æ‹¬åœ¨åŒå°–æ‹¬å·ã€Š ã€‹ä¸­çš„å­—ç¬¦ä¸²è¡¨ç¤º</p>
<p>ç›®å‰UMLæä¾›äº†40å¤šä¸ªé¢„å®šä¹‰çš„æ„é€ å‹å…ƒç´ ï¼Œå¦‚åŒ…å«ã€Šincludeã€‹ã€æ‰©å±•ã€Š Extend ã€‹</p>
<h2 id="ä»€ä¹ˆæ˜¯UML"><a href="#ä»€ä¹ˆæ˜¯UML" class="headerlink" title="ä»€ä¹ˆæ˜¯UML"></a>ä»€ä¹ˆæ˜¯UML</h2><p>æ˜¯ä¸€ç§å¯¹è½¯ä»¶ç³»ç»Ÿ(æ¶æ„)è¿›è¡Œ==å¯è§†åŒ–å»ºæ¨¡==çš„è¯­è¨€ï¼Œä»¥å›¾å½¢çš„æ–¹å¼æè¿°äº†è½¯ä»¶çš„æ¦‚å¿µã€‚</p>
<h2 id="UMLæœ‰ä»€ä¹ˆä½œç”¨"><a href="#UMLæœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="UMLæœ‰ä»€ä¹ˆä½œç”¨"></a>UMLæœ‰ä»€ä¹ˆä½œç”¨</h2><ol>
<li>æè¿°æŸä¸ªé—®é¢˜é¢†åŸŸ</li>
<li>æè¿°æ„æ€ä¸­çš„è½¯ä»¶è®¾è®¡</li>
<li>æè¿°å·²ç»å®Œæˆçš„è½¯ä»¶å®ç°</li>
</ol>
<h2 id="UMLå›¾çš„åˆ†ç±»"><a href="#UMLå›¾çš„åˆ†ç±»" class="headerlink" title="UMLå›¾çš„åˆ†ç±»"></a>UMLå›¾çš„åˆ†ç±»</h2><h3 id="é™æ€å›¾"><a href="#é™æ€å›¾" class="headerlink" title="é™æ€å›¾"></a>é™æ€å›¾</h3><blockquote>
<p>é€šè¿‡æè¿°ç±»ã€å¯¹è±¡å’Œæ•°æ®ç»“æ„ä»¥åŠå®ƒä»¬ä¹‹é—´å­˜åœ¨çš„å…³ç³»ï¼Œæ¥æè¿°è½¯ä»¶è¦ç´ ä¸­ä¸å˜çš„é€»è¾‘ç»“æ„ã€‚</p>
</blockquote>
<h4 id="ç”¨ä¾‹å›¾ï¼ˆUse-Case-Diagramsï¼‰"><a href="#ç”¨ä¾‹å›¾ï¼ˆUse-Case-Diagramsï¼‰" class="headerlink" title="ç”¨ä¾‹å›¾ï¼ˆUse Case Diagramsï¼‰"></a>ç”¨ä¾‹å›¾ï¼ˆUse Case Diagramsï¼‰</h4><h4 id="å¯¹è±¡å›¾ï¼ˆObject-Diagramsï¼‰"><a href="#å¯¹è±¡å›¾ï¼ˆObject-Diagramsï¼‰" class="headerlink" title="å¯¹è±¡å›¾ï¼ˆObject Diagramsï¼‰"></a>å¯¹è±¡å›¾ï¼ˆObject Diagramsï¼‰</h4><h4 id="ç±»å›¾ï¼ˆClass-Diagramsï¼‰"><a href="#ç±»å›¾ï¼ˆClass-Diagramsï¼‰" class="headerlink" title="ç±»å›¾ï¼ˆClass Diagramsï¼‰"></a>ç±»å›¾ï¼ˆClass Diagramsï¼‰</h4><h4 id="ç»„ä»¶å›¾ï¼ˆComponent-Diagramsï¼‰"><a href="#ç»„ä»¶å›¾ï¼ˆComponent-Diagramsï¼‰" class="headerlink" title="ç»„ä»¶å›¾ï¼ˆComponent Diagramsï¼‰"></a>ç»„ä»¶å›¾ï¼ˆComponent Diagramsï¼‰</h4><h4 id="åŒ…å›¾ï¼ˆPackage-Diagramsï¼‰"><a href="#åŒ…å›¾ï¼ˆPackage-Diagramsï¼‰" class="headerlink" title="åŒ…å›¾ï¼ˆPackage Diagramsï¼‰"></a>åŒ…å›¾ï¼ˆPackage Diagramsï¼‰</h4><h4 id="éƒ¨ç½²å›¾ï¼ˆDeployment-Diagramsï¼‰"><a href="#éƒ¨ç½²å›¾ï¼ˆDeployment-Diagramsï¼‰" class="headerlink" title="éƒ¨ç½²å›¾ï¼ˆDeployment Diagramsï¼‰"></a>éƒ¨ç½²å›¾ï¼ˆDeployment Diagramsï¼‰</h4><h3 id="åŠ¨æ€å›¾"><a href="#åŠ¨æ€å›¾" class="headerlink" title="åŠ¨æ€å›¾"></a>åŠ¨æ€å›¾</h3><blockquote>
<p>é€šè¿‡æç»˜æ‰§è¡Œæµç¨‹æˆ–è€…å®ä½“çŠ¶æ€å˜åŒ–çš„æ–¹å¼ï¼Œæ¥å±•ç¤ºè½¯ä»¶å®ä½“åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å˜åŒ–è¿‡ç¨‹ã€‚</p>
</blockquote>
<h4 id="åä½œå›¾ï¼ˆCollaboration-Diagramsï¼‰"><a href="#åä½œå›¾ï¼ˆCollaboration-Diagramsï¼‰" class="headerlink" title="åä½œå›¾ï¼ˆCollaboration Diagramsï¼‰"></a>åä½œå›¾ï¼ˆCollaboration Diagramsï¼‰</h4><h4 id="åºåˆ—å›¾ï¼ˆSequence-Diagramsï¼‰"><a href="#åºåˆ—å›¾ï¼ˆSequence-Diagramsï¼‰" class="headerlink" title="åºåˆ—å›¾ï¼ˆSequence Diagramsï¼‰"></a>åºåˆ—å›¾ï¼ˆSequence Diagramsï¼‰</h4><h4 id="æ´»åŠ¨å›¾ï¼ˆActivity-Diagramsï¼‰"><a href="#æ´»åŠ¨å›¾ï¼ˆActivity-Diagramsï¼‰" class="headerlink" title="æ´»åŠ¨å›¾ï¼ˆActivity Diagramsï¼‰"></a>æ´»åŠ¨å›¾ï¼ˆActivity Diagramsï¼‰</h4><h4 id="çŠ¶æ€å›¾ï¼ˆState-Diagramsï¼‰"><a href="#çŠ¶æ€å›¾ï¼ˆState-Diagramsï¼‰" class="headerlink" title="çŠ¶æ€å›¾ï¼ˆState Diagramsï¼‰"></a>çŠ¶æ€å›¾ï¼ˆState Diagramsï¼‰</h4>]]></content>
      <categories>
        <category>æ¶æ„</category>
        <category>UML</category>
      </categories>
      <tags>
        <tag>æ¶æ„</tag>
        <tag>UML</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue Mixin</title>
    <url>/2020/08/25/Vue%20Mixin/</url>
    <content><![CDATA[<p><a href="https://www.jianshu.com/p/c054835f86bb">å‚è€ƒè¿æ¥</a></p>
<h2 id="å±€éƒ¨-mixin"><a href="#å±€éƒ¨-mixin" class="headerlink" title="å±€éƒ¨ mixin"></a>å±€éƒ¨ mixin</h2><p>å½“å¤šä¸ªç»„ä»¶éƒ½éœ€è¦ç”¨åˆ°ç›¸åŒå¾—åˆ°æ–¹æ³•æˆ–è€…dataæœ‰ç›¸åŒçš„å±æ€§ï¼Œå°±å¯ä»¥ä½¿ç”¨mixinè¿›è¡Œå°è£…</p>
<p>éœ€è¦å°è£…çš„æ–¹æ³•å’Œå±æ€§ â€“&gt; <code>mixin.js</code> ï¼ˆåå­—æ ¹æ®ä¸šåŠ¡å®šä¹‰ï¼‰</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">	name: <span class="string">&#x27;Mixin&#x27;</span>,</span><br><span class="line">	 <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	   <span class="keyword">return</span> &#123;</span><br><span class="line">         message: <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">	 &#125;,</span><br><span class="line">     <span class="comment">//å¯ä»¥æ·»åŠ é’©å­å‡½æ•°</span></span><br><span class="line">     <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">&#x27;æˆ‘æ˜¯ mixins ä¸­çš„ created&#x27;</span>)</span><br><span class="line">     &#125;,</span><br><span class="line">	 methods: &#123;</span><br><span class="line">	    <span class="function"><span class="title">show</span>(<span class="params">num</span>)</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(num)  <span class="comment">// mixinsçš„å‡½æ•°å¯ä»¥æ¥æ”¶ç»„ä»¶ä¼ çš„å‚æ•°ã€‚</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">foo</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">conflicting</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;from mixin&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>éœ€è¦ä½¿ç”¨mixin.jsé‡Œé¢çš„æ–¹æ³•å’Œå±æ€§çš„vueæ–‡ä»¶ â€“&gt; <code>test.vue</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import mixin from &#39;..&#x2F;mixins&#x2F;mixin&#39;</span><br><span class="line">    </span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#39;Test&#39;,</span><br><span class="line">  mixins: [mixin], &#x2F;&#x2F; è¿™é‡Œå¼•å…¥mixin.js</span><br><span class="line">  data() &#123;</span><br><span class="line">	return &#123;</span><br><span class="line"> 	  title: &#39;def&#39;,</span><br><span class="line">      message: &#39;goodbye&#39;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">   created() &#123;</span><br><span class="line">      console.log(&#39;æˆ‘æ˜¯Vueä¸­çš„created&#39;)</span><br><span class="line">      console.log(this.$data)</span><br><span class="line">      this.show(50); &#x2F;&#x2F;å¯é€šè¿‡å‡½æ•°ä¼ å‚,æŠŠç»„ä»¶ä¸­éœ€è¦çš„å‚æ•°ä¼ ç»™mixinsè¿›è¡Œä½¿ç”¨ã€‚</span><br><span class="line">   &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">	   bar() &#123;</span><br><span class="line">          console.log(&#39;bar&#39;)</span><br><span class="line">        &#125;,</span><br><span class="line">        conflicting() &#123;</span><br><span class="line">          console.log(&#39;from self&#39;)</span><br><span class="line">        &#125;</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang&#x3D;&quot;scss&quot; scoped&gt;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>



<h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><blockquote>
<p>ç»„ä»¶ â€“&gt; test.vue</p>
<p>æ··å…¥å¯¹è±¡ â€“&gt; mixin.js</p>
</blockquote>
<ol>
<li><p>å½“ç»„ä»¶å’Œæ··å…¥å¯¹è±¡å«æœ‰åŒåé€‰é¡¹ï¼ˆå±æ€§/æ–¹æ³•ï¼‰æ—¶ï¼Œè¿™äº›é€‰é¡¹å°†ä»¥æ°å½“çš„æ–¹å¼æ··åˆã€‚</p>
<blockquote>
<p>æ¯”å¦‚ï¼Œæ•°æ®å¯¹è±¡åœ¨å†…éƒ¨ä¼šè¿›è¡Œæµ…åˆå¹¶ (ä¸€å±‚å±æ€§æ·±åº¦)ï¼Œåœ¨å’Œç»„ä»¶çš„æ•°æ®å‘ç”Ÿå†²çªæ—¶ä»¥ç»„ä»¶æ•°æ®ä¼˜å…ˆã€‚</p>
<p>ä¸Šè¿°ä¾‹å­ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">data: &#123;</span><br><span class="line">   <span class="keyword">return</span>: &#123;</span><br><span class="line">      title: <span class="string">&#x27;def&#x27;</span>, <span class="comment">// mixin.jså±æ€§è£…è¿›ç»„ä»¶é‡Œé¢</span></span><br><span class="line">      message: <span class="string">&#x27;goodbye&#x27;</span> <span class="comment">// ä¸mixin.jsåŒåï¼Œç»„ä»¶ä¼˜å…ˆ</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  <span class="function"><span class="title">show</span>(<span class="params">num</span>)</span> &#123; <span class="comment">// mixin.jsæ–¹æ³•è£…è¿›ç»„ä»¶é‡Œé¢</span></span><br><span class="line">      <span class="built_in">console</span>.log(num)  </span><br><span class="line">   &#125;, </span><br><span class="line">   <span class="function"><span class="title">bar</span>(<span class="params"></span>)</span> &#123; <span class="comment">// ä¸mixin.jsåŒåï¼Œç»„ä»¶ä¼˜å…ˆ</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="function"><span class="title">conflicting</span>(<span class="params"></span>)</span> &#123; <span class="comment">// ä¸mixin.jsåŒåï¼Œç»„ä»¶ä¼˜å…ˆ</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;from self&#x27;</span>)</span><br><span class="line">   &#125;,   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>åŒåé’©å­å‡½æ•°å°†æ··åˆä¸ºä¸€ä¸ªæ•°ç»„ï¼Œéƒ½ä¼šè¢«è°ƒç”¨ã€‚</p>
<blockquote>
<p>æ··å…¥å¯¹è±¡çš„é’©å­å°†åœ¨ç»„ä»¶è‡ªèº«é’©å­ä¹‹å‰è°ƒç”¨ã€‚</p>
</blockquote>
</li>
<li><p>å€¼ä¸ºå¯¹è±¡çš„é€‰é¡¹ï¼Œä¾‹å¦‚ <code>methods</code>, <code>components</code> å’Œ <code>directives</code>ï¼Œå°†è¢«æ··åˆä¸ºåŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<blockquote>
<p>ä¸¤ä¸ªå¯¹è±¡é”®åå†²çªæ—¶ï¼Œå–ç»„ä»¶å¯¹è±¡çš„é”®å€¼å¯¹ã€‚</p>
</blockquote>
</li>
</ol>
<h2 id="å…¨å±€-mixin"><a href="#å…¨å±€-mixin" class="headerlink" title="å…¨å±€ mixin"></a>å…¨å±€ mixin</h2><blockquote>
<p>æ…ç”¨:  ä¸€æ—¦ä½¿ç”¨å…¨å±€æ··å…¥å¯¹è±¡ï¼Œå°†ä¼šå½±å“åˆ° æ‰€æœ‰ ä¹‹ååˆ›å»ºçš„ Vue å®ä¾‹</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">Vue.mixin(&#123;&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Vue</category>
      </categories>
      <tags>
        <tag>Vue</tag>
        <tag>Mixin</tag>
      </tags>
  </entry>
  <entry>
    <title>Vue created ä¸ mounted</title>
    <url>/2020/11/09/Vue%20created%20%E4%B8%8E%20mounted/</url>
    <content><![CDATA[<h1 id="Vue-created-ä¸-mounted-åŒºåˆ«"><a href="#Vue-created-ä¸-mounted-åŒºåˆ«" class="headerlink" title="Vue created ä¸ mounted åŒºåˆ«"></a>Vue created ä¸ mounted åŒºåˆ«</h1><table>
<thead>
<tr>
<th align="center">ç”Ÿå‘½å‘¨æœŸ</th>
<th align="center">æ˜¯å¦è·å–domèŠ‚ç‚¹</th>
<th align="center">æ˜¯å¦å¯ä»¥è·å–data</th>
<th align="center">æ˜¯å¦è·å–methods</th>
</tr>
</thead>
<tbody><tr>
<td align="center">beforeCreate</td>
<td align="center">å¦</td>
<td align="center">å¦</td>
<td align="center">å¦</td>
</tr>
<tr>
<td align="center">created</td>
<td align="center">å¦</td>
<td align="center">æ˜¯</td>
<td align="center">æ˜¯</td>
</tr>
<tr>
<td align="center">beforeMount</td>
<td align="center">å¦</td>
<td align="center">æ˜¯</td>
<td align="center">æ˜¯</td>
</tr>
<tr>
<td align="center">mounted</td>
<td align="center">æ˜¯</td>
<td align="center">æ˜¯</td>
<td align="center">æ˜¯</td>
</tr>
</tbody></table>
<ul>
<li>createdï¼šåœ¨æ¨¡æ¿æ¸²æŸ“æˆ html å‰è°ƒç”¨ï¼Œå³é€šå¸¸åˆå§‹åŒ–æŸäº›å±æ€§å€¼ï¼Œç„¶åå†æ¸²æŸ“æˆè§†å›¾ã€‚</li>
<li>mountedï¼šåœ¨æ¨¡æ¿æ¸²æŸ“æˆ html åè°ƒç”¨ï¼Œé€šå¸¸æ˜¯åˆå§‹åŒ–é¡µé¢å®Œæˆåï¼Œå†å¯¹ html çš„dom èŠ‚ç‚¹è¿›è¡Œä¸€äº›éœ€è¦çš„æ“ä½œã€‚</li>
</ul>
<p>å¦‚æœè¦ç±»ä¼¼ <code>let ctx = document.getElementById(ID)</code>è·å– dom å…ƒç´ ï¼Œåªèƒ½ç­‰è¿™ä¸ªhtml æ¸²æŸ“å®Œåæ‰å¯ä»¥è¿›è¡Œï¼Œé‚£ä¹ˆå°±ç”¨ mounted ï¼Œå¦‚æœä¸éœ€è¦ created å³å¯ã€‚</p>
]]></content>
      <categories>
        <category>Vue</category>
      </categories>
      <tags>
        <tag>Vue</tag>
        <tag>Mixin</tag>
      </tags>
  </entry>
  <entry>
    <title>Wake On Lan é…ç½®è¿œç¨‹å¯åŠ¨ç”µè„‘</title>
    <url>/2020/07/04/WOL%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h1><p>è¿œç¨‹æ§åˆ¶ç”µè„‘å¼€æœºã€‚</p>
<blockquote>
<p>æœ¬äººç¬”è®°æœ¬æ˜¯åˆèµ·æ¥æ”¾åœ¨ä¹¦æ¶åé¢çš„ï¼Œæ¯æ¬¡å¼€æœºéƒ½è¦æŠŠå®ƒæ‹¿å‡ºæ¥æ‰“å¼€ï¼Œéå¸¸éº»çƒ¦ï¼Œæ‰€ä»¥æƒ³è¦é€šè¿‡å…¶ä»–æ–¹å¼å”¤é†’ç”µè„‘ã€‚</p>
</blockquote>
<h1 id="è§£å†³æ€è·¯"><a href="#è§£å†³æ€è·¯" class="headerlink" title="è§£å†³æ€è·¯"></a>è§£å†³æ€è·¯</h1><blockquote>
<p>ä½¿ç”¨Wake On Lané€šè¿‡ç½‘å¡æ§åˆ¶ç”µè„‘å¼€æœºã€‚</p>
</blockquote>
<h1 id="ä»€ä¹ˆæ˜¯Wake-On-Lan"><a href="#ä»€ä¹ˆæ˜¯Wake-On-Lan" class="headerlink" title="ä»€ä¹ˆæ˜¯Wake On Lan"></a>ä»€ä¹ˆæ˜¯Wake On Lan</h1><p> Wake-On-LAN ç®€ç§° WOLï¼Œæ˜¯ä¸€ç§ç”µæºç®¡ç†åŠŸèƒ½ï¼›å®ƒæ˜¯ç”±IBMå…¬å¸æå‡ºçš„ç½‘ç»œå”¤é†’æ ‡å‡†ï¼Œç›®å‰è¯¥æ ‡å‡†å·²è¢«å¤§å¤šæ•°ä¸»æ¿å‚å•†æ”¯æŒã€‚æ”¯æŒè¯¥æ ‡å‡†çš„ä¸»æ¿å…è®¸ä»è¿œç¨‹é€šè¿‡ç½‘ç»œå”¤é†’è®¡ç®—æœºï¼Œä¹Ÿå°±æ˜¯è¿œç¨‹å¼€æœºã€‚</p>
<h1 id="å¦‚ä½•å®ç°è¿œç¨‹å¼€æœº"><a href="#å¦‚ä½•å®ç°è¿œç¨‹å¼€æœº" class="headerlink" title="å¦‚ä½•å®ç°è¿œç¨‹å¼€æœº"></a>å¦‚ä½•å®ç°è¿œç¨‹å¼€æœº</h1><h2 id="æ‰“å¼€ä½ çš„ç½‘ç»œè®¾ç½®"><a href="#æ‰“å¼€ä½ çš„ç½‘ç»œè®¾ç½®" class="headerlink" title="æ‰“å¼€ä½ çš„ç½‘ç»œè®¾ç½®"></a>æ‰“å¼€ä½ çš„ç½‘ç»œè®¾ç½®</h2><p>æ–¹å¼1ï¼šæˆ‘çš„ç”µè„‘-&gt;å³é”®-&gt;ç®¡ç†-&gt;è®¾å¤‡ç®¡ç†å™¨-&gt;ç½‘ç»œé€‚é…å™¨-&gt;æ‰¾åˆ°è‡ªå·±çš„ç½‘å¡-&gt;å³é”®-&gt;å±æ€§</p>
<p><img src="http://image.leonote.cn/image-20200703221016604.png" alt="image-20200703221016604"></p>
<p>æ–¹å¼2ï¼šæ‰“å¼€ç½‘ç»œå’ŒInternetè®¾ç½®-&gt;ç½‘ç»œå…±äº«ä¸­å¿ƒ-&gt;æ›´æ”¹é€‚é…å™¨è®¾ç½®-&gt;æ‰¾åˆ°è‡ªå·±çš„ç½‘å¡-&gt;å³é”®-&gt;å±æ€§-&gt;é…ç½®</p>
<p><img src="http://image.leonote.cn/image-20200703221145601.png" alt="image-20200703221145601"></p>
<p><img src="http://image.leonote.cn/image-20200703221347169.png" alt="image-20200703221347169"></p>
<p><img src="http://image.leonote.cn/image-20200703221417037.png" alt="image-20200703221417037"></p>
<h2 id="é€‰æ‹©ç½‘å¡å”¤é†’"><a href="#é€‰æ‹©ç½‘å¡å”¤é†’" class="headerlink" title="é€‰æ‹©ç½‘å¡å”¤é†’"></a>é€‰æ‹©ç½‘å¡å”¤é†’</h2><p><img src="http://image.leonote.cn/image-20200703221524097.png" alt="image-20200703221524097"></p>
<p><img src="http://image.leonote.cn/image-20200703221625409.png" alt="image-20200703221625409"></p>
<h2 id="è®¾ç½®é˜²ç«å¢™ç­–ç•¥"><a href="#è®¾ç½®é˜²ç«å¢™ç­–ç•¥" class="headerlink" title="è®¾ç½®é˜²ç«å¢™ç­–ç•¥"></a>è®¾ç½®é˜²ç«å¢™ç­–ç•¥</h2><p>é˜²ç«å¢™å’Œç½‘ç»œä¿æŠ¤-&gt; é«˜çº§è®¾ç½®</p>
<p><img src="http://image.leonote.cn/image-20200703221741989.png" alt="image-20200703221741989"></p>
<p><img src="http://image.leonote.cn/image-20200703221814410.png" alt="image-20200703221814410"></p>
<p><img src="http://image.leonote.cn/image-20200703222006090.png" alt="image-20200703222006090"></p>
<p><img src="http://image.leonote.cn/image-20200703222150080.png" alt="image-20200703222150080"></p>
<p><img src="http://image.leonote.cn/image-20200703222054000.png" alt="image-20200703222054000"></p>
<p><img src="http://image.leonote.cn/image-20200703222122592.png" alt="image-20200703222122592"></p>
<h2 id="åœ¨è·¯ç”±å™¨è®¾ç½®é‡Œå°†PCçš„MACåœ°å€å’Œç½‘çº¿çš„IPç»‘å®š"><a href="#åœ¨è·¯ç”±å™¨è®¾ç½®é‡Œå°†PCçš„MACåœ°å€å’Œç½‘çº¿çš„IPç»‘å®š" class="headerlink" title="åœ¨è·¯ç”±å™¨è®¾ç½®é‡Œå°†PCçš„MACåœ°å€å’Œç½‘çº¿çš„IPç»‘å®š"></a>åœ¨è·¯ç”±å™¨è®¾ç½®é‡Œå°†PCçš„MACåœ°å€å’Œç½‘çº¿çš„IPç»‘å®š</h2><p><img src="http://image.leonote.cn/snipaste_20200703_215804.png" alt="snipaste_20200703_215804"></p>
<h2 id="PCå®‰è£…æµ‹è¯•è½¯ä»¶"><a href="#PCå®‰è£…æµ‹è¯•è½¯ä»¶" class="headerlink" title="PCå®‰è£…æµ‹è¯•è½¯ä»¶"></a>PCå®‰è£…æµ‹è¯•è½¯ä»¶</h2><p><a href="https://www.depicus.com/wake-on-lan/wake-on-lan-monitor">https://www.depicus.com/wake-on-lan/wake-on-lan-monitor</a> </p>
<p>ä¸‹è½½å®Œæˆåæ‰“å¼€ï¼Œè®¾ç½®UDPç«¯å£ä¸ºåˆšæ‰è®¾ç½®çš„ç«¯å£å·9ï¼Œç‚¹å‡»Start</p>
<p><img src="http://image.leonote.cn/image-20200703222934685.png" alt="image-20200703222934685"></p>
<h2 id="æ‰‹æœºå®‰è£…WOLçš„è½¯ä»¶"><a href="#æ‰‹æœºå®‰è£…WOLçš„è½¯ä»¶" class="headerlink" title="æ‰‹æœºå®‰è£…WOLçš„è½¯ä»¶"></a>æ‰‹æœºå®‰è£…WOLçš„è½¯ä»¶</h2><p>è¿™é‡Œæˆ‘Iphoneå®‰è£…çš„æ˜¯Wolow</p>
<p><img src="http://image.leonote.cn/image-20200703223328607.png" alt="image-20200703223328607"></p>
<p><img src="http://image.leonote.cn/image-20200703223420342.png" alt="image-20200703223420342"></p>
<p>ç‚¹å‡»åï¼Œå¦‚æœåˆšæ‰æ‰“å¼€çš„monitorè½¯ä»¶ï¼Œå‡ºç°ä»¥ä¸‹çš„å†…å®¹ï¼Œç†è®ºä¸Šå·²ç»ä»£è¡¨èƒ½å¤Ÿè”é€šï¼Œå…³æœºåå¦‚æœè¿˜æ˜¯æ²¡æœ‰å”¤é†’å¯èƒ½éœ€è¦æ‰¾ä¸‹å…¶ä»–åŸå› ã€‚</p>
<p><img src="http://image.leonote.cn/image-20200703224052572.png" alt="image-20200703224052572"></p>
<h1 id="Wake-On-LanåŸç†"><a href="#Wake-On-LanåŸç†" class="headerlink" title="Wake On LanåŸç†"></a>Wake On LanåŸç†</h1><p>Wake-On-LANçš„å®ç°ï¼Œä¸»è¦æ˜¯å‘ç›®æ ‡ä¸»æœºå‘é€ç‰¹æ®Šæ ¼å¼çš„æ•°æ®åŒ…ï¼Œä¿—ç§°é­”æœ¯åŒ…ï¼ˆMagic Packetï¼‰ã€‚</p>
<p>Magic Packet æ ¼å¼çš„æ•°æ®åŒ…æ˜¯ç”± AMD å…¬å¸å¼€å‘æ¨å¹¿çš„æŠ€æœ¯ï¼Œè™½ç„¶å…¶å¹¶éä¸–ç•Œå…¬è®¤çš„æ ‡å‡†ï¼Œä½†æ˜¯ä»ç„¶å—åˆ°å¾ˆå¤šç½‘å¡åˆ¶é€ å•†çš„æ”¯æŒï¼Œå› æ­¤è®¸å¤šå…·æœ‰ç½‘ç»œå”¤é†’åŠŸèƒ½çš„ç½‘å¡éƒ½èƒ½ä¸ä¹‹å…¼å®¹ã€‚</p>
<h2 id="Magic-Packet"><a href="#Magic-Packet" class="headerlink" title="Magic Packet"></a>Magic Packet</h2><p>é­”æ³•æ•°æ®åŒ…ï¼ˆMagic Packetï¼‰æ˜¯ä¸€ä¸ªå¹¿æ’­æ€§çš„å¸§ï¼ˆframeï¼‰ï¼Œé€šè¿‡ç«¯å£7æˆ–ç«¯å£9è¿›è¡Œå‘é€ï¼Œä¸”å¯ä»¥ç”¨æ— è¿æ¥ï¼ˆConnectionless protocolï¼‰çš„é€šä¿¡åè®®ï¼ˆå¦‚UDPï¼‰æ¥ä¼ é€’ã€‚<br> åœ¨é­”æ³•æ•°æ®åŒ…å†…ï¼Œæ¯æ¬¡éƒ½ä¼šå…ˆæœ‰è¿ç»­6ä¸ªâ€FFâ€ï¼ˆåå…­è¿›åˆ¶ï¼Œæ¢ç®—æˆäºŒè¿›åˆ¶å³ï¼š11111111ï¼‰çš„æ•°æ®ï¼Œå³ï¼šFF FF FF FF FF FFï¼Œåœ¨è¿ç»­6ä¸ªâ€FFâ€ååˆ™å¼€å§‹å¸¦å‡ºMACåœ°å€ä¿¡æ¯ï¼ˆMACåœ°å€é‡å¤16æ¬¡ï¼‰ï¼Œæœ‰æ—¶è¿˜ä¼šå¸¦å‡º4å­—èŠ‚æˆ–6å­—èŠ‚çš„å¯†ç ï¼Œä¸€æ—¦ç»ç”±ç½‘å¡ä¾¦æµ‹ã€è§£è¯»ã€ç ”åˆ¤ï¼ˆå¹¿æ’­ï¼‰é­”æ³•æ•°æ®åŒ…çš„å†…å®¹ï¼Œå†…å®¹ä¸­çš„MACåœ°å€ã€å¯†ç è‹¥ä¸ç”µè„‘è‡ªèº«çš„åœ°å€ã€å¯†ç å»åˆï¼Œå°±ä¼šå¼•å¯¼å”¤é†’ã€å¼€æœºçš„ç¨‹åºã€‚</p>
<p>Magic Packet é­”æœ¯æ•°æ®åŒ…çš„æ ¼å¼ä¸€èˆ¬çœ‹ä¸Šå»åƒä¸‹é¢è¿™ä¸ªæ ·å­<br> å‡è®¾MACåœ°å€ä¸ºï¼š00-00-00-00-00</p>
<table>
<thead>
<tr>
<th align="center">åºå·</th>
<th align="center">MagicPacket</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">FF FF FF FF FF FF</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">9</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">10</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">11</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">12</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">13</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">14</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">15</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
<tr>
<td align="center">17</td>
<td align="center">00 00 00 00 00 00</td>
</tr>
</tbody></table>
<p>é­”æ³•æ•°æ®åŒ…ï¼ˆMagic Packetï¼‰ç»“æ„ä¸Šéå¸¸ç®€å•ã€‚</p>
<h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p><a href="https://www.jianshu.com/p/22cbb5e9036a">C#è¯­è¨€å»å®ç°ä¸€ä¸ªWakeOnLanè½¯ä»¶</a></p>
]]></content>
      <categories>
        <category>WOL</category>
      </categories>
      <tags>
        <tag>WOL</tag>
      </tags>
  </entry>
  <entry>
    <title>dockerå®‰è£…å¸¸ç”¨è½¯ä»¶</title>
    <url>/2019/12/07/docker%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="docker-å®‰è£…å¸¸ç”¨è½¯ä»¶"><a href="#docker-å®‰è£…å¸¸ç”¨è½¯ä»¶" class="headerlink" title="docker å®‰è£…å¸¸ç”¨è½¯ä»¶"></a>docker å®‰è£…å¸¸ç”¨è½¯ä»¶</h1><blockquote>
<p>å¦‚æœé…ç½®å¼€æœºå¯åŠ¨ï¼šåé¢åŠ  <code>--restart=always</code></p>
</blockquote>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><ol>
<li>ä¸‹è½½: <code>docker pull nginx</code></li>
<li>è¿è¡Œ: <code>docker run --name nginx -p 80:80 -d docker.io/nginx</code> </li>
</ol>
<h3 id="é…ç½®-nginx-conf"><a href="#é…ç½®-nginx-conf" class="headerlink" title="é…ç½® nginx.conf"></a>é…ç½® nginx.conf</h3><ol>
<li><p>è¿›å…¥ nginx å®¹å™¨: <code>docker exec -it nginx /bin/bash</code></p>
</li>
<li><p>è¿›å…¥ /etc/nginx ç›®å½•: <code>cd /etc/nginx</code></p>
</li>
<li><p>viæˆ–è€…vimç¼–è¾‘: <code>vim nginx.conf</code></p>
</li>
<li><blockquote>
<p>PSï¼šå› ä¸ºnginxé‡Œé¢æ²¡æœ‰è‡ªå¸¦vimæˆ–è€…viï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œå®‰è£…</p>
<p>åœ¨/etc/nginxç›®å½•ä¸‹ï¼š</p>
<p><code>apt-get update</code>  æ›´æ–°</p>
<p><code>apt-get install vim</code>  ä¸‹è½½ vim</p>
</blockquote>
</li>
</ol>
<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><h3 id="å•æœºç‰ˆ"><a href="#å•æœºç‰ˆ" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h3><ol>
<li>ä¸‹è½½: <code>docker pull redis:latest</code></li>
<li>è¿è¡Œ: <code>docker run -itd --name redis -p 6379:6379 redis</code> + <code>--requirepass &quot;******&quot;</code> (è¿è¡Œæ—¶å°±è®¾ç½®å¯†ç )</li>
<li>è¿›å…¥rediså®¹å™¨é‡Œé¢(å¯é€‰): <code>docker exec -it redis /bin/bash</code></li>
<li>è¿æ¥redis(å¯é€‰): <code>redis-cli</code></li>
<li>æŸ¥çœ‹æ˜¯å¦æœ‰è®¾ç½®å¯†ç (å¯é€‰):  <code>config get requirepass</code></li>
<li>è®¾ç½®å¯†ç (å¯é€‰): <code>config set requirepass ****</code></li>
</ol>
<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><ol>
<li>ä¸‹è½½: <code>docker pull mysql:latest</code></li>
<li>è¿è¡Œ: <code>docker run -itd --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql</code></li>
</ol>
<h2 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h2><h3 id="å•æœºç‰ˆ-1"><a href="#å•æœºç‰ˆ-1" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h3><ol>
<li>ä¸‹è½½: <code>docker pull zookeeper:latest</code></li>
<li>è¿è¡Œ: <code>docker run -d --name zookeeper -p 2181:2181 zookeeper</code></li>
<li>è¿›å…¥zookeeperå®¹å™¨é‡Œé¢(å¯é€‰): <code>docker exec -it zookeeper /bin/bash</code></li>
</ol>
<h2 id="kafuka"><a href="#kafuka" class="headerlink" title="kafuka"></a>kafuka</h2><h3 id="å•æœºç‰ˆ-2"><a href="#å•æœºç‰ˆ-2" class="headerlink" title="å•æœºç‰ˆ"></a>å•æœºç‰ˆ</h3><ol>
<li><p>ä¸‹è½½: <code>docker pull wurstmeister/kafka</code></p>
</li>
<li><p>è¿è¡Œ:  </p>
<ul>
<li><p>å…ˆè¿è¡Œzookeeper <code>docker run -d --name zookeeper -p 2181:2181 zookeeper</code></p>
</li>
<li><p>å†å¯åŠ¨kafuka</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run  -d --name kafka -p 9092:9092 -e KAFKA_BROKER_ID=0 -e KAFKA_ZOOKEEPER_CONNECT=192.168.1.100:2181 -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.1.100:9092 -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 -t wurstmeister/kafka</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è§£é‡Šï¼š</p>
<p>ä¸Šé¢çš„å‘½ä»¤ï¼Œä¸»è¦è®¾ç½®å››ä¸ªå‚æ•°</p>
<p>KAFKA_BROKER_ID=0<br>KAFKA_ZOOKEEPER_CONNECT=192.168.1.100:2181<br>KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.1.100:9092<br>KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092<br>ä¸­é—´ä¸¤ä¸ªå‚æ•°çš„192.168.1.100æ”¹ä¸ºå®¿ä¸»æœºå™¨çš„IPåœ°å€ï¼Œå¦‚æœä¸è¿™ä¹ˆè®¾ç½®ï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ¨åˆ«çš„æœºå™¨ä¸Šè®¿é—®ä¸åˆ°kafkaã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li><p>æµ‹è¯•kafuka: </p>
<ul>
<li>è¿›å…¥å®¹å™¨: <code>docker exec -it kafka /bin/bash</code></li>
<li>è¿›å…¥kafkaæ‰€åœ¨ç›®å½•: <code>cd opt/kafka_2.11-2.5.0/</code></li>
<li>å¯åŠ¨æ¶ˆæ¯å‘é€æ–¹: <code>./bin/kafka-console-producer.sh --broker-list localhost:9092 --topic mykafka</code></li>
<li>å…‹éš†ä¼šè¯ è¿›å…¥kafkaæ‰€åœ¨ç›®å½•: <code>cd opt/kafka_2.11-2.5.0/</code></li>
<li>å¯åŠ¨æ¶ˆæ¯æ¥æ”¶æ–¹: <code>./bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic mykafka --from-beginning</code></li>
</ul>
</li>
</ol>
<h2 id="mongo"><a href="#mongo" class="headerlink" title="mongo"></a>mongo</h2><ol>
<li><p>ä¸‹è½½å¹¶è¿è¡Œ: <code>docker run -itd --name mongo -v /data/mongo/data:/data/db -p 27017:27017 mongo --auth</code></p>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šé»˜è®¤æ•°æ®æ˜¯å­˜åœ¨å®¹å™¨ç³»ç»Ÿçš„<code>/data/db</code>ç›®å½•ä¸‹çš„ â€“authæ˜¯å¼€å¯è®¤è¯</p>
</blockquote>
</li>
<li><p>è®¾ç½®å¯†ç </p>
<ul>
<li>è¿›å…¥å®¹å™¨: <code>docker exec -it mongo bash</code></li>
<li>è¿æ¥åˆ°mongo: <code>mongo</code></li>
<li>æŸ¥çœ‹å½“å‰ç‰ˆæœ¬: <code>db.version()</code></li>
<li>åˆ‡æ¢åˆ°adminåº“: <code>use admin</code></li>
<li>åˆ›å»ºç®¡ç†å‘˜æƒé™ç”¨æˆ·: <code>db.createUser(&#123; user:&#39;admin&#39;,pwd:&#39;123456&#39;,roles:[ &#123; role:&#39;userAdminAnyDatabase&#39;, db: &#39;admin&#39;&#125;]&#125;);</code></li>
<li>è®¤è¯: <code>db.auth(&#39;admin&#39;,&#39;123456&#39;);</code></li>
<li>åˆ›å»ºæ™®é€šè¯»å†™ å¹¶æŒ‡å®šåº“ç”¨æˆ·: <code>db.createUser(&#123; user:&#39;user&#39;,pwd:&#39;123456&#39;,roles:[ &#123; role:&#39;readWrite&#39;, db: &#39;testdb&#39;&#125;]&#125;);</code></li>
<li>å¿…é¡»è¦åœ¨adminåº“è®¤è¯: <code>db.auth(&#39;user&#39;,&#39;123456&#39;)</code></li>
<li>åˆ‡æ¢åˆ°testdbåº“: <code>use testdb</code></li>
<li>æ’å…¥ä¸€æ¡æ•°æ®åˆ°personé›†åˆä¸­: <code>db.person.insert(&#123;name:&#39;libai-go&#39;,age:18&#125;)</code></li>
<li>æŸ¥æ‰¾personé›†åˆæ‰€æœ‰æ•°æ®: <code>db.person.find(&#123;&#125;)</code></li>
</ul>
</li>
</ol>
<h2 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h2><ol>
<li><p>åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒåŒä¸€ä¸ªç½‘ç»œçš„å†…çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡localhost:port é€šä¿¡ï¼Œæ–¹ä¾¿kibanaè®¿é—®es:</p>
<p><code>docker network create somenetwork</code></p>
</li>
<li><p>ä¸‹è½½å¹¶è¿è¡Œ: <code>docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch</code></p>
</li>
</ol>
<h2 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h2><ol>
<li>ä¸‹è½½å¹¶è¿è¡Œ: <code>docker run -d --name kibana --net somenetwork -p 5601:5601 kibana:7.6.2</code></li>
</ol>
]]></content>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoå¸¸ç”¨å‘½ä»¤</title>
    <url>/2019/11/28/hexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h4 id="å®‰è£…hexo"><a href="#å®‰è£…hexo" class="headerlink" title="å®‰è£…hexo"></a>å®‰è£…hexo</h4><p><code>npm install hexo -g</code> </p>
<h4 id="æ›´æ–°ç‰ˆæœ¬"><a href="#æ›´æ–°ç‰ˆæœ¬" class="headerlink" title="æ›´æ–°ç‰ˆæœ¬"></a>æ›´æ–°ç‰ˆæœ¬</h4><p> <code>npm update hexo -g</code></p>
<h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p><code>hexo init</code></p>
<h1 id="å‘½ä»¤-amp-ç®€å†™"><a href="#å‘½ä»¤-amp-ç®€å†™" class="headerlink" title="å‘½ä»¤&amp;ç®€å†™"></a>å‘½ä»¤&amp;ç®€å†™</h1><h4 id="æ–°å»ºæ–‡ç« "><a href="#æ–°å»ºæ–‡ç« " class="headerlink" title="æ–°å»ºæ–‡ç« "></a>æ–°å»ºæ–‡ç« </h4><p><code>hexo new &quot;&lt;title&gt;&quot;</code>      ===          <code>hexo n &quot;&lt;title&gt;&quot;</code> </p>
<h4 id="æ–°å»ºè‰ç¨¿"><a href="#æ–°å»ºè‰ç¨¿" class="headerlink" title="æ–°å»ºè‰ç¨¿"></a>æ–°å»ºè‰ç¨¿</h4><p><code>hexo new draft &quot;&lt;title&gt;&quot;</code> ===  <code>hexo n draft &quot;&lt;title&gt;&quot;</code></p>
<blockquote>
<p>è‰ç¨¿ç›¸å½“äºâ€œç§å¯†æ–‡ç« â€åŠŸèƒ½ã€‚</p>
<ol>
<li>ä¼šåœ¨<code>source/_drafts</code>ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªè‰ç¨¿çš„markdownæ–‡ä»¶ã€‚ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶ä¸è¢«æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œé“¾æ¥ä¹Ÿè®¿é—®ä¸åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ æƒ³æŠŠæŸä¸€ç¯‡æ–‡ç« ç§»é™¤æ˜¾ç¤ºï¼Œåˆä¸èˆå¾—åˆ é™¤ï¼Œå¯ä»¥æŠŠå®ƒç§»åŠ¨åˆ°<code>_drafts</code>ç›®å½•ä¹‹ä¸­ã€‚</li>
<li>å¦‚æœä½ å¸Œæœ›å¼ºè¡Œé¢„è§ˆè‰ç¨¿ï¼Œæ›´æ”¹é…ç½®æ–‡ä»¶ï¼š<code>render_drafts: true</code></li>
<li>æˆ–è€…æœ¬åœ°é¢„è§ˆçš„å‘½ä»¤åŠ å‚æ•°ï¼š<code>hexo server --drafts</code></li>
</ol>
</blockquote>
<h4 id="å°†è‰ç¨¿å‘å¸ƒæˆæ–‡ç« "><a href="#å°†è‰ç¨¿å‘å¸ƒæˆæ–‡ç« " class="headerlink" title="å°†è‰ç¨¿å‘å¸ƒæˆæ–‡ç« "></a>å°†è‰ç¨¿å‘å¸ƒæˆæ–‡ç« </h4><p><code>hexo publish &quot;&lt;title&gt;&quot;</code>   ===       <code>hexo p &quot;&lt;title&gt;&quot;</code> </p>
<h4 id="ç”Ÿæˆé™æ€ç½‘é¡µ"><a href="#ç”Ÿæˆé™æ€ç½‘é¡µ" class="headerlink" title="ç”Ÿæˆé™æ€ç½‘é¡µ"></a>ç”Ÿæˆé™æ€ç½‘é¡µ</h4><p> <code>hexo generate</code> ===   <code>hexo g</code>  </p>
<h4 id="æ¸…é™¤é¡µé¢ç¼“å­˜"><a href="#æ¸…é™¤é¡µé¢ç¼“å­˜" class="headerlink" title="æ¸…é™¤é¡µé¢ç¼“å­˜"></a>æ¸…é™¤é¡µé¢ç¼“å­˜</h4><p><code>hexo clean</code></p>
<h4 id="æœ¬åœ°å¯åŠ¨hexoæœåŠ¡é¢„è§ˆï¼Œä¿®æ”¹å†…å®¹ä¼šæ›´æ–°é¡µé¢"><a href="#æœ¬åœ°å¯åŠ¨hexoæœåŠ¡é¢„è§ˆï¼Œä¿®æ”¹å†…å®¹ä¼šæ›´æ–°é¡µé¢" class="headerlink" title="æœ¬åœ°å¯åŠ¨hexoæœåŠ¡é¢„è§ˆï¼Œä¿®æ”¹å†…å®¹ä¼šæ›´æ–°é¡µé¢"></a>æœ¬åœ°å¯åŠ¨hexoæœåŠ¡é¢„è§ˆï¼Œä¿®æ”¹å†…å®¹ä¼šæ›´æ–°é¡µé¢</h4><p><code>hexo server</code>  ===  <code>hexo s</code></p>
<blockquote>
<ol>
<li><code>hexo server -s</code> #é™æ€æ¨¡å¼</li>
<li><code>hexo server -p 5000</code> #æ›´æ”¹ç«¯å£</li>
<li><code>hexo server -i 192.168.1.1</code> #è‡ªå®šä¹‰ IP </li>
</ol>
</blockquote>
<h4 id="éƒ¨ç½²åˆ°çº¿ä¸Š"><a href="#éƒ¨ç½²åˆ°çº¿ä¸Š" class="headerlink" title="éƒ¨ç½²åˆ°çº¿ä¸Š"></a>éƒ¨ç½²åˆ°çº¿ä¸Š</h4><p><code>hexo deploy</code> ===  <code>hexo d</code></p>
<h4 id="ç»„åˆå‘½ä»¤ï¼Œå¯ä»¥é…ç½®åœ¨package-jsonä¸Š"><a href="#ç»„åˆå‘½ä»¤ï¼Œå¯ä»¥é…ç½®åœ¨package-jsonä¸Š" class="headerlink" title="ç»„åˆå‘½ä»¤ï¼Œå¯ä»¥é…ç½®åœ¨package.jsonä¸Š"></a>ç»„åˆå‘½ä»¤ï¼Œå¯ä»¥é…ç½®åœ¨package.jsonä¸Š</h4><blockquote>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">   &quot;localStart&quot;: &quot;hexo clean &amp;&amp; hexo g &amp;&amp; hexo s &quot;,</span><br><span class="line">   &quot;blogDeployee&quot;: &quot;hexo clean &amp;&amp; hexo g &amp;&amp; hexo d &quot;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>blog</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>lambdaè¡¨è¾¾å¼Collectors.toMapå½“valueä¸ºnullæ—¶æŠ¥é”™</title>
    <url>/2019/08/26/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8FCollectors-toMap%E5%BD%93value%E4%B8%BAnull%E6%97%B6%E6%8A%A5%E9%94%99/</url>
    <content><![CDATA[<h1 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h1><blockquote>
<p>Map.mergeæ–¹æ³•åˆå¹¶æ—¶ï¼Œmergeä¸å…è®¸valueä¸ºnullå¯¼è‡´çš„</p>
</blockquote>
<h2 id="æºç å¦‚ä¸‹"><a href="#æºç å¦‚ä¸‹" class="headerlink" title="æºç å¦‚ä¸‹"></a>æºç å¦‚ä¸‹</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">default</span> V <span class="title">merge</span><span class="params">(K key, V value, </span></span></span><br><span class="line"><span class="function"><span class="params">                BiFunction&lt;? <span class="keyword">super</span> V, ? <span class="keyword">super</span> V, ? extends V&gt; remappingFunction)</span> </span>&#123;</span><br><span class="line">    Objects.requireNonNull(remappingFunction);</span><br><span class="line">    Objects.requireNonNull(value);</span><br><span class="line">    V oldValue = get(key);</span><br><span class="line">    V newValue = (oldValue == <span class="keyword">null</span>) ? value : remappingFunction.apply(oldValue, value);</span><br><span class="line">    <span class="keyword">if</span> (newValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">      remove(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      put(key, newValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newValue;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="è§£å†³çš„åŠæ³•"><a href="#è§£å†³çš„åŠæ³•" class="headerlink" title="è§£å†³çš„åŠæ³•"></a>è§£å†³çš„åŠæ³•</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">fundsSerials.stream()</span><br><span class="line">    .collect(</span><br><span class="line">        Collectors.toMap(</span><br><span class="line">            FundsSerial::getSerialNo,</span><br><span class="line">            fundsSerial -&gt; Optional.of(fundsSerial).map(FundsSerial::getOrderNo).orElse(<span class="string">&quot;&quot;</span>),</span><br><span class="line">            (k1, k2) -&gt; k2));</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä½¿ç”¨ï¼š<code>Optional.of(fundsSerial)</code> æˆ–è€… <code>Optional.ofNullable(fundsSerial)</code> è½¬æˆ <code>optional</code> å¯¹è±¡ï¼Œ</p>
<p>ç„¶åä½¿ç”¨<code>orElse()</code>ï¼Œæ¢æˆé»˜è®¤å€¼ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>lambda</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowså®‰è£…nvmç®¡ç†nodeå’Œnpm</title>
    <url>/2019/08/24/windows%E5%AE%89%E8%A3%85nvm%E7%AE%A1%E7%90%86node%E5%92%8Cnpm/</url>
    <content><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯nvm"><a href="#ä»€ä¹ˆæ˜¯nvm" class="headerlink" title="ä»€ä¹ˆæ˜¯nvm"></a>ä»€ä¹ˆæ˜¯nvm</h1><blockquote>
<p>nvmæ˜¯nodeJSçš„ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œå¯ä»¥è¿è¡Œåœ¨å¤šç§æ“ä½œç³»ç»Ÿä¸Šã€‚nvm for windows æ˜¯ä½¿ç”¨goè¯­è¨€ç¼–å†™çš„è½¯ä»¶ã€‚</p>
</blockquote>
<h1 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h1><p><a href="https://github.com/coreybutler/nvm-windows/releases">nvm-windowsä¸‹è½½åœ°å€</a> </p>
<p>å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/snipaste_20190824_152817.png" alt=""></p>
<ul>
<li>nvm-noinstall.zipï¼š å…å®‰è£…ç‰ˆæœ¬ï¼Œä½†æ˜¯ä½¿ç”¨ä¹‹å‰éœ€è¦é…ç½®ç¯å¢ƒå˜é‡</li>
<li>nvm-setup.zipï¼šå®‰è£…åŒ…ï¼Œä¸‹è½½ä¹‹åç‚¹å‡»å®‰è£…ï¼Œæ— éœ€é…ç½®å°±å¯ä»¥ä½¿ç”¨ã€‚</li>
<li>Source code(zip)ï¼šzipå‹ç¼©çš„æºç </li>
<li>Sourc code(tar.gz)ï¼štar.gzçš„æºç ï¼Œä¸€èˆ¬ç”¨äºUnixç³»ç»Ÿ</li>
</ul>
<h1 id="æ£€æµ‹"><a href="#æ£€æµ‹" class="headerlink" title="æ£€æµ‹"></a>æ£€æµ‹</h1><p>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼Œæ‰“å¼€å‘½ä»¤è¡Œçª—å£ä¸­è¾“å…¥nvm</p>
<ul>
<li>å¦‚æœå‡ºç°nvmç‰ˆæœ¬å·å’Œä¸€ç³»åˆ—å¸®åŠ©æŒ‡ä»¤ï¼Œåˆ™è¯´æ˜nvmå®‰è£…æˆåŠŸã€‚</li>
<li>å¦åˆ™ï¼Œå¯èƒ½ä¼šæç¤º<code>nvm: command not found</code></li>
</ul>
<p><img src="http://image.leonote.cn/snipaste_20190824_135949.png" alt=""></p>
<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><p>nvm for windowsæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œåœ¨æ§åˆ¶å°è¾“å…¥<code>nvm</code>,å°±å¯ä»¥çœ‹åˆ°å®ƒçš„å‘½ä»¤ç”¨æ³•ã€‚</p>
<h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><ul>
<li><code>nvm arch [32|64]</code> ï¼š æ˜¾ç¤ºnodeæ˜¯è¿è¡Œåœ¨32ä½è¿˜æ˜¯64ä½æ¨¡å¼ã€‚å‚æ•°å¯æŒ‡å®š32æˆ–64æ¥è¦†ç›–é»˜è®¤ä½“ç³»ç»“æ„ã€‚</li>
<li><code>nvm install &lt;version&gt; [arch]</code>ï¼š è¯¥å¯ä»¥æ˜¯node.jsç‰ˆæœ¬æˆ–æœ€æ–°ç¨³å®šç‰ˆæœ¬<code>latest</code>ã€‚ï¼ˆå¯é€‰[arch]ï¼‰æŒ‡å®šå®‰è£…32ä½æˆ–64ä½ç‰ˆæœ¬ï¼ˆé»˜è®¤ä¸ºç³»ç»Ÿarchï¼‰ã€‚è®¾ç½®[arch]ä¸º<code>all</code>ä»¥å®‰è£…32å’Œ64ä½ç‰ˆæœ¬ã€‚åœ¨å‘½ä»¤åé¢æ·»åŠ <code>--insecure</code> ï¼Œå¯ä»¥ç»•è¿‡è¿œç«¯ä¸‹è½½æœåŠ¡å™¨çš„SSLéªŒè¯ã€‚</li>
<li><code>nvm list [available]</code>ï¼š åˆ—å‡ºå·²ç»å®‰è£…çš„node.jsç‰ˆæœ¬ã€‚å¯é€‰çš„availableï¼Œæ˜¾ç¤ºå¯ä¸‹è½½ç‰ˆæœ¬çš„éƒ¨åˆ†åˆ—è¡¨ã€‚è¿™ä¸ªå‘½ä»¤å¯ä»¥ç®€å†™ä¸º<code>nvm ls [available]</code>ã€‚</li>
<li><code>nvm on</code>ï¼š å¯ç”¨node.jsç‰ˆæœ¬ç®¡ç†ã€‚</li>
<li><code>nvm off</code>ï¼š ç¦ç”¨node.jsç‰ˆæœ¬ç®¡ç†(ä¸å¸è½½ä»»ä½•ä¸œè¥¿)</li>
<li><code>nvm proxy [url]</code>ï¼š è®¾ç½®ç”¨äºä¸‹è½½çš„ä»£ç†ã€‚ç•™<code>[url]</code>ç©ºç™½ï¼Œä»¥æŸ¥çœ‹å½“å‰çš„ä»£ç†ã€‚è®¾ç½®<code>[url]</code>ä¸º<code>none</code>åˆ é™¤ä»£ç†ã€‚</li>
<li><code>nvm node_mirror [url]</code>ï¼šè®¾ç½®nodeé•œåƒï¼Œé»˜è®¤ä¸º<code>https://nodejs.org/dist/.</code>ã€‚æˆ‘å»ºè®®è®¾ç½®ä¸ºæ·˜å®çš„é•œåƒ<em><a href="https://npm.taobao.org/mirrors/node/">https://npm.taobao.org/mirrors/node/</a></em></li>
<li><code>nvm npm_mirror [url]</code>ï¼šè®¾ç½®npmé•œåƒï¼Œé»˜è®¤ä¸º<code>https://github.com/npm/npm/archive/</code>ã€‚æˆ‘å»ºè®®è®¾ç½®ä¸ºæ·˜å®çš„é•œåƒ<em><a href="https://npm.taobao.org/mirrors/npm/">https://npm.taobao.org/mirrors/npm/</a></em></li>
<li><code>nvm uninstall &lt;version&gt;</code>ï¼š å¸è½½æŒ‡å®šç‰ˆæœ¬çš„nodejsã€‚</li>
<li><code>nvm use [version] [arch]</code>ï¼š åˆ‡æ¢åˆ°ä½¿ç”¨æŒ‡å®šçš„nodejsç‰ˆæœ¬ã€‚å¯ä»¥æŒ‡å®š32/64ä½[arch]ã€‚<code>nvm use &lt;arch&gt;</code>å°†ç»§ç»­ä½¿ç”¨æ‰€é€‰ç‰ˆæœ¬ï¼Œä½†æ ¹æ®æä¾›çš„å€¼åˆ‡æ¢åˆ°32/64ä½æ¨¡å¼çš„<code>&lt;arch&gt;</code></li>
<li><code>nvm root [path]</code>ï¼š è®¾ç½® nvm å­˜å‚¨node.jsä¸åŒç‰ˆæœ¬çš„ç›®å½• ,å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨å½“å‰ç›®å½•ã€‚</li>
<li><code>nvm version</code>ï¼š æ˜¾ç¤ºå½“å‰è¿è¡Œçš„nvmç‰ˆæœ¬ï¼Œå¯ä»¥ç®€å†™ä¸º<code>nvm v</code></li>
</ul>
<h2 id="å®‰è£…æŸä¸ªç‰ˆæœ¬çš„node"><a href="#å®‰è£…æŸä¸ªç‰ˆæœ¬çš„node" class="headerlink" title="å®‰è£…æŸä¸ªç‰ˆæœ¬çš„node"></a>å®‰è£…æŸä¸ªç‰ˆæœ¬çš„node</h2><p>è¿™é‡Œæˆ‘å®‰è£…çš„æ˜¯v12.9.0</p>
<p><code>nvm install 12.9.0</code></p>
<p><code>nvm use 12.9.0</code></p>
<p><img src="http://image.leonote.cn/snipaste_20190824_140027.png" alt=""></p>
<h2 id="é…ç½®ç¯å¢ƒå˜é‡"><a href="#é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡"></a>é…ç½®ç¯å¢ƒå˜é‡</h2><p>æ ¹æ®å®‰è£…nvmæ—¶ï¼Œé€‰æ‹©çš„nodeçš„åœ°å€ï¼Œå¤åˆ¶åˆ°ç³»ç»ŸPathè·¯å¾„ä¸‹</p>
<p><img src="http://image.leonote.cn/snipaste_20190824_155504.png" alt=""></p>
<p>æ–¹ä¾¿å¯ä»¥åœ¨å…¨å±€ä½¿ç”¨ï¼Œä»¥åŠåœ¨git bashä¸­ä½¿ç”¨</p>
<blockquote>
<p>æ³¨æ„ï¼š å®‰è£…å®Œåï¼Œgit bashå¯èƒ½ä¼šæç¤º</p>
<p><code>node: command not found</code> æˆ–è€… <code>npm: command not found</code> </p>
<p>é‡å¯ä¸€ä¸‹å°±å¥½äº†ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>å¼€å‘ç¯å¢ƒ</category>
      </categories>
      <tags>
        <tag>windows</tag>
        <tag>nvm</tag>
        <tag>node</tag>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>äº‹åŠ¡</title>
    <url>/2020/09/06/%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<h1 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h1><h2 id="ä»€ä¹ˆæ˜¯äº‹åŠ¡"><a href="#ä»€ä¹ˆæ˜¯äº‹åŠ¡" class="headerlink" title="ä»€ä¹ˆæ˜¯äº‹åŠ¡"></a>ä»€ä¹ˆæ˜¯äº‹åŠ¡</h2><blockquote>
<p>æ‰€è°“çš„äº‹åŠ¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ“ä½œåºåˆ—ï¼Œè¿™äº›æ“ä½œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚</p>
<p>äº‹åŠ¡æ˜¯æ•°æ®åº“ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§çš„å•ä½ï¼Œåœ¨æ¯ä¸ªäº‹åŠ¡ç»“æŸæ—¶ï¼Œéƒ½èƒ½ä¿æŒæ•°æ®ä¸€è‡´æ€§ã€‚</p>
</blockquote>
<h2 id="äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§"><a href="#äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§" class="headerlink" title="äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§"></a>äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§</h2><h3 id="Atomic-åŸå­æ€§"><a href="#Atomic-åŸå­æ€§" class="headerlink" title="Atomic åŸå­æ€§"></a>Atomic åŸå­æ€§</h3><p>ä¸åŒå¯¹è±¡ä¹‹é—´å¯¹äºåŸå­æ€§å®šä¹‰ä¸åŒï¼š</p>
<ul>
<li><p>äº‹åŠ¡æ€§æ•°æ®åº“(ACIDè¯­å¢ƒä¸‹)ï¼š<strong>åŸå­æ€§æ˜¯æŒ‡ä¸€ç»„å¯¹æ•°æ®åº“çš„æ”¹å˜ï¼Œè¦ä¹ˆæœ€ç»ˆæˆåŠŸæ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±å…¨éƒ¨å›æ»šã€‚</strong>è¿™å°±è¦æ±‚æ•°æ®åº“ç³»ç»Ÿè¦å®ç°æŸç§==å›æ»šçš„æœºåˆ¶==ï¼Œæ¯”å¦‚redo/undo logã€‚    </p>
</li>
<li><p>å¯¹äºæ”¯æŒå¹¶å‘çš„ç¼–ç¨‹è¯­è¨€(Javaã€C++ç­‰)ï¼šåŸå­æ€§æ˜¯æŒ‡<strong><em>ä¸€ç»„æŒ‡ä»¤è¢«æ‰§è¡Œæ—¶ï¼Œä¸å—å…¶ä»–æŒ‡ä»¤çš„å¹²æ‰°</em></strong>ã€‚æ¯”å¦‚â€ç»™ä¸€ä¸ªæ•´å‹å˜é‡èµ‹å€¼æ˜¯åŸå­çš„â€œç­‰ç­‰ã€‚</p>
</li>
<li><p>ä¸€äº›<code>NoSQL</code>çš„æ•°æ®åº“(<code>Redis</code>)ï¼š äº‹åŠ¡çš„åŸå­æ€§çš„æ„æ€æ›´æ¥è¿‘äº<strong><em>â€œä¸€ç»„æŒ‡ä»¤è¢«æ‰§è¡Œæ—¶ï¼Œä¸å—å…¶ä»–æŒ‡ä»¤çš„å¹²æ‰°â€</em></strong>ï¼Œè€Œä¸æ˜¯â€œå¯ä»¥å›æ»šâ€ã€‚</p>
</li>
</ul>
<h3 id="Consistency-ä¸€è‡´æ€§"><a href="#Consistency-ä¸€è‡´æ€§" class="headerlink" title="Consistency ä¸€è‡´æ€§"></a>Consistency ä¸€è‡´æ€§</h3><p>ä¸åŒçš„ç¯å¢ƒä¸‹æœ‰ç€ä¸åŒçš„å«ä¹‰ï¼š</p>
<ol>
<li>å¤šå‰¯æœ¬çš„ä¸€è‡´æ€§</li>
<li>ä¸€è‡´æ€§hash</li>
<li>CAPç†è®ºçš„ä¸€è‡´æ€§</li>
<li>ACIDé‡Œçš„ä¸€è‡´æ€§</li>
</ol>
<h4 id="ACIDè¯­å¢ƒä¸‹çš„ä¸€è‡´æ€§"><a href="#ACIDè¯­å¢ƒä¸‹çš„ä¸€è‡´æ€§" class="headerlink" title="ACIDè¯­å¢ƒä¸‹çš„ä¸€è‡´æ€§"></a>ACIDè¯­å¢ƒä¸‹çš„ä¸€è‡´æ€§</h4><p>AID éƒ½æ˜¯æ•°æ®åº“çš„ç‰¹å¾ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ•°æ®åº“çš„å…·ä½“å®ç°ã€‚ä½†æ˜¯å”¯ç‹¬Cä¸ä¸€æ ·ï¼Œ<strong>å®ƒéœ€è¦ä¾èµ–äºåº”ç”¨å±‚ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–äºå¼€å‘è€…çš„å…·ä½“å®ç°ã€‚</strong> <strong>è¿™é‡Œçš„ä¸€è‡´æ€§æ˜¯æŒ‡ç³»ç»Ÿä»ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼Œè¿ç§»åˆ°å¦ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ã€‚</strong></p>
<p><strong>æ­£ç¡®çš„çŠ¶æ€ï¼šå°±æ˜¯å½“å‰çš„çŠ¶æ€æ»¡è¶³é¢„å®šçš„çº¦æŸï¼ˆä¸šåŠ¡ä¸Šçš„è¦æ±‚ï¼‰å°±å«åšæ­£ç¡®çš„çŠ¶æ€ã€‚</strong></p>
<blockquote>
<p>ä¸šåŠ¡çš„æ•°æ®ä¸€è‡´æ€§ä¸€èˆ¬ç”¨<strong>æ­£ç¡®çš„ä¸šåŠ¡ä»£ç </strong> + <strong>å®šæ—¶ä»»åŠ¡</strong> + <strong>æ•°æ®åº“è‡ªèº«çš„ç®€å•åˆæ³•æ€§é˜²æŠ¤ï¼ˆäº‹åŠ¡çš„AIDã€é”ç­‰ï¼‰</strong>ä¸€èµ·å®ç°ã€‚</p>
</blockquote>
<h3 id="Isolation-éš”ç¦»æ€§"><a href="#Isolation-éš”ç¦»æ€§" class="headerlink" title="Isolation éš”ç¦»æ€§"></a>Isolation éš”ç¦»æ€§</h3><p>ä¸€ç»„å¯¹æ•°æ®åº“çš„å¹¶å‘ä¿®æ”¹äº’ç›¸ä¸å½±å“ã€‚</p>
<ol>
<li>å¹¶å‘ä¿®æ”¹çš„æ˜¯äº’ä¸ç›¸å¹²çš„æ•°æ®ï¼Œæœ¬èº«å°±æ»¡è¶³éš”ç¦»çš„æ¡ä»¶</li>
<li>å¹¶å‘ä¿®æ”¹çš„æ˜¯ç›¸å…³è”çš„ï¼Œæˆ–è€…å°±æ˜¯åŒä¸€ä»½æ•°æ®ï¼Œå°±å¿…ç„¶ä¼šç›¸äº’å½±å“ã€‚</li>
</ol>
<p>ä¿è¯éš”ç¦»æ€§çš„ä¸»è¦é—®é¢˜ä¸åœ¨äºéš”ç¦»æœ¬èº«ï¼šè€Œåœ¨äº<strong>å¦‚æœå°†è¯»å–ä½œä¸ºå¯¹æ•°æ®ä¿®æ”¹çš„å‰ææ¡ä»¶ï¼Œä¹‹ååœ¨å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„ä¸€åˆ¹é‚£ï¼Œè¯»å–æ—¶çš„å‰ææ¡ä»¶è¿˜æ˜¯å¦æ»¡è¶³</strong>ã€‚æ¯•ç«Ÿè¯»å–å’Œå†™å…¥æ˜¯ä¸¤ä¸ªåˆ†å¼€çš„æŒ‡ä»¤ï¼Œè€Œåœ¨è¿™ä¸¤ä¸ªæŒ‡ä»¤ä¸­é—´å¯èƒ½å¤¹æ‚å…¶ä»–äº‹åŠ¡å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚ï¼ˆå¦‚ï¼šæ‰¾åˆ°å¯ç”¨çš„åº“å­˜ï¼Œæœ‰åˆ™æ‰£å‡ï¼Œæ²¡æœ‰åˆ™æç¤ºç¼ºè´§ï¼‰</p>
<p>ä¿æŒéš”ç¦»æ€§åšæ³•ï¼šä¿è¯å¯¹å…³è”æ•°æ®çš„ä¿®æ”¹ä¸²è¡ŒåŒ–(<code>SERIALIZABLE</code>) ï¼Œå¦‚ï¼šåŠ é”ï¼Œä½†æ˜¯é”å¯¹æ•°æ®åº“å¹¶å‘çš„æ€§èƒ½è´Ÿé¢å½±å“å¾ˆå¤§ï¼Œæ‰€ä»¥å‡ºç°äº†å‡ ç§å¼±ä¸€äº›çš„éš”ç¦»æ€§ä¿è¯</p>
<ol>
<li><code>READ UNCOMMITTED</code></li>
<li><code>READ COMMITTED</code></li>
<li><code>REPEATABLE READ</code></li>
</ol>
<h3 id="Durability-æŒä¹…æ€§"><a href="#Durability-æŒä¹…æ€§" class="headerlink" title="Durability æŒä¹…æ€§"></a>Durability æŒä¹…æ€§</h3><p>æ˜¯æŒ‡å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œä¸€æ—¦å®Œæˆï¼Œè¯¥ç»“æœå°±åº”å½“æ°¸è¿œä¸ä¸¢å¤±ã€‚</p>
<p>åœ¨ç°å®å½“ä¸­ï¼Œ</p>
<ul>
<li>ä¸€èˆ¬é€šè¿‡æŒä¹…æ€§å­˜å‚¨è®¾å¤‡ï¼ˆæ¯”å¦‚ç£ç›˜/SSDï¼‰å†™å…¥å¹¶åˆ·æ–°æ¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚</li>
<li>å¦‚æœè§‰å¾—ä¸€ä¸ªèŠ‚ç‚¹ä¸é è°±ï¼Œå¯ä»¥å¢åŠ å¤šä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰ä¸€èµ·æ¥ä¿è¯æŒä¹…ï¼›</li>
<li>å¦‚æœè§‰å¾—è¿™æ ·è¿˜ä¸å¤Ÿé è°±ï¼Œå¯ä»¥åœ¨ä¸åŒçš„åœ°ç†ä½ç½®çš„å¦ä¸€ä¸ªæ•°æ®ä¸­å¿ƒåšå¤‡ä»½ã€‚</li>
</ul>
<p>å®é™…ä¸Š<strong><em>ç»å¯¹çš„æŒä¹…æ€§æ˜¯ä¸å­˜åœ¨çš„</em></strong>ï¼Œå› ä¸ºæ•´ä¸ªå­˜å‚¨å±‚é¢æœ‰å¾ˆå¤šä¸ç¡®å®šå› ç´ ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿæœ¬èº«<code>fsyncæŒ‡ä»¤</code>å®ç°æœ‰bugï¼Œç£ç›˜çš„å›ºä»¶æœ‰bugï¼Œä¾›ç”µå‡ºç°é—®é¢˜é€ æˆæ•°æ®é”™ä¹±ï¼Œå¼‚æ­¥çš„æ•°æ®å¤åˆ¶æ²¡æœ‰ç”Ÿæ•ˆç­‰ç­‰ã€‚</p>
<p>æ‰€ä»¥åœ¨ç°å®å½“ä¸­çš„æ•°æ®åº“ï¼Œåªèƒ½åœ¨å½“å‰æˆæœ¬å’ŒæŠ€æœ¯é™åˆ¶çš„çº¦æŸä¸‹ï¼Œå°½é‡ç»´æŒä¸€å®šç¨‹åº¦çš„æŒä¹…æ€§ã€‚</p>
<blockquote>
<p>æ€»ç»“ï¼šäº‹åŠ¡æ€§æ•°æ®åº“å®ç°çš„æ˜¯</p>
<ul>
<li>æ”¯æŒæœªå®Œæˆçš„æ•°æ®ä¿®æ”¹å›æ»šçš„æœºåˆ¶ï¼Œå¯¹åº”â€œåŸå­æ€§â€</li>
<li>åŠ›æ‰€èƒ½åŠçš„æ•°æ®åˆæ³•æ€§æ£€æŸ¥ï¼Œå¯¹åº”â€œä¸€è‡´æ€§â€</li>
<li>ä¿è¯æ•°æ®å¹¶å‘çš„ä¿®æ”¹çš„è§„åˆ™ï¼Œå¯¹åº”â€œéš”ç¦»æ€§â€</li>
<li>ä½¿ç”¨åŸºäºæŒä¹…åŒ–å­˜å‚¨ï¼ˆç£ç›˜ã€SSDï¼‰çš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨ï¼Œå¯¹åº”â€œæŒä¹…æ€§â€</li>
</ul>
</blockquote>
<h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><ul>
<li><code>Read uncommitted</code>ï¼šå³ä½¿ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°è¯­å¥æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯åˆ«çš„äº‹åŠ¡å¯ä»¥è¯»åˆ°è¿™ä¸ªæ”¹å˜ï¼Œé¸¡è‚‹ä¸€èˆ¬çš„å­˜åœ¨ã€‚</li>
<li><code>Read committed</code>ï¼šä¸€ä¸ªäº‹åŠ¡èƒ½çœ‹åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€æ¡æ•°æ®è®°å½•å·²ç»æäº¤çš„ä¿®æ”¹ã€‚</li>
<li><code>Repeatable read</code>ï¼šä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡Œä¸¤æ¬¡æˆ–å¤šæ¬¡åŒæ ·çš„å¯¹äºæ•°æ®å†…å®¹çš„æŸ¥è¯¢ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†ä¸ä¿è¯å¯¹äºæ•°æ®æ¡æ•°çš„æŸ¥è¯¢æ˜¯ä¸€æ ·çš„ã€‚</li>
<li><code>Serializable</code>ï¼šäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œä¸å…è®¸å¹¶å‘æ‰§è¡Œã€‚</li>
</ul>
<h3 id="Repeatable-read-ç¤ºä¾‹"><a href="#Repeatable-read-ç¤ºä¾‹" class="headerlink" title="Repeatable read ç¤ºä¾‹"></a>Repeatable read ç¤ºä¾‹</h3><p>Repeatable Read çš„ç›´è§‚æ„Ÿè§‰ä»¿ä½›æ˜¯ç»™äº‹åŠ¡åšä¸€ä¸ªæ•´ä¸ªæ•°æ®åº“åšäº†ä¸€ä¸ªå¿«ç…§ï¼Œ æ‰€ä»¥å¾ˆå¤šæ—¶å€™è¿™ç§éš”ç¦»çº§åˆ«åˆè¢«ç§°ä¸º<strong>Snapshot Isolation</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>äº‹åŠ¡A</th>
<th>äº‹åŠ¡B</th>
</tr>
</thead>
<tbody><tr>
<td>get x (å¾—åˆ°0)</td>
<td></td>
</tr>
<tr>
<td></td>
<td>set x = 1</td>
</tr>
<tr>
<td></td>
<td>commit</td>
</tr>
<tr>
<td>get x (å¾—åˆ°0)</td>
<td></td>
</tr>
<tr>
<td>commit</td>
<td></td>
</tr>
</tbody></table>
<p>â€œå¿«ç…§â€çš„åŠŸèƒ½åœ¨ä¸€äº›åœºæ™¯ä¸‹éå¸¸é‡è¦ï¼Œå¦‚ï¼š</p>
<ul>
<li><p><strong>æ•°æ®å¤‡ä»½</strong>ï¼šä¾‹å¦‚æ•°æ®åº“Sä»æ•°æ®åº“Mä¸­å¤åˆ¶æ•°æ®ï¼Œä½†æ˜¯åŒæ—¶Mæ•°æ®åº“åˆè¢«æŒç»­ä¿®æ”¹ã€‚Séœ€è¦æ‹¿åˆ°ä¸€ä¸ªMçš„æ•°æ®å¿«ç…§ï¼Œä½†æ˜¯åˆä¸èƒ½çœŸçš„æŠŠMç»™åœäº†ã€‚</p>
</li>
<li><p><strong>æ•°æ®åˆæ³•æ€§æ£€æŸ¥</strong>ï¼šä¾‹å¦‚æœ‰ä¸¤å¼ æ•°æ®è¡¨ï¼Œä¸€å¼ è®°å½•äº†å½“æ—¶çš„äº¤æ˜“æ€»é¢ï¼Œå¦å¤–ä¸€å¼ è¡¨è®°å½•äº†æ¯ä¸ªäº¤æ˜“çš„é‡‘é¢ã€‚</p>
</li>
</ul>
<p>==é‚£ä¹ˆåœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¿«ç…§çš„å­˜åœ¨ï¼Œäº¤æ˜“é‡‘é¢çš„æ€»å’Œå¯èƒ½ä¸å½“æ—¶çš„äº¤æ˜“æ€»é¢å¯¹ä¸ä¸Šï¼Œ==</p>
<p>==å› ä¸ºéšç€æ£€æŸ¥äº‹åŠ¡çš„è¿›è¡Œï¼Œæ–°çš„äº¤æ˜“è®°å½•æ•°æ®ä¼šè¢«æäº¤ã€‚è¿™äº›æ–°çš„æäº¤ä¼šè¢«æ£€æŸ¥äº‹åŠ¡çœ‹åˆ°ã€‚==</p>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<p>å¦‚æœæ˜¯åŸºäº<code>MVCC</code>çš„å®ç°ï¼Œ<code>Repeatable Read</code>å¯ä»¥å®Œå…¨é¿å…å¹»è¯»ã€‚</p>
<p>æ— è®º<code>MySQL</code>è¿˜æ˜¯<code>PostgreSQL</code>åœ¨<code>Repeatable Read</code>éš”ç¦»çº§åˆ«éƒ½ä¸ä¼šå‡ºç°å¹»è¯»ã€‚</p>
</blockquote>
<h3 id="æ•°æ®åº“å¹¶å‘æ“ä½œäº§ç”Ÿçš„é—®é¢˜"><a href="#æ•°æ®åº“å¹¶å‘æ“ä½œäº§ç”Ÿçš„é—®é¢˜" class="headerlink" title="æ•°æ®åº“å¹¶å‘æ“ä½œäº§ç”Ÿçš„é—®é¢˜"></a>æ•°æ®åº“å¹¶å‘æ“ä½œäº§ç”Ÿçš„é—®é¢˜</h3><h4 id="ä¸¢å¤±æ›´æ–°"><a href="#ä¸¢å¤±æ›´æ–°" class="headerlink" title="ä¸¢å¤±æ›´æ–°"></a>ä¸¢å¤±æ›´æ–°</h4><h5 id="ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°é—®é¢˜"><a href="#ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°é—®é¢˜" class="headerlink" title="ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°é—®é¢˜"></a>ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°é—®é¢˜</h5><p>æ­¤ç§æ›´æ–°ä¸¢å¤±æ˜¯å› ä¸ºå›æ»šçš„åŸå› ï¼Œæ‰€ä»¥ä¹Ÿå«==å›æ»šä¸¢å¤±==ã€‚</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>å–æ¬¾äº‹åŠ¡A</th>
<th>è½¬è´¦äº‹åŠ¡B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>å¼€å§‹äº‹åŠ¡</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>å¼€å§‹äº‹åŠ¡</td>
</tr>
<tr>
<td>T3</td>
<td>æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ</td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>æ±‡å…¥100å…ƒæŠŠä½™é¢æ”¹ä¸º1100å…ƒ</td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>æäº¤äº‹åŠ¡</td>
</tr>
<tr>
<td>T7</td>
<td>å–å‡º100å…ƒæŠŠä½™é¢æ”¹ä¸º900å…ƒ</td>
<td></td>
</tr>
<tr>
<td>T8</td>
<td>æ’¤é”€äº‹åŠ¡ï¼Œä½™é¢æ¢å¤ä¸º1000 å…ƒï¼ˆä¸¢å¤±æ›´æ–°ï¼‰</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>æ³¨æ„ï¼š Aäº‹åŠ¡åœ¨æ’¤é”€æ—¶ï¼Œå°†Bäº‹åŠ¡å·²ç»è½¬å…¥è´¦æˆ·çš„é‡‘é¢ç»™æŠ¹å»äº†ï¼Œæ­¤æ—¶ä½™é¢ä¸º1000å…ƒã€‚</p>
</blockquote>
<h5 id="ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜"><a href="#ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜" class="headerlink" title="ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜"></a>ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜</h5><p>æ­¤ç§æ›´æ–°ä¸¢å¤±æ˜¯å› ä¸ºæ›´æ–°è¢«å…¶ä»–äº‹åŠ¡ç»™è¦†ç›–äº†ï¼Œä¹Ÿå¯ä»¥å«==è¦†ç›–ä¸¢å¤±==ã€‚</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>è½¬è´¦äº‹åŠ¡A</th>
<th>å–æ¬¾äº‹åŠ¡B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td></td>
<td>å¼€å§‹äº‹åŠ¡</td>
</tr>
<tr>
<td>T2</td>
<td>å¼€å§‹äº‹åŠ¡</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td></td>
<td>æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ</td>
</tr>
<tr>
<td>T4</td>
<td>æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ</td>
<td></td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>å–å‡º100å…ƒæŠŠä½™é¢æ”¹ä¸º900å…ƒ</td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>æäº¤äº‹åŠ¡</td>
</tr>
<tr>
<td>T7</td>
<td>æ±‡å…¥100å…ƒ</td>
<td></td>
</tr>
<tr>
<td>T8</td>
<td>æäº¤äº‹åŠ¡ï¼ŒæŠŠä½™é¢æ”¹ä¸º1100 å…ƒï¼ˆä¸¢å¤±æ›´æ–°ï¼‰</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>æ³¨æ„ï¼šAäº‹åŠ¡æŠŠBäº‹åŠ¡çš„é‡‘é¢ä¿®æ”¹äº†ï¼Œæ­¤æ—¶ä½™é¢ä¸º1100å…ƒã€‚</p>
</blockquote>
<h4 id="è„è¯»"><a href="#è„è¯»" class="headerlink" title="è„è¯»"></a>è„è¯»</h4><p>Aäº‹åŠ¡è¯»å–Bäº‹åŠ¡å°šæœªæäº¤çš„æ›´æ”¹æ•°æ®ï¼Œå¹¶åœ¨è¿™ä¸ªæ•°æ®çš„åŸºç¡€ä¸Šè¿›è¡Œæ“ä½œã€‚</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>å‘˜å·¥äº‹åŠ¡A</th>
<th>è€æ¿äº‹åŠ¡B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td></td>
<td>å¼€å§‹äº‹åŠ¡</td>
</tr>
<tr>
<td>T2</td>
<td>å¼€å§‹äº‹åŠ¡</td>
<td></td>
</tr>
<tr>
<td>T3</td>
<td></td>
<td>ç»™å‘˜å·¥è´¦æˆ·è½¬è´¦5000å…ƒ</td>
</tr>
<tr>
<td>T4</td>
<td>æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º5000å…ƒ(è„è¯»)</td>
<td></td>
</tr>
<tr>
<td>T5</td>
<td>æäº¤äº‹åŠ¡</td>
<td></td>
</tr>
<tr>
<td>T6</td>
<td></td>
<td>æ’¤é”€äº‹åŠ¡</td>
</tr>
<tr>
<td>T7</td>
<td></td>
<td>å¼€å§‹äº‹åŠ¡</td>
</tr>
<tr>
<td>T8</td>
<td></td>
<td>ç»™å‘˜å·¥è´¦æˆ·è½¬è´¦2000å…ƒ</td>
</tr>
<tr>
<td>T9</td>
<td></td>
<td>æäº¤äº‹åŠ¡</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>è§£é‡Š</strong></p>
<p>â€‹    å…¬å¸å‘å·¥èµ„äº†ï¼Œé¢†å¯¼æŠŠ5000å…ƒæ‰“åˆ°å‘˜å·¥çš„è´¦å·ä¸Šï¼Œä½†æ˜¯è¯¥äº‹åŠ¡å¹¶æœªæäº¤ï¼Œè€Œå‘˜å·¥æ­£å¥½å»æŸ¥çœ‹è´¦æˆ·ï¼Œå‘ç°5000å…ƒå·¥èµ„åˆ°è´¦ã€‚ä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œé¢†å¯¼å‘ç°å‘ç»™å‘˜å·¥çš„å‘çš„å·¥èµ„é‡‘é¢ä¸å¯¹ï¼Œæ˜¯2000å…ƒï¼Œäºæ˜¯å›æ»šäº†äº‹åŠ¡ï¼Œä¿®æ”¹ä¸º2000åï¼Œå°†äº‹åŠ¡æäº¤ï¼Œæœ€åå‘˜å·¥å®é™…çš„å·¥èµ„æ˜¯åªæœ‰ 2000å…ƒã€‚</p>
</blockquote>
<h4 id="ä¸å¯é‡å¤è¯»"><a href="#ä¸å¯é‡å¤è¯»" class="headerlink" title="ä¸å¯é‡å¤è¯»"></a>ä¸å¯é‡å¤è¯»</h4><p>æ˜¯æŒ‡åœ¨Aäº‹åŠ¡å†…ï¼Œå¤šæ¬¡è¯»åŒä¸€æ•°æ®ï¼Œä½†æ˜¯ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®å†…å®¹ä¸ä¸€æ ·ã€‚ï¼ˆå³ä¸èƒ½è¯»åˆ°ç›¸åŒçš„æ•°æ®å†…å®¹ï¼‰</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>å‘˜å·¥äº‹åŠ¡A</th>
<th>å‘˜å·¥è€å©†äº‹åŠ¡B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>å¼€å§‹äº‹åŠ¡</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>å¼€å§‹äº‹åŠ¡</td>
</tr>
<tr>
<td>T3</td>
<td>å‡†å¤‡ä»˜æ¬¾ï¼ŒæŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º2000å…ƒ</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>ç½‘ä¸Šè½¬è´¦2000å…ƒ</td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>æäº¤äº‹åŠ¡</td>
</tr>
<tr>
<td>T6</td>
<td>ä»˜æ¬¾ï¼ŒæŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º0å…ƒï¼Œä»˜æ¬¾å¤±è´¥</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>æäº¤äº‹åŠ¡</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p><strong>è§£é‡Š</strong></p>
<p>å‘˜å·¥æ‹¿ç€å·¥èµ„å¡å»æ¶ˆè´¹ï¼Œç³»ç»Ÿè¯»å–åˆ°å¡é‡Œç¡®å®æœ‰2000å…ƒï¼Œè€Œæ­¤æ—¶ä»–è€å©†ä¹Ÿæ­£å¥½åœ¨ç½‘ä¸Šè½¬è´¦ï¼ŒæŠŠå·¥èµ„å¡çš„2000å…ƒè½¬åˆ°å¦ä¸€è´¦æˆ·ï¼Œ å¹¶åœ¨å‘˜å·¥ä¹‹å‰æäº¤äº†äº‹åŠ¡ï¼Œå½“å‘˜å·¥è¿›è¡Œæ‰£æ¬¾æ—¶ï¼Œç³»ç»Ÿæ£€æŸ¥åˆ°å‘˜å·¥çš„å·¥èµ„å¡å·²ç»æ²¡æœ‰é’±ï¼Œæ‰£æ¬¾å¤±è´¥ã€‚</p>
</blockquote>
<h4 id="å¹»è¯»"><a href="#å¹»è¯»" class="headerlink" title="å¹»è¯»"></a>å¹»è¯»</h4><p>æ˜¯æŒ‡å½“äº‹åŠ¡ä¸æ˜¯ç‹¬ç«‹æ‰§è¡Œæ—¶å‘ç”Ÿçš„ä¸€ç§ç°è±¡ï¼ŒAäº‹åŠ¡å¯¹ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™ç§ä¿®æ”¹æ¶‰åŠåˆ°è¡¨ä¸­çš„å…¨éƒ¨æ•°æ®è¡Œã€‚åŒæ—¶ï¼ŒBäº‹åŠ¡ä¹Ÿä¿®æ”¹è¿™ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œè¿™ç§ä¿®æ”¹æ˜¯å‘è¡¨ä¸­æ’å…¥æˆ–åˆ é™¤ä¸€è¡Œæ•°æ®ã€‚é‚£ä¹ˆï¼Œæ“ä½œAäº‹åŠ¡çš„ç”¨æˆ·ä¼šå‘ç°è¡¨ä¸­è¿˜æœ‰å°šæœªè¢«ä¿®æ”¹çš„æ•°æ®è¡Œï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ã€‚</p>
<table>
<thead>
<tr>
<th>æ—¶é—´</th>
<th>å‘˜å·¥è€å©†äº‹åŠ¡A</th>
<th>å‘˜å·¥äº‹åŠ¡B</th>
</tr>
</thead>
<tbody><tr>
<td>T1</td>
<td>å¼€å§‹äº‹åŠ¡</td>
<td></td>
</tr>
<tr>
<td>T2</td>
<td></td>
<td>å¼€å§‹äº‹åŠ¡</td>
</tr>
<tr>
<td>T3</td>
<td>æŸ¥è¯¢ä¿¡ç”¨å¡çš„æ¶ˆè´¹è®°å½•æ€»é¢ä¸º80å…ƒ</td>
<td></td>
</tr>
<tr>
<td>T4</td>
<td></td>
<td>å®¢æˆ·åº”é…¬ï¼Œä¿¡ç”¨å¡ä»˜æ¬¾1000å…ƒ</td>
</tr>
<tr>
<td>T5</td>
<td></td>
<td>æäº¤äº‹åŠ¡</td>
</tr>
<tr>
<td>T6</td>
<td>æ‰“å°ä¿¡ç”¨å¡è´¦å•ï¼Œæ€»é¢ä¸º1080å…ƒï¼ˆå¹»è¯»ï¼‰</td>
<td></td>
</tr>
<tr>
<td>T7</td>
<td>æäº¤äº‹åŠ¡</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p><strong>è§£é‡Š</strong>    </p>
<p>å‘˜å·¥è€å©†æ—¶å¸¸æŸ¥çœ‹å‘˜å·¥çš„ä¿¡ç”¨å¡æ¶ˆè´¹è®°å½•ã€‚æœ‰ä¸€å¤©ï¼Œå¥¹æ­£åœ¨æŸ¥è¯¢åˆ°å‘˜å·¥å½“æœˆä¿¡ç”¨å¡çš„æ€»æ¶ˆè´¹é‡‘é¢ </p>
<p>ï¼ˆ<code>select sum(amount) from transaction where month = æœ¬æœˆ</code>ï¼‰ä¸º80å…ƒï¼Œè€Œå‘˜å·¥æ­¤æ—¶æ­£å¥½åº”é…¬å®Œååœ¨æ”¶é“¶å°ä¹°å•ï¼Œæ¶ˆè´¹äº†1000å…ƒï¼Œå³æ–°å¢äº†ä¸€æ¡1000å…ƒçš„æ¶ˆè´¹è®°å½•ï¼ˆ<code>insert transaction ...</code> ï¼‰ï¼Œå¹¶æäº¤äº‹åŠ¡ï¼Œéšåå‘˜å·¥è€å©†æ‰“å°å½“æœˆä¿¡ç”¨å¡ç« æ³•ï¼Œå´å‘ç°æ¶ˆè´¹æ€»é¢ä¸º1080å…ƒï¼Œå‘˜å·¥è€å©†å¾ˆè¯§å¼‚ï¼Œä»¥ä¸ºå‡ºç°äº†å¹»è§‰ï¼Œå¹»è¯»å°±è¿™æ ·äº§ç”Ÿäº†ã€‚</p>
</blockquote>
<p><strong>å¹»è¯»å’Œä¸å¯é‡å¤è¯»å¼ºè°ƒçš„ç»´åº¦ä¸ä¸€æ ·:</strong></p>
<ol>
<li><strong>ä¸å¯é‡å¤è¯»æ˜¯æŒ‡Aæ“ä½œæ•°æ®æ—¶ï¼ŒBå¯ä»¥ä¿®æ”¹è¯¥è¡Œæ•°æ®ã€‚</strong></li>
<li><strong>å¹»è¯»æ˜¯æŒ‡Aæ“ä½œæ•°æ®æ—¶ï¼ŒBå¯ä»¥æ–°å¢/åˆ é™¤ä¸€æ¡æ•°æ®ï¼ˆæ˜¯å¯¹æ€»è®°å½•æ•°æœ‰å½±å“çš„ï¼‰ã€‚</strong></li>
</ol>
<h3 id="éš”ç¦»çº§åˆ«å¯¹å¼‚å¸¸çš„æ§åˆ¶èƒ½åŠ›"><a href="#éš”ç¦»çº§åˆ«å¯¹å¼‚å¸¸çš„æ§åˆ¶èƒ½åŠ›" class="headerlink" title="éš”ç¦»çº§åˆ«å¯¹å¼‚å¸¸çš„æ§åˆ¶èƒ½åŠ›"></a>éš”ç¦»çº§åˆ«å¯¹å¼‚å¸¸çš„æ§åˆ¶èƒ½åŠ›</h3><table>
<thead>
<tr>
<th><strong>éš”ç¦»çº§åˆ«\å¹¶å‘é—®é¢˜</strong></th>
<th><strong>ç¬¬ä¸€ç±»æ›´æ–°ä¸¢å¤±</strong></th>
<th><strong>è„è¯»</strong></th>
<th><strong>ä¸å¯é‡å¤è¯»</strong></th>
<th><strong>ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°</strong></th>
<th><strong>å¹»è¯»</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>Read uncommitted</code></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td><code>Read committed</code></td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>Yï¼ˆ<code>MVVC</code>-&gt; Nï¼‰</td>
</tr>
<tr>
<td><code>Repeatable read</code></td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>Yï¼ˆ<code>MVVC</code>-&gt; Nï¼‰</td>
</tr>
<tr>
<td><code>Serializable</code></td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>N</td>
</tr>
</tbody></table>
<h1 id="å†™å‰æå›°å¢ƒ"><a href="#å†™å‰æå›°å¢ƒ" class="headerlink" title="å†™å‰æå›°å¢ƒ"></a>å†™å‰æå›°å¢ƒ</h1><p>ä¸šåŠ¡ä»£ç ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>å…ˆè¯»å–ä¸€æ®µç°æœ‰çš„æ•°æ®ï¼›</li>
<li>åœ¨è¿™ä¸ªæ•°æ®çš„åŸºç¡€ä¸Šåšé€»è¾‘åˆ¤æ–­æˆ–è€…è®¡ç®—ï¼›</li>
<li>å°†è®¡ç®—çš„ç»“æœå†™å›æ•°æ®åº“ï¼›</li>
</ol>
<p>ç¬¬ä¸‰æ­¥çš„å†™å…¥ä¼š<strong>ä¾èµ–</strong>ç¬¬ä¸€æ­¥çš„è¯»å–ã€‚è€Œä¸”åœ¨1å’Œ3ä¹‹é—´ï¼Œä¸ç®¡ä¸šåŠ¡ä»£ç ç¦»å¾—æœ‰å¤šè¿‘ï¼Œéƒ½æ— æ³•é¿å…å…¶ä»–äº‹åŠ¡çš„å¹¶å‘ä¿®æ”¹ã€‚å³ï¼šåœ¨å½“å‰äº‹åŠ¡è¯»å–è¿™æ®µæ•°æ®åï¼Œåˆæœ‰å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ï¼Œè€Œå½“å‰äº‹åŠ¡å°†ç»“æœå†™å›æ•°æ®åº“ï¼Œä¼šé€ æˆå¦ä¸€ä¸ªäº‹åŠ¡çš„ä¿®æ”¹ä¸¢å¤±ã€‚</p>
<blockquote>
<p>è¿™ä¸ªé—®é¢˜å°±æ˜¯<strong>åœ¨ä¿®æ”¹çš„äº‹åŠ¡åœ¨æäº¤æ—¶ï¼Œæ— æ³•ç¡®ä¿è¿™ä¸ªä¿®æ”¹çš„å‰ææ˜¯å¦è¿˜å¯é </strong>ã€‚è¿™ç§é—®é¢˜ç§°ä¹‹ä¸º<strong>å†™å‰æå›°å¢ƒ</strong>ã€‚</p>
</blockquote>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><ul>
<li>äº‹åŠ¡éš”ç¦»çº§åˆ«ç”¨<code>Serializable</code>ï¼›</li>
<li>åŠ æ‚²è§‚é”ï¼›å†™å…¥è¾ƒå¤šçš„æƒ…å†µ</li>
<li>åŠ ä¹è§‚é”ï¼›è¯»å–è¾ƒå¤šçš„æƒ…å†µ</li>
</ul>
]]></content>
      <categories>
        <category>äº‹åŠ¡</category>
      </categories>
      <tags>
        <tag>äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title>7å¤§ç¼“å­˜ç»å…¸é—®é¢˜</title>
    <url>/2020/11/23/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-7%E5%A4%A7%E7%BC%93%E5%AD%98%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="7å¤§ç¼“å­˜ç»å…¸é—®é¢˜"><a href="#7å¤§ç¼“å­˜ç»å…¸é—®é¢˜" class="headerlink" title="7å¤§ç¼“å­˜ç»å…¸é—®é¢˜"></a>7å¤§ç¼“å­˜ç»å…¸é—®é¢˜</h1><p><img src="http://image.leonote.cn/20201123134403.png" alt=""></p>
<h2 id="ç¬¬ä¸€ä¸ªç»å…¸é—®é¢˜-ç¼“å­˜å¤±æ•ˆ"><a href="#ç¬¬ä¸€ä¸ªç»å…¸é—®é¢˜-ç¼“å­˜å¤±æ•ˆ" class="headerlink" title="ç¬¬ä¸€ä¸ªç»å…¸é—®é¢˜-ç¼“å­˜å¤±æ•ˆ"></a>ç¬¬ä¸€ä¸ªç»å…¸é—®é¢˜-ç¼“å­˜å¤±æ•ˆ</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>æœåŠ¡ç³»ç»ŸæŸ¥æ•°æ®ï¼Œé¦–å…ˆä¼šæŸ¥ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå°±è¿›ä¸€æ­¥æŸ¥ DBï¼Œæœ€åæŸ¥åˆ°æ•°æ®åå›ç§åˆ°ç¼“å­˜å¹¶è¿”å›ã€‚</p>
<p>ç¼“å­˜çš„æ€§èƒ½æ¯” DB é«˜ 50~100 å€ä»¥ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æ•°æ®æŸ¥è¯¢å°½å¯èƒ½å‘½ä¸­ç¼“å­˜ï¼Œè¿™æ ·ç³»ç»Ÿè´Ÿè·æœ€å°ï¼Œæ€§èƒ½æœ€ä½³ã€‚</p>
<p>ç¼“å­˜é‡Œçš„æ•°æ®å­˜å‚¨åŸºæœ¬ä¸Šéƒ½æ˜¯ä»¥ key ä¸ºç´¢å¼•è¿›è¡Œå­˜å‚¨å’Œè·å–çš„ã€‚<strong>ä¸šåŠ¡è®¿é—®æ—¶ï¼Œå¦‚æœå¤§é‡çš„ key åŒæ—¶è¿‡æœŸï¼Œå¾ˆå¤šç¼“å­˜æ•°æ®è®¿é—®éƒ½ä¼š missï¼Œè¿›è€Œç©¿é€åˆ° DBï¼ŒDB çš„å‹åŠ›å°±ä¼šæ˜æ˜¾ä¸Šå‡</strong>ï¼Œç”±äº DB çš„æ€§èƒ½è¾ƒå·®ï¼Œåªåœ¨ç¼“å­˜çš„ 1%~2% ä»¥ä¸‹ï¼Œè¿™æ ·è¯·æ±‚çš„æ…¢æŸ¥ç‡ä¼šæ˜æ˜¾ä¸Šå‡ã€‚è¿™å°±æ˜¯ç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ã€‚</p>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>å¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼Œç‰¹åˆ«æ˜¯å¾ˆå¤š key ä¸€èµ·å¤±æ•ˆçš„åŸå› ï¼Œè·Ÿæˆ‘ä»¬æ—¥å¸¸å†™ç¼“å­˜çš„è¿‡æœŸæ—¶é—´æ¯æ¯ç›¸å…³ã€‚</p>
<p>åœ¨å†™ç¼“å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæ ¹æ®ä¸šåŠ¡çš„è®¿é—®ç‰¹ç‚¹ï¼Œç»™æ¯ç§ä¸šåŠ¡æ•°æ®é¢„ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œåœ¨å†™ç¼“å­˜æ—¶æŠŠè¿™ä¸ªè¿‡æœŸæ—¶é—´å¸¦ä¸Šï¼Œè®©ç¼“å­˜æ•°æ®åœ¨è¿™ä¸ªå›ºå®šçš„è¿‡æœŸæ—¶é—´åè¢«æ·˜æ±°ã€‚<strong>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå› ä¸ºç¼“å­˜æ•°æ®æ˜¯é€æ­¥å†™å…¥çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é€æ­¥è¿‡æœŸè¢«æ·˜æ±°çš„ã€‚</strong> <strong><em>ä½†åœ¨æŸäº›åœºæ™¯ï¼Œä¸€å¤§æ‰¹æ•°æ®ä¼šè¢«ç³»ç»Ÿä¸»åŠ¨æˆ–è¢«åŠ¨ä» DB æ‰¹é‡åŠ è½½ï¼Œç„¶åå†™å…¥ç¼“å­˜ã€‚</em></strong>è¿™äº›æ•°æ®å†™å…¥ç¼“å­˜æ—¶ï¼Œç”±äºä½¿ç”¨ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨ç»å†è¿™ä¸ªè¿‡æœŸæ—¶é—´ä¹‹åï¼Œè¿™æ‰¹æ•°æ®å°±ä¼šä¸€èµ·åˆ°æœŸï¼Œä»è€Œè¢«ç¼“å­˜æ·˜æ±°ã€‚æ­¤æ—¶ï¼Œå¯¹è¿™æ‰¹æ•°æ®çš„æ‰€æœ‰è¯·æ±‚ï¼Œéƒ½ä¼šå‡ºç°ç¼“å­˜å¤±æ•ˆï¼Œä»è€Œéƒ½ç©¿é€åˆ° DBï¼ŒDB ç”±äºæŸ¥è¯¢é‡å¤ªå¤§ï¼Œå°±å¾ˆå®¹æ˜“å‹åŠ›å¤§å¢ï¼Œè¯·æ±‚å˜æ…¢ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>å¾ˆå¤šä¸šåŠ¡åœºæ™¯ï¼Œç¨ä¸æ³¨æ„ï¼Œå°±å‡ºç°å¤§é‡çš„ç¼“å­˜å¤±æ•ˆï¼Œè¿›è€Œå¯¼è‡´ç³»ç»Ÿ DB å‹åŠ›å¤§ã€è¯·æ±‚å˜æ…¢çš„æƒ…å†µã€‚æ¯”å¦‚åŒä¸€æ‰¹ç«è½¦ç¥¨ã€é£æœºç¥¨ï¼Œå½“å¯ä»¥å”®å–æ—¶ï¼Œç³»ç»Ÿä¼šä¸€æ¬¡æ€§åŠ è½½åˆ°ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜å†™å…¥æ—¶ï¼Œè¿‡æœŸæ—¶é—´æŒ‰ç…§é¢„å…ˆè®¾ç½®çš„è¿‡æœŸå€¼ï¼Œé‚£è¿‡æœŸæ—¶é—´åˆ°æœŸåï¼Œç³»ç»Ÿå°±ä¼šå› ç¼“å­˜å¤±æ•ˆå‡ºç°å˜æ…¢çš„é—®é¢˜ã€‚ç±»ä¼¼çš„ä¸šåŠ¡åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¾®åšä¸šåŠ¡ï¼Œä¼šæœ‰åå°ç¦»çº¿ç³»ç»Ÿï¼ŒæŒç»­è®¡ç®—çƒ­é—¨å¾®åšï¼Œæ¯å½“è®¡ç®—ç»“æŸï¼Œä¼šå°†è¿™æ‰¹çƒ­é—¨å¾®åšæ‰¹é‡å†™å…¥å¯¹åº”çš„ç¼“å­˜ã€‚è¿˜æ¯”å¦‚ï¼Œå¾ˆå¤šä¸šåŠ¡ï¼Œåœ¨éƒ¨ç½²æ–° IDC æˆ–æ–°ä¸šåŠ¡ä¸Šçº¿æ—¶ï¼Œä¼šè¿›è¡Œç¼“å­˜é¢„çƒ­ï¼Œä¹Ÿä¼šä¸€æ¬¡æ€§åŠ è½½å¤§æ‰¹çƒ­æ•°æ®ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆ<br>å¯¹äºæ‰¹é‡ key ç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ï¼ŒåŸå› æ—¢ç„¶æ˜¯é¢„ç½®çš„å›ºå®šè¿‡æœŸæ—¶é—´ï¼Œé‚£è§£å†³æ–¹æ¡ˆä¹Ÿä»è¿™é‡Œå…¥æ‰‹ã€‚è®¾è®¡ç¼“å­˜çš„è¿‡æœŸæ—¶é—´æ—¶ï¼Œä½¿ç”¨å…¬å¼ï¼šè¿‡æœŸæ—¶é—´=baes æ—¶é—´+éšæœºæ—¶é—´ã€‚å³ç›¸åŒä¸šåŠ¡æ•°æ®å†™ç¼“å­˜æ—¶ï¼Œåœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¹‹ä¸Šï¼Œå†åŠ ä¸€ä¸ªéšæœºçš„è¿‡æœŸæ—¶é—´ï¼Œè®©æ•°æ®åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å†…æ…¢æ…¢è¿‡æœŸï¼Œé¿å…ç¬æ—¶å…¨éƒ¨è¿‡æœŸï¼Œå¯¹ DB é€ æˆè¿‡å¤§å‹åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>å°†jaråŒ…è®¾ç½®æˆwindowsçš„service</title>
    <url>/2019/08/25/%E5%B0%86jar%E5%8C%85%E6%B3%A8%E5%86%8C%E6%88%90windows%E7%9A%84%E6%9C%8D%E5%8A%A1/</url>
    <content><![CDATA[<h1 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h1><blockquote>
<p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶ä¼šéœ€è¦è‡ªå®šä¹‰ä¸€äº›æœåŠ¡å¯åŠ¨ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨åœ¨å‘½ä»¤è¡Œçª—å£ä¸­è¿è¡Œå‘½ä»¤ï¼Œè€Œä¸”ä¼šæœ‰ä¸€ä¸ªçª—å£åœ¨ä»»åŠ¡æ é‡Œï¼Œå¤ªéº»çƒ¦äº†ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘éœ€è¦éƒ¨ç½²ä¸€ä¸ª<code>Jrebel</code>çš„æ³¨å†Œå™¨ï¼Œideaæ‰å¯ä»¥æ¿€æ´»<code>Jrebel</code>æˆåŠŸï¼Œæ‰€ä»¥æƒ³æ³¨å†Œæˆä¸€ä¸ªæœåŠ¡ï¼Œå¼€æœºåè‡ªåŠ¨å¯åŠ¨æœåŠ¡ï¼Œä¸éœ€è¦å†æ“ä½œä»»ä½•ä¸œè¥¿ã€‚</p>
</blockquote>
<h1 id="å‡†å¤‡JaråŒ…"><a href="#å‡†å¤‡JaråŒ…" class="headerlink" title="å‡†å¤‡JaråŒ…"></a>å‡†å¤‡JaråŒ…</h1><p>è‡ªè¡Œå‡†å¤‡éœ€è¦æ³¨å†ŒæˆæœåŠ¡çš„jaråŒ…ã€‚å¦‚æœæ˜¯<code>Java</code>ç¨‹åºçš„è¯ï¼Œmavenæ‰“åŒ…æˆjarå³å¯ã€‚</p>
<p>è¿™é‡Œæˆ‘éœ€è¦ä¸€ä¸ª<code>Jrebel</code>çš„æ³¨å†Œå™¨çš„JaråŒ…ã€‚</p>
<p><a href="https://gitee.com/gsls200808/JrebelLicenseServerforJava">JrebelLicenseServiceä¸‹è½½åœ°å€</a></p>
<h1 id="ä¸‹è½½winsw"><a href="#ä¸‹è½½winsw" class="headerlink" title="ä¸‹è½½winsw"></a>ä¸‹è½½winsw</h1><p>winswæ˜¯ä¸€æ¬¾å¯å°†å¯æ‰§è¡Œç¨‹åºå®‰è£…æˆWindows Serviceçš„å¼€æºå·¥å…·ã€‚<a href="https://github.com/kohsuke/winsw/releases">winswä¸‹è½½åœ°å€</a></p>
<p>åªéœ€è¦ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶(<code>.exe</code>)å’Œé…ç½®æ–‡ä»¶(<code>.xml</code>)ï¼Œé…ç½®æ–‡ä»¶æ˜¯ä¸ºäº†å‚è€ƒéœ€è¦é…ç½®ä»€ä¹ˆï¼Œåˆ°æ—¶ç›´æ¥åœ¨ä¸Šé¢æ”¹å³å¯ã€‚</p>
<ul>
<li><code>sample-minimal.xml</code>:  æœ€å°é…ç½®</li>
<li><code>sample-allOptions.xml</code>ï¼š å¯é€‰æ‹©çš„é…ç½®</li>
</ul>
<p><img src="http://image.leonote.cn/Snipaste_2019-11-28_16-54-33.png" alt=""></p>
<h1 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h1><h2 id="é…ç½®æœåŠ¡æ‰€éœ€è¦çš„æ–‡ä»¶"><a href="#é…ç½®æœåŠ¡æ‰€éœ€è¦çš„æ–‡ä»¶" class="headerlink" title="é…ç½®æœåŠ¡æ‰€éœ€è¦çš„æ–‡ä»¶"></a>é…ç½®æœåŠ¡æ‰€éœ€è¦çš„æ–‡ä»¶</h2><ol>
<li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹<code>Jrebel</code>ã€‚</li>
<li>å°†ä¸‹è½½å¥½çš„<code>JrebelBrainsLicenseServerforJava-1.0-SNAPSHOT-jar-with-dependencies.jar</code>æ”¹åä¸º<code>Jrebel.jar</code>ï¼Œå¹¶å¤åˆ¶è¿›å»ã€‚</li>
<li>å°†ä¸‹è½½å¥½çš„<code>WinSW.NET4.exe</code>æ”¹åä¸º<code>Jrebel.exe</code>ï¼Œå¹¶å¤åˆ¶è¿›å»ã€‚</li>
<li>å› ä¸ºæˆ‘ä¸éœ€è¦ç‰¹åˆ«å¤æ‚çš„é…ç½®ï¼Œæ‰€ä»¥ä½¿ç”¨<code>sample-minimal.xml</code>å³å¯ï¼Œæ”¹åä¸º<code>Jrebel.xml</code>ï¼Œå¹¶å¤åˆ¶è¿›å»ã€‚</li>
</ol>
<p>å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-11-28_16-56-25.png" alt=""></p>
<h2 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h2><p>ä¿®æ”¹<code>Jrebel.xml</code>çš„å†…å®¹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- æœåŠ¡ID: å¯åŠ¨ã€å…³é—­ã€åˆ é™¤æœåŠ¡æ—¶ï¼Œéƒ½æ˜¯é€šè¿‡IDæ¥æ“ä½œçš„ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>JrebelService<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- æœåŠ¡åç§°, ç”¨äºæ˜¾ç¤º --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>JrebelService<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- æœåŠ¡æè¿° --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>This service is Jrebel License Service<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- è‹¥é…ç½®äº†javaç¯å¢ƒå˜é‡ï¼Œç›´æ¥å†™æˆâ€œjavaâ€å°±è¡Œ; --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ä¹Ÿå¯ä»¥å†™æˆè¿™æ ·æ¥æŒ‡å®šä½¿ç”¨çš„jdkç‰ˆæœ¬: C:\Program Files\Java\jdk8\jre\bin\java --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executable</span>&gt;</span>java<span class="tag">&lt;/<span class="name">executable</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- å¯åŠ¨å‚æ•° --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- jaråŒ…ä¸åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹å¯ä»¥ä½¿ç”¨è¿™ç§å†™æ³•: G:\Jrebel\Jrebel.jar--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>-jar Jrebel.jar -p 8081<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- è®¾ç½®å¼€æœºå¯åŠ¨ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">startmode</span>&gt;</span>Automatic<span class="tag">&lt;/<span class="name">startmode</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- æ—¥å¿—é…ç½® --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- logpathæŒ‡å®šåœ¨å“ªä¸ªæ–‡ä»¶ä¸‹è®°å½•logï¼Œè¿™é‡Œæ˜¯åœ¨åŒçº§ç›®å½•ä¸‹åˆ›å»ºlogsæ–‡ä»¶å¤¹å­˜æ”¾log --&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">logpath</span>&gt;</span>logs<span class="tag">&lt;/<span class="name">logpath</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">logmode</span>&gt;</span>rotate<span class="tag">&lt;/<span class="name">logmode</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="æ³¨å†ŒæœåŠ¡"><a href="#æ³¨å†ŒæœåŠ¡" class="headerlink" title="æ³¨å†ŒæœåŠ¡"></a>æ³¨å†ŒæœåŠ¡</h2><ol>
<li>å·²ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å‘½ä»¤è¡Œã€‚</li>
<li>è¿›å…¥åˆ°(<code>.exe</code>)ç›®å½•ä¸‹ï¼Œå³D:\Jrebelã€‚å¦‚æœå°†è¯¥è·¯å¾„é…ç½®åœ¨Pathè·¯å¾„ä¸‹ï¼Œåˆ™è¿™æ­¥çœç•¥ã€‚</li>
<li>è¾“å…¥ <code>Jrebel install</code> å³å¯æ³¨å†ŒæœåŠ¡ã€‚</li>
<li>æœåŠ¡æ³¨å†ŒæˆåŠŸåï¼Œä½¿ç”¨<code>net start JrebelService</code>è¿è¡Œè¯¥æœåŠ¡ã€‚</li>
</ol>
<p>è¿™æ ·å°±å®Œæˆäº†ã€‚</p>
<h1 id="å¯èƒ½ç¢°åˆ°çš„é—®é¢˜"><a href="#å¯èƒ½ç¢°åˆ°çš„é—®é¢˜" class="headerlink" title="å¯èƒ½ç¢°åˆ°çš„é—®é¢˜"></a>å¯èƒ½ç¢°åˆ°çš„é—®é¢˜</h1><h2 id="â€œæ— æ³•å°†XXXXé¡¹è¯†åˆ«ä¸º-cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜"><a href="#â€œæ— æ³•å°†XXXXé¡¹è¯†åˆ«ä¸º-cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜" class="headerlink" title="â€œæ— æ³•å°†XXXXé¡¹è¯†åˆ«ä¸º cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜"></a>â€œæ— æ³•å°†XXXXé¡¹è¯†åˆ«ä¸º cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜</h2><blockquote>
<p>åœ¨è¿™æ¬¡æœåŠ¡ä¸­å‡ºç°çš„è¯ï¼Œåº”è¯¥æ˜¯æŠ¥ï¼š<strong><em>â€œæ— æ³•å°†Jrebel.exeé¡¹è¯†åˆ«ä¸º cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜</em></strong></p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>ç¬¬ä¸€ç§æ–¹å¼ï¼šéœ€è¦åœ¨æœ‰<code>Jrebel.exe</code>çš„ç›®å½•ä¸‹æ‰§è¡Œè¯¥å‘½ä»¤ã€‚</p>
<p>ç¬¬äºŒç§æ–¹å¼ï¼šå°†<code>Jrebel.exe</code>æ‰€åœ¨ç›®å½•é…ç½®åœ¨Pathè·¯å¾„ä¸‹ã€‚</p>
</blockquote>
<h2 id="FATAL-WMI-Operation-failure-AccessDenied"><a href="#FATAL-WMI-Operation-failure-AccessDenied" class="headerlink" title="FATAL - WMI Operation failure: AccessDenied"></a>FATAL - WMI Operation failure: AccessDenied</h2><blockquote>
<p>è¿™ä¸ªæ˜¯å› ä¸ºæ²¡æœ‰ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½è¿è¡Œ<code>Jrebel</code>å‘½ä»¤ï¼Œç”¨ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å‘½ä»¤è¡Œå³å¯ã€‚</p>
</blockquote>
<h1 id="å‡çº§"><a href="#å‡çº§" class="headerlink" title="å‡çº§"></a>å‡çº§</h1><p>è™½ç„¶æ˜¯æˆåŠŸé…ç½®å¥½äº†æœåŠ¡ï¼Œä½†æ˜¯å…³é—­æœåŠ¡ï¼Œæ³¨é”€æœåŠ¡ï¼Œéƒ½éœ€è¦é‡æ–°åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå‘½ä»¤ï¼Œä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚æ‰€ä»¥å¯ä»¥ç¼–å†™batæ–‡ä»¶æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚</p>
<p>è¿™é‡Œä¸»è¦æ˜¯å››ä¸ªå‘½ä»¤ï¼š</p>
<ul>
<li><code>Jrebel install</code></li>
<li><code>net start JrebelService</code></li>
<li><code>net stop JrebelService</code></li>
<li><code>Jrebel uninstall</code></li>
</ul>
<p>æ‰€ä»¥éœ€è¦åˆ›å»ºå››ä¸ªbatæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li><code>Jrebel_install.bat</code>   å¯¹åº”å‘½ä»¤   <code>Jrebel install</code></li>
<li><code>Jrebel_start.bat</code>   å¯¹åº”å‘½ä»¤   <code>net start JrebelService</code></li>
<li><code>Jrebel_stop.bat</code>   å¯¹åº”å‘½ä»¤   <code>net stop JrebelService</code></li>
<li><code>Jrebel_uninstall.bat</code>   å¯¹åº”å‘½ä»¤   <code>net stop JrebelService</code> å’Œ <code>Jrebel uninstall</code></li>
</ul>
<p>ä½†æ˜¯è¿™æ ·è¿˜ä¸è¡Œï¼Œå› ä¸ºè¿™äº›æœåŠ¡å‘½ä»¤éœ€è¦ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ‰æœ‰æ•ˆã€‚</p>
<p>æ‰€ä»¥éœ€è¦åœ¨æ¯ä¸ªbatæ–‡ä»¶é‡Œé¢å¼€å¤´åŠ ä¸Šè¿™æ®µå‘½ä»¤<strong>ç”¨äºç”³è¯·ç®¡ç†å‘˜æƒé™</strong>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">nul 2&gt;&amp;1 <span class="string">&quot;%SYSTEMROOT%\system32\cacls.exe&quot;</span> <span class="string">&quot;%SYSTEMROOT%\system32\config\system&quot;</span></span></span><br><span class="line">if &#x27;%errorlevel%&#x27; NEQ &#x27;0&#x27; (</span><br><span class="line">goto UACPrompt</span><br><span class="line">) else ( goto gotAdmin )</span><br><span class="line">:UACPrompt</span><br><span class="line">echo Set UAC = CreateObject^(&quot;Shell.Application&quot;^) &gt; &quot;%temp%\getadmin.vbs&quot;</span><br><span class="line">echo UAC.ShellExecute &quot;%~s0&quot;, &quot;&quot;, &quot;&quot;, &quot;runas&quot;, 1 &gt;&gt; &quot;%temp%\getadmin.vbs&quot;</span><br><span class="line">&quot;%temp%\getadmin.vbs&quot;</span><br><span class="line">exit /B</span><br><span class="line">:gotAdmin</span><br><span class="line">if exist &quot;%temp%\getadmin.vbs&quot; ( del &quot;%temp%\getadmin.vbs&quot; )</span><br><span class="line">pushd &quot;%CD%&quot;</span><br><span class="line">cd /D &quot;%~dp0&quot;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-11-28_17-02-48.png" alt=""></p>
<blockquote>
<p>è¿™æ ·å°±å¯ä»¥åŒå‡»æ‰§è¡Œbatæ–‡ä»¶ï¼Œå¿«é€Ÿæ³¨å†ŒæœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡ï¼Œåœæ­¢æœåŠ¡å’Œæ³¨é”€æœåŠ¡ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>å¼€å‘ç¯å¢ƒ</category>
      </categories>
      <tags>
        <tag>windows</tag>
        <tag>jar</tag>
        <tag>Jrebel</tag>
      </tags>
  </entry>
  <entry>
    <title>æ•°æ®åº“ç´¢å¼•</title>
    <url>/2020/09/14/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95/</url>
    <content><![CDATA[<h1 id="æ•°æ®åº“ç´¢å¼•"><a href="#æ•°æ®åº“ç´¢å¼•" class="headerlink" title="æ•°æ®åº“ç´¢å¼•"></a>æ•°æ®åº“ç´¢å¼•</h1><h2 id="ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿ</h2><h2 id="ç´¢å¼•çš„ç±»å‹"><a href="#ç´¢å¼•çš„ç±»å‹" class="headerlink" title="ç´¢å¼•çš„ç±»å‹"></a>ç´¢å¼•çš„ç±»å‹</h2><h3 id="æ•°æ®ç»“æ„è§’åº¦"><a href="#æ•°æ®ç»“æ„è§’åº¦" class="headerlink" title="æ•°æ®ç»“æ„è§’åº¦"></a>æ•°æ®ç»“æ„è§’åº¦</h3><ul>
<li>B-Tree ç´¢å¼•</li>
<li>hash ç´¢å¼•</li>
<li>Full-test ç´¢å¼•</li>
<li>R-Tree ç´¢å¼•</li>
</ul>
<h3 id="ç‰©ç†å­˜å‚¨è§’åº¦"><a href="#ç‰©ç†å­˜å‚¨è§’åº¦" class="headerlink" title="ç‰©ç†å­˜å‚¨è§’åº¦"></a>ç‰©ç†å­˜å‚¨è§’åº¦</h3><p>cluster</p>
<ul>
<li>èšç°‡ç´¢å¼•ï¼ˆèšé›†ç´¢å¼•ï¼‰ï¼šç‰©ç†ç´¢å¼•ï¼Œä¸åŸºè¡¨çš„ç‰©ç†é¡ºåºç›¸åŒï¼Œæ•°æ®å€¼çš„é¡ºåºæ€»æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—<ul>
<li><code>CREATE CLUSTERED INDEX mycolumn_cindex ON mytable(mycolumn) WITH</code></li>
<li><code>ALLOW_DUP_ROW(å…è®¸æœ‰é‡å¤è®°å½•çš„èšç°‡ç´¢å¼•)</code></li>
</ul>
</li>
<li>éèšç°‡ç´¢å¼•ï¼ˆç¾¤é›†ç´¢å¼•ï¼‰ï¼š<code>CREATE UNCLUSTERED INDEX mycolumn_cindex ON mytable(mycolumn)</code></li>
</ul>
<h3 id="é€»è¾‘è§’åº¦"><a href="#é€»è¾‘è§’åº¦" class="headerlink" title="é€»è¾‘è§’åº¦"></a>é€»è¾‘è§’åº¦</h3><ul>
<li>å”¯ä¸€ç´¢å¼• <code>CREATE UNIQUE INDEX myclumn_uindex ON mytable(mycolumn)</code></li>
<li>ä¸»é”®ç´¢å¼•ï¼ˆä¸»ç´¢å¼•ï¼‰primary key</li>
<li>(å¤)ç»„åˆç´¢å¼•ï¼ˆå¤šåˆ—ç´¢å¼•ï¼‰ï¼š<code>CREATE INDEX mycolumn_index ON mytable (mycolumn1, mycolumn2)</code></li>
<li>æ™®é€šç´¢å¼•ï¼ˆå•åˆ—ç´¢å¼•ï¼‰ï¼š<code>CREATE INDEX mycolumn_index ON mytable (mycolumn)</code></li>
<li>ç©ºé—´ç´¢å¼•ï¼š</li>
</ul>
<h2 id="ç´¢å¼•çš„ä¼˜ç¼ºç‚¹"><a href="#ç´¢å¼•çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="ç´¢å¼•çš„ä¼˜ç¼ºç‚¹"></a>ç´¢å¼•çš„ä¼˜ç¼ºç‚¹</h2><h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ol>
<li>åˆ›å»ºå”¯ä¸€æ€§ç´¢å¼•ï¼Œä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§</li>
<li><strong>å¤§å¤§åŠ å¿«æ•°æ®çš„æ£€ç´¢é€Ÿåº¦</strong> â€“ æœ€ä¸»è¦çš„åŸå› </li>
<li>åŠ é€Ÿè¡¨å’Œè¡¨ä¹‹é—´çš„è¿æ¥</li>
<li>åœ¨ä½¿ç”¨åˆ†ç»„å’Œæ’åºå­å¥è¿›è¡Œæ•°æ®æ£€ç´¢æ—¶ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’Œæ’åºçš„æ—¶é—´</li>
<li>é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ä¼˜åŒ–éšè—å™¨ï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½</li>
</ol>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li>åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦è€—è´¹æ—¶é—´ï¼Œè¿™ç§æ—¶é—´éšç€æ•°æ®é‡çš„å¢åŠ è€Œå¢åŠ </li>
<li>ç´¢å¼•éœ€è¦å ç”¨æ•°æ®è¡¨ä»¥å¤–çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œå¦‚æœè¦å»ºç«‹èšç°‡ç´¢å¼•ï¼Œé‚£ä¹ˆéœ€è¦çš„ç©ºé—´å°±ä¼šæ›´å¤§</li>
<li>å½“å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•éœ€è¦è¢«é‡å»ºï¼Œé™ä½äº†æ•°æ®çš„ç»´æŠ¤é€Ÿåº¦</li>
</ol>
<h2 id="ç´¢å¼•çš„ä½¿ç”¨"><a href="#ç´¢å¼•çš„ä½¿ç”¨" class="headerlink" title="ç´¢å¼•çš„ä½¿ç”¨"></a>ç´¢å¼•çš„ä½¿ç”¨</h2><ol>
<li>å½“å­—æ®µçš„æ•°æ®æ›´æ–°é¢‘ç‡è¾ƒä½ï¼ŒæŸ¥è¯¢ä½¿ç”¨é¢‘ç‡è¾ƒé«˜å¹¶ä¸”å­˜åœ¨å¤§é‡é‡å¤å€¼æ—¶ï¼Œå»ºè®®ä½¿ç”¨<strong>èšç°‡ç´¢å¼•</strong></li>
<li>ç»å¸¸åŒæ—¶å­˜å–å¤šåˆ—ï¼Œä¸”æ¯åˆ—éƒ½å«æœ‰é‡å¤å€¼å¯è€ƒè™‘å»ºç«‹<strong>ç»„åˆç´¢å¼•</strong></li>
<li>ç»„åˆç´¢å¼•çš„å‰å¯¼åˆ—ä¸€å®šå¥½æ§åˆ¶å¥½ï¼Œå¦åˆ™æ— æ³•èµ·åˆ°ç´¢å¼•çš„æ•ˆæœã€‚å¦‚æœæŸ¥è¯¢æ—¶å‰å¯¼åˆ—ä¸åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åˆ™è¯¥ç»„åˆç´¢å¼•ä¸ä¼šè¢«ä½¿ç”¨ï¼Œå‰å¯¼åˆ—ä¸€å®šæ˜¯ä½¿ç”¨æœ€é¢‘ç¹çš„åˆ—ã€‚</li>
</ol>
<h2 id="æ•°æ®åº“ä¼˜åŒ–-ORACLE"><a href="#æ•°æ®åº“ä¼˜åŒ–-ORACLE" class="headerlink" title="æ•°æ®åº“ä¼˜åŒ–(ORACLE)"></a>æ•°æ®åº“ä¼˜åŒ–(ORACLE)</h2><h3 id="SQLä½¿ç”¨ç´¢å¼•çš„ä¾‹å­"><a href="#SQLä½¿ç”¨ç´¢å¼•çš„ä¾‹å­" class="headerlink" title="SQLä½¿ç”¨ç´¢å¼•çš„ä¾‹å­"></a>SQLä½¿ç”¨ç´¢å¼•çš„ä¾‹å­</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">INDEX_COLUMN <span class="operator">=</span> ?</span><br><span class="line">INDEX_COLUMN <span class="operator">&gt;</span> ?</span><br><span class="line">INDEX_COLUMN <span class="operator">&gt;=</span> ?</span><br><span class="line">INDEX_COLUMN <span class="operator">&lt;</span> ?</span><br><span class="line">INDEX_COLUMN <span class="operator">&lt;=</span> ?</span><br><span class="line">INDEX_COLUMN <span class="keyword">between</span> ? <span class="keyword">and</span> ?</span><br><span class="line">INDEX_COLUMN <span class="keyword">in</span> (?,?,...,?)</span><br><span class="line">INDEX_COLUMN <span class="keyword">like</span> ?<span class="operator">||</span><span class="string">&#x27;%&#x27;</span> <span class="comment">--ï¼ˆåå¯¼æ¨¡ç³ŠæŸ¥è¯¢ï¼‰</span></span><br><span class="line">T1.INDEX_COLUMN<span class="operator">=</span>T2.COLUMN1 <span class="comment">--ï¼ˆä¸¤ä¸ªè¡¨é€šè¿‡ç´¢å¼•å­—æ®µå…³è”ï¼‰</span></span><br></pre></td></tr></table></figure>

<h3 id="SQLä¸ä½¿ç”¨ç´¢å¼•çš„ä¾‹å­"><a href="#SQLä¸ä½¿ç”¨ç´¢å¼•çš„ä¾‹å­" class="headerlink" title="SQLä¸ä½¿ç”¨ç´¢å¼•çš„ä¾‹å­"></a>SQLä¸ä½¿ç”¨ç´¢å¼•çš„ä¾‹å­</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ä¸ç­‰äºæ“ä½œä¸èƒ½ä½¿ç”¨ç´¢å¼•</span></span><br><span class="line">INDEX_COLUMN <span class="operator">&lt;&gt;</span> ?</span><br><span class="line">INDEX_COLUMN <span class="keyword">not</span> <span class="keyword">in</span> (?,?,...,?)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç»è¿‡æ™®é€šè¿ç®—æˆ–å‡½æ•°è¿ç®—åçš„ç´¢å¼•å­—æ®µä¸èƒ½ä½¿ç”¨ç´¢å¼•</span></span><br><span class="line"><span class="keyword">function</span>(INDEX_COLUMN) <span class="operator">=</span> ?</span><br><span class="line">INDEX_COLUMN <span class="operator">+</span> <span class="number">1</span> <span class="operator">=</span> ?</span><br><span class="line">INDEX_COLUMN <span class="operator">||</span> <span class="string">&#x27;a&#x27;</span> <span class="operator">=</span> ?</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å«å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•</span></span><br><span class="line">INDEX_COLUMN <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span><span class="operator">||</span>?</span><br><span class="line">INDEX_COLUMN <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span><span class="operator">||</span>?<span class="operator">||</span><span class="string">&#x27;%&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- B-TREEç´¢å¼•é‡Œä¸ä¿å­˜å­—æ®µä¸ºNULLå€¼è®°å½•ï¼Œå› æ­¤IS NULLä¸èƒ½ä½¿ç”¨ç´¢å¼•</span></span><br><span class="line">INDEX_COLUMN <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Oracleåœ¨åšæ•°å€¼æ¯”è¾ƒæ—¶éœ€è¦å°†ä¸¤è¾¹çš„æ•°æ®è½¬æ¢æˆåŒä¸€ç§æ•°æ®ç±»å‹ï¼Œå¦‚æœä¸¤è¾¹æ•°æ®ç±»å‹ä¸åŒæ—¶ä¼šå¯¹å­—æ®µå€¼éšå¼è½¬æ¢ï¼Œç›¸å½“äºåŠ äº†ä¸€å±‚å‡½æ•°å¤„ç†ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ç´¢å¼•ã€‚</span></span><br><span class="line">NUMBER_INDEX_COLUMN<span class="operator">=</span><span class="string">&#x27;12345&#x27;</span></span><br><span class="line">CHAR_INDEX_COLUMN<span class="operator">=</span><span class="number">12345</span></span><br><span class="line">a.INDEX_COLUMN<span class="operator">=</span>a.COLUMN_1</span><br></pre></td></tr></table></figure>

<h3 id="å¸¸ç”¨ä¼˜åŒ–æ–¹æ³•ï¼ˆORACLEï¼‰"><a href="#å¸¸ç”¨ä¼˜åŒ–æ–¹æ³•ï¼ˆORACLEï¼‰" class="headerlink" title="å¸¸ç”¨ä¼˜åŒ–æ–¹æ³•ï¼ˆORACLEï¼‰"></a>å¸¸ç”¨ä¼˜åŒ–æ–¹æ³•ï¼ˆORACLEï¼‰</h3><h4 id="whereå­å¥ä¸­çš„è¿æ¥é¡ºåº"><a href="#whereå­å¥ä¸­çš„è¿æ¥é¡ºåº" class="headerlink" title="whereå­å¥ä¸­çš„è¿æ¥é¡ºåº"></a>whereå­å¥ä¸­çš„è¿æ¥é¡ºåº</h4><p>   WHERE å­å¥æ˜¯ä»ä¸‹å¾€ä¸Šæ‰§è¡Œï¼Œç­›é€‰æ‰å†…å®¹æœ€å¤šçš„æ¡ä»¶å¿…é¡»å†™åœ¨ WHERE å­å¥çš„æœ«å°¾ï¼Œå°¤å…¶æ˜¯<code>ä¸»é”®ID=?</code>è¿™æ ·çš„æ¡ä»¶ã€‚</p>
<h4 id="selectå­å¥ä¸­é¿å…ä½¿ç”¨-â€˜-â€˜"><a href="#selectå­å¥ä¸­é¿å…ä½¿ç”¨-â€˜-â€˜" class="headerlink" title="selectå­å¥ä¸­é¿å…ä½¿ç”¨ â€˜ * â€˜"></a>selectå­å¥ä¸­é¿å…ä½¿ç”¨ â€˜ * â€˜</h4><p>   oracleè§£æè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠ*ä¾æ¬¡è½¬æ¢ä¸ºæ‰€æœ‰åˆ—åï¼Œè¿™ä¸ªå·¥ä½œæ˜¯é€šè¿‡æŸ¥è¯¢æ•°æ®å­—å…¸æ¥å®Œæˆçš„ï¼Œ è¿™æ„å‘³ç€å°†è€—è´¹æ›´å¤šçš„æ—¶é—´</p>
<h4 id="é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°"><a href="#é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°" class="headerlink" title="é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°"></a>é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°</h4><p>WHEREå­å¥ä¸­ï¼Œå¦‚æœç´¢å¼•åˆ—æ˜¯å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚ä¼˜åŒ–å™¨å°†ä¸ä½¿ç”¨ç´¢å¼•è€Œä½¿ç”¨å…¨è¡¨æ‰«æ</p>
<h4 id="é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨NOT"><a href="#é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨NOT" class="headerlink" title="é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨NOT"></a>é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨NOT</h4><p>NOT ä¼šäº§ç”Ÿåœ¨å’Œåœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°ç›¸åŒçš„æ•ˆæœã€‚ </p>
<h4 id="é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨IS-NULLå’ŒIS-NOT-NULL"><a href="#é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨IS-NULLå’ŒIS-NOT-NULL" class="headerlink" title="é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨IS NULLå’ŒIS NOT NULL"></a>é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨IS NULLå’ŒIS NOT NULL</h4><p>é¿å…åœ¨ç´¢å¼•ä¸­ä½¿ç”¨ä»»ä½•å¯ä»¥ä¸ºç©ºçš„åˆ—ï¼Œoracle å°†æ— æ³•ä½¿ç”¨è¯¥ç´¢å¼•</p>
<blockquote>
<p>å¯¹äºå•åˆ—ç´¢å¼•ï¼Œå¦‚æœåˆ—åŒ…å«ç©ºå€¼ï¼Œç´¢å¼•ä¸­å°†ä¸å­˜åœ¨æ­¤è®°å½•</p>
<p>å¯¹äºå¤åˆç´¢å¼•ï¼Œå¦‚æœæ¯ä¸ªåˆ—éƒ½ä¸ºç©ºï¼Œç´¢å¼•ä¸­åŒæ ·ä¸å­˜åœ¨æ­¤è®°å½•</p>
</blockquote>
<h4 id="æ³¨æ„é€šé…ç¬¦-çš„å½±å“"><a href="#æ³¨æ„é€šé…ç¬¦-çš„å½±å“" class="headerlink" title="æ³¨æ„é€šé…ç¬¦%çš„å½±å“"></a>æ³¨æ„é€šé…ç¬¦%çš„å½±å“</h4><h5 id="å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•"><a href="#å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•" class="headerlink" title="å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•"></a>å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•</h5><p><code>INDEX_COLUMN like &#39;%&#39;||?</code></p>
<h5 id="åå¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•å¯ä»¥ä½¿ç”¨ç´¢å¼•"><a href="#åå¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•å¯ä»¥ä½¿ç”¨ç´¢å¼•" class="headerlink" title="åå¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•å¯ä»¥ä½¿ç”¨ç´¢å¼•"></a>åå¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•å¯ä»¥ä½¿ç”¨ç´¢å¼•</h5><p><code>INDEX_COLUMN like ?||&#39;%&#39;</code></p>
<h4 id="é¿å…æ”¹å˜ç´¢å¼•åˆ—çš„ç±»å‹"><a href="#é¿å…æ”¹å˜ç´¢å¼•åˆ—çš„ç±»å‹" class="headerlink" title="é¿å…æ”¹å˜ç´¢å¼•åˆ—çš„ç±»å‹"></a>é¿å…æ”¹å˜ç´¢å¼•åˆ—çš„ç±»å‹</h4><p>åœ¨åšæ•°å€¼æ¯”è¾ƒæ—¶éœ€è¦å°†ä¸¤è¾¹çš„æ•°æ®è½¬æ¢æˆåŒä¸€ç§æ•°æ®ç±»å‹ï¼Œå¦‚æœä¸¤è¾¹æ•°æ®ç±»å‹ä¸åŒæ—¶ä¼šå¯¹å­—æ®µå€¼éšå¼è½¬æ¢ï¼Œç›¸å½“äºåŠ äº†ä¸€å±‚å‡½æ•°å¤„ç†ï¼Œå¯¼è‡´ä¸èƒ½ä½¿ç”¨ç´¢å¼•ã€‚</p>
<h4 id="ç”¨-UNION-UNION-ALLæ›¿æ¢OR-é€‚ç”¨äºç´¢å¼•åˆ—"><a href="#ç”¨-UNION-UNION-ALLæ›¿æ¢OR-é€‚ç”¨äºç´¢å¼•åˆ—" class="headerlink" title="ç”¨(UNION)UNION ALLæ›¿æ¢OR (é€‚ç”¨äºç´¢å¼•åˆ—)"></a>ç”¨(UNION)UNION ALLæ›¿æ¢OR (é€‚ç”¨äºç´¢å¼•åˆ—)</h4><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œ ç”¨UNIONæ›¿æ¢WHEREå­å¥ä¸­çš„ORå°†ä¼šèµ·åˆ°è¾ƒå¥½çš„æ•ˆæœï¼Œå¯¹ç´¢å¼•åˆ—ä½¿ç”¨ORå°†é€ æˆå…¨è¡¨æ‰«æã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šä»¥ä¸Šè§„åˆ™åªé’ˆå¯¹å¤šä¸ªç´¢å¼•åˆ—æœ‰æ•ˆã€‚å¦‚æœæœ‰columnæ²¡æœ‰è¢«ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•ˆç‡å¯èƒ½ä¼šå› ä¸ºä½ æ²¡æœ‰é€‰æ‹©ORè€Œé™ä½</p>
</blockquote>
<h4 id="ç”¨UNION-ALL-æ›¿æ¢UNION-å¦‚æœæœ‰å¯èƒ½çš„è¯"><a href="#ç”¨UNION-ALL-æ›¿æ¢UNION-å¦‚æœæœ‰å¯èƒ½çš„è¯" class="headerlink" title="ç”¨UNION-ALL æ›¿æ¢UNION ( å¦‚æœæœ‰å¯èƒ½çš„è¯)"></a>ç”¨UNION-ALL æ›¿æ¢UNION ( å¦‚æœæœ‰å¯èƒ½çš„è¯)</h4><p>å½“ SQLè¯­å¥éœ€è¦UNIONä¸¤ä¸ªæŸ¥è¯¢ç»“æœé›†åˆæ—¶ï¼Œè¿™ä¸¤ä¸ªç»“æœé›†åˆä¼šä»¥UNION-ALLçš„æ–¹å¼è¢«åˆå¹¶ï¼Œ ç„¶ååœ¨è¾“å‡ºæœ€ç»ˆç»“æœå‰è¿›è¡Œæ’åºã€‚ å¦‚æœç”¨UNION ALLæ›¿ä»£UNIONï¼Œ è¿™æ ·æ’åºå°±ä¸æ˜¯å¿…è¦äº†ï¼Œ æ•ˆç‡å°±ä¼šå› æ­¤å¾—åˆ°æé«˜ã€‚ </p>
<blockquote>
<p>æ³¨æ„ï¼šUNION ALL å°†é‡å¤è¾“å‡ºä¸¤ä¸ªç»“æœé›†åˆä¸­ç›¸åŒè®°å½•</p>
</blockquote>
<h4 id="EXISTSæ›¿æ¢DISTINCT"><a href="#EXISTSæ›¿æ¢DISTINCT" class="headerlink" title="EXISTSæ›¿æ¢DISTINCT"></a>EXISTSæ›¿æ¢DISTINCT</h4><p>å¸¦æœ‰DISTINCTã€UNIONã€MINUSã€INTERSECTçš„SQLè¯­å¥ä¼šå¯åŠ¨SQLå¼•æ“æ‰§è¡Œè€—è´¹èµ„æºçš„æ’åº(SORT)åŠŸèƒ½ã€‚</p>
<blockquote>
<p> DISTINCT éœ€è¦<strong>ä¸€æ¬¡</strong>æ’åºæ“ä½œï¼Œ è€Œå…¶ä»–çš„è‡³å°‘éœ€è¦æ‰§è¡Œ<strong>ä¸¤æ¬¡</strong>æ’åºã€‚</p>
<p>é€šå¸¸ï¼Œ å¸¦æœ‰UNIONã€MINUS ã€INTERSECTçš„SQLè¯­å¥éƒ½å¯ä»¥ç”¨å…¶ä»–æ–¹å¼é‡å†™ã€‚</p>
</blockquote>
<h4 id="åˆç†çš„ä½¿ç”¨EXISTSå’ŒIN"><a href="#åˆç†çš„ä½¿ç”¨EXISTSå’ŒIN" class="headerlink" title="åˆç†çš„ä½¿ç”¨EXISTSå’ŒIN"></a>åˆç†çš„ä½¿ç”¨EXISTSå’ŒIN</h4><p>EXISTSï¼šé¦–å…ˆæ£€æŸ¥ä¸»æŸ¥è¯¢ï¼Œç„¶åè¿è¡Œå­æŸ¥è¯¢ç›´åˆ°å®ƒæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œè¿™å°±èŠ‚çœäº†æ—¶é—´ã€‚<br>IN å­æŸ¥è¯¢ï¼šé¦–å…ˆç³»ç»Ÿå…ˆå°†ä¸»æŸ¥è¯¢æŒ‚èµ·ï¼Œç„¶åæ‰§è¡Œå­æŸ¥è¯¢ï¼Œå¹¶å°†è·å¾—çš„ç»“æœåˆ—è¡¨å­˜æ”¾åœ¨ä¸€ä¸ªåŠ äº†ç´¢å¼•çš„ä¸´æ—¶è¡¨ä¸­ã€‚å¾…å­æŸ¥è¯¢æ‰§è¡Œå®Œæ¯•ï¼Œå†æ‰§è¡Œä¸»æŸ¥è¯¢ã€‚è¿™ä¹Ÿå°±æ˜¯ä½¿ç”¨EXISTSæ¯”ä½¿ç”¨INé€šå¸¸æŸ¥è¯¢é€Ÿåº¦å¿«çš„åŸå› ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B <span class="keyword">where</span> A.id <span class="operator">=</span> B.id) ;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> A <span class="keyword">where</span> A.id <span class="keyword">in</span> (<span class="keyword">select</span> B.id <span class="keyword">from</span> B) ;</span><br></pre></td></tr></table></figure>

<p>å½“å­æŸ¥è¯¢çš„è¡¨å¤§ï¼Œexists ä¼˜äº inï¼›</p>
<blockquote>
<p>è¡¥å……</p>
<ol>
<li>EXISTS(subquery) åªè¿”å› TRUE or FALSEï¼Œå®é™…å®è¡Œæ—¶ä¼šä¼˜åŒ–å­æŸ¥è¯¢çš„selectæ¸…å•ï¼Œå› æ­¤å­æŸ¥è¯¢é‡Œå†™ select * / select 1 / select â€˜Xâ€™ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ«</li>
<li>å¦‚æœä¸¤ä¸ªè¡¨çš„å¤§å°ç›¸å½“ï¼Œexists å’Œ in å·®åˆ«ä¸å¤§</li>
<li>æ— è®ºå“ªä¸ªè¡¨å¤§ï¼Œnot exists éƒ½æ¯” not in è¦å¿«ï¼Œå› ä¸º not in å†…å¤–è¡¨éƒ½ä¸èµ°ç´¢å¼•ï¼›è€Œ not existsçš„å­æŸ¥è¯¢ä¾ç„¶å¯ä»¥ç”¨è¡¨çš„ç´¢å¼•</li>
</ol>
</blockquote>
]]></content>
      <categories>
        <category>ç´¢å¼•</category>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>ç´¢å¼•</tag>
      </tags>
  </entry>
  <entry>
    <title>æ•°æ®åº“é”</title>
    <url>/2020/09/06/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%81/</url>
    <content><![CDATA[<h1 id="æ•°æ®åº“é”"><a href="#æ•°æ®åº“é”" class="headerlink" title="æ•°æ®åº“é”"></a>æ•°æ®åº“é”</h1><h2 id="é”çš„åˆ†ç±»"><a href="#é”çš„åˆ†ç±»" class="headerlink" title="é”çš„åˆ†ç±»"></a>é”çš„åˆ†ç±»</h2><p>æŒ‰è·å–é”çš„æ–¹å¼ï¼š</p>
<ul>
<li>æ’ä»–é”</li>
<li>å…±äº«é”</li>
</ul>
<p>æŒ‰ç³»ç»Ÿå¹¶å‘ï¼š</p>
<ul>
<li>æ‚²è§‚é”</li>
<li>ä¹è§‚é”</li>
</ul>
<p>æŒ‰ä¿æŠ¤å¯¹è±¡ï¼š</p>
<ul>
<li>DMLé”ï¼š<ul>
<li>TXè¡Œé”</li>
<li>TMè¡¨é”</li>
</ul>
</li>
<li>DDLé”ï¼š<ul>
<li>DDLæ’ä»–é”</li>
<li>DDLå…±äº«é”</li>
<li>DDLå¯åˆ†è§£è§£æé”</li>
</ul>
</li>
<li>ç³»ç»Ÿé”ï¼š<ul>
<li>é—©é”Latch</li>
<li>äº’æ–¥é”Mutexes</li>
<li>å†…éƒ¨é”ï¼š<ul>
<li>å­—å…¸ç¼“å­˜é”</li>
<li>æ–‡ä»¶å’Œæ—¥å¿—ç®¡ç†é”</li>
<li>è¡¨ç©ºé—´å’Œæ’¤é”€æ®µé”</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p> ä¹è§‚é” å’Œ æ‚²è§‚é” æ˜¯ä¸€ç§æ€æƒ³</p>
<p> å®ç°å½¢å¼å¯èƒ½ä¸ä¸€æ ·ï¼šå¦‚ Javaçš„åŸå­ç±»ï¼Œæ•°æ®åº“çš„versionå­—æ®µ</p>
</blockquote>
<h2 id="æ‚²è§‚é”"><a href="#æ‚²è§‚é”" class="headerlink" title="æ‚²è§‚é”"></a>æ‚²è§‚é”</h2><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆæ‚²è§‚ï¼Œå®ƒå¯¹äºæ•°æ®è¢«å¤–ç•Œä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œè®¤ä¸ºæ•°æ®éšæ—¶ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ•´ä¸ªæ•°æ®å¤„ç†ä¸­éœ€è¦å°†æ•°æ®åŠ é”ã€‚æ‚²è§‚é”ä¸€èˆ¬éƒ½æ˜¯ä¾é å…³ç³»æ•°æ®åº“æä¾›çš„é”æœºåˆ¶ï¼Œäº‹å®ä¸Šå…³ç³»æ•°æ®åº“ä¸­çš„<strong>è¡Œé”</strong>ï¼Œ<strong>è¡¨é”</strong>ä¸è®ºæ˜¯<strong>è¯»å†™é”</strong>éƒ½æ˜¯æ‚²è§‚é”ã€‚</p>
<h3 id="æ‚²è§‚é”æŒ‰ç…§ä½¿ç”¨æ€§è´¨åˆ’åˆ†"><a href="#æ‚²è§‚é”æŒ‰ç…§ä½¿ç”¨æ€§è´¨åˆ’åˆ†" class="headerlink" title="æ‚²è§‚é”æŒ‰ç…§ä½¿ç”¨æ€§è´¨åˆ’åˆ†"></a>æ‚²è§‚é”æŒ‰ç…§ä½¿ç”¨æ€§è´¨åˆ’åˆ†</h3><h4 id="å…±äº«é”-Sé”"><a href="#å…±äº«é”-Sé”" class="headerlink" title="å…±äº«é”(Sé”)"></a>å…±äº«é”(Sé”)</h4><blockquote>
<p>å¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½æœ‰å†™æ“ä½œ</p>
</blockquote>
<p>è¯»é”ï¼Œäº‹åŠ¡Aå¯¹å¯¹è±¡TåŠ Sé”ï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿåªèƒ½å¯¹TåŠ Sï¼Œç›´åˆ°Aé‡Šæ”¾Sé”ã€‚</p>
<h4 id="æ’å®ƒé”-Xé”"><a href="#æ’å®ƒé”-Xé”" class="headerlink" title="æ’å®ƒé”(Xé”)"></a>æ’å®ƒé”(Xé”)</h4><blockquote>
<p>åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ“ä½œï¼Œå…¶ä»–äº‹åŠ¡ç­‰å¾…</p>
</blockquote>
<p>å†™é”ï¼Œäº‹åŠ¡Aå¯¹å¯¹è±¡TåŠ Xé”ä»¥åï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹TåŠ ä»»ä½•é”ï¼Œåªæœ‰äº‹åŠ¡Aå¯ä»¥è¯»å†™å¯¹è±¡Tç›´åˆ°Aé‡Šæ”¾Xé”ã€‚</p>
<h4 id="æ›´æ–°é”-Ué”"><a href="#æ›´æ–°é”-Ué”" class="headerlink" title="æ›´æ–°é”(Ué”)"></a>æ›´æ–°é”(Ué”)</h4><p>ç”¨æ¥é¢„å®šè¦å¯¹æ­¤å¯¹è±¡æ–½åŠ Xé”ï¼Œå®ƒå…è®¸å…¶ä»–äº‹åŠ¡è¯»ï¼Œä½†ä¸å…è®¸å†æ–½åŠ Ué”æˆ–Xé”ï¼›å½“è¢«è¯»å–çš„å¯¹è±¡å°†è¦è¢«æ›´æ–°æ—¶ï¼Œåˆ™å‡çº§ä¸ºXé”ï¼Œä¸»è¦æ˜¯ç”¨æ¥é˜²æ­¢æ­»é”çš„ã€‚å› ä¸ºä½¿ç”¨å…±äº«é”æ—¶ï¼Œä¿®æ”¹æ•°æ®çš„æ“ä½œåˆ†ä¸ºä¸¤æ­¥ï¼Œé¦–å…ˆè·å¾—ä¸€ä¸ªå…±äº«é”ï¼Œè¯»å–æ•°æ®ï¼Œç„¶åå°†å…±äº«é”å‡çº§ä¸ºæ’å®ƒé”ï¼Œç„¶åå†æ‰§è¡Œä¿®æ”¹æ“ä½œã€‚è¿™æ ·å¦‚æœåŒæ—¶æœ‰ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åŒæ—¶å¯¹ä¸€ä¸ªå¯¹è±¡ç”³è¯·äº†å…±äº«é”ï¼Œåœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›äº‹åŠ¡éƒ½è¦å°†å…±äº«é”å‡çº§ä¸ºæ’å®ƒé”ã€‚è¿™äº›äº‹åŠ¡éƒ½ä¸ä¼šé‡Šæ”¾å…±äº«é”è€Œæ˜¯ä¸€ç›´ç­‰å¾…å¯¹æ–¹é‡Šæ”¾ï¼Œè¿™æ ·å°±é€ æˆäº†æ­»é”ã€‚å¦‚æœä¸€ä¸ªæ•°æ®åœ¨ä¿®æ”¹å‰ç›´æ¥ç”³è¯·æ›´æ–°é”ï¼Œåœ¨æ•°æ®ä¿®æ”¹çš„æ—¶å€™å†å‡çº§ä¸ºæ’å®ƒé”ï¼Œå°±å¯ä»¥é¿å…æ­»é”ã€‚</p>
<h4 id="æ’å®ƒé”å’Œå…±äº«é”çš„ç›¸å®¹çŸ©é˜µ"><a href="#æ’å®ƒé”å’Œå…±äº«é”çš„ç›¸å®¹çŸ©é˜µ" class="headerlink" title="æ’å®ƒé”å’Œå…±äº«é”çš„ç›¸å®¹çŸ©é˜µ"></a>æ’å®ƒé”å’Œå…±äº«é”çš„ç›¸å®¹çŸ©é˜µ</h4><table>
<thead>
<tr>
<th><strong>T1\T2</strong></th>
<th><strong>X</strong></th>
<th><strong>S</strong></th>
<th><strong>-</strong></th>
</tr>
</thead>
<tbody><tr>
<td>X</td>
<td>N</td>
<td>N</td>
<td>Y</td>
</tr>
<tr>
<td>S</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>-</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
</tbody></table>
<h3 id="æ‚²è§‚é”æŒ‰ç…§ä½œç”¨èŒƒå›´åˆ’åˆ†"><a href="#æ‚²è§‚é”æŒ‰ç…§ä½œç”¨èŒƒå›´åˆ’åˆ†" class="headerlink" title="æ‚²è§‚é”æŒ‰ç…§ä½œç”¨èŒƒå›´åˆ’åˆ†"></a>æ‚²è§‚é”æŒ‰ç…§ä½œç”¨èŒƒå›´åˆ’åˆ†</h3><h4 id="è¡Œé”"><a href="#è¡Œé”" class="headerlink" title="è¡Œé”"></a>è¡Œé”</h4><blockquote>
<p>ä½œç”¨èŒƒå›´ï¼šè¡Œçº§åˆ«</p>
<p>æ•°æ®åº“èƒ½å¤Ÿç¡®å®šé‚£äº›è¡Œéœ€è¦é”çš„æƒ…å†µä¸‹ä½¿ç”¨è¡Œé”ï¼Œ<strong>å¦‚æœä¸çŸ¥é“ä¼šå½±å“å“ªäº›è¡Œçš„æ—¶å€™å°±ä¼šä½¿ç”¨è¡¨é”</strong>ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<p>â€‹    ä¸€ä¸ªç”¨æˆ·è¡¨userï¼Œæœ‰ä¸»é”®idå’Œç”¨æˆ·ç”Ÿæ—¥birthdayå½“ä½ ä½¿ç”¨<code>update â€¦ where id=?</code>è¿™æ ·çš„è¯­å¥æ•°æ®åº“æ˜ç¡®çŸ¥é“ä¼šå½±å“å“ªä¸€è¡Œï¼Œå®ƒå°±ä¼šä½¿ç”¨è¡Œé”ï¼Œå½“ä½ ä½¿ç”¨<code>update â€¦ where birthday=?</code>è¿™æ ·çš„çš„è¯­å¥çš„æ—¶å€™å› ä¸ºäº‹å…ˆä¸çŸ¥é“ä¼šå½±å“å“ªäº›è¡Œå°±å¯èƒ½ä¼šä½¿ç”¨è¡¨é”ã€‚</p>
</blockquote>
<h4 id="è¡¨é”"><a href="#è¡¨é”" class="headerlink" title="è¡¨é”"></a>è¡¨é”</h4><blockquote>
<p>ä½œç”¨èŒƒå›´ï¼šæ•´å¼ è¡¨</p>
</blockquote>
<h2 id="ä¹è§‚é”"><a href="#ä¹è§‚é”" class="headerlink" title="ä¹è§‚é”"></a>ä¹è§‚é”</h2><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡è‡ªå·±æ“ä½œæ•°æ®çš„æ—¶å€™è®¤ä¸ºæ²¡æœ‰äººå›æ¥ä¿®æ”¹å®ƒï¼Œæ‰€ä»¥ä¸å»åŠ é”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šå»åˆ¤æ–­åœ¨æ­¤æœŸé—´æ•°æ®æœ‰æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±å»å®ç°ã€‚</p>
<h3 id="ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯"><a href="#ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯"></a>ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯</h3><blockquote>
<p>ä¸¤ç§é”å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä¸å¯è®¤ä¸ºä¸€ç§å¥½äºå¦ä¸€ç§ï¼Œåƒ<strong>ä¹è§‚é”é€‚ç”¨äºå†™æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ˆå¤šè¯»åœºæ™¯ï¼‰</strong>ï¼Œå³å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿçš„æ—¶å€™ï¼Œè¿™æ ·å¯ä»¥çœå»äº†é”çš„å¼€é”€ï¼ŒåŠ å¤§äº†ç³»ç»Ÿçš„æ•´ä¸ªååé‡ã€‚ä½†å¦‚æœæ˜¯å¤šå†™çš„æƒ…å†µï¼Œä¸€èˆ¬ä¼šç»å¸¸äº§ç”Ÿå†²çªï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸Šå±‚åº”ç”¨ä¼šä¸æ–­çš„è¿›è¡Œretryï¼Œè¿™æ ·åå€’æ˜¯é™ä½äº†æ€§èƒ½ï¼Œæ‰€ä»¥<strong>ä¸€èˆ¬å¤šå†™çš„åœºæ™¯ä¸‹ç”¨æ‚²è§‚é”å°±æ¯”è¾ƒåˆé€‚ã€‚</strong></p>
</blockquote>
<h3 id="ä¹è§‚é”å®ç°æ–¹å¼"><a href="#ä¹è§‚é”å®ç°æ–¹å¼" class="headerlink" title="ä¹è§‚é”å®ç°æ–¹å¼"></a>ä¹è§‚é”å®ç°æ–¹å¼</h3><h4 id="ç‰ˆæœ¬å·"><a href="#ç‰ˆæœ¬å·" class="headerlink" title="ç‰ˆæœ¬å·"></a>ç‰ˆæœ¬å·</h4><blockquote>
<p><strong>å®ç°</strong>ï¼šå®ä½“ä¸Šå¢åŠ ç‰ˆæœ¬æ ‡è¯†ï¼Œæ•°æ®åº“ä¸Šè¡¨å¢åŠ ä¸€ä¸ª<code>version</code>å­—æ®µï¼›æ¯æ¬¡æ›´æ–°æŠŠè¿™ä¸ªå­—æ®µåŠ 1</p>
<p><strong>åŸç†</strong>ï¼šè¯»æ•°æ®æ—¶æŠŠ<code>version</code>è¯»å‡ºæ¥ï¼Œåœ¨æ›´æ–°æ•°æ®æ—¶æ¯”è¾ƒ<code>version</code>ï¼Œå¦‚æœè¯»çš„<code>version</code>æ²¡æœ‰å˜åŒ–å¯ä»¥æ›´æ–°äº†ï¼Œå¦‚æœDBçš„<code>version</code>æ¯”è¯»çš„<code>version</code>å¤§ï¼Œè¯´æ˜æœ‰å…¶ä»–äº‹åŠ¡æ›´æ–°äº†è¯¥æ•°æ®ã€‚è¿™æ—¶å€™å¾—åˆ°ä¸€ä¸ªæ— æ³•æ›´æ–°çš„é€šçŸ¥ï¼Œç”¨æˆ·è‡ªè¡Œæ ¹æ®è¿™ä¸ªé€šçŸ¥æ¥å†³å®šæ€ä¹ˆå¤„ç†ï¼Œæ¯”å¦‚é‡æ–°å¼€å§‹ä¸€éã€‚</p>
<p><strong>å…³é”®</strong>ï¼šåˆ¤æ–­<code>version</code>å’Œæ›´æ–°ä¸¤ä¸ªåŠ¨ä½œéœ€è¦ä½œä¸ºä¸€ä¸ªåŸå­å•å…ƒæ‰§è¡Œï¼Œå¦åˆ™åœ¨ä½ åˆ¤æ–­å¯ä»¥æ›´æ–°ï¼Œä½†æ˜¯åœ¨æ­£å¼æ›´æ–°å‰ï¼Œåˆæœ‰åˆ«çš„æ•°æ®ä¿®æ”¹äº†versionï¼Œè¿™ä¸ªæ—¶å€™ä½ çš„æ›´æ–°å°±ä¼šè¦†ç›–åˆ«çš„äº‹åŠ¡çš„æ›´æ–°ï¼Œé€ æˆç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜ã€‚</p>
<p><code>update â€¦ , version = version + 1 where â€¦ and version=&#39;old version&#39;;</code>ï¼Œæ ¹æ®è¿”å›ç»“æœæ˜¯0è¿˜æ˜¯é0æ¥åˆ¤æ–­æ˜¯å¦æ›´æ–°æˆåŠŸã€‚</p>
</blockquote>
<h4 id="æ—¶é—´æˆ³"><a href="#æ—¶é—´æˆ³" class="headerlink" title="æ—¶é—´æˆ³"></a>æ—¶é—´æˆ³</h4><blockquote>
<p>å’Œç‰ˆæœ¬å·åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯é€šè¿‡æ—¶é—´æˆ³æ¥åˆ¤æ–­è€Œå·²ï¼Œæ³¨æ„æ—¶é—´æˆ³è¦ä½¿ç”¨æ•°æ®åº“æœåŠ¡å™¨çš„æ—¶é—´æˆ³ä¸èƒ½æ˜¯ä¸šåŠ¡ç³»ç»Ÿçš„æ—¶é—´</p>
</blockquote>
<h4 id="å¾…æ›´æ–°å­—æ®µ"><a href="#å¾…æ›´æ–°å­—æ®µ" class="headerlink" title="å¾…æ›´æ–°å­—æ®µ"></a>å¾…æ›´æ–°å­—æ®µ</h4><blockquote>
<p>å®ç°ï¼šå’Œç‰ˆæœ¬å·æ–¹å¼ç›¸ä¼¼ï¼Œåªæ˜¯ä¸å¢åŠ é¢å¤–å­—æ®µï¼Œç›´æ¥ä½¿ç”¨æœ‰æ•ˆæ•°æ®å­—æ®µåšç‰ˆæœ¬æ§åˆ¶ä¿¡æ¯ï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½æ— æ³•æ”¹å˜æ—§ç³»ç»Ÿçš„æ•°æ®åº“è¡¨ç»“æ„ã€‚</p>
<p>åŸç†ï¼šå‡å¦‚å¾…æ›´æ–°å­—æ®µå«countï¼Œå…ˆå»è¯»å–è¿™ä¸ªcountï¼Œæ›´æ–°æ—¶å»æ¯”è¾ƒæ•°æ®åº“ä¸­countçš„å€¼æ˜¯ä¸æ˜¯åŸæ¥è¯»å–çš„å€¼ï¼Œå¦‚æœæ˜¯å°±æ›´æ–°ï¼Œå¦åˆ™æ›´æ–°å¤±è´¥ã€‚JAVAåŸå­ç±»å‹å¯¹è±¡ï¼šå¦‚<code>AtomicInteger</code>å°±æ˜¯è¿™ç§æ€æƒ³ã€‚</p>
</blockquote>
<h4 id="æ‰€æœ‰å­—æ®µ"><a href="#æ‰€æœ‰å­—æ®µ" class="headerlink" title="æ‰€æœ‰å­—æ®µ"></a>æ‰€æœ‰å­—æ®µ</h4><blockquote>
<p>å’Œå¾…æ›´æ–°å­—æ®µç±»ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨æ‰€æœ‰å­—æ®µåšç‰ˆæœ¬æ§åˆ¶ä¿¡æ¯ï¼Œåªæœ‰æ‰€æœ‰å­—æ®µéƒ½æ²¡å˜åŒ–æ‰ä¼šæ‰§è¡Œæ›´æ–°ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>é”</category>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>ç³»ç»Ÿæ¶æ„æ¼”åŒ–</title>
    <url>/2020/11/15/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8C%96/</url>
    <content><![CDATA[<h1 id="ç³»ç»Ÿæ¶æ„"><a href="#ç³»ç»Ÿæ¶æ„" class="headerlink" title="ç³»ç»Ÿæ¶æ„"></a>ç³»ç»Ÿæ¶æ„</h1><h2 id="ç³»ç»ŸæŠ€æœ¯æŒ‘æˆ˜ä¸æ–¹æ¡ˆ"><a href="#ç³»ç»ŸæŠ€æœ¯æŒ‘æˆ˜ä¸æ–¹æ¡ˆ" class="headerlink" title="ç³»ç»ŸæŠ€æœ¯æŒ‘æˆ˜ä¸æ–¹æ¡ˆ"></a>ç³»ç»ŸæŠ€æœ¯æŒ‘æˆ˜ä¸æ–¹æ¡ˆ</h2><h3 id="äº’è”ç½‘ç³»ç»Ÿé¢ä¸´æ€æ ·çš„æŒ‘æˆ˜"><a href="#äº’è”ç½‘ç³»ç»Ÿé¢ä¸´æ€æ ·çš„æŒ‘æˆ˜" class="headerlink" title="äº’è”ç½‘ç³»ç»Ÿé¢ä¸´æ€æ ·çš„æŒ‘æˆ˜?"></a>äº’è”ç½‘ç³»ç»Ÿé¢ä¸´æ€æ ·çš„æŒ‘æˆ˜?</h3><ul>
<li><p>éœ€è¦é¢å¯¹<strong>é«˜å¹¶å‘</strong>ç”¨æˆ·ï¼Œ<strong>å¤§æµé‡</strong>è®¿é—®</p>
<ul>
<li>Google æ—¥å‡ PV æ•° 35 äº¿ï¼Œæ—¥å‡ IP è®¿é—®æ•° 3 äº¿</li>
<li>å¾®ä¿¡åœ¨çº¿ç”¨æˆ·æ•° 10 äº¿</li>
<li>å¤©çŒ«åŒåä¸€æ´»åŠ¨ä¸€å¤©äº¤æ˜“é¢ 3000 äº¿</li>
</ul>
</li>
<li><p><strong>é«˜å¯ç”¨</strong></p>
<ul>
<li>ç³»ç»Ÿ 7Ã—24 å°æ—¶ä¸é—´æ–­æœåŠ¡ï¼Œå¤§å‹äº’è”ç½‘ç«™çš„<strong>å®•æœº</strong>äº‹ä»¶é€šå¸¸ä¼šæˆä¸ºæ–°é—»ç„¦ç‚¹</li>
</ul>
</li>
<li><p>éœ€è¦å­˜å‚¨ã€ç®¡ç†<strong>æµ·é‡æ•°æ®</strong></p>
<ul>
<li>Facebook æ¯å‘¨ä¸Šä¼ çš„ç…§ç‰‡æ•°ç›®æ¥è¿‘10äº¿ </li>
<li>ç™¾åº¦æ”¶å½•çš„ç½‘é¡µæ•°ç›®æœ‰æ•°ç™¾äº¿ </li>
<li>Google æœ‰è¿‘ç™¾ä¸‡å°æœåŠ¡å™¨ä¸ºå…¨çƒç”¨æˆ·æä¾›æœåŠ¡</li>
</ul>
</li>
<li><p>ç”¨æˆ·åˆ†å¸ƒå¹¿æ³›ï¼Œ<strong>ç½‘ç»œæƒ…å†µå¤æ‚</strong></p>
<ul>
<li>è®¸å¤šå¤§å‹äº’è”ç½‘éƒ½æ˜¯ä¸ºå…¨çƒç”¨æˆ·æä¾›æœåŠ¡çš„ï¼Œç”¨æˆ·åˆ†å¸ƒèŒƒå›´å¹¿ï¼Œå„åœ°ç½‘ç»œæƒ…å†µåƒå·®ä¸‡åˆ«ã€‚ åœ¨å›½å†…ï¼Œæœ‰å„ä¸ªè¿è¥å•†ç½‘ç»œäº’é€šéš¾çš„é—®é¢˜ã€‚è€Œä¸­ç¾å…‰ç¼†çš„æ•°æ¬¡æ•…éšœï¼Œä¹Ÿè®©ä¸€äº›å¯¹å›½å¤–ç”¨æˆ·ä¾èµ–è¾ƒå¤§çš„ç½‘ç«™ä¸å¾—ä¸è€ƒè™‘åœ¨æµ·å¤–å»ºç«‹æ•°æ®ä¸­å¿ƒ</li>
</ul>
</li>
<li><p>å®‰å…¨ç¯å¢ƒæ¶åŠ£</p>
<ul>
<li>ç”±äºäº’è”ç½‘çš„å¼€æ”¾æ€§ï¼Œä½¿å¾—äº’è”ç½‘ç«™æ›´å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œå¤§å‹ç½‘ç«™å‡ ä¹æ¯å¤©éƒ½ä¼šé‡åˆ°é»‘å®¢æ”»å‡»æƒ…å†µã€‚2011å¹´å›½å†…å¤šä¸ªé‡è¦ç½‘ç«™æ³„éœ²ç”¨æˆ·å¯†ç ï¼Œè®©æ™®é€šç”¨æˆ·ä¹Ÿç›´é¢ä¸€æ¬¡äº’è”ç½‘å®‰å…¨é—®é¢˜</li>
</ul>
</li>
<li><p><strong>éœ€æ±‚å¿«é€Ÿå˜æ›´ï¼Œå‘å¸ƒé¢‘ç¹</strong></p>
<ul>
<li>å’Œä¼ ç»Ÿè½¯ä»¶çš„ç‰ˆæœ¬å‘å¸ƒé¢‘ç‡ä¸åŒï¼Œäº’è”ç½‘äº§å“ä¸ºå¿«é€Ÿé€‚åº”å¸‚åœºï¼Œæ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œå…¶äº§å“å‘å¸ƒé¢‘ç‡ä¹Ÿæ˜¯æé«˜çš„ã€‚Office çš„äº§å“ç‰ˆæœ¬ä»¥å¹´ä¸ºå•ä½å‘å¸ƒï¼Œè€Œä¸€èˆ¬å¤§å‹ç½‘ç«™çš„äº§å“æ¯å‘¨éƒ½æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒä¸Šçº¿ï¼Œè‡³äºä¸­å°å‹ç½‘ç«™çš„å‘å¸ƒå°±æ›´é¢‘ç¹äº†ï¼Œæœ‰æ—¶å€™ä¸€å¤©ä¼šå‘å¸ƒå‡ åæ¬¡</li>
</ul>
</li>
<li><p>æ¸è¿›å¼å‘å±•</p>
<ul>
<li>ä¸åŒäºä¼ ç»Ÿè½¯ä»¶äº§å“æˆ–è€…ä¼ä¸šåº”ç”¨ç³»ç»Ÿï¼Œä¸€å¼€å§‹å°±è§„åˆ’å¥½å…¨éƒ¨çš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚ï¼Œå‡  ä¹æ‰€æœ‰çš„å¤§å‹äº’è”ç½‘ç«™éƒ½æ˜¯ä»ä¸€ä¸ªå°ç½‘ç«™å¼€å§‹ï¼Œæ¸è¿›çš„å‘å±•èµ·æ¥çš„ã€‚</li>
<li>å¥½çš„äº’è”ç½‘äº§å“éƒ½æ˜¯æ…¢æ…¢è¿è¥å‡ºæ¥çš„ï¼Œä¸æ˜¯ä¸€å¼€å§‹å°±å¼€å‘å¥½çš„ã€‚é‚£äº›åˆšå»ºç«‹å°±æŠ•å…¥å·¨èµ„ï¼Œ æœ‰å·¨å¤§èƒŒæ™¯çš„ç½‘ç«™ï¼Œåæ¥å‘å±•éƒ½å¾ˆæƒ¨æ·¡ã€‚</li>
</ul>
</li>
</ul>
<h3 id="åº”å¯¹é«˜å¹¶å‘æŒ‘æˆ˜çš„ä¸¤ä¸ªæŠ€æœ¯æ–¹å‘"><a href="#åº”å¯¹é«˜å¹¶å‘æŒ‘æˆ˜çš„ä¸¤ä¸ªæŠ€æœ¯æ–¹å‘" class="headerlink" title="åº”å¯¹é«˜å¹¶å‘æŒ‘æˆ˜çš„ä¸¤ä¸ªæŠ€æœ¯æ–¹å‘"></a>åº”å¯¹é«˜å¹¶å‘æŒ‘æˆ˜çš„ä¸¤ä¸ªæŠ€æœ¯æ–¹å‘</h3><h4 id="å‚ç›´ä¼¸ç¼©"><a href="#å‚ç›´ä¼¸ç¼©" class="headerlink" title="å‚ç›´ä¼¸ç¼©"></a>å‚ç›´ä¼¸ç¼©</h4><p>â€‹    é€šè¿‡<strong>å‡çº§ç¡¬ä»¶å’Œç½‘ç»œååèƒ½åŠ›</strong>å¯ä»¥å®ç°å‚ç›´ä¼¸ç¼©ã€‚ç”±äºä¸éœ€è¦æ”¹å˜åº”ç”¨æ¶æ„ï¼Œæ‰€ä»¥é€šå¸¸ è¢«è®¤ä¸ºæ˜¯<strong>æœ€ç®€å•çš„çŸ­æœŸä¼¸ç¼©æ€§æ–¹æ¡ˆ</strong>ã€‚ </p>
<ul>
<li>é€šè¿‡ä½¿ç”¨ RAIDï¼ˆç‹¬ç«‹å†—ä½™ç£ç›˜é˜µåˆ—ï¼‰å¢åŠ  I/O ååèƒ½åŠ›</li>
<li>é€šè¿‡åˆ‡æ¢åˆ° SSDï¼ˆå›ºæ€ç¡¬ç›˜ï¼‰æ”¹å–„ I/O è®¿é—®é€Ÿåº¦</li>
<li>é€šè¿‡å¢åŠ å†…å­˜å‡å°‘ I/O æ“ä½œ</li>
<li>é€šè¿‡å‡çº§ç½‘ç»œæ¥å£æˆ–è€…å¢åŠ ç½‘ç»œæ¥å£æé«˜ç½‘ç»œååèƒ½åŠ›</li>
<li>æ›´æ–°æœåŠ¡å™¨ä½¿ç”¨æ›´å¤šå¤„ç†å™¨æˆ–è€…æ›´å¤šè¶…çº¿ç¨‹</li>
</ul>
<h5 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h5><p>è¾¾åˆ°æŸä¸ªç¨‹åº¦åï¼Œå¢åŠ è®¡ç®—èƒ½åŠ›éœ€è¦çš„æ›´å¤šçš„èŠ±è´¹ã€‚</p>
<ul>
<li>å‚ç›´ä¼¸ç¼©æœ‰ç‰©ç†æé™ã€‚</li>
<li>æ“ä½œç³»ç»Ÿçš„è®¾è®¡æˆ–è€…åº”ç”¨ç¨‹åºè‡ªèº«åˆ¶çº¦ç€å‚ç›´ä¼¸ç¼©æœ€å¤šåªèƒ½è¾¾åˆ°æŸä¸ªç‚¹ã€‚</li>
</ul>
<p><img src="http://image.leonote.cn//20201115101239.png" alt=""></p>
<h4 id="æ°´å¹³ä¼¸ç¼©"><a href="#æ°´å¹³ä¼¸ç¼©" class="headerlink" title="æ°´å¹³ä¼¸ç¼©"></a>æ°´å¹³ä¼¸ç¼©</h4><p>æ°´å¹³ä¼¸ç¼©æ˜¯æŒ‡é€šè¿‡å¢åŠ æœåŠ¡å™¨æå‡è®¡ç®—èƒ½åŠ›çš„ä¸€ç±»æ¶æ„æ–¹æ³•ã€‚ </p>
<p>æ°´å¹³ä¼¸ç¼©è¢«è®¤ä¸ºæ˜¯ä¼¸ç¼©æ€§çš„åœ£æ¯ï¼Œæ°´å¹³ä¼¸ç¼©å¯ä»¥å…‹æœå‚ç›´ä¼¸ç¼©å¸¦æ¥çš„å•ä½è®¡ç®—æˆæœ¬éšè®¡ç®— èƒ½åŠ›å¢åŠ è€Œè¿…é€Ÿé£™å‡çš„é—®é¢˜ã€‚</p>
<p>å¦å¤–ï¼Œæ°´å¹³ä¼¸ç¼©æ€»æ˜¯å¯ä»¥å¢åŠ æ›´å¤šæœåŠ¡å™¨ï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šåƒå‚ç›´ä¼¸ç¼©é‚£æ ·é­é‡åˆ°å•å°æœ åŠ¡å™¨çš„æé™ã€‚</p>
<p><img src="http://image.leonote.cn//20201115101557.png" alt=""></p>
<h2 id="äº’è”ç½‘æ¶æ„æ¼”åŒ–"><a href="#äº’è”ç½‘æ¶æ„æ¼”åŒ–" class="headerlink" title="äº’è”ç½‘æ¶æ„æ¼”åŒ–"></a>äº’è”ç½‘æ¶æ„æ¼”åŒ–</h2><h3 id="ç¬¬é›¶é˜¶æ®µï¼šæœ€ç®€å•çš„äº’è”ç½‘åº”ç”¨æ¶æ„"><a href="#ç¬¬é›¶é˜¶æ®µï¼šæœ€ç®€å•çš„äº’è”ç½‘åº”ç”¨æ¶æ„" class="headerlink" title="ç¬¬é›¶é˜¶æ®µï¼šæœ€ç®€å•çš„äº’è”ç½‘åº”ç”¨æ¶æ„"></a>ç¬¬é›¶é˜¶æ®µï¼šæœ€ç®€å•çš„äº’è”ç½‘åº”ç”¨æ¶æ„</h3><p>ä¸€å°æœåŠ¡å™¨é‡Œé¢å®Œæˆæ‰€æœ‰çš„äº‹æƒ…</p>
<p><img src="http://image.leonote.cn//20201115101756.png" alt=""></p>
<h3 id="ç¬¬ä¸€é˜¶æ®µï¼šåº”ç”¨æ•°æ®åˆ†ç¦»"><a href="#ç¬¬ä¸€é˜¶æ®µï¼šåº”ç”¨æ•°æ®åˆ†ç¦»" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼šåº”ç”¨æ•°æ®åˆ†ç¦»"></a>ç¬¬ä¸€é˜¶æ®µï¼šåº”ç”¨æ•°æ®åˆ†ç¦»</h3><p><img src="http://image.leonote.cn//20201115101928.png" alt=""></p>
<h3 id="ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ”¹å–„ç³»ç»Ÿæ€§èƒ½"><a href="#ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ”¹å–„ç³»ç»Ÿæ€§èƒ½" class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ”¹å–„ç³»ç»Ÿæ€§èƒ½"></a>ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ”¹å–„ç³»ç»Ÿæ€§èƒ½</h3><p><img src="http://image.leonote.cn//20201115102022.png" alt=""></p>
<h3 id="ç¬¬ä¸‰é˜¶æ®µï¼šä½¿ç”¨åº”ç”¨æœåŠ¡å™¨é›†ç¾¤æ”¹å–„ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼šä½¿ç”¨åº”ç”¨æœåŠ¡å™¨é›†ç¾¤æ”¹å–„ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼šä½¿ç”¨åº”ç”¨æœåŠ¡å™¨é›†ç¾¤æ”¹å–„ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›"></a>ç¬¬ä¸‰é˜¶æ®µï¼šä½¿ç”¨åº”ç”¨æœåŠ¡å™¨é›†ç¾¤æ”¹å–„ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›</h3><p><img src="http://image.leonote.cn//20201115102252.png" alt=""></p>
<h3 id="ç¬¬å››é˜¶æ®µï¼šæ•°æ®åº“è¯»å†™åˆ†ç¦»"><a href="#ç¬¬å››é˜¶æ®µï¼šæ•°æ®åº“è¯»å†™åˆ†ç¦»" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šæ•°æ®åº“è¯»å†™åˆ†ç¦»"></a>ç¬¬å››é˜¶æ®µï¼šæ•°æ®åº“è¯»å†™åˆ†ç¦»</h3><p><img src="http://image.leonote.cn//20201115102505.png" alt=""></p>
<h3 id="ç¬¬äº”é˜¶æ®µï¼šä½¿ç”¨åå‘ä»£ç†å’Œ-CDN-åŠ é€Ÿç½‘ç«™å“åº”"><a href="#ç¬¬äº”é˜¶æ®µï¼šä½¿ç”¨åå‘ä»£ç†å’Œ-CDN-åŠ é€Ÿç½‘ç«™å“åº”" class="headerlink" title="ç¬¬äº”é˜¶æ®µï¼šä½¿ç”¨åå‘ä»£ç†å’Œ CDN åŠ é€Ÿç½‘ç«™å“åº”"></a>ç¬¬äº”é˜¶æ®µï¼šä½¿ç”¨åå‘ä»£ç†å’Œ CDN åŠ é€Ÿç½‘ç«™å“åº”</h3><p><img src="http://image.leonote.cn//20201115102618.png" alt=""></p>
<h3 id="ç¬¬å…­é˜¶æ®µï¼šä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ"><a href="#ç¬¬å…­é˜¶æ®µï¼šä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ" class="headerlink" title="ç¬¬å…­é˜¶æ®µï¼šä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ"></a>ç¬¬å…­é˜¶æ®µï¼šä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ</h3><p><img src="http://image.leonote.cn//20201115102720.png" alt=""></p>
<h3 id="ç¬¬ä¸ƒé˜¶æ®µï¼šä½¿ç”¨-NoSQL-å’Œæœç´¢å¼•æ“"><a href="#ç¬¬ä¸ƒé˜¶æ®µï¼šä½¿ç”¨-NoSQL-å’Œæœç´¢å¼•æ“" class="headerlink" title="ç¬¬ä¸ƒé˜¶æ®µï¼šä½¿ç”¨ NoSQL å’Œæœç´¢å¼•æ“"></a>ç¬¬ä¸ƒé˜¶æ®µï¼šä½¿ç”¨ NoSQL å’Œæœç´¢å¼•æ“</h3><p><img src="http://image.leonote.cn//20201115102805.png" alt=""></p>
<h3 id="ç¬¬å…«é˜¶æ®µï¼šä¸šåŠ¡æ‹†åˆ†"><a href="#ç¬¬å…«é˜¶æ®µï¼šä¸šåŠ¡æ‹†åˆ†" class="headerlink" title="ç¬¬å…«é˜¶æ®µï¼šä¸šåŠ¡æ‹†åˆ†"></a>ç¬¬å…«é˜¶æ®µï¼šä¸šåŠ¡æ‹†åˆ†</h3><p><img src="http://image.leonote.cn//20201115102903.png" alt=""></p>
<h3 id="ç¬¬ä¹é˜¶æ®µï¼šå¾®æœåŠ¡åŠä¸­å°åŒ–"><a href="#ç¬¬ä¹é˜¶æ®µï¼šå¾®æœåŠ¡åŠä¸­å°åŒ–" class="headerlink" title="ç¬¬ä¹é˜¶æ®µï¼šå¾®æœåŠ¡åŠä¸­å°åŒ–"></a>ç¬¬ä¹é˜¶æ®µï¼šå¾®æœåŠ¡åŠä¸­å°åŒ–</h3><p><img src="http://image.leonote.cn//20201115102933.png" alt=""></p>
<h3 id="ç¬¬åé˜¶æ®µ-å¤§æ•°æ®ä¸æ™ºèƒ½åŒ–"><a href="#ç¬¬åé˜¶æ®µ-å¤§æ•°æ®ä¸æ™ºèƒ½åŒ–" class="headerlink" title="ç¬¬åé˜¶æ®µ å¤§æ•°æ®ä¸æ™ºèƒ½åŒ–"></a>ç¬¬åé˜¶æ®µ å¤§æ•°æ®ä¸æ™ºèƒ½åŒ–</h3><h2 id="äº’è”ç½‘æ¶æ„æ¨¡å¼"><a href="#äº’è”ç½‘æ¶æ„æ¨¡å¼" class="headerlink" title="äº’è”ç½‘æ¶æ„æ¨¡å¼"></a>äº’è”ç½‘æ¶æ„æ¨¡å¼</h2><p>æ¯ä¸€ä¸ªæ¨¡å¼æè¿°äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬å‘¨å›´ä¸æ–­é‡å¤å‘ç”Ÿçš„é—®é¢˜ä»¥åŠè¯¥é—®é¢˜è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚è¿™ æ ·ï¼Œä½ å°±èƒ½ä¸€æ¬¡åˆä¸€æ¬¡çš„ä½¿ç”¨è¯¥æ–¹æ¡ˆè€Œä¸å¿…åšé‡å¤å·¥ä½œã€‚ </p>
<p>æ¨¡å¼çš„å…³é”®åœ¨äºæ¨¡å¼çš„å¯é‡å¤æ€§ï¼Œé—®é¢˜ä¸åœºæ™¯çš„å¯é‡å¤æ€§å¸¦æ¥è§£å†³æ–¹æ¡ˆçš„å¯é‡å¤ä½¿ç”¨ã€‚</p>
<p>äº’è”ç½‘æ¶æ„æ¨¡å¼å°±æ˜¯è¯•å›¾å»æè¿°é‚£äº›ä¸ºè§£å†³äº’è”ç½‘ç³»ç»Ÿé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€æ˜“æ‰©å±•ã€å¯ä¼¸ ç¼©ã€å®‰å…¨ç­‰ç›®æ ‡ï¼Œè¢«å¾ˆå¤šäº’è”ç½‘åº”ç”¨é‡å¤ä½¿ç”¨çš„ä¸€äº›è§£å†³æ–¹æ¡ˆï¼Œè¿™äº›è§£å†³æ–¹æ¡ˆæ˜¯äº’è”ç½‘ è½¯ä»¶ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<h3 id="åˆ†å±‚"><a href="#åˆ†å±‚" class="headerlink" title="åˆ†å±‚"></a>åˆ†å±‚</h3><p>åˆ†å±‚æ˜¯ä¼ä¸šåº”ç”¨ç³»ç»Ÿä¸­æœ€å¸¸è§çš„ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå°†ç³»ç»Ÿåœ¨æ¨ªå‘ç»´åº¦ä¸Šåˆ‡åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œ æ¯ä¸ªéƒ¨åˆ†è´Ÿè´£ä¸€éƒ¨åˆ†ç›¸å¯¹æ¯”è¾ƒå•ä¸€çš„èŒè´£ï¼Œç„¶åé€šè¿‡ä¸Šå±‚å¯¹ä¸‹å±‚ä¾èµ–å’Œè°ƒç”¨ç»„æˆä¸€ä¸ªå®Œ æ•´çš„ç³»ç»Ÿã€‚</p>
<h3 id="åˆ†å‰²"><a href="#åˆ†å‰²" class="headerlink" title="åˆ†å‰²"></a>åˆ†å‰²</h3><p>å¦‚æœè¯´åˆ†å±‚æ˜¯å°†è½¯ä»¶åœ¨æ¨ªå‘æ–¹é¢è¿›è¡Œåˆ‡åˆ†ï¼Œé‚£ä¹ˆåˆ†å‰²å°±æ˜¯åœ¨çºµå‘æ–¹é¢å¯¹è½¯ä»¶è¿›è¡Œåˆ‡åˆ†ã€‚ ç³»ç»Ÿè¶Šå¤§ï¼ŒåŠŸèƒ½è¶Šå¤æ‚ï¼ŒæœåŠ¡å’Œæ•°æ®å¤„ç†çš„ç§ç±»ä¹Ÿè¶Šå¤šï¼Œå°†è¿™äº›ä¸åŒçš„åŠŸèƒ½å’ŒæœåŠ¡åˆ†å‰²å¼€æ¥ï¼ŒåŒ…è£…æˆé«˜å†…èšä½è€¦åˆçš„æ¨¡å—å•å…ƒï¼Œä¸€æ–¹é¢æœ‰åŠ©äºè½¯ä»¶çš„å¼€å‘å’Œç»´æŠ¤ï¼›å¦ä¸€æ–¹é¢ï¼Œ ä¾¿äºä¸åŒæ¨¡å—çš„åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæé«˜ç½‘ç«™çš„å¹¶å‘å¤„ç†èƒ½åŠ›å’ŒåŠŸèƒ½æ‰©å±•èƒ½åŠ›ã€‚</p>
<h3 id="åˆ†å¸ƒå¼"><a href="#åˆ†å¸ƒå¼" class="headerlink" title="åˆ†å¸ƒå¼"></a>åˆ†å¸ƒå¼</h3><p>å¯¹äºå¤§å‹ç½‘ç«™ï¼Œ<strong>åˆ†å±‚å’Œåˆ†å‰²çš„ä¸€ä¸ªä¸»è¦ç›®çš„æ˜¯ä¸ºäº†åˆ‡åˆ†åçš„æ¨¡å—ä¾¿äºåˆ†å¸ƒå¼éƒ¨ç½²</strong>ï¼Œå°±æ˜¯å°†ä¸åŒæ¨¡å—éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡è¿œç¨‹è°ƒç”¨ååŒå·¥ä½œã€‚åˆ†å¸ƒå¼æ„å‘³ç€è§£å†³åŒæ ·çš„é—®é¢˜å¯ä»¥ä½¿ç”¨æ›´å¤šçš„è®¡ç®—æœºï¼Œè®¡ç®—æœºè¶Šå¤šï¼ŒCPUã€å†…å­˜ã€å­˜å‚¨èµ„æºä¹Ÿå°±è¶Šå¤šï¼Œèƒ½å¤Ÿå¤„ç†çš„å¹¶å‘è®¿é—®å’Œæ•°æ®é‡å°±è¶Šå¤§ã€‚</p>
<ul>
<li>åˆ†å¸ƒå¼åº”ç”¨å’ŒæœåŠ¡ </li>
<li>åˆ†å¸ƒå¼é™æ€èµ„æº </li>
<li>åˆ†å¸ƒå¼æ•°æ®å’Œå­˜å‚¨ </li>
<li>åˆ†å¸ƒå¼è®¡ç®—</li>
</ul>
<h3 id="é›†ç¾¤"><a href="#é›†ç¾¤" class="headerlink" title="é›†ç¾¤"></a>é›†ç¾¤</h3><p>ä½¿ç”¨åˆ†å¸ƒå¼è™½ç„¶å·²ç»å°†åˆ†å±‚å’Œåˆ†å‰²åçš„æ¨¡å—ç‹¬ç«‹éƒ¨ç½²ï¼Œä½†æ˜¯å¯¹äºç”¨æˆ·è®¿é—®é›†ä¸­çš„æ¨¡å—ï¼Œ æ¯”å¦‚ç½‘ç«™çš„é¦–é¡µï¼Œè¿˜éœ€è¦å°†ç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡å™¨é›†ç¾¤åŒ–ï¼Œå³å¤šå°æœåŠ¡å™¨éƒ¨ç½²ç›¸åŒåº”ç”¨æ„æˆä¸€ä¸ªé›†ç¾¤ï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡è®¾å¤‡å…±åŒå¯¹å¤–æä¾›æœåŠ¡ã€‚ </p>
<h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><p>ç¼“å­˜å°±æ˜¯å°†æ•°æ®å­˜æ”¾åœ¨è·ç¦»è®¡ç®—æœ€è¿‘çš„ä½ç½®ä»¥åŠ å¿«å¤„ç†é€Ÿåº¦ã€‚<strong>ç¼“å­˜æ˜¯æ”¹å–„è½¯ä»¶æ€§èƒ½çš„ç¬¬ä¸€æ‰‹æ®µ</strong>ï¼Œç°ä»£ CPU è¶Šæ¥è¶Šå¿«çš„ä¸€ä¸ªé‡è¦å› ç´ å°±æ˜¯ä½¿ç”¨äº†æ›´å¤šçš„ç¼“å­˜ï¼Œåœ¨å¤æ‚çš„è½¯ä»¶è®¾è®¡ä¸­ï¼Œç¼“å­˜å‡ ä¹æ— å¤„ä¸åœ¨ã€‚å¤§å‹ç½‘ç«™æ¶æ„è®¾è®¡åœ¨å¾ˆå¤šæ–¹é¢éƒ½ä½¿ç”¨äº†ç¼“å­˜è®¾è®¡ã€‚</p>
<ul>
<li>CDN </li>
<li>åå‘ä»£ç† </li>
<li>æœ¬åœ°ç¼“å­˜ </li>
<li>è¿œç¨‹ç¼“å­˜ </li>
</ul>
<h3 id="å¼‚æ­¥"><a href="#å¼‚æ­¥" class="headerlink" title="å¼‚æ­¥"></a>å¼‚æ­¥</h3><p>è®¡ç®—æœºè½¯ä»¶å‘å±•çš„ä¸€ä¸ªé‡è¦ç›®æ ‡å’Œé©±åŠ¨åŠ›æ˜¯<strong>é™ä½è½¯ä»¶è€¦åˆæ€§</strong>ã€‚äº‹ç‰©ä¹‹é—´è¶Šå°‘ç›´æ¥å…³ç³»ï¼Œ é‚£ä¹ˆå°±è¶Šå°‘è¢«å½¼æ­¤å½±å“ï¼Œè¶Šå¯ä»¥ç‹¬ç«‹å‘å±•ã€‚å¤§å‹ç½‘ç«™æ¶æ„ä¸­ï¼Œç³»ç»Ÿè§£è€¦åˆçš„æ‰‹æ®µé™¤äº†å‰é¢æåˆ°çš„åˆ†å±‚ã€åˆ†å‰²ã€åˆ†å¸ƒç­‰æ‰‹æ®µï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦æ‰‹æ®µæ˜¯å¼‚æ­¥ï¼Œå°±æ˜¯å°†ä¸€ä¸ªä¸šåŠ¡æ“ä½œåˆ†æˆå¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µä¹‹é—´<strong>é€šè¿‡å…±äº«æ•°æ®è€Œä¸æ˜¯ç›´æ¥è°ƒç”¨</strong>çš„æ–¹æ³•è¿›è¡Œåä½œã€‚ </p>
<ul>
<li>æé«˜ç³»ç»Ÿå¯ç”¨æ€§ </li>
<li>åŠ å¿«ç½‘ç«™å“åº”é€Ÿåº¦ </li>
<li>æ¶ˆé™¤å¹¶å‘è®¿é—®é«˜å³° </li>
</ul>
<h3 id="å†—ä½™"><a href="#å†—ä½™" class="headerlink" title="å†—ä½™"></a>å†—ä½™</h3><p>äº’è”ç½‘åº”ç”¨éœ€è¦ 7Ã—24 å°æ—¶è¿ç»­è¿è¡Œï¼Œä½†æ˜¯æœåŠ¡å™¨æ€»æœ‰å¯èƒ½ä¼šå‡ºç°æ•…éšœï¼Œç‰¹åˆ«æ˜¯æœåŠ¡å™¨è§„æ¨¡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œ<strong>æœåŠ¡å™¨å®•æœºæ˜¯å¿…ç„¶äº‹ä»¶</strong>ã€‚è¦æƒ³ä¿è¯åœ¨æœåŠ¡å™¨å®•æœºçš„æƒ…å†µä¸‹ç½‘ç«™ä¾ç„¶å¯ä»¥ç»§ç»­æœåŠ¡ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå°±éœ€è¦<strong>ä¸€å®šç¨‹åº¦çš„æœåŠ¡å™¨å†—ä½™è¿è¡Œï¼Œæ•°æ®å†—ä½™å¤‡ä»½</strong>ã€‚ </p>
<h3 id="è‡ªåŠ¨åŒ–"><a href="#è‡ªåŠ¨åŒ–" class="headerlink" title="è‡ªåŠ¨åŒ–"></a>è‡ªåŠ¨åŒ–</h3><p>åœ¨æ— äººå€¼å®ˆçš„æƒ…å†µä¸‹ç½‘ç«™å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä¸€åˆ‡éƒ½å¯ä»¥è‡ªåŠ¨åŒ–æ˜¯ç½‘ç«™çš„ç†æƒ³çŠ¶æ€ã€‚ç›®å‰äº’è”ç½‘çš„è‡ªåŠ¨åŒ–æ¶æ„è®¾è®¡ä¸»è¦é›†ä¸­åœ¨è¿ç»´æ–¹é¢ã€‚ </p>
<h3 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h3><p>äº’è”ç½‘çš„å¼€æ”¾ç‰¹æ€§ä½¿å¾—å…¶ä»è¯ç”Ÿèµ·å°±é¢å¯¹å·¨å¤§çš„å®‰å…¨æŒ‘æˆ˜ï¼Œç½‘ç«™åœ¨å®‰å…¨æ¶æ„æ–¹é¢ä¹Ÿç§¯ç´¯äº†è®¸å¤šæ¨¡å¼ï¼šé€šè¿‡å¯†ç å’Œæ‰‹æœºæ ¡éªŒç è¿›è¡Œ<strong>èº«ä»½è®¤è¯</strong>ï¼›ç™»å½•ã€äº¤æ˜“ç­‰æ“ä½œéœ€è¦å¯¹ç½‘ç»œé€šè®¯è¿›è¡Œ<strong>åŠ å¯†</strong>ï¼Œç½‘ç«™æœåŠ¡å™¨ä¸Šå­˜å‚¨çš„æ•æ„Ÿæ•°æ®å¦‚ç”¨æˆ·ä¿¡æ¯ç­‰ä¹Ÿè¿›è¡ŒåŠ å¯†å¤„ç†ï¼›ä¸ºäº†é˜²æ­¢æœºå™¨äººç¨‹åºæ»¥ç”¨ç½‘ç»œèµ„æºä¾›ç»™ç½‘ç«™ï¼Œç½‘ç«™ä½¿ç”¨<strong>éªŒè¯ç </strong>è¿›è¡Œè¯†åˆ«ï¼›å¯¹äºå¸¸è§çš„ç”¨äºæ”»å‡»ç½‘ç«™çš„ XSS æ”»å‡»ï¼ŒSQL æ³¨å…¥ï¼Œè¿›è¡Œ<strong>ç¼–ç è½¬æ¢</strong>ç­‰ç›¸åº”å¤„ç†ï¼›å¯¹äºåƒåœ¾ä¿¡æ¯ã€æ•æ„Ÿä¿¡æ¯è¿›è¡Œ<strong>è¿‡æ»¤</strong>ï¼› å¯¹è½¬è´¦äº¤æ˜“ç­‰é‡è¦æ“ä½œæ ¹æ®äº¤æ˜“æ¨¡å¼å’Œäº¤æ˜“ä¿¡æ¯è¿›è¡Œ<strong>é£é™©æ§åˆ¶</strong>ã€‚</p>
<h2 id="å¦‚ä½•è¡¡é‡ä¸€ä¸ªç³»ç»Ÿçš„æ¶æ„è®¾è®¡"><a href="#å¦‚ä½•è¡¡é‡ä¸€ä¸ªç³»ç»Ÿçš„æ¶æ„è®¾è®¡" class="headerlink" title="å¦‚ä½•è¡¡é‡ä¸€ä¸ªç³»ç»Ÿçš„æ¶æ„è®¾è®¡"></a>å¦‚ä½•è¡¡é‡ä¸€ä¸ªç³»ç»Ÿçš„æ¶æ„è®¾è®¡</h2><h3 id="é«˜æ€§èƒ½"><a href="#é«˜æ€§èƒ½" class="headerlink" title="é«˜æ€§èƒ½"></a>é«˜æ€§èƒ½</h3><p>æ€§èƒ½æ˜¯äº’è”ç½‘çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ï¼Œé™¤éæ˜¯æ²¡å¾—é€‰æ‹©ï¼Œå¦åˆ™ç”¨æˆ·æ— æ³•å¿å—ä¸€ä¸ªå“åº”ç¼“æ…¢çš„åº”ç”¨ã€‚ä¸€ä¸ªæ‰“å¼€ç¼“æ…¢åº”ç”¨ä¼šå¯¼è‡´ä¸¥é‡çš„ç”¨æˆ·æµå¤±ï¼Œå¾ˆå¤šæ—¶å€™ç³»ç»Ÿæ€§èƒ½é—®é¢˜æ˜¯ç³»ç»Ÿæ¶æ„å‡çº§ä¼˜åŒ–çš„è§¦å‘å™¨ã€‚å¯ä»¥è¯´æ€§èƒ½æ˜¯äº’è”ç½‘ç³»ç»Ÿæ¶æ„è®¾è®¡çš„ä¸€ä¸ªé‡è¦æ–¹é¢ï¼Œä»»ä½•æ¶æ„è®¾è®¡æ–¹æ¡ˆéƒ½å¿…é¡»è€ƒè™‘å¯èƒ½ä¼šå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚ </p>
<p>ä¹Ÿæ­£æ˜¯å› ä¸ºæ€§èƒ½é—®é¢˜å‡ ä¹æ— å¤„ä¸åœ¨ï¼Œæ‰€ä»¥ä¼˜åŒ–ç½‘ç«™æ€§èƒ½çš„æ‰‹æ®µä¹Ÿéå¸¸å¤šï¼Œä»ç”¨æˆ·ç«¯åˆ°æ•°æ®åº“ï¼Œä»ä»£ç åˆ°æœºæˆ¿éƒ¨ç½²ï¼Œ<strong>å½±å“ç”¨æˆ·è¯·æ±‚çš„æ‰€æœ‰ç¯èŠ‚éƒ½å¯ä»¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</strong>ã€‚</p>
<h3 id="é«˜å¯ç”¨"><a href="#é«˜å¯ç”¨" class="headerlink" title="é«˜å¯ç”¨"></a>é«˜å¯ç”¨</h3><p>å› ä¸ºäº’è”ç½‘åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨çš„æœåŠ¡å™¨ç¡¬ä»¶é€šå¸¸æ˜¯æ™®é€šçš„å•†ç”¨æœåŠ¡å™¨ï¼Œè¿™äº›æœåŠ¡å™¨çš„è®¾è®¡ç›®æ ‡æœ¬èº«å¹¶ä¸ä¿è¯é«˜å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„æœåŠ¡å™¨å®•æœºã€‚å¤§å‹äº’è”ç½‘ç³»ç»Ÿé€šå¸¸éƒ½ä¼šæœ‰ä¸Šä¸‡å°æœåŠ¡å™¨ï¼Œæ¯å¤©éƒ½å¿…å®šä¼šæœ‰ä¸€äº›æœåŠ¡å™¨å®•æœºï¼Œå› æ­¤<strong>ç³»ç»Ÿé«˜å¯ç”¨æ¶æ„è®¾è®¡çš„å‰ææ˜¯å¿…ç„¶ä¼šå‡ºç°æœåŠ¡å™¨å®•æœº</strong>ï¼Œè€Œé«˜å¯ç”¨è®¾è®¡çš„ç›®æ ‡å°±æ˜¯å½“æœåŠ¡å™¨å®•æœºçš„æ—¶å€™ï¼ŒæœåŠ¡æˆ–è€…åº”ç”¨ä¾ç„¶å¯ç”¨ã€‚ ç³»ç»Ÿé«˜å¯ç”¨çš„ä¸»è¦æ‰‹æ®µæ˜¯<strong>å†—ä½™</strong>ï¼Œåº”ç”¨éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸ŠåŒæ—¶æä¾›è®¿é—®ï¼Œæ•°æ®å­˜å‚¨åœ¨å¤šå°æœåŠ¡å™¨ä¸Šäº’ç›¸å¤‡ä»½ï¼Œä»»ä½•ä¸€å°æœåŠ¡å™¨å®•æœºéƒ½ä¸ä¼šå½±å“åº”ç”¨çš„æ•´ä½“å¯ç”¨ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</p>
<h3 id="å¯ä¼¸ç¼©"><a href="#å¯ä¼¸ç¼©" class="headerlink" title="å¯ä¼¸ç¼©"></a>å¯ä¼¸ç¼©</h3><p>å¤§å‹äº’è”ç½‘åº”ç”¨é€šè¿‡é›†ç¾¤çš„æ–¹å¼å°†å¤šå°æœåŠ¡å™¨ç»„æˆä¸€ä¸ªæ•´ä½“å…±åŒæä¾›æœåŠ¡ã€‚æ‰€è°“ä¼¸ç¼©æ€§æ˜¯æŒ‡<strong>é€šè¿‡ä¸æ–­å‘é›†ç¾¤ä¸­åŠ å…¥æœåŠ¡å™¨çš„æ‰‹æ®µæ¥ç¼“è§£ä¸æ–­ä¸Šå‡çš„ç”¨æˆ·å¹¶å‘è®¿é—®å‹åŠ›å’Œä¸æ–­å¢é•¿çš„æ•°æ®å­˜å‚¨éœ€æ±‚</strong>ã€‚ </p>
<p>è¡¡é‡æ¶æ„ä¼¸ç¼©æ€§çš„<strong>ä¸»è¦æ ‡å‡†</strong>å°±æ˜¯</p>
<ul>
<li>æ˜¯å¦å¯ä»¥ç”¨å¤šå°æœåŠ¡å™¨æ„å»ºé›†ç¾¤</li>
<li>æ˜¯å¦å®¹æ˜“å‘é›†ç¾¤ä¸­æ·»åŠ æ–°çš„æœåŠ¡å™¨</li>
<li>åŠ å…¥æ–°çš„æœåŠ¡å™¨åæ˜¯å¦å¯ä»¥æä¾›å’ŒåŸæ¥çš„æœåŠ¡å™¨æ— å·®åˆ«çš„æœåŠ¡</li>
<li>é›†ç¾¤ä¸­å¯å®¹çº³çš„æ€»çš„æœåŠ¡å™¨æ•°é‡æ˜¯å¦æœ‰é™åˆ¶</li>
</ul>
<h3 id="å¯æ‰©å±•"><a href="#å¯æ‰©å±•" class="headerlink" title="å¯æ‰©å±•"></a>å¯æ‰©å±•</h3><p>ä¸åŒäºå…¶ä»–æ¶æ„è¦ç´ ä¸»è¦å…³æ³¨éåŠŸèƒ½æ€§éœ€æ±‚ï¼Œ<strong>æ‰©å±•æ€§æ¶æ„ç›´æ¥å…³æ³¨ç³»ç»Ÿçš„åŠŸèƒ½éœ€æ±‚</strong>ã€‚äº’è”ç½‘åº”ç”¨å¿«é€Ÿå‘å±•ï¼ŒåŠŸèƒ½ä¸æ–­æ‰©å±•ï¼Œå¦‚ä½•è®¾è®¡ç³»ç»Ÿçš„æ¶æ„ä½¿å…¶èƒ½å¤Ÿå¿«é€Ÿå“åº”éœ€æ±‚å˜åŒ–ï¼Œ æ˜¯ç³»ç»Ÿå¯æ‰©å±•æ¶æ„ä¸»è¦çš„ç›®çš„ã€‚ </p>
<p>è¡¡é‡ç³»ç»Ÿæ¶æ„æ‰©å±•æ€§å¥½åçš„ä¸»è¦æ ‡å‡†å°±æ˜¯åœ¨ç³»ç»Ÿå¢åŠ æ–°çš„ä¸šåŠ¡äº§å“æ—¶</p>
<ul>
<li>æ˜¯å¦å¯ä»¥å®ç°<strong>å¯¹ç°æœ‰äº§å“é€æ˜æ— å½±å“</strong>ï¼Œä¸éœ€è¦ä»»ä½•æ”¹åŠ¨æˆ–è€…å¾ˆå°‘æ”¹åŠ¨æ—¢æœ‰ä¸šåŠ¡åŠŸèƒ½å°±å¯ä»¥ä¸Šçº¿æ–°äº§å“ã€‚</li>
<li>ä¸åŒäº§å“ä¹‹é—´æ˜¯å¦å¾ˆ<strong>å°‘è€¦åˆ</strong>ï¼Œä¸€ä¸ªäº§å“æ”¹åŠ¨å¯¹å…¶ä»–äº§å“æ— å½±å“ï¼Œå…¶ä»–äº§å“å’ŒåŠŸèƒ½ä¸éœ€è¦ å—ç‰µè¿è¿›è¡Œæ”¹åŠ¨ã€‚ </li>
</ul>
<p>å¯æ‰©å±•æ¶æ„çš„ä¸»è¦æ‰‹æ®µæ˜¯<strong>äº‹ä»¶é©±åŠ¨æ¶æ„</strong>å’Œ<strong>åˆ†å¸ƒå¼æœåŠ¡</strong>ã€‚</p>
<h3 id="å®‰å…¨-1"><a href="#å®‰å…¨-1" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h3><p>äº’è”ç½‘æ˜¯å¼€æ”¾çš„ï¼Œä»»ä½•äººåœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®ç³»ç»Ÿã€‚ç³»ç»Ÿçš„å®‰å…¨æ¶æ„å°±æ˜¯ä¿æŠ¤ç³»ç»Ÿä¸å—æ¶æ„è®¿é—®å’Œæ”»å‡»ï¼Œä¿æŠ¤ç½‘ç«™çš„é‡è¦æ•°æ®ä¸è¢«çªƒå–ã€‚ </p>
<p>è¡¡é‡ç³»ç»Ÿå®‰å…¨æ¶æ„çš„æ ‡å‡†å°±æ˜¯é’ˆå¯¹ç°å­˜å’Œæ½œåœ¨çš„å„ç§æ”»å‡»ä¸çªƒå¯†æ‰‹æ®µï¼Œæ˜¯å¦æœ‰å¯é çš„åº”å¯¹ç­–ç•¥ã€‚</p>
<h2 id="äº’è”ç½‘æ¶æ„æŠ€æœ¯"><a href="#äº’è”ç½‘æ¶æ„æŠ€æœ¯" class="headerlink" title="äº’è”ç½‘æ¶æ„æŠ€æœ¯"></a>äº’è”ç½‘æ¶æ„æŠ€æœ¯</h2><p><img src="http://image.leonote.cn//20201115105842.png" alt=""></p>
<h3 id="å‰ç«¯æ¶æ„"><a href="#å‰ç«¯æ¶æ„" class="headerlink" title="å‰ç«¯æ¶æ„"></a>å‰ç«¯æ¶æ„</h3><ul>
<li>App åŠ Web å¼€å‘æŠ€æœ¯</li>
<li>æµè§ˆå™¨åŠ HTTP ä¼˜åŒ–æŠ€æœ¯</li>
<li>CDN</li>
<li>åŠ¨é™åˆ†ç¦»</li>
<li>å›¾ç‰‡æœåŠ¡</li>
<li>åå‘ä»£ç†</li>
<li>DNS</li>
</ul>
<h3 id="ç½‘å…³åŠåº”ç”¨å±‚æ¶æ„"><a href="#ç½‘å…³åŠåº”ç”¨å±‚æ¶æ„" class="headerlink" title="ç½‘å…³åŠåº”ç”¨å±‚æ¶æ„"></a>ç½‘å…³åŠåº”ç”¨å±‚æ¶æ„</h3><ul>
<li>ç½‘å…³æ¶æ„</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>åŠ¨æ€é¡µé¢é™æ€åŒ–</li>
<li>ä¸šåŠ¡æ‹†åˆ† </li>
</ul>
<h3 id="æœåŠ¡å±‚æ¶æ„"><a href="#æœåŠ¡å±‚æ¶æ„" class="headerlink" title="æœåŠ¡å±‚æ¶æ„"></a>æœåŠ¡å±‚æ¶æ„</h3><ul>
<li>å¾®æœåŠ¡æ¡†æ¶</li>
<li>åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>åˆ†å¸ƒå¼ç¼“å­˜</li>
<li>åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼ˆé”ï¼‰æœåŠ¡ </li>
</ul>
<h3 id="å­˜å‚¨å±‚æ¶æ„"><a href="#å­˜å‚¨å±‚æ¶æ„" class="headerlink" title="å­˜å‚¨å±‚æ¶æ„"></a>å­˜å‚¨å±‚æ¶æ„</h3><ul>
<li>åˆ†å¸ƒå¼æ–‡ä»¶</li>
<li>åˆ†å¸ƒå¼å…³ç³»æ•°æ®åº“</li>
<li>NoSQL æ•°æ®åº“ </li>
</ul>
<h3 id="åå°æ¶æ„"><a href="#åå°æ¶æ„" class="headerlink" title="åå°æ¶æ„"></a>åå°æ¶æ„</h3><ul>
<li>å¤§æ•°æ®å¹³å°</li>
<li>æœç´¢å¼•æ“</li>
<li>æ¨èå¼•æ“</li>
<li>æ•°æ®ä»“åº“ </li>
</ul>
<h3 id="è¿ç»´ä¸å®‰å…¨"><a href="#è¿ç»´ä¸å®‰å…¨" class="headerlink" title="è¿ç»´ä¸å®‰å…¨"></a>è¿ç»´ä¸å®‰å…¨</h3><ul>
<li>æ•°æ®é‡‡é›†ä¸å±•ç¤º </li>
<li>æ•°æ®ç›‘æ§ä¸æŠ¥è­¦ </li>
<li>æ”»å‡»ä¸é˜²æŠ¤</li>
<li>æ•°æ®åŠ å¯†ä¸è§£å¯†</li>
</ul>
]]></content>
      <categories>
        <category>æ¶æ„</category>
      </categories>
      <tags>
        <tag>æ¶æ„</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼</title>
    <url>/2020/11/09/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h2><p>åˆå«åš<strong>é™æ€å·¥å‚æ–¹æ³•</strong>ï¼ˆStatic Factory Methodï¼‰</p>
<blockquote>
<p>ç®€å•å·¥å‚æ¨¡å¼çš„å®è´¨æ˜¯ç”±ä¸€ä¸ªå·¥å‚ç±»<strong>æ ¹æ®ä¼ å…¥çš„å‚æ•°</strong>ï¼Œ<strong>åŠ¨æ€å†³å®š</strong>åº”è¯¥<strong>åˆ›å»ºå“ªä¸€ä¸ªäº§å“ç±»</strong>ã€‚ </p>
</blockquote>
<p>Spring ä¸­çš„<code>BeanFactory</code>å°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„ä½“ç°ï¼Œæ ¹æ®ä¼ å…¥ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†æ¥è·å¾—beanå¯¹è±¡ï¼Œä½†æ˜¯å¦æ˜¯åœ¨ä¼ å…¥å‚æ•°ååˆ›å»ºè¿˜æ˜¯ä¼ å…¥å‚æ•°å‰åˆ›å»ºè¿™ä¸ªè¦æ ¹æ®å…·ä½“æƒ…å†µæ¥å®šã€‚å¦‚ä¸‹é…ç½®ï¼Œå°±æ˜¯åœ¨ <code>HelloItxxz</code> ç±»ä¸­åˆ›å»ºä¸€ä¸ª <code>itxxzBean</code>ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;singletonBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.itxxz.HelloItxxz&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>Hello! è¿™æ˜¯singletonBean<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;itxxzBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.itxxz.HelloItxxz&quot;</span>  <span class="attr">singleton</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">value</span>&gt;</span>Hello! è¿™æ˜¯itxxzBean! <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h2><h3 id="æ‡’æ±‰æ¨¡å¼"><a href="#æ‡’æ±‰æ¨¡å¼" class="headerlink" title="æ‡’æ±‰æ¨¡å¼"></a>æ‡’æ±‰æ¨¡å¼</h3><p>çº¿ç¨‹ä¸å®‰å…¨å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒé‡æ£€æŸ¥æ¨¡å¼å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton; </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123; </span><br><span class="line">      <span class="keyword">synchronized</span> (Singleton.class) &#123; </span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">          singleton = <span class="keyword">new</span> Singleton(); </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singleton;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é¥¿æ±‰å•ä¾‹æ¨¡å¼"><a href="#é¥¿æ±‰å•ä¾‹æ¨¡å¼" class="headerlink" title="é¥¿æ±‰å•ä¾‹æ¨¡å¼"></a>é¥¿æ±‰å•ä¾‹æ¨¡å¼</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton instance = <span class="keyword">new</span> Singleton();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æšä¸¾å•ä¾‹æ¨¡å¼"><a href="#æšä¸¾å•ä¾‹æ¨¡å¼" class="headerlink" title="æšä¸¾å•ä¾‹æ¨¡å¼"></a>æšä¸¾å•ä¾‹æ¨¡å¼</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">  INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ç­–ç•¥æ¨¡å¼-Strategy-Pattern"><a href="#ç­–ç•¥æ¨¡å¼-Strategy-Pattern" class="headerlink" title="ç­–ç•¥æ¨¡å¼ ( Strategy Pattern )"></a>ç­–ç•¥æ¨¡å¼ ( Strategy Pattern )</h2><h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><p>è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚</p>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ol>
<li>ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è¯­å¥</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç³»åˆ—çš„å¯ä¾›é‡ç”¨çš„ç®—æ³•æ—ï¼Œæ°å½“ä½¿ç”¨ç»§æ‰¿å¯ä»¥æŠŠç®—æ³•æ—çš„å…¬å…±ä»£ç è½¬ç§»åˆ°çˆ¶ç±»é‡Œé¢ï¼Œä»è€Œé¿å…é‡å¤çš„ä»£ç </li>
<li>ç­–ç•¥æ¨¡å¼å¯ä»¥æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸åŒå®ç°ï¼Œå®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæ—¶é—´æˆ–ç©ºé—´è¦æ±‚é€‰æ‹©ä¸åŒçš„</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŸåˆ™çš„å®Œç¾æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸä»£ç çš„æƒ…å†µä¸‹ï¼Œçµæ´»å¢åŠ æ–°ç®—æ³•</li>
<li>ç­–ç•¥æ¨¡å¼æŠŠç®—æ³•çš„ä½¿ç”¨æ”¾åˆ°ç¯å¢ƒç±»ä¸­ï¼Œè€Œç®—æ³•çš„å®ç°ç§»åˆ°å…·ä½“ç­–ç•¥ç±»ä¸­ï¼Œå®ç°äº†äºŒè€…çš„åˆ†ç¦»</li>
</ol>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li>å®¢æˆ·ç«¯å¿…é¡»ç†è§£æ‰€æœ‰ç­–ç•¥ç®—æ³•çš„åŒºåˆ«ï¼Œä»¥ä¾¿é€‚æ—¶é€‰æ‹©æ°å½“çš„ç®—æ³•ç±»</li>
<li>ç­–ç•¥æ¨¡å¼é€ æˆå¾ˆå¤šçš„ç­–ç•¥ç±»</li>
</ol>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><h4 id="ç»§æ‰¿å®ç°"><a href="#ç»§æ‰¿å®ç°" class="headerlink" title="ç»§æ‰¿å®ç°"></a>ç»§æ‰¿å®ç°</h4><p>å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¼ºåˆ¶å­ç±»å®ç°è¯¥æ–¹æ³•</p>
<p>è¿™ç§å®ç°ï¼Œå¯¹çˆ¶ç±»å¯¹å­ç±»ä¸ä¸€å®šæ˜¯é€æ˜çš„ï¼Œå¦‚æœçˆ¶ç±»æä¾›äº†é»˜è®¤çš„å®ç°ï¼Œå­ç±»éœ€è¦äº†è§£å®ç°çš„ç»†èŠ‚ï¼Œå†å†³å®šæ˜¯å¦é‡å†™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¹Ÿå¯ä»¥å°†è¯¥æ–¹æ³•è®¾ç½®æˆæŠ½è±¡æ–¹æ³•ï¼Œ å¼ºè¿«å­ç±»æ¥å®ç°è¯¥æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æä¾›ä¸€ä¸ªé»˜è®¤çš„å®ç°</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionModelA</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    aStyleBrake();<span class="comment">// A é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionModelB</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bStyleBrake(); <span class="comment">// B é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ç»„åˆå®ç°"><a href="#ç»„åˆå®ç°" class="headerlink" title="ç»„åˆå®ç°"></a>ç»„åˆå®ç°</h4><p>è¿™ç§å®ç°æ˜¯é€æ˜çš„ï¼Œåªéœ€è¦æ”¹å˜å¯¹è±¡çš„å¼•ç”¨å°±å¯ä»¥æ”¹å˜å…¶è¡Œä¸ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBrakeBehavior</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AStyleBrake</span> <span class="keyword">implements</span> <span class="title">IBrakeBehavior</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    aStyleBrake(); <span class="comment">// A é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BStyleBrake</span> <span class="keyword">implements</span> <span class="title">IBrakeBehavior</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bStyleBrake(); <span class="comment">// B é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> IBrakeBehavior brakeBehavior;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    brakeBehavior.execute();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrakeBehavior</span><span class="params">(<span class="keyword">final</span> IBrakeBehavior brakeType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.brakeBehavior = brakeType;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åé€šè¿‡å·¥å‚ç±»ï¼Œæ ¹æ®è¿è¡Œçš„å‚æ•°é€‰æ‹©å‡ºå¯¹åº”çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Action action  = ActionFactory.createAction(String parameters);   action.execute();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åªæœ‰åœ¨ç­–ç•¥é€‰æ‹©é‡Œæœ‰æ¡ä»¶é€‰æ‹©è¯­å¥ï¼Œå…¶ä»–åœ°æ–¹ä¸å‡ºç°ã€‚</p>
<p>å¦‚ä¸Šè¿°çš„<code>createAction()</code>æ–¹æ³•</p>
</blockquote>
<h2 id="é€‚é…å™¨æ¨¡å¼-Adapter-Pattern"><a href="#é€‚é…å™¨æ¨¡å¼-Adapter-Pattern" class="headerlink" title="é€‚é…å™¨æ¨¡å¼ ( Adapter Pattern )"></a>é€‚é…å™¨æ¨¡å¼ ( Adapter Pattern )</h2><h3 id="å®šä¹‰-1"><a href="#å®šä¹‰-1" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œã€‚åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>ç±»é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸é€‚é…è€…ä¹‹é—´æ˜¯<strong>ç»§æ‰¿ï¼ˆæˆ–å®ç°ï¼‰å…³ç³»</strong></li>
<li>å¯¹è±¡é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸é€‚é…è€…ä¹‹é—´æ˜¯<strong>å…³è”å…³ç³»</strong></li>
</ul>
<p>å‰è€…çš„è€¦åˆåº¦æ¯”åè€…é«˜ï¼Œä¸”è¦æ±‚å¼€å‘äº†è§£ç°æœ‰ç»„ä»¶åº“ä¸­çš„ç›¸å…³ç»„ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œåº”ç”¨ç›¸å¯¹è¾ƒå°‘äº›ã€‚</p>
<h3 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><ul>
<li>å°†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»è§£è€¦ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªé€‚é…å™¨ç±»æ¥é‡ç”¨ç°æœ‰çš„é€‚é…è€…ç±»ï¼Œè€Œæ— é¡»ä¿®æ”¹åŸæœ‰ä»£ç ã€‚</li>
<li>å¢åŠ äº†ç±»çš„é€æ˜æ€§å’Œå¤ç”¨æ€§ï¼Œå°†å…·ä½“çš„å®ç°å°è£…åœ¨é€‚é…è€…ç±»ä¸­ï¼Œå¯¹äºå®¢æˆ·ç«¯ç±»æ¥è¯´æ˜¯é€æ˜çš„ï¼Œè€Œä¸”æé«˜äº†é€‚é…è€…çš„å¤ç”¨æ€§ã€‚</li>
<li>çµæ´»æ€§å’Œæ‰©å±•æ€§éƒ½éå¸¸å¥½ï¼Œé€šè¿‡ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›´æ¢é€‚é…å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šå¢åŠ æ–°çš„é€‚é…å™¨ç±»ï¼Œå®Œå…¨ç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ã€‚</li>
</ul>
<p><strong>ç±»é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š</strong></p>
<p>ç”±äºé€‚é…å™¨ç±»æ˜¯é€‚é…è€…ç±»çš„å­ç±»ï¼Œå› æ­¤å¯ä»¥åœ¨é€‚é…å™¨ç±»ä¸­ç½®æ¢ä¸€äº›é€‚é…è€…çš„æ–¹æ³•ï¼Œä½¿å¾—é€‚é…å™¨çš„çµæ´»æ€§æ›´å¼ºã€‚</p>
<p><strong>å¯¹è±¡é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š</strong></p>
<p>åŒä¸€ä¸ªé€‚é…å™¨å¯ä»¥æŠŠé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æ¥å£ã€‚</p>
<h3 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><p><strong>ç±»é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š</strong></p>
<p>å¯¹äº Java ç­‰ä¸æ”¯æŒå¤šé‡ç»§æ‰¿çš„è¯­è¨€ï¼Œä¸€æ¬¡æœ€å¤šåªèƒ½é€‚é…ä¸€ä¸ªé€‚é…è€…ç±»ï¼Œè€Œä¸”ç›®æ ‡æŠ½è±¡ç±»åªèƒ½ä¸ºæŠ½è±¡ç±»ï¼Œä¸èƒ½ä¸ºå…·ä½“ç±»ï¼Œå…¶ä½¿ç”¨æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œä¸èƒ½å°†ä¸€ä¸ªé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æ¥å£ã€‚</p>
<p><strong>å¯¹è±¡é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š</strong></p>
<p>ä¸ç±»é€‚é…å™¨æ¨¡å¼ç›¸æ¯”ï¼Œè¦æƒ³ç½®æ¢é€‚é…è€…ç±»çš„æ–¹æ³•å°±ä¸å®¹æ˜“ã€‚å¦‚æœä¸€å®šè¦ç½®æ¢æ‰é€‚é…è€…ç±»çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹æ³•ï¼Œå°±åªå¥½å…ˆåšä¸€ä¸ªé€‚é…è€…ç±»çš„å­ç±»ï¼Œå°†é€‚é…è€…ç±»çš„æ–¹æ³•ç½®æ¢æ‰ï¼Œç„¶åå†æŠŠé€‚é…è€…ç±»çš„å­ç±»å½“åšçœŸæ­£çš„é€‚é…è€…è¿›è¡Œé€‚é…ï¼Œå®ç°è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ã€‚</p>
<h3 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h3><p><strong>è§’è‰²</strong></p>
<ul>
<li><strong>Targetï¼ˆç›®æ ‡æŠ½è±¡ç±»ï¼‰</strong>ï¼šç›®æ ‡æŠ½è±¡ç±»å®šä¹‰å®¢æˆ·æ‰€éœ€æ¥å£ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–æ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“ç±»ã€‚</li>
<li><strong>Adapterï¼ˆé€‚é…å™¨ç±»ï¼‰</strong>ï¼šé€‚é…å™¨å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªæ¥å£ï¼Œä½œä¸ºä¸€ä¸ªè½¬æ¢å™¨ï¼Œå¯¹ Adaptee å’Œ Target è¿›è¡Œé€‚é…ï¼Œé€‚é…å™¨ç±»æ˜¯é€‚é…å™¨æ¨¡å¼çš„æ ¸å¿ƒï¼Œåœ¨å¯¹è±¡é€‚é…å™¨ä¸­ï¼Œå®ƒé€šè¿‡ç»§æ‰¿ Target å¹¶å…³è”ä¸€ä¸ª Adaptee å¯¹è±¡ä½¿äºŒè€…äº§ç”Ÿè”ç³»ã€‚</li>
<li><strong>Adapteeï¼ˆé€‚é…è€…ç±»ï¼‰</strong>ï¼šé€‚é…è€…å³è¢«é€‚é…çš„è§’è‰²ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£éœ€è¦é€‚é…ï¼Œé€‚é…è€…ç±»ä¸€èˆ¬æ˜¯ä¸€ä¸ªå…·ä½“ç±»ï¼ŒåŒ…å«äº†å®¢æˆ·å¸Œæœ›ä½¿ç”¨çš„ä¸šåŠ¡æ–¹æ³•ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ²¡æœ‰é€‚é…è€…ç±»çš„æºä»£ç ã€‚</li>
</ul>
<h4 id="ç±»é€‚é…å™¨"><a href="#ç±»é€‚é…å™¨" class="headerlink" title="ç±»é€‚é…å™¨"></a>ç±»é€‚é…å™¨</h4><p>é¦–å…ˆæœ‰ä¸€ä¸ªå·²å­˜åœ¨çš„å°†è¢«é€‚é…çš„ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adaptee</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adapteeRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¢«é€‚é…è€…çš„æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰ä¸€ä¸ªç›®æ ‡æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœé€šè¿‡ä¸€ä¸ªé€‚é…å™¨ç±»ï¼Œå®ç° <code>Target</code> æ¥å£ï¼ŒåŒæ—¶ç»§æ‰¿äº† <code>Adaptee</code> ç±»ï¼Œç„¶ååœ¨å®ç°çš„ <code>request()</code> æ–¹æ³•ä¸­è°ƒç”¨çˆ¶ç±»çš„ <code>adapteeRequest()</code> å³å¯å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">Adaptee</span> <span class="keyword">implements</span> <span class="title">Target</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...ä¸€äº›æ“ä½œ...</span></span><br><span class="line">        <span class="keyword">super</span>.adapteeRequest();</span><br><span class="line">        <span class="comment">//...ä¸€äº›æ“ä½œ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯¹è±¡é€‚é…å™¨"><a href="#å¯¹è±¡é€‚é…å™¨" class="headerlink" title="å¯¹è±¡é€‚é…å™¨"></a>å¯¹è±¡é€‚é…å™¨</h4><p>å¯¹è±¡é€‚é…å™¨ä¸ç±»é€‚é…å™¨ä¸åŒä¹‹å¤„åœ¨äºï¼Œç±»é€‚é…å™¨é€šè¿‡ç»§æ‰¿æ¥å®Œæˆé€‚é…ï¼Œå¯¹è±¡é€‚é…å™¨åˆ™æ˜¯é€šè¿‡å…³è”æ¥å®Œæˆï¼Œè¿™é‡Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ <code>Adapter</code> ç±»å³å¯å°†è½¬å˜ä¸ºå¯¹è±¡é€‚é…å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">implements</span> <span class="title">Target</span></span>&#123;</span><br><span class="line">    <span class="comment">// é€‚é…è€…æ˜¯å¯¹è±¡é€‚é…å™¨çš„ä¸€ä¸ªå±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> Adaptee adaptee = <span class="keyword">new</span> Adaptee();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        adaptee.adapteeRequest();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="è£…é¥°å™¨æ¨¡å¼"><a href="#è£…é¥°å™¨æ¨¡å¼" class="headerlink" title="è£…é¥°å™¨æ¨¡å¼"></a>è£…é¥°å™¨æ¨¡å¼</h2><p>åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬çš„é¡¹ç›®<strong>éœ€è¦è¿æ¥å¤šä¸ªæ•°æ®åº“</strong>ï¼Œè€Œä¸”ä¸åŒçš„å®¢æˆ·åœ¨æ¯æ¬¡è®¿é—®ä¸­æ ¹æ®éœ€è¦ä¼šå»è®¿é—®ä¸åŒçš„æ•°æ®åº“ã€‚æˆ‘ä»¬ä»¥å¾€åœ¨springå’Œhibernateæ¡†æ¶ä¸­æ€»æ˜¯é…ç½®ä¸€ä¸ªæ•°æ®æºï¼Œå› è€Œ<code>sessionFactory</code>çš„<code>dataSource</code>å±æ€§æ€»æ˜¯æŒ‡å‘è¿™ä¸ªæ•°æ®æºå¹¶ä¸”æ’å®šä¸å˜ï¼Œæ‰€æœ‰DAOåœ¨ä½¿ç”¨<code>sessionFactory</code>çš„æ—¶å€™éƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ•°æ®æºè®¿é—®æ•°æ®åº“ã€‚</p>
<p>ä½†æ˜¯ç°åœ¨ï¼Œç”±äºé¡¹ç›®çš„éœ€è¦ï¼Œæˆ‘ä»¬çš„DAOåœ¨è®¿é—®<code>sessionFactory</code>çš„æ—¶å€™éƒ½ä¸å¾—ä¸<strong>åœ¨å¤šä¸ªæ•°æ®æºä¸­ä¸æ–­åˆ‡æ¢</strong>ï¼Œé—®é¢˜å°±å‡ºç°äº†ï¼šå¦‚ä½•è®©<code>sessionFactory</code>åœ¨æ‰§è¡Œæ•°æ®æŒä¹…åŒ–çš„æ—¶å€™ï¼Œæ ¹æ®å®¢æˆ·çš„éœ€æ±‚èƒ½å¤ŸåŠ¨æ€åˆ‡æ¢ä¸åŒçš„æ•°æ®æºï¼Ÿæˆ‘ä»¬èƒ½ä¸èƒ½åœ¨springçš„æ¡†æ¶ä¸‹é€šè¿‡å°‘é‡ä¿®æ”¹å¾—åˆ°è§£å†³ï¼Ÿæ˜¯å¦æœ‰ä»€ä¹ˆè®¾è®¡æ¨¡å¼å¯ä»¥åˆ©ç”¨å‘¢ï¼Ÿ </p>
<p>é¦–å…ˆæƒ³åˆ°åœ¨springçš„<code>applicationContext</code>ä¸­é…ç½®æ‰€æœ‰çš„<code>dataSource</code>ã€‚è¿™äº›<code>dataSource</code>å¯èƒ½æ˜¯å„ç§ä¸åŒç±»å‹çš„ï¼Œæ¯”å¦‚ä¸åŒçš„æ•°æ®åº“ï¼šOracleã€SQL Serverã€MySQLç­‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸åŒçš„æ•°æ®æºï¼šæ¯”å¦‚apache æä¾›çš„<code>org.apache.commons.dbcp.BasicDataSource</code>ã€springæä¾›çš„<code>org.springframework.jndi.JndiObjectFactoryBean</code>ç­‰ã€‚ç„¶å<code>sessionFactory</code>æ ¹æ®å®¢æˆ·çš„æ¯æ¬¡è¯·æ±‚ï¼Œå°†<code>dataSource</code>å±æ€§è®¾ç½®æˆä¸åŒçš„æ•°æ®æºï¼Œä»¥åˆ°è¾¾åˆ‡æ¢æ•°æ®æºçš„ç›®çš„ã€‚</p>
<p>springä¸­ç”¨åˆ°çš„<strong>åŒ…è£…å™¨æ¨¡å¼åœ¨ç±»å</strong>ä¸Šæœ‰ä¸¤ç§è¡¨ç°ï¼šä¸€ç§æ˜¯ç±»åä¸­å«æœ‰<strong>Wrapper</strong>ï¼Œå¦ä¸€ç§æ˜¯ç±»åä¸­å«æœ‰<strong>Decorator</strong>ã€‚</p>
<blockquote>
<p>åŸºæœ¬ä¸Šéƒ½æ˜¯<strong>åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£</strong>ã€‚</p>
</blockquote>
<h2 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h2><p>å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚Template Methodä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</p>
<p>Template Methodæ¨¡å¼ä¸€èˆ¬æ˜¯éœ€è¦ç»§æ‰¿çš„ã€‚è¿™é‡Œæƒ³è¦æ¢è®¨å¦ä¸€ç§å¯¹Template Methodçš„ç†è§£ã€‚springä¸­çš„<code>JdbcTemplate</code>ï¼Œåœ¨ç”¨è¿™ä¸ªç±»æ—¶å¹¶ä¸æƒ³å»ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»çš„æ–¹æ³•å¤ªå¤šï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æƒ³ç”¨åˆ°<code>JdbcTemplate</code>å·²æœ‰çš„ç¨³å®šçš„ã€å…¬ç”¨çš„æ•°æ®åº“è¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠå˜åŒ–çš„ä¸œè¥¿æŠ½å‡ºæ¥ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ å…¥<code>JdbcTemplate</code>çš„æ–¹æ³•ä¸­ã€‚ä½†æ˜¯å˜åŒ–çš„ä¸œè¥¿æ˜¯ä¸€æ®µä»£ç ï¼Œè€Œä¸”è¿™æ®µä»£ç ä¼šç”¨åˆ°<code>JdbcTemplate</code>ä¸­çš„å˜é‡ã€‚æ€ä¹ˆåŠï¼Ÿé‚£æˆ‘ä»¬å°±ç”¨å›è°ƒå¯¹è±¡å§ã€‚</p>
<p>åœ¨è¿™ä¸ªå›è°ƒå¯¹è±¡ä¸­å®šä¹‰ä¸€ä¸ªæ“çºµ<code>JdbcTemplate</code>ä¸­å˜é‡çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å»å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå°±æŠŠå˜åŒ–çš„ä¸œè¥¿é›†ä¸­åˆ°è¿™é‡Œäº†ã€‚ç„¶åæˆ‘ä»¬å†ä¼ å…¥è¿™ä¸ªå›è°ƒå¯¹è±¡åˆ°<code>JdbcTemplate</code>ï¼Œä»è€Œå®Œæˆäº†è°ƒç”¨ã€‚è¿™å¯èƒ½æ˜¯Template Methodä¸éœ€è¦ç»§æ‰¿çš„å¦ä¸€ç§å®ç°æ–¹å¼ã€‚ </p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š </p>
<p><code>JdbcTemplate</code>ä¸­çš„executeæ–¹æ³• </p>
<p>![](F:/CloudNode/åå°/2-Java EE/Spring/image/6.png)</p>
<h3 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h3>]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹</title>
    <url>/2021/02/27/%E8%B4%AB%E8%A1%80%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%85%85%E8%A1%80%E6%A8%A1%E5%9E%8B/</url>
    <content><![CDATA[<h1 id="è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹"><a href="#è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹" class="headerlink" title="è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹"></a>è´«è¡€æ¨¡å‹å’Œå……è¡€æ¨¡å‹</h1><h2 id="è´«è¡€æ¨¡å‹"><a href="#è´«è¡€æ¨¡å‹" class="headerlink" title="è´«è¡€æ¨¡å‹"></a>è´«è¡€æ¨¡å‹</h2><p>æ¦‚å¿µï¼šæ˜¯æŒ‡é¢†åŸŸå¯¹è±¡é‡Œåªæœ‰getå’Œsetæ–¹æ³•ï¼Œæˆ–è€…åŒ…å«å°‘é‡çš„CRUDæ–¹æ³•ï¼Œæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘éƒ½ä¸åŒ…å«åœ¨å†…è€Œæ˜¯æ”¾åœ¨Business Logicå±‚ã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ˜¯ç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„æ¸…æ¥šï¼Œå„å±‚ä¹‹é—´å•å‘ä¾èµ–ï¼ŒClient -&gt; (Business Facade) -&gt; Business Logic -&gt; Data Accessã€‚</p>
<p>â€‹          å½“ç„¶ Business Logic æ˜¯ä¾èµ– Domain Object çš„ã€‚ä¼¼ä¹ç°åœ¨æµè¡Œçš„æ¶æ„å°±æ˜¯è¿™æ ·ï¼Œå½“ç„¶å±‚æ¬¡è¿˜å¯ä»¥ç»†åˆ†ã€‚ </p>
<p>ç¼ºç‚¹ï¼šæ˜¯ä¸å¤Ÿé¢å‘å¯¹è±¡ï¼Œé¢†åŸŸå¯¹è±¡åªæ˜¯ä½œä¸ºä¿å­˜çŠ¶æ€æˆ–è€…ä¼ é€’çŠ¶æ€ä½¿ç”¨ï¼Œæ‰€ä»¥å°±è¯´åªæœ‰æ•°æ®æ²¡æœ‰è¡Œä¸ºçš„å¯¹è±¡ä¸æ˜¯çœŸæ­£çš„å¯¹è±¡ã€‚</p>
<blockquote>
<p>åœ¨ Business Logic é‡Œé¢å¤„ç†æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ POEAA (ä¼ä¸šåº”ç”¨æ¶æ„æ¨¡å¼)ä¸€ä¹¦ä¸­è¢«ç§°ä¸º Transaction Script æ¨¡å¼ã€‚</p>
</blockquote>
<h2 id="å……è¡€æ¨¡å‹"><a href="#å……è¡€æ¨¡å‹" class="headerlink" title="å……è¡€æ¨¡å‹"></a>å……è¡€æ¨¡å‹</h2><p>æ¦‚å¿µï¼šå¤§å¤šä¸šåŠ¡é€»è¾‘å’ŒæŒä¹…åŒ–æ”¾åœ¨ Domain Object é‡Œé¢ï¼ŒBusiness Logic åªæ˜¯ç®€å•å°è£…éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ä»¥åŠæ§åˆ¶äº‹åŠ¡ã€æƒé™ç­‰ï¼Œ</p>
<p>â€‹          è¿™æ ·å±‚æ¬¡ç»“æ„å°±å˜æˆ Client -&gt;ï¼ˆBusiness Facade) -&gt; Business Logic -&gt; Domain Object -&gt; Data Accessã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ˜¯é¢å‘å¯¹è±¡ï¼ŒBusiness Logic ç¬¦åˆå•ä¸€èŒè´£ï¼Œä¸åƒåœ¨è´«è¡€æ¨¡å‹é‡Œé¢é‚£æ ·åŒ…å«æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘å¤ªè¿‡æ²‰é‡ã€‚</p>
<p>ç¼ºç‚¹ï¼šæ˜¯å¦‚ä½•åˆ’åˆ†ä¸šåŠ¡é€»è¾‘ï¼Œä»€ä¹ˆæ ·çš„é€»è¾‘åº”è¯¥æ”¾åœ¨ Domain Object ä¸­ï¼Œä»€ä¹ˆæ ·çš„ä¸šåŠ¡é€»è¾‘åº”è¯¥æ”¾åœ¨ Business Logic ä¸­ï¼Œè¿™æ˜¯å¾ˆå«ç³Šçš„ã€‚</p>
<p>â€‹          å³ä½¿åˆ’åˆ†å¥½äº†ä¸šåŠ¡é€»è¾‘ï¼Œç”±äºåˆ†æ•£åœ¨ Business Logic å’Œ Domain Object å±‚ä¸­ï¼Œä¸èƒ½æ›´å¥½çš„åˆ†æ¨¡å—å¼€å‘ã€‚ç†Ÿæ‚‰ä¸šåŠ¡é€»è¾‘çš„å¼€å‘äººå‘˜éœ€è¦æ¸—</p>
<p>â€‹          é€åˆ° Domain Logic ä¸­å»ï¼Œè€Œåœ¨ Domain Logic åˆåŒ…å«äº†æŒä¹…åŒ–ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´è¿™ååˆ†æ··ä¹±ã€‚ å…¶æ¬¡ï¼Œå› ä¸º Business Logic è¦æ§åˆ¶äº‹åŠ¡</p>
<p>â€‹          å¹¶ä¸”ä¸ºä¸Šå±‚æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æœåŠ¡è°ƒç”¨å…¥å£ç‚¹ï¼Œå®ƒå°±å¿…é¡»æŠŠåœ¨ Domain Logic é‡Œå®ç°çš„ä¸šåŠ¡é€»è¾‘å…¨éƒ¨é‡æ–°åŒ…è£…ä¸€éï¼Œå®Œå…¨å±äºé‡å¤åŠ³åŠ¨ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>é¢†åŸŸé©±åŠ¨è®¾è®¡</tag>
        <tag>DDD</tag>
      </tags>
  </entry>
  <entry>
    <title>éƒ¨ç½²SpringbootæœåŠ¡åˆ°äº‘æœåŠ¡å™¨ä¸Š</title>
    <url>/2019/12/06/%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A/</url>
    <content><![CDATA[<h1 id="éƒ¨ç½²ä¸€ä¸ªjavaæœåŠ¡å™¨åˆ°è‡ªå·±çš„äº‘æœåŠ¡å™¨ä¸Š"><a href="#éƒ¨ç½²ä¸€ä¸ªjavaæœåŠ¡å™¨åˆ°è‡ªå·±çš„äº‘æœåŠ¡å™¨ä¸Š" class="headerlink" title="éƒ¨ç½²ä¸€ä¸ªjavaæœåŠ¡å™¨åˆ°è‡ªå·±çš„äº‘æœåŠ¡å™¨ä¸Š"></a>éƒ¨ç½²ä¸€ä¸ªjavaæœåŠ¡å™¨åˆ°è‡ªå·±çš„äº‘æœåŠ¡å™¨ä¸Š</h1><blockquote>
<p>ä»¥è…¾è®¯äº‘æœåŠ¡å™¨ä¸ºä¾‹</p>
</blockquote>
<h2 id="è®¾ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ä¸€äº›å¸¸ç”¨ç«¯å£"><a href="#è®¾ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ä¸€äº›å¸¸ç”¨ç«¯å£" class="headerlink" title="è®¾ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ä¸€äº›å¸¸ç”¨ç«¯å£"></a>è®¾ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ä¸€äº›å¸¸ç”¨ç«¯å£</h2><p>åœ¨èœå•é‡Œé€‰æ‹©å®‰å…¨ç»„é…ç½®ä¸€æ¡å®‰å…¨ç»„è§„åˆ™ï¼Œæ·»åŠ å®Œåä¼šå¤šä¸€è¡Œè®°å½•ï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-12-10_10-15-21.png" alt=""></p>
<p>é€‰æ‹©æ·»åŠ è§„åˆ™ï¼Œè®¾ç½®å…¥ç«™è§„åˆ™å’Œå‡ºç«™è§„åˆ™ï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-12-10_10-17-29.png" alt=""></p>
<p><img src="http://image.leonote.cn/Snipaste_2019-12-10_10-18-11.png" alt=""></p>
<p>å°†è¿™ä¸ªå®‰å…¨ç»„è§„åˆ™å…³è”åˆ°è‡ªå·±çš„äº‘ä¸»æœºä¸Šï¼š</p>
<p><img src="http://image.leonote.cn/Snipaste_2019-12-10_10-18-42.png" alt=""></p>
<p><img src="http://image.leonote.cn/Snipaste_2019-12-10_10-19-24.png" alt=""></p>
<h2 id="ä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨"><a href="#ä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨" class="headerlink" title="ä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨"></a>ä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨</h2><p>å½“å¼€æ”¾å®Œ22ç«¯å£åï¼Œå°±å¯ä»¥å»ç”Ÿæˆå…¬ç§é’¥ï¼ŒæŠŠç§é’¥ä¸‹è½½åï¼Œä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨çš„å…¬ç½‘IPï¼Œä¼šå‡ºç°è¾“å…¥è´¦å·ï¼Œå¯†ç å’Œå¯†é’¥ã€‚æŠŠä¸‹è½½å¥½çš„å¯†é’¥åŠ è½½è¿›æ¥ï¼Œå°±å¯ä»¥ä½¿ç”¨xshellè®¿é—®äº†ã€‚ä»¥åå†è¯¦ç»†å†™ã€‚ã€‚</p>
<h2 id="ä¸‹è½½å¿…è¦çš„è½¯ä»¶"><a href="#ä¸‹è½½å¿…è¦çš„è½¯ä»¶" class="headerlink" title="ä¸‹è½½å¿…è¦çš„è½¯ä»¶"></a>ä¸‹è½½å¿…è¦çš„è½¯ä»¶</h2><blockquote>
<p>PS: æš‚æ—¶è¿˜ä¸æ‡‚ä½¿ç”¨ docker éƒ¨ç½²æœåŠ¡ï¼Œæ‰€ä»¥ç”¨æœ€åŸå§‹çš„æ–¹å¼éƒ¨ç½²</p>
</blockquote>
<p>æˆ‘éƒ¨ç½²çš„æ˜¯<code>springboot</code>é¡¹ç›®ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ°<code>java</code>ç¯å¢ƒï¼Œå…ˆå®‰è£…<code>jdk</code>ã€‚</p>
<h3 id="å®‰è£…-JDK"><a href="#å®‰è£…-JDK" class="headerlink" title="å®‰è£… JDK"></a>å®‰è£… JDK</h3><h4 id="æŸ¥çœ‹æ˜¯å¦å·²ç»å®‰è£…äº†JDK"><a href="#æŸ¥çœ‹æ˜¯å¦å·²ç»å®‰è£…äº†JDK" class="headerlink" title="æŸ¥çœ‹æ˜¯å¦å·²ç»å®‰è£…äº†JDK"></a>æŸ¥çœ‹æ˜¯å¦å·²ç»å®‰è£…äº†JDK</h4><p><code>whereis java</code><br><code>which java</code></p>
<blockquote>
<p>å¦‚æœæœ‰<code>jdk</code>ä¼šè¾“å‡ºæ‰€åœ¨ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰ä¸è¾“å‡ºï¼Œæˆ–è€…è¾“å‡ºæ‰¾ä¸åˆ°</p>
</blockquote>
<h4 id="å¸è½½æ—§ç‰ˆæœ¬çš„JDK"><a href="#å¸è½½æ—§ç‰ˆæœ¬çš„JDK" class="headerlink" title="å¸è½½æ—§ç‰ˆæœ¬çš„JDK"></a>å¸è½½æ—§ç‰ˆæœ¬çš„JDK</h4><p>æ‰¾åˆ°JDKçš„ä½ç½®ï¼š<code>rpm -qa | grep jdk</code></p>
<p>æ ¹æ®ä½ç½®å¸è½½ï¼š</p>
<h4 id="å®‰è£…æƒ³è¦çš„JDKç‰ˆæœ¬"><a href="#å®‰è£…æƒ³è¦çš„JDKç‰ˆæœ¬" class="headerlink" title="å®‰è£…æƒ³è¦çš„JDKç‰ˆæœ¬"></a>å®‰è£…æƒ³è¦çš„JDKç‰ˆæœ¬</h4><p>æˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯ jdk8 <a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">ä¸‹è½½åœ°å€</a> ï¼Œä¸‹è½½ tar.gz æ ¼å¼çš„æ–‡ä»¶</p>
<p>ä¸‹è½½å®Œåï¼Œä½¿ç”¨ xftp ä¸Šè½½åˆ°äº‘æœåŠ¡å™¨ä¸Šï¼Œæˆ‘è¿™é‡Œæ”¾åˆ°äº†<code>/usr/local</code> ã€‚</p>
<p><img src="http://image.leonote.cn/snipaste_20191205_203752.png" alt=""></p>
<p>è§£å‹åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸Šï¼š <code>tar zxvf jdk8.tar.gz</code></p>
<p>å°†è¯¥jdké…ç½®åˆ°ç¯å¢ƒå˜é‡ä¸Šå»ï¼š</p>
<p><code>vi /etc/profile</code></p>
<p>æ–‡ä»¶æœ«å°¾è¿½åŠ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">JAVA_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;jdk1.8.0_231</span><br><span class="line">JRE_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;jdk1.8.0_231&#x2F;jre</span><br><span class="line">PATH&#x3D;$PATH:$JAVA_HOME&#x2F;bin:$JRE_HOME&#x2F;bin</span><br><span class="line">CLASSPATH&#x3D;:$JAVA_HOME&#x2F;lib&#x2F;dt.jar:$JAVA_HOME&#x2F;lib&#x2F;tools.jar:$JRE_HOME&#x2F;lib</span><br><span class="line"></span><br><span class="line">export JAVA_HOME JRE_HOME PATH CLASSPATH</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜é€€å‡ºåï¼Œä½¿å…¶ç«‹å³ç”Ÿæ•ˆï¼š <code>source /etc/profile</code>  </p>
<p>åˆ›å»º<code>Test.java</code>æ–‡ä»¶:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;hello world !&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å¹¶è¿è¡Œï¼Œå¦‚æœè¾“å‡ºhello woldåˆ™é…ç½®å®Œæˆ</p>
<p><code>javac Test.java</code></p>
<p><code>java Test</code></p>
<h3 id="å®‰è£…-Docker"><a href="#å®‰è£…-Docker" class="headerlink" title="å®‰è£… Docker"></a>å®‰è£… Docker</h3><p>å› ä¸ºæˆ‘çš„äº‘æœåŠ¡å™¨å®‰è£…çš„æ˜¯<code>CentOs7</code> ï¼Œæ‰€ä»¥ä½¿ç”¨yumä¸‹è½½</p>
<p>å®‰è£… Dockerï¼š <code>yum -y install docker</code></p>
<p>å¯åŠ¨ Dockerï¼š<code>systemctl start docker</code></p>
<p>éªŒè¯æ˜¯å¦æˆåŠŸï¼š<code>docker run hello-world</code>  å¦‚æœè¾“å‡ºhello worldåˆ™æˆåŠŸ</p>
<h4 id="ä¸‹è½½æƒ³è¦è¿è¡Œçš„è½¯ä»¶"><a href="#ä¸‹è½½æƒ³è¦è¿è¡Œçš„è½¯ä»¶" class="headerlink" title="ä¸‹è½½æƒ³è¦è¿è¡Œçš„è½¯ä»¶"></a>ä¸‹è½½æƒ³è¦è¿è¡Œçš„è½¯ä»¶</h4><p>æˆ‘è¿™é‡Œéœ€è¦ç”¨åˆ°<code>Mysql</code>ï¼š<code>docker pull mysql</code></p>
<p>è¿è¡Œ <code>mysql</code>ï¼Œè¿™é‡Œæ²¡æœ‰è®¾ç½®å¤æ‚çš„å¯†ç ï¼š<code>docker run -itd --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 docker.io/mysql</code></p>
<p>è¿›å…¥<code>mysql</code>å®¹å™¨ï¼š<code>docker exec  -it  mysql  /bin/bash</code>  </p>
<p>è¾“å…¥è´¦å·ï¼š<code>mysql -uroot -p</code></p>
<p>è¾“å…¥å¯†ç ï¼š</p>
<p>è¿›å…¥<code>mysql</code>åï¼Œåˆ›å»ºæ•°æ®åº“å¹¶ä½¿ç”¨ï¼š<code>create database mini;</code>  å’Œ <code>use mini;</code></p>
<p>é€€å‡º<code>mysql</code>å‘½ä»¤è¡Œæ¨¡å¼ï¼š<code>exit</code></p>
<p>é€€å‡º docker å®¹å™¨ï¼š<code>exit</code></p>
<h2 id="maven-æ‰“åŒ…"><a href="#maven-æ‰“åŒ…" class="headerlink" title="maven æ‰“åŒ…"></a>maven æ‰“åŒ…</h2><p>ä½¿ç”¨å‘½ä»¤æˆ–è€…ideè¿›è¡Œæ‰“åŒ…</p>
<p>å¦‚æœäº‘ä¸Šçš„é…ç½®å’Œæœ¬åœ°çš„é…ç½®ä¸ä¸€æ ·ï¼Œå¯ä»¥æ‰“åŒ…åï¼Œè§£å‹æ‰“å¼€ï¼Œç”¨äº‘ä¸Šçš„é…ç½®æ›¿æ¢æœ¬åœ°çš„é…ç½®</p>
<h2 id="åœ¨-xshell-è¿è¡Œspringboot"><a href="#åœ¨-xshell-è¿è¡Œspringboot" class="headerlink" title="åœ¨ xshell è¿è¡Œspringboot"></a>åœ¨ xshell è¿è¡Œspringboot</h2><p>è¿›å…¥åˆ°springbooté¡¹ç›®å­˜æ”¾çš„ä½ç½®ï¼Œè¿è¡Œjava -jarå‘½ä»¤</p>
<p><img src="http://image.leonote.cn/snipaste_20191205_211502.png" alt=""></p>
<h2 id="ç›´æ¥ç”¨äº‘æœåŠ¡å™¨çš„å…¬ç½‘è®¿é—®è‡ªå·±å†™çš„api"><a href="#ç›´æ¥ç”¨äº‘æœåŠ¡å™¨çš„å…¬ç½‘è®¿é—®è‡ªå·±å†™çš„api" class="headerlink" title="ç›´æ¥ç”¨äº‘æœåŠ¡å™¨çš„å…¬ç½‘è®¿é—®è‡ªå·±å†™çš„api"></a>ç›´æ¥ç”¨äº‘æœåŠ¡å™¨çš„å…¬ç½‘è®¿é—®è‡ªå·±å†™çš„api</h2><p><img src="http://image.leonote.cn/snipaste_20191205_211619.png" alt=""></p>
]]></content>
      <categories>
        <category>è¿ç»´</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>è¿ç»´</tag>
        <tag>äº‘æœåŠ¡å™¨</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>é˜²æŠ–åŠ¨</title>
    <url>/2020/08/20/%E9%98%B2%E6%8A%96%E5%8A%A8/</url>
    <content><![CDATA[<p><a href="https://github.com/YvetteLau/Step-By-Step/issues/10">å‚è€ƒçš„è¿æ¥</a></p>
<h2 id="ä»€ä¹ˆæ˜¯é˜²æŠ–"><a href="#ä»€ä¹ˆæ˜¯é˜²æŠ–" class="headerlink" title="ä»€ä¹ˆæ˜¯é˜²æŠ–"></a>ä»€ä¹ˆæ˜¯é˜²æŠ–</h2><p>æ‰€è°“é˜²æŠ–ï¼Œå°±æ˜¯æŒ‡è§¦å‘äº‹ä»¶ååœ¨nç§’å†…åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœåœ¨nç§’å†…è§¦å‘äº‹ä»¶çš„ï¼Œåˆ™ä¼šé‡æ–°è®¡ç®—å‡½æ•°æ‰§è¡Œäº‹ä»¶</p>
<h2 id="é˜²æŠ–çš„ä¸¤ç§çŠ¶æ€"><a href="#é˜²æŠ–çš„ä¸¤ç§çŠ¶æ€" class="headerlink" title="é˜²æŠ–çš„ä¸¤ç§çŠ¶æ€"></a>é˜²æŠ–çš„ä¸¤ç§çŠ¶æ€</h2><h3 id="ç«‹å³æ‰§è¡Œ"><a href="#ç«‹å³æ‰§è¡Œ" class="headerlink" title="ç«‹å³æ‰§è¡Œ"></a>ç«‹å³æ‰§è¡Œ</h3><p>è§¦å‘äº‹ä»¶åå‡½æ•°ç«‹å³æ‰§è¡Œ</p>
<h3 id="éç«‹å³æ‰§è¡Œ"><a href="#éç«‹å³æ‰§è¡Œ" class="headerlink" title="éç«‹å³æ‰§è¡Œ"></a>éç«‹å³æ‰§è¡Œ</h3><p>è§¦å‘äº‹ä»¶åå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨nç§’åå¼€å§‹æ‰§è¡Œ</p>
<h2 id="é˜²æŠ–ä½¿ç”¨åœºæ™¯"><a href="#é˜²æŠ–ä½¿ç”¨åœºæ™¯" class="headerlink" title="é˜²æŠ–ä½¿ç”¨åœºæ™¯"></a>é˜²æŠ–ä½¿ç”¨åœºæ™¯</h2><blockquote>
<p>é˜²æŠ–å‡½æ•°å¸¸ç”¨æ¥è¿›è¡Œå¤„ç†æŸäº›é¢‘ç¹è§¦å‘çš„è¯·æ±‚äº‹ä»¶ï¼ˆæˆ–è€…å‰ç«¯è®¡ç®—çš„äº‹ä»¶ï¼‰</p>
<ul>
<li>windowæ»šåŠ¨æ¡äº‹ä»¶ scroll</li>
<li>windowçš„resize</li>
<li>é¼ æ ‡çš„mouse move</li>
<li>ä¸‹æ‹‰æ¡†çš„è¿œç¨‹æ¨¡ç³Šæœç´¢</li>
<li>è¡¨å•ç»„ä»¶è¾“å…¥å†…å®¹éªŒè¯</li>
<li>é˜²æ­¢å¤šæ¬¡ç‚¹å‡»å¯¼è‡´è¡¨å•å¤šæ¬¡æäº¤</li>
</ul>
<p>ç›®çš„ï¼šé™åˆ¶å‡½æ•°è§¦å‘é¢‘ç‡ï¼›å¯¹æ€§èƒ½ä¼˜åŒ–ï¼Œå‡å°‘æœåŠ¡å™¨è´Ÿæ‹…ï¼›</p>
<p>å®ç°æ ¸å¿ƒï¼šç»´æŠ¤ä¸€ä¸ª<code>setTimeout</code>ï¼Œåœ¨å†·å´æ—¶é—´å†…å†æ¬¡è§¦å‘å‡½æ•°åˆ™æ¸…ç©ºåŸ<code>setTimeout</code>é‡æ–°è®¡ç®—ä¸€ä¸ª<code>setTimeout</code>æ¨å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ</p>
</blockquote>
<h2 id="lodashçš„æ–¹æ³•"><a href="#lodashçš„æ–¹æ³•" class="headerlink" title="lodashçš„æ–¹æ³•"></a>lodashçš„æ–¹æ³•</h2><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_.debounce(func, [wait=<span class="number">0</span>], [options=&#123;&#125;])</span><br></pre></td></tr></table></figure>

<h4 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h4><ol>
<li><code>func</code> <em>(Function)</em>: è¦é˜²æŠ–åŠ¨çš„å‡½æ•°ã€‚</li>
<li><code>[wait=0]</code> <em>(number)</em>: éœ€è¦å»¶è¿Ÿçš„æ¯«ç§’æ•°ã€‚</li>
<li><code>[options=&#123;&#125;]</code> <em>(Object)</em>: é€‰é¡¹å¯¹è±¡ã€‚</li>
<li><code>[options.leading=false]</code> <em>(boolean)</em>: æŒ‡å®šåœ¨å»¶è¿Ÿå¼€å§‹å‰è°ƒç”¨ã€‚</li>
<li><code>[options.maxWait]</code> <em>(number)</em>: è®¾ç½® <code>func</code> å…è®¸è¢«å»¶è¿Ÿçš„æœ€å¤§å€¼ã€‚</li>
<li><code>[options.trailing=true]</code> <em>(boolean)</em>: æŒ‡å®šåœ¨å»¶è¿Ÿç»“æŸåè°ƒç”¨ã€‚</li>
</ol>
<h4 id="è¿”å›"><a href="#è¿”å›" class="headerlink" title="è¿”å›"></a>è¿”å›</h4><p><em>(Function)</em>: è¿”å›æ–°çš„ debouncedï¼ˆé˜²æŠ–åŠ¨ï¼‰å‡½æ•°ã€‚</p>
<h4 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é¿å…çª—å£åœ¨å˜åŠ¨æ—¶å‡ºç°æ˜‚è´µçš„è®¡ç®—å¼€é”€ã€‚</span></span><br><span class="line">jQuery(<span class="built_in">window</span>).on(<span class="string">&#x27;resize&#x27;</span>, _.debounce(calculateLayout, <span class="number">150</span>));</span><br><span class="line"> </span><br><span class="line"><span class="comment">// å½“ç‚¹å‡»æ—¶ `sendMail` éšåå°±è¢«è°ƒç”¨ã€‚</span></span><br><span class="line">jQuery(element).on(<span class="string">&#x27;click&#x27;</span>, _.debounce(sendMail, <span class="number">300</span>, &#123;</span><br><span class="line">  <span class="string">&#x27;leading&#x27;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&#x27;trailing&#x27;</span>: <span class="literal">false</span></span><br><span class="line">&#125;));</span><br><span class="line"> </span><br><span class="line"><span class="comment">// ç¡®ä¿ `batchLog` è°ƒç”¨1æ¬¡ä¹‹åï¼Œ1ç§’å†…ä¼šè¢«è§¦å‘ã€‚</span></span><br><span class="line"><span class="keyword">var</span> debounced = _.debounce(batchLog, <span class="number">250</span>, &#123; <span class="string">&#x27;maxWait&#x27;</span>: <span class="number">1000</span> &#125;);</span><br><span class="line"><span class="keyword">var</span> source = <span class="keyword">new</span> EventSource(<span class="string">&#x27;/stream&#x27;</span>);</span><br><span class="line">jQuery(source).on(<span class="string">&#x27;message&#x27;</span>, debounced);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// å–æ¶ˆä¸€ä¸ª trailing çš„é˜²æŠ–åŠ¨è°ƒç”¨</span></span><br><span class="line">jQuery(<span class="built_in">window</span>).on(<span class="string">&#x27;popstate&#x27;</span>, debounced.cancel);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å‰ç«¯</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>lodash</tag>
        <tag>é˜²æ­¢å¤šæ¬¡æäº¤</tag>
      </tags>
  </entry>
  <entry>
    <title>é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™</title>
    <url>/2020/09/16/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/</url>
    <content><![CDATA[<h1 id="é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™"><a href="#é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™" class="headerlink" title="é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™"></a>é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™</h1><p>é¢å‘å¯¹è±¡è®¾è®¡ï¼ˆOODï¼šObject Oriented Designï¼‰çš„å…­å¤§è®¾è®¡åŸåˆ™</p>
<table>
<thead>
<tr>
<th align="left">ç¼©å†™</th>
<th align="left">è‹±æ–‡åç§°</th>
<th>ä¸­æ–‡åç§°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SRP</td>
<td align="left">Single Responsibility Principle</td>
<td>å•ä¸€èŒè´£åŸåˆ™</td>
</tr>
<tr>
<td align="left">OCP</td>
<td align="left">Open Close Principle</td>
<td>å¼€é—­åŸåˆ™</td>
</tr>
<tr>
<td align="left">LSP</td>
<td align="left">Liskov Substitution Principle</td>
<td>é‡Œæ°æ›¿æ¢åŸåˆ™</td>
</tr>
<tr>
<td align="left">ISP</td>
<td align="left">Interface Segregation Principle</td>
<td>æ¥å£åˆ†ç¦»åŸåˆ™</td>
</tr>
<tr>
<td align="left">DIP</td>
<td align="left">Dependency Inversion Principle</td>
<td>ä¾èµ–å€’ç½®åŸåˆ™</td>
</tr>
<tr>
<td align="left">LoD</td>
<td align="left">Law of Demeter ï¼ˆ Least Knowledge Principleï¼‰</td>
<td>è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆæœ€å°‘çŸ¥é“åŸåˆ™ï¼‰</td>
</tr>
</tbody></table>
<blockquote>
<p>å‰äº”ä¸ªè®¾è®¡åŸåˆ™å°±æ˜¯é€šå¸¸æ‰€è¯´çš„<code>SOLID</code>ï¼ˆä¸Šæ–¹è¡¨æ ¼ç¼©å†™çš„é¦–å­—æ¯ï¼Œä»ä¸Šåˆ°ä¸‹ï¼‰</p>
</blockquote>
<h2 id="å¼€é—­åŸåˆ™-OCP"><a href="#å¼€é—­åŸåˆ™-OCP" class="headerlink" title="å¼€é—­åŸåˆ™ ( OCP )"></a>å¼€é—­åŸåˆ™ ( OCP )</h2><h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><blockquote>
<p>ğŸ“Œ Software entities (classes, modules, functions, etc.) should be open for extension, but closed for modification.</p>
</blockquote>
<p>å³ï¼šä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚ç±»ã€æ¨¡å—å’Œå‡½æ•°ç­‰åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚</p>
<p>ä¸éœ€è¦ä¿®æ”¹è½¯ä»¶å®ä½“ï¼ˆç±»ã€æ¨¡å—ã€å‡½æ•°ç­‰ï¼‰ï¼Œå°±åº”è¯¥èƒ½å®ç°åŠŸèƒ½çš„æ‰©å±•</p>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><p>å¯ä»¥åœ¨ä¸æ”¹åŠ¨åŸæœ‰ä»£ç çš„å‰æä¸‹ç»™ç¨‹åºæ‰©å±•åŠŸèƒ½ã€‚å¢åŠ äº†ç¨‹åºçš„å¯æ‰©å±•æ€§ï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†ç¨‹åºçš„ç»´æŠ¤æˆæœ¬ã€‚</p>
<h3 id="å®ç°çš„æ–¹æ³•"><a href="#å®ç°çš„æ–¹æ³•" class="headerlink" title="å®ç°çš„æ–¹æ³•"></a>å®ç°çš„æ–¹æ³•</h3><p>å…³é”®æ˜¯æŠ½è±¡ï¼Œé€šè¿‡å®ç°é¢„å…ˆè®¾ç½®å¥½çš„æŠ½è±¡çš„æ¥å£ï¼ˆæŠ½è±¡ç±»ï¼‰æ¥å®ç°æ–°çš„åŠŸèƒ½ã€‚</p>
<h4 id="ç­–ç•¥æ¨¡å¼-Strategy-Pattern"><a href="#ç­–ç•¥æ¨¡å¼-Strategy-Pattern" class="headerlink" title="ç­–ç•¥æ¨¡å¼ ( Strategy Pattern )"></a>ç­–ç•¥æ¨¡å¼ ( Strategy Pattern )</h4><h5 id="å®šä¹‰-1"><a href="#å®šä¹‰-1" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h5><p>è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚</p>
<h5 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h5><ol>
<li>ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è¯­å¥</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç³»åˆ—çš„å¯ä¾›é‡ç”¨çš„ç®—æ³•æ—ï¼Œæ°å½“ä½¿ç”¨ç»§æ‰¿å¯ä»¥æŠŠç®—æ³•æ—çš„å…¬å…±ä»£ç è½¬ç§»åˆ°çˆ¶ç±»é‡Œé¢ï¼Œä»è€Œé¿å…é‡å¤çš„ä»£ç </li>
<li>ç­–ç•¥æ¨¡å¼å¯ä»¥æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸åŒå®ç°ï¼Œå®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæ—¶é—´æˆ–ç©ºé—´è¦æ±‚é€‰æ‹©ä¸åŒçš„</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŸåˆ™çš„å®Œç¾æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸä»£ç çš„æƒ…å†µä¸‹ï¼Œçµæ´»å¢åŠ æ–°ç®—æ³•</li>
<li>ç­–ç•¥æ¨¡å¼æŠŠç®—æ³•çš„ä½¿ç”¨æ”¾åˆ°ç¯å¢ƒç±»ä¸­ï¼Œè€Œç®—æ³•çš„å®ç°ç§»åˆ°å…·ä½“ç­–ç•¥ç±»ä¸­ï¼Œå®ç°äº†äºŒè€…çš„åˆ†ç¦»</li>
</ol>
<h5 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h5><ol>
<li>å®¢æˆ·ç«¯å¿…é¡»ç†è§£æ‰€æœ‰ç­–ç•¥ç®—æ³•çš„åŒºåˆ«ï¼Œä»¥ä¾¿é€‚æ—¶é€‰æ‹©æ°å½“çš„ç®—æ³•ç±»</li>
<li>ç­–ç•¥æ¨¡å¼é€ æˆå¾ˆå¤šçš„ç­–ç•¥ç±»</li>
</ol>
<h5 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h5><h6 id="ç»§æ‰¿å®ç°"><a href="#ç»§æ‰¿å®ç°" class="headerlink" title="ç»§æ‰¿å®ç°"></a>ç»§æ‰¿å®ç°</h6><p>å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¼ºåˆ¶å­ç±»å®ç°è¯¥æ–¹æ³•</p>
<p>è¿™ç§å®ç°ï¼Œå¯¹çˆ¶ç±»å¯¹å­ç±»ä¸ä¸€å®šæ˜¯é€æ˜çš„ï¼Œå¦‚æœçˆ¶ç±»æä¾›äº†é»˜è®¤çš„å®ç°ï¼Œå­ç±»éœ€è¦äº†è§£å®ç°çš„ç»†èŠ‚ï¼Œå†å†³å®šæ˜¯å¦é‡å†™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¹Ÿå¯ä»¥å°†è¯¥æ–¹æ³•è®¾ç½®æˆæŠ½è±¡æ–¹æ³•ï¼Œ å¼ºè¿«å­ç±»æ¥å®ç°è¯¥æ–¹æ³•</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æä¾›ä¸€ä¸ªé»˜è®¤çš„å®ç°</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionModelA</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    aStyleBrake();<span class="comment">// A é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActionModelB</span> <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bStyleBrake(); <span class="comment">// B é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="ç»„åˆå®ç°"><a href="#ç»„åˆå®ç°" class="headerlink" title="ç»„åˆå®ç°"></a>ç»„åˆå®ç°</h6><p>è¿™ç§å®ç°æ˜¯é€æ˜çš„ï¼Œåªéœ€è¦æ”¹å˜å¯¹è±¡çš„å¼•ç”¨å°±å¯ä»¥æ”¹å˜å…¶è¡Œä¸ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBrakeBehavior</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AStyleBrake</span> <span class="keyword">implements</span> <span class="title">IBrakeBehavior</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    aStyleBrake(); <span class="comment">// A é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BStyleBrake</span> <span class="keyword">implements</span> <span class="title">IBrakeBehavior</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bStyleBrake(); <span class="comment">// B é£æ ¼çš„è¡Œä¸º</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> IBrakeBehavior brakeBehavior;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    brakeBehavior.execute();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBrakeBehavior</span><span class="params">(<span class="keyword">final</span> IBrakeBehavior brakeType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.brakeBehavior = brakeType;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åé€šè¿‡å·¥å‚ç±»ï¼Œæ ¹æ®è¿è¡Œçš„å‚æ•°é€‰æ‹©å‡ºå¯¹åº”çš„å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Action action  = ActionFactory.createAction(String parameters);   action.execute();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åªæœ‰åœ¨ç­–ç•¥é€‰æ‹©é‡Œæœ‰æ¡ä»¶é€‰æ‹©è¯­å¥ï¼Œå…¶ä»–åœ°æ–¹ä¸å‡ºç°ã€‚</p>
<p>å¦‚ä¸Šè¿°çš„<code>createAction()</code>æ–¹æ³•</p>
</blockquote>
<h4 id="é€‚é…å™¨æ¨¡å¼-Adapter-Pattern"><a href="#é€‚é…å™¨æ¨¡å¼-Adapter-Pattern" class="headerlink" title="é€‚é…å™¨æ¨¡å¼ ( Adapter Pattern )"></a>é€‚é…å™¨æ¨¡å¼ ( Adapter Pattern )</h4><h5 id="å®šä¹‰-2"><a href="#å®šä¹‰-2" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h5><p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œã€‚åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>ç±»é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸é€‚é…è€…ä¹‹é—´æ˜¯<strong>ç»§æ‰¿ï¼ˆæˆ–å®ç°ï¼‰å…³ç³»</strong></li>
<li>å¯¹è±¡é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸é€‚é…è€…ä¹‹é—´æ˜¯<strong>å…³è”å…³ç³»</strong></li>
</ul>
<p>å‰è€…çš„è€¦åˆåº¦æ¯”åè€…é«˜ï¼Œä¸”è¦æ±‚å¼€å‘äº†è§£ç°æœ‰ç»„ä»¶åº“ä¸­çš„ç›¸å…³ç»„ä»¶çš„å†…éƒ¨ç»“æ„ï¼Œåº”ç”¨ç›¸å¯¹è¾ƒå°‘äº›ã€‚</p>
<h5 id="ä¼˜ç‚¹-2"><a href="#ä¼˜ç‚¹-2" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h5><ul>
<li>å°†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»è§£è€¦ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªé€‚é…å™¨ç±»æ¥é‡ç”¨ç°æœ‰çš„é€‚é…è€…ç±»ï¼Œè€Œæ— é¡»ä¿®æ”¹åŸæœ‰ä»£ç ã€‚</li>
<li>å¢åŠ äº†ç±»çš„é€æ˜æ€§å’Œå¤ç”¨æ€§ï¼Œå°†å…·ä½“çš„å®ç°å°è£…åœ¨é€‚é…è€…ç±»ä¸­ï¼Œå¯¹äºå®¢æˆ·ç«¯ç±»æ¥è¯´æ˜¯é€æ˜çš„ï¼Œè€Œä¸”æé«˜äº†é€‚é…è€…çš„å¤ç”¨æ€§ã€‚</li>
<li>çµæ´»æ€§å’Œæ‰©å±•æ€§éƒ½éå¸¸å¥½ï¼Œé€šè¿‡ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›´æ¢é€‚é…å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šå¢åŠ æ–°çš„é€‚é…å™¨ç±»ï¼Œå®Œå…¨ç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ã€‚</li>
</ul>
<p><strong>ç±»é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š</strong></p>
<p>ç”±äºé€‚é…å™¨ç±»æ˜¯é€‚é…è€…ç±»çš„å­ç±»ï¼Œå› æ­¤å¯ä»¥åœ¨é€‚é…å™¨ç±»ä¸­ç½®æ¢ä¸€äº›é€‚é…è€…çš„æ–¹æ³•ï¼Œä½¿å¾—é€‚é…å™¨çš„çµæ´»æ€§æ›´å¼ºã€‚</p>
<p><strong>å¯¹è±¡é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š</strong></p>
<p>åŒä¸€ä¸ªé€‚é…å™¨å¯ä»¥æŠŠé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æ¥å£ã€‚</p>
<h5 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h5><p><strong>ç±»é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š</strong></p>
<p>å¯¹äº Java ç­‰ä¸æ”¯æŒå¤šé‡ç»§æ‰¿çš„è¯­è¨€ï¼Œä¸€æ¬¡æœ€å¤šåªèƒ½é€‚é…ä¸€ä¸ªé€‚é…è€…ç±»ï¼Œè€Œä¸”ç›®æ ‡æŠ½è±¡ç±»åªèƒ½ä¸ºæŠ½è±¡ç±»ï¼Œä¸èƒ½ä¸ºå…·ä½“ç±»ï¼Œå…¶ä½¿ç”¨æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œä¸èƒ½å°†ä¸€ä¸ªé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æ¥å£ã€‚</p>
<p><strong>å¯¹è±¡é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š</strong></p>
<p>ä¸ç±»é€‚é…å™¨æ¨¡å¼ç›¸æ¯”ï¼Œè¦æƒ³ç½®æ¢é€‚é…è€…ç±»çš„æ–¹æ³•å°±ä¸å®¹æ˜“ã€‚å¦‚æœä¸€å®šè¦ç½®æ¢æ‰é€‚é…è€…ç±»çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹æ³•ï¼Œå°±åªå¥½å…ˆåšä¸€ä¸ªé€‚é…è€…ç±»çš„å­ç±»ï¼Œå°†é€‚é…è€…ç±»çš„æ–¹æ³•ç½®æ¢æ‰ï¼Œç„¶åå†æŠŠé€‚é…è€…ç±»çš„å­ç±»å½“åšçœŸæ­£çš„é€‚é…è€…è¿›è¡Œé€‚é…ï¼Œå®ç°è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ã€‚</p>
<h5 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h5><p>è§’è‰²</p>
<ul>
<li><strong>Targetï¼ˆç›®æ ‡æŠ½è±¡ç±»ï¼‰</strong>ï¼šç›®æ ‡æŠ½è±¡ç±»å®šä¹‰å®¢æˆ·æ‰€éœ€æ¥å£ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–æ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“ç±»ã€‚</li>
<li><strong>Adapterï¼ˆé€‚é…å™¨ç±»ï¼‰</strong>ï¼šé€‚é…å™¨å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªæ¥å£ï¼Œä½œä¸ºä¸€ä¸ªè½¬æ¢å™¨ï¼Œå¯¹ Adaptee å’Œ Target è¿›è¡Œé€‚é…ï¼Œé€‚é…å™¨ç±»æ˜¯é€‚é…å™¨æ¨¡å¼çš„æ ¸å¿ƒï¼Œåœ¨å¯¹è±¡é€‚é…å™¨ä¸­ï¼Œå®ƒé€šè¿‡ç»§æ‰¿ Target å¹¶å…³è”ä¸€ä¸ª Adaptee å¯¹è±¡ä½¿äºŒè€…äº§ç”Ÿè”ç³»ã€‚</li>
<li><strong>Adapteeï¼ˆé€‚é…è€…ç±»ï¼‰</strong>ï¼šé€‚é…è€…å³è¢«é€‚é…çš„è§’è‰²ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£éœ€è¦é€‚é…ï¼Œé€‚é…è€…ç±»ä¸€èˆ¬æ˜¯ä¸€ä¸ªå…·ä½“ç±»ï¼ŒåŒ…å«äº†å®¢æˆ·å¸Œæœ›ä½¿ç”¨çš„ä¸šåŠ¡æ–¹æ³•ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ²¡æœ‰é€‚é…è€…ç±»çš„æºä»£ç ã€‚</li>
</ul>
<h6 id="ç±»é€‚é…å™¨"><a href="#ç±»é€‚é…å™¨" class="headerlink" title="ç±»é€‚é…å™¨"></a>ç±»é€‚é…å™¨</h6><p>é¦–å…ˆæœ‰ä¸€ä¸ªå·²å­˜åœ¨çš„å°†è¢«é€‚é…çš„ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adaptee</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adapteeRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¢«é€‚é…è€…çš„æ–¹æ³•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰ä¸€ä¸ªç›®æ ‡æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœé€šè¿‡ä¸€ä¸ªé€‚é…å™¨ç±»ï¼Œå®ç° <code>Target</code> æ¥å£ï¼ŒåŒæ—¶ç»§æ‰¿äº† <code>Adaptee</code> ç±»ï¼Œç„¶ååœ¨å®ç°çš„ <code>request()</code> æ–¹æ³•ä¸­è°ƒç”¨çˆ¶ç±»çš„ <code>adapteeRequest()</code> å³å¯å®ç°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">Adaptee</span> <span class="keyword">implements</span> <span class="title">Target</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...ä¸€äº›æ“ä½œ...</span></span><br><span class="line">        <span class="keyword">super</span>.adapteeRequest();</span><br><span class="line">        <span class="comment">//...ä¸€äº›æ“ä½œ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="å¯¹è±¡é€‚é…å™¨"><a href="#å¯¹è±¡é€‚é…å™¨" class="headerlink" title="å¯¹è±¡é€‚é…å™¨"></a>å¯¹è±¡é€‚é…å™¨</h6><p>å¯¹è±¡é€‚é…å™¨ä¸ç±»é€‚é…å™¨ä¸åŒä¹‹å¤„åœ¨äºï¼Œç±»é€‚é…å™¨é€šè¿‡ç»§æ‰¿æ¥å®Œæˆé€‚é…ï¼Œå¯¹è±¡é€‚é…å™¨åˆ™æ˜¯é€šè¿‡å…³è”æ¥å®Œæˆï¼Œè¿™é‡Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ <code>Adapter</code> ç±»å³å¯å°†è½¬å˜ä¸ºå¯¹è±¡é€‚é…å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">implements</span> <span class="title">Target</span></span>&#123;</span><br><span class="line">    <span class="comment">// é€‚é…è€…æ˜¯å¯¹è±¡é€‚é…å™¨çš„ä¸€ä¸ªå±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> Adaptee adaptee = <span class="keyword">new</span> Adaptee();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        adaptee.adapteeRequest();</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="è§‚å¯Ÿè€…æ¨¡å¼-ï¼ˆ-Observer-Pattern-ï¼‰"><a href="#è§‚å¯Ÿè€…æ¨¡å¼-ï¼ˆ-Observer-Pattern-ï¼‰" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼ ï¼ˆ Observer Pattern ï¼‰"></a>è§‚å¯Ÿè€…æ¨¡å¼ ï¼ˆ Observer Pattern ï¼‰</h4><h2 id="ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆ-Dependency-Inversion-Principle-ï¼‰"><a href="#ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆ-Dependency-Inversion-Principle-ï¼‰" class="headerlink" title="ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆ Dependency Inversion Principle ï¼‰"></a>ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆ Dependency Inversion Principle ï¼‰</h2><h3 id="ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰"><a href="#ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰" class="headerlink" title="ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰"></a>ä¾èµ–å€’ç½®åŸåˆ™å®šä¹‰</h3><blockquote>
<p>ğŸ“ŒHigh level modules should not depend upon low level modules, Both should depend upon abstractions. Abstractions should not depend upon details. Details should depend upon abstractions</p>
</blockquote>
<p>ç¿»è¯‘è¿‡æ¥ï¼š</p>
<ul>
<li>é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡</li>
<li>æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚</li>
<li>ç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡</li>
</ul>
<p>æŒ‰ç…§Javaçš„ç†è§£ï¼Œæ˜¯é¢å‘æ¥å£ç¼–ç¨‹</p>
<h3 id="ä¾èµ–å€’ç½®åŸåˆ™ä½œç”¨"><a href="#ä¾èµ–å€’ç½®åŸåˆ™ä½œç”¨" class="headerlink" title="ä¾èµ–å€’ç½®åŸåˆ™ä½œç”¨"></a>ä¾èµ–å€’ç½®åŸåˆ™ä½œç”¨</h3><h4 id="é™ä½ç±»é—´çš„è€¦åˆæ€§"><a href="#é™ä½ç±»é—´çš„è€¦åˆæ€§" class="headerlink" title="é™ä½ç±»é—´çš„è€¦åˆæ€§"></a>é™ä½ç±»é—´çš„è€¦åˆæ€§</h4><p>ç±»é—´çš„ä¾èµ–éƒ½æ˜¯é€šè¿‡æ¥å£å®Œæˆçš„ï¼ŒæŸä¸ªç±»çš„å®ç°å˜äº†ï¼Œä¹Ÿä¸å½±å“ä¸Šæ¸¸ä»£ç ã€‚</p>
<h4 id="å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£é™©"><a href="#å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£é™©" class="headerlink" title="å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£é™©"></a>å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£é™©</h4><p>å„å±‚çº§ï¼Œæ¨¡å—é—´éƒ½æ˜¯é€šè¿‡æ¥å£å®šä¹‰çš„çº¦æŸï¼Œåªè¦éƒ½éµå¾ªè¿™äº›çº¦æŸï¼Œèƒ½ç›¸åº”å‡å°‘äº†å¹¶è¡Œå¼€å‘çš„å†²çªã€‚</p>
<h3 id="ä¾èµ–å€’ç½®çš„å®ç°æ–¹æ³•"><a href="#ä¾èµ–å€’ç½®çš„å®ç°æ–¹æ³•" class="headerlink" title="ä¾èµ–å€’ç½®çš„å®ç°æ–¹æ³•"></a>ä¾èµ–å€’ç½®çš„å®ç°æ–¹æ³•</h3><h4 id="æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–å¯¹è±¡"><a href="#æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–å¯¹è±¡" class="headerlink" title="æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–å¯¹è±¡"></a>æ„é€ å‡½æ•°ä¼ é€’ä¾èµ–å¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Driver</span><span class="params">(Car car)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.car = car;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.car.run();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;          </span><br></pre></td></tr></table></figure>

<h4 id="Setteræ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡"><a href="#Setteræ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡" class="headerlink" title="Setteræ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡"></a>Setteræ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCar</span><span class="params">(Car car)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.car = car;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.car.run();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ¥å£å£°æ˜ä¾èµ–"><a href="#æ¥å£å£°æ˜ä¾èµ–" class="headerlink" title="æ¥å£å£°æ˜ä¾èµ–"></a>æ¥å£å£°æ˜ä¾èµ–</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Driver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drive</span><span class="params">(Car car)</span> </span>&#123;</span><br><span class="line">        car.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¥½è±ååŸåˆ™"><a href="#å¥½è±ååŸåˆ™" class="headerlink" title="å¥½è±ååŸåˆ™"></a>å¥½è±ååŸåˆ™</h3><blockquote>
<p>donâ€™t call us, weâ€™ll call you</p>
</blockquote>
<p>å› ä¸ºåœ¨å¥½è±åï¼ŒæŠŠç®€å†é€’äº¤ç»™æ¼”è‰ºå…¬å¸åå°±åªæœ‰å›å®¶ç­‰å¾…ã€‚ç”±æ¼”è‰ºå…¬å¸å¯¹æ•´ä¸ªå¨±ä¹é¡¹çš„å®Œå…¨æ§åˆ¶ï¼Œæ¼”å‘˜åªèƒ½è¢«åŠ¨å¼çš„æ¥å—å…¬å¸çš„å·®ä½¿ï¼Œåœ¨éœ€è¦çš„ç¯èŠ‚ä¸­ï¼Œå®Œæˆè‡ªå·±çš„æ¼”å‡ºã€‚</p>
<h4 id="ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¾èµ–å€’ç½®åŸåˆ™åˆè¢«ç§°ä¸ºå¥½è±ååŸåˆ™"><a href="#ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¾èµ–å€’ç½®åŸåˆ™åˆè¢«ç§°ä¸ºå¥½è±ååŸåˆ™" class="headerlink" title="ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¾èµ–å€’ç½®åŸåˆ™åˆè¢«ç§°ä¸ºå¥½è±ååŸåˆ™"></a>ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¾èµ–å€’ç½®åŸåˆ™åˆè¢«ç§°ä¸ºå¥½è±ååŸåˆ™</h4><p>å¥½è±åæœ‰ä¸€ä¸ªè§’è‰²ï¼Œæ‰¾æ¼”å‘˜æ¥æ¼”</p>
<p>å¥½è±åç›¸å½“äºé«˜å±‚ï¼Œæ¼”å‘˜ä»¬ç›¸å½“äºä½å±‚ï¼Œä»–ä»¬é—´çš„è”ç³»æ˜¯é€šè¿‡æŸä¸ªè§’è‰²ï¼Œ</p>
<p>è¿™ä¸ªè§’è‰²ç”±å“ªä¸ªæ¼”å‘˜æ¥æ¼”éƒ½å¯ä»¥ï¼Œå¹¶ä¸ä¾èµ–äºå…·ä½“æŸä¸ªæ¼”å‘˜ï¼Œ</p>
<p>æ•´ä¸ªæµç¨‹æœ‰ç‚¹åƒé¢å‘æ¥å£ç¼–ç¨‹ã€‚</p>
<blockquote>
<p>ğŸ“Œä¸¤ä¸ªåŸåˆ™å¼ºè°ƒçš„ç‚¹åº”è¯¥æ˜¯ä¸ä¸€æ ·çš„ï¼ŒæŸ¥åˆ°çš„èµ„æ–™ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ï¼š</p>
<p>å¥½è±ååŸåˆ™ï¼šå¼ºè°ƒçš„æ˜¯é«˜å±‚å¯¹åº•å±‚çš„ä¸»åŠ¨è°ƒç”¨</p>
<p>ä¾èµ–å€’ç½®åŸåˆ™ï¼šå¼ºè°ƒçš„æ˜¯é¢å‘æ¥å£ç¼–ç¨‹</p>
<p>æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†åˆä¸å…¨æ˜¯ã€‚</p>
</blockquote>
<h2 id="é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆï¼‰"><a href="#é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆï¼‰" class="headerlink" title="é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆï¼‰"></a>é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆï¼‰</h2><h2 id="å•ä¸€èŒè´£åŸåˆ™ï¼ˆï¼‰"><a href="#å•ä¸€èŒè´£åŸåˆ™ï¼ˆï¼‰" class="headerlink" title="å•ä¸€èŒè´£åŸåˆ™ï¼ˆï¼‰"></a>å•ä¸€èŒè´£åŸåˆ™ï¼ˆï¼‰</h2><h2 id="æ¥å£éš”ç¦»åŸåˆ™ï¼ˆï¼‰"><a href="#æ¥å£éš”ç¦»åŸåˆ™ï¼ˆï¼‰" class="headerlink" title="æ¥å£éš”ç¦»åŸåˆ™ï¼ˆï¼‰"></a>æ¥å£éš”ç¦»åŸåˆ™ï¼ˆï¼‰</h2>]]></content>
      <categories>
        <category>æ¶æ„</category>
        <category>é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™</category>
      </categories>
      <tags>
        <tag>é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™</tag>
      </tags>
  </entry>
  <entry>
    <title>PlantUMLè¯­æ³•</title>
    <url>/2020/09/21/PlantUML%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<h1 id="PlantUMLè¯­æ³•"><a href="#PlantUMLè¯­æ³•" class="headerlink" title="PlantUMLè¯­æ³•"></a>PlantUMLè¯­æ³•</h1><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p><a href="http://plantuml.com/">å®˜æ–¹ç«™ç‚¹</a></p>
<ol>
<li>éœ€è¦ java ç¯å¢ƒã€‚</li>
<li>éœ€è¦å®‰è£… <a href="http://www.graphviz.org/">Graphviz</a> ä¾èµ–</li>
<li>ä¸‹è½½ <a href="http://plantuml.com/download">plantuml</a></li>
</ol>
<h2 id="ä½¿ç”¨-IDEA-æ¥åˆ›å»ºå’Œé¢„è§ˆ"><a href="#ä½¿ç”¨-IDEA-æ¥åˆ›å»ºå’Œé¢„è§ˆ" class="headerlink" title="ä½¿ç”¨ IDEA æ¥åˆ›å»ºå’Œé¢„è§ˆ"></a>ä½¿ç”¨ IDEA æ¥åˆ›å»ºå’Œé¢„è§ˆ</h2><ol>
<li>ä¸‹è½½ <a href="https://www.jetbrains.com/zh-cn/idea/download/">IDEA</a> ç¼–è¾‘å™¨</li>
<li>æ‰“å¼€ Plugins æœç´¢ â€œplantumlâ€ï¼Œé€‰ä¸­ PlantUML integrationï¼Œç‚¹å‡»å®‰è£…å³å¯</li>
<li>é…ç½® PlantUML </li>
</ol>
<p><img src="http://image.leonote.cn/20200921160019.png" alt=""></p>
<h2 id="è„šæœ¬è¯­æ³•"><a href="#è„šæœ¬è¯­æ³•" class="headerlink" title="è„šæœ¬è¯­æ³•"></a>è„šæœ¬è¯­æ³•</h2><p>puml æ˜¯è„šæœ¬è¯­è¨€ï¼Œæ˜¯æŒ‰ç…§æ¢è¡Œæ¥è¯†åˆ«è¯­æ³•çš„ã€‚</p>
<p>ä¸€èˆ¬çš„è¡¨è¾¾è¯­å¥ä¸º:</p>
<ol>
<li><p><code>èŠ‚ç‚¹  è¿æ¥ç¬¦å·  èŠ‚ç‚¹</code></p>
</li>
<li><p><code>å…³é”®å­—  èŠ‚ç‚¹æˆ–å†…å®¹</code></p>
</li>
<li><pre><code class="uml">å¼€å§‹å…³é”®å­—
  å†…å®¹
ç»“æŸå…³é”®å­—
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&gt; æ³¨æ„**ç©ºæ ¼**ç­‰éå­—ç¬¦ä½œä¸ºèŠ‚ç‚¹å†…å®¹çš„ä½¿ç”¨ï¼Œæœ‰äº›å¤šå…³é”®å­—è¯­å¥ä¸­éœ€è¦ä½¿ç”¨**åŒå¼•å·**æ¥åŒ…å«å¸¦ç©ºæ ¼çš„è¯­å¥</span><br><span class="line"></span><br><span class="line">### æ´»åŠ¨å›¾ ( Activity Diagram )</span><br><span class="line"></span><br><span class="line">#### Simple Activity</span><br><span class="line"></span><br><span class="line">è¯­æ³•æ˜¯ &#96;: èŠ‚ç‚¹ ;&#96; ç»“æŸ</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;plantuml</span><br><span class="line">@startuml</span><br><span class="line">title act_new_1</span><br><span class="line">:æ­¥éª¤ä¸€;</span><br><span class="line">:æ­¤å¤„æœ‰ä¸ªæ”¯æŒç®€å•çš„ mark è¯­æ³• **åŠ ç²—å­—ä½“**;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
<p><img src="http://image.leonote.cn//20200921184659.png" alt=""></p>
<h4 id="Start-Stop-å¼€å§‹å’Œç»“æŸ"><a href="#Start-Stop-å¼€å§‹å’Œç»“æŸ" class="headerlink" title="Start / Stop å¼€å§‹å’Œç»“æŸ"></a>Start / Stop å¼€å§‹å’Œç»“æŸ</h4><p>å¼€å§‹ä½ç½®ä¸º start å¼€å§‹ï¼Œstop åœæ­¢ï¼Œend ç»“æŸ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_2</span><br><span class="line">start</span><br><span class="line">:æ­¥éª¤ä¸€;</span><br><span class="line">:mark è¯­æ³• **åŠ ç²—å­—ä½“**;</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921184843.png" alt=""></p>
<h4 id="Conditional-æ¡ä»¶è¯­å¥"><a href="#Conditional-æ¡ä»¶è¯­å¥" class="headerlink" title="Conditional æ¡ä»¶è¯­å¥"></a>Conditional æ¡ä»¶è¯­å¥</h4><p>æ§åˆ¶è¯­å¥çš„ä½¿ç”¨ï¼Œæ³¨æ„å†…å®¹ <code>()</code> çš„ä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_3</span><br><span class="line">start</span><br><span class="line">if (æ˜¯å¦å·²ä¸‹è½½ graphviz?) then (æ˜¯)</span><br><span class="line">    :æ‰§è¡Œ \ndiagrams;</span><br><span class="line">else (å¦)</span><br><span class="line">    :éœ€è¦ä¸‹è½½ graphviz åæ‰èƒ½æ‰§è¡Œ</span><br><span class="line">    __activity__ diagrams;</span><br><span class="line">endif</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921184945.png" alt=""></p>
<h4 id="Repeat-loop-å¾ªç¯å¤„ç†ï¼ˆæ§åˆ¶è¯­å¥ï¼‰"><a href="#Repeat-loop-å¾ªç¯å¤„ç†ï¼ˆæ§åˆ¶è¯­å¥ï¼‰" class="headerlink" title="Repeat loop å¾ªç¯å¤„ç†ï¼ˆæ§åˆ¶è¯­å¥ï¼‰"></a>Repeat loop å¾ªç¯å¤„ç†ï¼ˆæ§åˆ¶è¯­å¥ï¼‰</h4><p>ä½¿ç”¨å…³é”®å­— <code>repeat</code>ï¼Œ<code>repeat while ()</code> æ¥å®ç°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_4</span><br><span class="line">start</span><br><span class="line">repeat</span><br><span class="line">    :è¯»å–æ–‡ä»¶;</span><br><span class="line">    :ç¼–è¯‘ diagrams;</span><br><span class="line">repeat while (æ›´å¤šï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ª?)</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921192651.png" alt=""></p>
<h4 id="While-loop-å¾ªç¯æ§åˆ¶"><a href="#While-loop-å¾ªç¯æ§åˆ¶" class="headerlink" title="While loop å¾ªç¯æ§åˆ¶"></a>While loop å¾ªç¯æ§åˆ¶</h4><p>ä½¿ç”¨ <code>while</code> <code>endwhile</code> å¾ªç¯æ§åˆ¶</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_5</span><br><span class="line">start</span><br><span class="line">while (æ‰§è¡Œæ¡ä»¶å…è®¸æ–‡ä»¶å­˜åœ¨?)</span><br><span class="line">    :è¯»å–æ–‡ä»¶;</span><br><span class="line">    :ç¼–è¯‘ diagrams;</span><br><span class="line">endwhile</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921192834.png" alt=""></p>
<p>å¯ä»¥è¿½åŠ æ ‡ç­¾</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_6</span><br><span class="line">start</span><br><span class="line">:æ‰“å¼€æ–‡ä»¶;</span><br><span class="line">while (æ£€æŸ¥æ–‡ä»¶å¤§å° ?) is (æœ‰å†…å®¹)</span><br><span class="line">    :è¯»å–æ–‡ä»¶;</span><br><span class="line">    :ç¼–è¯‘ dia;</span><br><span class="line">endwhile (ç©º)</span><br><span class="line">:å…³é—­æ–‡ä»¶;</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921193035.png" alt=""></p>
<h4 id="Parallel-processing-å¹¶è¡Œå¤„ç†"><a href="#Parallel-processing-å¹¶è¡Œå¤„ç†" class="headerlink" title="Parallel processing å¹¶è¡Œå¤„ç†"></a>Parallel processing å¹¶è¡Œå¤„ç†</h4><p>ä½¿ç”¨ <code>fork</code> å…³é”®å­—åˆ›å»ºå¹¶è¡Œå¤„ç†</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_7</span><br><span class="line">start</span><br><span class="line">if (multiprocessor?) then (yes)</span><br><span class="line">  fork</span><br><span class="line">    :Treatment 1;</span><br><span class="line">  fork again</span><br><span class="line">    :Treatment 2;</span><br><span class="line">  end fork</span><br><span class="line">else (monoproc)</span><br><span class="line">  :Treatment 1;</span><br><span class="line">  :Treatment 2;</span><br><span class="line">endif</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921193139.png" alt=""></p>
<h4 id="Notes-æ³¨é‡Š"><a href="#Notes-æ³¨é‡Š" class="headerlink" title="Notes æ³¨é‡Š"></a>Notes æ³¨é‡Š</h4><ul>
<li>å•è¡Œæ³¨é‡Šä½¿ç”¨ <code>note right|left å†…å®¹</code>ï¼Œæ³¨æ„åé¢æ²¡æœ‰åˆ†å·</li>
<li>å¤šè¡Œæ³¨é‡Šä½¿ç”¨ <code>note right|left æ¢è¡Œ å†…å®¹ æ¢è¡Œ end note</code>çš„æ–¹å¼å¤„ç†</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_8</span><br><span class="line">start</span><br><span class="line">: æ­¥éª¤1;</span><br><span class="line">note left: This is a __NOTE__</span><br><span class="line">: æ­¥éª¤2;</span><br><span class="line">note right</span><br><span class="line">    æ”¯æŒ mark ç¼–è¾‘è¯­æ³•</span><br><span class="line">    This note is on several</span><br><span class="line">    &#x2F;&#x2F;lines&#x2F;&#x2F; and can</span><br><span class="line">    contain &lt;b&gt;HTML&lt;&#x2F;b&gt;</span><br><span class="line">    &#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">    * Calling the method &quot;&quot;foo()&quot;&quot; is prohibited</span><br><span class="line">end note</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921193326.png" alt=""></p>
<p>æ³¨æ„ mark å¹¶é Markdown è¯­æ³•ï¼Œä»¥æ¡ˆä¾‹ä¸º b</p>
<h4 id="Color-é¢œè‰²"><a href="#Color-é¢œè‰²" class="headerlink" title="Color é¢œè‰²"></a>Color é¢œè‰²</h4><p>åœ¨å†’å·é’±å¯ä»¥è¿½åŠ  <code>#åå…­è¿›åˆ¶</code> çš„é¢œè‰²ç¼–å·æˆ–è€…åç§°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_9</span><br><span class="line">start</span><br><span class="line">:è¿›ç¨‹å¼€å§‹;</span><br><span class="line">#red:è¯•ç€è¯»å–æ–‡ä»¶</span><br><span class="line">æ–‡ä»¶å¿…é¡»æœ‰å¯å†™æƒé™!;</span><br><span class="line">#AAAAAA:ç»“æŸè¿›ç¨‹;</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921193453.png" alt=""></p>
<h4 id="Complete-example-æ¡ˆä¾‹"><a href="#Complete-example-æ¡ˆä¾‹" class="headerlink" title="Complete example æ¡ˆä¾‹"></a>Complete example æ¡ˆä¾‹</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title act_new_10</span><br><span class="line">start</span><br><span class="line">:ClickServlet.handleRequest();</span><br><span class="line">:new page;</span><br><span class="line">if (Page.onSecurityCheck) then (true)</span><br><span class="line">    #7c7c7c:Page.onInit();</span><br><span class="line">    if (isForward?) then (no)</span><br><span class="line">    #red:Process controls;</span><br><span class="line">    if (continue processing?) then (no)</span><br><span class="line">        stop</span><br><span class="line">    endif</span><br><span class="line">    if (isPost?) then (yes)</span><br><span class="line">        :Page.onPost();</span><br><span class="line">    else (no)</span><br><span class="line">        :Page.onGet();</span><br><span class="line">    endif</span><br><span class="line">    :Page.onRender();</span><br><span class="line">    endif</span><br><span class="line">else (false)</span><br><span class="line">endif</span><br><span class="line">if (do redirect?) then (yes)</span><br><span class="line">    :redirect process;</span><br><span class="line">else</span><br><span class="line">    if (do forward?) then (yes)</span><br><span class="line">    :Forward request;</span><br><span class="line">    else (no)</span><br><span class="line">    :Render page template;</span><br><span class="line">    endif</span><br><span class="line">endif</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921193617.png" alt=""></p>
<h3 id="æ—¶åºå›¾-Sequence-Diagram"><a href="#æ—¶åºå›¾-Sequence-Diagram" class="headerlink" title="æ—¶åºå›¾ ( Sequence Diagram )"></a>æ—¶åºå›¾ ( Sequence Diagram )</h3><p>åŸºæœ¬è¯­æ³•</p>
<ol>
<li>ä½¿ç”¨ <code>èŠ‚ç‚¹ -&gt; èŠ‚ç‚¹: æè¿°</code> -&gt; ä¸ºå®çº¿</li>
<li>å¦‚æœä½¿ç”¨è™šçº¿åˆ™ ç”¨ <code>--&gt;</code></li>
<li>ç®­å¤´çš„æ–¹å‘å¯ä»¥æ˜¯åŒå‘çš„ <code>èŠ‚ç‚¹ &lt;-- èŠ‚ç‚¹</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_1</span><br><span class="line">ç”¨æˆ· -&gt; å¹³å°: å‘é€ç™»å½•è¯·æ±‚</span><br><span class="line">å¹³å° --&gt; ç”¨æˆ·: éªŒè¯é€šè¿‡</span><br><span class="line">ç”¨æˆ· -&gt; å¹³å°: å¦ä¸€ä¸ªè¯·æ±‚</span><br><span class="line">ç”¨æˆ· &lt;-- å¹³å°: è¿”å›éªŒè¯æ¶ˆæ¯</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921193759.png" alt=""></p>
<h4 id="Comments-æ³¨é‡Š"><a href="#Comments-æ³¨é‡Š" class="headerlink" title="Comments æ³¨é‡Š"></a>Comments æ³¨é‡Š</h4><p>å†…éƒ¨æ³¨é‡Šä½¿ç”¨ <code>&#39;</code> å•å¼•å·æ¥å¼€å§‹ å•è¡Œæ³¨é‡Šï¼Œ å¤šè¡Œæ³¨é‡Šåˆ™ä½¿ç”¨ <code>/&#39;</code> å’Œ <code>&#39;/</code> åŒ…æ‹¬</p>
<h4 id="Declaring-participant-ï¼ˆè§’è‰²ï¼‰"><a href="#Declaring-participant-ï¼ˆè§’è‰²ï¼‰" class="headerlink" title="Declaring participant ï¼ˆè§’è‰²ï¼‰"></a>Declaring participant ï¼ˆè§’è‰²ï¼‰</h4><p>æä¾›äº†çš„å£°æ˜å‚åŠ è€… (è§’è‰²)ï¼Œæ¥ä¸°å¯Œå›¾å½¢ï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨ç®­å¤´ä¸¤è¾¹çš„å·²ç»éšå¼å£°æ˜äº†( participant )ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>participant èŠ‚ç‚¹</code> æ¥æ˜¾ç¤ºå£°æ˜è§’è‰²ï¼Œè¿™ç§çŠ¶å†µä¸»è¦æ˜¯ä¸ºäº†å£°æ˜è§’è‰²çš„é¡ºåºã€‚</p>
<ul>
<li>actor</li>
<li>boundary</li>
<li>control</li>
<li>entity</li>
<li>database</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_2</span><br><span class="line">actor Foo1</span><br><span class="line">boundary Foo2</span><br><span class="line">control Foo3</span><br><span class="line">entity Foo4</span><br><span class="line">database Foo5</span><br><span class="line">Foo1 -&gt; Foo2 : To boundary</span><br><span class="line">Foo1 -&gt; Foo3 : To control</span><br><span class="line">Foo1 -&gt; Foo4 : To entity</span><br><span class="line">Foo1 -&gt; Foo5 : To database</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194112.png" alt=""></p>
<p>è¿½åŠ è‰²å½©æ¡ˆä¾‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_3</span><br><span class="line">actor å®¢æˆ· #red</span><br><span class="line">&#39; å£°æ˜è§’è‰²çš„æ—¶å€™åœ¨åé¢å¯ä»¥è¿½åŠ é¢œè‰²</span><br><span class="line">&#39; æ³¨é‡Šå†…å®¹å¹¶ä¸ä¼šæ˜¾ç¤º</span><br><span class="line">&#39; The only difference between actor</span><br><span class="line">&#39; and participant is the drawing</span><br><span class="line">participant æœåŠ¡ç«¯</span><br><span class="line">participant &quot;I have a really\nlong name&quot; as L #99FF99</span><br><span class="line">&#x2F;&#39;  è¿™é‡Œä½¿ç”¨ &#96;as&#96; å…³é”®å­—å£°æ˜äº† L æ¥ä½œä¸ºåˆ«å</span><br><span class="line">    ä½ ä¹Ÿå¯ä»¥è¿™æ ·å†™:</span><br><span class="line">    participant L as &quot;I have a really\nlong name&quot;  #99FF99</span><br><span class="line">    &#39;&#x2F;</span><br><span class="line">æœåŠ¡ç«¯-&gt;å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ·-&gt;æœåŠ¡ç«¯: Authentication Response</span><br><span class="line">å®¢æˆ·-&gt;L: Log transaction</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194240.png" alt=""></p>
<h4 id="Use-non-letters-in-participants-éå­—ç¬¦å¤„ç†"><a href="#Use-non-letters-in-participants-éå­—ç¬¦å¤„ç†" class="headerlink" title="Use non-letters in participants éå­—ç¬¦å¤„ç†"></a>Use non-letters in participants éå­—ç¬¦å¤„ç†</h4><p>åœ¨å£°æ˜éå­—æ¯çš„è§’è‰²çš„æ—¶å€™ä½¿ç”¨åŒå¼•å·å¤„ç† (åŒ…å«ç©ºæ ¼)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_4</span><br><span class="line">æœåŠ¡ç«¯ -&gt; &quot;å®¢æˆ·()&quot; : Hello</span><br><span class="line">&quot;å®¢æˆ·()&quot; -&gt; &quot;This is very\nlong&quot; as Long</span><br><span class="line">&#39; You can also declare:</span><br><span class="line">&#39; &quot;å®¢æˆ·()&quot; -&gt; Long as &quot;This is very\nlong&quot;</span><br><span class="line">Long --&gt; &quot;å®¢æˆ·()&quot; : ok</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194357.png" alt=""></p>
<h4 id="Message-to-Self"><a href="#Message-to-Self" class="headerlink" title="Message to Self"></a>Message to Self</h4><p>åœ¨ä»‹ç»è¿‡é•¿çš„å†…å®¹çš„æ—¶å€™ä½¿ç”¨ <code>\n</code> æ¥æ¢è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_5</span><br><span class="line">æœåŠ¡ç«¯-&gt;æœåŠ¡ç«¯: This is a signal to self.\nIt also demonstrates\nmultiline \ntext</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194508.png" alt=""></p>
<h4 id="Change-arrow-style-ç®­å¤´æ ·å¼"><a href="#Change-arrow-style-ç®­å¤´æ ·å¼" class="headerlink" title="Change arrow style ç®­å¤´æ ·å¼"></a>Change arrow style ç®­å¤´æ ·å¼</h4><p>åœ¨æ—¶åºå›¾ä¸­å¯ä»¥ä½¿ç”¨å¤šç§æ ·å¼ï¼ŒåŸºäºä¸‹é¢çš„æ¡ˆä¾‹ï¼Œæ¥æ›¿æ¢é»˜è®¤çš„ç®­å¤´</p>
<blockquote>
<p>æ€»ä½“æ¥è¯´ <code>-</code> è¡¨ç¤ºå®çº¿ï¼Œ <code>--</code> æ ‡è¯†è™šçº¿<br>è€Œåœ¨åœ¨ä¸¤è¾¹çš„æ ‡è¯†ç®­å¤´çš„æ–¹å‘å’Œæ ·å¼</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_6</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· -&gt;&gt; æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· -\ æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· \\- æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· &#x2F;&#x2F;-- æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· -&gt;o æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· o\\-- æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· &lt;-&gt; æœåŠ¡ç«¯</span><br><span class="line">å®¢æˆ· &lt;-&gt;o æœåŠ¡ç«¯</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194637.png" alt=""></p>
<h4 id="Change-arrow-color-ç®­å¤´è‰²å½©"><a href="#Change-arrow-color-ç®­å¤´è‰²å½©" class="headerlink" title="Change arrow color ç®­å¤´è‰²å½©"></a>Change arrow color ç®­å¤´è‰²å½©</h4><p>ä½¿ç”¨å…³é”®å­— <code>autonumber</code> æ¥è‡ªåŠ¨ä¸ºæ¶ˆæ¯ç”Ÿæˆç´¢å¼•æ•°å­—</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_8</span><br><span class="line">autonumber</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194722.png" alt=""></p>
<p>åœ¨ <code>autonumber</code> åå¯ä»¥è®¾å®š <code>å¼€å§‹ä½ç½® æ¢¯åº¦</code> å‚æ•°<br>åœ¨é»˜è®¤æƒ…å†µä¸‹ <code>autonumber</code> è‡ªåŠ¨è¿½åŠ äº† <code>start</code> å‚æ•°ï¼Œ åœ¨ä½¿ç”¨ <code>stop</code> å‚æ•°å¯ä»¥åœæ­¢è®¡æ•°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_9</span><br><span class="line">autonumber</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Authentication Response</span><br><span class="line">autonumber stop</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : åœæ­¢</span><br><span class="line">autonumber 15</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Another è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Another authentication Response</span><br><span class="line">autonumber 40 10</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Yet another è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Yet another authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921194933.png" alt=""></p>
<p>ä½ ä¹Ÿå¯ä»¥å¯¹æ•°å­—è¿›è¡Œæ ¼å¼åŒ–è¾“å‡ºï¼Œä¸º <code>autonumber</code> è¿½åŠ æ ¼å¼åŒ–ä½¿ç”¨å•å¼•å· <code>&quot;æ ¼å¼&quot;</code> ï¼Œå†…éƒ¨å¯ä»¥ä½¿ç”¨ HTML æ ‡è®°ï¼Œå¯ä»¥å‚çœ‹åé¢çš„ Formatting using HTML </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_10</span><br><span class="line">autonumber &quot;&lt;b&gt;[000]&lt;&#x2F;b&gt;&quot;</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Authentication Response</span><br><span class="line">autonumber 15 &quot;&lt;b&gt;(&lt;u&gt;###&lt;&#x2F;u&gt;)&quot;</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Another è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Another authentication Response</span><br><span class="line">autonumber 40 10 &quot;&lt;font color&#x3D;red&gt;&lt;b&gt;Message 0  &quot;</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Yet another è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Yet another authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921195056.png" alt=""></p>
<h4 id="Splitting-diagrams-åˆ†å‰²ä¸ºå¤šä¸ªå›¾å½¢"><a href="#Splitting-diagrams-åˆ†å‰²ä¸ºå¤šä¸ªå›¾å½¢" class="headerlink" title="Splitting diagrams åˆ†å‰²ä¸ºå¤šä¸ªå›¾å½¢"></a>Splitting diagrams åˆ†å‰²ä¸ºå¤šä¸ªå›¾å½¢</h4><p>å…³é”®å­— <code>newpage</code> å¯ä»¥å°†åŒä¸€å¼ å›¾å½¢åˆ†å‰²ä¸ºå¤šä¸ªå›¾ï¼Œå¯ä»¥è¿½åŠ  æ ‡é¢˜å‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_11</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 1</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 2</span><br><span class="line">newpage</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 3</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 4</span><br><span class="line">newpage ç¬¬ä¸‰ç« çš„æ ‡é¢˜\næœ€åä¸€é¡µ</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 5</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 6</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921195943.png" alt=""></p>
<h4 id="Grouping-message-åˆ†ç»„æ¶ˆæ¯"><a href="#Grouping-message-åˆ†ç»„æ¶ˆæ¯" class="headerlink" title="Grouping message åˆ†ç»„æ¶ˆæ¯"></a>Grouping message åˆ†ç»„æ¶ˆæ¯</h4><p>æä¾›äº†ä¸€ä¸‹å‡ ç»„å…³é”®è¯</p>
<ul>
<li>alt/else</li>
<li>opt</li>
<li>loop</li>
<li>par</li>
<li>break</li>
<li>critical</li>
<li>group, followed by a text to be displayed</li>
</ul>
<p>å…³é”®è¯åå¯ä»¥è¿½åŠ æ–‡æœ¬ï¼Œæ¥ä½œä¸ºå‰¯æ ‡é¢˜<br>ä½¿ç”¨ <code>end</code> å…³é”®è¯æ¥è¡¨ç¤ºç»“æŸ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_12</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">alt æˆåŠŸ</span><br><span class="line">    å®¢æˆ· -&gt; æœåŠ¡ç«¯: è®¸å¯è®¤è¯</span><br><span class="line">else å¯è¯†åˆ«çš„æ­£å¸¸å¤±è´¥</span><br><span class="line">    å®¢æˆ· -&gt; æœåŠ¡ç«¯: è®¤è¯å¤±è´¥</span><br><span class="line">    group ç»„åç§°</span><br><span class="line">        æœåŠ¡ç«¯ -&gt;  æ—¥å¿—:  attack start</span><br><span class="line">        loop 1000 times</span><br><span class="line">            æœåŠ¡ç«¯ -&gt; å®¢æˆ·: DNS Attack</span><br><span class="line">        end</span><br><span class="line">        æœåŠ¡ç«¯ -&gt;  æ—¥å¿—: Log attack end</span><br><span class="line">    end</span><br><span class="line">else  å…¶ä»–å¤±è´¥</span><br><span class="line">   å®¢æˆ· -&gt; æœåŠ¡ç«¯: é‡æ–°è¯·æ±‚</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200044.png" alt=""></p>
<h4 id="Notes-on-messages"><a href="#Notes-on-messages" class="headerlink" title="Notes on messages"></a>Notes on messages</h4><h5 id="å•è¡Œæ³¨é‡Š"><a href="#å•è¡Œæ³¨é‡Š" class="headerlink" title="å•è¡Œæ³¨é‡Š"></a>å•è¡Œæ³¨é‡Š</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">note right:  å³ä¾§çš„å†…å®¹</span><br><span class="line">note left:  å³ä¾§çš„å†…å®¹</span><br></pre></td></tr></table></figure>

<h5 id="å¤šè¡Œæ³¨é‡Š"><a href="#å¤šè¡Œæ³¨é‡Š" class="headerlink" title="å¤šè¡Œæ³¨é‡Š"></a>å¤šè¡Œæ³¨é‡Š</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">note right:</span><br><span class="line">å¤šè¡Œå†…å®¹</span><br><span class="line">end note</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_13</span><br><span class="line">æœåŠ¡ç«¯-&gt;å®¢æˆ· : hello</span><br><span class="line">note left: this is a first note</span><br><span class="line">å®¢æˆ·-&gt;æœåŠ¡ç«¯ : ok</span><br><span class="line">note right: this is another note</span><br><span class="line">å®¢æˆ·-&gt;å®¢æˆ· : I am thinking</span><br><span class="line">note left</span><br><span class="line">    a note</span><br><span class="line">    can also be defined</span><br><span class="line">    on several lines</span><br><span class="line">end note</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200217.png" alt=""></p>
<h4 id="Some-other-notes"><a href="#Some-other-notes" class="headerlink" title="Some other notes"></a>Some other notes</h4><p><code>of</code>ï¼Œ<code>over</code> åè·Ÿä¸Šè§’è‰²ï¼ˆå‚ä¸è€…ï¼‰ï¼Œå¯ä»¥ç®¡ç†ï¼Œå…¶ä¸­ <code>over</code> å¯ä»¥è¦†ç›–åœ¨çº¿ä¸Š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_14</span><br><span class="line">participant æœåŠ¡ç«¯</span><br><span class="line">participant å®¢æˆ·</span><br><span class="line">note left of æœåŠ¡ç«¯ #aqua</span><br><span class="line">    æ˜¾ç¤º</span><br><span class="line">    å·¦ä¾§ of æœåŠ¡ç«¯.</span><br><span class="line">end note</span><br><span class="line">note right of æœåŠ¡ç«¯: æ˜¾ç¤ºåœ¨å³ä¾§ of æœåŠ¡ç«¯.</span><br><span class="line">note over æœåŠ¡ç«¯: over æ³¨é‡Šè¦†ç›–åœ¨æœåŠ¡ç«¯.</span><br><span class="line">note over æœåŠ¡ç«¯, å®¢æˆ· #FFAAAA: æ³¨é‡Š\n è¦†ç›–åœ¨ å®¢æˆ· å’Œ æœåŠ¡ç«¯.</span><br><span class="line">note over å®¢æˆ·, æœåŠ¡ç«¯</span><br><span class="line">    This is yet another</span><br><span class="line">    example of</span><br><span class="line">    a long note.</span><br><span class="line">end note</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200340.png" alt=""></p>
<h4 id="Formatting-using-HTML"><a href="#Formatting-using-HTML" class="headerlink" title="Formatting using HTML"></a>Formatting using HTML</h4><p>ä½¿ç”¨ç±» html-tagï¼š</p>
<ul>
<li><code>&lt;b&gt;</code> æ¥åŠ ç²—å­—ä½“</li>
<li><code>&lt;u&gt;</code> or <code>&lt;u:#AAAAAA&gt;</code> or <code>&lt;u:colorName&gt;</code> è¾“å‡ºä¸‹åˆ’çº¿</li>
<li><code>&lt;i&gt;</code> æ–œä½“å­—è¾“å‡º</li>
<li><code>&lt;s&gt;</code> or <code>&lt;s:#AAAAAA&gt;</code> or <code>&lt;s:colorName&gt;</code> for strike text</li>
<li><code>&lt;w&gt; or</code>&lt;w:#AAAAAA&gt;<code>or</code>&lt;w:colorName&gt;` for wave underline text</li>
<li><code>&lt;color:#AAAAAA&gt;</code> or <code>&lt;color:colorName&gt;</code></li>
<li><code>&lt;back:#AAAAAA&gt;</code> or <code>&lt;back:colorName&gt;</code> for background color</li>
<li>`<a href="size:nn">size:nn</a> to change font size</li>
<li><code>&lt;img src=&quot;file&quot;&gt;</code> or <code>&lt;img:file&gt;</code> : the file must be accessible by the filesystem</li>
<li><code>&lt;img src=&quot;http://url&quot;&gt;</code> or <code>&lt;img:http://url&gt;</code> : the URL must be available from the Internet</li>
</ul>
<p><strong>example</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_15</span><br><span class="line">participant æœåŠ¡ç«¯</span><br><span class="line">participant &quot;The &lt;b&gt;Famous&lt;&#x2F;b&gt; å®¢æˆ·&quot; as å®¢æˆ·</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : A &lt;i&gt;well formated&lt;&#x2F;i&gt; message</span><br><span class="line">note right of æœåŠ¡ç«¯</span><br><span class="line"> This is &lt;back:cadetblue&gt;&lt;size:18&gt;displayed&lt;&#x2F;size&gt;&lt;&#x2F;back&gt;</span><br><span class="line"> &lt;u&gt;left of&lt;&#x2F;u&gt; æœåŠ¡ç«¯.</span><br><span class="line">end note</span><br><span class="line">note left of å®¢æˆ·</span><br><span class="line"> &lt;u:red&gt;This&lt;&#x2F;u&gt; is &lt;color #118888&gt;displayed&lt;&#x2F;color&gt;</span><br><span class="line"> &lt;b&gt;&lt;color purple&gt;left of&lt;&#x2F;color&gt; &lt;s:red&gt;æœåŠ¡ç«¯&lt;&#x2F;strike&gt; å®¢æˆ·&lt;&#x2F;b&gt;.</span><br><span class="line">end note</span><br><span class="line">note over æœåŠ¡ç«¯, å®¢æˆ·</span><br><span class="line"> &lt;w:#FF33FF&gt;This is hosted&lt;&#x2F;w&gt; by &lt;img http:&#x2F;&#x2F;s.plantuml.com&#x2F;logoc.png&gt;</span><br><span class="line">end note</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200506.png" alt=""></p>
<h4 id="Divider"><a href="#Divider" class="headerlink" title="Divider"></a>Divider</h4><p>If you want, you can split a diagram using == separator to divide your diagram into logical steps</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_16</span><br><span class="line">&#x3D;&#x3D; Initialisation &#x3D;&#x3D;</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: Authentication Response</span><br><span class="line">&#x3D;&#x3D; Repetition &#x3D;&#x3D;</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: Another è¯·æ±‚è®¤è¯</span><br><span class="line">æœåŠ¡ç«¯ &lt;-- å®¢æˆ·: another authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200612.png" alt=""></p>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><p>You can use reference in a diagram, using the keyword ref over</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_17</span><br><span class="line">participant æœåŠ¡ç«¯</span><br><span class="line">actor å®¢æˆ·</span><br><span class="line">ref over æœåŠ¡ç«¯, å®¢æˆ· : init</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ· : hello</span><br><span class="line">ref over å®¢æˆ·</span><br><span class="line">  This can be on</span><br><span class="line">  several lines</span><br><span class="line">end ref</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200730.png" alt=""></p>
<h4 id="Delay"><a href="#Delay" class="headerlink" title="Delay"></a>Delay</h4><p>You can use â€¦ to indicate a delay in the diagram. And it is also possible to put a message with this delay.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_18</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">...</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: Authentication Response</span><br><span class="line">...5 minutes latter...</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: Bye !</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200821.png" alt=""></p>
<h4 id="Space"><a href="#Space" class="headerlink" title="Space"></a>Space</h4><p>å¯¹æ¶ˆæ¯ä½¿ç”¨ç©ºè¡Œ <code>|||</code>ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰åƒç´ é«˜åº¦ <code>||æ•°å­—||</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_19</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: message 1</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: ok</span><br><span class="line">|||</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: message 2</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: ok</span><br><span class="line">||45||</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: message 3</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: ok</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921200928.png" alt=""></p>
<h4 id="Lifeline-Activation-and-Destruction-ç”Ÿå‘½å‘¨æœŸ"><a href="#Lifeline-Activation-and-Destruction-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Lifeline Activation and Destruction ç”Ÿå‘½å‘¨æœŸ"></a>Lifeline Activation and Destruction ç”Ÿå‘½å‘¨æœŸ</h4><p>ä½¿ç”¨ <code>activate è§’è‰²</code> è¡¨ç¤ºå¼€å§‹ç”Ÿå‘½å‘¨æœŸï¼Œä½¿ç”¨ <code>destory è§’è‰²</code> æ ‡è¯†ç»“æŸå‘¨æœŸ</p>
<p>å¼€å§‹å’Œç»“æŸå¿…é¡»æˆå¯¹çš„å­˜åœ¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_20</span><br><span class="line">participant User</span><br><span class="line">User -&gt; A: DoWork</span><br><span class="line">activate A</span><br><span class="line">A -&gt; B: &lt;&lt; createRequest &gt;&gt;</span><br><span class="line">activate B</span><br><span class="line">B -&gt; C: DoWork</span><br><span class="line">activate C</span><br><span class="line">C --&gt; B: WorkDone</span><br><span class="line">destroy C</span><br><span class="line">B --&gt; A: RequestCreated</span><br><span class="line">deactivate B</span><br><span class="line">A -&gt; User: Done</span><br><span class="line">deactivate A</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921201053.png" alt=""></p>
<p>ä¸ºè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ ‡è®°è‰²å½© ï¼Œå¯ä»¥è¿½åŠ è‰²å½©å‚æ•°ï¼Œ åœ¨ plantuml ä¸­è‰²å½©ä½¿ç”¨ #åå…­è¿›åˆ¶çš„è‰²å½©å€¼ æ¥è¡¨ç¤º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title seq_21</span><br><span class="line">participant User</span><br><span class="line">User -&gt; A: DoWork</span><br><span class="line">activate A #FFBBBB</span><br><span class="line">A -&gt; A: Internal call</span><br><span class="line">activate A #DarkSalmon</span><br><span class="line">A -&gt; B: &lt;&lt; createRequest &gt;&gt;</span><br><span class="line">activate B</span><br><span class="line">B --&gt; A: RequestCreated</span><br><span class="line">deactivate B</span><br><span class="line">deactivate A</span><br><span class="line">A -&gt; User: Done</span><br><span class="line">deactivate A</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921201142.png" alt=""></p>
<h4 id="Participant-creation"><a href="#Participant-creation" class="headerlink" title="Participant creation"></a>Participant creation</h4><p>You can use the create keyword just before the first reception of a message to emphasize the fact that this message is actually creating this new object</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : hello</span><br><span class="line">create Other</span><br><span class="line">æœåŠ¡ç«¯ -&gt; Other : new</span><br><span class="line">create control String</span><br><span class="line">æœåŠ¡ç«¯ -&gt; String</span><br><span class="line">note right : You can also put notes!</span><br><span class="line">æœåŠ¡ç«¯ --&gt; å®¢æˆ· : ok</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h4 id="Incoming-and-outgoing-messages"><a href="#Incoming-and-outgoing-messages" class="headerlink" title="Incoming and outgoing messages"></a>Incoming and outgoing messages</h4><p>You can use incoming or outgoing arrows if you want to focus on a part of the diagram. Use square brackets to denotate the left â€œ[â€œ or the right â€œ]â€ side of the diagram.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">[-&gt; A: DoWork</span><br><span class="line">activate A</span><br><span class="line">A -&gt; A: Internal call</span><br><span class="line">activate A</span><br><span class="line">A -&gt;] : &lt;&lt; createRequest &gt;&gt;</span><br><span class="line">A&lt;--] : RequestCreated</span><br><span class="line">deactivate A</span><br><span class="line">[&lt;- A: Done</span><br><span class="line">deactivate A</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921201337.png" alt=""></p>
<h4 id="Stereotypes-and-Spots"><a href="#Stereotypes-and-Spots" class="headerlink" title="Stereotypes and Spots"></a>Stereotypes and Spots</h4><p>It is possible to add stereotypes to participants using &lt;&lt; and &gt;&gt;. In the stereotype, you can add a spotted character in a colored circle using the syntax (X,color)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">participant &quot;Famous å®¢æˆ·&quot; as å®¢æˆ· &lt;&lt; Generated &gt;&gt;</span><br><span class="line">participant æœåŠ¡ç«¯ &lt;&lt; (C,#ADD1B2) Testable &gt;&gt;</span><br><span class="line">å®¢æˆ·-&gt;æœåŠ¡ç«¯: First message</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200921201436.png" alt=""></p>
<p>æˆ–è€…</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">participant å®¢æˆ· &lt;&lt; (C,#ADD1B2) &gt;&gt;</span><br><span class="line">participant æœåŠ¡ç«¯ &lt;&lt; (C,#ADD1B2) &gt;&gt;</span><br><span class="line">å®¢æˆ·-&gt;æœåŠ¡ç«¯: First message</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h4 id="More-information-on-titles"><a href="#More-information-on-titles" class="headerlink" title="More information on titles"></a>More information on titles</h4><p>You can use some HTML tags in the title.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title &lt;u&gt;Simple&lt;&#x2F;u&gt; communication example</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯: Authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p>You can add newline using \n in the title description.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title &lt;u&gt;Simple&lt;&#x2F;u&gt; communication example\non several lines</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯: Authentication Response</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<p>You can also define title on several lines using title and end title keywords.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line"></span><br><span class="line">title</span><br><span class="line"> &lt;u&gt;Simple&lt;&#x2F;u&gt; communication example</span><br><span class="line"> on &lt;i&gt;several&lt;&#x2F;i&gt; lines and using &lt;font color&#x3D;red&gt;html&lt;&#x2F;font&gt;</span><br><span class="line"> This is hosted by &lt;img:sourceforge.jpg&gt;</span><br><span class="line">end title</span><br><span class="line"></span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯: Authentication Response</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h4 id="7-22-Participants-englober"><a href="#7-22-Participants-englober" class="headerlink" title="7.22. Participants englober"></a>7.22. Participants englober</h4><p>It is possible to draw a box arround some participants, using box and end box commands. You can add an optional title or a optional background color, after the box keyword.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">box &quot;Internal Service&quot; #LightBlue</span><br><span class="line">    participant å®¢æˆ·</span><br><span class="line">    participant æœåŠ¡ç«¯</span><br><span class="line">end box</span><br><span class="line">participant Other</span><br><span class="line">å®¢æˆ· -&gt; æœåŠ¡ç«¯ : hello</span><br><span class="line">æœåŠ¡ç«¯ -&gt; Other : hello</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h4 id="7-23-Removing-Footer"><a href="#7-23-Removing-Footer" class="headerlink" title="7.23. Removing Footer"></a>7.23. Removing Footer</h4><p>You can use the hide footbox keywords to remove the footer of the diagram.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">hide footbox</span><br><span class="line">title Footer removed</span><br><span class="line">æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯</span><br><span class="line">å®¢æˆ· --&gt; æœåŠ¡ç«¯: Authentication Response</span><br></pre></td></tr></table></figure>

<p>@enduml</p>
<p>Skinparam</p>
<p>You can use the skinparam command to change colors and fonts for the drawing. You can use this command :</p>
<p>In the diagram definition, like any other commands, In an included file, In a configuration file, provided in the command line or the ANT task.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">skinparam backgroundColor #EEEBDC</span><br><span class="line"></span><br><span class="line">skinparam sequence &#123;</span><br><span class="line">    ArrowColor DeepSkyBlue</span><br><span class="line">    ActorBorderColor DeepSkyBlue</span><br><span class="line">    LifeLineBorderColor blue</span><br><span class="line">    LifeLineBackgroundColor #A9DCDF</span><br><span class="line"></span><br><span class="line">    ParticipantBorderColor DeepSkyBlue</span><br><span class="line">    ParticipantBackgroundColor DodgerBlue</span><br><span class="line">    ParticipantFontName Impact</span><br><span class="line">    ParticipantFontSize 17</span><br><span class="line">    ParticipantFontColor #A9DCDF</span><br><span class="line"></span><br><span class="line">    ActorBackgroundColor aqua</span><br><span class="line">    ActorFontColor DeepSkyBlue</span><br><span class="line">    ActorFontSize 17</span><br><span class="line">    ActorFontName Aapex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">actor User</span><br><span class="line">participant &quot;First Class&quot; as A</span><br><span class="line">participant &quot;Second Class&quot; as B</span><br><span class="line">participant &quot;Last Class&quot; as C</span><br><span class="line"></span><br><span class="line">User -&gt; A: DoWork</span><br><span class="line">activate A</span><br><span class="line"></span><br><span class="line">A -&gt; B: Create Request</span><br><span class="line">activate B</span><br><span class="line"></span><br><span class="line">B -&gt; C: DoWork</span><br><span class="line">activate C</span><br><span class="line">C --&gt; B: WorkDone</span><br><span class="line">destroy C</span><br><span class="line"></span><br><span class="line">B --&gt; A: Request Created</span><br><span class="line">deactivate B</span><br><span class="line"></span><br><span class="line">A --&gt; User: Done</span><br><span class="line">deactivate A</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://erasin.wang/plantuml/">PlantUMLè¯­æ³•</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/134200993">PlantUMLè¯­æ³•</a></p>
]]></content>
      <categories>
        <category>UML</category>
      </categories>
      <tags>
        <tag>UML</tag>
        <tag>plantuml</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Security (ä¸€) æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ</title>
    <url>/2020/05/30/Spring%20Security%20(%E4%B8%80)%20%E6%9E%B6%E6%9E%84%E6%A1%86%E6%9E%B6-Component%E3%80%81Service%E3%80%81Filter%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<blockquote>
<p>ã€è½¬è½½ã€‘</p>
<p>ä½œè€…ï¼šCcww</p>
<p>é“¾æ¥ï¼š<a href="https://juejin.im/post/5d074dc1f265da1bce3dd10f">https://juejin.im/post/5d074dc1f265da1bce3dd10f</a></p>
</blockquote>
<h1 id="Spring-security-ï¼ˆä¸€ï¼‰æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ"><a href="#Spring-security-ï¼ˆä¸€ï¼‰æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ" class="headerlink" title="Spring security ï¼ˆä¸€ï¼‰æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ"></a>Spring security ï¼ˆä¸€ï¼‰æ¶æ„æ¡†æ¶-Componentã€Serviceã€Filteråˆ†æ</h1><p>â€ƒâ€ƒæƒ³è¦æ·±å…¥spring securityçš„authentication ï¼ˆèº«ä»½éªŒè¯ï¼‰å’Œaccess-controlï¼ˆè®¿é—®æƒé™æ§åˆ¶ï¼‰å·¥ä½œæµç¨‹ï¼Œå¿…é¡»æ¸…æ¥šspring securityçš„ä¸»è¦æŠ€æœ¯ç‚¹åŒ…æ‹¬å…³é”®æ¥å£ã€ç±»ä»¥åŠæŠ½è±¡ç±»å¦‚ä½•ååŒå·¥ä½œè¿›è¡Œauthentication å’Œaccess-controlçš„å®ç°ã€‚</p>
<h2 id="Spring-Security-è®¤è¯å’Œæˆæƒæµç¨‹"><a href="#Spring-Security-è®¤è¯å’Œæˆæƒæµç¨‹" class="headerlink" title="Spring Security è®¤è¯å’Œæˆæƒæµç¨‹"></a>Spring Security è®¤è¯å’Œæˆæƒæµç¨‹</h2><p>å¸¸è§è®¤è¯å’Œæˆæƒæµç¨‹å¯ä»¥åˆ†æˆï¼š</p>
<ol>
<li>A user is prompted to log in with a username and password ï¼ˆç”¨æˆ·ç”¨è´¦å¯†ç ç™»å½•ï¼‰</li>
<li>The system (successfully) verifies that the password is correct for the usernameï¼ˆæ ¡éªŒå¯†ç æ­£ç¡®æ€§ï¼‰</li>
<li>The context information for that user is obtained (their list of roles and so on).ï¼ˆè·å–ç”¨æˆ·ä¿¡æ¯contextï¼Œå¦‚æƒé™ï¼‰</li>
<li>A security context is established for the userï¼ˆä¸ºç”¨æˆ·åˆ›å»ºsecurity contextï¼‰</li>
<li>The user proceeds, potentially to perform some operation which is potentially protected by an access control mechanism which checks the required permissions for the operation against the current security context information.ï¼ˆè®¿é—®æƒé™æ§åˆ¶ï¼Œæ˜¯å¦å…·æœ‰è®¿é—®æƒé™ï¼‰</li>
</ol>
<h3 id="Spring-Security-è®¤è¯"><a href="#Spring-Security-è®¤è¯" class="headerlink" title="Spring Security è®¤è¯"></a>Spring Security è®¤è¯</h3><p>ä¸Šè¿°å‰ä¸‰ç‚¹ä¸ºspring securityè®¤è¯éªŒè¯ç¯èŠ‚ï¼š</p>
<ol>
<li>é€šå¸¸é€šè¿‡<code>AbstractAuthenticationProcessingFilter</code>è¿‡æ»¤å™¨å°†è´¦å·å¯†ç ç»„è£…æˆAuthenticationå®ç°ç±»<code>UsernamePasswordAuthenticationToken</code>ï¼›</li>
<li>å°†tokenä¼ é€’ç»™AuthenticationManageréªŒè¯æ˜¯å¦æœ‰æ•ˆï¼Œè€ŒAuthenticationManageré€šå¸¸ä½¿ç”¨<code>ProviderManager</code>å®ç°ç±»æ¥æ£€éªŒï¼›</li>
<li><code>AuthenticationManager</code>è®¤è¯æˆåŠŸåå°†è¿”å›ä¸€ä¸ªæ‹¥æœ‰è¯¦ç»†ä¿¡æ¯çš„Authentication objectï¼ˆåŒ…æ‹¬æƒé™ä¿¡æ¯ï¼Œèº«ä»½ä¿¡æ¯ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œä½†å¯†ç é€šå¸¸ä¼šè¢«ç§»é™¤ï¼‰ï¼›</li>
<li>é€šè¿‡<code>SecurityContextHolder.getContext().getAuthentication().getPrincipal()</code>å°†Authenticationè®¾ç½®åˆ°security contextä¸­ã€‚</li>
</ol>
<h3 id="Spring-Security-è®¿é—®æˆæƒ"><a href="#Spring-Security-è®¿é—®æˆæƒ" class="headerlink" title="Spring Security è®¿é—®æˆæƒ"></a>Spring Security è®¿é—®æˆæƒ</h3><ol>
<li>é€šè¿‡<code>FilterSecurityInterceptor</code>è¿‡æ»¤å™¨å…¥å£è¿›å…¥ï¼›</li>
<li><code>FilterSecurityInterceptor</code>é€šè¿‡å…¶ç»§æ‰¿çš„æŠ½è±¡ç±»AbstractSecurityInterceptorçš„<code>beforeInvocation(Object object)</code>æ–¹æ³•è¿›è¡Œè®¿é—®æˆæƒï¼Œå…¶ä¸­æ¶‰åŠäº†ç±»<code>AuthenticationManager</code>ã€<code>AccessDecisionManager</code>ã€<code>SecurityMetadataSource</code>ç­‰ã€‚</li>
</ol>
<p>æ ¹æ®ä¸Šè¿°æè¿°çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸»è¦å»åˆ†æå…¶ä¸­æ¶‰åŠçš„ä¸€ä¸‹Componentã€Serviceã€Filterã€‚</p>
<h2 id="æ ¸å¿ƒç»„ä»¶ï¼ˆCore-Component-ï¼‰"><a href="#æ ¸å¿ƒç»„ä»¶ï¼ˆCore-Component-ï¼‰" class="headerlink" title="æ ¸å¿ƒç»„ä»¶ï¼ˆCore Component ï¼‰"></a>æ ¸å¿ƒç»„ä»¶ï¼ˆCore Component ï¼‰</h2><h3 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h3><p>â€ƒâ€ƒ<code>SecurityContextHolder</code>æä¾›å¯¹<code>SecurityContext</code>çš„è®¿é—®ï¼Œå­˜å‚¨security contextï¼ˆç”¨æˆ·ä¿¡æ¯ã€è§’è‰²æƒé™ç­‰ï¼‰ï¼Œè€Œä¸”å…¶å…·æœ‰ä¸‹åˆ—å‚¨å­˜ç­–ç•¥å³å·¥ä½œæ¨¡å¼ï¼š</p>
<ol>
<li><code>SecurityContextHolder.MODE_THREADLOCAL</code>ï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨<code>ThreadLocal</code>ï¼Œä¿¡æ¯å¯ä¾›æ­¤çº¿ç¨‹ä¸‹çš„æ‰€æœ‰çš„æ–¹æ³•ä½¿ç”¨ï¼Œä¸€ç§ä¸çº¿ç¨‹ç»‘å®šçš„ç­–ç•¥ï¼Œæ­¤å¤©ç„¶å¾ˆé€‚åˆServlet Webåº”ç”¨ã€‚</li>
<li><code>SecurityContextHolder.MODE_GLOBAL</code>ï¼šä½¿ç”¨äºç‹¬ç«‹åº”ç”¨</li>
<li><code>SecurityContextHolder.MODE_INHERITABLETHREADLOCAL</code>ï¼šå…·æœ‰ç›¸åŒå®‰å…¨æ ‡ç¤ºçš„çº¿ç¨‹</li>
</ol>
<p>ä¿®æ”¹<code>SecurityContextHolder</code>çš„å·¥ä½œæ¨¡å¼æœ‰ä¸¤ç§æ–¹æ³• :</p>
<ol>
<li>è®¾ç½®ä¸€ä¸ªç³»ç»Ÿå±æ€§(system.properties) : spring.security.strategy;</li>
<li>è°ƒç”¨<code>SecurityContextHolder</code>é™æ€æ–¹æ³•<code>setStrategyName()</code></li>
</ol>
<p>åœ¨é»˜è®¤<code>ThreadLocal</code>ç­–ç•¥ä¸­ï¼Œ<code>SecurityContextHolder</code>ä¸ºé™æ€æ–¹æ³•è·å–ç”¨æˆ·ä¿¡æ¯ä¸º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal(); </span><br><span class="line"><span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails) &#123;      </span><br><span class="line">     String username = ((UserDetails)principal).getUsername();  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     String username = principal.toString();     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä¸€èˆ¬ä¸éœ€è¦è‡ªèº«å»è·å–ã€‚ å…¶ä¸­<code>getAuthentication()</code>è¿”å›ä¸€ä¸ª<code>Authentication</code>è®¤è¯ä¸»ä½“ï¼Œæ¥ä¸‹æ¥åˆ†æ<code>Authentication</code>ã€<code>UserDetails</code>ç»†èŠ‚ã€‚</p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><p>â€ƒâ€ƒSpring Securityä½¿ç”¨ä¸€ä¸ª<code>Authentication</code>å¯¹è±¡æ¥æè¿°å½“å‰ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯,å…¶åŒ…å«ç”¨æˆ·æ‹¥æœ‰çš„æƒé™ä¿¡æ¯åˆ—è¡¨ã€ç”¨æˆ·ç»†èŠ‚ä¿¡æ¯ï¼ˆèº«ä»½ä¿¡æ¯ã€è®¤è¯ä¿¡æ¯ï¼‰ã€‚<code>Authentication</code>ä¸ºè®¤è¯ä¸»ä½“åœ¨spring securityä¸­æ—¶æœ€é«˜çº§åˆ«èº«ä»½/è®¤è¯çš„æŠ½è±¡ï¼Œå¸¸è§çš„å®ç°ç±»<code>UsernamePasswordAuthenticationToken</code>ã€‚<code>Authentication</code>æ¥å£æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123; </span><br><span class="line">    <span class="comment">//æƒé™ä¿¡æ¯åˆ—è¡¨,é»˜è®¤GrantedAuthorityæ¥å£çš„ä¸€äº›å®ç°ç±»</span></span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); </span><br><span class="line">    <span class="comment">//å¯†ç ä¿¡æ¯</span></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//ç»†èŠ‚ä¿¡æ¯ï¼Œwebåº”ç”¨ä¸­çš„å®ç°æ¥å£é€šå¸¸ä¸º WebAuthenticationDetailsï¼Œå®ƒè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’ŒsessionIdçš„å€¼</span></span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//é€šå¸¸è¿”å›å€¼ä¸ºUserDetailså®ç°ç±»</span></span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰é¢ä¸¤ä¸ªç»„ä»¶éƒ½æ¶‰åŠäº†UserDetailsï¼Œä»¥åŠGrantedAuthorityå…¶åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ2.3å°èŠ‚åˆ†æã€‚</p>
<h3 id="UserDetails-amp-GrantedAuthority"><a href="#UserDetails-amp-GrantedAuthority" class="headerlink" title="UserDetails&amp;GrantedAuthority"></a>UserDetails&amp;GrantedAuthority</h3><p>â€ƒâ€ƒUserDetailsæä¾›ä»åº”ç”¨ç¨‹åºçš„DAOæˆ–å…¶ä»–å®‰å…¨æ•°æ®æºæ„å»ºAuthenticationå¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼ŒåŒ…å«GrantedAuthorityã€‚å…¶å®˜æ–¹å®ç°ç±»ä¸ºUserï¼Œå¼€å‘è€…å¯ä»¥å®ç°å…¶æ¥å£è‡ªå®šä¹‰UserDetailså®ç°ç±»ã€‚å…¶æ¥å£æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">     <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€ƒ   UserDetailsä¸Authenticationæ¥å£åŠŸèƒ½ç±»ä¼¼ï¼Œå…¶å«ä¹‰æ˜¯Authenticationä¸ºç”¨æˆ·æäº¤çš„è®¤è¯å‡­è¯ï¼ˆè´¦å·å¯†ç ï¼‰ï¼›</p>
<p>â€‹        UserDetailsä¸ºç³»ç»Ÿä¸­ç”¨æˆ·æ­£ç¡®è®¤è¯å‡­è¯ï¼›</p>
<p>â€‹        UserDetailsServiceä¸­çš„loadUserByUsernameæ–¹æ³•è·å–æ­£ç¡®çš„è®¤è¯å‡­è¯ï¼›</p>
<p> â€ƒ å…¶ä¸­åœ¨getAuthorities()æ–¹æ³•ä¸­è·å–åˆ°GrantedAuthorityåˆ—è¡¨æ˜¯ä»£è¡¨ç”¨æˆ·è®¿é—®åº”ç”¨ç¨‹åºæƒé™èŒƒå›´ï¼Œæ­¤ç±»æƒé™é€šå¸¸æ˜¯â€œrole(è§’è‰²ï¼‰â€ï¼Œä¾‹å¦‚<code>ROLE_ADMINISTRATOR</code>æˆ–<code>ROLE_HR_SUPERVISOR</code>ï¼›</p>
<p>â€‹        GrantedAuthorityæ¥å£å¸¸è§çš„å®ç°ç±»SimpleGrantedAuthorityã€‚</p>
<h2 id="æ ¸å¿ƒæœåŠ¡ç±»ï¼ˆCore-Servicesï¼‰"><a href="#æ ¸å¿ƒæœåŠ¡ç±»ï¼ˆCore-Servicesï¼‰" class="headerlink" title="æ ¸å¿ƒæœåŠ¡ç±»ï¼ˆCore Servicesï¼‰"></a>æ ¸å¿ƒæœåŠ¡ç±»ï¼ˆCore Servicesï¼‰</h2><h3 id="AuthenticationManagerã€ProviderManagerä»¥åŠAuthenticationProvider"><a href="#AuthenticationManagerã€ProviderManagerä»¥åŠAuthenticationProvider" class="headerlink" title="AuthenticationManagerã€ProviderManagerä»¥åŠAuthenticationProvider"></a>AuthenticationManagerã€ProviderManagerä»¥åŠAuthenticationProvider</h3><p>â€ƒâ€ƒ<code>AuthenticationManager</code>æ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæ¥å£ï¼Œæ˜¯è®¤è¯ä¸€åˆ‡çš„èµ·ç‚¹ã€‚</p>
<p>â€‹         <strong><em>å¸¸è§çš„è®¤è¯æµç¨‹éƒ½æ˜¯AuthenticationManagerå®ç°ç±»ProviderManagerå¤„ç†</em></strong>ï¼Œè€Œä¸”ProviderManagerå®ç°ç±»åŸºäºå§”æ‰˜è€…æ¨¡å¼ç»´æŠ¤<code>AuthenticationProvider</code> åˆ—è¡¨ç”¨äºä¸åŒçš„è®¤è¯æ–¹å¼ã€‚ä¾‹å¦‚ï¼š</p>
<ol>
<li>ä½¿ç”¨<strong>è´¦å·å¯†ç </strong>è®¤è¯æ–¹å¼<code>DaoAuthenticationProvider</code>å®ç°ç±»ï¼ˆç»§æ‰¿äº†AbstractUserDetailsAuthenticationProvideæŠ½è±¡ç±»ï¼‰ï¼Œå…¶ä¸ºé»˜è®¤è®¤è¯æ–¹å¼ï¼Œè¿›è¡Œæ•°æ®åº“åº“è·å–è®¤è¯æ•°æ®ä¿¡æ¯ã€‚</li>
<li><strong>æ¸¸å®¢</strong>èº«ä»½ç™»å½•è®¤è¯æ–¹å¼<code>AnonymousAuthenticationProvider</code>å®ç°ç±»</li>
<li>ä»<strong>cookies</strong>è·å–è®¤è¯æ–¹å¼<code>RememberMeAuthenticationProvider</code>å®ç°ç±»</li>
</ol>
<p><code>ProviderManager</code>æºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">	Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span><br><span class="line">	AuthenticationException lastException = <span class="keyword">null</span>;</span><br><span class="line">	Authentication result = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//AuthenticationProvideråˆ—è¡¨ä¾æ¬¡è®¤è¯</span></span><br><span class="line">	<span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!provider.supports(toTest)) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//æ¯ä¸ªAuthenticationProviderè¿›è¡Œè®¤è¯</span></span><br><span class="line">			result = provider.authenticate(authentication)</span><br><span class="line">			<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">				copyDetails(authentication, result);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		....</span><br><span class="line">		<span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">			lastException = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//è¿›è¡Œçˆ¶ç±»AuthenticationProviderè¿›è¡Œè®¤è¯</span></span><br><span class="line">	<span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Allow the parent to try.</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			result = parent.authenticate(authentication);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">			lastException = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	   <span class="comment">// å¦‚æœæœ‰Authenticationä¿¡æ¯ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (eraseCredentialsAfterAuthentication</span><br><span class="line">				&amp;&amp; (result <span class="keyword">instanceof</span> CredentialsContainer)) &#123;</span><br><span class="line">				<span class="comment">//æ¸…é™¤å¯†ç </span></span><br><span class="line">			((CredentialsContainer) result).eraseCredentials();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶</span></span><br><span class="line">		eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">//å¦‚æœéƒ½æ²¡è®¤è¯æˆåŠŸï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">	<span class="keyword">if</span> (lastException == <span class="keyword">null</span>) &#123;</span><br><span class="line">		lastException = <span class="keyword">new</span> ProviderNotFoundException(messages.getMessage(</span><br><span class="line">				<span class="string">&quot;ProviderManager.providerNotFound&quot;</span>,</span><br><span class="line">				<span class="keyword">new</span> Object[] &#123; toTest.getName() &#125;,</span><br><span class="line">				<span class="string">&quot;No AuthenticationProvider found for &#123;0&#125;&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	prepareException(lastException, authentication);</span><br><span class="line">	<span class="keyword">throw</span> lastException;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>â€ƒ    ProviderManager ä¸­çš„<code>List&lt;AuthenticationProvider&gt;</code>ï¼Œä¼š<strong>ä¾ç…§æ¬¡åº</strong>å»è®¤è¯ï¼›</p>
<p>â€‹         é»˜è®¤ç­–ç•¥ä¸‹ï¼Œåªéœ€è¦é€šè¿‡ä¸€ä¸ª<code>AuthenticationProvider</code>çš„è®¤è¯ï¼Œå³å¯è¢«è®¤ä¸ºæ˜¯ç™»å½•æˆåŠŸï¼Œè€Œä¸”è®¤è¯æˆåŠŸåè¿”å›ä¸€ä¸ª<code>Authentication</code>å®ä½“ï¼Œå¹¶ä¸ºäº†å®‰å…¨ä¼šè¿›è¡Œæ¸…é™¤å¯†ç ã€‚</p>
<p>â€‹        å¦‚æœæ‰€æœ‰è®¤è¯å™¨éƒ½æ— æ³•è®¤è¯æˆåŠŸï¼Œåˆ™ProviderManager ä¼šæŠ›å‡ºä¸€ä¸ª<code>ProviderNotFoundException</code>å¼‚å¸¸ã€‚</p>
<h3 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h3><p>â€ƒâ€ƒUserDetailsServiceæ¥å£ä½œç”¨æ˜¯ä»ç‰¹å®šçš„åœ°æ–¹è·å–è®¤è¯çš„æ•°æ®æºï¼ˆè´¦å·ã€å¯†ç ï¼‰ã€‚å¦‚ä½•è·å–åˆ°ç³»ç»Ÿä¸­æ­£ç¡®çš„è®¤è¯å‡­è¯ï¼Œé€šè¿‡<code>loadUserByUsername(String username)</code>è·å–è®¤è¯ä¿¡æ¯ï¼Œè€Œä¸”å…¶åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;  </span><br></pre></td></tr></table></figure>

<p>â€‹    UserDetailsServiceå¸¸è§çš„å®ç°ç±»</p>
<ol>
<li>ä»æ•°æ®åº“è·å–çš„JdbcDaoImplå®ç°ç±»ï¼Œ</li>
<li>ä»å†…å­˜ä¸­è·å–çš„InMemoryUserDetailsManagerå®ç°ç±»ï¼Œ</li>
<li>â€¦.</li>
<li>è‡ªå®šä¹‰UserDetailsServiceå®ç°ç±»ï¼Œå¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="comment">//ç”¨æˆ·mapper</span></span><br><span class="line"> <span class="keyword">private</span> UserInfoMapper userInfoMapper;</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="comment">//ç”¨æˆ·æƒé™mapper</span></span><br><span class="line"> <span class="keyword">private</span> PermissionInfoMapper permissionInfoMapper;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">    UserInfoDTO userInfo = userInfoMapper.getUserInfoByUserName(username);</span><br><span class="line">    <span class="keyword">if</span> (userInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;PermissionInfoDTO&gt; permissionInfoDTOS = permissionInfoMapper.findByAdminUserId(userInfo.getId());</span><br><span class="line">        List&lt;GrantedAuthority&gt; grantedAuthorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//ç»„è£…æƒé™GrantedAuthority object</span></span><br><span class="line">        <span class="keyword">for</span> (PermissionInfoDTO permissionInfoDTO : permissionInfoDTOS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionInfoDTO != <span class="keyword">null</span> &amp;&amp; permissionInfoDTO.getPermissionName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                GrantedAuthority grantedAuthority = <span class="keyword">new</span> SimpleGrantedAuthority(</span><br><span class="line">                        permissionInfoDTO.getPermissionName());</span><br><span class="line">                grantedAuthorityList.add(grantedAuthority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è¿”å›ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(userInfo.getUserName(), userInfo.getPasswaord(), grantedAuthorityList);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æŠ›å‡ºç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">&quot;admin&quot;</span> + username + <span class="string">&quot;do not exist&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<h3 id="AccessDecisionManager-amp-SecurityMetadataSource"><a href="#AccessDecisionManager-amp-SecurityMetadataSource" class="headerlink" title="AccessDecisionManager&amp;SecurityMetadataSource"></a>AccessDecisionManager&amp;SecurityMetadataSource</h3><p>â€ƒâ€ƒAccessDecisionManageræ˜¯ç”±AbstractSecurityInterceptorè°ƒç”¨ï¼Œè´Ÿè´£åšå‡ºæœ€ç»ˆçš„è®¿é—®æ§åˆ¶å†³ç­–ã€‚</p>
<p>AccessDecisionManageræ¥å£æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è®¿é—®æ§åˆ¶å†³ç­–</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object secureObject,Collection&lt;ConfigAttribute&gt; attrs)</span> <span class="keyword">throws</span> AccessDeniedException</span>;</span><br><span class="line"> <span class="comment">//æ˜¯å¦æ”¯æŒå¤„ç†ä¼ é€’çš„ConfigAttribute</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span></span>;</span><br><span class="line"> <span class="comment">//ç¡®è®¤classæ˜¯å¦ä¸ºAccessDecisionManager</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class clazz)</span></span>;</span><br></pre></td></tr></table></figure>

<p>â€ƒâ€ƒSecurityMetadataSourceåŒ…å«ç€AbstractSecurityInterceptorè®¿é—®æˆæƒæ‰€éœ€çš„å…ƒæ•°æ®ï¼ˆåŠ¨æ€urlã€åŠ¨æ€æˆæƒæ‰€éœ€çš„æ•°æ®ï¼‰ï¼›åœ¨AbstractSecurityInterceptoræˆæƒæ¨¡å—ä¸­ç»“åˆAccessDecisionManagerè¿›è¡Œè®¿é—®æˆæƒï¼Œå…¶æ¶‰åŠäº†ConfigAttributeã€‚ </p>
<p>SecurityMetadataSourceæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object object)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰SecurityMetadataSourceæ•°æ®æºï¼Œå®ç°æ¥å£FilterInvocationSecurityMetadataSourceã€‚ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilterSecurityMetadataSource</span> <span class="keyword">implements</span> <span class="title">FilterInvocationSecurityMetadataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        FilterInvocation fi = (FilterInvocation) object;</span><br><span class="line">        String url = fi.getRequestUrl();</span><br><span class="line">        String httpMethod = fi.getRequest().getMethod();</span><br><span class="line">        List&lt;ConfigAttribute&gt; attributes = <span class="keyword">new</span> ArrayList&lt;ConfigAttribute&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lookup your database (or other source) using this information and populate the</span></span><br><span class="line">        <span class="comment">// list of attributes</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation.class.isAssignableFrom(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h3><p>â€ƒä¸ºäº†å­˜å‚¨å®‰å…¨ï¼Œä¸€èˆ¬è¦å¯¹å¯†ç è¿›è¡Œç®—æ³•åŠ å¯†ã€‚</p>
<p>Spring Securityæä¾›äº†åŠ å¯†<code>PasswordEncoder</code>æ¥å£ã€‚å…¶å®ç°ç±»æœ‰ï¼š</p>
<ol>
<li><p>BCrypt hashç®—æ³•å®ç°çš„<code>BCryptPasswordEncoder</code>ï¼›</p>
</li>
<li><p>SCrypt hashing ç®—æ³•å®ç°çš„<code>SCryptPasswordEncoder</code>ï¼›</p>
</li>
</ol>
<p>PasswordEncoderæ¥å£åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¯†ç åŠ å¯†</span></span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span>;</span><br><span class="line">    <span class="comment">//å¯†ç é…å¯¹</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="æ ¸å¿ƒ-Security-è¿‡æ»¤å™¨ï¼ˆCore-Security-Filtersï¼‰"><a href="#æ ¸å¿ƒ-Security-è¿‡æ»¤å™¨ï¼ˆCore-Security-Filtersï¼‰" class="headerlink" title="æ ¸å¿ƒ Security è¿‡æ»¤å™¨ï¼ˆCore Security Filtersï¼‰"></a>æ ¸å¿ƒ Security è¿‡æ»¤å™¨ï¼ˆCore Security Filtersï¼‰</h2><h3 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a>FilterSecurityInterceptor</h3><p>â€ƒâ€ƒ<code>FilterSecurityInterceptor</code>æ˜¯Spring Security<strong>æˆæƒæ¨¡å—å…¥å£</strong>ï¼Œè¯¥ç±»æ ¹æ®è®¿é—®çš„ç”¨æˆ·çš„è§’è‰²ï¼Œæƒé™æˆæƒè®¿é—®é‚£äº›èµ„æºï¼ˆè®¿é—®ç‰¹å®šè·¯å¾„åº”è¯¥å…·å¤‡çš„æƒé™ï¼‰ã€‚<br>â€ƒâ€ƒ<code>FilterSecurityInterceptor</code>å°è£…<code>FilterInvocation</code>å¯¹è±¡è¿›è¡Œæ“ä½œï¼›</p>
<p>â€‹           æ‰€æœ‰çš„è¯·æ±‚åˆ°äº†<code>FilterSecurityInterceptor</code>ï¼Œå¦‚æœè¿™ä¸ªfilterä¹‹å‰æ²¡æœ‰æ‰§è¡Œè¿‡çš„è¯ï¼Œé‚£ä¹ˆé¦–å…ˆæ‰§è¡Œå…¶çˆ¶ç±»<code>AbstractSecurityInterceptor</code>æä¾›çš„<code>InterceptorStatusToken token = super.beforeInvocation(fi)</code>ï¼Œè¯¥æ–¹æ³•ä¼šï¼š</p>
<ol>
<li>ä½¿ç”¨AuthenticationManagerè·å–Authenticationä¸­ç”¨æˆ·è¯¦æƒ…ï¼›</li>
<li>ä½¿ç”¨ConfigAttributeå°è£…å·²å®šä¹‰å¥½è®¿é—®æƒé™è¯¦æƒ…ï¼›</li>
<li>ä½¿ç”¨AccessDecisionManager.decide()æ–¹æ³•è¿›è¡Œè®¿é—®æƒé™æ§åˆ¶ã€‚</li>
</ol>
<p><code>FilterSecurityInterceptor</code>æºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((fi.getRequest() != <span class="keyword">null</span>)</span><br><span class="line">			&amp;&amp; (fi.getRequest().getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>)</span><br><span class="line">			&amp;&amp; observeOncePerRequest) &#123;</span><br><span class="line">		fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// first time this request being called, so perform security checking</span></span><br><span class="line">		<span class="keyword">if</span> (fi.getRequest() != <span class="keyword">null</span> &amp;&amp; observeOncePerRequest) &#123;</span><br><span class="line">			fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//å›è°ƒå…¶ç»§æ‰¿çš„æŠ½è±¡ç±»AbstractSecurityInterceptorçš„æ–¹æ³•</span></span><br><span class="line">		InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">super</span>.finallyInvocation(token);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractSecurityInterceptoræºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">	....</span><br><span class="line">	<span class="comment">//è·å–æ‰€æœ‰è®¿é—®æƒé™ï¼ˆurl-roleï¼‰å±æ€§åˆ—è¡¨ï¼ˆå·²å®šä¹‰åœ¨æ•°æ®åº“æˆ–è€…å…¶ä»–åœ°æ–¹ï¼‰</span></span><br><span class="line">	Collection&lt;ConfigAttribute&gt; attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource()</span><br><span class="line">			.getAttributes(object);</span><br><span class="line">	....</span><br><span class="line">	<span class="comment">//è·å–è¯¥ç”¨æˆ·è®¿é—®ä¿¡æ¯ï¼ˆåŒ…æ‹¬urlï¼Œè®¿é—®æƒé™ï¼‰</span></span><br><span class="line">	Authentication authenticated = authenticateIfRequired();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attempt authorization</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//è¿›è¡Œæˆæƒè®¿é—®</span></span><br><span class="line">		<span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</span><br><span class="line">	&#125;<span class="keyword">catch</span></span><br><span class="line">	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UsernamePasswordAuthenticationFilter"><a href="#UsernamePasswordAuthenticationFilter" class="headerlink" title="UsernamePasswordAuthenticationFilter"></a>UsernamePasswordAuthenticationFilter</h3><p>â€ƒâ€ƒ<code>UsernamePasswordAuthenticationFilter</code>ä½¿ç”¨usernameå’Œpasswordè¡¨å•ç™»å½•ä½¿ç”¨çš„è¿‡æ»¤å™¨ï¼Œä¹Ÿæ˜¯<strong>æœ€å¸¸ç”¨çš„</strong>è¿‡æ»¤å™¨ã€‚å…¶æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">    HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">     <span class="comment">//è·å–è¡¨å•ä¸­çš„ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line">     String username = obtainUsername(request);</span><br><span class="line">     String password = obtainPassword(request);</span><br><span class="line">     ...</span><br><span class="line">     username = username.trim();</span><br><span class="line">     <span class="comment">//ç»„è£…æˆusername+passwordå½¢å¼çš„token</span></span><br><span class="line">     UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">     username, password);</span><br><span class="line">     <span class="comment">// Allow subclasses to set the &quot;details&quot; property</span></span><br><span class="line">     setDetails(request, authRequest);</span><br><span class="line">     <span class="comment">//äº¤ç»™å†…éƒ¨çš„AuthenticationManagerå»è®¤è¯ï¼Œå¹¶è¿”å›è®¤è¯ä¿¡æ¯</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p>â€ƒâ€ƒå…¶ä¸»è¦ä»£ç ä¸ºåˆ›å»º<code>UsernamePasswordAuthenticationToken</code>çš„Authenticationå®ä½“ä»¥åŠè°ƒç”¨AuthenticationManagerè¿›è¡Œauthenticateè®¤è¯ï¼Œæ ¹æ®è®¤è¯ç»“æœæ‰§è¡ŒsuccessfulAuthenticationæˆ–è€…unsuccessfulAuthenticationï¼Œæ— è®ºæˆåŠŸå¤±è´¥ï¼Œä¸€èˆ¬çš„å®ç°éƒ½æ˜¯è½¬å‘æˆ–è€…é‡å®šå‘ç­‰å¤„ç†ï¼Œä¸å†ç»†ç©¶AuthenticationSuccessHandlerå’ŒAuthenticationFailureHandleã€‚è‹¥æœ‰å…´è¶£ï¼Œå¯ä»¥ç ”ç©¶ä¸€ä¸‹å…¶çˆ¶ç±»AbstractAuthenticationProcessingFilterè¿‡æ»¤å™¨ã€‚</p>
<h3 id="AnonymousAuthenticationFilter"><a href="#AnonymousAuthenticationFilter" class="headerlink" title="AnonymousAuthenticationFilter"></a>AnonymousAuthenticationFilter</h3><p><code>AnonymousAuthenticationFilter</code>æ˜¯åŒ¿åç™»å½•è¿‡æ»¤å™¨ï¼Œå®ƒä½äºå¸¸ç”¨çš„èº«ä»½è®¤è¯è¿‡æ»¤å™¨ï¼ˆå¦‚UsernamePasswordAuthenticationFilterã€BasicAuthenticationFilterã€RememberMeAuthenticationFilterï¼‰ä¹‹åï¼Œæ„å‘³ç€åªæœ‰åœ¨ä¸Šè¿°èº«ä»½è¿‡æ»¤å™¨æ‰§è¡Œå®Œæ¯•åï¼ŒSecurityContextä¾æ—§æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼ŒAnonymousAuthenticationFilterè¯¥è¿‡æ»¤å™¨æ‰ä¼šæœ‰æ„ä¹‰â€”â€”ç»™<strong>å½“å‰è¯·æ±‚</strong>ä¸€ä¸ªåŒ¿åèº«ä»½ã€‚</p>
<p> AnonymousAuthenticationFilteræºç åˆ†æï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnonymousAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">	<span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AnonymousAuthenticationFilter</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">this</span>(key, <span class="string">&quot;anonymousUser&quot;</span>, AuthorityUtils.createAuthorityList(<span class="string">&quot;ROLE_ANONYMOUS&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//åˆ›å»ºåŒ¿åç™»å½•Authenticationçš„ä¿¡æ¯</span></span><br><span class="line">	    	SecurityContextHolder.getContext().setAuthentication(</span><br><span class="line">			    	createAuthentication((HttpServletRequest) req));</span><br><span class="line">		    		...</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    chain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºåŒ¿åç™»å½•Authenticationçš„ä¿¡æ¯æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Authentication <span class="title">createAuthentication</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">	    AnonymousAuthenticationToken auth = <span class="keyword">new</span> AnonymousAuthenticationToken(key,</span><br><span class="line">			principal, authorities);</span><br><span class="line">	    auth.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">	    <span class="keyword">return</span> auth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SecurityContextPersistenceFilter"><a href="#SecurityContextPersistenceFilter" class="headerlink" title="SecurityContextPersistenceFilter"></a>SecurityContextPersistenceFilter</h3><p>â€ƒâ€ƒSecurityContextPersistenceFilterçš„ä¸¤ä¸ªä¸»è¦ä½œç”¨ï¼š</p>
<ol>
<li>å½“Requestè¿‡æ¥æ—¶ï¼Œåˆ›å»ºSecurityContextå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
<li>å½“Requestç»“æŸæ—¶ï¼Œæ¸…ç©ºSecurityContextHolderã€‚</li>
</ol>
<h2 id="å°èŠ‚æ€»ç»“ï¼š"><a href="#å°èŠ‚æ€»ç»“ï¼š" class="headerlink" title="å°èŠ‚æ€»ç»“ï¼š"></a>å°èŠ‚æ€»ç»“ï¼š</h2><p>. AbstractAuthenticationProcessingFilter:ä¸»è¦å¤„ç†ç™»å½•<br>. FilterSecurityInterceptor:ä¸»è¦å¤„ç†é‰´æƒ</p>
]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data ElasticSearch</title>
    <url>/2021/01/31/SpringDataElasticSearch/</url>
    <content><![CDATA[<h1 id="Spring-Data-ElasticSearch"><a href="#Spring-Data-ElasticSearch" class="headerlink" title="Spring Data ElasticSearch"></a>Spring Data ElasticSearch</h1><h2 id="Spring-Data-ElasticSearch-å…¥é—¨æ¡ˆä¾‹"><a href="#Spring-Data-ElasticSearch-å…¥é—¨æ¡ˆä¾‹" class="headerlink" title="Spring Data ElasticSearch å…¥é—¨æ¡ˆä¾‹"></a>Spring Data ElasticSearch å…¥é—¨æ¡ˆä¾‹</h2><p>Spring Data å’Œ Elasticsearch ç»“åˆçš„æ—¶å€™ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§é—®é¢˜ï¼ŒElasticsearch å’Œ Spring Boot æ˜¯åŒæ—¶å‘å‰å‘å±•çš„ï¼Œè€Œ Elasticsearch çš„å¤§ç‰ˆæœ¬ä¹‹é—´è¿˜å­˜åœ¨ä¸€å®šçš„ API å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥å¿…é¡»è¦çŸ¥é“è¿™äº›ç‰ˆæœ¬ä¹‹é—´çš„å…³ç³»ï¼Œè¡¨æ ¼å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Spring Data Release Train</th>
<th align="center">Spring Data Elasticsearch</th>
<th align="center">Elasticsearch</th>
<th align="center">Spring Boot</th>
</tr>
</thead>
<tbody><tr>
<td align="center">2020.0.0<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_1">[1]</a></td>
<td align="center">4.1.x<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_1">[1]</a></td>
<td align="center">7.9.3</td>
<td align="center">2.4.x<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_1">[1]</a></td>
</tr>
<tr>
<td align="center">Neumann</td>
<td align="center">4.0.x</td>
<td align="center">7.6.2</td>
<td align="center">2.3.x</td>
</tr>
<tr>
<td align="center">Moore</td>
<td align="center">3.2.x</td>
<td align="center">6.8.12</td>
<td align="center">2.2.x</td>
</tr>
<tr>
<td align="center">Lovelace</td>
<td align="center">3.1.x</td>
<td align="center">6.2.2</td>
<td align="center">2.1.x</td>
</tr>
<tr>
<td align="center">Kay<a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=490#/detail/pc?id=4731">[2]</a></td>
<td align="center">3.0.x<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_2">[2]</a></td>
<td align="center">5.5.0</td>
<td align="center">2.0.x<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_2">[2]</a></td>
</tr>
<tr>
<td align="center">Ingalls<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_2">[2]</a></td>
<td align="center">2.1.x<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_2">[2]</a></td>
<td align="center">2.4.0</td>
<td align="center">1.5.x<a href="https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/#_footnotedef_2">[2]</a></td>
</tr>
</tbody></table>
<p>ç”±äºç‰ˆæœ¬è¶Šæ–°è¶Šä¾¿åˆ©ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ç›´æ¥é‡‡ç”¨æœ€æ–°çš„ç‰ˆæœ¬ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šåˆ©ç”¨ Helm Chart å®‰è£…ä¸€ä¸ª Elasticsearch é›†ç¾¤ 7.9.3 ç‰ˆæœ¬</strong>ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1. helm2 repo add elastic https://helm.elastic.co</span><br><span class="line">2. helm2 install --name myelasticsearch elastic/elasticsearchÂ  --set imageTag=7.9.3</span><br></pre></td></tr></table></figure>

<p>å®‰è£…å®Œä¹‹åï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ã€‚</p>
<p><img src="http://image.leonote.cn//20210131155146.jpg" alt=""></p>
<p>è¿™ä»£è¡¨å®‰è£…æˆåŠŸã€‚</p>
<p>ç”±äº ElasticSearch æ˜¯å‘å±•å˜åŒ–çš„ï¼Œæ‰€ä»¥å®ƒçš„å®‰è£…æ–¹å¼å¯ä»¥å‚è€ƒ<a href="https://github.com/elastic/helm-charts/tree/master/elasticsearch">å®˜æ–¹æ–‡æ¡£</a></p>
<p>ç„¶ååˆ©ç”¨ k8s é›†ç¾¤ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ï¼Œå°±å¯ä»¥å¼€å§‹æµ‹è¯•äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">~ â¯â¯â¯ kubectl port-forward svc/elasticsearch-master 9200:9200 -n my-namespace</span><br><span class="line">Forwarding from 127.0.0.1:9200 -&gt; 9200</span><br><span class="line">Forwarding from [::1]:9200 -&gt; 9200</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥ï¼šåœ¨ gradle.build é‡Œé¢é…ç½® Spring Data ElasticSearch ä¾èµ–çš„ Jar åŒ…ã€‚</strong></p>
<p>ä¾èµ– Spring Boot 2.4.1 ç‰ˆæœ¬ï¼Œå®Œæ•´çš„ gradle.build æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">   id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;2.4.1&#x27;</span></span><br><span class="line">   id <span class="string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="string">&#x27;1.0.10.RELEASE&#x27;</span></span><br><span class="line">   id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">group = <span class="string">&#x27;com.example.data.es&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;0.0.1-SNAPSHOT&#x27;</span></span><br><span class="line">sourceCompatibility = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line">configurations &#123;</span><br><span class="line">   compileOnly &#123;</span><br><span class="line">      extendsFrom annotationProcessor</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">   mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">   implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-actuator&#x27;</span></span><br><span class="line">   implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-elasticsearch&#x27;</span></span><br><span class="line">   implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">   compileOnly <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">   developmentOnly <span class="string">&#x27;org.springframework.boot:spring-boot-devtools&#x27;</span></span><br><span class="line">   runtimeOnly <span class="string">&#x27;io.micrometer:micrometer-registry-prometheus&#x27;</span></span><br><span class="line">   annotationProcessor <span class="string">&#x27;org.projectlombok:lombok&#x27;</span></span><br><span class="line">   testImplementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">test &#123;</span><br><span class="line">   useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼šæ–°å»ºä¸€ä¸ªç›®å½•ï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•ã€‚</strong></p>
<p><img src="http://image.leonote.cn//20210131155436.jpg" alt=""></p>
<p><strong>ç¬¬å››æ­¥ï¼šåœ¨ application.properties é‡Œé¢æ–°å¢ es çš„è¿æ¥åœ°å€ï¼Œè¿æ¥æœ¬åœ°çš„ Elasticsearchã€‚</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.data.elasticsearch.client.reactive.endpoints</span>=<span class="string">127.0.0.1:9200</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äº”æ­¥ï¼šæ–°å¢ä¸€ä¸ª ElasticSearchConfiguration çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¼€å¯æ‰«æçš„åŒ…ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo.es;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.config.EnableElasticsearchRepositories;</span><br><span class="line"><span class="comment">//åˆ©ç”¨@EnableElasticsearchRepositoriesæ³¨è§£æŒ‡å®šElasticsearchç›¸å…³çš„Repositoryçš„åŒ…è·¯å¾„åœ¨å“ªé‡Œ</span></span><br><span class="line"><span class="meta">@EnableElasticsearchRepositories(basePackages = &quot;com.example.data.es.demo.es&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å…­æ­¥ï¼šæ–°å¢ä¸€ä¸ª Topic çš„ Documentï¼Œå®ƒç±»ä¼¼ JPA é‡Œé¢çš„å®ä½“ï¼Œç”¨æ¥ä¿å­˜å’Œè¯»å– Topic çš„æ•°æ®</strong>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo.es;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.Field;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.annotations.FieldType;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;topic&quot;)</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="comment">//è®ºå›ä¸»é¢˜ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Topic</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Nested, includeInParent = true)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Author&gt; authors;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.example.data.es.demo.es;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="comment">//ä½œè€…ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸ƒæ­¥ï¼šæ–°å»ºä¸€ä¸ª Elasticsearch çš„ Repositoryï¼Œç”¨æ¥å¯¹ Elasticsearch ç´¢å¼•çš„å¢åˆ æ”¹æŸ¥</strong>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo.es;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="comment">//ç±»ä¼¼JPAä¸€æ ·ç›´æ¥æ“ä½œTopicç±»å‹çš„ç´¢å¼•</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TopicRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Topic</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Topic&gt; <span class="title">findByTitle</span><span class="params">(String title)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å…«æ­¥: æ–°å»ºä¸€ä¸ª Controllerï¼Œå¯¹ Topic ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢å’Œæ·»åŠ ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> TopicRepository topicRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æŸ¥è¯¢topicçš„æ‰€æœ‰ç´¢å¼•</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;topics&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Topic&gt; <span class="title">query</span><span class="params">(<span class="meta">@Param(&quot;title&quot;)</span> String title)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> topicRepository.findByTitle(title);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¿å­˜ topicç´¢å¼•</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;topics&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Topic <span class="title">create</span><span class="params">(<span class="meta">@RequestBody</span> Topic topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> topicRepository.save(topic);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¹æ­¥ï¼šå‘é€ä¸€ä¸ªæ·»åŠ å’ŒæŸ¥è¯¢çš„è¯·æ±‚æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<p>å‘é€ä¸‰ä¸ª POST è¯·æ±‚ï¼Œæ·»åŠ ä¸‰æ¡ç´¢å¼•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/topics</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8080</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span><span class="punctuation">: </span>d9cc1f6c-24dd-17ff-f2e8-3063fa6b86fc</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;:&quot;jack&quot;,</span><br><span class="line">    &quot;id&quot;:2,</span><br><span class="line">    &quot;authors&quot;:[&#123;</span><br><span class="line">        &quot;name&quot;:&quot;jk1&quot;</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">        &quot;name&quot;:&quot;jk2&quot;</span><br><span class="line">        &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå‘é€ä¸€ä¸ª get è¯·æ±‚ï¼Œè·å¾—æ ‡é¢˜æ˜¯ jack çš„ç´¢å¼•ï¼Œå¦‚ä¸‹é¢è¿™è¡Œä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:8080/topics?title=jack</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å¦‚ä¸‹ç»“æœã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://127.0.0.1:8080/topics?title=jack</span><br><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span>Â </span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Wed, 30 Dec 2020 15:12:16 GMT</span><br><span class="line"><span class="attribute">Keep-Alive</span><span class="punctuation">: </span>timeout=60</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">Â  &#123;</span><br><span class="line">Â  Â  &quot;id&quot;: 1,</span><br><span class="line">Â  Â  &quot;title&quot;: &quot;jack&quot;,</span><br><span class="line">Â  Â  &quot;authors&quot;: [</span><br><span class="line">Â  Â  Â  &#123;</span><br><span class="line">Â  Â  Â  Â  &quot;name&quot;: &quot;jk1&quot;</span><br><span class="line">Â  Â  Â  &#125;,</span><br><span class="line">Â  Â  Â  &#123;</span><br><span class="line">Â  Â  Â  Â  &quot;name&quot;: &quot;jk2&quot;</span><br><span class="line">Â  Â  Â  &#125;</span><br><span class="line">Â  Â  ]</span><br><span class="line">Â  &#125;,</span><br><span class="line">Â  &#123;</span><br><span class="line">Â  Â  &quot;id&quot;: 3,</span><br><span class="line">Â  Â  &quot;title&quot;: &quot;jack&quot;,</span><br><span class="line">Â  Â  &quot;authors&quot;: [</span><br><span class="line">Â  Â  Â  &#123;</span><br><span class="line">Â  Â  Â  Â  &quot;name&quot;: &quot;jk1&quot;</span><br><span class="line">Â  Â  Â  &#125;,</span><br><span class="line">Â  Â  Â  &#123;</span><br><span class="line">Â  Â  Â  Â  &quot;name&quot;: &quot;jk2&quot;</span><br><span class="line">Â  Â  Â  &#125;</span><br><span class="line">Â  Â  ]</span><br><span class="line">Â  &#125;,</span><br><span class="line">Â  &#123;</span><br><span class="line">Â  Â  &quot;id&quot;: 2,</span><br><span class="line">Â  Â  &quot;title&quot;: &quot;jack&quot;,</span><br><span class="line">Â  Â  &quot;authors&quot;: [</span><br><span class="line">Â  Â  Â  &#123;</span><br><span class="line">Â  Â  Â  Â  &quot;name&quot;: &quot;jk1&quot;</span><br><span class="line">Â  Â  Â  &#125;,</span><br><span class="line">Â  Â  Â  &#123;</span><br><span class="line">Â  Â  Â  Â  &quot;name&quot;: &quot;jk2&quot;</span><br><span class="line">Â  Â  Â  &#125;</span><br><span class="line">Â  Â  ]</span><br><span class="line">Â  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 348ms; Content length: 199 bytes</span><br><span class="line">Cannot preserve cookies, cookie storage file is included in ignored list:</span><br><span class="line">&gt; /Users/jack/Company/git_hub/spring-data-jpa-guide/2.3/elasticsearch-data/.idea/httpRequests/http-client.cookies</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ Spring Data Elasticsearch æ¥æ“ä½œ ES ç›¸å…³çš„ API çš„è¯ï¼Œæ¯”ç›´æ¥å†™ Http çš„ client è¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºè¿™é‡Œé¢å°è£…äº†å¾ˆå¤šåŸºç¡€é€»è¾‘ï¼Œçœå»äº†å¾ˆå¤šé‡å¤é€ è½®å­çš„è¿‡ç¨‹ã€‚</p>
<p><strong>ç¬¬åæ­¥ï¼šElasticsearch Repository çš„æµ‹è¯•ç”¨ä¾‹å†™æ³•</strong>ï¼Œå¦‚ä¸‹é¢çš„ä»£ç å’Œæ³¨é‡Šæ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo;</span><br><span class="line"><span class="keyword">import</span> com.example.data.es.demo.es.Author;</span><br><span class="line"><span class="keyword">import</span> com.example.data.es.demo.es.Topic;</span><br><span class="line"><span class="keyword">import</span> com.example.data.es.demo.es.TopicRepository;</span><br><span class="line"><span class="keyword">import</span> org.assertj.core.util.Lists;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.BeforeEach;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.TestPropertySource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@TestPropertySource(properties = &#123;&quot;logging.level.org.springframework.data.elasticsearch.core=TRACE&quot;, &quot;logging.level.org.springframework.data.elasticsearch.client=trace&quot;, &quot;logging.level.org.elasticsearch.client=TRACE&quot;, &quot;logging.level.org.apache.http=TRACE&quot;&#125;)</span><span class="comment">//æ–°å¢ä¸€äº›é…ç½®ï¼Œ å¼€å¯spring data elastic searchçš„httpçš„è°ƒç”¨è¿‡ç¨‹ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹æ—¥å¿—</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchRepositoryTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> TopicRepository topicRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        topicRepository.deleteAll(); //å¯ä»¥ç›´æ¥åˆ é™¤æ‰€æœ‰ç´¢å¼•</span></span><br><span class="line">        Topic topic = Topic.builder().id(<span class="number">11L</span>)</span><br><span class="line">            						.title(<span class="string">&quot;jacktest&quot;</span>)</span><br><span class="line">            						.authors(Lists.newArrayList(Author.builder()</span><br><span class="line">                                                                .name(<span class="string">&quot;jk1&quot;</span>)</span><br><span class="line">                                                                .build()))</span><br><span class="line">            						.build();</span><br><span class="line">        topicRepository.save(topic);<span class="comment">//é›†æˆæµ‹è¯•ä¿å­˜ç´¢å¼•</span></span><br><span class="line">        Topic topic1 = Topic.builder().id(<span class="number">14L</span>)</span><br><span class="line">            						 .title(<span class="string">&quot;jacktest&quot;</span>)</span><br><span class="line">            					 	 .authors(Lists.newArrayList(Author.builder()</span><br><span class="line">                                        .name(<span class="string">&quot;jk1&quot;</span>)</span><br><span class="line">                                        .build()))</span><br><span class="line">            						 .build();</span><br><span class="line">        topicRepository.save(topic1);</span><br><span class="line">        Topic topic2 = Topic.builder().id(<span class="number">15L</span>)</span><br><span class="line">            						 .title(<span class="string">&quot;jacktest&quot;</span>)</span><br><span class="line">            						 .authors(Lists.newArrayList(Author.builder()</span><br><span class="line">                                        .name(<span class="string">&quot;jk1&quot;</span>)</span><br><span class="line">                                        .build()))</span><br><span class="line">            						 .build();</span><br><span class="line">        topicRepository.save(topic2);<span class="comment">//ä¿å­˜ç´¢å¼•</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTopic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterable&lt;Topic&gt; topics = topicRepository.findAll();</span><br><span class="line">        topics.forEach(topic1 -&gt; &#123;</span><br><span class="line">            System.out.println(topic1);</span><br><span class="line">        &#125;);</span><br><span class="line">        List&lt;Topic&gt; topicList = topicRepository.findByTitle(<span class="string">&quot;jacktest&quot;</span>);</span><br><span class="line">        topicList.forEach(t -&gt; &#123;</span><br><span class="line">            System.out.println(t);<span class="comment">//è·å¾—ç´¢å¼•çš„æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">        &#125;);</span><br><span class="line">        List&lt;Topic&gt; topicList2 = topicRepository.findByTitle(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">        topicList2.forEach(t -&gt; &#123;</span><br><span class="line">            System.out.println(t);<span class="comment">//ä¹Ÿå¯ä»¥ç”¨æ–­è¨€æµ‹è¯•</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœ‹ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹çš„è°ƒç”¨æ—¥å¿—ï¼Œä»æ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨çš„æ—¶å€™å‘ç”Ÿçš„ Http çš„ PUT è¯·æ±‚ï¼Œæ˜¯ç”¨æ¥åˆ›å»ºå’Œä¿®æ”¹ä¸€ä¸ªç´¢å¼•çš„æ–‡æ¡£çš„ã€‚è¯·çœ‹ä¸‹é¢çš„å›¾ç‰‡ã€‚</p>
<p><img src="http://image.leonote.cn//20210131160243.jpg" alt=""></p>
<p>ä»ä¸­ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œè½¬åŒ–æˆ es çš„ api æŸ¥è¯¢è¯­æ³•ä¹‹åï¼Œå‘é€çš„ post è¯·æ±‚åˆå˜æˆä¸‹å›¾æ˜¾ç¤ºçš„æ ·å­ã€‚</p>
<p><img src="http://image.leonote.cn//20210131160331.jpg" alt=""></p>
<h2 id="Spring-Data-ElasticSearch-å…³é”®çš„ç±»"><a href="#Spring-Data-ElasticSearch-å…³é”®çš„ç±»" class="headerlink" title="Spring Data ElasticSearch å…³é”®çš„ç±»"></a>Spring Data ElasticSearch å…³é”®çš„ç±»</h2><p>é€šè¿‡ä¸Šé¢çš„æ¡ˆä¾‹å¯ä»¥çŸ¥é“ï¼ŒSpring Data ElasticSearch çš„ç”¨æ³•å…¶å®éå¸¸ç®€å•ï¼Œå¹¶ä¸”é€šè¿‡æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåº•å±‚å®ç°æ˜¯åŸºäº http è¯·æ±‚ï¼Œæ¥æ“ä½œ Elasticsearch çš„ server ä¸­çš„ api è¿›è¡Œçš„ã€‚</p>
<p>é‚£ä¹ˆç®€å•çœ‹ä¸€ä¸‹è¿™ä¸€æ¡†æ¶è¿˜æä¾›äº†å“ªäº› ElasticSearch çš„æ“ä½œæ–¹æ³•ã€‚çœ‹ä¸€ä¸‹ Repository çš„æ‰€æœ‰å­ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20210131160632.jpg" alt=""></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œ<code>ElasticsearchRepository</code> æ˜¯é»˜è®¤çš„ Repository çš„å®ç°ç±»ï¼Œå¦‚æœç»§ç»­å¾€ä¸‹é¢çœ‹æºç çš„è¯ï¼Œå°±å¯ä»¥çœ‹åˆ°é‡Œé¢è¿›è¡Œäº†å¾ˆå¤š ES çš„ Http Client æ“ä½œã€‚</p>
<p>åŒæ—¶å†çœ‹ä¸€ä¸‹ Structure è§†å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131160716.jpg" alt=""></p>
<p>ä»è¿™å¼ å›¾å¯ä»¥çŸ¥é“ï¼Œ<code>ElasticsearchRepository</code> é»˜è®¤æä¾›äº† search å’Œ index ç›¸å…³çš„ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œå¹¶ä¸” Spring Data Common é‡Œé¢çš„ä¸€äº›å…¬å…±æ–¹æ³•åŒæ ·é€‚ç”¨ï¼Œè¿™å’Œåˆšæ‰æ¼”ç¤ºçš„ Defining Method Query çš„ JPA è¯­æ³•åŒæ ·é€‚ç”¨ï¼Œå¯ä»¥å¤§å¤§å‡è½»æ“ä½œ ES çš„éš¾åº¦ï¼Œæé«˜äº†å¼€å‘çš„æ•ˆç‡ï¼Œç”šè‡³åƒåˆ†é¡µã€æ’åºã€limit ç­‰åŒæ ·é€‚ç”¨ã€‚</p>
<p>å’Œ Spring Data JPA ç”¨ç›¸åŒçš„æ€è·¯ï¼Œå°±å¯ä»¥å¾ˆå¿«æŒæ¡ Spring Data Elasticsearch çš„åŸºæœ¬ç”¨æ³•ï¼ŒåŠå…¶å¤§æ¦‚çš„å®ç°æ€è·¯ã€‚</p>
<h2 id="ESRepository-å’Œ-JPARepository-åŒæ—¶å­˜åœ¨"><a href="#ESRepository-å’Œ-JPARepository-åŒæ—¶å­˜åœ¨" class="headerlink" title="ESRepository å’Œ JPARepository åŒæ—¶å­˜åœ¨"></a>ESRepository å’Œ JPARepository åŒæ—¶å­˜åœ¨</h2><p>å‡è®¾åˆšæ‰æµ‹è¯•çš„æ ·ä¾‹é‡Œé¢ï¼ŒåŒæ—¶æœ‰å…³äº User ä¿¡æ¯çš„ DB æ“ä½œï¼Œé‚£ä¹ˆé¡¹ç›®åº”è¯¥æ€ä¹ˆå†™ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šå°†å¯¹ Elasticsearch çš„å®ä½“ã€Repository å’Œå¯¹ JPA æ“ä½œçš„å®ä½“ã€Repository æ”¾åˆ°ä¸åŒçš„æ–‡ä»¶é‡Œé¢</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131160920.jpg" alt=""></p>
<p><strong>ç¬¬äºŒæ­¥ï¼šæ–°å¢ JpaConfigurationï¼Œç”¨æ¥æŒ‡å®š Jpa ç›¸å…³çš„ Repository ç›®å½•</strong>ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo.jpa;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;</span><br><span class="line"><span class="comment">//åˆ©ç”¨ @EnableJpaRepositories æŒ‡å®šJPAçš„ç›®å½•æ˜¯ &quot;com.example.data.es.demo.jpa&quot;</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &quot;com.example.data.es.demo.jpa&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfiguration</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼šæ–°å¢ User å®ä½“ï¼Œç”¨æ¥æ“ä½œç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å››æ­¥ï¼šæ–°å¢ UserRepositoryï¼Œç”¨æ¥è¿›è¡Œ DB æ“ä½œã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo.jpa;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="comment">//å¯¹Userçš„DBæ“ä½œï¼Œç›´æ¥ç»§æ‰¿JpaRepository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äº”æ­¥ï¼šå†™æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæµ‹è¯•ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.data.es.demo;</span><br><span class="line"><span class="keyword">import</span> com.example.data.es.demo.jpa.User;</span><br><span class="line"><span class="keyword">import</span> com.example.data.es.demo.jpa.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ©ç”¨@DataJpaTestå®Œæˆé›†æˆæµ‹è¯•</span></span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryTest</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJpa</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//å¾€æ•°æ®åº“é‡Œé¢ä¿å­˜ä¸€æ¡æ•°æ®ï¼Œå¹¶ä¸”æ‰“å°ä¸€ä¸‹</span></span><br><span class="line">        userRepository.save(User.builder().id(<span class="number">1L</span>)</span><br><span class="line">                            .name(<span class="string">&quot;jkdb&quot;</span>)</span><br><span class="line">                            .email(<span class="string">&quot;jack@email.com&quot;</span>)</span><br><span class="line">                            .build());</span><br><span class="line">        List&lt;User&gt; users = userRepository.findAll();</span><br><span class="line">        users.forEach(user -&gt; &#123;</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™ï¼Œæµ‹è¯•ç”¨ä¾‹å°±å˜æˆäº†å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç»“æ„ã€‚</p>
<p><img src="http://image.leonote.cn//20210131161203.jpg" alt=""></p>
<p>JPA å’Œ Elasticsearch åŒæ—¶å­˜åœ¨ï¼Œå’Œå¯åŠ¨é¡¹ç›®æ˜¯ä¸€æ ·çš„æ•ˆæœï¼Œè¿™é‡Œå°±ä¸å†™ Controller äº†ã€‚</p>
<p>å†æ•´ä½“è¿è¡Œä¸€ä¸‹è¿™ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¿›è¡Œå®Œæ•´çš„æµ‹è¯•ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœã€‚</p>
<ol>
<li><p><code>ElasticSearchRepositoryTest</code> æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°è¿™æ˜¯å¯¹ ES è¿›è¡Œçš„æ“ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131161259.jpg" alt=""></p>
</li>
<li><p><code>UserRepositoryTest</code> æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹å‡ºæ¥è¿™æ˜¯å¯¹ DB è¿›è¡Œçš„æ“ä½œï¼Œæ‰€ä»¥è°ä¹Ÿä¸å½±å“è°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131161344.jpg" alt=""></p>
</li>
</ol>
<p>   Spring Data å¯¹ JPA ç­‰ SQL å‹çš„ä¼ ç»Ÿæ•°æ®åº“çš„æ”¯æŒæ˜¯éå¸¸å¥½çš„ï¼ŒåŒæ—¶å¯¹ NoSQL å‹çš„éå…³ç³»ç±»æ•°æ®åº“çš„æ”¯æŒä¹Ÿæ¯”è¾ƒå‹å¥½ï¼Œå¤§å¤§é™ä½äº†æ“ä½œä¸åŒæ•°æ®æºçš„éš¾åº¦ï¼Œå¯ä»¥æœ‰æ•ˆæå‡å¼€å‘æ•ˆç‡ã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data ElasticSearch</category>
      </categories>
      <tags>
        <tag>Spring Data ElasticSearch</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa äº‹åŠ¡ä¸è¿æ¥æ± </title>
    <url>/2020/11/18/SpringDataJpa%E4%BA%8B%E5%8A%A1%E4%B8%8E%E8%BF%9E%E6%8E%A5%E6%B1%A0/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-äº‹åŠ¡ä¸è¿æ¥æ± "><a href="#Spring-Data-Jpa-äº‹åŠ¡ä¸è¿æ¥æ± " class="headerlink" title="Spring Data Jpa äº‹åŠ¡ä¸è¿æ¥æ± "></a>Spring Data Jpa äº‹åŠ¡ä¸è¿æ¥æ± </h1><h2 id="äº‹åŠ¡çš„åŸºæœ¬åŸç†"><a href="#äº‹åŠ¡çš„åŸºæœ¬åŸç†" class="headerlink" title="äº‹åŠ¡çš„åŸºæœ¬åŸç†"></a>äº‹åŠ¡çš„åŸºæœ¬åŸç†</h2><p>ä»¥ MySQL 5.7 ä¸ºä¾‹ï¼š</p>
<p>å½“ MySQL ä½¿ç”¨ InnoDB æ•°æ®åº“å¼•æ“çš„æ—¶å€™ï¼Œæ•°æ®åº“æ˜¯å¯¹äº‹åŠ¡æœ‰æ”¯æŒçš„ã€‚è€Œäº‹åŠ¡æœ€ä¸»è¦çš„ä½œç”¨æ˜¯ä¿è¯æ•°æ® ACID çš„ç‰¹æ€§ï¼Œå³åŸå­æ€§ï¼ˆ<strong>A</strong>tomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆ<strong>C</strong>onsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆ<strong>I</strong>solationï¼‰ã€æŒä¹…æ€§ï¼ˆ<strong>D</strong>urabilityï¼‰ã€‚åˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šï¼š</p>
<ul>
<li><strong>åŸå­æ€§</strong>ï¼š æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ï¼ˆTransactionï¼‰ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œè€Œä¸ä¼šæœ‰ä¸­é—´æŸä¸ªæ•°æ®å•ç‹¬æ›´æ–°çš„æ“ä½œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸€æ—¦å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›æ»šï¼ˆRollbackï¼‰åˆ°æ­¤æ¬¡äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚</li>
<li><strong>ä¸€è‡´æ€§</strong>ï¼š æ˜¯æŒ‡äº‹åŠ¡æ“ä½œå¼€å§‹ä¹‹å‰ï¼Œå’Œæ“ä½œå¼‚å¸¸å›æ»šä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚æ•°æ®åº“äº‹åŠ¡ commit ä¹‹åï¼Œæ•°æ®ä¹Ÿæ˜¯æŒ‰ç…§æˆ‘ä»¬é¢„æœŸæ­£ç¡®æ‰§è¡Œçš„ã€‚å³è¦é€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚</li>
<li><strong>æŒä¹…æ€§</strong>ï¼š æ˜¯æŒ‡äº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹è¿›è¡Œäº†æŒä¹…åŒ–çš„æ°¸ä¹…ä¿å­˜ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œå…¶å®å°±æ˜¯ä¿å­˜åˆ°ç¡¬ç›˜ã€‚</li>
<li><strong>éš”ç¦»æ€§</strong>ï¼š æ˜¯æŒ‡æ•°æ®åº“å…è®¸å¤šä¸ªè¿æ¥ï¼ŒåŒæ—¶å¹¶å‘å¤šä¸ªäº‹åŠ¡ï¼Œåˆå¯¹åŒä¸€ä¸ªæ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œéš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„ç°è±¡ã€‚è€Œ MySQL é‡Œé¢å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„äº‹åŠ¡çš„å››ç§éš”ç¦»çº§åˆ«ï¼Œå³è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚</li>
</ul>
<h3 id="MySQL-äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"><a href="#MySQL-äº‹åŠ¡çš„éš”ç¦»çº§åˆ«" class="headerlink" title="MySQL äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"></a>MySQL äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</h3><ul>
<li><p><strong>Read Uncommittedï¼ˆè¯»å–æœªæäº¤å†…å®¹ï¼‰</strong>ï¼šæ­¤éš”ç¦»çº§åˆ«ï¼Œè¡¨ç¤ºæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æœã€‚ä¸åŒäº‹åŠ¡ä¹‹é—´è¯»å–åˆ°å…¶ä»–äº‹åŠ¡ä¸­æœªæäº¤çš„æ•°æ®ï¼Œé€šå¸¸è¿™ç§æƒ…å†µä¹Ÿè¢«ç§°ä¹‹ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ï¼Œä¼šé€ æˆæ•°æ®çš„é€»è¾‘å¤„ç†é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å¤šçº¿ç¨‹é‡Œé¢ç»å¸¸è¯´çš„æ•°æ®ä¸å®‰å…¨äº†ã€‚åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå‡ ä¹å¾ˆå°‘è§åˆ°ä½¿ç”¨çš„ï¼Œå› ä¸ºå®ƒçš„æ€§èƒ½ä¹Ÿä¸æ¯”å…¶ä»–çº§åˆ«è¦å¥½å¤šå°‘ã€‚</p>
</li>
<li><p><strong>Read Committedï¼ˆè¯»å–æäº¤å†…å®¹ï¼‰</strong>ï¼š æ­¤éš”ç¦»çº§åˆ«æ˜¯æŒ‡ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ç›¸åŒçš„ä¸¤æ¬¡æŸ¥è¯¢å¯èƒ½äº§ç”Ÿçš„ç»“æœä¼šä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒæ¬¡æŸ¥è¯¢èƒ½è¯»å–åˆ°å…¶ä»–äº‹åŠ¡å·²ç»æäº¤çš„æœ€æ–°æ•°æ®ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä¸å¯é‡å¤è¯»ï¼ˆUnrepeatable Readï¼‰çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚å› ä¸ºåŒä¸€äº‹åŠ¡çš„å…¶ä»–å®ä¾‹åœ¨è¯¥å®ä¾‹å¤„ç†æœŸé—´ï¼Œå¯èƒ½ä¼šå¯¹å…¶ä»–äº‹åŠ¡è¿›è¡Œæ–°çš„ commitï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­çš„åŒä¸€ select ä¸Šï¼Œå¤šæ¬¡æ‰§è¡Œå¯èƒ½è¿”å›ä¸åŒç»“æœã€‚è¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†ä¸æ˜¯ MySQL é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼‰ã€‚</p>
</li>
<li><p><strong>Repeatable Readï¼ˆå¯é‡è¯»ï¼‰</strong>ï¼š è¿™æ˜¯ MySQL çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒç¡®ä¿åŒä¸€ä¸ªäº‹åŠ¡å¤šæ¬¡æŸ¥è¯¢ç›¸åŒçš„æ•°æ®ï¼Œèƒ½è¯»åˆ°ç›¸åŒçš„æ•°æ®ã€‚å³ä½¿å¤šä¸ªäº‹åŠ¡çš„ä¿®æ”¹å·²ç» commitï¼Œæœ¬äº‹åŠ¡å¦‚æœæ²¡æœ‰ç»“æŸï¼Œæ°¸è¿œè¯»åˆ°çš„æ˜¯ç›¸åŒæ•°æ®ï¼Œè¦æ³¨æ„å®ƒä¸Read Committed çš„éš”ç¦»çº§åˆ«çš„åŒºåˆ«ï¼Œæ˜¯æ­£å¥½ç›¸åçš„ã€‚è¿™ä¼šå¯¼è‡´å¦ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¹»è¯» ï¼ˆPhantom Readï¼‰ï¼Œå³è¯»åˆ°çš„æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ã€‚è¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ï¼Œä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šç”¨å·¥å…·æ‰“å¼€ä¸€ä¸ªæ•°æ®åº“çš„ DB è¿æ¥ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</strong></p>
<p><img src="http://image.leonote.cn/20201118125513.png" alt=""></p>
<p>æŸ¥çœ‹ä¸€ä¸‹æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚</p>
<p><img src="http://image.leonote.cn/20201118125737.png" alt=""></p>
<p>ç„¶åå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ user_info çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨ user_info è¡¨é‡Œé¢æ’å…¥äº†ä¸‰æ¡æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201118130241.png" alt=""></p>
<p><strong>ç¬¬äºŒæ­¥ï¼šæˆ‘ä»¬æ‰“å¼€å¦å¤–ä¸€ä¸ªç›¸åŒæ•°æ®åº“çš„ DB è¿æ¥ï¼Œåˆ é™¤ä¸€æ¡æ•°æ®ï¼ŒSQL å¦‚ä¸‹ï¼š</strong></p>
<p><img src="http://image.leonote.cn/20201118130356.png" alt=""></p>
<p>å½“åˆ é™¤æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯ç¬¬ä¸‰ä¸ªè¿æ¥ï¼Œçœ‹ä¸€ä¸‹æ•°æ®åº“é‡Œé¢ç¡®å®å°‘äº†ä¸€æ¡ ID=1 çš„æ•°æ®ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†è¿”å›ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œ select * from user_infoï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŸ¥åˆ°çš„è¿˜æ˜¯ä¸‰æ¡æ•°æ®ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„å¯é‡å¤è¯»ã€‚</p>
<p><img src="http://image.leonote.cn/20201118130515.png" alt=""></p>
</li>
<li><p><strong>Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰</strong>ï¼šè¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒä¿è¯äº†æ¯ä¸ªäº‹åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå³å¼ºåˆ¶äº‹åŠ¡æ’åºï¼Œæ‰€æœ‰äº‹åŠ¡ä¹‹é—´ä¸å¯èƒ½äº§ç”Ÿå†²çªï¼Œä»è€Œè§£å†³å¹»è¯»é—®é¢˜ã€‚å¦‚æœé…ç½®åœ¨è¿™ä¸ªçº§åˆ«çš„äº‹åŠ¡ï¼Œå¤„ç†æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå¹¶å‘æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡çš„ db è¿æ¥è¶…æ—¶ç°è±¡å’Œé”ç«äº‰ï¼Œä»è€Œé™ä½äº†æ•°æ®å¤„ç†çš„ååé‡ã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªæ€§èƒ½æ¯”è¾ƒä½ï¼Œæ‰€ä»¥é™¤äº†æŸäº›è´¢åŠ¡ç³»ç»Ÿä¹‹å¤–ï¼Œç”¨çš„äººä¸æ˜¯ç‰¹åˆ«å¤šã€‚</p>
</li>
</ul>
<h3 id="MySQL-äº‹åŠ¡ä¸è¿æ¥çš„å…³ç³»"><a href="#MySQL-äº‹åŠ¡ä¸è¿æ¥çš„å…³ç³»" class="headerlink" title="MySQL äº‹åŠ¡ä¸è¿æ¥çš„å…³ç³»"></a>MySQL äº‹åŠ¡ä¸è¿æ¥çš„å…³ç³»</h3><p>è¦ææ¸…æ¥šäº‹åŠ¡å’Œè¿æ¥æ± çš„å…³ç³»ï¼Œå¿…é¡»è¦å…ˆçŸ¥é“äºŒè€…å­˜åœ¨çš„å‰ææ¡ä»¶ã€‚</p>
<ol>
<li><p>äº‹åŠ¡å¿…é¡»åœ¨åŒä¸€ä¸ªè¿æ¥é‡Œé¢çš„ï¼Œç¦»å¼€è¿æ¥æ²¡æœ‰äº‹åŠ¡å¯è¨€ï¼›</p>
</li>
<li><p>MySQL æ•°æ®åº“é»˜è®¤ autocommit=1ï¼Œå³æ¯ä¸€æ¡ SQL æ‰§è¡Œå®Œè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼›</p>
</li>
<li><p>æ•°æ®åº“é‡Œé¢çš„æ¯ä¸€æ¡ SQL æ‰§è¡Œçš„æ—¶å€™å¿…é¡»æœ‰äº‹åŠ¡ç¯å¢ƒï¼›</p>
</li>
<li><p>MySQL åˆ›å»ºè¿æ¥çš„æ—¶å€™é»˜è®¤å¼€å¯äº‹åŠ¡ï¼Œå…³é—­è¿æ¥çš„æ—¶å€™å¦‚æœå­˜åœ¨äº‹åŠ¡æ²¡æœ‰ commit çš„æƒ…å†µï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œ rollback æ“ä½œï¼›</p>
</li>
<li><p>ä¸åŒçš„ connect ä¹‹é—´çš„äº‹åŠ¡æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚</p>
</li>
</ol>
<p>çŸ¥é“äº†è¿™äº›æ¡ä»¶ï¼Œå°±å¯ä»¥ç»§ç»­æ¢ç´¢äºŒè€…çš„å…³ç³»äº†ã€‚åœ¨ connection å½“ä¸­ï¼Œæ“ä½œäº‹åŠ¡çš„æ–¹å¼åªæœ‰ä¸¤ç§ã€‚</p>
<h3 id="MySQL-äº‹åŠ¡çš„ä¸¤ç§æ“ä½œæ–¹å¼"><a href="#MySQL-äº‹åŠ¡çš„ä¸¤ç§æ“ä½œæ–¹å¼" class="headerlink" title="MySQL äº‹åŠ¡çš„ä¸¤ç§æ“ä½œæ–¹å¼"></a>MySQL äº‹åŠ¡çš„ä¸¤ç§æ“ä½œæ–¹å¼</h3><p>ç¬¬ä¸€ç§ï¼šç”¨ BEGINã€ROLLBACKã€COMMIT æ¥å®ç°ã€‚</p>
<ul>
<li><strong>BEGIN</strong> å¼€å§‹ä¸€ä¸ªäº‹åŠ¡</li>
<li><strong>ROLLBACK</strong> äº‹åŠ¡å›æ»š</li>
<li><strong>COMMIT</strong> äº‹åŠ¡ç¡®è®¤</li>
</ul>
<p>ç¬¬äºŒç§ï¼šç›´æ¥ç”¨ SET æ¥æ”¹å˜ MySQL çš„è‡ªåŠ¨æäº¤æ¨¡å¼ã€‚</p>
<ul>
<li><strong>SET AUTOCOMMIT=0</strong> ç¦æ­¢è‡ªåŠ¨æäº¤</li>
<li><strong>SET AUTOCOMMIT=1</strong> å¼€å¯è‡ªåŠ¨æäº¤</li>
</ul>
<h3 id="MySQL-æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#MySQL-æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="MySQL æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°æ˜¯ä»€ä¹ˆï¼Ÿ"></a>MySQL æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>è€Œ<strong>ä»»ä½•æ•°æ®åº“çš„è¿æ¥æ•°éƒ½æ˜¯æœ‰é™çš„</strong>ï¼Œå—å†…å­˜å’Œ CPU é™åˆ¶ã€‚</p>
<ul>
<li>æŸ¥çœ‹æ•°æ®åº“æœ€å¤§è¿æ¥æ•°ï¼š <code>show variables like &#39;max_connections&#39;</code> </li>
<li>æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„è¿æ¥æ•°ï¼š <code>show global status like &#39;Max_used_connections&#39;</code> </li>
<li>è®¾ç½®æ•°æ®åº“æœ€å¤§è¿æ¥æ•°ï¼š <code>set global max_connections=1500</code> </li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<p>å†è§‚å¯Ÿæ•°æ®åº“çš„è¿æ¥æ•°çš„çš„åŒæ—¶ï¼Œéœ€è¦è§‚å¯ŸCPUå’Œå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥æ­¤æ¥åˆ¤æ–­å½“å‰ç³»ç»Ÿæ•°æ®åº“ä¸­serverçš„è¿æ¥æ•°æœ€ä½³å¤§å°æ˜¯å¤šå°‘</p>
<p>MySQL è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯ 8 å°æ—¶</p>
</blockquote>
<h2 id="Spring-é‡Œé¢äº‹åŠ¡çš„é…ç½®æ–¹æ³•"><a href="#Spring-é‡Œé¢äº‹åŠ¡çš„é…ç½®æ–¹æ³•" class="headerlink" title="Spring é‡Œé¢äº‹åŠ¡çš„é…ç½®æ–¹æ³•"></a>Spring é‡Œé¢äº‹åŠ¡çš„é…ç½®æ–¹æ³•</h2><p>Spring Bootä¼šé€šè¿‡ <code>TransactionAutoConfiguration</code> åŠ è½½ @EnableTransactionManagement æ³¨è§£å¸®æˆ‘ä»¬é»˜è®¤å¼€å¯äº‹åŠ¡ï¼Œå…³é”®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201118132724.png" alt=""></p>
<p>Spring é‡Œé¢çš„äº‹åŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œå¸¸è§çš„æ˜¯<strong>ç›´æ¥é€šè¿‡ @Transaction çš„æ–¹å¼è¿›è¡Œé…ç½®</strong>ï¼Œæ‰“å¼€ SimpleJpaRepository æºç ç±»ä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Repository</span><br><span class="line"><span class="meta">@Transactional(readOnly = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; <span class="keyword">implements</span> <span class="title">JpaRepositoryImplementation</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line">...</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">(Iterable&lt;? extends T&gt; entities)</span> </span>&#123;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ SimpleJpaRepository é‡Œé¢çš„æ–¹æ³•éƒ½æ˜¯åªè¯»äº‹åŠ¡ï¼Œè€Œä¸€äº›æ›´æ–°çš„æ–¹æ³•éƒ½æ˜¯è¯»å†™äº‹åŠ¡ã€‚</p>
</blockquote>
<p>æ‰€ä»¥æ¯ä¸ª Repository çš„æ–¹æ³•æ˜¯éƒ½æ˜¯æœ‰äº‹åŠ¡çš„ï¼Œå³ä½¿æ²¡æœ‰ä½¿ç”¨ä»»ä½•åŠ  @Transactional æ³¨è§£çš„æ–¹æ³•ï¼ŒæŒ‰ç…§ä¸Šé¢æ‰€è®²çš„ MySQL çš„ Transactional å¼€å¯åŸç†ï¼Œä¹Ÿä¼šæœ‰æ•°æ®åº“çš„äº‹åŠ¡ã€‚</p>
<h3 id="é»˜è®¤-Transactional-æ³¨è§£å¼äº‹åŠ¡"><a href="#é»˜è®¤-Transactional-æ³¨è§£å¼äº‹åŠ¡" class="headerlink" title="é»˜è®¤ @Transactional æ³¨è§£å¼äº‹åŠ¡"></a>é»˜è®¤ @Transactional æ³¨è§£å¼äº‹åŠ¡</h3><p>æ³¨è§£å¼äº‹åŠ¡åˆç§°<strong>æ˜¾å¼äº‹åŠ¡</strong>ï¼Œéœ€è¦æ‰‹åŠ¨æ˜¾å¼æ³¨è§£å£°æ˜ï¼Œ@Transactional çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Transactional &#123;</span><br><span class="line">   <span class="meta">@AliasFor(&quot;transactionManager&quot;)</span></span><br><span class="line">   <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">   <span class="function">String <span class="title">transactionManager</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="function">Propagation <span class="title">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED</span>;</span><br><span class="line">   <span class="function">Isolation <span class="title">isolation</span><span class="params">()</span> <span class="keyword">default</span> Isolation.DEFAULT</span>;</span><br><span class="line">   <span class="function"><span class="keyword">int</span> <span class="title">timeout</span><span class="params">()</span> <span class="keyword">default</span> TransactionDefinition.TIMEOUT_DEFAULT</span>;</span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">readOnly</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">   Class&lt;? extends Throwable&gt;[] rollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">   String[] rollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">   Class&lt;? extends Throwable&gt;[] noRollbackFor() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">   String[] noRollbackForClassName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Transactional æ³¨è§£ä¸­å¸¸ç”¨çš„å‚æ•°ï¼š</p>
<table>
<thead>
<tr>
<th><strong>å‚æ•°åç§°</strong></th>
<th><strong>åŠŸèƒ½æè¿°</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>readOnly</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®å½“å‰äº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œè®¾ç½®ä¸ºtrueè¡¨ç¤ºåªè¯»ï¼Œfalseåˆ™è¡¨ç¤ºå¯è¯»å†™ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚ä¾‹å¦‚ï¼š@Transactional(readOnly=true)</td>
</tr>
<tr>
<td><strong>rollbackFor</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š@Transactional(rollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š@Transactional(rollbackFor={RuntimeException.class, Exception.class})</td>
</tr>
<tr>
<td><strong>rollbackForClassName</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š@Transactional(rollbackForClassName=â€RuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š@Transactional(rollbackForClassName={â€œRuntimeExceptionâ€,â€Exceptionâ€})</td>
</tr>
<tr>
<td><strong>noRollbackFor</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š@Transactional(noRollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š@Transactional(noRollbackFor={RuntimeException.class, Exception.class})</td>
</tr>
<tr>
<td><strong>noRollbackForClassName</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›æ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›æ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š@Transactional(noRollbackForClassName=â€RuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š@Transactional(noRollbackForClassName={â€œRuntimeExceptionâ€,â€Exceptionâ€})</td>
</tr>
<tr>
<td><strong>propagation</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€‚ä¾‹å¦‚ï¼š@Transactional(propagation=Propagation.NOT_SUPPORTED,readOnly=true)</td>
</tr>
<tr>
<td><strong>isolation</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®åº•å±‚æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ç”¨äºå¤„ç†å¤šäº‹åŠ¡å¹¶å‘çš„æƒ…å†µï¼Œé€šå¸¸ä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«å³å¯ï¼ŒåŸºæœ¬ä¸éœ€è¦è¿›è¡Œè®¾ç½®</td>
</tr>
<tr>
<td><strong>timeout</strong></td>
<td>è¯¥å±æ€§ç”¨äºè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶ç§’æ•°ï¼Œé»˜è®¤å€¼ä¸º-1è¡¨ç¤ºæ°¸ä¸è¶…æ—¶</td>
</tr>
</tbody></table>
<h4 id="éš”ç¦»çº§åˆ«å’Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶"><a href="#éš”ç¦»çº§åˆ«å’Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶" class="headerlink" title="éš”ç¦»çº§åˆ«å’Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶"></a>éš”ç¦»çº§åˆ«å’Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶</h4><p><strong>éš”ç¦»çº§åˆ« Isolation isolation() default Isolation.DEFAULT</strong>ï¼šé»˜è®¤é‡‡ç”¨æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚å…¶ä¸­ï¼ŒIsolation æ˜¯ä¸ªæšä¸¾å€¼ï¼š</p>
<ul>
<li>READ_UNCOMMITTEDï¼šè¯»å–æœªæäº¤æ•°æ®(ä¼šå‡ºç°è„è¯», ä¸å¯é‡å¤è¯») åŸºæœ¬ä¸ä½¿ç”¨</li>
<li>READ_COMMITTEDï¼šè¯»å–å·²æäº¤æ•°æ®(ä¼šå‡ºç°ä¸å¯é‡å¤è¯»å’Œå¹»è¯»)</li>
<li>REPEATABLE_READï¼šå¯é‡å¤è¯»(ä¼šå‡ºç°å¹»è¯»)</li>
<li>SERIALIZABLEï¼šä¸²è¡ŒåŒ–</li>
</ul>
<blockquote>
<p>MYSQLï¼šé»˜è®¤ä¸º REPEATABLE_READ çº§åˆ«<br>SQLSERVERï¼šé»˜è®¤ä¸º READ_COMMITTED</p>
</blockquote>
<p><strong>propagation</strong>ï¼šä»£è¡¨çš„æ˜¯äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ï¼Œè¿™ä¸ªæ˜¯ Spring äº‹åŠ¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæ˜¯ Spring æ¡†æ¶ç‹¬æœ‰çš„ï¼Œå®ƒå’Œ MySQL æ•°æ®åº“æ²¡æœ‰ä¸€ç‚¹å…³ç³»ã€‚æ‰€è°“äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºæ˜¯æŒ‡åœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼Œåœ¨å¼€å§‹å½“å‰äº‹åŠ¡ä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹å½“å‰çº¿ç¨‹ä¸­æ˜¯å¦æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œæä¾›äº†ä¸ƒä¸ªé€‰é¡¹æ¥æŒ‡å®šå½“å‰äº‹åŠ¡çš„å‘ç”Ÿè¡Œä¸ºã€‚ <code>org.springframework.transaction.annotation.Propagation</code> è¿™ç±»æœ‰ 7 ä¸ªè¡¨ç¤ºä¼ æ’­è¡Œä¸ºçš„æšä¸¾å€¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Propagation</span> </span>&#123;</span><br><span class="line">	REQUIRED(<span class="number">0</span>),</span><br><span class="line">	SUPPORTS(<span class="number">1</span>),</span><br><span class="line">	MANDATORY(<span class="number">2</span>),</span><br><span class="line">	REQUIRES_NEW(<span class="number">3</span>),</span><br><span class="line">	NOT_SUPPORTED(<span class="number">4</span>),</span><br><span class="line">	NEVER(<span class="number">5</span>),</span><br><span class="line">	NESTED(<span class="number">6</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>REQUIREDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚è¿™ä¸ªå€¼æ˜¯é»˜è®¤çš„ã€‚</li>
<li>SUPPORTSï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚</li>
<li>MANDATORYï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>REQUIRES_NEWï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li>
<li>NOT_SUPPORTEDï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚</li>
<li>NEVERï¼šä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>NESTEDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡æ¥è¿è¡Œï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¯¥å–å€¼ç­‰ä»·äº REQUIREDã€‚</li>
</ul>
<p>è®¾ç½®æ–¹æ³•ï¼šé€šè¿‡ä½¿ç”¨ propagation å±æ€§è®¾ç½®ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br></pre></td></tr></table></figure>

<h4 id="Transactional-çš„å±€é™æ€§"><a href="#Transactional-çš„å±€é™æ€§" class="headerlink" title="@Transactional çš„å±€é™æ€§"></a>@Transactional çš„å±€é™æ€§</h4><p>åˆ—ä¸¾ä¸€ä¸ªå½“å‰å¯¹è±¡è°ƒç”¨å¯¹è±¡è‡ªå·±é‡Œé¢çš„æ–¹æ³•ä¸èµ·ä½œç”¨çš„åœºæ™¯ã€‚</p>
<p>åœ¨ UserInfoServiceImpl çš„ save æ–¹æ³•ä¸­è°ƒç”¨äº†å¸¦äº‹åŠ¡çš„ calculate æ–¹æ³•ï¼Œè¯·çœ‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ®UserIdäº§ç”Ÿçš„ä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Transactional(transactionManager = &quot;db2TransactionManager&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfo <span class="title">calculate</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">      UserInfo userInfo = userInfoRepository.findById(userId).get();</span><br><span class="line">      userInfo.setAges(userInfo.getAges()+<span class="number">1</span>);</span><br><span class="line">      <span class="comment">//.....ç­‰ç­‰ä¸€äº›å¤æ‚äº‹åŠ¡å†…çš„æ“ä½œ</span></span><br><span class="line">      userInfo.setTelephone(Instant.now().toString());</span><br><span class="line">      <span class="keyword">return</span> userInfoRepository.saveAndFlush(userInfo);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ­¤æ–¹æ³•è°ƒç”¨è‡ªèº«å¯¹è±¡çš„æ–¹æ³•ï¼Œå°±ä¼šå‘ç°calculateæ–¹æ³•ä¸Šé¢çš„äº‹åŠ¡æ˜¯å¤±æ•ˆçš„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfo <span class="title">save</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.calculate(userId);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“åœ¨ UserInfoServiceImpl ç±»çš„å¤–éƒ¨è°ƒç”¨ save æ–¹æ³•çš„æ—¶å€™ï¼Œæ­¤æ—¶ save æ–¹æ³•é‡Œé¢è°ƒç”¨äº†è‡ªèº«çš„ calculate æ–¹æ³•ï¼Œå°±ä¼šå‘ç° calculate æ–¹æ³•ä¸Šé¢çš„äº‹åŠ¡æ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œè¿™ä¸ªæ˜¯ Spring çš„ä»£ç†æœºåˆ¶çš„é—®é¢˜ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¯ä»¥å¼•å…¥ä¸€ä¸ªç±» TransactionTemplateï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ç”¨æ³•ã€‚</p>
<h4 id="TransactionTemplate-çš„ç”¨æ³•"><a href="#TransactionTemplate-çš„ç”¨æ³•" class="headerlink" title="TransactionTemplate çš„ç”¨æ³•"></a>TransactionTemplate çš„ç”¨æ³•</h4><p>æ­¤ç±»æ˜¯é€šè¿‡ <code>TransactionAutoConfiguration</code> åŠ è½½é…ç½®è¿›å»çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201119170236.png" alt=""></p>
<p>é€šè¿‡æºç å¯ä»¥çœ‹åˆ°æ­¤ç±»æä¾›äº†ä¸€ä¸ªå…³é”® execute æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201119170457.png" alt=""></p>
<p>è¿™é‡Œé¢ä¼šå¸®æˆ‘ä»¬å¤„ç†äº‹åŠ¡å¼€å§‹ã€rollbackã€commit çš„é€»è¾‘ï¼Œæ‰€ä»¥ç”¨çš„æ—¶å€™å°±éå¸¸ç®€å•ï¼ŒæŠŠä¸Šé¢çš„æ–¹æ³•åšå¦‚ä¸‹æ”¹åŠ¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">save</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> transactionTemplate.execute(status -&gt; <span class="keyword">this</span>.calculate(userId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å¤–éƒ¨å†è°ƒç”¨ save æ–¹æ³•çš„æ—¶å€™ï¼Œcalculate å°±ä¼šè¿›å…¥äº‹åŠ¡ç®¡ç†é‡Œé¢å»äº†ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢ä»£ç ä¸­çš„æ–¹æ³•è®¾ç½®äº‹åŠ¡çš„å±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">transactionTemplate = <span class="keyword">new</span> TransactionTemplate(transactionManager);</span><br><span class="line"><span class="comment">//è®¾ç½®éš”ç¦»çº§åˆ«</span></span><br><span class="line">transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_REPEATABLE_READ);</span><br><span class="line"><span class="comment">//è®¾ç½®ä¼ æ’­æœºåˆ¶</span></span><br><span class="line">transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW);</span><br><span class="line"><span class="comment">//è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">transactionTemplate.setTimeout(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//è®¾ç½®æ˜¯å¦åªè¯»</span></span><br><span class="line">transactionTemplate.setReadOnly(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ ¹æ® transactionTemplate çš„å®ç°åŸç†ï¼Œè‡ªå·±å®ç°ä¸€ä¸ª TransactionHelper</p>
<h4 id="è‡ªå®šä¹‰-TransactionHelper"><a href="#è‡ªå®šä¹‰-TransactionHelper" class="headerlink" title="è‡ªå®šä¹‰ TransactionHelper"></a>è‡ªå®šä¹‰ TransactionHelper</h4><p><strong>ç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ª TransactionHelper ç±»ï¼Œè¿›è¡Œäº‹åŠ¡ç®¡ç†</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ©ç”¨springè¿›è¡Œç®¡ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionHelper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ©ç”¨spring çš„æœºåˆ¶å’Œjdk8çš„functionæœºåˆ¶å®ç°äº‹åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span> <span class="comment">//å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µï¼ŒæŒ‡å®šæ˜ç¡®çš„å›æ»šå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T, R&gt; <span class="function">R <span class="title">transactional</span><span class="params">(Function&lt;T, R&gt; function, T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> function.apply(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥ï¼šç›´æ¥åœ¨ service ä¸­å°±å¯ä»¥ä½¿ç”¨äº†</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TransactionHelper transactionHelper;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è°ƒç”¨å¤–éƒ¨çš„transactionHelperç±»ï¼Œåˆ©ç”¨transactionHelperæ–¹æ³•ä¸Šé¢çš„<span class="doctag">@Transaction</span>æ³¨è§£ä½¿äº‹åŠ¡ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">save</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> transactionHelper.transactional((uid)-&gt;<span class="keyword">this</span>.calculate(uid), userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="éšå¼äº‹åŠ¡-AspectJ-äº‹åŠ¡é…ç½®"><a href="#éšå¼äº‹åŠ¡-AspectJ-äº‹åŠ¡é…ç½®" class="headerlink" title="éšå¼äº‹åŠ¡ / AspectJ äº‹åŠ¡é…ç½®"></a>éšå¼äº‹åŠ¡ / AspectJ äº‹åŠ¡é…ç½®</h3><p>åªéœ€è¦åœ¨é¡¹ç›®ä¸­æ–°å¢ä¸€ä¸ªç±» AspectjTransactionConfig å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectjTransactionConfig</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String transactionExecution = <span class="string">&quot;execution (* com.example..service.*.*(..))&quot;</span>;<span class="comment">//æŒ‡å®šæ‹¦æˆªå™¨ä½œç”¨çš„åŒ…è·¯å¾„</span></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DefaultPointcutAdvisor <span class="title">defaultPointcutAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//æŒ‡å®šä¸€èˆ¬è¦æ‹¦æˆªå“ªäº›ç±»</span></span><br><span class="line">      AspectJExpressionPointcut pointcut = <span class="keyword">new</span> AspectJExpressionPointcut();</span><br><span class="line">      pointcut.setExpression(transactionExecution);</span><br><span class="line">      <span class="comment">//é…ç½®advisor</span></span><br><span class="line">      DefaultPointcutAdvisor advisor = <span class="keyword">new</span> DefaultPointcutAdvisor();</span><br><span class="line">      advisor.setPointcut(pointcut);</span><br><span class="line">      <span class="comment">//æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼ï¼ŒæŒ‡å®šä¸Šé¢çš„åŒ…è·¯å¾„é‡Œé¢çš„æ–¹æ³•çš„äº‹åŠ¡ç­–ç•¥</span></span><br><span class="line">      Properties attributes = <span class="keyword">new</span> Properties();</span><br><span class="line">      attributes.setProperty(<span class="string">&quot;get*&quot;</span>, <span class="string">&quot;PROPAGATION_REQUIRED,-Exception&quot;</span>);</span><br><span class="line">      attributes.setProperty(<span class="string">&quot;add*&quot;</span>, <span class="string">&quot;PROPAGATION_REQUIRED,-Exception&quot;</span>);</span><br><span class="line">      attributes.setProperty(<span class="string">&quot;save*&quot;</span>, <span class="string">&quot;PROPAGATION_REQUIRED,-Exception&quot;</span>);</span><br><span class="line">      attributes.setProperty(<span class="string">&quot;update*&quot;</span>, <span class="string">&quot;PROPAGATION_REQUIRED,-Exception&quot;</span>);</span><br><span class="line">      attributes.setProperty(<span class="string">&quot;delete*&quot;</span>, <span class="string">&quot;PROPAGATION_REQUIRED,-Exception&quot;</span>);</span><br><span class="line">      <span class="comment">//åˆ›å»ºInterceptor</span></span><br><span class="line">      TransactionInterceptor txAdvice = <span class="keyword">new</span> TransactionInterceptor(transactionManager, attributes);</span><br><span class="line">      advisor.setAdvice(txAdvice);</span><br><span class="line">      <span class="keyword">return</span> advisor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹å¼ï¼Œåªè¦ç¬¦åˆæˆ‘ä»¬ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾è§„åˆ™çš„ service æ–¹æ³•ï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ äº‹åŠ¡äº†ï¼›å¦‚æœæˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šæ·»åŠ  @Transactionalï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸Šé¢çš„é»˜è®¤è§„åˆ™ã€‚</p>
<p>ä¸è¿‡è¿™ç§æ–¹æ³•è¿‘ä¸¤å¹´ä½¿ç”¨çš„å›¢é˜Ÿè¶Šæ¥è¶Šå°‘äº†ï¼Œå› ä¸ºæ³¨è§£çš„æ–¹å¼å…¶å®å¾ˆæ–¹ä¾¿ï¼Œå¹¶ä¸”æ³¨è§£ @Transactional çš„æ–¹å¼æ›´å®¹æ˜“è®©äººç†è§£ï¼Œä»£ç ä¹Ÿæ›´ç®€å•ã€‚</p>
<h2 id="é€šè¿‡æ—¥å¿—åˆ†æé…ç½®æ–¹æ³•çš„è¿‡ç¨‹"><a href="#é€šè¿‡æ—¥å¿—åˆ†æé…ç½®æ–¹æ³•çš„è¿‡ç¨‹" class="headerlink" title="é€šè¿‡æ—¥å¿—åˆ†æé…ç½®æ–¹æ³•çš„è¿‡ç¨‹"></a>é€šè¿‡æ—¥å¿—åˆ†æé…ç½®æ–¹æ³•çš„è¿‡ç¨‹</h2><p>ä¸€ä¸ªæ–¹æ³•ç»å†çš„ SQL å’Œè¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨æ•°æ®è¿æ¥ä¸­åŠ ä¸Š logger=Slf4JLogger&amp;profileSQL=trueï¼Œç”¨æ¥æ˜¾ç¤º MySQL æ‰§è¡Œçš„ SQL æ—¥å¿—</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">##########datasource1 é‡‡ç”¨Mysqlæ•°æ®åº“</span></span><br><span class="line"><span class="meta">spring.datasource1.url</span>=<span class="string">jdbc:mysql://localhost:3306/test?logger=Slf4JLogger&amp;profileSQL=true</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥ï¼Œæ‰“å¼€ Spring çš„äº‹åŠ¡å¤„ç†æ—¥å¿—ï¼Œç”¨æ¥è§‚å¯Ÿäº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹</strong></p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Log Transactions Details</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.orm.jpa</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.transaction</span>=<span class="string">TRACE</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.engine.transaction.internal.TransactionImpl</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="comment"># ç›‘æ§è¿æ¥çš„æƒ…å†µ</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.resource.jdbc</span>=<span class="string">trace</span></span><br><span class="line"><span class="meta">logging.level.com.zaxxer.hikari</span>=<span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼Œæ‰§è¡Œä¸€ä¸ª saveOrUpdate çš„æ“ä½œ</strong>ï¼Œè¯·çœ‹è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20201119172605.png" alt=""></p>
<p>é€šè¿‡æ—¥å¿—å¯ä»¥å‘ç°ï¼Œæ‰§è¡Œä¸€ä¸ª saveUserInfo çš„åŠ¨ä½œï¼Œç”±äºåœ¨å…¶ä¸­é…ç½®äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ° JpaTransactionManager è·å¾—äº‹åŠ¡çš„è¿‡ç¨‹ï¼Œå›¾ä¸Šé»„è‰²çš„éƒ¨åˆ†æ˜¯åŒä¸€ä¸ªè¿æ¥é‡Œé¢æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œå…¶æ‰§è¡Œçš„æ•´ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>get connectionï¼šä»äº‹åŠ¡ç®¡ç†é‡Œé¢ï¼Œè·å¾—è¿æ¥å°± begin å¼€å§‹äº‹åŠ¡äº†ã€‚æ²¡æœ‰çœ‹åˆ°æ˜¾ç¤ºçš„ begin çš„ SQLï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ–­å®šå®ƒåˆ©ç”¨äº† MySQL çš„ connection åˆå§‹åŒ–äº‹åŠ¡çš„ç‰¹æ€§ã€‚</p>
</li>
<li><p>set autocommit=0ï¼šå…³é—­è‡ªåŠ¨æäº¤æ¨¡å¼ï¼Œè¿™ä¸ªæ—¶å€™å¿…é¡»è¦åœ¨ç¨‹åºé‡Œé¢ commit æˆ–è€… rollbackã€‚</p>
</li>
<li><p>select user_infoï¼šçœ‹çœ‹ user_info æ•°æ®åº“é‡Œé¢æ˜¯å¦å­˜åœ¨æˆ‘ä»¬è¦ä¿å­˜çš„æ•°æ®ã€‚</p>
</li>
<li><p>update user_infoï¼šå‘ç°æ•°æ®åº“é‡Œé¢å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œã€‚</p>
</li>
<li><p>commitï¼šæ‰§è¡Œæäº¤äº‹åŠ¡ã€‚</p>
</li>
<li><p>set autocommit=1ï¼šäº‹åŠ¡æ‰§è¡Œå®Œï¼Œæ”¹å› autocommit çš„é»˜è®¤å€¼ï¼Œæ¯æ¡ SQL æ˜¯ç‹¬ç«‹çš„äº‹åŠ¡ã€‚</p>
</li>
</ol>
<p>è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œå¦‚æœé€šè¿‡ä¸‹é¢è¿™è¡Œä»£ç ï¼Œæ”¹å˜é»˜è®¤éš”ç¦»çº§åˆ«çš„è¯ï¼Œå†è§‚å¯Ÿæ—¥å¿—ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span></span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn/20201119172832.png" alt=""></p>
<p>è€Œåœ¨äº‹åŠ¡ç»“æŸä¹‹åï¼Œå®ƒè¿˜ä¼šè¿˜åŸæ­¤é“¾æ¥çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œåˆå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20201119173301.png" alt=""></p>
<h2 id="Spring-äº‹åŠ¡çš„å®ç°åŸç†"><a href="#Spring-äº‹åŠ¡çš„å®ç°åŸç†" class="headerlink" title="Spring äº‹åŠ¡çš„å®ç°åŸç†"></a>Spring äº‹åŠ¡çš„å®ç°åŸç†</h2><p>@Transactional çš„å·¥ä½œæœºåˆ¶ä¸»è¦æ˜¯åˆ©ç”¨çš„ Spring çš„ AOP åŸç†ï¼Œåœ¨åŠ è½½æ‰€æœ‰ç±»çš„æ—¶å€™ï¼Œå®¹å™¨å°±ä¼šçŸ¥é“æŸäº›ç±»éœ€è¦å¯¹åº”åœ°è¿›è¡Œå“ªäº› Interceptor çš„å¤„ç†ã€‚</p>
<h3 id="Spring-äº‹åŠ¡æºç åˆ†æ"><a href="#Spring-äº‹åŠ¡æºç åˆ†æ" class="headerlink" title="Spring äº‹åŠ¡æºç åˆ†æ"></a>Spring äº‹åŠ¡æºç åˆ†æ</h3><h4 id="äº‹åŠ¡è·å¾—è¿æ¥çš„å…³é”®æ—¶æœº"><a href="#äº‹åŠ¡è·å¾—è¿æ¥çš„å…³é”®æ—¶æœº" class="headerlink" title="äº‹åŠ¡è·å¾—è¿æ¥çš„å…³é”®æ—¶æœº"></a>äº‹åŠ¡è·å¾—è¿æ¥çš„å…³é”®æ—¶æœº</h4><p>åœ¨ <code>TransactionManagementConfigurationSelector</code> é‡Œé¢è®¾ç½®ä¸€ä¸ªæ–­ç‚¹</p>
<p>å°±ä¼šçŸ¥é“ä»£ç†çš„åŠ è½½ç±» <code>ProxyTransactionManagementConfiguration</code> å¯¹äº‹åŠ¡çš„å¤„ç†æœºåˆ¶ã€‚å…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201120105157.png" alt=""></p>
<p>æ‰“å¼€ <code>ProxyTransactionManagementConfiguration</code> çš„è¯ï¼Œå°±ä¼šåŠ è½½ <code>TransactionInterceptor</code> çš„å¤„ç†ç±»ï¼Œå…³é”®æºç å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://image.leonote.cn/20201120110226.png" alt=""></p>
<p>å¦‚æœç»§ç»­åŠ è½½çš„è¯ï¼Œé‡Œé¢å°±ä¼šåŠ è½½å¸¦æœ‰ @Transactional æ³¨è§£çš„ç±»æˆ–è€…æ–¹æ³•ã€‚å…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201120110420.png" alt=""></p>
<p>åŠ è½½æœŸé—´ï¼Œé€šè¿‡ @Transactional æ³¨è§£æ¥ç¡®å®šå“ªäº›æ–¹æ³•éœ€è¦è¿›è¡Œäº‹åŠ¡å¤„ç†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">o.s.orm.jpa.JpaTransactionManager : Creating new transaction with name</span><br></pre></td></tr></table></figure>

<p>è€Œè¿è¡ŒæœŸé—´é€šè¿‡ä¸Šé¢è¿™æ¡æ—¥å¿—ï¼Œå°±å¯ä»¥æ‰¾åˆ° JpaTransactionManager é‡Œé¢é€šè¿‡ getTransaction æ–¹æ³•åˆ›å»ºçš„äº‹åŠ¡ï¼Œç„¶åå†é€šè¿‡ debug æ¨¡å¼çš„ IDEA çº¿ç¨‹æ ˆè¿›è¡Œåˆ†æï¼Œå°±èƒ½çŸ¥é“åˆ›å»ºäº‹åŠ¡çš„æ•´ä¸ªè¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201120110637.png" alt=""></p>
<p>å¦‚ä¸Šå›¾ï¼Œ createTransactionIfNecessary æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºäº‹åŠ¡çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201120110908.png" alt=""></p>
<p>ç»§ç»­å¾€ä¸‹é¢ debug çš„è¯ï¼Œå°±ä¼šæ‰¾åˆ°åˆ›å»ºäº‹åŠ¡çš„å…³é”®ä»£ç ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ <code>AbstractPlatformTransactionManager</code> é‡Œé¢çš„ startTransaction æ–¹æ³•å¼€å¯äº‹åŠ¡ã€‚è¯·çœ‹ä¸‹å›¾ï¼š</p>
<p><img src="http://image.leonote.cn/20201120110958.png" alt=""></p>
<p>ç„¶åç»§ç»­å¾€ä¸‹æ–­ç‚¹è¿›è¡Œåˆ†æï¼Œå½“æ–­ç‚¹èµ°åˆ°æœ€åçš„æ—¶å€™å°±æ˜¯å¼€å¯äº‹åŠ¡çš„æ—¶å€™ï¼Œå¿…é¡»è¦ä»æ•°æ®æºé‡Œé¢è·å¾—è¿æ¥ã€‚</p>
<p>çœ‹ä¸€ä¸‹æ–­ç‚¹çš„æ ˆä¿¡æ¯ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªå…³é”®çš„ debug ç‚¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20201120111143.png" alt=""></p>
<p>å…¶ä¸­ï¼Œ</p>
<p>ç¬¬ä¸€å¤„ï¼šæ˜¯å¤„ç†å¸¦ @Transactional çš„æ³¨è§£çš„æ–¹æ³•ï¼Œåˆ©ç”¨ CGLIB è¿›è¡Œäº‹åŠ¡æ‹¦æˆªå¤„ç†ï¼›</p>
<p>ç¬¬äºŒå¤„ï¼šæ˜¯æ ¹æ® Spring çš„äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Œæ¥åˆ¤æ–­æ˜¯ç”¨ç°æœ‰çš„äº‹åŠ¡ï¼Œè¿˜æ˜¯åˆ›å»ºæ–°çš„äº‹åŠ¡ï¼›</p>
<p>ç¬¬ä¸ƒå¤„ï¼šæ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦ç°æœ‰è¿æ¥ï¼Œå¦‚æœæœ‰ç›´æ¥ç”¨ï¼Œå¦‚æœæ²¡æœ‰å°±ä»ç¬¬å…«å¤„çš„æ•°æ®æºé‡Œé¢çš„è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼Œç¬¬ä¸ƒå¤„çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn/20201120111235.png" alt=""></p>
<h4 id="ä»€ä¹ˆæ—¶é—´é‡Šæ”¾è¿æ¥åˆ°è¿æ¥æ± "><a href="#ä»€ä¹ˆæ—¶é—´é‡Šæ”¾è¿æ¥åˆ°è¿æ¥æ± " class="headerlink" title="ä»€ä¹ˆæ—¶é—´é‡Šæ”¾è¿æ¥åˆ°è¿æ¥æ± "></a>ä»€ä¹ˆæ—¶é—´é‡Šæ”¾è¿æ¥åˆ°è¿æ¥æ± </h4><p>åœ¨ <code>LogicalConnectionManagedImpl</code> çš„ releaseConnection æ–¹æ³•ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20201120111931.png" alt=""></p>
<p>åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œå®ƒä¼šå°†è¿æ¥é‡Šæ”¾åˆ°è¿æ¥æ± é‡Œé¢ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„ saveOrUpdate çš„è¯¦ç»†æ‰§è¡Œæ—¥å¿—ï¼Œå¯ä»¥è§‚å¯Ÿå‡ºæ¥ï¼š</p>
<ul>
<li>äº‹åŠ¡æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºå¼€å¯çš„</li>
<li>æ•°æ®åº“è¿æ¥æ˜¯ä»€ä¹ˆæ—¶æœºå¼€å¯çš„</li>
<li>äº‹åŠ¡æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºå…³é—­çš„</li>
<li>æ•°æ®åº“è¿æ¥æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºé‡Šæ”¾çš„</li>
</ul>
<blockquote>
<p>Spring ä¸­çš„äº‹åŠ¡å’Œè¿æ¥çš„å…³ç³»æ˜¯ï¼Œå¼€å¯äº‹åŠ¡çš„åŒæ—¶è·å– DB è¿æ¥ï¼›äº‹åŠ¡å®Œæˆçš„æ—¶å€™é‡Šæ”¾ DB è¿æ¥ã€‚</p>
</blockquote>
<h2 id="äº‹åŠ¡å’Œè¿æ¥æ± åœ¨-JPA-ä¸­çš„æ³¨æ„äº‹é¡¹"><a href="#äº‹åŠ¡å’Œè¿æ¥æ± åœ¨-JPA-ä¸­çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="äº‹åŠ¡å’Œè¿æ¥æ± åœ¨ JPA ä¸­çš„æ³¨æ„äº‹é¡¹"></a>äº‹åŠ¡å’Œè¿æ¥æ± åœ¨ JPA ä¸­çš„æ³¨æ„äº‹é¡¹</h2><p>æ•°æ®æºçš„è¿æ¥æ± ä¸èƒ½é…ç½®è¿‡å¤§ï¼Œå¦åˆ™è¿æ¥ä¹‹é—´åˆ‡æ¢å°±ä¼šéå¸¸è€—è´¹åº”ç”¨å†…éƒ¨çš„ CPU å’Œå†…å­˜ï¼Œä»è€Œé™ä½åº”ç”¨å¯¹å¤–æä¾› API çš„ååé‡ã€‚</p>
<p>æ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨äº‹åŠ¡çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ä¸ªäº‹é¡¹ï¼š</p>
<ol>
<li><p><strong>äº‹åŠ¡å†…çš„é€»è¾‘ä¸èƒ½æ‰§è¡Œæ—¶é—´å¤ªé•¿</strong>ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´å ç”¨ db è¿æ¥çš„æ—¶é—´è¿‡é•¿ï¼Œä¼šé€ æˆæ•°æ®åº“è¿æ¥ä¸å¤Ÿç”¨çš„æƒ…å†µï¼›</p>
</li>
<li><p><strong>è·¨åº”ç”¨çš„æ“ä½œï¼Œå¦‚ API è°ƒç”¨ç­‰ï¼Œå°½é‡ä¸è¦åœ¨æœ‰äº‹åŠ¡çš„æ–¹æ³•é‡Œé¢è¿›è¡Œï¼›</strong></p>
</li>
<li><p>å¦‚æœåœ¨çœŸå®ä¸šåŠ¡åœºæ™¯ä¸­æœ‰è€—æ—¶çš„æ“ä½œï¼Œä¹Ÿéœ€è¦å¸¦äº‹åŠ¡æ—¶ï¼ˆå¦‚æ‰£æ¬¾ç¯èŠ‚ï¼‰ï¼Œé‚£ä¹ˆè¯·æ³¨æ„å¢åŠ æ•°æ®æºé…ç½®çš„è¿æ¥æ± æ•°ï¼›</p>
</li>
<li><p>é€šè¿‡ MVC çš„åº”ç”¨è¯·æ±‚è¿æ¥æ± æ•°é‡ï¼Œä¹Ÿè¦æ ¹æ®è¿æ¥æ± çš„æ•°é‡å’Œäº‹åŠ¡çš„è€—æ—¶æƒ…å†µçµæ´»é…ç½®ï¼›è€Œ tomcat é»˜è®¤çš„è¯·æ±‚è¿æ¥æ± æ•°é‡æ˜¯ 200 ä¸ªï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ¥å¢åŠ æˆ–è€…å‡å°‘è¯·æ±‚çš„è¿æ¥æ± æ•°é‡ï¼Œä»è€Œå‡å°‘å¹¶å‘å¤„ç†å¯¹äº‹åŠ¡çš„ä¾èµ–ã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa äºŒçº§ç¼“å­˜çš„æ€è€ƒ</title>
    <url>/2021/01/30/SpringDataJpa%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E6%80%9D%E8%80%83-%E7%BB%93%E5%90%88Redis/</url>
    <content><![CDATA[<h1 id="äºŒçº§ç¼“å­˜çš„æ€è€ƒï¼šJPAç»“åˆRedis"><a href="#äºŒçº§ç¼“å­˜çš„æ€è€ƒï¼šJPAç»“åˆRedis" class="headerlink" title="äºŒçº§ç¼“å­˜çš„æ€è€ƒï¼šJPAç»“åˆRedis"></a>äºŒçº§ç¼“å­˜çš„æ€è€ƒï¼šJPAç»“åˆRedis</h1><h2 id="äºŒçº§ç¼“å­˜çš„æ¦‚å¿µ"><a href="#äºŒçº§ç¼“å­˜çš„æ¦‚å¿µ" class="headerlink" title="äºŒçº§ç¼“å­˜çš„æ¦‚å¿µ"></a>äºŒçº§ç¼“å­˜çš„æ¦‚å¿µ</h2><p>ä¸€çº§ç¼“å­˜çš„å®ä½“çš„ç”Ÿå‘½å‘¨æœŸå’Œ PersistenceContext æ˜¯ç›¸åŒçš„ï¼Œå³è½½ä½“ä¸ºåŒä¸€ä¸ª Session æ‰æœ‰æ•ˆï¼›è€Œ Hibernate æå‡ºäº†äºŒçº§ç¼“å­˜çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨ä¸åŒçš„ Session ä¹‹é—´å…±äº«å®ä½“å®ä¾‹ï¼Œè¯´ç™½äº†å°±æ˜¯åœ¨å•ä¸ªåº”ç”¨å†…çš„æ•´ä¸ª application ç”Ÿå‘½å‘¨æœŸä¹‹å†…å…±äº«å®ä½“ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ã€‚</p>
<p>ç”±äº JPA åè®®æœ¬èº«å¹¶æ²¡æœ‰è§„å®šäºŒçº§ç¼“å­˜çš„æ¦‚å¿µï¼Œæ‰€ä»¥è¿™æ˜¯ Hibernate ç‹¬æœ‰çš„ç‰¹æ€§ã€‚åœ¨ Hibernate ä¸­ï¼Œä»æ•°æ®åº“é‡Œé¢æŸ¥è¯¢å®ä½“çš„è¿‡ç¨‹å°±å˜æˆäº†ï¼šç¬¬ä¸€æ­¥å…ˆçœ‹çœ‹ä¸€çº§ç¼“å­˜é‡Œé¢æœ‰æ²¡æœ‰å®ä½“ï¼Œå¦‚æœæ²¡æœ‰å†çœ‹çœ‹äºŒçº§ç¼“å­˜é‡Œé¢æœ‰æ²¡æœ‰ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰å†ä»æ•°æ®åº“é‡Œé¢æŸ¥è¯¢ã€‚</p>
<h3 id="Hibernate-ä¸­äºŒçº§ç¼“å­˜çš„é…ç½®æ–¹æ³•"><a href="#Hibernate-ä¸­äºŒçº§ç¼“å­˜çš„é…ç½®æ–¹æ³•" class="headerlink" title="Hibernate ä¸­äºŒçº§ç¼“å­˜çš„é…ç½®æ–¹æ³•"></a>Hibernate ä¸­äºŒçº§ç¼“å­˜çš„é…ç½®æ–¹æ³•</h3><p>Hibernate ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹äºŒçº§ç¼“å­˜æ˜¯å…³é—­çš„ï¼Œå¦‚æœæƒ³å¼€å¯äºŒçº§ç¼“å­˜éœ€è¦é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªæ­¥éª¤ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ç¬¬ä¸‰æ–¹äºŒçº§ç¼“å­˜çš„å®ç°çš„ jarã€‚</strong></p>
<p>å› ä¸º Hibernate æœ¬èº«å¹¶æ²¡æœ‰å®ç°ç¼“å­˜çš„åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸»è¦ä¾èµ–ç¬¬ä¸‰æ–¹ï¼Œå¦‚ Ehcacheã€jcacheã€redis ç­‰ç¬¬ä¸‰æ–¹åº“ã€‚ä¸‹é¢ä»¥ EhCache ä¸ºä¾‹ï¼Œåˆ©ç”¨ gradle å¼•å…¥ hibernate-ehcache çš„ä¾èµ–ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">implementation <span class="string">&#x27;org.hibernate:hibernate-ehcache:5.2.2.Final&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³ç”¨ jcacheï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile <span class="string">&#x27;org.hibernate:hibernate-jcache:5.2.2.Final&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥ï¼šåœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¼€å¯äºŒçº§ç¼“å­˜ã€‚</strong></p>
<p>äºŒçº§ç¼“å­˜é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨å¦‚ä¸‹æ–¹å¼å¼€å¯äºŒçº§ç¼“å­˜ï¼Œå¹¶ä¸”é…ç½® cache.region.factory_class ä¸ºä¸åŒçš„ç¼“å­˜å®ç°ç±»ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">hibernate.cache.use_second_level_cache</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">hibernate.cache.region.factory_class</span>=<span class="string">org.hibernate.cache.ehcache.EhCacheRegionFactory</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼šåœ¨ç”¨åˆ°äºŒçº§ç¼“å­˜çš„åœ°æ–¹é…ç½® @Cacheable å’Œ @Cache çš„ç­–ç•¥ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.persistence.Cacheable;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Cacheable</span></span><br><span class="line"><span class="meta">@org</span>.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;......&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äºŒçº§ç¼“å­˜çš„æ€è€ƒ"><a href="#äºŒçº§ç¼“å­˜çš„æ€è€ƒ" class="headerlink" title="äºŒçº§ç¼“å­˜çš„æ€è€ƒ"></a>äºŒçº§ç¼“å­˜çš„æ€è€ƒ</h3><p>äºŒçº§ç¼“å­˜ä¸»è¦è§£å†³çš„æ˜¯å•åº”ç”¨åœºæ™¯ä¸‹è·¨ Session ç”Ÿå‘½å‘¨æœŸçš„å®ä½“å…±äº«é—®é¢˜ï¼Œå¯æ˜¯ä¸€å®šè¦é€šè¿‡ Hibernate æ¥åšå—ï¼Ÿç­”æ¡ˆå¹¶ä¸æ˜¯ï¼Œå…¶å®å¯ä»¥é€šè¿‡å„ç§ Cache çš„æ‰‹æ®µæ¥åšï¼Œå› ä¸º Hibernate é‡Œé¢ä¸€çº§ç¼“å­˜çš„å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ï¼Œå¹¶ä¸”ä½¿ç”¨çš„è¯å®ä½“çš„ç”Ÿå‘½å‘¨æœŸä¼šæœ‰å˜åŒ–ï¼ŒæŸ¥è¯¢é—®é¢˜çš„è¿‡ç¨‹è¾ƒä¸ºéº»çƒ¦ã€‚</p>
<p>åŒæ—¶ï¼Œéšç€ç°åœ¨é€æ¸å¾®æœåŠ¡åŒ–ã€åˆ†å¸ƒå¼åŒ–ï¼Œå¦‚ä»Šçš„åº”ç”¨éƒ½ä¸æ˜¯å•æœºåº”ç”¨ï¼Œé‚£ä¹ˆç¼“å­˜ä¹‹é—´å¦‚ä½•å…±äº«å‘¢ï¼Ÿåˆ†å¸ƒå¼ç¼“å­˜åˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿæ¯”å¦‚ä¸€ä¸ªæœºå™¨å˜äº†ï¼Œå¦ä¸€ä¸ªæœºå™¨æ²¡å˜ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿä¼¼ä¹ Hibernate å¹¶æ²¡æœ‰è€ƒè™‘åˆ°è¿™äº›é—®é¢˜ã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜æœ‰ä»€ä¹ˆæ—¶é—´æ•°æ®ä¼šå˜æ›´ã€å˜åŒ–äº†ä¹‹åå¦‚ä½•æ¸…é™¤ç¼“å­˜ï¼Œç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è¦æ€è€ƒçš„ï¼Œæ‰€ä»¥ Hibernate çš„äºŒçº§ç¼“å­˜å¬èµ·æ¥â€œé«˜å¤§ä¸Šâ€ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ç»å¯¹æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚</p>
<p>é‚£ä¹ˆç»è¿‡è¿™ä¸€è¿ä¸²çš„ç–‘é—®ï¼Œå¦‚æœä¸ç”¨ Hibernate çš„äºŒçº§ç¼“å­˜ï¼Œè¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ</p>
<h2 id="åˆ©ç”¨-Redis-è¿›è¡Œç¼“å­˜"><a href="#åˆ©ç”¨-Redis-è¿›è¡Œç¼“å­˜" class="headerlink" title="åˆ©ç”¨ Redis è¿›è¡Œç¼“å­˜"></a>åˆ©ç”¨ Redis è¿›è¡Œç¼“å­˜</h2><p>åœ¨å®é™…å·¥ä½œä¸­ç»å¸¸éœ€è¦ cache çš„å°±æ˜¯ Redisï¼Œé‚£ä¹ˆé€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥çœ‹ä¸‹ Spring Cache ç»“åˆ Redis æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚</p>
<h3 id="Spring-Cache-å’Œ-Redis-ç»“åˆ"><a href="#Spring-Cache-å’Œ-Redis-ç»“åˆ" class="headerlink" title="Spring Cache å’Œ Redis ç»“åˆ"></a>Spring Cache å’Œ Redis ç»“åˆ</h3><p>ç¬¬ä¸€æ­¥ï¼šåœ¨ gradle ä¸­å¼•å…¥ cache å’Œ redis çš„ä¾èµ–ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŸæ¥åªç”¨åˆ°äº†JPA</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-jpa&#x27;</span></span><br><span class="line"><span class="comment">//ä¸ºäº†å¼•å…¥cacheå’Œredisæœºåˆ¶éœ€è¦å¼•å…¥å¦‚ä¸‹ä¸¤ä¸ªjaråŒ…</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-redis&#x27;</span> <span class="comment">//redisçš„ä¾èµ–</span></span><br><span class="line">implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-cache&#x27;</span> <span class="comment">//cache çš„ä¾èµ–</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šåœ¨ application.properties é‡Œé¢å¢åŠ  redis çš„ç›¸å…³é…ç½®ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">sySj6vmYke</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">6000</span></span><br><span class="line"><span class="meta">spring.redis.pool.max-active</span>=<span class="string">8</span></span><br><span class="line"><span class="meta">spring.redis.pool.max-idle</span>=<span class="string">8</span></span><br><span class="line"><span class="meta">spring.redis.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="meta">spring.redis.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ <code>@EnableCaching</code> å¼€å¯ç¼“å­˜ï¼Œå¢åŠ  configuration é…ç½®ç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfiguration</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šåœ¨éœ€è¦ç¼“å­˜çš„åœ°æ–¹æ·»åŠ  <code>@Cacheable</code> æ³¨è§£å³å¯ã€‚ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼ŒæŠŠ <code>@Cacheable</code> æ³¨è§£é…ç½®åœ¨äº† controller æ–¹æ³•ä¸Šï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/info/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@Cacheable(value = &quot;userInfo&quot;, key = &quot;&#123;#root.methodName, #id&#125;&quot;, unless = &quot;#result == null&quot;)</span> <span class="comment">//åˆ©ç”¨é»˜è®¤keyå€¼ç”Ÿæˆè§„åˆ™valueåŠ keyç”Ÿæˆä¸€ä¸ªredisçš„keyå€¼ï¼Œresult==nullçš„æ—¶å€™ä¸è¿›è¡Œç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//ç¬¬äºŒæ¬¡å°±ä¸ä¼šå†æ‰§è¡Œè¿™é‡Œäº†</span></span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.findById(id).get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äº”æ­¥ï¼šå¯åŠ¨é¡¹ç›®ï¼Œè¯·æ±‚ä¸€ä¸‹è¿™ä¸ª API ä¼šå‘ç°ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚è¿‡åï¼Œredis é‡Œé¢å°±æœ‰ä¸€æ¡è®°å½•äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130161543.jpg" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ä¹‹åï¼Œå–æ•°æ®å°±ä¸ä¼šå†è¯·æ±‚æ•°æ®åº“äº†ã€‚é‚£ä¹ˆ redis å·²ç»ç†Ÿæ‚‰äº†ï¼Œé‚£ä¹ˆæ¥çœ‹ä¸€ä¸‹ Spring Cache éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p>
<h3 id="Spring-Cache-ä»‹ç»"><a href="#Spring-Cache-ä»‹ç»" class="headerlink" title="Spring Cache ä»‹ç»"></a>Spring Cache ä»‹ç»</h3><p>Spring 3.1 ä¹‹åå¼•å…¥äº†åŸºäºæ³¨é‡Šï¼ˆannotationï¼‰çš„ç¼“å­˜ï¼ˆcacheï¼‰æŠ€æœ¯ï¼Œå®ƒæœ¬è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç¼“å­˜å®ç°æ–¹æ¡ˆï¼ˆä¾‹å¦‚ EHCache æˆ–è€… Redisï¼‰ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯¹ç¼“å­˜ä½¿ç”¨çš„æŠ½è±¡æ¦‚å¿µï¼Œé€šè¿‡åœ¨æ—¢æœ‰ä»£ç ä¸­æ·»åŠ å°‘é‡å®ƒå®šä¹‰çš„å„ç§ annotationï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°ç¼“å­˜æ–¹æ³•çš„è¿”å›å¯¹è±¡çš„æ•ˆæœã€‚</p>
<p>Spring çš„ç¼“å­˜æŠ€æœ¯è¿˜å…·å¤‡ç›¸å½“çš„çµæ´»æ€§ï¼Œä¸ä»…èƒ½å¤Ÿä½¿ç”¨ SpELï¼ˆSpring Expression Languageï¼‰æ¥å®šä¹‰ç¼“å­˜çš„ key å’Œå„ç§ conditionï¼Œè¿˜æä¾›å¼€ç®±å³ç”¨çš„ç¼“å­˜ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆï¼Œä¹Ÿæ”¯æŒä¸»æµçš„ä¸“ä¸šç¼“å­˜ï¼Œä¾‹å¦‚ Redisï¼ŒEHCache é›†æˆã€‚è€Œ Spring Cache å±äº Spring framework çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ä¸‹é¢å›¾ç‰‡æ‰€ç¤ºçš„è¿™ä¸ªåŒ…é‡Œé¢ã€‚</p>
<p><img src="http://image.leonote.cn//20210130161742.jpg" alt=""></p>
<p><strong>Spring cache é‡Œé¢çš„ä¸»è¦çš„æ³¨è§£</strong></p>
<p><strong>@Cacheable</strong></p>
<p>åº”ç”¨åˆ°è¯»å–æ•°æ®çš„æ–¹æ³•ä¸Šï¼Œå°±æ˜¯å¯ä»¥ç¼“å­˜çš„æ–¹æ³•ï¼Œå¦‚æŸ¥æ‰¾æ–¹æ³•ï¼šå…ˆä»ç¼“å­˜ä¸­è¯»å–ï¼Œå¦‚æœæ²¡æœ‰å†è°ƒç”¨æ–¹æ³•è·å–æ•°æ®ï¼Œç„¶åæŠŠæ•°æ®æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Cacheable &#123;</span><br><span class="line">   <span class="meta">@AliasFor(&quot;cacheNames&quot;)</span></span><br><span class="line">   String[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"><span class="comment">//cacheçš„åå­—ã€‚å¯ä»¥æ ¹æ®åå­—è®¾ç½®ä¸åŒcacheå¤„ç†ç±»ã€‚redisé‡Œé¢å¯ä»¥æ ¹æ®cacheåå­—è®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ã€‚</span></span><br><span class="line">   <span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line">   String[] cacheNames() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"><span class="comment">//ç¼“å­˜çš„keyçš„åå­—ï¼Œæ”¯æŒ SPEL</span></span><br><span class="line">   <span class="function">String <span class="title">key</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"><span class="comment">//keyçš„ç”Ÿæˆç­–ç•¥ï¼Œä¸æŒ‡å®šå¯ä»¥ç”¨å…¨å±€çš„é»˜è®¤çš„ã€‚</span></span><br><span class="line">   <span class="function">String <span class="title">keyGenerator</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//å®¢æˆ·é€‰æ‹©ä¸åŒçš„CacheManager</span></span><br><span class="line">   <span class="function">String <span class="title">cacheManager</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//é…ç½®ä¸åŒçš„cache resolver</span></span><br><span class="line">   <span class="function">String <span class="title">cacheResolver</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶æ‰èƒ½è¢«ç¼“å­˜ï¼Œæ”¯æŒSpELï¼Œå¯ä»¥å»æ‰æ–¹æ³•åã€å‚æ•°</span></span><br><span class="line">   <span class="function">String <span class="title">condition</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"><span class="comment">//æ’é™¤å“ªäº›è¿”å›ç»“æœä¸åŠ å…¥ç¼“å­˜é‡Œé¢å»ï¼Œæ”¯æŒSpELï¼Œå®é™…å·¥ä½œä¸­å¸¸è§çš„æ˜¯result ==nullç­‰</span></span><br><span class="line">   <span class="function">String <span class="title">unless</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//æ˜¯å¦åŒæ­¥è¯»å–ç¼“å­˜ã€æ›´æ–°ç¼“å­˜</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">sync</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯@Cacheable ç›¸å…³çš„ä¾‹å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Cacheable(cacheNames=&quot;book&quot;, condition=&quot;#name.length() &lt; 32&quot;, unless=&quot;#result.notNeedCache&quot;)</span><span class="comment">//åˆ©ç”¨SPELè¡¨è¾¾å¼åªæœ‰å½“nameå‚æ•°é•¿åº¦å°äº32çš„æ—¶å€™å†è¿›è¡Œç¼“å­˜ï¼Œæ’é™¤notNeedCacheçš„å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(String name)</span></span></span><br></pre></td></tr></table></figure>

<p><strong>@CachePut</strong></p>
<p>è°ƒç”¨æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨æŠŠç›¸åº”çš„æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œå®ƒä¸ @Cacheable ä¸åŒçš„æ˜¯æ‰€æœ‰æ³¨è§£çš„æ–¹æ³•æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œä¸€èˆ¬é…ç½®åœ¨ Update å’Œ insert æ–¹æ³•ä¸Šã€‚å…¶æºç é‡Œé¢çš„å­—æ®µå’Œç”¨æ³•åŸºæœ¬ä¸ @Cacheable ç›¸åŒï¼Œåªæ˜¯ä½¿ç”¨åœºæ™¯ä¸ä¸€æ ·ã€‚</p>
<p><strong>@CacheEvict</strong></p>
<p>åˆ é™¤ç¼“å­˜ï¼Œä¸€èˆ¬é…ç½®åœ¨åˆ é™¤æ–¹æ³•ä¸Šé¢ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CacheEvict &#123;</span><br><span class="line"><span class="comment">//ä¸@Cacheableç›¸åŒçš„éƒ¨åˆ†å°±ä¸é‡å¤å™è¿°äº†ã€‚</span></span><br><span class="line">......</span><br><span class="line">	<span class="comment">//æ˜¯å¦åˆ é™¤æ‰€æœ‰çš„å®ä½“å¯¹è±¡</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">allEntries</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">   <span class="comment">//æ˜¯å¦æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œã€‚é»˜è®¤åœ¨æ–¹æ³•è°ƒç”¨æˆåŠŸä¹‹ååˆ é™¤</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">beforeInvocation</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">	<span class="meta">@Caching</span> æ‰€æœ‰Cacheæ³¨è§£çš„ç»„åˆé…ç½®æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</span><br><span class="line">	<span class="keyword">public</span> <span class="meta">@interface</span> Caching &#123;</span><br><span class="line">   Cacheable[] cacheable() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">   CachePut[] put() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">   CacheEvict[] evict() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤–ï¼Œè¿˜æœ‰ @CacheConfig è¡¨ç¤ºå…¨å±€ Cache é…ç½®ï¼›@EnableCachingï¼Œè¡¨ç¤ºæ˜¯å¦å¼€å¯ SpringCache çš„é…ç½®ã€‚</p>
<p><strong>Spring Cache Redis é‡Œé¢ä¸»è¦çš„ç±»</strong></p>
<p><strong>org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration</strong></p>
<p>cache çš„è‡ªåŠ¨è£…é…ç±»ï¼Œæ­¤ç±»è¢«åŠ è½½çš„æ–¹å¼æ˜¯åœ¨ spring bootçš„spring.factories æ–‡ä»¶é‡Œé¢ï¼Œå…¶å…³é”®æºç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CacheManager.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(CacheAspectSupport.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(value = CacheManager.class, name = &quot;cacheResolver&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(CacheProperties.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; CouchbaseDataAutoConfiguration.class, HazelcastAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">      HibernateJpaAutoConfiguration.class, RedisAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123; CacheConfigurationImportSelector.class, CacheManagerEntityManagerFactoryDependsOnPostProcessor.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheAutoConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * &#123;<span class="doctag">@link</span> ImportSelector&#125; to add &#123;<span class="doctag">@link</span> CacheType&#125; configuration classes.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        CacheType[] types = CacheType.values();</span><br><span class="line">        String[] imports = <span class="keyword">new</span> String[types.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; types.length; i++) &#123;</span><br><span class="line">           imports[i] = CacheConfigurations.getConfigurationClass(types[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> imports;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œæ­¤ç±»çš„å…³é”®ä½œç”¨æ˜¯åŠ è½½ Cache çš„ä¾èµ–é…ç½®ï¼Œä»¥åŠåŠ è½½æ‰€æœ‰ CacheType çš„é…ç½®æ–‡ä»¶ï¼Œè€Œ CacheConfigurations é‡Œé¢å®šä¹‰äº†ä¸åŒçš„ Cache å®ç°æ–¹å¼çš„é…ç½®ï¼Œé‡Œé¢åŒ…å«äº† Ehcacheã€Redisã€Jcache çš„å„ç§å®ç°æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130162157.jpg" alt=""></p>
<p><strong>org.springframework.cache.annotation.CachingConfigurerSupport</strong></p>
<p>é€šè¿‡æ­¤ç±»å¯ä»¥è‡ªå®šä¹‰ Cache é‡Œé¢çš„ CacheManagerã€CacheResolverã€KeyGeneratorã€CacheErrorHandlerï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingConfigurerSupport</span> <span class="keyword">implements</span> <span class="title">CachingConfigurer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// cacheçš„managerï¼Œä¸»è¦æ˜¯ç®¡ç†ä¸åŒçš„cacheçš„å®ç°æ–¹å¼ï¼Œå¦‚redisè¿˜æ˜¯ehcacheç­‰</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// cacheçš„ä¸åŒå®ç°è€…çš„æ“ä½œæ–¹æ³•ï¼ŒCacheResolverè§£æå™¨ï¼Œç”¨äºæ ¹æ®å®é™…æƒ…å†µæ¥åŠ¨æ€è§£æä½¿ç”¨å“ªä¸ªCache</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> CacheResolver <span class="title">cacheResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//cacheçš„keyçš„ç”Ÿæˆè§„åˆ™</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//cacheå‘ç”Ÿå¼‚å¸¸çš„å›è°ƒå¤„ç†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä¼šæ‰“å°ä¸ªwarnæ—¥å¿—ï¼Œæ–¹ä¾¿çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> CacheErrorHandler <span class="title">errorHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œæ‰€æœ‰ CacheManager æ˜¯ Spring æä¾›çš„å„ç§ç¼“å­˜æŠ€æœ¯æŠ½è±¡æ¥å£ï¼Œé€šè¿‡å®ƒæ¥ç®¡ç†ï¼ŒSpring framework é‡Œé¢é»˜è®¤å®ç°çš„ CacheManager æœ‰ä¸åŒçš„å®ç°ç±»ï¼Œredis é»˜è®¤åŠ è½½çš„æ˜¯ RedisCacheManagerï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130162327.jpg" alt=""></p>
<p><strong>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</strong></p>
<p>å®ƒæ˜¯åŠ è½½ Cache çš„å®ç°è€…ï¼Œä¹Ÿæ˜¯ redis çš„å®ç°ç±»ï¼Œå…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210130163005.jpg" alt=""></p>
<p>å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå®ƒä¾èµ–æœ¬èº«çš„ Redis çš„è¿æ¥ï¼Œå¹¶ä¸”åŠ è½½äº† RedisCacheManagerï¼›åŒæ—¶å¯ä»¥çœ‹åˆ°å…³äº Cache å’Œ Redis çš„é…ç½®æœ‰å“ªäº›ã€‚</p>
<p>é€šè¿‡ CacheProperties é‡Œé¢ redis çš„é…ç½®ï¼Œå¯ä»¥è®¾ç½®â€œ<strong>key çš„ç»Ÿä¸€å‰ç¼€ã€é»˜è®¤è¿‡æœŸæ—¶é—´ã€æ˜¯å¦ç¼“å­˜ null å€¼ã€æ˜¯å¦ä½¿ç”¨å‰ç¼€</strong>â€è¿™å››ä¸ªé…ç½®ã€‚</p>
<p><img src="http://image.leonote.cn//20210130163115.jpg" alt=""></p>
<h2 id="Spring-Cache-ç»“åˆ-Redis-ä½¿ç”¨çš„æœ€ä½³å®è·µ"><a href="#Spring-Cache-ç»“åˆ-Redis-ä½¿ç”¨çš„æœ€ä½³å®è·µ" class="headerlink" title="Spring Cache ç»“åˆ Redis ä½¿ç”¨çš„æœ€ä½³å®è·µ"></a>Spring Cache ç»“åˆ Redis ä½¿ç”¨çš„æœ€ä½³å®è·µ</h2><p><strong>ä¸åŒ cache çš„ name åœ¨ redis é‡Œé¢é…ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´</strong></p>
<p>é»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰ redis çš„ cache è¿‡æœŸæ—¶é—´æ˜¯ä¸€æ ·çš„ï¼Œå®é™…å·¥ä½œä¸­ä¸€èˆ¬éœ€è¦è‡ªå®šä¹‰ä¸åŒ cache çš„ name çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™é‡Œ cache çš„ name å°±æ˜¯æŒ‡ @Cacheable é‡Œé¢ value å±æ€§å¯¹åº”çš„å€¼ã€‚ä¸»è¦æ­¥éª¤å¦‚ä¸‹ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šè‡ªå®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”¨æ¥æŒ‡å®šä¸åŒçš„ cacheName å¯¹åº”çš„è¿‡æœŸæ—¶é—´ä¸ä¸€æ ·ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.cache.redis&quot;)</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ”¹å–„ä¸€ä¸‹cacheNameçš„æœ€ä½³å®è·µæ–¹æ³•ï¼Œç›®å‰ä¸»è¦ç”¨ä¸åŒçš„cache nameä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥æ‰©å±•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCacheProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Duration&gt; cacheNameConfig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šé€šè¿‡è‡ªå®šä¹‰ç±» MyRedisCacheManagerBuilderCustomizer å®ç° <code>RedisCacheManagerBuilderCustomizer</code> é‡Œé¢çš„ customize æ–¹æ³•ï¼Œç”¨æ¥æŒ‡å®šä¸åŒçš„ name é‡‡ç”¨ä¸åŒçš„ RedisCacheConfigurationï¼Œä»è€Œè¾¾åˆ°è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´çš„æ•ˆæœã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™ä¸ªä¾èµ–spring boot 2.2 ä»¥ä¸Šç‰ˆæœ¬æ‰æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisCacheManagerBuilderCustomizer</span> <span class="keyword">implements</span> <span class="title">RedisCacheManagerBuilderCustomizer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyCacheProperties myCacheProperties;</span><br><span class="line">    <span class="keyword">private</span> RedisCacheConfiguration redisCacheConfiguration;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRedisCacheManagerBuilderCustomizer</span><span class="params">(MyCacheProperties myCacheProperties, RedisCacheConfiguration redisCacheConfiguration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.myCacheProperties = myCacheProperties;</span><br><span class="line">        <span class="keyword">this</span>.redisCacheConfiguration = redisCacheConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ©ç”¨é»˜è®¤é…ç½®çš„åªéœ€è¦åœ¨è¿™é‡ŒåŠ å°±å¯ä»¥äº†</span></span><br><span class="line"><span class="comment">     * spring.cache.cache-names=abc,def,userlist2,user3</span></span><br><span class="line"><span class="comment">     * ä¸‹é¢æ˜¯ä¸åŒçš„cache-nameå¯ä»¥é…ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œyamlä¹Ÿæ”¯æŒï¼Œå¦‚æœä»¥åè¿˜æœ‰å…¶ä»–å±æ€§æ‰©å±•å¯ä»¥æ”¹è¿™é‡Œ</span></span><br><span class="line"><span class="comment">     * spring.cache.redis.cache-name-config.user2=2h</span></span><br><span class="line"><span class="comment">     * spring.cache.redis.cache-name-config.def=2m</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(RedisCacheManager.RedisCacheManagerBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(myCacheProperties.getCacheNameConfig())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, RedisCacheConfiguration&gt; cacheConfigurations = myCacheProperties.getCacheNameConfig().entrySet().stream()</span><br><span class="line">                .collect(Collectors</span><br><span class="line">                        .toMap(e-&gt;e.getKey(),v-&gt;builder</span><br><span class="line">                                .getCacheConfigurationFor(v.getKey())</span><br><span class="line">                                .orElse(RedisCacheConfiguration.defaultCacheConfig().serializeValuesWith(redisCacheConfiguration.getValueSerializationPair()))</span><br><span class="line">                                .entryTtl(v.getValue())));</span><br><span class="line">        builder.withInitialCacheConfigurations(cacheConfigurations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šåœ¨ CacheConfiguration é‡Œé¢æŠŠè‡ªå®šä¹‰çš„ CacheManagerCustomize åŠ è½½è¿›å»å³å¯ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(value = &#123;MyCacheProperties.class,CacheProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;CacheAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯æŒä¸åŒçš„cache nameæœ‰ä¸åŒçš„ç¼“å­˜æ—¶é—´çš„é…ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> myCacheProperties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisCacheConfiguration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;myRedisCacheManagerBuilderCustomizer&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(RedisCacheManagerBuilderCustomizer.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyRedisCacheManagerBuilderCustomizer <span class="title">myRedisCacheManagerBuilderCustomizer</span><span class="params">(MyCacheProperties myCacheProperties, RedisCacheConfiguration redisCacheConfiguration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRedisCacheManagerBuilderCustomizer(myCacheProperties,redisCacheConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šä½¿ç”¨çš„æ—¶å€™éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ application.properties é‡Œé¢åšå¦‚ä¸‹é…ç½®å³å¯ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤çš„è¿‡æœŸæ—¶é—´æ˜¯20åˆ†é’Ÿ</span></span><br><span class="line"><span class="meta">spring.cache.redis.time-to-live</span>=<span class="string">20m</span></span><br><span class="line"><span class="comment"># è®¾ç½®åˆšæ‰çš„ä¾‹å­ @Cacheable(value=&quot;userInfo&quot;)5åˆ†é’Ÿè¿‡æœŸ</span></span><br><span class="line"><span class="meta">spring.cache.redis.cache-name-config.userInfo</span>=<span class="string">5m</span></span><br><span class="line"><span class="comment"># è®¾ç½® roomçš„cache1å°æ—¶è¿‡æœŸ</span></span><br><span class="line"><span class="meta">spring.cache.redis.cache-name-config.room</span>=<span class="string">1h</span></span><br></pre></td></tr></table></figure>

<p><strong>è‡ªå®šä¹‰ KeyGenerator å®ç°ï¼Œredis çš„ key è‡ªå®šä¹‰æ‹¼æ¥è§„åˆ™</strong></p>
<p>å‡å¦‚ä¸å–œæ¬¢é»˜è®¤çš„ cache ç”Ÿæˆçš„ key çš„ string è§„åˆ™ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå®šä¹‰ã€‚åˆ›å»º MyRedisCachingConfigurerSupport é›†æˆ CachingConfigurerSupport å³å¯ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisCachingConfigurerSupport</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getKeyGenerator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¦†ç›–é»˜è®¤çš„redis keyçš„ç”Ÿæˆè§„åˆ™ï¼Œå˜æˆ&quot;æ–¹æ³•å:å‚æ•°:å‚æ•°&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> KeyGenerator <span class="title">getKeyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (target, method, params) -&gt; &#123;</span><br><span class="line">            StringBuilder key = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            key.append(ClassUtils.getQualifiedMethodName(method));</span><br><span class="line">            <span class="keyword">for</span> (Object obc : params) &#123;</span><br><span class="line">                key.append(<span class="string">&quot;:&quot;</span>).append(obc);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> key.toString();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å‘ç”Ÿ cache å’Œ redis çš„æ“ä½œå¼‚å¸¸æ—¶ï¼Œä¸å¸Œæœ›é˜»ç¢ä¸»æµç¨‹ï¼Œæ‰“å°ä¸€ä¸ªå…³é”®æ—¥å¿—å³å¯</p>
<p>åªéœ€è¦åœ¨ MyRedisCachingConfigurerSupport é‡Œé¢å†å®ç°çˆ¶ç±»çš„ errorHandler å³å¯ï¼Œä»£ç å˜æˆäº†å¦‚ä¸‹æ¨¡æ ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRedisCachingConfigurerSupport</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getKeyGenerator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¦†ç›–é»˜è®¤çš„redis keyçš„ç”Ÿæˆè§„åˆ™ï¼Œå˜æˆ&quot;æ–¹æ³•å:å‚æ•°:å‚æ•°&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> KeyGenerator <span class="title">getKeyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (target, method, params) -&gt; &#123;</span><br><span class="line">            StringBuilder key = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            key.append(ClassUtils.getQualifiedMethodName(method));</span><br><span class="line">            <span class="keyword">for</span> (Object obc : params) &#123;</span><br><span class="line">                key.append(<span class="string">&quot;:&quot;</span>).append(obc);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> key.toString();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¦†ç›–é»˜è®¤å¼‚å¸¸å¤„ç†æ–¹æ³•ï¼Œä¸æŠ›å¼‚å¸¸ï¼Œæ”¹æ‰“å°erroræ—¥å¿—</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheErrorHandler <span class="title">errorHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CacheErrorHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCacheGetError</span><span class="params">(RuntimeException exception, Cache cache, Object key)</span> </span>&#123;</span><br><span class="line">                log.error(String.format(<span class="string">&quot;Spring cache GET error:cache=%s,key=%s&quot;</span>, cache, key), exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCachePutError</span><span class="params">(RuntimeException exception, Cache cache, Object key, Object value)</span> </span>&#123;</span><br><span class="line">                log.error(String.format(<span class="string">&quot;Spring cache PUT error:cache=%s,key=%s&quot;</span>, cache, key), exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCacheEvictError</span><span class="params">(RuntimeException exception, Cache cache, Object key)</span> </span>&#123;</span><br><span class="line">                log.error(String.format(<span class="string">&quot;Spring cache EVICT error:cache=%s,key=%s&quot;</span>, cache, key), exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCacheClearError</span><span class="params">(RuntimeException exception, Cache cache)</span> </span>&#123;</span><br><span class="line">                log.error(String.format(<span class="string">&quot;Spring cache CLEAR error:cache=%s&quot;</span>, cache), exception);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ”¹å˜é»˜è®¤çš„ cache é‡Œé¢ redis çš„ value åºåˆ—åŒ–æ–¹å¼</strong></p>
<p>é»˜è®¤æœ‰å¯èƒ½æ˜¯ JDK åºåˆ—åŒ–æ–¹å¼ï¼Œæ‰€ä»¥ä¸€èˆ¬çœ‹ä¸æ‡‚ redis é‡Œé¢çš„å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠåºåˆ—åŒ–æ–¹å¼æ”¹æˆ JSON æ ¼å¼ï¼Œåªéœ€è¦åœ¨ CacheConfiguration é‡Œé¢å¢åŠ é»˜è®¤çš„ RedisCacheConfiguration é…ç½®å³å¯ï¼Œå®Œæ•´çš„ CacheConfiguration å˜æˆå¦‚ä¸‹ä»£ç æ‰€ç¤ºçš„æ ·å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(value = &#123;MyCacheProperties.class,CacheProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123;CacheAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¯æŒä¸åŒçš„cache nameæœ‰ä¸åŒçš„ç¼“å­˜æ—¶é—´çš„é…ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> myCacheProperties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisCacheConfiguration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;myRedisCacheManagerBuilderCustomizer&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(RedisCacheManagerBuilderCustomizer.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyRedisCacheManagerBuilderCustomizer <span class="title">myRedisCacheManagerBuilderCustomizer</span><span class="params">(MyCacheProperties myCacheProperties, RedisCacheConfiguration redisCacheConfiguration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRedisCacheManagerBuilderCustomizer(myCacheProperties,redisCacheConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cacheå¼‚å¸¸ä¸æŠ›å¼‚å¸¸ï¼Œåªæ‰“å°erroræ—¥å¿—</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;myRedisCachingConfigurerSupport&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyRedisCachingConfigurerSupport <span class="title">myRedisCachingConfigurerSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyRedisCachingConfigurerSupport();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¾èµ–é»˜è®¤çš„ObjectMapperï¼Œå®ç°æ™®é€šçš„jsonåºåˆ—åŒ–</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultObjectMapper</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;genericJackson2JsonRedisSerializer&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;genericJackson2JsonRedisSerializer&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GenericJackson2JsonRedisSerializer <span class="title">genericJackson2JsonRedisSerializer</span><span class="params">(ObjectMapper defaultObjectMapper)</span> </span>&#123;</span><br><span class="line">        ObjectMapper objectMapper = defaultObjectMapper.copy();</span><br><span class="line">        objectMapper.registerModule(<span class="keyword">new</span> Hibernate5Module().enable(REPLACE_PERSISTENT_COLLECTIONS)); <span class="comment">//æ”¯æŒJPAçš„å®ä½“çš„jsonçš„åºåˆ—åŒ–</span></span><br><span class="line">        objectMapper.configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.deactivateDefaultTyping(); <span class="comment">//å…³é—­ defaultTypeï¼Œä¸éœ€è¦å…³å¿ƒredisé‡Œé¢æ˜¯å¦ä¸ºå¯¹è±¡çš„ç±»å‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GenericJackson2JsonRedisSerializer(objectMapper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¦†ç›– RedisCacheConfigurationï¼Œåªæ˜¯ä¿®æ”¹serializeValues with jackson</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cacheProperties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &quot;jacksonRedisCacheConfiguration&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheConfiguration <span class="title">jacksonRedisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                  GenericJackson2JsonRedisSerializer genericJackson2JsonRedisSerializer)</span> </span>&#123;</span><br><span class="line">        CacheProperties.Redis redisProperties = cacheProperties.getRedis();</span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration</span><br><span class="line">                .defaultCacheConfig();</span><br><span class="line">        config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(genericJackson2JsonRedisSerializer));<span class="comment">//ä¿®æ”¹çš„å…³é”®æ‰€åœ¨ï¼ŒæŒ‡å®šJackson2JsonRedisSerializerçš„æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = config.prefixCacheNameWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa ä½¿ç”¨ SPEL</title>
    <url>/2021/01/25/SpringDataJpa%E4%BD%BF%E7%94%A8SPEL/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-ä½¿ç”¨-SPEL"><a href="#Spring-Data-Jpa-ä½¿ç”¨-SPEL" class="headerlink" title="Spring Data Jpa ä½¿ç”¨ SPEL"></a>Spring Data Jpa ä½¿ç”¨ SPEL</h1><h2 id="SpEL-åŸºç¡€è¯­æ³•"><a href="#SpEL-åŸºç¡€è¯­æ³•" class="headerlink" title="SpEL åŸºç¡€è¯­æ³•"></a>SpEL åŸºç¡€è¯­æ³•</h2><h3 id="SpEL-å¤§çº²"><a href="#SpEL-å¤§çº²" class="headerlink" title="SpEL å¤§çº²"></a>SpEL å¤§çº²</h3><p>SpEL çš„å…¨ç§°ä¸º Spring Expression Languageï¼Œå³ Spring è¡¨è¾¾å¼è¯­è¨€ï¼Œæ˜¯ Spring framework é‡Œé¢çš„æ ¸å¿ƒé¡¹ç›®ã€‚spring-expression çš„ jar åŒ…çš„å¼•ç”¨å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210125130549.png" alt=""></p>
<p>ä»æ ¸å¿ƒå¼•ç”¨æ¥çœ‹ï¼ŒSpEL è´¯ç©¿æ‰€æœ‰ Spring çš„æ ¸å¿ƒåŠŸèƒ½ã€‚å½“ç„¶äº†ï¼ŒSpEL å¯ä»¥è„±ç¦» Spring å·¥ç¨‹ç‹¬ç«‹ä½¿ç”¨ï¼Œå…¶é¡¹ç›®é‡Œæœ‰ä¸‰ä¸ªé‡è¦çš„æ¥å£ï¼š<code>ExpressionParser</code>ã€<code>Expression</code>ã€<code>EvaluationContext</code>ï¼Œæˆ‘ä»å®˜æ–¹æ–‡æ¡£ä¸­æ‰¾äº†ä¸€å¼ å›¾æ¥è¯´æ˜å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><img src="http://image.leonote.cn/20210125130830.png" alt=""></p>
<h3 id="ExpressionParser"><a href="#ExpressionParser" class="headerlink" title="ExpressionParser"></a>ExpressionParser</h3><p>å®ƒæ˜¯ SpEL çš„å¤„ç†æ¥å£ï¼Œé»˜è®¤å®ç°ç±»æ˜¯ <code>SpelExpressionParser</code>ï¼Œå¯¹å¤–æä¾›çš„åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExpressionParser</span> </span>&#123;</span><br><span class="line">   <span class="comment">// æ ¹æ®ä¼ å…¥çš„è¡¨è¾¾å¼ç”ŸæˆExpression</span></span><br><span class="line">   <span class="function">Expression <span class="title">parseExpression</span><span class="params">(String expressionString)</span> <span class="keyword">throws</span> ParseException</span>;</span><br><span class="line">   <span class="comment">// æ ¹æ®ä¼ å…¥çš„è¡¨è¾¾å¼å’ŒParserContextç”ŸæˆExpressionå¯¹è±¡</span></span><br><span class="line">   <span class="function">Expression <span class="title">parseExpression</span><span class="params">(String expressionString, ParserContext context)</span> <span class="keyword">throws</span> ParseException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„ç›®çš„éƒ½æ˜¯ç”Ÿæˆ Expressionã€‚</p>
<h3 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h3><p>å®ƒé»˜è®¤çš„å®ç°æ˜¯ <code>SpELExpression</code>ï¼Œä¸»è¦å¯¹å¤–æä¾›çš„æ¥å£å°±æ˜¯æ ¹æ®è¡¨è¾¾å¼è·å¾—è¡¨è¾¾å¼å“åº”çš„ç»“æœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210125131058.png" alt=""></p>
<p>è€Œå®ƒçš„è¿™äº›æ–¹æ³•ä¸­ï¼Œæœ€é‡çš„ä¸€ä¸ªå‚æ•°å°±æ˜¯ EvaluationContextã€‚</p>
<h3 id="EvaluationContext"><a href="#EvaluationContext" class="headerlink" title="EvaluationContext"></a>EvaluationContext</h3><p>è¡¨ç¤ºè§£æ String è¡¨è¾¾å¼æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚å¯»æ‰¾ ROOT æ˜¯è°ï¼Œåå°„è§£æçš„ Methodã€Fieldã€Constructor çš„è§£æå™¨å’Œå–å€¼æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ã€‚çœ‹ä¸€ä¸‹å…¶æ¥å£æä¾›çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210125131201.png" alt=""></p>
<h3 id="SpEL-çš„åŸºæœ¬ç”¨æ³•"><a href="#SpEL-çš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="SpEL çš„åŸºæœ¬ç”¨æ³•"></a>SpEL çš„åŸºæœ¬ç”¨æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ExpressionParseræ˜¯æ“ä½œSpELçš„æ€»å…¥å£ï¼Œåˆ›å»ºä¸€ä¸ªæ¥å£ExpressionParserå¯¹åº”çš„å®ä¾‹SpelExpressionParser</span></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line"><span class="comment">//é€šè¿‡ä¸Šé¢çš„parser.parseExpressionæ–¹æ³•è·å¾—ä¸€ä¸ªExpressionçš„å®ä¾‹ï¼Œé‡Œé¢å®ç°çš„å°±æ˜¯newä¸€ä¸ªSpelExpressionå¯¹è±¡ï¼›è€ŒparseExpressionçš„å‚æ•°å°±æ˜¯SpELçš„ä½¿ç”¨é‡ç‚¹ï¼Œå„ç§è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">//1.ç®€å•çš„stringç±»å‹ç”¨&#x27;&#x27; å¼•ç”¨</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">//2.SpELæ”¯æŒå¾ˆå¤šåŠŸèƒ½ç‰¹æ€§ï¼Œå¦‚è°ƒç”¨æ–¹æ³•ã€è®¿é—®å±æ€§ã€è°ƒç”¨æ„é€ å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨Stringå¯¹è±¡é‡Œé¢çš„concatæ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;.concat(&#x27;!&#x27;)&quot;</span>);</span><br><span class="line"><span class="comment">//é€šè¿‡getValueæ–¹æ³•å¯ä»¥å¾—åˆ°ç»è¿‡Expresionè®¡ç®—parseExpressionæ–¹æ³•çš„å­—ç¬¦ä¸²å‚æ•°(ç¬¦åˆSpELè¯­æ³•çš„è¡¨è¾¾å¼)çš„ç»“æœ</span></span><br><span class="line">String message = (String) exp.getValue();</span><br></pre></td></tr></table></figure>

<p>è€Œè®¿é—®å±æ€§å€¼å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//3.invokes getBytes()æ–¹æ³•</span></span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;&#x27;Hello World&#x27;.bytes&quot;</span>);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = (<span class="keyword">byte</span>[]) exp.getValue(); <span class="comment">//å¾—åˆ° byte[]ç±»å‹çš„ç»“æœ</span></span><br></pre></td></tr></table></figure>

<p>SpEL å­—ç¬¦ä¸²è¡¨è¾¾å¼è¿˜æ”¯æŒä½¿ç”¨â€œ.â€è¿›è¡ŒåµŒå¥—å±æ€§ prop1.prop2.prop3 è®¿é—®ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; invokes getBytes().length</span><br><span class="line">Expression exp &#x3D; parser.parseExpression(&quot;&#39;Hello World&#39;.bytes.length&quot;);</span><br><span class="line">int length &#x3D; (Integer) exp.getValue();</span><br></pre></td></tr></table></figure>

<p>è®¿é—®æ„é€ æ–¹æ³•ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;new String(&#x27;hello world&#x27;).toUpperCase()&quot;</span>);</span><br><span class="line">String message = exp.getValue(String.class);</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥é€šè¿‡ EvaluationContext æ¥é…ç½®ä¸€äº›æ ¹å…ƒç´ ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡ä¸€ä¸ªExpressionè¡¨è¾¾å¼æƒ³å–nameå±æ€§å¯¹åº”çš„å€¼</span></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp = parser.parseExpression(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">//é€šè¿‡EvaluationContextè®¾ç½®rootObjectç­‰äºnewçš„UserInfoå¯¹è±¡</span></span><br><span class="line">UserInfo rootUserInfo = UserInfo.builder().name(<span class="string">&quot;jack&quot;</span>).build();</span><br><span class="line">EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext(rootUserInfo);</span><br><span class="line"><span class="comment">//getValueæ ¹æ®è®¾ç½®çš„contextå–å€¼ï¼Œå¯ä»¥å¾—åˆ°jackå­—ç¬¦ä¸²</span></span><br><span class="line">String name = (String) exp.getValue(context);</span><br><span class="line"><span class="comment">//ä¹Ÿå¯ä»¥åˆ©ç”¨SpELçš„è¡¨è¾¾å¼è¿›è¡Œè¿ç®—ï¼Œåˆ¤æ–­åå­—æ˜¯å¦ç­‰äºå­—ç¬¦ä¸²Nikola</span></span><br><span class="line">Expression exp2 = parser.parseExpression(<span class="string">&quot;name == &#x27;Nikola&#x27;&quot;</span>);</span><br><span class="line"><span class="keyword">boolean</span> result2 = exp2.getValue(context, Boolean.class); <span class="comment">// æ ¹æ®UserInfoçš„rootObjectå¾—åˆ°false</span></span><br></pre></td></tr></table></figure>

<p><code>SpelExpressionParser</code> çš„æ„é€ æ–¹æ³•è¿˜æ”¯æŒä¸€äº›é…ç½®ï¼Œä¾‹å¦‚ç»å¸¸é‡åˆ°<strong>ç©ºæŒ‡é’ˆå¼‚å¸¸</strong>å’Œ<strong>ä¸‹æ ‡è¶Šç•Œ</strong>çš„é—®é¢˜ï¼Œå°±å¯ä»¥é€šè¿‡ <code>SpelParserConfiguration</code> é…ç½®ï¼šå½“ Null çš„æ—¶å€™è‡ªåŠ¨åˆå§‹åŒ–ï¼Œå½“ Collection è¶Šç•Œçš„æ—¶å€™è‡ªåŠ¨æ‰©å®¹å¢åŠ ã€‚ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ„é€ ä¸€ä¸ªClassï¼Œæ–¹ä¾¿æµ‹è¯•</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUser</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; address;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¼€å¯è‡ªåŠ¨åˆå§‹åŒ–nullå’Œè‡ªåŠ¨æ‰©å®¹collection</span></span><br><span class="line">SpelParserConfiguration config = <span class="keyword">new</span> SpelParserConfiguration(<span class="keyword">true</span>,<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//åˆ©ç”¨configç”ŸæˆExpressionParserçš„å®ä¾‹</span></span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser(config);</span><br><span class="line"><span class="comment">//é€šè¿‡è¡¨è¾¾å¼å–è¿™ä¸ªç”¨æˆ·çš„ç¬¬ä¸‰ä¸ªåœ°å€</span></span><br><span class="line">Expression expression = parser.parseExpression(<span class="string">&quot;address[3]&quot;</span>);</span><br><span class="line">MyUser demo = <span class="keyword">new</span> MyUser(); </span><br><span class="line"><span class="comment">//newä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰åˆå§‹åŒ–MyUseré‡Œé¢çš„addressï¼Œç”±äºé…ç½®äº†è‡ªåŠ¨åˆå§‹åŒ–å’Œæ‰©å®¹ï¼Œæ‰€ä»¥é€šè¿‡ä¸‹é¢çš„è®¡ç®—ï¼Œæ²¡æœ‰å¾—åˆ°å¼‚å¸¸ï¼Œoå¯ä»¥å¾—åˆ°ä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²</span></span><br><span class="line">Object o = expression.getValue(demo);<span class="comment">// ç©ºå­—ç¬¦ä¸²</span></span><br></pre></td></tr></table></figure>

<h2 id="SpEL-åœ¨-Spring-ä¸­å¸¸è§çš„ä½¿ç”¨åœºæ™¯"><a href="#SpEL-åœ¨-Spring-ä¸­å¸¸è§çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="SpEL åœ¨ Spring ä¸­å¸¸è§çš„ä½¿ç”¨åœºæ™¯"></a>SpEL åœ¨ Spring ä¸­å¸¸è§çš„ä½¿ç”¨åœºæ™¯</h2><p>SpEL åœ¨ @Value é‡Œé¢çš„ç”¨æ³•æœ€å¸¸è§</p>
<h3 id="Value-çš„åº”ç”¨åœºæ™¯"><a href="#Value-çš„åº”ç”¨åœºæ™¯" class="headerlink" title="@Value çš„åº”ç”¨åœºæ™¯"></a>@Value çš„åº”ç”¨åœºæ™¯</h3><p>æ–°å»ºä¸€ä¸ª <code>DemoProperties</code> å¯¹è±¡ï¼Œç”¨ Spring è£…è½½ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸¤ä¸ªè¯­æ³•ç‚¹ï¼šè¿ç®—ç¬¦å’Œ Mapã€Listã€‚</p>
<p><strong>ç¬¬ä¸€ä¸ªè¯­æ³•ï¼šé€šè¿‡ @Value å±•ç¤º SpEL é‡Œé¢æ”¯æŒçš„å„ç§è¿ç®—ç¬¦çš„å†™æ³•ã€‚</strong>å¦‚ä¸‹é¢çš„è¡¨æ ¼æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th align="center">ç±»å‹</th>
<th align="center">æ“ä½œç¬¦</th>
</tr>
</thead>
<tbody><tr>
<td align="center">é€»è¾‘è¿ç®—</td>
<td align="center">+, -, *, /, %, ^, div, mod</td>
</tr>
<tr>
<td align="center">é€»è¾‘æ¯”è¾ƒç¬¦å·</td>
<td align="center">&lt;, &gt;, ==, !=, &lt;=, &gt;=, lt, gt, eq, ne, le, ge</td>
</tr>
<tr>
<td align="center">é€»è¾‘å…³ç³»</td>
<td align="center">and, or, not, &amp;&amp;, ||, !</td>
</tr>
<tr>
<td align="center">ä¸‰å…ƒè¡¨è¾¾å¼</td>
<td align="center">?:</td>
</tr>
<tr>
<td align="center">æ­£åˆ™è¡¨è¾¾å¼</td>
<td align="center">matches</td>
</tr>
</tbody></table>
<p>å±•ç¤ºä¸€ä¸‹ SpEL é‡Œé¢æ”¯æŒçš„å„ç§è¿ç®—ç¬¦</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//é€šè¿‡@Valueä½¿ç”¨SpELçš„åœ°æ–¹ï¼Œä¸€å®šè¦å°†æ­¤å¯¹è±¡äº¤ç”±Springè¿›è¡Œç®¡ç†</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoProperties</span> </span>&#123;</span><br><span class="line">   <span class="comment">// ç¬¬ä¸€éƒ¨åˆ†ï¼šé€»è¾‘è¿ç®—æ“ä½œ</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;19 + 1&#125;&quot;)</span> <span class="comment">// 20</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> add;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;String1 &#x27; + &#x27;string2&#x27;&#125;&quot;)</span> <span class="comment">// &quot;String1 string2&quot;</span></span><br><span class="line">    <span class="keyword">private</span> String addString;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;20 - 1&#125;&quot;)</span> <span class="comment">// 19</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> subtract;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;10 * 2&#125;&quot;)</span> <span class="comment">// 20</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> multiply;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;36 / 2&#125;&quot;)</span> <span class="comment">// 19</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> divide;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;36 div 2&#125;&quot;)</span> <span class="comment">// 18, the same as for / operator</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> divideAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;37 % 10&#125;&quot;)</span> <span class="comment">// 7</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> modulo;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;37 mod 10&#125;&quot;)</span> <span class="comment">// 7, the same as for % operator</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> moduloAlphabetic;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬äºŒéƒ¨åˆ†ï¼šé€»è¾‘æ¯”è¾ƒç¬¦å·</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 == 1&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> equal;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 eq 1&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> equalAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 != 1&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> notEqual;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 ne 1&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> notEqualAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 &lt; 1&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> lessThan;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 lt 1&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> lessThanAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 &lt;= 1&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> lessThanOrEqual;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 le 1&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> lessThanOrEqualAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 &gt; 1&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> greaterThan;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 gt 1&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> greaterThanAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 &gt;= 1&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> greaterThanOrEqual;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;1 ge 1&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> greaterThanOrEqualAlphabetic;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// ç¬¬ä¸‰éƒ¨åˆ†ï¼šé€»è¾‘å…³ç³»è¿ç®—ç¬¦    </span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;250 &gt; 200 &amp;&amp; 200 &lt; 4000&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> and;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;250 &gt; 200 and 200 &lt; 4000&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> andAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;400 &gt; 300 || 150 &lt; 100&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> or;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;400 &gt; 300 or 150 &lt; 100&#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> orAlphabetic;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;!true&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> not;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;not true&#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> notAlphabetic;    </span><br><span class="line">    </span><br><span class="line">   <span class="comment">// ç¬¬å››éƒ¨åˆ†ï¼šä¸‰å…ƒè¡¨è¾¾å¼ &amp; Elvisè¿ç®—ç¬¦</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;2 &gt; 1 ? &#x27;a&#x27; : &#x27;b&#x27;&#125;&quot;)</span> <span class="comment">// &quot;b&quot;</span></span><br><span class="line">    <span class="keyword">private</span> String ternary;</span><br><span class="line">    <span class="comment">//demoProperties å°±æ˜¯é€šè¿‡springåŠ è½½çš„å½“å‰å¯¹è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">//å–springå®¹å™¨é‡Œé¢çš„æŸä¸ªbeançš„å±æ€§ï¼Œ</span></span><br><span class="line">    <span class="comment">//è¿™é‡Œå–çš„æ˜¯demoPropertieså¯¹è±¡é‡Œé¢çš„somePropertyå±æ€§ï¼Œ</span></span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºnullå°±ç›´æ¥ç”¨ï¼Œå¦‚æœä¸ºnullè¿”å›&#x27;default&#x27;å­—ç¬¦ä¸²</span></span><br><span class="line">   <span class="meta">@Value(&quot;#&#123;demoProperties.someProperty != null ? demoProperties.someProperty : &#x27;default&#x27;&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ternaryProperty;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Elvisè¿ç®—ç¬¦æ˜¯ä¸‰å…ƒè¡¨è¾¾å¼ç®€å†™çš„æ–¹å¼ï¼Œå’Œä¸Šé¢ä¸€æ ·çš„ç»“æœã€‚å¦‚æœsomePropertyä¸ºnullåˆ™è¿”å›defaultå€¼ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;demoProperties.someProperty ?: &#x27;default&#x27;&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String elvis;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–ç³»ç»Ÿç¯å¢ƒçš„å±æ€§ï¼Œå¦‚æœç³»ç»Ÿå±æ€§pop3.portå·²å®šä¹‰ä¼šç›´æ¥æ³¨å…¥ï¼Œå¦‚æœæœªå®šä¹‰ï¼Œåˆ™è¿”å›é»˜è®¤å€¼25ã€‚systemPropertiesæ˜¯springå®¹å™¨é‡Œé¢çš„systemPropertieså®ä½“ï¼›</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;systemProperties[&#x27;pop3.port&#x27;] ?: 25&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer port;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿˜å¯ä»¥ç”¨äºå®‰å…¨å¼•ç”¨è¿ç®—ç¬¦ä¸»è¦ä¸ºäº†é¿å…ç©ºæŒ‡é’ˆï¼ŒæºäºGroovyè¯­è¨€ã€‚</span></span><br><span class="line"><span class="comment">     * å¾ˆå¤šæ—¶å€™ä½ å¼•ç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•æˆ–è€…å±æ€§æ—¶éƒ½éœ€è¦åšéç©ºæ ¡éªŒã€‚</span></span><br><span class="line"><span class="comment">     * ä¸ºäº†é¿å…æ­¤ç±»é—®é¢˜ï¼Œä½¿ç”¨å®‰å…¨å¼•ç”¨è¿ç®—ç¬¦åªä¼šè¿”å›nullè€Œä¸æ˜¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//@Value(&quot;#&#123;demoPropertiesx?:someProperty&#125;&quot;) </span></span><br><span class="line">    <span class="comment">// å¦‚æœdemoPropertiesxä¸ä¸ºnullï¼Œåˆ™è¿”å›somePropertyå€¼</span></span><br><span class="line">    <span class="keyword">private</span> String someProperty;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬äº”éƒ¨åˆ†ï¼šæ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒ</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;100&#x27; matches &#x27;\\d+&#x27; &#125;&quot;)</span> <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> validNumericStringResult;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;100fghdjf&#x27; matches &#x27;\\d+&#x27; &#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> invalidNumericStringResult;</span><br><span class="line">    <span class="comment">// åˆ©ç”¨matchesåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿”å›true</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;valid alphabetic string&#x27; matches &#x27;[a-zA-Z\\s]+&#x27; &#125;&quot;)</span> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> validAlphabeticStringResult;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;&#x27;invalid alphabetic string #$1&#x27; matches &#x27;[a-zA-Z\\s]+&#x27; &#125;&quot;)</span> <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> invalidAlphabeticStringResult;</span><br><span class="line">    <span class="comment">//å¦‚æœsomeValueåªæœ‰æ•°å­—</span></span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;demoProperties.someValue matches &#x27;\\d+&#x27;&#125;&quot;)</span> <span class="comment">// true </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> validNumericValue;</span><br><span class="line">    <span class="comment">//æ–°å¢ä¸€ä¸ªç©ºçš„someValueå±æ€§æ–¹ä¾¿æµ‹è¯•</span></span><br><span class="line">    <span class="keyword">private</span> String someValue=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡ <code>@Value</code> æµ‹è¯•å„ç§ SpEL çš„è¡¨è¾¾å¼ï¼Œè¿™å’Œæ”¾åœ¨ <code>parser.parseExpression(&quot;SpEL çš„è¡¨è¾¾å¼å­—ç¬¦ä¸²&quot;);</code> é‡Œé¢çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span></span><br><span class="line"><span class="meta">@Import(TestConfiguration.class)</span></span><br><span class="line"><span class="meta">@ComponentScan(value = &quot;com.example.jpa.demo.config.DemoProperties&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoPropertiesTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="keyword">private</span> DemoProperties demoProperties;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSpel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æµ‹è¯•@Valueé‡Œé¢ä¸åŒè¡¨è¾¾å¼çš„å€¼äº†</span></span><br><span class="line">        System.out.println(demoProperties.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@TestConfiguration</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfig</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> DemoProperties <span class="title">demoProperties</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DemoProperties();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…å¯ä»¥å¯åŠ¨é¡¹ç›®ï¼Œä¹Ÿèƒ½çœ‹åˆ°ç»“æœã€‚</p>
<h3 id="Value-çš„è§£æåŸç†"><a href="#Value-çš„è§£æåŸç†" class="headerlink" title="@Value çš„è§£æåŸç†"></a>@Value çš„è§£æåŸç†</h3><p>Spring é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ä¼šæ ¹æ® @Value çš„æ³¨è§£ï¼Œå»åŠ è½½ SpelExpressionResolver åŠç®—å‡ºæ¥éœ€è¦çš„ StandardEvaluationContextï¼Œç„¶åå†è°ƒç”¨ Expression æ–¹æ³•è¿›è¡Œ getValue æ“ä½œï¼Œå…¶ä¸­è®¡ç®— StandardEvaluationContext çš„å…³é”®æºç å¦‚ä¸‹é¢ä¸¤å¼ å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210125132506.png" alt=""></p>
<p><img src="http://image.leonote.cn/20210125132515.png" alt=""></p>
<p><strong>ç¬¬äºŒä¸ªè¯­æ³•ï¼š@Value å±•ç¤ºäº† SpEL å¯ä»¥ç›´æ¥è¯»å– Map å’Œ List é‡Œé¢çš„å€¼</strong>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡@ComponentåŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç»™å…¶ä¸­çš„Listå’ŒMapé™„ä¸Šå€¼</span></span><br><span class="line"><span class="meta">@Component(&quot;workersHolder&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkersHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; workers = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">private</span> Map&lt;String, Integer&gt; salaryByWorkers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WorkersHolder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                workers.add(<span class="string">&quot;John&quot;</span>);</span><br><span class="line">                workers.add(<span class="string">&quot;Susie&quot;</span>);</span><br><span class="line">                workers.add(<span class="string">&quot;Alex&quot;</span>);</span><br><span class="line">                workers.add(<span class="string">&quot;George&quot;</span>);</span><br><span class="line">                salaryByWorkers.put(<span class="string">&quot;John&quot;</span>, <span class="number">35000</span>);</span><br><span class="line">                salaryByWorkers.put(<span class="string">&quot;Susie&quot;</span>, <span class="number">47000</span>);</span><br><span class="line">                salaryByWorkers.put(<span class="string">&quot;Alex&quot;</span>, <span class="number">12000</span>);</span><br><span class="line">                salaryByWorkers.put(<span class="string">&quot;George&quot;</span>, <span class="number">14000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Getters and setters ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SpELç›´æ¥è¯»å–Mapå’ŒListé‡Œé¢çš„å€¼</span></span><br><span class="line"><span class="meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;John&#x27;]&#125;&quot;)</span> <span class="comment">// 35000</span></span><br><span class="line"><span class="keyword">private</span> Integer johnSalary;</span><br><span class="line"><span class="meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;George&#x27;]&#125;&quot;)</span> <span class="comment">// 14000</span></span><br><span class="line"><span class="keyword">private</span> Integer georgeSalary;</span><br><span class="line"><span class="meta">@Value(&quot;#&#123;workersHolder.salaryByWorkers[&#x27;Susie&#x27;]&#125;&quot;)</span> <span class="comment">// 47000</span></span><br><span class="line"><span class="keyword">private</span> Integer susieSalary;</span><br><span class="line"><span class="meta">@Value(&quot;#&#123;workersHolder.workers[0]&#125;&quot;)</span> <span class="comment">// John</span></span><br><span class="line"><span class="keyword">private</span> String firstWorker;</span><br><span class="line"><span class="meta">@Value(&quot;#&#123;workersHolder.workers[3]&#125;&quot;)</span> <span class="comment">// George</span></span><br><span class="line"><span class="keyword">private</span> String lastWorker;</span><br><span class="line"><span class="meta">@Value(&quot;#&#123;workersHolder.workers.size()&#125;&quot;)</span> <span class="comment">// 4</span></span><br><span class="line"><span class="keyword">private</span> Integer numberOfWorkers;</span><br></pre></td></tr></table></figure>

<h3 id="Value-ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹-ä¸-çš„åŒºåˆ«"><a href="#Value-ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹-ä¸-çš„åŒºåˆ«" class="headerlink" title="@Value ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ # ä¸ $ çš„åŒºåˆ«"></a>@Value ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ # ä¸ $ çš„åŒºåˆ«</h3><p>SpEL è¡¨è¾¾å¼é»˜è®¤ä»¥ # å¼€å§‹ï¼Œä»¥å¤§æ‹¬å·è¿›è¡ŒåŒ…ä½ï¼Œå¦‚ <code>#&#123;expression&#125;</code>ã€‚é»˜è®¤è§„åˆ™åœ¨ ParserContext é‡Œé¢è®¾ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æ˜¯ä¸€èˆ¬å»ºè®®ä¸è¦åŠ¨ã€‚</p>
<p><img src="http://image.leonote.cn/20210126125812.png" alt=""></p>
<p>è¿™é‡Œæ³¨æ„è¦ä¸ Spring ä¸­çš„ Properties è¿›è¡ŒåŒºåˆ«ï¼ŒProperties ç›¸å…³çš„è¡¨è¾¾å¼æ˜¯ä»¥ $ å¼€å§‹çš„å¤§æ‹¬å·è¿›è¡ŒåŒ…ä½çš„ï¼Œå¦‚ <code>$&#123;property.name&#125;</code>ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ @Value çš„å€¼æœ‰ä¸¤ç±»ï¼š</p>
<ul>
<li><p><code>$&#123; property**:**default_value &#125;</code></p>
</li>
<li><p><code>#&#123; obj.property**? :**default_value &#125;</code></p>
</li>
</ul>
<p>ç¬¬ä¸€ä¸ªæ³¨å…¥çš„æ˜¯å¤–éƒ¨å‚æ•°å¯¹åº”çš„ Propertyï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯ SpEL è¡¨è¾¾å¼å¯¹åº”çš„å†…å®¹ã€‚</p>
<p>è€Œ Property placeholders ä¸èƒ½åŒ…å« SpEL è¡¨è¾¾å¼ï¼Œä½†æ˜¯ SpEL è¡¨è¾¾å¼å¯ä»¥åŒ…å« Property çš„å¼•ç”¨ã€‚å¦‚ <code>#&#123;$&#123;someProperty&#125; + 2&#125;</code>ï¼Œå¦‚æœ someProperty=1ï¼Œé‚£ä¹ˆæ•ˆæœå°†æ˜¯ <code>#&#123; 1 + 2&#125;</code>ï¼Œæœ€ç»ˆçš„ç»“æœå°†æ˜¯ 3ã€‚</p>
<h3 id="JPA-ä¸­-Query-çš„åº”ç”¨åœºæ™¯"><a href="#JPA-ä¸­-Query-çš„åº”ç”¨åœºæ™¯" class="headerlink" title="JPA ä¸­ @Query çš„åº”ç”¨åœºæ™¯"></a>JPA ä¸­ @Query çš„åº”ç”¨åœºæ™¯</h3><p>SpEL é™¤äº†èƒ½åœ¨ @Value é‡Œé¢ä½¿ç”¨å¤–ï¼Œä¹Ÿèƒ½åœ¨ @Query é‡Œä½¿ç”¨ï¼Œè€Œåœ¨ @Query é‡Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹ï¼Œå°±æ˜¯å®ƒå¯ä»¥ç”¨æ¥å–æ–¹æ³•çš„å‚æ•°ã€‚</p>
<h4 id="é€šè¿‡-SpEL-å–è¢«-Query-æ³¨è§£çš„æ–¹æ³•å‚æ•°"><a href="#é€šè¿‡-SpEL-å–è¢«-Query-æ³¨è§£çš„æ–¹æ³•å‚æ•°" class="headerlink" title="é€šè¿‡ SpEL å–è¢« @Query æ³¨è§£çš„æ–¹æ³•å‚æ•°"></a>é€šè¿‡ SpEL å–è¢« @Query æ³¨è§£çš„æ–¹æ³•å‚æ•°</h4><p>åœ¨ @Query æ³¨è§£ä¸­ä½¿ç”¨ SpEL çš„ä¸»è¦ç›®çš„æ˜¯å–æ–¹æ³•çš„å‚æ•°ï¼Œä¸»è¦æœ‰ä¸‰ç§ç”¨æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨æ³•ä¸€ï¼šæ ¹æ®ä¸‹æ ‡å–æ–¹æ³•é‡Œé¢çš„å‚æ•°</span></span><br><span class="line"><span class="meta">@Query(&quot;select u from User u where u.age = ?#&#123;[0]&#125;&quot;)</span> </span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findUsersByAge</span><span class="params">(<span class="keyword">int</span> age)</span></span>;</span><br><span class="line"><span class="comment">//ç”¨æ³•äºŒï¼š#customerå–@Param(&quot;customer&quot;)é‡Œé¢çš„å‚æ•°</span></span><br><span class="line"><span class="meta">@Query(&quot;select u from User u where u.firstname = :#&#123;#customer.firstname&#125;&quot;)</span></span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findUsersByCustomersFirstname</span><span class="params">(<span class="meta">@Param(&quot;customer&quot;)</span> Customer customer)</span></span>;</span><br><span class="line"><span class="comment">//ç”¨æ³•ä¸‰ï¼šç”¨JPAçº¦å®šçš„å˜é‡entityNameå–å¾—å½“å‰å®ä½“çš„å®ä½“åå­—</span></span><br><span class="line"><span class="meta">@Query(&quot;from #&#123;#entityName&#125;&quot;)</span></span><br><span class="line"><span class="function">List&lt;UserInfo&gt; <span class="title">findAllByEntityName</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ</p>
<ul>
<li><p>æ–¹æ³•ä¸€å¯ä»¥é€šè¿‡ [0] çš„æ–¹å¼ï¼Œæ ¹æ®ä¸‹æ ‡å–åˆ°æ–¹æ³•çš„å‚æ•°ï¼›</p>
</li>
<li><p>æ–¹æ³•äºŒé€šè¿‡ <code>#customer</code> å¯ä»¥æ ¹æ® @Param æ³¨è§£çš„å‚æ•°çš„åå­—å–åˆ°å‚æ•°ï¼Œå¿…é¡»é€šè¿‡ <code>?#&#123;&#125;</code> å’Œ <code>:#&#123;&#125;</code> æ¥è§¦å‘ SpEL çš„è¡¨è¾¾å¼è¯­æ³•ï¼›</p>
</li>
<li><p>æ–¹æ³•ä¸‰é€šè¿‡ä¸‹è¿°è¯­æ³•ï¼Œå–çº¦å®šçš„å®ä½“çš„åå­—ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#&#123;#entityName&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>å†æ¥çœ‹ä¸€ä¸ªæ›´å¤æ‚ä¸€ç‚¹çš„ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">// JPAçº¦å®šçš„å˜é‡entityNameå–å¾—å½“å‰å®ä½“çš„å®ä½“åå­—</span></span><br><span class="line">   <span class="meta">@Query(&quot;from #&#123;#entityName&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findAllByEntityName</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//ä¸€ä¸ªæŸ¥è¯¢ä¸­æ—¢å¯ä»¥æ”¯æŒSpELä¹Ÿå¯ä»¥æ”¯æŒæ™®é€šçš„:ParamNameçš„æ–¹å¼</span></span><br><span class="line">   <span class="meta">@Modifying</span></span><br><span class="line">   <span class="meta">@Query(&quot;update #&#123;#entityName&#125; u set u.name = :name where u.id =:id&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">updateUserActiveState</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name, <span class="meta">@Param(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//æ¼”ç¤ºSpELæ ¹æ®æ•°ç»„ä¸‹æ ‡å–å‚æ•°ï¼Œå’Œæ ¹æ®æ™®é€šçš„Parmaçš„åå­—:nameå–å‚æ•°</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.lastName like %:#&#123;[0]&#125; and u.name like %:name%&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findContainingEscaped</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//SpELå–Parmaçš„åå­—customeré‡Œé¢çš„å±æ€§</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.name = :#&#123;#customer.name&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findUsersByCustomersFirstname</span><span class="params">(<span class="meta">@Param(&quot;customer&quot;)</span> UserInfo customer)</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//åˆ©ç”¨SpELæ ¹æ®ä¸€ä¸ªå†™æ­»çš„&#x27;jack&#x27;å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.name = ?#&#123;&#x27;jack&#x27;&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findOliverBySpELExpressionWithoutArgumentsWithQuestionmark</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//åŒæ—¶SpELæ”¯æŒç‰¹æ®Šå‡½æ•°escapeå’ŒescapeCharacter</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.lastName like %?#&#123;escape([0])&#125;% escape ?#&#123;escapeCharacter()&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findByNameWithSpelExpression</span><span class="params">(String name)</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// #entityNameå’Œ#[]åŒæ—¶ä½¿ç”¨</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from #&#123;#entityName&#125; u where u.name = ?#&#123;[0]&#125; and u.lastName = ?#&#123;[1]&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findUsersByFirstnameForSpELExpressionWithParameterIndexOnlyWithEntityExpression</span><span class="params">(String name, String lastName)</span></span>;</span><br><span class="line">   <span class="comment">//å¯¹äº native SQLåŒæ ·é€‚ç”¨ï¼Œå¹¶ä¸”åŒæ ·æ”¯æŒå–pageableåˆ†é¡µé‡Œé¢çš„å±æ€§å€¼</span></span><br><span class="line">   <span class="meta">@Query(value = &quot;select * from (&quot; //</span></span><br><span class="line"><span class="meta">         + &quot;select u.*, rownum() as RN from (&quot; //</span></span><br><span class="line"><span class="meta">         + &quot;select * from user_info ORDER BY ucase(firstname)&quot; //</span></span><br><span class="line"><span class="meta">         + &quot;) u&quot; //</span></span><br><span class="line"><span class="meta">         + &quot;) where RN between ?#&#123; #pageable.offset +1 &#125; and ?#&#123;#pageable.offset + #pageable.pageSize&#125;&quot;, //</span></span><br><span class="line"><span class="meta">         countQuery = &quot;select count(u.id) from user_info u&quot;, //</span></span><br><span class="line"><span class="meta">         nativeQuery = true)</span></span><br><span class="line">   <span class="function">Page&lt;UserInfo&gt; <span class="title">findUsersInNativeQueryWithPagination</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ªäººæ¯”è¾ƒæ¨èä½¿ç”¨ @Param çš„æ–¹å¼ï¼Œè¿™æ ·è¯­ä¹‰æ¸…æ™°ï¼Œå‚æ•°æ¢ä½ç½®äº†ä¹Ÿä¸å½±å“æ‰§è¡Œç»“æœã€‚</p>
<p>å…³äºæºç çš„å®ç°ï¼Œå¯ä»¥åˆ° ExpressionBasedStringQuery.class é‡Œé¢ç»§ç»­ç ”ç©¶ï¼Œå…³é”®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210126130209.png" alt=""></p>
<h4 id="spring-security-data-åœ¨-Query-ä¸­çš„ç”¨æ³•"><a href="#spring-security-data-åœ¨-Query-ä¸­çš„ç”¨æ³•" class="headerlink" title="spring-security-data åœ¨ @Query ä¸­çš„ç”¨æ³•"></a>spring-security-data åœ¨ @Query ä¸­çš„ç”¨æ³•</h4><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œæœ‰æ—¶ä¼šç”¨ spring-security åšé‰´æƒï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ<a href="https://spring.io/projects/spring-security#learn">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>å½“æˆ‘ä»¬ç”¨ Spring Security çš„æ—¶å€™ï¼Œå…¶å®å¯ä»¥é¢å¤–å¼•å…¥ jai åŒ… spring-security-dataã€‚å¦‚æœä½¿ç”¨äº† JPA å’Œ Spring Security çš„è¯ï¼Œbuild.gradle æœ€ç»ˆä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼Œè¯·çœ‹ä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;å¼•å…¥spring data jpa</span><br><span class="line">implementation &#39;org.springframework.boot:spring-boot-starter-data-jpa&#39;</span><br><span class="line">&#x2F;&#x2F;é›†æˆspring security</span><br><span class="line">implementation &#39;org.springframework.boot:spring-boot-starter-security&#39;</span><br><span class="line">&#x2F;&#x2F; é›†æˆspring security dataå¯¹JPAçš„æ”¯æŒ</span><br><span class="line">implementation &#39;org.springframework.security:spring-security-data&#39;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾ç»§æ‰¿ Spring Security ä¹‹åï¼ŒSecurityContextHolder é‡Œé¢æ”¾ç½®çš„ Authentication æ˜¯ UserInfoï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤æ—¶Authenticationç±»å‹ä¸ºUserInfo</span></span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></pre></td></tr></table></figure>

<p>è¿™æ · JPA é‡Œé¢çš„ @Query å°±å¯ä»¥å–åˆ°å½“å‰çš„ SecurityContext ä¿¡æ¯ï¼Œå…¶ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®å½“å‰ç”¨æˆ·emailå–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯</span></span><br><span class="line"><span class="meta">@Query(&quot;select u from UserInfo u where u.emailAddress = ?#&#123;principal.email&#125;&quot;)</span></span><br><span class="line"><span class="function">List&lt;UserInfo&gt; <span class="title">findCurrentUserWithCustomQuery</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//å¦‚æœå½“å‰ç”¨æˆ·æ˜¯adminï¼Œå°±è¿”å›æŸä¸šåŠ¡çš„æ‰€æœ‰å¯¹è±¡ï¼›å¦‚æœä¸æ˜¯adminè§’è‰²ï¼Œå°±åªç»™å½“å‰ç”¨æˆ·çš„æŸä¸šåŠ¡æ•°æ®</span></span><br><span class="line"><span class="meta">@Query(&quot;select o from BusinessObject o where o.owner.emailAddress like &quot;+</span></span><br><span class="line"><span class="meta">      &quot;?#&#123;hasRole(&#x27;ROLE_ADMIN&#x27;) ? &#x27;%&#x27; : principal.emailAddress&#125;&quot;)</span></span><br><span class="line"><span class="function">List&lt;BusinessObject&gt; <span class="title">findBusinessObjectsForCurrentUser</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡çœ‹æºç ä¼šå‘ç°ï¼Œspring-security-data å°±å¸®æˆ‘ä»¬åšäº†ä¸€ä»¶äº‹æƒ…ï¼šå®ç° EvaluationContextExtensionï¼Œè®¾ç½®äº† SpEL æ‰€éœ€è¦çš„ rootObject ä¸º SecurityExpressionRootã€‚å…³é”®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210126130511.png" alt=""></p>
<p>ç”±äº SecurityExpressionRoot æ˜¯ rootObjectï¼Œæ ¹æ®ä¸Šé¢ä»‹ç»çš„ SpEL çš„åŸºæœ¬ç”¨æ³•ï¼ŒSecurityExpressionRoot é‡Œé¢çš„å„ç§å±æ€§å’Œæ–¹æ³•éƒ½å¯ä»¥åœ¨ SpEL ä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210126130554.png" alt=""></p>
<p>è¿™å…¶å®ä¹Ÿç»™äº†ä¸€äº›å¯å‘ï¼šå½“éœ€è¦è‡ªåŠ¨ rootObject ç»™ @Query ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œè¿™æ · @Query çš„çµæ´»æ€§ä¼šå¢å¼ºå¾ˆå¤šã€‚</p>
<h3 id="SpEL-åœ¨-Cacheable-ä¸­çš„åº”ç”¨åœºæ™¯"><a href="#SpEL-åœ¨-Cacheable-ä¸­çš„åº”ç”¨åœºæ™¯" class="headerlink" title="SpEL åœ¨ @Cacheable ä¸­çš„åº”ç”¨åœºæ™¯"></a>SpEL åœ¨ @Cacheable ä¸­çš„åº”ç”¨åœºæ™¯</h3><p>åœ¨å®é™…å·¥ä½œä¸­è¿˜æœ‰ä¸€ä¸ªç»å¸¸ç”¨åˆ° SpEL çš„åœºæ™¯ï¼Œå°±æ˜¯åœ¨ Cache çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ Spring Cache çš„ç›¸å…³æ³¨è§£é‡Œé¢ï¼Œå¦‚ <code>@Cacheable</code>ã€<code>@CachePut</code>ã€<code>@CacheEvict</code> ç­‰ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¼“å­˜keyå–å½“å‰æ–¹æ³•åï¼Œåˆ¤æ–­ä¸€ä¸‹åªæœ‰è¿”å›ç»“æœä¸ä¸ºnullæˆ–è€…éemptyæ‰è¿›è¡Œç¼“å­˜</span></span><br><span class="line"><span class="meta">@Cacheable(value = &quot;APP&quot;, key = &quot;#root.methodName&quot;, cacheManager = &quot;redis.cache&quot;, unless = &quot;#result == null || #result.isEmpty()&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Map&lt;String, String&gt;&gt; getAppGlobalSettings() &#123;&#125;</span><br><span class="line"><span class="comment">//evictç­–ç•¥çš„keyæ˜¯å½“å‰å‚æ•°customeré‡Œé¢çš„nameå±æ€§</span></span><br><span class="line"><span class="meta">@Caching(evict = &#123;</span></span><br><span class="line"><span class="meta">@CacheEvict(value=&quot;directory&quot;, key=&quot;#customer.name&quot;) &#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">(Customer customer)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//åœ¨conditioné‡Œé¢ä½¿ç”¨ï¼Œå½“å‚æ•°é‡Œé¢customerçš„nameå±æ€§çš„å€¼ç­‰äºå­—ç¬¦ä¸²Tomæ‰æ”¾åˆ°ç¼“å­˜é‡Œé¢</span></span><br><span class="line"><span class="meta">@CachePut(value=&quot;addresses&quot;, condition=&quot;#customer.name==&#x27;Tom&#x27;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">(Customer customer)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">//ç”¨åœ¨unlessé‡Œé¢ï¼Œåˆ©ç”¨SpELçš„æ¡ä»¶è¡¨è¾¾å¼åˆ¤æ–­ï¼Œæ’é™¤è¿”å›çš„ç»“æœåœ°å€é•¿åº¦å°äº64çš„è¯·æ±‚</span></span><br><span class="line"><span class="meta">@CachePut(value=&quot;addresses&quot;, unless=&quot;#result.length()&lt;64&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAddress</span><span class="params">(Customer customer)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Spring-Cache-ä¸­-SpEL-æ”¯æŒçš„ä¸Šä¸‹æ–‡è¯­æ³•"><a href="#Spring-Cache-ä¸­-SpEL-æ”¯æŒçš„ä¸Šä¸‹æ–‡è¯­æ³•" class="headerlink" title="Spring Cache ä¸­ SpEL æ”¯æŒçš„ä¸Šä¸‹æ–‡è¯­æ³•"></a>Spring Cache ä¸­ SpEL æ”¯æŒçš„ä¸Šä¸‹æ–‡è¯­æ³•</h4><p>Spring Cache æä¾›äº†ä¸€äº›å¯ä½¿ç”¨çš„ SpEL ä¸Šä¸‹æ–‡æ•°æ®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼ˆæ‘˜è‡ª Spring å®˜æ–¹æ–‡æ¡£ï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th align="center">æ”¯æŒçš„å±æ€§</th>
<th align="center">ä½œç”¨åŸŸ</th>
<th align="center">åŠŸèƒ½æè¿°</th>
<th align="center">ä½¿ç”¨æ–¹æ³•</th>
</tr>
</thead>
<tbody><tr>
<td align="center">methodName</td>
<td align="center">root å¯¹è±¡</td>
<td align="center">å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•å</td>
<td align="center">#root.methodName</td>
</tr>
<tr>
<td align="center">method</td>
<td align="center">root å¯¹è±¡</td>
<td align="center">å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•</td>
<td align="center">#root.method.name</td>
</tr>
<tr>
<td align="center">target</td>
<td align="center">root å¯¹è±¡</td>
<td align="center">å½“å‰è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡</td>
<td align="center">#root.target</td>
</tr>
<tr>
<td align="center">targetClass</td>
<td align="center">root å¯¹è±¡</td>
<td align="center">å½“å‰è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡ç±»</td>
<td align="center">#root.targetClass</td>
</tr>
<tr>
<td align="center">args</td>
<td align="center">root å¯¹è±¡</td>
<td align="center">å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨</td>
<td align="center">#root.args[0]</td>
</tr>
<tr>
<td align="center">caches</td>
<td align="center">root å¯¹è±¡</td>
<td align="center">å½“å‰æ–¹æ³•è°ƒç”¨ä½¿ç”¨çš„ç¼“å­˜åˆ—è¡¨ï¼ˆå¦‚@Cacheable(value={â€œcache1â€, â€œcache2â€})ï¼‰ï¼Œåˆ™æœ‰ä¸¤ä¸ª cache</td>
<td align="center">#root.caches[0].name</td>
</tr>
<tr>
<td align="center">argument name</td>
<td align="center">æ‰§è¡Œä¸Šä¸‹æ–‡</td>
<td align="center">å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°ï¼Œå¦‚ findById(Long id)ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ #id æ‹¿åˆ°å‚æ•°</td>
<td align="center">#user.id è¡¨ç¤ºå‚æ•° user é‡Œé¢çš„ id</td>
</tr>
<tr>
<td align="center">result</td>
<td align="center">æ‰§è¡Œä¸Šä¸‹æ–‡</td>
<td align="center">æ–¹æ³•æ‰§è¡Œåçš„è¿”å›å€¼ï¼ˆä»…å½“æ–¹æ³•æ‰§è¡Œä¹‹åçš„åˆ¤æ–­æœ‰æ•ˆï¼Œå¦‚â€˜unlessâ€™ï¼Œâ€™cache evictâ€™çš„ beforeInvocation=falseï¼‰</td>
<td align="center">#result</td>
</tr>
</tbody></table>
<p>ä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ Spring Cache ä¸­ SpEL çš„ EvaluationContext åŠ è½½æ–¹å¼ï¼Œå…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210126131110.png" alt=""></p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa åœ¨CompletableFutureå¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPA</title>
    <url>/2021/01/09/SpringDataJpa%E5%9C%A8CompletableFuture%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8JPA/</url>
    <content><![CDATA[<h1 id="åœ¨-CompletableFuture-å¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPA"><a href="#åœ¨-CompletableFuture-å¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPA" class="headerlink" title="åœ¨ CompletableFuture å¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPA"></a>åœ¨ CompletableFuture å¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPA</h1><h2 id="CompletableFuture-çš„ä½¿ç”¨å®é™…æ¡ˆä¾‹"><a href="#CompletableFuture-çš„ä½¿ç”¨å®é™…æ¡ˆä¾‹" class="headerlink" title="CompletableFuture çš„ä½¿ç”¨å®é™…æ¡ˆä¾‹"></a>CompletableFuture çš„ä½¿ç”¨å®é™…æ¡ˆä¾‹</h2><p>åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéš¾å…ä¼šç”¨åˆ°å¼‚æ­¥æ–¹æ³•ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•çš„ä¾‹å­ï¼Œç»å…¸åœ°è¿˜åŸä¸€äº›åœ¨å¼‚æ­¥æ–¹æ³•é‡Œé¢ç»å¸¸ä¼šçŠ¯çš„é”™è¯¯ã€‚</p>
<p>æ¨¡æ‹Ÿä¸€ä¸ª Service æ–¹æ³•ï¼Œé€šè¿‡å¼‚æ­¥æ“ä½œï¼Œæ›´æ–° UserInfo ä¿¡æ¯ï¼Œå¹¶ä¸”å¯èƒ½ä¸€ä¸ªæ–¹æ³•é‡Œé¢æœ‰ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¼šå¤šæ¬¡æ›´æ–° UserInfo ä¿¡æ¯ï¼Œæ¨¡æ‹Ÿçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoController</span> </span>&#123;</span><br><span class="line">   <span class="comment">//å¼‚æ­¥æ“ä½œå¿…é¡»è¦å»ºç«‹çº¿ç¨‹æ± </span></span><br><span class="line">   <span class="meta">@Autowired</span> <span class="keyword">private</span>  Executor executor;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡serviceæ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œä¸€äº›ä¸šåŠ¡æ–¹æ³•é‡Œé¢å¯èƒ½ä¿®æ”¹äº†ä¸¤æ¬¡ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping(&quot;test/async/user&quot;)</span></span><br><span class="line">   <span class="meta">@Transactional</span> <span class="comment">// æ¨¡æ‹Ÿä¸€ä¸ª service æ–¹æ³•ï¼ŒæœŸå¾…æ˜¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">testSaveUser</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">   CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">      UserInfo user = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">      <span class="comment">//..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ”¹å˜ UserInfo é‡Œé¢çš„å€¼ï¼›</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         Thread.sleep(<span class="number">200L</span>);<span class="comment">// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 200 æ¯«ç§’</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_first&quot;</span>+name); <span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼</span></span><br><span class="line">      userInfoRepository.save(user);</span><br><span class="line">      <span class="comment">//..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬äºŒæ¬¡æ”¹å˜ UserInfo é‡Œé¢çš„å€¼ï¼›</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         Thread.sleep(<span class="number">300L</span>);<span class="comment">// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 300 æ¯«ç§’</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_second&quot;</span>+name);<span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼</span></span><br><span class="line">      userInfoRepository.save(user);</span><br><span class="line">   &#125;, executor).exceptionally(throwable -&gt; &#123;</span><br><span class="line">      throwable.printStackTrace();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="comment">//... å®é™…ä¸šåŠ¡ä¸­ï¼Œå¯èƒ½è¿˜æœ‰ä¼šå…¶ä»–å¼‚æ­¥æ–¹æ³•</span></span><br><span class="line">   cf.isDone();</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ testSaveUser æ–¹æ³•é‡Œé¢å¼€äº†ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ï¼Œå¼‚æ­¥çº¿ç¨‹é‡‡ç”¨ CompletableFuture æ–¹æ³•ï¼Œåœ¨é‡Œé¢æ‰§è¡Œäº†ä¸¤æ¬¡ UserInfo çš„ Save æ“ä½œ</p>
<p>é‚£ä¹ˆä¸Šé¢çš„ä»£ç é—®é¢˜çš„è¡¨è±¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h2 id="è¡¨ç°å‡ºæ¥çš„é—®é¢˜ç°çŠ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#è¡¨ç°å‡ºæ¥çš„é—®é¢˜ç°çŠ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="è¡¨ç°å‡ºæ¥çš„é—®é¢˜ç°çŠ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>è¡¨ç°å‡ºæ¥çš„é—®é¢˜ç°çŠ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p>é‚£ä¹ˆå®é™…å·¥ä½œä¸­ï¼Œå¦‚æœå†™å‡ºæ¥ç±»ä¼¼çš„ä»£ç ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæ ·çš„é—®é¢˜å‘¢ï¼Ÿ</p>
<ol>
<li><p>æ•´ä¸ªè¯·æ±‚éå¸¸æ­£å¸¸ï¼Œæ°¸è¿œéƒ½æ˜¯ 200ï¼›ä¹Ÿæ²¡æœ‰ä»»ä½•æŠ¥é”™ä¿¡æ¯ï¼Œä½†æ˜¯å‘ç°æ•°æ®åº“é‡Œé¢ç¬¬äºŒæ¬¡çš„ save(user) æ°¸è¿œä¸ç”Ÿæ•ˆï¼Œæ°¸è¿œä¸ä¼šå‡ºç° name åŒ…å« â€œ_secondâ€ çš„è®°å½•ï¼Œè¿™ä¸ªæ˜¯å¿…ç°çš„ï¼›</p>
</li>
<li><p>æ•´ä¸ªè¯·æ±‚éå¸¸æ­£å¸¸ï¼Œæ°¸è¿œéƒ½æ˜¯ 200ï¼›ä¹Ÿæ²¡æœ‰ä»»ä½•æŠ¥é”™ä¿¡æ¯ï¼Œæœ‰çš„æ—¶å€™ä¼šå‘ç°æ•°æ®åº“é‡Œé¢æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œç”šè‡³ç¬¬ä¸€æ¬¡ save(user) éƒ½æ²¡æœ‰ç”Ÿæ•ˆï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯å¶å‘çš„ã€‚</p>
</li>
</ol>
<h3 id="æ­¥éª¤æ‹†è§£"><a href="#æ­¥éª¤æ‹†è§£" class="headerlink" title="æ­¥éª¤æ‹†è§£"></a>æ­¥éª¤æ‹†è§£</h3><h4 id="CompletableFuture-ä½¿ç”¨æœ€ä½³å®è·µ"><a href="#CompletableFuture-ä½¿ç”¨æœ€ä½³å®è·µ" class="headerlink" title="CompletableFuture ä½¿ç”¨æœ€ä½³å®è·µ"></a>CompletableFuture ä½¿ç”¨æœ€ä½³å®è·µ</h4><p>CompletableFuture ä¸»è¦çš„åŠŸèƒ½æ˜¯å®ç°äº† Future å’Œ CompletionStage çš„æ¥å£ï¼Œä¸»è¦çš„æ–¹æ³•å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡ç»™å®šçš„çº¿ç¨‹æ± ï¼Œå¼‚æ­¥æ‰§è¡Œ Runnable æ–¹æ³•ï¼Œä¸å¸¦è¿”å›ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; 	<span class="title">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span></span></span><br><span class="line"><span class="function"><span class="comment">//é€šè¿‡ç»™å®šçš„çº¿ç¨‹æ± ï¼Œå¼‚æ­¥æ‰§è¡Œ Runnable æ–¹æ³•ï¼Œå¸¦è¿”å›ç»“æœ</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; 	<span class="title">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span></span></span><br><span class="line"><span class="function"><span class="comment">//å½“ä¸Šé¢çš„å¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œä¹‹åéœ€è¦æ‰§è¡Œçš„å›è°ƒæ–¹æ³•</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; 	<span class="title">thenAccept</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> T&gt; action)</span></span></span><br><span class="line"><span class="function"><span class="comment">//é˜»å¡ç­‰å¾… future æ‰§è¡Œå®Œç»“æœ</span></span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//é˜»å¡è·å–ç»“æœ</span></span><br><span class="line"><span class="function">V <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//å½“å¼‚æ­¥æ“ä½œå‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompletionStage&lt;T&gt; <span class="title">exceptionally</span><span class="params">(Function&lt;Throwable, ? extends T&gt; fn)</span></span>;</span><br></pre></td></tr></table></figure>

<p>CompletableFuture è¿˜æœ‰æ›´å¤šçš„æ–¹æ³•ï¼Œå…¶åŠŸèƒ½ä¹Ÿéå¸¸å¼ºå¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬å¼€å‘è¿‡ç¨‹ä¸­ç”¨æ­¤ç±»çš„åœºæ™¯è¿˜éå¸¸å¤šã€‚</p>
<p>å…¶å®ä¸Šé¢çš„ Demo åªæ˜¯åˆ©ç”¨ runAsync åšäº†å¼‚æ­¥æ“ä½œï¼Œå¹¶åˆ©ç”¨ isDone åšäº†é˜»å¡ç­‰å¾…çš„åŠ¨ä½œï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ Exceptionally å¤„ç†å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<p>æ‰€ä»¥å¦‚æœæƒ³æ‰“å°å¼‚å¸¸ä¿¡æ¯ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ©ç”¨ Exceptionallyã€‚æ”¹è¿›ä¸€ä¸‹ Demo ä»£ç ï¼ŒæŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦å‘ç”Ÿäº†å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">   ......è¿™é‡Œçš„ä»£ç ä¸å˜</span><br><span class="line">&#125;, executor).exceptionally(e -&gt; &#123;</span><br><span class="line">   log.error(e);<span class="comment">//æŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°å‡ºæ¥</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>å†è¯·æ±‚ä¸Šé¢çš„ Controller æ–¹æ³•çš„æ—¶å€™ï¼Œå‘ç°æ§åˆ¶å°å°±ä¼šæ‰“å°å‡ºå¦‚ä¸‹æ‰€ç¤ºçš„ Error ä¿¡æ¯:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">java.util.concurrent.CompletionException: org.springframework.orm.ObjectOptimisticLockingFailureException: Object of <span class="class"><span class="keyword">class</span> [<span class="title">com</span>.<span class="title">example</span>.<span class="title">jpa</span>.<span class="title">demo</span>.<span class="title">db</span>.<span class="title">UserInfo</span>] <span class="title">with</span> <span class="title">identifier</span> [1]: <span class="title">optimistic</span> <span class="title">locking</span> <span class="title">failed</span>; <span class="title">nested</span> <span class="title">exception</span> <span class="title">is</span> <span class="title">org</span>.<span class="title">hibernate</span>.<span class="title">StaleObjectStateException</span>: <span class="title">Row</span> <span class="title">was</span> <span class="title">updated</span> <span class="title">or</span> <span class="title">deleted</span> <span class="title">by</span> <span class="title">another</span> <span class="title">transaction</span> (<span class="title">or</span> <span class="title">unsaved</span>-<span class="title">value</span> <span class="title">mapping</span> <span class="title">was</span> <span class="title">incorrect</span>) : [<span class="title">com</span>.<span class="title">example</span>.<span class="title">jpa</span>.<span class="title">demo</span>.<span class="title">db</span>.<span class="title">UserInfo</span>#1]</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">CompletableFuture</span>.<span class="title">encodeThrowable</span>(<span class="title">CompletableFuture</span>.<span class="title">java</span>:314)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">CompletableFuture</span>.<span class="title">completeThrowable</span>(<span class="title">CompletableFuture</span>.<span class="title">java</span>:319)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">CompletableFuture</span>$<span class="title">AsyncRun</span>.<span class="title">run</span>$$$<span class="title">capture</span>(<span class="title">CompletableFuture</span>.<span class="title">java</span>:1739)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">CompletableFuture</span>$<span class="title">AsyncRun</span>.<span class="title">run</span>(<span class="title">CompletableFuture</span>.<span class="title">java</span>)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">ThreadPoolExecutor</span>.<span class="title">runWorker</span>(<span class="title">ThreadPoolExecutor</span>.<span class="title">java</span>:1167)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">ThreadPoolExecutor</span>$<span class="title">Worker</span>.<span class="title">run</span>(<span class="title">ThreadPoolExecutor</span>.<span class="title">java</span>:641)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">lang</span>.<span class="title">Thread</span>.<span class="title">run</span>(<span class="title">Thread</span>.<span class="title">java</span>:844)</span></span><br><span class="line"><span class="class"><span class="title">Caused</span> <span class="title">by</span>: <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">orm</span>.<span class="title">ObjectOptimisticLockingFailureException</span>: <span class="title">Object</span> <span class="title">of</span> <span class="title">class</span> [<span class="title">com</span>.<span class="title">example</span>.<span class="title">jpa</span>.<span class="title">demo</span>.<span class="title">db</span>.<span class="title">UserInfo</span>] <span class="title">with</span> <span class="title">identifier</span> [1]: <span class="title">optimistic</span> <span class="title">locking</span> <span class="title">failed</span>; <span class="title">nested</span> <span class="title">exception</span> <span class="title">is</span> <span class="title">org</span>.<span class="title">hibernate</span>.<span class="title">StaleObjectStateException</span>: <span class="title">Row</span> <span class="title">was</span> <span class="title">updated</span> <span class="title">or</span> <span class="title">deleted</span> <span class="title">by</span> <span class="title">another</span> <span class="title">transaction</span> (<span class="title">or</span> <span class="title">unsaved</span>-<span class="title">value</span> <span class="title">mapping</span> <span class="title">was</span> <span class="title">incorrect</span>) : [<span class="title">com</span>.<span class="title">example</span>.<span class="title">jpa</span>.<span class="title">demo</span>.<span class="title">db</span>.<span class="title">UserInfo</span>#1]</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">orm</span>.<span class="title">jpa</span>.<span class="title">vendor</span>.<span class="title">HibernateJpaDialect</span>.<span class="title">convertHibernateAccessException</span>(<span class="title">HibernateJpaDialect</span>.<span class="title">java</span>:337)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">orm</span>.<span class="title">jpa</span>.<span class="title">vendor</span>.<span class="title">HibernateJpaDialect</span>.<span class="title">translateExceptionIfPossible</span>(<span class="title">HibernateJpaDialect</span>.<span class="title">java</span>:255)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">aop</span>.<span class="title">framework</span>.<span class="title">ReflectiveMethodInvocation</span>.<span class="title">proceed</span>(<span class="title">ReflectiveMethodInvocation</span>.<span class="title">java</span>:186)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">aop</span>.<span class="title">framework</span>.<span class="title">JdkDynamicAopProxy</span>.<span class="title">invoke</span>(<span class="title">JdkDynamicAopProxy</span>.<span class="title">java</span>:212)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">com</span>.<span class="title">sun</span>.<span class="title">proxy</span>.$<span class="title">Proxy116</span>.<span class="title">save</span>(<span class="title">Unknown</span> <span class="title">Source</span>)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">jpa</span>.<span class="title">demo</span>.<span class="title">web</span>.<span class="title">UserInfoController</span>.<span class="title">lambda</span>$<span class="title">testSaveUser</span>$0(<span class="title">UserInfoController</span>.<span class="title">java</span>:57)</span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">java</span>.<span class="title">base</span>/<span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">CompletableFuture</span>$<span class="title">AsyncRun</span>.<span class="title">run</span>$$$<span class="title">capture</span>(<span class="title">CompletableFuture</span>.<span class="title">java</span>:1736)</span></span><br><span class="line"><span class="class">	... 4 <span class="title">more</span></span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŠ¥é”™ä¿¡æ¯ï¼Œå¯ä»¥å‘ç°å…¶å®å°±æ˜¯å‘ç”Ÿäº†<strong>ä¹è§‚é”å¼‚å¸¸</strong>ï¼Œå¯¼è‡´ä¸Šé¢å®ä¾‹ä¸­çš„ç¬¬äºŒæ¬¡ save(user) å¿…ç„¶å¤±è´¥ï¼›è€Œç¬¬ä¸€æ¬¡ save(user) çš„å¤±è´¥ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨å¹¶å‘çš„æƒ…å†µä¸‹æœ‰å…¶ä»–è¯·æ±‚çº¿ç¨‹æ”¹å˜äº† UserInfo çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ”¹å˜äº† Versionã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹å®Œæ•´çš„ UserInfo å¯¹è±¡å®ä½“ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@EntityListeners(&#123;AuditingEntityListener.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="meta">@Version</span></span><br><span class="line">   <span class="keyword">private</span> Integer version;</span><br><span class="line">   <span class="meta">@CreatedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="meta">@CreatedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant createTime;</span><br><span class="line">   <span class="meta">@LastModifiedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line">   <span class="meta">@LastModifiedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant lastModifiedTime;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="keyword">private</span> String lastName;</span><br><span class="line">   <span class="keyword">private</span> String emailAddress;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ @Version ä¹å…³é”æœºåˆ¶å°±æ˜¯é˜²æ­¢æ•°æ®è¢«è¦†ç›–ï¼›è€Œå®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­å…¶å®å¾ˆéš¾å‘ç°ç±»ä¼¼é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥å½“ä½¿ç”¨ä»»ä½•çš„å¼‚æ­¥çº¿ç¨‹å¤„ç†æ¡†æ¶çš„æ—¶å€™ï¼Œä¸€å®šè¦æƒ³å¥½å¼‚å¸¸æƒ…å†µä¸‹æ€ä¹ˆæ‰“å°æ—¥å¿—ï¼Œå¦åˆ™å°±åƒé»‘æ´ä¸€æ ·ï¼Œå®Œå…¨ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<p>é‚£ä¹ˆæ—¢ç„¶çŸ¥é“å‘ç”Ÿäº†ä¹è§‚é”å¼‚å¸¸ï¼Œè¿™é‡Œå°±æœ‰ä¸ªç–‘é—®äº†ï¼šåœ¨ UserInfoController çš„ testSaveUser æ–¹æ³•ä¸Šé¢åŠ äº† @Transaction çš„æ³¨è§£ï¼Œä¸ºä»€ä¹ˆäº‹åŠ¡æ²¡æœ‰å›æ»šï¼Ÿ</p>
<h4 id="é€šè¿‡æ—¥å¿—æŸ¥çœ‹äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#é€šè¿‡æ—¥å¿—æŸ¥çœ‹äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="é€šè¿‡æ—¥å¿—æŸ¥çœ‹äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹"></a>é€šè¿‡æ—¥å¿—æŸ¥çœ‹äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹</h4><p>çœ‹çœ‹å¼‚æ­¥è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå…ˆæ‰“å¼€äº‹åŠ¡çš„æ—¥å¿—ï¼Œçœ‹çœ‹ä¸Šé¢æ–¹æ³•çš„äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## åœ¨ db çš„è¿æ¥ä¸­å¼€å¯ logger=Slf4JLogger&amp;profileSQL=true çœ‹ä¸€ä¸‹æ¯ä¸ªäº‹åŠ¡é‡Œæ‰§è¡Œçš„ sql æœ‰å“ªäº›</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/test?logger=Slf4JLogger&amp;profileSQL=true</span></span><br><span class="line"><span class="comment">## æ‰“å¼€ä¸‹é¢è¿™äº›ç±»çš„æ—¥å¿—çº§åˆ«ï¼Œè§‚å¯Ÿä¸€ä¸‹äº‹åŠ¡çš„å¼€å¯å’Œå…³é—­æ—¶æœº</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.orm.jpa</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.transaction</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.orm.jpa.JpaTransactionManager</span>=<span class="string">trace</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.engine.transaction.internal.TransactionImpl</span>=<span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<p>å†è¯·æ±‚ä¸€ä¸‹åˆšæ‰çš„æµ‹è¯•æ¥å£ï¼šPOST <a href="http://localhost:8087/test/async/user?name=jack">http://localhost:8087/test/async/user?name=jack</a> å°±ä¼šäº§ç”Ÿä¸‹å›¾æ‰€ç¤ºçš„æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20210111161229.png" alt=""></p>
<p>å…ˆçœ‹ä¸€ä¸‹ä¸ŠåŠéƒ¨åˆ†ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™å¼€å¯äº†ä¸¤ä¸ªäº‹åŠ¡ï¼Œåˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šã€‚</p>
<p><strong>çº¿ç¨‹ 1</strong>ï¼š[nio-8087-exec-1] å¼€å¯äº† UserInfoController.testSaveUser æ–¹æ³•ä¸Šé¢çš„äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ http çš„è¯·æ±‚çº¿ç¨‹ï¼Œå¼€å¯äº†ä¸€ä¸ª Controller è¯·æ±‚äº‹åŠ¡ã€‚è¿™æ˜¯å› ä¸ºåœ¨ testSaveUser çš„æ–¹æ³•ä¸Šé¢åŠ äº† @Transaction çš„æ³¨è§£ï¼Œæ‰€ä»¥å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ã€‚</p>
<p>è€Œé€šè¿‡æ—¥å¿—å¯ä»¥å‘ç°ï¼Œäº‹åŠ¡ 1 é‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œéšåå°±è¿›è¡Œäº† Commit æ“ä½œï¼Œæ‰€ä»¥çœ‹å¾—å‡ºæ¥ï¼Œ<strong><em>é»˜è®¤ä¸åšä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡æ˜¯ä¸èƒ½è·¨çº¿ç¨‹çš„ã€‚æ¯ä¸ªçº¿ç¨‹é‡Œé¢çš„äº‹åŠ¡ç›¸äº’éš”ç¦»ã€äº’ä¸å½±å“ã€‚</em></strong></p>
<p><strong>çº¿ç¨‹ 2</strong>ï¼š[         task-1]ï¼Œé€šè¿‡å¼‚æ­¥çº¿ç¨‹æ± å¼€å¯äº† SimpleJpaRepository.findById æ–¹æ³•ä¸Šé¢çš„åªè¯»äº‹åŠ¡ã€‚è¿™æ˜¯å› ä¸ºé»˜è®¤çš„ SimpleJpaRepository ç±»ä¸Šé¢åŠ äº† @Transaction(readOnly=true) äº§ç”Ÿçš„ç»“æœã€‚é€šè¿‡ MySQL çš„æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œæ­¤æ¬¡äº‹åŠ¡é‡Œé¢åªåšäº†å’Œä»£ç ç›¸å…³çš„ select user_info çš„æ“ä½œã€‚</p>
<p>å†çœ‹ä¸€ä¸‹ååŠéƒ¨åˆ†çš„æ—¥å¿—ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210111162146.png" alt=""></p>
<p>é€šè¿‡ååŠéƒ¨åˆ†æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤æ¬¡ save(user) æ–¹æ³•ï¼Œä¹Ÿåˆ†åˆ«å¼€å¯äº†å„è‡ªçš„äº‹åŠ¡ï¼Œè¿™æ˜¯å› ä¸º SimpleJpaRepository.save æ–¹æ³•ä¸Šé¢æœ‰ @Transaction æ³¨è§£èµ·äº†ä½œç”¨ï¼Œè€Œç¬¬äºŒæ¬¡äº‹åŠ¡å› ä¸º JPA çš„å®ç°æ–¹æ³•åˆ¤æ–­äº†æ•°æ®åº“è¿™æ¡æ•°æ®çš„ Version å’Œ UserInfo çš„å¯¹è±¡ä¸­çš„ Version ä¸ä¸€è‡´ï¼Œä»è€Œç¬¬äºŒæ¬¡è¿›è¡Œäº†å›æ»šæ“ä½œã€‚</p>
<p>ä¸¤æ¬¡ save(user) çš„æ“ä½œé‡Œé¢åˆ†åˆ«æœ‰ä¸€æ¬¡ Select å’Œ Update è¯­ä¹‰ã€‚ä¸¤æ¬¡äº‹åŠ¡ï¼Œåˆ†åˆ«å¼€å¯äº†ä¸¤ä¸ª Sessionï¼Œæ‰€ä»¥å¯¹è±¡å¯¹äºè¿™ä¸¤æ¬¡ Session æ¥è¯´åˆ†åˆ«æ˜¯ä»æ¸¸ç¦»æ€ï¼ˆDetachedï¼‰è½¬æˆæŒä¹…æ€ï¼ˆPersistentï¼‰çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸¤ä¸ªç‹¬ç«‹çš„äº‹åŠ¡é‡Œé¢ï¼Œä¸€æ¬¡ Selectï¼Œä¸€æ¬¡ Updateã€‚</p>
<p>é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ä¸€ä¸ªç®€å•çš„æ–¹æ³•ä¸­ä¸€å…±å‘ç”Ÿäº†å››æ¬¡äº‹åŠ¡ï¼Œéƒ½æ˜¯é‡‡ç”¨çš„é»˜è®¤éš”ç¦»çº§åˆ«å’Œä¼ æ’­æœºåˆ¶ã€‚é‚£ä¹ˆå¦‚æœæƒ³è®©å¼‚æ­¥æ–¹æ³•é‡Œé¢åªæœ‰ä¸€ä¸ªäº‹åŠ¡åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<h3 id="å¼‚æ­¥äº‹åŠ¡çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•"><a href="#å¼‚æ­¥äº‹åŠ¡çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•" class="headerlink" title="å¼‚æ­¥äº‹åŠ¡çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•"></a>å¼‚æ­¥äº‹åŠ¡çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•</h3><p>å¼‚æ­¥æ–¹æ³•é‡Œé¢çš„äº‹åŠ¡æ˜¯ç‹¬ç«‹çš„ï¼Œé‚£ä¹ˆç›´æ¥æŠŠå¼‚æ­¥çš„ä»£ç å—ç”¨ç‹¬ç«‹çš„äº‹åŠ¡åŒ…è£…èµ·æ¥å³å¯ï¼Œåšæ³•æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<p>ç¬¬ä¸€ç§å¤„ç†æ–¹æ³•ï¼šæŠŠå…¶ä¸­çš„å¼‚æ­¥ä»£ç å—ï¼Œç§»åˆ°ä¸€ä¸ªå¤–éƒ¨ç±»é‡Œé¢ã€‚è¿™é‡Œæ”¾åˆ° UserInfoService ä¸­ï¼ŒåŒæ—¶æ–¹æ³•ä¸­åŠ ä¸Š @Transaction æ³¨è§£ç”¨æ¥å¼€å¯äº‹åŠ¡ï¼ŒåŠ ä¸Š @Retryable æ³¨è§£è¿›è¡Œä¹è§‚é”é‡è¯•ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŠ ä¸Šäº‹åŠ¡ï¼Œè¿™æ ·å¯ä»¥åšåˆ°åŸå­æ€§ï¼Œè§£å†³äº‹åŠ¡åŠ åˆ°å¼‚å¸¸æ–¹æ³•ä¹‹å¤–æ²¡æœ‰ä»»ä½•ä½œç”¨çš„é—®é¢˜</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="comment">//åŠ ä¸Šé‡è¯•æœºåˆ¶ï¼Œè¿™æ ·å½“å‘ç”Ÿä¹è§‚é”å¼‚å¸¸çš„æ—¶å€™ï¼Œé‡æ–°å°è¯•ä¸‹é¢çš„é€»è¾‘ï¼Œå‡å°‘è¯·æ±‚çš„å¤±è´¥æ¬¡æ•°</span></span><br><span class="line"><span class="meta">@Retryable(value = ObjectOptimisticLockingFailureException.class,backoff = @Backoff(multiplier = 1.5,random = true))</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">businessUserMethod</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">   UserInfo user = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">   <span class="comment">//..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ”¹å˜UserInfoé‡Œé¢çš„å€¼ï¼›</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(<span class="number">200L</span>);<span class="comment">// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 200 æ¯«ç§’</span></span><br><span class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">   user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_first&quot;</span>+name); <span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼</span></span><br><span class="line">   userInfoRepository.save(user);</span><br><span class="line">   <span class="comment">//..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬äºŒæ¬¡æ”¹å˜ UserInfo é‡Œé¢çš„å€¼ï¼›</span></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep(<span class="number">300L</span>);<span class="comment">// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 300 æ¯«ç§’</span></span><br><span class="line">   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">   &#125;</span><br><span class="line">   user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_second&quot;</span>+name);<span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼</span></span><br><span class="line">   userInfoRepository.save(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆ Controller é‡Œé¢åªéœ€è¦å˜æˆå¦‚ä¸‹å†™æ³•å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡serviceæ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œä¸€äº›ä¸šåŠ¡æ–¹æ³•é‡Œé¢å¯èƒ½ä¿®æ”¹äº†ä¸¤æ¬¡ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;test/async/user&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testSaveUser</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">   CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">      userInfoService.businessUserMethod(name);</span><br><span class="line">   &#125;, executor).exceptionally(e -&gt; &#123;</span><br><span class="line">      log.error(e);<span class="comment">//æŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°å‡ºæ¥</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="comment">//... å®é™…ä¸šåŠ¡ä¸­ï¼Œå¯èƒ½è¿˜æœ‰ä¼šå…¶ä»–å¼‚æ­¥æ–¹æ³•</span></span><br><span class="line">   cf.isDone();</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡å‘èµ·ä¸€ä¸‹è¯·æ±‚ï¼Œçœ‹ä¸€ä¸‹æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20210111163243.png" alt=""></p>
<p>é€šè¿‡ä¸Šå›¾çš„æ—¥å¿—ï¼Œå¯ä»¥çŸ¥é“ä¸¤ä¸ªé‡è¦ä¿¡æ¯ï¼š</p>
<ol>
<li><p>è¿™ä¸ªæ—¶å€™åªæœ‰ UserInfoServiceImpl.businessUserMethod å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™æ˜¯å› ä¸º findById å’Œ Save æ–¹æ³•ä¸­ï¼Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶éƒ½æ˜¯â€œå¦‚æœå­˜åœ¨äº‹åŠ¡å°±åˆ©ç”¨å½“å‰äº‹åŠ¡â€çš„åŸç†ï¼Œæ‰€ä»¥å°±ä¸ä¼šåƒä¸Šé¢ä¸€æ ·åˆ›å»ºå››æ¬¡äº‹åŠ¡äº†ï¼›</p>
</li>
<li><p>è€Œæ­¤æ—¶ä¸¤æ¬¡ save(user) åªäº§ç”Ÿäº†ä¸€ä¸ª update çš„ sql è¯­å¥ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆéš¾å‡ºç°ä¹è§‚é”å¼‚å¸¸äº†ï¼Œå› ä¸ºè¿™æ˜¯ Session çš„æœºåˆ¶ï¼Œå°†ä¸¤æ¬¡å¯¹ UserInfo å®ä½“çš„æ“ä½œè¿›è¡Œäº†åˆå¹¶ï¼›æ‰€ä»¥ä½¿ç”¨ JPA çš„æ—¶å€™æŸç§ç¨‹åº¦ä¸Šä¹Ÿä¼šé™ä½ db çš„å‹åŠ›ï¼Œå¢åŠ ä»£ç çš„æ‰§è¡Œæ€§èƒ½ã€‚</p>
</li>
</ol>
<p>è€Œå¦å¤–ä¸€ä¸ªä¾§è®ºï¼Œå°±æ˜¯å½“äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¶Šå¿«çš„æ—¶å€™ï¼Œå‘ç”Ÿå¼‚å¸¸çš„æ¦‚ç‡å°±ä¼šè¶Šä½ï¼Œå› ä¸ºå¯ä»¥å‡å°‘å¹¶å‘å¤„ç†çš„æœºä¼šã€‚</p>
<p>ç¬¬äºŒç§å¤„ç†æ–¹æ³•ï¼šTransactionTemplate æ–¹æ³•å¼€å¯äº‹åŠ¡</p>
<p>ç¬¬ä¸‰ç§å¤„ç†æ–¹æ³•ï¼šå¯ä»¥å»ºä¸€ä¸ªè‡ªå·±çš„ TransactionHelperï¼Œå¹¶å¸¦ä¸Šé‡è¯•æœºåˆ¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ©ç”¨springè¿›è¡Œç®¡ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Component</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TransactionHelper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ©ç”¨ spring æœºåˆ¶å’Œ jdk8 çš„ Consumer æœºåˆ¶å®ç°åªæ¶ˆè´¹çš„äº‹åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @Transactional(rollbackFor = Exception.class) <span class="comment">//å¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µï¼ŒæŒ‡å®šæ˜ç¡®çš„å›æ»šå¼‚å¸¸</span></span><br><span class="line">    @Retryable(value = ObjectOptimisticLockingFailureException.class,backoff = @Backoff(multiplier = <span class="number">1.5</span>,random = <span class="literal">true</span>))</span><br><span class="line">    public <span class="keyword">void</span> <span class="function"><span class="title">transactional</span>(<span class="params">Consumer consumer,<span class="built_in">Object</span> o</span>)</span> &#123;</span><br><span class="line">        consumer.accept(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller é‡Œé¢çš„å†™æ³•å¯ä»¥å˜æˆå¦‚ä¸‹æ–¹å¼ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·æ•ˆæœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;test/async/user&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testSaveUser</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">   CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">      transactionHelper.transactional((param)-&gt;&#123; <span class="comment">// é€šè¿‡lambdaå®ç°äº‹åŠ¡ç®¡ç†</span></span><br><span class="line">         UserInfo user = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">         <span class="comment">//..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ”¹å˜UserInfoé‡Œé¢çš„å€¼ï¼›</span></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">200L</span>);<span class="comment">// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶200æ¯«ç§’</span></span><br><span class="line">         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_first&quot;</span>+name); <span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼</span></span><br><span class="line">         userInfoRepository.save(user);</span><br><span class="line">         <span class="comment">//..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬äºŒæ¬¡æ”¹å˜UserInfoé‡Œé¢çš„å€¼ï¼›</span></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">300L</span>);<span class="comment">// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶300æ¯«ç§’</span></span><br><span class="line">         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_second&quot;</span>+name);<span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼</span></span><br><span class="line">         userInfoRepository.save(user);</span><br><span class="line">      &#125;,name);</span><br><span class="line">   &#125;, executor).exceptionally(e -&gt; &#123;</span><br><span class="line">      log.error(e);<span class="comment">//æŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°å‡ºæ¥</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="comment">//... å®é™…ä¸šåŠ¡ä¸­ï¼Œå¯èƒ½è¿˜æœ‰ä¼šå…¶ä»–å¼‚æ­¥æ–¹æ³•</span></span><br><span class="line">   cf.isDone();</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡ Lambda è¡¨è¾¾å¼è§£å†³äº‹åŠ¡é—®é¢˜ã€‚</p>
<p>æ€»ä¹‹ï¼Œä¸ç®¡æ˜¯ä»¥ä¸Šå“ªç§æ–¹æ³•ï¼Œéƒ½å¯ä»¥è§£å†³æ‰€è¯´çš„å¼‚æ­¥äº‹åŠ¡çš„é—®é¢˜ã€‚æ‰€ä»¥ææ¸…æ¥šäº‹åŠ¡çš„èƒŒåå®ç°é€»è¾‘ï¼Œå°±å¾ˆå®¹æ˜“è§£å†³ç±»ä¼¼é—®é¢˜äº†ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¸ºä»€ä¹ˆå½“å¼‚æ­¥æ–¹æ³•ä¸­æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™ï¼Œç¬¬äºŒæ¬¡ save(user) å°±æˆåŠŸäº†ï¼Ÿè€Œå¼‚æ­¥ä»£ç å—é‡Œé¢çš„ä¸¤ä¸ª save(user) åˆ†åˆ«åœ¨ä¸¤ä¸ªäº‹åŠ¡é‡Œé¢ï¼Œç¬¬äºŒæ¬¡å°±ä¸æˆåŠŸäº†å‘¢ï¼Ÿ</p>
<h2 id="Session-çš„æœºåˆ¶ä¸-Repository-save-entity-æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#Session-çš„æœºåˆ¶ä¸-Repository-save-entity-æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="Session çš„æœºåˆ¶ä¸ Repository.save(entity) æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>Session çš„æœºåˆ¶ä¸ Repository.save(entity) æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ</h2><p>Entity æœ‰ä¸åŒçš„çŠ¶æ€ã€‚</p>
<p>åœ¨ä¸€ä¸ª Session é‡Œé¢ï¼Œå¦‚æœé€šè¿‡ findById(id) å¾—åˆ°ä¸€ä¸ª Entityï¼Œå®ƒå°±ä¼šå˜æˆ Managerï¼ˆpersistï¼‰ æŒä¹…æ€ã€‚é‚£ä¹ˆåŒä¸€ä¸ª Session é‡Œé¢ï¼ŒåŒä¸€ä¸ª Entity å¤šæ¬¡æ“ä½œ Hibernate å°±ä¼šè¿›è¡Œ Merge æ“ä½œã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢çš„å®ä¾‹ä¸­ï¼Œå½“åœ¨ businessUserMethod æ–¹æ³•ä¸Šé¢åŠ  @Transaction çš„æ—¶å€™ï¼Œä¼šé€ æˆå¼‚æ­¥ä»£ç çš„æ•´å—é€»è¾‘å¤„äºåŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢ï¼Œ åŒä¸€ä¸ªäº‹åŠ¡å°±ä¼šå…±äº«åŒä¸€ä¸ª Sessionï¼Œæ‰€ä»¥åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢çš„ findByIdã€saveã€save çš„å¤šæ¬¡æ“ä½œéƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹ã€‚</p>
<p>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¯ä»¥é€šè¿‡è®¾ç½® Debug æ–­ç‚¹ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å¯¹è±¡çš„å†…å­˜å¯¹è±¡åœ°å€æ˜¯å¦ä¸€æ ·ï¼Œå°±å¯ä»¥çœ‹å¾—å‡ºæ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒfindById ä¹‹åå’Œä¸¤æ¬¡ save ä¹‹åéƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p><img src="http://image.leonote.cn/20210111164917.png" alt=""></p>
<p>è€Œå¦‚æœè·¨ Session ä¼ é€’å®ä½“å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ª Session é‡Œé¢æŒä¹…æ€çš„å¯¹è±¡ï¼Œå¯¹äºå¦å¤–ä¸€ä¸ª Session æ¥è¯´å°±æ˜¯ä¸€ä¸ªDetachedï¼ˆæ¸¸ç¦»æ€ï¼‰çš„å¯¹è±¡ã€‚</p>
<p>è€Œæ ¹æ® Session é‡Œé¢çš„ Persistent Context çš„åŸç†ï¼Œä¸€æ—¦è¿™ä¸ªæ¸¸ç¦»æ€çš„å¯¹è±¡è¿›è¡Œ db æ“ä½œï¼ŒSession ä¼š Copy ä¸€ä¸ªæ–°çš„å®ä½“å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä¸åœ¨å¼‚æ­¥ä»£ç ä¸­åŠ äº‹åŠ¡çš„æ—¶å€™ï¼Œå³å»æ‰å¼‚æ­¥ä»£ç å— businessUserMethod æ–¹æ³•ä¸­çš„ @Transaction æ³¨è§£ï¼ŒfindById ä¹‹åå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€æ–°çš„ Sessionï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯å¯¹è±¡ 1ï¼›ç¬¬ä¸€æ¬¡ Save ä¹‹åï¼Œç”±äºåˆæ˜¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€æ–°çš„ Sessionï¼Œé‚£ä¹ˆè¿”å›çš„å®ä½“ u2 å°±æ˜¯å¯¹è±¡ 2ã€‚</p>
<p>çŸ¥é“è¿™ä¸ªåŸç†ä¹‹åï¼Œå¯¹ä»£ç åšå¦‚ä¸‹æ”¹åŠ¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  @Transactional å»æ‰äº‹åŠ¡</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">businessUserMethod</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">      UserInfo user = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">      user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_first&quot;</span>+name); <span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼</span></span><br><span class="line">      UserInfo u2 = userInfoRepository.save(user);</span><br><span class="line">      user.setName(RandomUtils.nextInt(<span class="number">1</span>,<span class="number">100000</span>)+ <span class="string">&quot;_second&quot;</span>+name); <span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼</span></span><br><span class="line">      UserInfo u3 = userInfoRepository.save(u2);<span class="comment">// ç¬¬äºŒæ¬¡saveé‡‡ç”¨ç¬¬ä¸€æ¬¡saveçš„è¿”å›ç»“æœï¼Œè¿™æ ·é‡Œé¢å¸¦æœ‰äº†æœ€æ–°çš„versionçš„å€¼ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¼šä¿å­˜æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¼‚æ­¥é‡Œé¢è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºä¹è§‚é”çš„åŸç†æ˜¯ Version å˜äº†ï¼Œæˆ‘ä»¬ç”¨æœ€æ–°çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æœ€æ–°çš„ Version å°±å¯ä»¥äº†ã€‚</p>
<p>è®¾ç½®ä¸€ä¸ªæ–­ç‚¹çœ‹ä¸€ä¸‹ userã€u2ã€u3 åœ¨ä¸åŒçš„ Session ä½œç”¨åŸŸä¹‹åï¼Œå°±å˜æˆä¸åŒçš„å®ä¾‹äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210111165244.png" alt=""></p>
<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><ol>
<li><p>åœ¨ä¸Šé¢ Demo ä¸­çš„å¼‚æ­¥åœºæ™¯ä¸‹è®¾ç½® open-in-view ç­‰äº true / falseï¼Œä¼šå¯¹ä¸Šé¢çš„æµ‹è¯•ç»“æœæœ‰å½±å“å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ è‚¯å®šæ²¡æœ‰å½±å“çš„ï¼Œspring.jpa.open-in-view çš„æœ¬è´¨è¿˜æ˜¯å¼€å¯ Sessionï¼Œè€Œä¿æŒä½ Session çš„æœ¬è´¨è¿˜æ˜¯åˆ©ç”¨ ThreadLocalï¼Œä¹Ÿå°±æ˜¯å¿…é¡»ä¸ºåŒä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹æ‰é€‚ç”¨ã€‚æ‰€ä»¥<strong><em>å¼‚æ­¥åœºæ™¯ä¸å— spring.jpa.open-in-view æ§åˆ¶</em></strong>ã€‚</p>
</li>
<li><p>å¦‚æœæ˜¯å¤§é‡çš„å¼‚æ­¥æ“ä½œ db connection çš„æŒæœ‰æ¨¡å¼ï¼Œåº”è¯¥é…ç½®æˆå“ªä¸€ç§æ¯”è¾ƒåˆé€‚ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTIONï¼Œå› ä¸ºè¿™æ ·å¯ä»¥åšåˆ°å¯¹ db è¿æ¥æœ€å¤§çš„åˆ©ç”¨ç‡ã€‚ç”¨çš„æ—¶å€™å°±è·å–ï¼Œäº‹åŠ¡æäº¤å®Œå°±é‡Šæ”¾ï¼Œè¿™æ ·å°±ä¸ç”¨å…³å¿ƒä¸šåŠ¡é€»è¾‘æ‰§è¡Œå¤šé•¿æ—¶é—´äº†ã€‚</p>
</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨å¼€å‘ä¸šåŠ¡ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦æ€è€ƒä¸€ä¸‹å‡ ä¸ªé—®é¢˜</p>
<ol>
<li>ä¸€ä¸ªè¯·æ±‚ï¼Œå¼€å¯äº†å‡ æ¬¡äº‹åŠ¡ï¼Ÿå‡ æ¬¡ Sessionï¼Ÿåœ¨ä»€ä¹ˆæ—¶æœºå¼€å¯çš„ï¼Ÿ</li>
<li>äº‹åŠ¡å’Œ Session åˆ†åˆ«ä¼šå¯¹å®ä½“çš„çŠ¶æ€æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</li>
<li><strong>ä¸€ä¸ªè¯·æ±‚ï¼Œå¯¹ db è¿æ¥æ± é‡Œé¢çš„è¿æ¥æŒæœ‰æ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ</strong></li>
<li><strong>ä¸€ä¸ªè¯·æ±‚ï¼Œæ€§èƒ½æŒ‡æ ‡éƒ½æœ‰å“ªäº›å†³å®šå› ç´ ï¼Ÿ</strong></li>
</ol>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa å¤„ç†ç”Ÿäº§ç¯å¢ƒå¤šæ•°æ®æºçš„é—®é¢˜</title>
    <url>/2020/11/17/SpringDataJpa%E5%A4%84%E7%90%86%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="ç”Ÿäº§ç¯å¢ƒå¤šæ•°æ®æºçš„å¤„ç†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ"><a href="#ç”Ÿäº§ç¯å¢ƒå¤šæ•°æ®æºçš„å¤„ç†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="ç”Ÿäº§ç¯å¢ƒå¤šæ•°æ®æºçš„å¤„ç†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ"></a>ç”Ÿäº§ç¯å¢ƒå¤šæ•°æ®æºçš„å¤„ç†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ</h1><p>å·¥ä½œä¸­æˆ‘ä»¬æ—¶å¸¸ä¼šé‡åˆ°è·¨æ•°æ®åº“æ“ä½œçš„æƒ…å†µï¼Œè¿™æ—¶å€™å°±éœ€è¦é…ç½®å¤šæ•°æ®æºï¼š</p>
<ul>
<li>å¦‚ä½•é…ç½®ï¼Ÿ</li>
<li>å¸¸ç”¨çš„æ–¹å¼åŠå…¶èƒŒåçš„åŸç†ï¼Ÿ</li>
</ul>
<h2 id="å¸¸ç”¨çš„é…ç½®æ–¹å¼"><a href="#å¸¸ç”¨çš„é…ç½®æ–¹å¼" class="headerlink" title="å¸¸ç”¨çš„é…ç½®æ–¹å¼"></a>å¸¸ç”¨çš„é…ç½®æ–¹å¼</h2><ol>
<li>é€šè¿‡å¤šä¸ª @Configuration æ–‡ä»¶</li>
<li>åˆ©ç”¨ <code>AbstractRoutingDataSource</code> é…ç½®å¤šæ•°æ®æº</li>
</ol>
<h2 id="ç¬¬ä¸€ç§æ–¹å¼ï¼šå¤šä¸ªæ•°æ®æºçš„-Configuration-çš„é…ç½®æ–¹æ³•"><a href="#ç¬¬ä¸€ç§æ–¹å¼ï¼šå¤šä¸ªæ•°æ®æºçš„-Configuration-çš„é…ç½®æ–¹æ³•" class="headerlink" title="ç¬¬ä¸€ç§æ–¹å¼ï¼šå¤šä¸ªæ•°æ®æºçš„ @Configuration çš„é…ç½®æ–¹æ³•"></a>ç¬¬ä¸€ç§æ–¹å¼ï¼šå¤šä¸ªæ•°æ®æºçš„ @Configuration çš„é…ç½®æ–¹æ³•</h2><blockquote>
<p>ğŸ¯ä¸»è¦æ€è·¯ï¼šä¸åŒ Package ä¸‹é¢çš„å®ä½“å’Œ Repository é‡‡ç”¨ä¸åŒçš„ Data Source</p>
</blockquote>
<p>æ‰€ä»¥æ”¹é€ ä¸€ä¸‹ example ç›®å½•ç»“æ„ï¼Œæ¥çœ‹çœ‹ä¸åŒ Repositories çš„æ•°æ®æºæ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šè§„åˆ’ Entity å’Œ Repository çš„ç›®å½•ç»“æ„ï¼Œä¸ºäº†æ–¹ä¾¿é…ç½®å¤šæ•°æ®æºã€‚</strong></p>
<ul>
<li>å°† User å’Œ UserAddressã€UserRepository å’Œ UserAddressRepository ç§»åŠ¨åˆ° db1 é‡Œé¢ï¼›</li>
<li>å°† UserInfo å’Œ UserInfoRepository ç§»åŠ¨åˆ° db2 é‡Œé¢ã€‚</li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201117193953.png" alt=""></p>
<p>æŠŠå®ä½“å’Œ Repository åˆ†åˆ«æ”¾åˆ°äº† db1 å’Œ db2 ä¸¤ä¸ªç›®å½•é‡Œé¢ï¼Œå‡è®¾æ•°æ®æº 1 æ˜¯ MySQLï¼ŒUser è¡¨å’Œ UserAddress è¡¨åœ¨æ•°æ®æº 1 é‡Œé¢ï¼Œé‚£ä¹ˆéœ€è¦é…ç½®ä¸€ä¸ªæ•°æ®æº 1 çš„ Configuration ç±»ï¼Œå¹¶ä¸”åœ¨é‡Œé¢é…ç½® DataSourceã€TransactionManager å’Œ EntityManagerã€‚</p>
<p><strong>ç¬¬äºŒæ­¥ï¼šé…ç½® DataSource1Config ç±»ã€‚</strong></p>
<p>ç›®å½•ç»“æ„è°ƒæ•´å®Œä¹‹åï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½®æ•°æ®æºï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span><span class="comment">//å¼€å¯äº‹åŠ¡</span></span><br><span class="line"><span class="comment">//åˆ©ç”¨EnableJpaRepositoriesé…ç½®å“ªäº›åŒ…ä¸‹é¢çš„Repositoriesï¼Œé‡‡ç”¨å“ªä¸ªEntityManagerFactoryå’Œå“ªä¸ªtransactionManager</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">      basePackages = &#123;&quot;com.example.jpa.example1.db1&quot;&#125;,//æ•°æ®æº1çš„repositoryçš„åŒ…è·¯å¾„</span></span><br><span class="line"><span class="meta">      entityManagerFactoryRef = &quot;db1EntityManagerFactory&quot;,//æ”¹å˜æ•°æ®æº1çš„EntityManagerFactoryçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb1EntityManagerFactory</span></span><br><span class="line"><span class="meta">      transactionManagerRef = &quot;db1TransactionManager&quot;//æ”¹å˜æ•°æ®æº1çš„transactionManagerçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb1TransactionManager</span></span><br><span class="line"><span class="meta">      )</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSource1Config</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æŒ‡å®šæ•°æ®æº1çš„dataSourceé…ç½®</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Primary</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;db1DataSourceProperties&quot;)</span></span><br><span class="line">   <span class="meta">@ConfigurationProperties(&quot;spring.datasource1&quot;)</span> <span class="comment">//æ•°æ®æº1çš„dbé…ç½®å‰ç¼€é‡‡ç”¨spring.datasource1</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">dataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¯ä»¥é€‰æ‹©ä¸åŒçš„æ•°æ®æºï¼Œè¿™é‡Œç”¨HikariDataSourceä¸¾ä¾‹ï¼Œåˆ›å»ºæ•°æ®æº1</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> db1DataSourceProperties</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Primary</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;db1DataSource&quot;)</span></span><br><span class="line">   <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.hikari.db1&quot;)</span> <span class="comment">//é…ç½®æ•°æ®æº1æ‰€ç”¨çš„hikarié…ç½®keyçš„å‰ç¼€</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> HikariDataSource <span class="title">dataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;db1DataSourceProperties&quot;)</span> DataSourceProperties db1DataSourceProperties)</span> </span>&#123;</span><br><span class="line">      HikariDataSource dataSource = db1DataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.hasText(db1DataSourceProperties.getName())) &#123;</span><br><span class="line">         dataSource.setPoolName(db1DataSourceProperties.getName());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> dataSource;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é…ç½®æ•°æ®æº1çš„entityManagerFactoryå‘½åä¸ºdb1EntityManagerFactoryï¼Œç”¨æ¥å¯¹å®ä½“è¿›è¡Œä¸€äº›æ“ä½œ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> db1DataSource entityManagerä¾èµ–db1DataSource</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Primary</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;db1EntityManagerFactory&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">(EntityManagerFactoryBuilder builder, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                      <span class="meta">@Qualifier(&quot;db1DataSource&quot;)</span> DataSource db1DataSource)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> builder.dataSource(db1DataSource)</span><br><span class="line">					.packages(<span class="string">&quot;com.example.jpa.example1.db1&quot;</span>) <span class="comment">//æ•°æ®1çš„å®ä½“æ‰€åœ¨çš„è·¯å¾„</span></span><br><span class="line">					.persistenceUnit(<span class="string">&quot;db1&quot;</span>)<span class="comment">// persistenceUnitçš„åå­—é‡‡ç”¨db1</span></span><br><span class="line">					.build();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é…ç½®æ•°æ®æº1çš„äº‹åŠ¡ç®¡ç†è€…ï¼Œå‘½åä¸ºdb1TransactionManagerä¾èµ–db1EntityManagerFactory</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> db1EntityManagerFactory </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Primary</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;db1TransactionManager&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;db1EntityManagerFactory&quot;)</span> </span></span></span><br><span class="line"><span class="function"><span class="params">                                                        EntityManagerFactory db1EntityManagerFactory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> JpaTransactionManager(db1EntityManagerFactory);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œï¼Œæ•°æ®æº 1 å°±é…ç½®å®Œäº†ï¼Œä¸‹é¢å†é…ç½®æ•°æ®æº 2ã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥ï¼šé…ç½® DataSource2Config ç±»ï¼ŒåŠ è½½æ•°æ®æº 2ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span><span class="comment">//å¼€å¯äº‹åŠ¡</span></span><br><span class="line"><span class="comment">//åˆ©ç”¨EnableJpaRepositoriesï¼Œé…ç½®å“ªäº›åŒ…ä¸‹é¢çš„Repositoriesï¼Œé‡‡ç”¨å“ªä¸ªEntityManagerFactoryå’Œå“ªä¸ªtransactionManager</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">        basePackages = &#123;&quot;com.example.jpa.example1.db2&quot;&#125;,//æ•°æ®æº2çš„repositoryçš„åŒ…è·¯å¾„</span></span><br><span class="line"><span class="meta">        entityManagerFactoryRef = &quot;db2EntityManagerFactory&quot;,//æ”¹å˜æ•°æ®æº2çš„EntityManagerFactoryçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb2EntityManagerFactory</span></span><br><span class="line"><span class="meta">        transactionManagerRef = &quot;db2TransactionManager&quot;//æ”¹å˜æ•°æ®æº2çš„transactionManagerçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb2TransactionManager</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSource2Config</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‡å®šæ•°æ®æº2çš„dataSourceé…ç½®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;db2DataSourceProperties&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(&quot;spring.datasource2&quot;)</span> <span class="comment">//æ•°æ®æº2çš„dbé…ç½®å‰ç¼€é‡‡ç”¨spring.datasource2</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProperties <span class="title">dataSourceProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯ä»¥é€‰æ‹©ä¸åŒçš„æ•°æ®æºï¼Œè¿™é‡Œæˆ‘ç”¨HikariDataSourceä¸¾ä¾‹ï¼Œåˆ›å»ºæ•°æ®æº2</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> db2DataSourceProperties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;db2DataSource&quot;)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.hikari.db2&quot;)</span> <span class="comment">//é…ç½®æ•°æ®æº2çš„hikarié…ç½®keyçš„å‰ç¼€</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HikariDataSource <span class="title">dataSource</span><span class="params">(<span class="meta">@Qualifier(&quot;db2DataSourceProperties&quot;)</span> DataSourceProperties db2DataSourceProperties)</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = db2DataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(db2DataSourceProperties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(db2DataSourceProperties.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®æ•°æ®æº2çš„entityManagerFactoryå‘½åä¸ºdb2EntityManagerFactoryï¼Œç”¨æ¥å¯¹å®ä½“è¿›è¡Œä¸€äº›æ“ä½œ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> db2DataSource entityManagerä¾èµ–db2DataSource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;db2EntityManagerFactory&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">(EntityManagerFactoryBuilder builder, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                       <span class="meta">@Qualifier(&quot;db2DataSource&quot;)</span> DataSource db2DataSource)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> builder.dataSource(db2DataSource)</span><br><span class="line">           			 .packages(<span class="string">&quot;com.example.jpa.example1.db2&quot;</span>) <span class="comment">//æ•°æ®2çš„å®ä½“æ‰€åœ¨çš„è·¯å¾„</span></span><br><span class="line">                	 .persistenceUnit(<span class="string">&quot;db2&quot;</span>)<span class="comment">// persistenceUnitçš„åå­—é‡‡ç”¨db2</span></span><br><span class="line">         		     .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®æ•°æ®æº2çš„äº‹åŠ¡ç®¡ç†è€…ï¼Œå‘½åä¸ºdb2TransactionManagerä¾èµ–db2EntityManagerFactory</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> db2EntityManagerFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;db2TransactionManager&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;db2EntityManagerFactory&quot;)</span> </span></span></span><br><span class="line"><span class="function"><span class="params">                                                         EntityManagerFactory db2EntityManagerFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JpaTransactionManager(db2EntityManagerFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ¤£æ³¨æ„ï¼šDataSource1Config å’Œ DataSource2Config ä¸åŒçš„æ˜¯ï¼Œ1 é‡Œé¢æ¯ä¸ª @Bean éƒ½ @Primaryï¼Œè€Œ 2 é‡Œé¢ä¸æ˜¯çš„ã€‚</p>
</blockquote>
<p><strong>ç¬¬å››æ­¥ï¼šé€šè¿‡ application.properties é…ç½®ä¸¤ä¸ªæ•°æ®æºçš„å€¼</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">###########datasource1 é‡‡ç”¨Mysqlæ•°æ®åº“</span></span><br><span class="line"><span class="meta">spring.datasource1.url</span>=<span class="string">jdbc:mysql://localhost:3306/test2?logger=Slf4JLogger&amp;profileSQL=true</span></span><br><span class="line"><span class="meta">spring.datasource1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource1.password</span>=<span class="string">root</span></span><br><span class="line"><span class="comment">##æ•°æ®æº1çš„è¿æ¥æ± çš„åå­—</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.db1.pool-name</span>=<span class="string">jpa-hikari-pool-db1</span></span><br><span class="line"><span class="comment">##æœ€é•¿ç”Ÿå‘½å‘¨æœŸ15åˆ†é’Ÿå¤Ÿäº†</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.db1.maxLifetime</span>=<span class="string">900000</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.db1.maximumPoolSize</span>=<span class="string">8</span></span><br><span class="line"><span class="comment">###########datasource2 é‡‡ç”¨h2å†…å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="meta">spring.datasource2.url</span>=<span class="string">jdbc:h2:~/test</span></span><br><span class="line"><span class="meta">spring.datasource2.username</span>=<span class="string">sa</span></span><br><span class="line"><span class="meta">spring.datasource2.password</span>=<span class="string">sa</span></span><br><span class="line"><span class="comment">##æ•°æ®æº2çš„è¿æ¥æ± çš„åå­—</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.db2.pool-name</span>=<span class="string">jpa-hikari-pool-db2</span></span><br><span class="line"><span class="comment">##æœ€é•¿ç”Ÿå‘½å‘¨æœŸå’Œæ•°æ®æº1åŒºåˆ†å¼€ï¼Œè®¾ç½®æˆ500ç§’</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.db2.maxLifetime</span>=<span class="string">500000</span></span><br><span class="line"><span class="comment">##æœ€å¤§è¿æ¥æ± å¤§å°å’Œæ•°æ®æº1åŒºåˆ†å¼€ï¼Œé…ç½®æˆ6ä¸ª</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.db2.maximumPoolSize</span>=<span class="string">6</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äº”æ­¥ï¼šå†™ä¸ª Controller æµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span> <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">   <span class="meta">@Autowired</span> <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">   <span class="comment">//æ“ä½œuserçš„Repository</span></span><br><span class="line">   <span class="meta">@PostMapping(&quot;/user&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> userRepository.save(user);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//æ“ä½œuserInfoçš„Repository</span></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/user/info&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> UserInfo <span class="title">saveUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> userInfoRepository.save(userInfo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬å…­æ­¥ï¼šç›´æ¥å¯åŠ¨æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæµ‹è¯•ä¸€ä¸‹ã€‚</strong></p>
<p>è¯·çœ‹è¿™ä¸€æ­¥çš„å¯åŠ¨æ—¥å¿—ï¼š</p>
<p><img src="http://image.leonote.cn//20201117195320.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å¯åŠ¨çš„æ˜¯ä¸¤ä¸ªæ•°æ®æºï¼Œå…¶å¯¹åº”çš„è¿æ¥æ± çš„ç›‘æ§æ˜¯ä¸ä¸€æ ·çš„ï¼šæ•°æ®æº 1 æœ‰ 8 ä¸ªï¼Œæ•°æ®æº 2 æœ‰ 6 ä¸ªã€‚</p>
<p><img src="http://image.leonote.cn//20201117195706.png" alt=""></p>
<p>å¦‚æœåˆ†åˆ«è¯·æ±‚ Controller å†™çš„ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿä¼šåˆ†åˆ«æ’å…¥åˆ°ä¸åŒçš„æ•°æ®æºé‡Œé¢å»ã€‚</p>
<h3 id="Datasource-ä¸-TransactionManagerã€EntityManagerFactory-çš„å…³ç³»åˆ†æ"><a href="#Datasource-ä¸-TransactionManagerã€EntityManagerFactory-çš„å…³ç³»åˆ†æ" class="headerlink" title="Datasource ä¸ TransactionManagerã€EntityManagerFactory çš„å…³ç³»åˆ†æ"></a>Datasource ä¸ TransactionManagerã€EntityManagerFactory çš„å…³ç³»åˆ†æ</h3><p>é€šè¿‡ä¸€ä¸ªç±»çš„å…³ç³»å›¾æ¥åˆ†æä¸€ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn//20201117200329.png" alt=""></p>
<p>å…¶ä¸­ï¼Œ</p>
<ol>
<li><code>HikariDataSource</code> è´Ÿè´£å®ç° DataSourceï¼Œäº¤ç»™ EntityManager å’Œ TransactionManager ä½¿ç”¨ï¼›</li>
<li>EntityManager æ˜¯åˆ©ç”¨ DataSource æ¥æ“ä½œæ•°æ®åº“ï¼Œè€Œå…¶å®ç°ç±»æ˜¯ <code>SessionImpl</code>ï¼›</li>
<li>EntityManagerFactory æ˜¯ç”¨æ¥ç®¡ç†å’Œç”Ÿæˆ EntityManager çš„ï¼Œè€Œ EntityManagerFactory çš„å®ç°ç±»æ˜¯ <code>LocalContainerEntityManagerFactoryBean</code>ï¼Œé€šè¿‡å®ç° FactoryBean æ¥å£å®ç°ï¼Œåˆ©ç”¨äº† FactoryBean åœ¨ Spring ä¸­çš„ bean ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Datasource1Config é‡Œé¢é…ç½® <code>LocalContainerEntityManagerFactoryBean</code> çš„ bean çš„æ³¨å…¥æ–¹å¼ï¼›</li>
<li><code>JpaTransactionManager</code> æ˜¯ç”¨æ¥ç®¡ç†äº‹åŠ¡çš„ï¼Œå®ç°äº† TransactionManager å¹¶ä¸”é€šè¿‡ EntityManagerFactory å’Œ Datasource è¿›è¡Œ db æ“ä½œï¼Œæ‰€ä»¥è¦åœ¨ DataSourceConfig é‡Œé¢å‘Šè¯‰ JpaTransactionManager ç”¨çš„ TransactionManager æ˜¯ db1EntityManagerFactoryã€‚</li>
</ol>
<blockquote>
<p>ğŸ“å…³ç³»å›¾ï¼š</p>
<p><code>DataSourceConfig</code> -&gt; <code>TransactionManager</code> -&gt; <code>EntityManagerFactory</code> -&gt; <code>EntityManager</code> -&gt; <code>DataSource</code> </p>
<p>â€‹                                                   â†“                                        â†“                                                                â†“</p>
<p>â€‹                    <code>JpaTransactionManager</code> -&gt; <code>LocalContainerEntityManagerFactoryBean</code> -&gt;  ..  -&gt; <code>HikariDataSource</code> </p>
</blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ Datasource çš„ EntityManagerFactory å’Œ TransactionManager æ˜¯æ€ä¹ˆåŠ è½½å’Œé…ç½®çš„å‘¢ï¼Ÿ</p>
<h3 id="é»˜è®¤çš„-JpaBaseConfiguration-çš„åŠ è½½æ–¹å¼åˆ†æ"><a href="#é»˜è®¤çš„-JpaBaseConfiguration-çš„åŠ è½½æ–¹å¼åˆ†æ" class="headerlink" title="é»˜è®¤çš„ JpaBaseConfiguration çš„åŠ è½½æ–¹å¼åˆ†æ"></a>é»˜è®¤çš„ JpaBaseConfiguration çš„åŠ è½½æ–¹å¼åˆ†æ</h3><p>å¯ä»¥é€šè¿‡ HibernateJpaConfigurationï¼Œæ‰¾åˆ°çˆ¶ç±» JpaBaseConfiguration ç±»ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201117201745.png" alt=""></p>
<p>æ¥ç€æ‰“å¼€ <code>JpaBaseConfiguration</code> å°±å¯ä»¥çœ‹åˆ°å¤šæ•°æ®æºçš„å‚è€ƒåŸå‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201117202608.png" alt=""></p>
<p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å•ä¸ªæ•°æ®æºæƒ…å†µä¸‹çš„ EntityManagerFactory å’Œ TransactionManager çš„åŠ è½½æ–¹æ³•ï¼Œ</p>
<p>å¹¶ä¸”æˆ‘ä»¬åœ¨<strong>å¤šæ•°æ®æºçš„é…ç½®</strong>é‡Œé¢è¿˜åŠ è½½äº†ä¸€ä¸ªç±»ï¼šEntityManagerFactoryBuilder ï¼Œæ­£æ˜¯ä»ä¸Šé¢çš„æ–¹æ³•åŠ è½½è¿›å»çš„ã€‚</p>
<h2 id="ç¬¬äºŒç§æ–¹å¼ï¼šåˆ©ç”¨-AbstractRoutingDataSource-é…ç½®å¤šæ•°æ®æº"><a href="#ç¬¬äºŒç§æ–¹å¼ï¼šåˆ©ç”¨-AbstractRoutingDataSource-é…ç½®å¤šæ•°æ®æº" class="headerlink" title="ç¬¬äºŒç§æ–¹å¼ï¼šåˆ©ç”¨ AbstractRoutingDataSource é…ç½®å¤šæ•°æ®æº"></a>ç¬¬äºŒç§æ–¹å¼ï¼šåˆ©ç”¨ AbstractRoutingDataSource é…ç½®å¤šæ•°æ®æº</h2><p>DataSource çš„æœ¬è´¨æ˜¯è·å¾—æ•°æ®åº“è¿æ¥ï¼Œè€Œ <code>AbstractRoutingDataSource</code> å¸®æˆ‘ä»¬å®ç°äº†åŠ¨æ€è·å¾—æ•°æ®æºçš„å¯èƒ½æ€§ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šå®šä¸€ä¸ªæ•°æ®æºçš„æšä¸¾ç±»ï¼Œç”¨æ¥æ ‡ç¤ºæ•°æ®æºæœ‰å“ªäº›ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šä¹‰ä¸€ä¸ªæ•°æ®æºçš„æšä¸¾ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">RoutingDataSourceEnum</span> </span>&#123;</span><br><span class="line">   DB1, <span class="comment">// å®é™…å·¥ä½œä¸­æšä¸¾çš„è¯­ä¹‰å¯ä»¥æ›´åŠ æ˜ç¡®ä¸€ç‚¹ï¼›</span></span><br><span class="line">   DB2;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RoutingDataSourceEnum <span class="title">findByCode</span><span class="params">(String dbRouting)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (RoutingDataSourceEnum e : values()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (e.name().equals(dbRouting)) &#123;</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> db1;<span class="comment">//æ²¡æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤è¿”å›æ•°æ®æº1</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥ï¼šæ–°å¢ DataSourceRoutingHolderï¼Œç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹éœ€è¦é‡‡ç”¨çš„æ•°æ®æºã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ©ç”¨ ThreadLocal æ¥å­˜å‚¨ï¼Œå½“å‰çš„çº¿ç¨‹ä½¿ç”¨çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceRoutingHolder</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;RoutingDataSourceEnum&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setBranchContext</span><span class="params">(RoutingDataSourceEnum dataSourceEnum)</span> </span>&#123;</span><br><span class="line">      threadLocal.set(dataSourceEnum);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RoutingDataSourceEnum <span class="title">getBranchContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearBranchContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      threadLocal.remove();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼šé…ç½® RoutingDataSourceConfigï¼Œç”¨æ¥æŒ‡å®šå“ªäº› Entity å’Œ Repository é‡‡ç”¨åŠ¨æ€æ•°æ®æºã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(</span></span><br><span class="line"><span class="meta">      //æ•°æ®æºçš„ repository çš„åŒ…è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬è¦†ç›– db1 å’Œ db2 çš„åŒ…è·¯å¾„</span></span><br><span class="line"><span class="meta">      basePackages = &#123;&quot;com.example.jpa.example1&quot;&#125;,</span></span><br><span class="line"><span class="meta">      entityManagerFactoryRef = &quot;routingEntityManagerFactory&quot;,</span></span><br><span class="line"><span class="meta">      transactionManagerRef = &quot;routingTransactionManager&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutingDataSourceConfig</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="meta">@Qualifier(&quot;db1DataSource&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> DataSource db1DataSource;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="meta">@Qualifier(&quot;db2DataSource&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> DataSource db2DataSource;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ›å»ºRoutingDataSourceï¼Œå¼•ç”¨æˆ‘ä»¬ä¹‹å‰é…ç½®çš„db1DataSourceå’Œdb2DataSource</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;routingDataSource&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Map&lt;Object, Object&gt; dataSourceMap = Maps.newHashMapWithExpectedSize(<span class="number">2</span>);</span><br><span class="line">      dataSourceMap.put(RoutingDataSourceEnum.DB1, db1DataSource);</span><br><span class="line">      dataSourceMap.put(RoutingDataSourceEnum.DB2, db2DataSource);</span><br><span class="line">      RoutingDataSource routingDataSource = <span class="keyword">new</span> RoutingDataSource();</span><br><span class="line">      <span class="comment">//è®¾ç½®RoutingDataSourceçš„é»˜è®¤æ•°æ®æº</span></span><br><span class="line">      routingDataSource.setDefaultTargetDataSource(db1DataSource);</span><br><span class="line">      <span class="comment">//è®¾ç½®RoutingDataSourceçš„æ•°æ®æºåˆ—è¡¨</span></span><br><span class="line">      routingDataSource.setTargetDataSources(dataSourceMap);</span><br><span class="line">      <span class="keyword">return</span> routingDataSource;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ç±»ä¼¼db1å’Œdb2çš„é…ç½®ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œé‡‡ç”¨routingDataSource</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> routingDataSource entityManagerä¾èµ–routingDataSource</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;routingEntityManagerFactory&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">(EntityManagerFactoryBuilder builder, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                      <span class="meta">@Qualifier(&quot;routingDataSource&quot;)</span> DataSource routingDataSource)</span> </span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> builder.dataSource(routingDataSource)</span><br><span class="line">            .packages(<span class="string">&quot;com.example.jpa.example1&quot;</span>) <span class="comment">//æ•°æ®routingçš„å®ä½“æ‰€åœ¨çš„è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬è¦†ç›–db1å’Œdb2çš„è·¯å¾„</span></span><br><span class="line">            .persistenceUnit(<span class="string">&quot;db-routing&quot;</span>)<span class="comment">// persistenceUnitçš„åå­—é‡‡ç”¨db-routing</span></span><br><span class="line">            .build();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é…ç½®æ•°æ®çš„äº‹åŠ¡ç®¡ç†è€…ï¼Œå‘½åä¸º routingTransactionManager ä¾èµ– routingEntityManagerFactory</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> routingEntityManagerFactory</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean(name = &quot;routingTransactionManager&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(<span class="meta">@Qualifier(&quot;routingEntityManagerFactory&quot;)</span> </span></span></span><br><span class="line"><span class="function"><span class="params">                                                        EntityManagerFactory routingEntityManagerFactory)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> JpaTransactionManager(routingEntityManagerFactory);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·¯ç”±æ•°æ®æºé…ç½®ä¸ DataSource1Config å’Œ DataSource2Config æœ‰ç›¸äº’è¦†ç›–å…³ç³»ï¼Œè¿™é‡Œè¦†ç›– db1 å’Œ db2 çš„åŒ…è·¯å¾„ï¼Œä»¥ä¾¿äºåŠ¨æ€æ•°æ®æºç”Ÿæ•ˆã€‚</p>
<p><strong>ç¬¬å››æ­¥ï¼šå†™ä¸€ä¸ª MVC æ‹¦æˆªå™¨ï¼Œç”¨æ¥æŒ‡å®šè¯·æ±‚åˆ†åˆ«é‡‡ç”¨ä»€ä¹ˆæ•°æ®æºã€‚</strong></p>
<p>æ–°å»ºä¸€ä¸ªç±» <code>DataSourceInterceptor</code>ï¼Œç”¨æ¥åœ¨è¯·æ±‚å‰åæŒ‡å®šæ•°æ®æºï¼Œè¯·çœ‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ¨æ€è·¯ç”±çš„å®ç°é€»è¾‘ï¼Œæˆ‘ä»¬é€šè¿‡è¯·æ±‚é‡Œé¢çš„db-routingï¼Œæ¥æŒ‡å®šæ­¤è¯·æ±‚é‡‡ç”¨ä»€ä¹ˆæ•°æ®æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¯·æ±‚å¤„ç†ä¹‹å‰æ›´æ”¹çº¿ç¨‹é‡Œé¢çš„æ•°æ®æº</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                      HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      String dbRouting = request.getHeader(<span class="string">&quot;db-routing&quot;</span>);</span><br><span class="line">      DataSourceRoutingHolder.setBranchContext(RoutingDataSourceEnum.findByCode(dbRouting));</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.preHandle(request, response, handler);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¯·æ±‚ç»“æŸä¹‹åæ¸…ç†çº¿ç¨‹é‡Œé¢çš„æ•°æ®æº</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.afterCompletion(request, response, handler, ex);</span><br><span class="line">      DataSourceRoutingHolder.clearBranchContext();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶éœ€è¦åœ¨å®ç° WebMvcConfigurer çš„é…ç½®é‡Œé¢ï¼ŒæŠŠæˆ‘ä»¬è‡ªå®šä¹‰æ‹¦æˆªå™¨ dataSourceInterceptor åŠ è½½è¿›å»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®ç°WebMvcConfigurer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> DataSourceInterceptor dataSourceInterceptor;</span><br><span class="line">   <span class="comment">//æ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">      registry.addInterceptor(dataSourceInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">      WebMvcConfigurer.<span class="keyword">super</span>.addInterceptors(registry);</span><br><span class="line">   &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤„é‡‡ç”¨çš„æ˜¯ MVC çš„æ‹¦æˆªå™¨æœºåˆ¶åŠ¨æ€æ”¹å˜çš„æ•°æ®é…ç½®ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„ AOP ä»»æ„çš„æ‹¦æˆªå™¨ï¼Œå¦‚äº‹åŠ¡æ‹¦æˆªå™¨ã€Service çš„æ‹¦æˆªå™¨ç­‰ï¼Œéƒ½å¯ä»¥å®ç°ã€‚</p>
<blockquote>
<p>ğŸ“æ³¨æ„ï¼šè¦åœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰é…ç½®å®Œæ¯•</p>
</blockquote>
<p><strong>ç¬¬äº”æ­¥ï¼šå¯åŠ¨æµ‹è¯•ã€‚</strong></p>
<p>åœ¨ Http è¯·æ±‚å¤´é‡Œé¢åŠ ä¸Š db-routingï¼šDB2ï¼Œé‚£ä¹ˆæœ¬æ¬¡è¯·æ±‚å°±ä¼šé‡‡ç”¨æ•°æ®æº 2 è¿›è¡Œå¤„ç†ï¼Œè¯·æ±‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/user/info</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8089</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">db-routing</span><span class="punctuation">: </span>DB2</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span><span class="punctuation">: </span>56d8dc02-7f3e-7b95-7ff1-572a4bb7d102</span><br><span class="line">&#123;&quot;ages&quot;:10&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢äº”ä¸ªæ­¥éª¤ï¼Œå¯ä»¥åˆ©ç”¨ <code>AbstractRoutingDataSource</code> å®ç°åŠ¨æ€æ•°æ®æºï¼Œå®é™…å·¥ä½œä¸­å¯èƒ½æ›´å¤æ‚ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹ã€çº¿ç¨‹å®‰å…¨ç­‰é—®é¢˜ã€‚</p>
<h3 id="å¤šæ•°æ®æºçš„æ³¨æ„äº‹é¡¹"><a href="#å¤šæ•°æ®æºçš„æ³¨æ„äº‹é¡¹" class="headerlink" title="å¤šæ•°æ®æºçš„æ³¨æ„äº‹é¡¹"></a>å¤šæ•°æ®æºçš„æ³¨æ„äº‹é¡¹</h3><ol>
<li><p>è¿™ç§æ–¹å¼åˆ©ç”¨äº†<strong>å½“å‰çº¿ç¨‹äº‹åŠ¡ä¸å˜çš„åŸç†</strong>ï¼Œæ‰€ä»¥è¦<strong>æ³¨æ„å¼‚æ­¥çº¿ç¨‹</strong>çš„å¤„ç†æ–¹å¼ï¼›</p>
</li>
<li><p>è¿™ç§æ–¹å¼åˆ©ç”¨äº† DataSource çš„åŸç†ï¼ŒåŠ¨æ€åœ°è¿”å›ä¸åŒçš„ db è¿æ¥ï¼Œä¸€èˆ¬<strong>éœ€è¦åœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰ä½¿ç”¨</strong>ï¼Œéœ€è¦<strong>æ³¨æ„äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ</strong>ï¼›</p>
</li>
<li><p>æ¯”è¾ƒ<strong>é€‚åˆè¯»å†™æ“ä½œåˆ†å¼€çš„ä¸šåŠ¡åœºæ™¯</strong>ï¼›</p>
</li>
<li><p>å¤šæ•°æ®çš„æƒ…å†µä¸‹ï¼Œ<strong>é¿å…ä¸€ä¸ªäº‹åŠ¡é‡Œé¢é‡‡ç”¨ä¸åŒçš„æ•°æ®æº</strong>ï¼Œè¿™æ ·ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘ç”Ÿï¼Œæ¯”å¦‚æ­»é”ç°è±¡ï¼›</p>
</li>
<li><p>å­¦ä¼šé€šè¿‡æ—¥å¿—æ£€æŸ¥å¼€å¯è¯·æ±‚çš„æ–¹æ³•å’Œå¼€å¯çš„æ•°æ®æºæ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥é€šè¿‡ Debug æ–­ç‚¹æ¥è§‚å¯Ÿæ•°æ®æºæ˜¯å¦é€‰æ‹©çš„æ­£ç¡®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201117205419.png" alt=""></p>
</li>
</ol>
<h3 id="å¾®æœåŠ¡ä¸‹çš„å»ºè®®"><a href="#å¾®æœåŠ¡ä¸‹çš„å»ºè®®" class="headerlink" title="å¾®æœåŠ¡ä¸‹çš„å»ºè®®"></a>å¾®æœåŠ¡ä¸‹çš„å»ºè®®</h3><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œä¸ºäº†ä¾¿æ·çœäº‹ï¼Œæ›´å¤šå¼€å‘è€…å–œæ¬¢é…ç½®å¤šä¸ªæ•°æ®æºï¼Œä½†æ˜¯å¼ºçƒˆå»ºè®®ä¸è¦åœ¨å¯¹ç”¨æˆ·ç›´æ¥æä¾›çš„ API æœåŠ¡ä¸Šé¢é…ç½®å¤šæ•°æ®æºï¼Œå¦åˆ™å°†å‡ºç°ä»¤äººæªæ‰‹ä¸åŠçš„ Bugã€‚</p>
<p>å¦‚æœæ˜¯åšåå°ç®¡ç†ç•Œé¢ï¼Œä¾›å…¬å¸å†…éƒ¨å‘˜å·¥ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆè¿™ç§ API å¯ä»¥ä¸ºäº†æ–¹ä¾¿è€Œä½¿ç”¨å¤šæ•°æ®æºã€‚</p>
<p>å¾®æœåŠ¡çš„å¤§ç¯å¢ƒä¸‹ï¼Œ<strong>æœåŠ¡è¶Šå°ï¼Œå†…èšè¶Šé«˜</strong>ï¼Œä½è€¦åˆæœåŠ¡è¶Šå¥å£®ï¼Œæ‰€ä»¥ä¸€èˆ¬è·¨åº“ä¹‹é—´<strong>é€šè¿‡ REST çš„ API åè®®ï¼Œè¿›è¡Œå†…éƒ¨æœåŠ¡ä¹‹é—´çš„è°ƒç”¨</strong>ï¼Œæ˜¯<strong>æœ€ç¨³å¦¥</strong>çš„æ–¹å¼ï¼ŒåŸå› æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li><p>REST çš„ API åè®®æ›´å®¹æ˜“ç›‘æ§ï¼Œæ›´å®¹æ˜“å®ç°äº‹åŠ¡çš„åŸå­æ€§ï¼›</p>
</li>
<li><p>db ä¹‹é—´è§£è€¦ï¼Œä½¿ä¸šåŠ¡é¢†åŸŸä»£ç èŒè´£æ›´æ¸…æ™°ï¼Œæ›´å®¹æ˜“å„è‡ªå¤„ç†å„ç§é—®é¢˜ï¼›</p>
</li>
<li><p>åªè¯»å’Œè¯»å†™çš„ API æ›´å®¹æ˜“åˆ†ç¦»å’Œç®¡ç†ã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa å¯¹ WebMVC çš„æ”¯æŒ</title>
    <url>/2020/11/11/SpringDataJpa%E5%AF%B9WebMVC%E7%9A%84%E6%94%AF%E6%8C%81/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-å¯¹-WebMVC-çš„æ”¯æŒ"><a href="#Spring-Data-Jpa-å¯¹-WebMVC-çš„æ”¯æŒ" class="headerlink" title="Spring Data Jpa å¯¹ WebMVC çš„æ”¯æŒ"></a>Spring Data Jpa å¯¹ WebMVC çš„æ”¯æŒ</h1><p>Spring Data å¯¹ Spring MVC åšäº†å¾ˆå¥½çš„æ”¯æŒï¼Œä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li><p>æ”¯æŒåœ¨ Controller å±‚ç›´æ¥è¿”å›å®ä½“ï¼Œè€Œä¸ä½¿ç”¨å…¶æ˜¾å¼çš„è°ƒç”¨æ–¹æ³•ï¼›</p>
</li>
<li><p>å¯¹ MVC å±‚æ”¯æŒæ ‡å‡†çš„åˆ†é¡µå’Œæ’åºåŠŸèƒ½ï¼›</p>
</li>
<li><p>æ‰©å±•çš„æ’ä»¶æ”¯æŒ Querydslï¼Œå¯ä»¥å¸®å¿™è¿›è¡Œä¸€äº›é€šç”¨çš„æŸ¥è¯¢é€»è¾‘ã€‚</p>
</li>
</ul>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¼€å¯ Spring Data å¯¹ Spring Web MVC æ”¯æŒéœ€è¦åœ¨ <code>@Configuration</code> çš„é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ  <code>@EnableSpringDataWebSupport</code> è¿™ä¸€æ³¨è§£ï¼Œå¦‚ä¸‹é¢è¿™ç§å½¢å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="comment">//å¼€å¯æ”¯æŒSpring Data Webçš„æ”¯æŒ</span></span><br><span class="line"><span class="meta">@EnableSpringDataWebSupport</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfiguration</span> </span>&#123; &#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºæˆ‘ä»¬ç”¨äº† Spring Bootï¼Œå…¶æœ‰è‡ªåŠ¨åŠ è½½æœºåˆ¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½ <code>SpringDataWebAutoConfiguration</code> ç±»ï¼Œå‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableSpringDataWebSupport</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; PageableHandlerMethodArgumentResolver.class, WebMvcConfigurer.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(PageableHandlerMethodArgumentResolver.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SpringDataWebProperties.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RepositoryRestMvcAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDataWebAutoConfiguration</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç±»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>@EnableSpringDataWebSupport</code> <strong>ä¼šè‡ªåŠ¨å¼€å¯</strong>ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ç”¨ Spring Boot + JPA + MVC çš„æ—¶å€™ï¼Œä»€ä¹ˆéƒ½ä¸éœ€è¦åšï¼Œå› ä¸º Spring Boot åˆ©ç”¨ Spring Data å¯¹ Spring MVC åšäº†å¾ˆå¤š Web å¼€å‘çš„å¤©ç„¶æ”¯æŒã€‚æ”¯æŒçš„ç»„ä»¶æœ‰ DomainConverterã€Pageã€Sortã€DataBindingã€Dynamic Param ç­‰ã€‚</p>
<h2 id="DomainClassConverter-ç»„ä»¶"><a href="#DomainClassConverter-ç»„ä»¶" class="headerlink" title="DomainClassConverter ç»„ä»¶"></a>DomainClassConverter ç»„ä»¶</h2><p>è¿™ä¸ªç»„ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯å¸®æˆ‘ä»¬æŠŠ Path ä¸­ ID çš„å˜é‡ï¼Œæˆ– Request å‚æ•°ä¸­çš„å˜é‡ ID çš„å‚æ•°å€¼ï¼Œç›´æ¥è½¬åŒ–æˆå®ä½“å¯¹è±¡æ³¨å†Œåˆ° Controller æ–¹æ³•çš„å‚æ•°é‡Œé¢ã€‚æ€ä¹ˆç†è§£å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼Œå°±å¾ˆå¥½æ‡‚äº†ã€‚</p>
<h3 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>é¦–å…ˆï¼Œå†™ä¸€ä¸ª MVC çš„ Controllerï¼Œåˆ†åˆ«ä» Path å’Œ Param å˜é‡é‡Œé¢ï¼Œæ ¹æ® ID è½¬åŒ–æˆå®ä½“ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoController</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä»pathå˜é‡é‡Œé¢è·å¾—å‚æ•°IDçš„å€¼ï¼Œç„¶åç›´æ¥è½¬åŒ–æˆUserInfoå®ä½“</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> userInfo</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoFromPath</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> userInfo;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å°†requestçš„paramä¸­çš„IDå˜é‡å€¼ï¼Œè½¬åŒ–æˆUserInfoå®ä½“</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> userInfo</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoFromRequestParam</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> userInfo;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ç„¶åï¼Œæˆ‘ä»¬è¿è¡Œèµ·æ¥ï¼Œçœ‹ä¸€ä¸‹ç»“æœï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/user/1</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;: 1,</span><br><span class="line">  &quot;version&quot;: 0,</span><br><span class="line">  &quot;ages&quot;: 10,</span><br><span class="line">  &quot;telephone&quot;: &quot;123456789&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç»“æœæ¥çœ‹ï¼ŒController é‡Œé¢çš„ getUserInfoFromRequestParam æ–¹æ³•ä¼šè‡ªåŠ¨æ ¹æ® ID æŸ¥è¯¢å®ä½“å¯¹è±¡ UserInfoï¼Œç„¶åæ³¨å…¥æ–¹æ³•çš„å‚æ•°é‡Œé¢ã€‚é‚£å®ƒæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p><code>DomainClassConverter</code> ç±»é‡Œé¢æœ‰ä¸ª <code>ToEntityConverter</code> çš„å†…éƒ¨è½¬åŒ–ç±»çš„ Matches æ–¹æ³•ï¼Œå®ƒä¼šåˆ¤æ–­å‚æ•°çš„ç±»å‹æ˜¯ä¸æ˜¯å®ä½“ï¼Œå¹¶ä¸”æœ‰æ²¡æœ‰å¯¹åº”çš„å®ä½“ Repository å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šç›´æ¥æŠ¥é”™è¯´æ‰¾ä¸åˆ°åˆé€‚çš„å‚æ•°è½¬åŒ–å™¨ã€‚</p>
<p><code>DomainClassConverter</code> é‡Œé¢çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DomainClassConverter</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">ConversionService</span> &amp; <span class="title">ConverterRegistry</span>&gt;</span></span><br><span class="line"><span class="class">      <span class="keyword">implements</span> <span class="title">ConditionalGenericConverter</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(TypeDescriptor sourceType, TypeDescriptor targetType)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//åˆ¤æ–­å‚æ•°çš„ç±»å‹æ˜¯ä¸æ˜¯å®ä½“</span></span><br><span class="line">      <span class="keyword">if</span> (sourceType.isAssignableTo(targetType)) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Class&lt;?&gt; domainType = targetType.getType();</span><br><span class="line">      <span class="comment">//æœ‰æ²¡æœ‰å¯¹åº”çš„å®ä½“çš„ Repository å­˜åœ¨</span></span><br><span class="line">      <span class="keyword">if</span> (!repositories.hasRepositoryFor(domainType)) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Optional&lt;RepositoryInformation&gt; repositoryInformation = repositories.getRepositoryInformationFor(domainType);</span><br><span class="line">      <span class="keyword">return</span> repositoryInformation.map(it -&gt; &#123;</span><br><span class="line">         Class&lt;?&gt; rawIdType = it.getIdType();</span><br><span class="line">         <span class="keyword">return</span> sourceType.equals(TypeDescriptor.valueOf(rawIdType))</span><br><span class="line">               || conversionService.canConvert(sourceType.getType(), rawIdType);</span><br><span class="line">      &#125;).orElseThrow(</span><br><span class="line">            () -&gt; <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">&quot;Couldn&#x27;t find RepositoryInformation for %s!&quot;</span>, domainType)));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­å…¶å®æ˜¯éœ€è¦æœ‰ UserInfoRepository çš„ï¼Œå¦åˆ™ä¼šå¤±è´¥ã€‚</p>
<p>é€šè¿‡æºç æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ matches=trueï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œä¸‹é¢çš„ convert æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ <code>findById</code> çš„æ–¹æ³•å¸®æˆ‘ä»¬æ‰§è¡ŒæŸ¥è¯¢åŠ¨ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201112134125.png" alt=""></p>
<p>è€Œ <code>DomainClassConverter</code> æ˜¯ Spring MVC è‡ªå®šä¹‰ Formatter çš„ä¸€ç§æœºåˆ¶ï¼ŒåŠ è½½è¿›å»ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p>
<p><img src="http://image.leonote.cn/20201112134341.png" alt=""></p>
<p>è€Œ <code>SpringDataWebConfiguration</code> æ˜¯å› ä¸ºå®ç°äº† WebMvcConfigurer çš„ addFormatters æ‰€æœ‰åŠ è½½äº†è‡ªå®šä¹‰å‚æ•°è½¬åŒ–å™¨çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æ‰æœ‰äº† <code>DomainClassConverter</code> ç»„ä»¶çš„æ”¯æŒã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDataWebConfiguration</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span>, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æºç ä¸Šæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ<code>DomainClassConverter</code> åªä¼šæ ¹æ® ID æ¥æŸ¥è¯¢å®ä½“ï¼Œå¾ˆæœ‰å±€é™æ€§ï¼Œæ²¡æœ‰æ›´åŠ çµæ´»çš„å‚æ•°è½¬åŒ–åŠŸèƒ½ï¼Œä¸è¿‡ä½ ä¹Ÿå¯ä»¥<strong><em>æ ¹æ®æºç è‡ªå·±è¿›è¡Œæ‰©å±•</em></strong>ã€‚</p>
<h2 id="Page-å’Œ-Sort-çš„å‚æ•°æ”¯æŒ"><a href="#Page-å’Œ-Sort-çš„å‚æ•°æ”¯æŒ" class="headerlink" title="Page å’Œ Sort çš„å‚æ•°æ”¯æŒ"></a>Page å’Œ Sort çš„å‚æ•°æ”¯æŒ</h2><h3 id="ä¸¾ä¾‹-1"><a href="#ä¸¾ä¾‹-1" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>é¦–å…ˆï¼Œæ–°å»ºä¸€ä¸ª UserInfoControllerï¼Œé‡Œé¢æ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æµ‹è¯•åˆ†é¡µå’Œæ’åºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;UserInfo&gt; <span class="title">queryByPage</span><span class="params">(Pageable pageable, UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.findAll(Example.of(userInfo),pageable);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/users/sort&quot;)</span></span><br><span class="line"><span class="keyword">public</span> HttpEntity&lt;List&lt;UserInfo&gt;&gt; queryBySort(Sort sort) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> HttpEntity&lt;&gt;(userInfoRepository.findAll(sort));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼ŒqueryByPage æ–¹æ³•ä¸­ï¼Œä¸¤ä¸ªå‚æ•°å¯ä»¥åˆ†åˆ«æ¥æ”¶åˆ†é¡µå‚æ•°å’ŒæŸ¥è¯¢æ¡ä»¶ï¼Œæˆ‘ä»¬è¯·æ±‚ä¸€ä¸‹ï¼Œçœ‹çœ‹æ•ˆæœï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/users?size=2&amp;page=0&amp;ages=10&amp;sort=id,desc</span><br></pre></td></tr></table></figure>

<p>å‚æ•°é‡Œé¢å¯ä»¥æ”¯æŒåˆ†é¡µå¤§å°ä¸º 2ã€é¡µç  0ã€æ’åºï¼ˆæŒ‰ç…§ ID å€’åºï¼‰</p>
<p>ages=10 æ‰€æœ‰ç»“æœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;content&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;ages&quot;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;telephone&quot;</span>: <span class="string">&quot;123456789&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;version&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;ages&quot;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;telephone&quot;</span>: <span class="string">&quot;123456789&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;pageable&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;sorted&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;unsorted&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;empty&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;pageNumber&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;pageSize&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;unpaged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;paged&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;totalPages&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;totalElements&quot;</span>: <span class="number">4</span>,</span><br><span class="line">  <span class="attr">&quot;last&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;number&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;numberOfElements&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;sorted&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;unsorted&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;empty&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;first&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;empty&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› æ­¤ï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼šPageable æ—¢æ”¯æŒåˆ†é¡µå‚æ•°ï¼Œä¹Ÿæ”¯æŒæ’åºå‚æ•°ã€‚å¹¶ä¸”ä»ä¸‹é¢è¿™è¡Œä»£ç å¯ä»¥çœ‹å‡ºå…¶ä¹Ÿå¯ä»¥å•ç‹¬è°ƒç”¨ Sort å‚æ•°ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/users/sort?ages=10&amp;sort=id,desc</span><br></pre></td></tr></table></figure>

<h3 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>å’Œ DomainClassConverter ç»„ä»¶çš„æ”¯æŒæ˜¯ä¸€æ ·çš„ï¼Œç”±äº <code>SpringDataWebConfiguration</code> å®ç°äº† WebMvcConfigurer æ¥å£ï¼Œé€šè¿‡ addArgumentResolvers æ–¹æ³•ï¼Œæ‰©å±•äº† Controller æ–¹æ³•çš„å‚æ•° HandlerMethodArgumentResolver ï¼Œä»ä¸‹é¢å›¾ç‰‡ä¸­ä½ å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚</p>
<p><img src="http://image.leonote.cn/20201112133652.png" alt=""></p>
<p>æˆ‘ä»¬é€šè¿‡ç®­å¤´çš„åœ°æ–¹åˆ†æä¸€ä¸‹ <code>SortHandlerMethodArgumentResolver</code> çš„ç±»ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p>
<p><img src="http://image.leonote.cn/20201112134714.png" alt=""></p>
<p>è¿™ä¸ªç±»é‡Œé¢æœ€å…³é”®çš„å°±æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><p>supportsParameterï¼šè¡¨ç¤ºåªå¤„ç†ç±»å‹ä¸º Sort.class çš„å‚æ•°ï¼›</p>
</li>
<li><p>resolveArgumentï¼šå¯ä»¥æŠŠè¯·æ±‚é‡Œé¢å‚æ•°çš„å€¼ï¼Œè½¬æ¢æˆè¯¥æ–¹æ³•é‡Œé¢çš„å‚æ•° Sort å¯¹è±¡ã€‚</p>
</li>
</ul>
<p>è¿™é‡Œè¿˜è¦æåˆ°çš„æ˜¯å¦å¤–ä¸€ä¸ªç±»ï¼š<code>PageableHandlerMethodArgumentResolver</code> ç±»ã€‚</p>
<p><img src="http://image.leonote.cn/20201112144556.png" alt=""></p>
<p>è¿™ä¸ªç±»é‡Œé¢ä¹Ÿæœ‰ä¸¤ä¸ªæœ€å…³é”®çš„æ–¹æ³•ï¼š</p>
<ul>
<li>supportsParameterï¼šè¡¨ç¤ºæˆ‘åªå¤„ç†ç±»å‹æ˜¯ Pageable.class çš„å‚æ•°ï¼›</li>
</ul>
<ul>
<li>resolveArgumentï¼šæŠŠè¯·æ±‚é‡Œé¢å‚æ•°çš„å€¼ï¼Œè½¬æ¢æˆè¯¥æ–¹æ³•é‡Œé¢çš„å‚æ•° Pageable çš„å®ç°ç±» PageRequestã€‚</li>
</ul>
<h2 id="Web-DataBinding-Support"><a href="#Web-DataBinding-Support" class="headerlink" title="Web DataBinding Support"></a>Web DataBinding Support</h2><p>Spring Data JPA é‡Œé¢ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>@ProjectedPayload</code> å’Œ <code>@JsonPath</code> å¯¹æ¥å£è¿›è¡Œæ³¨è§£æ”¯æŒï¼Œä¸è¿‡è¦æ³¨æ„è¿™ä¸ Jackson æ³¨è§£çš„åŒºåˆ«åœ¨äºï¼Œæ­¤æ—¶ç”¨çš„æ˜¯æ¥å£ã€‚</p>
<h3 id="ä¸¾ä¾‹-2"><a href="#ä¸¾ä¾‹-2" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>ç¬¬ä¸€æ­¥ï¼šå¦‚æœè¦æ”¯æŒ Projectionï¼Œå¿…é¡»è¦åœ¨ gradle é‡Œé¢å¼•å…¥ jsonpath ä¾èµ–æ‰å¯ä»¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">implementation &#39;com.jayway.jsonpath:json-path&#39;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šæ–°å»ºä¸€ä¸ª UserInfoInterface æ¥å£ç±»ï¼Œç”¨æ¥æ¥æ”¶æ¥å£ä¼ é€’çš„ json å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.web.JsonPath;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.web.ProjectedPayload;</span><br><span class="line"><span class="meta">@ProjectedPayload</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoInterface</span> </span>&#123;</span><br><span class="line">   <span class="meta">@JsonPath(&quot;$.ages&quot;)</span> <span class="comment">// ç¬¬ä¸€çº§å‚æ•°/JSONé‡Œé¢æ‰¾ageså­—æ®µ</span></span><br><span class="line"><span class="comment">// @JsonPath(&quot;$..ages&quot;) $..ä»£è¡¨ä»»æ„å±‚çº§æ‰¾ageså­—æ®µ</span></span><br><span class="line">   <span class="function">Integer <span class="title">getAges</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="meta">@JsonPath(&quot;$.telephone&quot;)</span> <span class="comment">//ç¬¬ä¸€çº§æ‰¾å‚æ•°/JSONé‡Œé¢çš„telephoneå­—æ®µ</span></span><br><span class="line"><span class="comment">// @JsonPath(&#123; &quot;$.telephone&quot;, &quot;$.user.telephone&quot; &#125;) //ç¬¬ä¸€çº§æˆ–è€…userä¸‹é¢çš„telephoneéƒ½å¯ä»¥</span></span><br><span class="line">   <span class="function">String <span class="title">getTelephone</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šåœ¨ Controller é‡Œé¢æ–°å»ºä¸€ä¸ª post æ–¹æ³•ï¼Œé€šè¿‡æ¥å£è·å¾— RequestBody å‚æ•°å¯¹è±¡é‡Œé¢çš„å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/users/projected&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfoInterface <span class="title">saveUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> UserInfoInterface userInfoInterface)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userInfoInterface;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šæˆ‘ä»¬å‘é€ä¸€ä¸ª post è¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">POST http://localhost:8089/users/projected</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123; </span><br><span class="line">   &quot;ages&quot;:10,</span><br><span class="line">   &quot;telephone&quot;:&quot;123456789&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å¯ä»¥æ­£å¸¸å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ages&quot;</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">&quot;telephone&quot;</span>: <span class="string">&quot;123456789&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå“åº”ç»“æœè¯´æ˜äº†æ¥å£å¯ä»¥æ­£å¸¸æ˜ å°„ã€‚</p>
<h3 id="åŸç†åˆ†æ-1"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><blockquote>
<p> Spring é‡Œé¢æ˜¯å¦‚ä½•é€šè¿‡ HttpMessageConverter å¯¹ Projected è¿›è¡Œçš„æ”¯æŒ</p>
</blockquote>
<p>æŸ¥çœ‹<code>SpringDataWebConfiguration</code>ç±»ï¼Œå…¶ä¸­å®ç°çš„ WebMvcConfigurer æ¥å£é‡Œé¢æœ‰ä¸ª extendMessageConverters æ–¹æ³•ï¼Œæ–¹æ³•é‡Œé¢åŠ äº†ä¸€ä¸ª <code>ProjectingJackson2HttpMessageConverter</code> çš„ç±»ï¼Œè¿™ä¸ªç±»ä¼šæŠŠå¸¦ ProjectedPayload.class æ³¨è§£çš„æ¥å£è¿›è¡Œ Converterã€‚</p>
<p>å…¶ä¸­ä¸»è¦çš„ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li><p>åŠ è½½ <code>ProjectingJackson2HttpMessageConverter</code>ï¼Œç”¨æ¥åš Projecting çš„æ¥å£è½¬åŒ–ã€‚é€šè¿‡æºç çœ‹ä¸€ä¸‹æ˜¯åœ¨å“ªé‡Œè¢«åŠ è½½è¿›å»çš„ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn/20201112171750.png" alt=""></p>
</li>
</ol>
<ul>
<li><p>è€Œ <code>ProjectingJackson2HttpMessageConverter</code> ä¸»è¦æ˜¯ç»§æ‰¿äº† <code>MappingJackson2HttpMessageConverter</code>ï¼Œå¹¶ä¸”å®ç°äº† <code>HttpMessageConverter</code> çš„æ¥å£é‡Œé¢çš„ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201112171920.png" alt=""></p>
<p>å…¶ä¸­ï¼Œ</p>
<ul>
<li>canRead é€šè¿‡åˆ¤æ–­å‚æ•°çš„å®ä½“ç±»å‹é‡Œé¢æ˜¯å¦æœ‰æ¥å£ï¼Œä»¥åŠæ˜¯å¦æœ‰ ProjectedPayload.class æ³¨è§£åï¼Œæ‰è¿›è¡Œè§£æï¼›</li>
<li>read æ–¹æ³•è´Ÿè´£æŠŠ HttpInputMessage è½¬åŒ–æˆ Projected çš„æ˜ å°„ä»£ç†å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h2 id="QueryDSL-Web-Support"><a href="#QueryDSL-Web-Support" class="headerlink" title="QueryDSL Web Support"></a>QueryDSL Web Support</h2><p>å®é™…å·¥ä½œä¸­ï¼Œç»å¸¸æœ‰äººä¼šç”¨ Querydsl åšä¸€äº›å¤æ‚æŸ¥è¯¢ï¼Œæ–¹ä¾¿ç”Ÿæˆ Rest çš„ API æ¥å£ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œåˆä¼šæš´éœ²ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿ</p>
<h3 id="ä¸¾ä¾‹-3"><a href="#ä¸¾ä¾‹-3" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>ç¬¬ä¸€æ­¥ï¼šéœ€è¦ gradle å¼•å…¥ querydsl çš„ä¾èµ–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">implementation &#39;com.querydsl:querydsl-apt&#39;</span><br><span class="line">implementation &#39;com.querydsl:querydsl-jpa&#39;</span><br><span class="line">annotationProcessor(&quot;com.querydsl:querydsl-apt:4.3.1:jpa&quot;,</span><br><span class="line">        &quot;org.hibernate.javax.persistence:hibernate-jpa-2.1-api:1.0.2.Final&quot;,</span><br><span class="line">        &quot;javax.annotation:javax.annotation-api:1.3.2&quot;,</span><br><span class="line">        &quot;org.projectlombok:lombok&quot;)</span><br><span class="line">annotationProcessor(&quot;org.springframework.boot:spring-boot-starter-data-jpa&quot;)</span><br><span class="line">annotationProcessor &#39;org.projectlombok:lombok&#39;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šUserInfoRepository ç»§æ‰¿ <code>QuerydslPredicateExecutor</code> æ¥å£ï¼Œå°±å¯ä»¥å®ç° QueryDSL çš„æŸ¥è¯¢æ–¹æ³•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">UserInfo</span>&gt; </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šController é‡Œé¢ç›´æ¥åˆ©ç”¨ <code>@QuerydslPredicate</code> æ³¨è§£æ¥æ”¶ Predicate å‚æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;user/dsl&quot;)</span></span><br><span class="line"><span class="function">Page&lt;UserInfo&gt; <span class="title">queryByDsl</span><span class="params">(<span class="meta">@QuerydslPredicate(root = UserInfo.class)</span> com.querydsl.core.types.Predicate predicate, Pageable pageable)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//è¿™é‡Œé¢ç”¨çš„æ˜¯ userInfoRepository é‡Œé¢çš„ QuerydslPredicateExecutor é‡Œé¢çš„æ–¹æ³•</span></span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.findAll(predicate, pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šç›´æ¥è¯·æ±‚æˆ‘ä»¬çš„ user / dsl å³å¯ï¼Œè¿™é‡Œåˆ©ç”¨ queryDsl çš„è¯­æ³• ï¼Œä½¿ &amp;ages=10 ä½œä¸ºæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/user/dsl?size=2&amp;page=0&amp;ages=10&amp;sort=id%2Cdesc&amp;ages=10</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: 2,</span><br><span class="line">      &quot;version&quot;: 0,</span><br><span class="line">      &quot;ages&quot;: 10,</span><br><span class="line">      &quot;telephone&quot;: &quot;123456789&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: 1,</span><br><span class="line">      &quot;version&quot;: 0,</span><br><span class="line">      &quot;ages&quot;: 10,</span><br><span class="line">      &quot;telephone&quot;: &quot;123456789&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;pageable&quot;: &#123;</span><br><span class="line">    &quot;sort&quot;: &#123;</span><br><span class="line">      &quot;sorted&quot;: true,</span><br><span class="line">      &quot;unsorted&quot;: false,</span><br><span class="line">      &quot;empty&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;offset&quot;: 0,</span><br><span class="line">    &quot;pageNumber&quot;: 0,</span><br><span class="line">    &quot;pageSize&quot;: 2,</span><br><span class="line">    &quot;unpaged&quot;: false,</span><br><span class="line">    &quot;paged&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;totalPages&quot;: 1,</span><br><span class="line">  &quot;totalElements&quot;: 2,</span><br><span class="line">  &quot;last&quot;: true,</span><br><span class="line">  &quot;size&quot;: 2,</span><br><span class="line">  &quot;number&quot;: 0,</span><br><span class="line">  &quot;sort&quot;: &#123;</span><br><span class="line">    &quot;sorted&quot;: true,</span><br><span class="line">    &quot;unsorted&quot;: false,</span><br><span class="line">    &quot;empty&quot;: false</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;numberOfElements&quot;: 2,</span><br><span class="line">  &quot;first&quot;: true,</span><br><span class="line">  &quot;empty&quot;: false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response code: 200; Time: 721ms; Content length: 425 bytes</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç»“è®º:</p>
<p>QueryDSL å¯ä»¥å¸®æˆ‘ä»¬çœå»åˆ›å»º Predicate çš„è¿‡ç¨‹ï¼Œç®€åŒ–äº†æ“ä½œæµç¨‹ã€‚ä½†æ˜¯å®ƒä¾ç„¶å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚å¤šäº†ä¸€äº›æ¨¡ç³ŠæŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ã€å¤§å°æŸ¥è¯¢ï¼Œå®ƒå¯¹è¿™äº›æ–¹é¢çš„æ”¯æŒä¸æ˜¯ç‰¹åˆ«å‹å¥½ã€‚å¯èƒ½æœªæ¥ä¼šæ›´æ–°ã€ä¼˜åŒ–</p>
</blockquote>
<h3 id="åŸç†åˆ†æ-2"><a href="#åŸç†åˆ†æ-2" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>QueryDSL ä¹Ÿæ˜¯ä¸»è¦åˆ©ç”¨è‡ªå®šä¹‰ Spring MVC çš„ <code>HandlerMethodArgumentResolver</code> å®ç°ç±»ï¼Œæ ¹æ®è¯·æ±‚çš„å‚æ•°å­—æ®µï¼Œè½¬åŒ–æˆ Controller é‡Œé¢æ‰€éœ€è¦çš„å‚æ•°ï¼Œè¯·çœ‹ä¸€ä¸‹æºç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuerydslPredicateArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">....</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">      NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      .....</span><br></pre></td></tr></table></figure>


<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œå…³äº insert å’Œ update çš„æ¥å£æ˜¯â€œé€ƒä¸æ‰â€çš„ï¼Œä½†ä¸æ˜¯æ¯æ¬¡çš„å­—æ®µéƒ½ä¼šå…¨éƒ¨ä¼ é€’è¿‡æ¥ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±æ¶‰åŠäº†ä¸Šè¿°å®ä¾‹é‡Œé¢çš„ä¸¤ä¸ªæ³¨è§£ <code>@DynamicUpdate</code> å’Œ <code>@DynamicInsert</code>ï¼Œä¸‹é¢æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚</p>
<h2 id="DynamicUpdate-amp-DynamicInsert-è¯¦è§£"><a href="#DynamicUpdate-amp-DynamicInsert-è¯¦è§£" class="headerlink" title="@DynamicUpdate &amp; @DynamicInsert è¯¦è§£"></a>@DynamicUpdate &amp; @DynamicInsert è¯¦è§£</h2><p><code>@DynamicInsert</code>ï¼šè¿™ä¸ªæ³¨è§£è¡¨ç¤º insert çš„æ—¶å€™ï¼Œä¼šåŠ¨æ€ç”Ÿäº§ insert SQL è¯­å¥</p>
<p>å…¶ç”Ÿæˆ SQL çš„è§„åˆ™æ˜¯ï¼š<strong>åªæœ‰éç©ºçš„å­—æ®µæ‰èƒ½ç”Ÿæˆ SQL</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target( TYPE )</span></span><br><span class="line"><span class="meta">@Retention( RUNTIME )</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DynamicInsert &#123;</span><br><span class="line">   <span class="comment">//é»˜è®¤æ˜¯trueï¼Œå¦‚æœè®¾ç½®æˆfalseï¼Œå°±è¡¨ç¤ºç©ºçš„å­—æ®µä¹Ÿä¼šç”Ÿæˆsqlè¯­å¥ï¼›</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ³¨è§£ä¸»è¦æ˜¯ç”¨åœ¨ @Entity çš„å®ä½“ä¸­ï¼Œå¦‚æœåŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼Œå°±è¡¨ç¤ºç”Ÿæˆçš„ insert SQL çš„ Columns åªåŒ…å«éç©ºçš„å­—æ®µï¼›å¦‚æœå®ä½“ä¸­ä¸åŠ è¿™ä¸ªæ³¨è§£ï¼Œé»˜è®¤çš„æƒ…å†µæ˜¯ç©ºçš„ï¼Œå­—æ®µä¹Ÿä¼šä½œä¸º insert è¯­å¥é‡Œé¢çš„ Columnsã€‚</p>
<p><code>@DynamicUpdate</code>ï¼šå’Œ insert æ˜¯ä¸€ä¸ªæ„æ€ï¼Œåªä¸è¿‡è¿™ä¸ªæ³¨è§£æŒ‡çš„æ˜¯åœ¨ update çš„æ—¶å€™ï¼Œä¼šåŠ¨æ€äº§ç”Ÿ update SQL è¯­å¥</p>
<p>ç”Ÿæˆ SQL çš„è§„åˆ™æ˜¯ï¼šåªæœ‰éç©ºçš„å­—æ®µæ‰ç”Ÿæˆåˆ° update SQL é‡Œé¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target( TYPE )</span></span><br><span class="line"><span class="meta">@Retention( RUNTIME )</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DynamicUpdate &#123;</span><br><span class="line">   <span class="comment">//å’Œinserté‡Œé¢ä¸€ä¸ªæ„æ€ï¼Œé»˜è®¤true;</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’Œä¸Šä¸€ä¸ªæ³¨è§£çš„åŸç†ç±»ä¼¼ï¼Œè¿™ä¸ªæ³¨è§£ä¹Ÿæ˜¯ç”¨åœ¨ @Entity çš„å®ä½“ä¸­ï¼Œå¦‚æœåŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼Œå°±è¡¨ç¤ºç”Ÿæˆçš„ update SQL çš„ Columns åªåŒ…å«éç©ºçš„å­—æ®µï¼›<strong>å¦‚æœä¸åŠ è¿™ä¸ªæ³¨è§£ï¼Œé»˜è®¤çš„æƒ…å†µæ˜¯ç©ºçš„å­—æ®µä¹Ÿä¼šä½œä¸º update è¯­å¥é‡Œé¢çš„ Columns</strong>ã€‚</p>
<h3 id="ä¸¾ä¾‹-4"><a href="#ä¸¾ä¾‹-4" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><p>ç¬¬ä¸€æ­¥ï¼šä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ User å®ä½“ï¼šåŠ ä¸Š <code>@DynamicInsert</code> å’Œ <code>@DynamicUpdate</code> æ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DynamicInsert</span></span><br><span class="line"><span class="meta">@DynamicUpdate</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">   <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">   <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">   <span class="keyword">private</span> Integer age;</span><br><span class="line">......&#125;<span class="comment">//å…¶ä»–ä¸å˜çš„ä¿¡æ¯çœç•¥</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šUserInfo å®ä½“è¿˜ä¿æŒä¸å˜ï¼Œå³æ²¡æœ‰åŠ ä¸Š <code>@DynamicInsert</code> å’Œ <code>@DynamicUpdate</code> æ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šæˆ‘ä»¬åœ¨ UserController é‡Œé¢æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯•æ–°å¢å’Œæ›´æ–° Userã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userRepository.save(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šåœ¨ UserInfoController é‡Œé¢æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯•æ–°å¢å’Œæ›´æ–° UserInfoã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/user/info&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">saveUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.save(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äº”æ­¥ï¼šæµ‹è¯•ä¸€ä¸‹ UserControllerçš„ post çš„ user æƒ…å†µï¼Œçœ‹ä¸€ä¸‹ insert çš„æƒ…å†µã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#### é€šè¿‡postæµ‹è¯•insert</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/user</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8089</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span><span class="punctuation">: </span>56d8dc02-7f3e-7b95-7ff1-572a4bb7d102</span><br><span class="line">&#123;&quot;ages&quot;:10, &quot;name&quot;:&quot;jack&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶ï¼Œå‘é€ä¸€ä¸ª post è¯·æ±‚ï¼Œåªå¸¦ ages å’Œ name å­—æ®µï¼Œè€Œå¹¶æ²¡æœ‰å¸¦ä¸Š User å®ä½“é‡Œé¢çš„å…¶ä»–å­—æ®µï¼Œç”Ÿæˆçš„ SQL å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (create_time, last_modified_time, version, name, id) <span class="keyword">values</span> (?, ?, ?, ?, ?)</span><br></pre></td></tr></table></figure>

<p>é™¤äº† BaseEntity é‡Œé¢çš„ä¸€äº›åŸºç¡€å­—æ®µï¼Œè€Œå…¶ä»–å­—æ®µå¹¶æ²¡æœ‰ç”Ÿæˆåˆ° insert è¯­å¥é‡Œé¢ã€‚</p>
<p>ç¬¬å…­æ­¥ï¼šæˆ‘ä»¬å†æµ‹è¯•ä¸€ä¸‹ user çš„ update æƒ…å†µã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#### è¿˜æ˜¯å‘ç”Ÿpostè¯·æ±‚ï¼Œå¸¦ä¸ŠIDå’Œversionæ‰§è¡Œupdateæ“ä½œ</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/user</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8089</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span><span class="punctuation">: </span>56d8dc02-7f3e-7b95-7ff1-572a4bb7d102</span><br><span class="line">&#123;&quot;ages&quot;:10,&quot;name&quot;:&quot;jack1&quot;,&quot;id&quot;:1,&quot;version&quot;:0&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶çœ‹åˆ°ï¼Œupdate å’Œ insert çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼Œå½“ Entity é‡Œé¢æœ‰ version å­—æ®µçš„æ—¶å€™ï¼Œæˆ‘ä»¬å†å¸¦ä¸Š version å’Œ id å°±ä¼šæ˜¾ç¤ºä¸º updateï¼Œå†çœ‹ä¸€ä¸‹è°ƒç”¨å®Œä¹‹åçš„ sqlï¼šç”¨ä¸€æ¡ select æŸ¥è¯¢ä¸€ä¸‹å®ä½“æ˜¯å¦å­˜åœ¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="keyword">select</span> user0_.id <span class="keyword">as</span> id1_1_0_, user0_.create_time <span class="keyword">as</span> create_t2_1_0_, user0_.create_user_id <span class="keyword">as</span> create_u3_1_0_, user0_.last_modified_time <span class="keyword">as</span> last_mod4_1_0_, user0_.last_modified_user_id <span class="keyword">as</span> last_mod5_1_0_, user0_.version <span class="keyword">as</span> version6_1_0_, user0_.age <span class="keyword">as</span> age7_1_0_, user0_.deleted <span class="keyword">as</span> deleted8_1_0_, user0_.email <span class="keyword">as</span> email9_1_0_, user0_.name <span class="keyword">as</span> name10_1_0_, user0_.sex <span class="keyword">as</span> sex11_1_0_ <span class="keyword">from</span> <span class="keyword">user</span> user0_ <span class="keyword">where</span> user0_.id<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¸€æ¡ update åŠ¨æ€æ›´æ–°äº†æˆ‘ä»¬ä¼ é€’çš„é‚£äº›å€¼ï¼Œè€Œä¸æ›´æ–° null çš„å­—æ®µï¼Œå¹¶ä¸”åªæ›´æ–°æœ‰å˜åŒ–çš„å­—æ®µï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: update <span class="keyword">user</span> <span class="keyword">set</span> last_modified_time<span class="operator">=</span>?, version<span class="operator">=</span>?, name<span class="operator">=</span>? <span class="keyword">where</span> id<span class="operator">=</span>? <span class="keyword">and</span> version<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸ƒæ­¥ï¼šé‚£ä¹ˆæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ UserInfo çš„ insert æ–¹æ³•ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#### insert</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/user/info</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8089</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span><span class="punctuation">: </span>56d8dc02-7f3e-7b95-7ff1-572a4bb7d102</span><br><span class="line">&#123;&quot;ages&quot;:10&#125;</span><br></pre></td></tr></table></figure>

<p>å‘é€ä¸€ä¸ª post çš„ insert æ“ä½œï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ SQLï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="keyword">insert</span> <span class="keyword">into</span> user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, telephone, id) <span class="keyword">values</span> (?, ?, ?, ?, ?, ?, ?, ?)</span><br></pre></td></tr></table></figure>

<p>å‘ç°æ— è®ºæœ‰æ²¡æœ‰ä¼ é€’å€¼ï¼Œæ¯ä¸ªå­—æ®µéƒ½åšäº† insertï¼Œæ²¡æœ‰ä¼ é€’çš„è¯ä¼šç”¨ null ä»£æ›¿ã€‚<br>ç¬¬å…«æ­¥ï¼šæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ UserInfo çš„ update æ–¹æ³•ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#### update</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/user/info</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8089</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Postman-Token</span><span class="punctuation">: </span>56d8dc02-7f3e-7b95-7ff1-572a4bb7d102</span><br><span class="line">&#123;&quot;ages&quot;:10,&quot;id&quot;:1,&quot;version&quot;:0&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: update user_info <span class="keyword">set</span> create_time<span class="operator">=</span>?, create_user_id<span class="operator">=</span>?, last_modified_time<span class="operator">=</span>?, last_modified_user_id<span class="operator">=</span>?, version<span class="operator">=</span>?, ages<span class="operator">=</span>?, telephone<span class="operator">=</span>? <span class="keyword">where</span> id<span class="operator">=</span>? <span class="keyword">and</span> version<span class="operator">=</span>?</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ update çš„ SQL å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿åªä¼ é€’äº† ages çš„å€¼ï¼Œå®ƒä¹Ÿä¼šæŠŠæˆ‘ä»¬æ²¡æœ‰ä¼ é€’çš„ telephone æ›´æ–°æˆ nullã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­åº”è¯¥èƒ½å¼„æ¸…æ¥š <code>@DynamicInsert</code> å’Œ <code>@DynamicUpdate</code> æ³¨è§£ä½œç”¨ï¼Œåœ¨å†™ API çš„æ—¶å€™å°±è¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦éœ€è¦å¯¹ null çš„å­—æ®µè¿›è¡Œæ“ä½œã€‚</p>
<h2 id="Spring-Data-å¯¹ç³»ç»Ÿç›‘æ§åšäº†å“ªäº›æ”¯æŒï¼Ÿ"><a href="#Spring-Data-å¯¹ç³»ç»Ÿç›‘æ§åšäº†å“ªäº›æ”¯æŒï¼Ÿ" class="headerlink" title="Spring Data å¯¹ç³»ç»Ÿç›‘æ§åšäº†å“ªäº›æ”¯æŒï¼Ÿ"></a>Spring Data å¯¹ç³»ç»Ÿç›‘æ§åšäº†å“ªäº›æ”¯æŒï¼Ÿ</h2><p>æˆ‘ä»¬æ—¢ç„¶åšäº† MVCï¼Œä¸€å®šä¹Ÿå…ä¸äº†è¦å¯¹ç³»ç»Ÿè¿›è¡Œç›‘æ§ï¼Œé‚£ä¹ˆæ€ä¹ˆçœ‹ç›‘æ§æŒ‡æ ‡å‘¢ï¼Ÿ</p>
<p>å¯¹æ•°æ®å±‚é¢çš„ç³»ç»Ÿè¿›è¡Œç›‘æ§ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p>æ–¹æ³•ä¸€ï¼š/actuator/health çš„æ”¯æŒï¼Œé‡Œé¢ä¼šæ£€æŸ¥ DB çš„çŠ¶æ€ã€‚</p>
<p><img src="http://image.leonote.cn/20201112173642.png" alt=""></p>
<p>æ–¹æ³•äºŒï¼š/actuator/prometheus é‡Œé¢ä¼šåŒ…å«ä¸€äº› Hibernate å’Œ Datasource çš„ metricã€‚</p>
<p><img src="http://image.leonote.cn/20201112173723.png" alt=""></p>
<p>è¿™ä¸ªæ–¹æ³•åœ¨æˆ‘ä»¬åš grafana å›¾è¡¨çš„æ—¶å€™ä¼šå¾ˆæœ‰ç”¨ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ol>
<li><p>å¼€å¯ prometheus éœ€è¦ gradle é¢å¤–å¼•å…¥ä¸‹é¢è¿™ä¸ªåŒ…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">implementation &#39;io.micrometer:micrometer-registry-prometheus&#39;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¼€å¯ Hibernate çš„ statistics éœ€è¦é…ç½®å¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.jpa.properties.hibernate.generate_statistics</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">management.endpoint.prometheus.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa @Entityçš„å›è°ƒæ–¹æ³•</title>
    <url>/2020/11/09/SpringDataJpa%E7%9A%84@Entity%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h1 id="Entity-çš„å›è°ƒæ–¹æ³•"><a href="#Entity-çš„å›è°ƒæ–¹æ³•" class="headerlink" title="@Entity çš„å›è°ƒæ–¹æ³•"></a>@Entity çš„å›è°ƒæ–¹æ³•</h1><h2 id="JPA-çš„-Callbacks-æœ‰å“ªäº›"><a href="#JPA-çš„-Callbacks-æœ‰å“ªäº›" class="headerlink" title="JPA çš„ Callbacks æœ‰å“ªäº›"></a>JPA çš„ Callbacks æœ‰å“ªäº›</h2><p>JPA åè®®é‡Œé¢è§„å®šï¼Œå¯ä»¥é€šè¿‡ä¸€äº›æ³¨è§£ï¼Œä¸ºå…¶ç›‘å¬å›è°ƒäº‹ä»¶ã€æŒ‡å®šå›è°ƒæ–¹æ³•ã€‚</p>
<p>å›è°ƒäº‹ä»¶æ³¨è§£è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>@PrePersist</code></td>
<td>EntityManager.persist æ–¹æ³•è°ƒç”¨ä¹‹å‰çš„å›è°ƒæ³¨è§£ï¼Œå³æ–°å¢ä¹‹å‰è°ƒç”¨</td>
</tr>
<tr>
<td><code>@PostPersist</code></td>
<td>EntityManager.persist æ–¹æ³•ä¹‹åè°ƒç”¨çš„å›è°ƒæ³¨è§£ï¼ŒEntityManager.flush æˆ– EntityManager.commit æ–¹æ³•ä¹‹åè°ƒç”¨çš„æ­¤æ–¹æ³•ï¼Œå³ä¿å­˜åˆ°æ•°æ®åº“ä¹‹åè¿›è¡Œè°ƒç”¨</td>
</tr>
<tr>
<td><code>@PreRemove</code></td>
<td>EntityManager.remove ä¹‹å‰è°ƒç”¨çš„å›è°ƒæ³¨è§£ï¼Œå³åˆ é™¤ä¹‹å‰è°ƒç”¨</td>
</tr>
<tr>
<td><code>@PostRemove</code></td>
<td>EntityManager.remove ä¹‹åè°ƒç”¨çš„å›è°ƒæ³¨è§£ï¼Œå³åˆ é™¤ä¹‹åè°ƒç”¨</td>
</tr>
<tr>
<td><code>@PreUpdate</code></td>
<td>åœ¨å®ä½“æ›´æ–°ä¹‹å‰è°ƒç”¨ï¼Œæ‰€è°“çš„æ›´æ–°èµ·å§‹æ˜¯åœ¨mergeä¹‹åï¼Œå®ä½“å‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸€æ³¨è§£å¯ä»¥åœ¨å˜åŒ–å‚¨å­˜åˆ°æ•°æ®åº“ä¹‹å‰è°ƒç”¨</td>
</tr>
<tr>
<td><code>@PostUpdate</code></td>
<td>åœ¨å®ä½“æ›´æ–°ä¹‹åè°ƒç”¨ï¼Œå³å®ä½“çš„å­—æ®µçš„å€¼å˜åŒ–ä¹‹åï¼Œåœ¨è°ƒç”¨EntityManager.flush æˆ– EntityManager.commit æ–¹æ³•ä¹‹åè°ƒç”¨çš„æ­¤æ–¹æ³•</td>
</tr>
<tr>
<td><code>@postLoad</code></td>
<td>åœ¨å®ä½“ä»DBåŠ è½½åˆ°ç¨‹åºé‡Œé¢ä¹‹åå›è°ƒ</td>
</tr>
</tbody></table>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><strong>å›è°ƒå‡½æ•°</strong>éƒ½æ˜¯å’Œ EntityManager.flush æˆ– EntityManager.commit åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œé¢æ‰§è¡Œçš„ï¼Œåªä¸è¿‡è°ƒç”¨æ–¹æ³•æœ‰å…ˆåä¹‹åˆ†ï¼Œéƒ½æ˜¯åŒæ­¥è°ƒç”¨ï¼Œæ‰€ä»¥å½“ä»»ä½•ä¸€ä¸ªå›è°ƒæ–¹æ³•é‡Œé¢å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½ä¼šè§¦å‘äº‹åŠ¡è¿›è¡Œå›æ»šï¼Œè€Œä¸ä¼šè§¦å‘äº‹åŠ¡æäº¤ã€‚</li>
<li>Callbacks æ³¨è§£å¯ä»¥æ”¾åœ¨å®ä½“é‡Œé¢ï¼Œå¯ä»¥æ”¾åœ¨ super-class é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨ Entity çš„ listener é‡Œé¢ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ”¾åœ¨å®ä½“ï¼ˆæˆ–è€… super-classï¼‰é‡Œé¢çš„æ–¹æ³•ï¼Œç­¾åæ ¼å¼ä¸ºâ€œvoid ()â€ï¼Œå³æ²¡æœ‰å‚æ•°ï¼Œæ–¹æ³•é‡Œé¢æ“ä½œçš„æ˜¯ this å¯¹è±¡è‡ªå·±ï¼›æ”¾åœ¨å®ä½“çš„ Entity Listener é‡Œé¢çš„æ–¹æ³•ç­¾åæ ¼å¼ä¸ºâ€œvoid (Object)â€ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•å¯ä»¥æœ‰å‚æ•°ï¼Œå‚æ•°æ˜¯ä»£è¡¨ç”¨æ¥æ¥æ”¶å›è°ƒæ–¹æ³•çš„å®ä½“ã€‚</li>
<li>ä¸Šè¿°æ³¨è§£ç”Ÿæ•ˆçš„å›è°ƒæ–¹æ³•å¯ä»¥æ˜¯ publicã€privateã€protectedã€friendly ç±»å‹çš„ï¼Œä½†æ˜¯ä¸èƒ½æ˜¯ static å’Œ final ç±»å‹çš„æ–¹æ³•ã€‚</li>
</ul>
</blockquote>
<h2 id="JPA-Callbacks-çš„ä½¿ç”¨æ–¹æ³•"><a href="#JPA-Callbacks-çš„ä½¿ç”¨æ–¹æ³•" class="headerlink" title="JPA Callbacks çš„ä½¿ç”¨æ–¹æ³•"></a>JPA Callbacks çš„ä½¿ç”¨æ–¹æ³•</h2><h3 id="åœ¨å®ä½“å’Œ-super-class-ä¸­ä½¿ç”¨"><a href="#åœ¨å®ä½“å’Œ-super-class-ä¸­ä½¿ç”¨" class="headerlink" title="åœ¨å®ä½“å’Œ super-class ä¸­ä½¿ç”¨"></a>åœ¨å®ä½“å’Œ super-class ä¸­ä½¿ç”¨</h3><p>ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ <code>BaseEntity</code>ï¼Œåœ¨é‡Œé¢æ–°å¢å›è°ƒå‡½æ•°å’Œæ³¨è§£ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.base;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.domain.support.AuditingEntityListener;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="meta">@EntityListeners(AuditingEntityListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line"><span class="comment">// @CreatedBy è¿™ä¸ªå¯èƒ½ä¼šè¢« AuditingEntityListener è¦†ç›–ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå…ˆæ³¨é‡Šæ‰</span></span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="meta">@CreatedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant createTime;</span><br><span class="line">   <span class="meta">@LastModifiedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line">   <span class="meta">@LastModifiedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant lastModifiedTime;</span><br><span class="line"><span class="comment">//  @Version ç”±äºæœ¬èº«æœ‰ä¹è§‚é”æœºåˆ¶ï¼Œè¿™ä¸ªæµ‹è¯•çš„æ—¶å€™å…ˆæ³¨é‡Šæ‰ï¼Œæ”¹ç”¨æ‰‹åŠ¨è®¾ç½®çš„å€¼ï¼›</span></span><br><span class="line">   <span class="keyword">private</span> Integer version;</span><br><span class="line">   <span class="meta">@PreUpdate</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;preUpdate::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">      <span class="keyword">this</span>.setCreateUserId(<span class="number">200</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostUpdate</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;postUpdate::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PreRemove</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preRemove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;preRemove::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostRemove</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postRemove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;postRemove::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostLoad</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postLoad</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;postLoad::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº†<code>@PreUpdate</code>ã€<code>@PostUpdate</code>ã€<code>@PreRemove</code>ã€<code>@PostRemove</code>ã€<code>@PostLoad</code> å‡ ä¸ªæ³¨è§£ï¼Œå¹¶åœ¨ç›¸åº”çš„å›è°ƒæ–¹æ³•é‡Œé¢åŠ äº†ç›¸åº”çš„æ—¥å¿—ã€‚å¹¶ä¸”åœ¨ <code>@PreUpdate</code> æ–¹æ³•é‡Œé¢ä¿®æ”¹äº† create_user_id çš„å€¼ä¸º 200ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åç»­æµ‹è¯•ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ä¸€ä¸‹ User ç±»ï¼Œä¹Ÿæ–°å¢ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”å’Œ <code>BaseEntity</code> åšæ³•ä¸€æ ·</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.example1.base.BaseEntity;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonIgnore;</span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addresses&quot;,callSuper = true)</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;<span class="comment">// implements Auditable&lt;Integer,Long, Instant&gt; &#123;</span></span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">   <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">   <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">   <span class="keyword">private</span> Integer age;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;user&quot;)</span></span><br><span class="line">   <span class="meta">@JsonIgnore</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;UserAddress&gt; addresses;</span><br><span class="line">   <span class="keyword">private</span> Boolean deleted;</span><br><span class="line">   <span class="meta">@PrePersist</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prePersist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;prePersist::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">      <span class="keyword">this</span>.setVersion(<span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostPersist</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postPersist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;postPersist::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨äº† <code>@PrePersist</code>ã€<code>@PostPersist</code> å›è°ƒäº‹ä»¶ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ <code>@PrePersist</code> é‡Œé¢å°† version ä¿®æ”¹ä¸º 1ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼šå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span></span><br><span class="line"><span class="meta">@Import(JpaConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    MyAuditorAware myAuditorAware;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸ºäº†å’Œæµ‹è¯•æ–¹æ³•çš„äº‹åŠ¡åˆ†å¼€ï¼Œæˆ‘ä»¬åœ¨ init é‡Œé¢åˆå§‹åŒ–æ•°æ®åšæ–°å¢æ“ä½œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@BeforeAll</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ç”±äºæµ‹è¯•ç”¨ä¾‹æ¨¡æ‹Ÿ web context ç¯å¢ƒï¼Œè¿™é‡Œåˆ©ç”¨ @MockBeanï¼Œmockæ‰æ–¹æ³•ï¼ŒæœŸå¾…è¿”å›13è¿™ä¸ªç”¨æˆ·ID</span></span><br><span class="line">       Mockito.when(myAuditorAware.getCurrentAuditor()).thenReturn(Optional.of(<span class="number">13</span>));</span><br><span class="line">        User u1 = User.builder()</span><br><span class="line">                .name(<span class="string">&quot;jack&quot;</span>)</span><br><span class="line">                .email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                .sex(SexEnum.BOY)</span><br><span class="line">                .age(<span class="number">20</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//æ²¡æœ‰saveä¹‹å‰ versionæ˜¯null</span></span><br><span class="line">        Assertions.assertNull(u1.getVersion());</span><br><span class="line">        userRepository.save(u1);</span><br><span class="line">        <span class="comment">//è¿™é‡Œé¢è§¦å‘ä¿å­˜æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°†versionè®¾ç½®æˆäº†1ï¼Œç„¶åéªŒè¯ä¸€ä¸‹</span></span><br><span class="line">        Assertions.assertEquals(<span class="number">1</span>,u1.getVersion());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æµ‹è¯•ä¸€ä¸‹æ›´æ–°å’ŒæŸ¥è¯¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCallBackUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æ­¤æ—¶ä¼šè§¦å‘@PostLoadäº‹ä»¶</span></span><br><span class="line">        User u1 = userRepository.getOne(<span class="number">1L</span>);</span><br><span class="line">        <span class="comment">//ä»dbé‡Œé¢é‡æ–°æŸ¥è¯¢å‡ºæ¥ï¼ŒéªŒè¯ä¸€ä¸‹versionæ˜¯ä¸æ˜¯1</span></span><br><span class="line">        Assertions.assertEquals(<span class="number">1</span>,u1.getVersion());</span><br><span class="line">        u1.setSex(SexEnum.GIRL);</span><br><span class="line">        <span class="comment">//æ­¤æ—¶ä¼šè§¦å‘@PreUpdateäº‹ä»¶</span></span><br><span class="line">        userRepository.save(u1);</span><br><span class="line">        List&lt;User&gt; u3 = userRepository.findAll();</span><br><span class="line">        u3.stream().forEach(u-&gt;&#123;</span><br><span class="line">            <span class="comment">//ä»dbæŸ¥è¯¢å‡ºæ¥ï¼ŒéªŒè¯ä¸€ä¸‹CreateUserIdæ˜¯å¦ä¸ºæˆ‘ä»¬åˆšæ‰ä¿®æ”¹çš„200</span></span><br><span class="line">           Assertions.assertEquals(<span class="number">200</span>,u.getCreateUserId());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æµ‹è¯•ä¸€ä¸‹åˆ é™¤äº‹ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCallBackDelete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æ­¤æ—¶ä¼šè§¦å‘@PostLoadäº‹ä»¶</span></span><br><span class="line">        User u1 = userRepository.getOne(<span class="number">1L</span>);</span><br><span class="line">        Assertions.assertEquals(<span class="number">200</span>,u1.getCreateUserId());</span><br><span class="line">        userRepository.delete(u1);</span><br><span class="line">        <span class="comment">//æ­¤æ—¶ä¼šè§¦å‘@PreRemoveã€@PostRemoveäº‹ä»¶</span></span><br><span class="line">        System.out.println(<span class="string">&quot;delete_after::&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æµ‹è¯•ç”¨ä¾‹éªŒè¯äº†å›è°ƒå‡½æ•°çš„äº‹ä»¶åï¼Œçœ‹ä¸€ä¸‹è¾“å‡ºçš„ SQL å’Œæ—¥å¿—ï¼š</p>
<p><img src="http://image.leonote.cn/20201109133706.png" alt=""></p>
<p>é€šè¿‡ä¸Šå›¾çš„æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°å“åº”çš„å›è°ƒå‡½æ•°è¢«è§¦å‘äº†ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°æ‰§è¡Œé¡ºåºä¸ºï¼š</p>
<ul>
<li>ä¿å­˜ï¼šPrePersist -&gt; Insert -&gt; PostPersist</li>
<li>æŸ¥è¯¢ï¼šSelect -&gt; PostLoad</li>
<li>æ›´æ–°ï¼šPreUpdate -&gt; Update -&gt; PostUpdate</li>
<li>åˆ é™¤ï¼šPreRemove -&gt; Remove -&gt; PostRemove</li>
</ul>
<p>è‹¥å›è°ƒå‡½æ•°é‡Œé¢å‘ç”Ÿå¼‚å¸¸ï¼Œæ•°æ®ä¼šå›æ»šï¼Œå¦‚åœ¨<code>@PostPersist</code>çš„æ–¹æ³•é‡ŒæŠ›å¼‚å¸¸</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostPersist</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postPersist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   System.out.println(<span class="string">&quot;postPersist::&quot;</span>+<span class="keyword">this</span>.toString());</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;jack test exception transactional roll back&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†è·‘æµ‹è¯•ç”¨ä¾‹å°±ä¼šå‘ç°ï¼Œå…¶ä¸­å‘ç”Ÿäº† <code>RollbackException</code> å¼‚å¸¸ï¼Œè¿™æ ·çš„è¯æ•°æ®æ˜¯ä¸ä¼šæäº¤åˆ° DB é‡Œé¢çš„ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´æ•°æ®è¿›è¡Œå›æ»šï¼Œåé¢çš„ä¸šåŠ¡æµç¨‹æ— æ³•æ‰§è¡Œä¸‹å»ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Could not commit JPA transaction; nested exception is javax.persistence.RollbackException: Error while committing the transaction</span><br><span class="line">org.springframework.transaction.TransactionSystemException: Could not commit JPA transaction; nested exception is javax.persistence.RollbackException: Error while committing the transaction</span><br></pre></td></tr></table></figure>


<p>æ‰€ä»¥åœ¨ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œä½ è¦æ³¨æ„è€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œé¿å…ä¸å¿…è¦çš„éº»çƒ¦ã€‚</p>
<h3 id="è‡ªå®šä¹‰-EntityListener"><a href="#è‡ªå®šä¹‰-EntityListener" class="headerlink" title="è‡ªå®šä¹‰ EntityListener"></a>è‡ªå®šä¹‰ EntityListener</h3><p>ç¬¬ä¸€æ­¥ï¼šè‡ªå®šä¹‰ä¸€ä¸ª <code>EntityLoggingListener</code> ç”¨æ¥è®°å½•æ“ä½œæ—¥å¿—ï¼Œé€šè¿‡ listener çš„æ–¹å¼é…ç½®å›è°ƒå‡½æ•°æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.base;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.example1.User;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityLoggingListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prePersist</span><span class="params">(BaseEntity entity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//entity.setVersion(1); å¦‚æœæ³¨é‡Šäº†ï¼Œæµ‹è¯•ç”¨ä¾‹è¿™ä¸ªåœ°æ–¹çš„éªŒè¯ä¹Ÿéœ€è¦å»æ‰</span></span><br><span class="line">        log.info(<span class="string">&quot;prePersist::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostPersist</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postPersist</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;postPersist::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PreUpdate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preUpdate</span><span class="params">(BaseEntity entity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//entity.setCreateUserId(200); å¦‚æœæ³¨é‡Šäº†ï¼Œæµ‹è¯•ç”¨ä¾‹è¿™ä¸ªåœ°æ–¹çš„éªŒè¯ä¹Ÿéœ€è¦å»æ‰</span></span><br><span class="line">        log.info(<span class="string">&quot;preUpdate::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostUpdate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postUpdate</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;postUpdate::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PreRemove</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preRemove</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;preRemove::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostRemove</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postRemove</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;postRemove::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostLoad</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postLoad</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æŸ¥è¯¢æ–¹æ³•é‡Œé¢å¯ä»¥å¯¹ä¸€äº›æ•æ„Ÿä¿¡æ¯åšä¸€äº›æ—¥å¿—</span></span><br><span class="line">        <span class="keyword">if</span> (User.class.isInstance(entity)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;postLoad::&#123;&#125;&quot;</span>,entity.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>åœ¨è¿™ä¸€æ­¥éª¤ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<p>ä¸Šé¢æ³¨é‡Šçš„ä»£ç ï¼Œä¹Ÿå¯ä»¥æ”¹å˜ entity é‡Œé¢çš„å€¼ï¼Œä½†æ˜¯åœ¨è¿™ä¸ª Listener çš„é‡Œé¢æˆ‘ä»¬ä¸åšä¿®æ”¹ï¼Œæ‰€ä»¥æŠŠ <code>setVersion</code> å’Œ <code>setCreateUserId</code> æ³¨é‡Šæ‰äº†ï¼Œè¦æ³¨æ„æµ‹è¯•ç”¨ä¾‹é‡Œé¢è¿™ä¸¤å¤„ä¹Ÿéœ€è¦ä¿®æ”¹ã€‚</p>
<p>å¦‚æœåœ¨ <code>@PostLoad</code> é‡Œé¢è®°å½•æ—¥å¿—ï¼Œä¸ä¸€å®šæ¯ä¸ªå®ä½“ã€æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦è®°å½•æ—¥å¿—ï¼Œåªéœ€è¦å¯¹ä¸€äº›æ•æ„Ÿçš„å®ä½“æˆ–è€…å­—æ®µåšæ—¥å¿—è®°å½•å³å¯ã€‚</p>
<p>å›è°ƒå‡½æ•°æ—¶å¯ä»¥åŠ ä¸Šå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥æ˜¯çˆ¶ç±» Objectï¼Œå¯ä»¥æ˜¯ <code>BaseEntity</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“çš„æŸä¸€ä¸ªå®ä½“ï¼›æ¨èç”¨ <code>BaseEntity</code>ï¼Œå› ä¸ºè¿™æ ·çš„æ–¹æ³•æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå®ƒå¯ä»¥çº¦å®šä¸€äº›æ¡†æ¶é€»è¾‘ï¼Œæ¯”å¦‚ <code>getCreateUserId</code>ã€<code>getLastModifiedUserId</code> ç­‰ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚</p>
<p>è¿™æ¬¡æ‰§è¡Œ <code>testCallBackDelete()</code>ï¼Œçœ‹çœ‹ä¼šå¾—åˆ°ä»€ä¹ˆæ ·çš„æ•ˆæœã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">2020-10-05 13:55:19.332Â  INFO 62541 --- [Â  Â  Test worker] c.e.j.e.base.EntityLoggingListenerÂ  Â  Â  Â : prePersist::User(super=BaseEntity(id=null, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=null), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)</span><br><span class="line">2020-10-05 13:55:19.449Â  INFO 62541 --- [Â  Â  Test worker] c.e.j.e.base.EntityLoggingListenerÂ  Â  Â  Â : postPersist::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)</span><br><span class="line">2020-10-05 13:55:19.698Â  INFO 62541 --- [Â  Â  Test worker] c.e.j.e.base.EntityLoggingListenerÂ  Â  Â  Â : postLoad::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)</span><br><span class="line">2020-10-05 13:55:19.719Â  INFO 62541 --- [Â  Â  Test worker] c.e.j.e.base.EntityLoggingListenerÂ  Â  Â  Â : preRemove::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)</span><br><span class="line">2020-10-05 13:55:19.798Â  INFO 62541 --- [Â  Â  Test worker] c.e.j.e.base.EntityLoggingListenerÂ  Â  Â  Â : postRemove::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ—¥å¿—æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ° callback æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒåŠå…¶å®ä½“å‚æ•°çš„å€¼ã€‚ä½ å°±ä¼šå‘ç°ï¼ŒåŸæ¥è‡ªå®šä¹‰ <code>EntityListener</code> å›è°ƒå‡½æ•°çš„æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ç®€å•ã€‚</p>
<p>ç»†å¿ƒçš„ä½ è¿™ä¸ªæ—¶å€™å¯èƒ½ä¹Ÿä¼šå‘ç°ï¼Œæˆ‘ä»¬ä¸Šé¢å…¶å®åº”ç”¨äº†ä¸¤ä¸ª <code>EntityListener</code>ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ <code>@EntityListeners</code> æœ‰ä¸ªåŠ è½½é¡ºåºçš„é—®é¢˜ï¼Œä½ éœ€è¦é‡ç‚¹æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p><strong>å…³äº <code>@EntityListeners</code> åŠ è½½é¡ºåºçš„è¯´æ˜</strong></p>
<ul>
<li><p>é»˜è®¤å¦‚æœå­ç±»å’Œçˆ¶ç±»éƒ½æœ‰ <code>EntityListeners</code>ï¼Œé‚£ä¹ˆ listeners ä¼šæŒ‰ç…§åŠ è½½çš„é¡ºåºæ‰§è¡Œæ‰€æœ‰ <code>EntityListeners</code>ï¼›</p>
</li>
<li><p><code>EntityListeners</code> å’Œå®ä½“é‡Œé¢çš„å›è°ƒå‡½æ•°æ³¨è§£å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œä½†éœ€è¦æ³¨æ„é¡ºåºé—®é¢˜ï¼›</p>
</li>
<li><p>å¦‚æœæˆ‘ä»¬ä¸æƒ³åŠ è½½ super-class é‡Œé¢çš„<code>EntityListeners</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨è§£ <code>@ExcludeSuperclassListeners</code>ï¼Œæ’é™¤æ‰€æœ‰çˆ¶ç±»é‡Œé¢çš„å®ä½“ç›‘å¬è€…ï¼Œéœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†åœ¨å­ç±»å®ä½“é‡Œé¢é‡æ–°å¼•å…¥å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExcludeSuperclassListeners</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="JPA-Callbacks-çš„æœ€ä½³å®è·µ"><a href="#JPA-Callbacks-çš„æœ€ä½³å®è·µ" class="headerlink" title="JPA Callbacks çš„æœ€ä½³å®è·µ"></a>JPA Callbacks çš„æœ€ä½³å®è·µ</h2><p>ä¸ªäººç»éªŒæ€»ç»“äº†å‡ ä¸ªæœ€ä½³å®è·µ</p>
<ol>
<li><p>å›è°ƒå‡½æ•°é‡Œé¢åº”å°½é‡é¿å…ç›´æ¥æ“ä½œä¸šåŠ¡ä»£ç ï¼Œæœ€å¥½ç”¨ä¸€äº›å…·æœ‰æ¡†æ¶æ€§çš„å…¬ç”¨ä»£ç ï¼Œå¦‚ Auditing æˆ– å®ä½“æ“ä½œæ—¥å¿— ç­‰ï¼›</p>
</li>
<li><p>æ³¨æ„å›è°ƒå‡½æ•°æ–¹æ³•è¦åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡Œï¼Œå¼‚å¸¸è¦å¯é¢„æœŸï¼Œéå¯é¢„æœŸçš„å¼‚å¸¸è¦è¿›è¡Œæ•è·ï¼Œä»¥å…å‡ºç°æ„æƒ³ä¸åˆ°çš„çº¿ä¸Š Bugï¼›</p>
</li>
<li><p>å›è°ƒå‡½æ•°æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œå¦‚æœä¸€äº›è®¡ç®—é‡å¤§çš„å’Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡å‘æ¶ˆæ¯ç­‰æœºåˆ¶å¼‚æ­¥å¤„ç†ï¼Œä»¥å…é˜»å¡ä¸»æµç¨‹ï¼Œå½±å“æ¥å£çš„æ€§èƒ½ã€‚æ¯”å¦‚ä¸Šé¢è¯´çš„æ—¥å¿—ï¼Œå¦‚æœæˆ‘ä»¬è¦å°†å…¶è®°å½•åˆ°æ•°æ®åº“é‡Œé¢ï¼Œå¯ä»¥åœ¨å›è°ƒæ–¹æ³•é‡Œé¢å‘ä¸ªæ¶ˆæ¯ï¼Œæ”¹è¿›ä¹‹åå°†å˜æˆå¦‚ä¸‹æ ¼å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditLoggingListener</span> </span>&#123;</span><br><span class="line">   <span class="meta">@PostLoad</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postLoad</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.notice(entity, OperateType.load);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostPersist</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postPersist</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.notice(entity, OperateType.create);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostRemove</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PostRemove</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.notice(entity, OperateType.remove);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PostUpdate</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">PostUpdate</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.notice(entity, OperateType.update);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notice</span><span class="params">(Object entity, OperateType type)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//æˆ‘ä»¬é€šè¿‡active mq å¼‚æ­¥å‘å‡ºæ¶ˆæ¯å¤„ç†äº‹ä»¶</span></span><br><span class="line">      ActiveMqEventManager.notice(<span class="keyword">new</span> ActiveMqEvent(type, entity));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Getter</span></span><br><span class="line">   <span class="class"><span class="keyword">enum</span> <span class="title">OperateType</span> </span>&#123;</span><br><span class="line">      create(<span class="string">&quot;åˆ›å»º&quot;</span>), remove(<span class="string">&quot;åˆ é™¤&quot;</span>),update(<span class="string">&quot;ä¿®æ”¹&quot;</span>),load(<span class="string">&quot;æŸ¥è¯¢&quot;</span>);</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line">      OperateType(String description) &#123;</span><br><span class="line">         <span class="keyword">this</span>.description=description;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨å›è°ƒå‡½æ•°é‡Œé¢ï¼Œå°½é‡ä¸è¦ç›´æ¥åœ¨æ“ä½œ <code>EntityManager</code> åå†åš session çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å…¶ä»–æŒä¹…åŒ–æ“ä½œï¼Œä»¥å…ç ´åäº‹åŠ¡çš„å¤„ç†æµç¨‹ï¼›ä¹Ÿä¸è¦è¿›è¡Œå…¶ä»–é¢å¤–çš„å…³è”å…³ç³»æ›´æ–°åŠ¨ä½œï¼Œä¸šåŠ¡æ€§çš„ä»£ç ä¸€å®šè¦æ”¾åœ¨ service å±‚é¢ï¼Œå¦åˆ™å¤ªè¿‡å¤æ‚ï¼Œæ—¶é—´é•¿äº†ä»£ç å¾ˆéš¾ç»´æŠ¤ï¼›</p>
</li>
<li><p>å›è°ƒå‡½æ•°é‡Œé¢æ¯”è¾ƒé€‚åˆç”¨ä¸€äº›è®¡ç®—å‹çš„transientæ–¹æ³•ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªæ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prePersist</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡ä¸€äº›é€»è¾‘è®¡ç®—å¹´é¾„ï¼›</span></span><br><span class="line">        user.calculationAge();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>JPA å®˜æ–¹æ¯”è¾ƒå»ºè®®æ”¾ä¸€äº›é»˜è®¤å€¼ï¼Œä½†æ˜¯æˆ‘ä¸æ˜¯ç‰¹åˆ«èµåŒï¼Œå› ä¸ºè§‰å¾—é‚£æ ·ä¸å¤Ÿç›´è§‚ï¼Œç›´æ¥ç”¨å­—æ®µåˆå§‹åŒ–å°±å¯ä»¥äº†ï¼Œæ²¡å¿…è¦åœ¨å›è°ƒå‡½æ•°é‡Œé¢æ”¾ç½®é»˜è®¤å€¼ã€‚</p>
</li>
</ol>
<p>é™¤äº†æ—¥å¿—ï¼Œå…¶ä»–å…¬ç”¨çš„åœºæ™¯ä¸å¤šã€‚å½“é‡åˆ°å…¶ä»–åœºæ™¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„å®ä½“å®é™…æƒ…å†µåˆ¶å®šè‡ªå·±ç‹¬æœ‰çš„ <code>EntityListener</code> æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@EntityListeners(UserListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;<span class="comment">// implements Auditable&lt;Integer,Long, Instant&gt; &#123;</span></span><br><span class="line">   <span class="meta">@Transient</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">calculationAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//é€šè¿‡ä¸€äº›é€»è¾‘è®¡ç®—å¹´é¾„ï¼›</span></span><br><span class="line">      <span class="keyword">this</span>.age=<span class="number">10</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   ......<span class="comment">//å…¶ä»–ä¸é‡è¦çš„çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼ŒUser ä¸­æˆ‘ä»¬æœ‰ä¸ªè®¡ç®—å¹´é¾„çš„é€»è¾‘è¦ç‹¬ç«‹è°ƒç”¨ï¼Œå°±å¯ä»¥åœ¨æŒä¹…åŒ–ä¹‹å‰è°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ–°å»ºä¸€ä¸ªè‡ªå·±çš„ <code>UserListener</code> å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PrePersist</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prePersist</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡ä¸€äº›é€»è¾‘è®¡ç®—å¹´é¾„ï¼›</span></span><br><span class="line">        user.calculationAge();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="JPA-Callbacks-çš„å®ç°åŸç†ï¼Œäº‹ä»¶æœºåˆ¶"><a href="#JPA-Callbacks-çš„å®ç°åŸç†ï¼Œäº‹ä»¶æœºåˆ¶" class="headerlink" title="JPA Callbacks çš„å®ç°åŸç†ï¼Œäº‹ä»¶æœºåˆ¶"></a>JPA Callbacks çš„å®ç°åŸç†ï¼Œäº‹ä»¶æœºåˆ¶</h2><p>Java Persistence API è§„å®šï¼šJPA çš„å®ç°æ–¹éœ€è¦å®ç°åŠŸèƒ½ï¼Œéœ€è¦æ”¯æŒå›è°ƒäº‹ä»¶æ³¨è§£ï¼›è€Œ Hibernate å†…éƒ¨è´Ÿè´£å®ç°ï¼ŒHibernate å†…éƒ¨ç»´æŠ¤äº†ä¸€å¥—å®ä½“çš„ <code>EventType</code>ï¼Œå…¶å†…éƒ¨åŒ…å«äº†å„ç§å›è°ƒäº‹ä»¶ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PreLoadEventListener&gt; PRE_LOAD = create( <span class="string">&quot;pre-load&quot;</span>, PreLoadEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PreDeleteEventListener&gt; PRE_DELETE = create( <span class="string">&quot;pre-delete&quot;</span>, PreDeleteEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PreUpdateEventListener&gt; PRE_UPDATE = create( <span class="string">&quot;pre-update&quot;</span>, PreUpdateEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PreInsertEventListener&gt; PRE_INSERT = create( <span class="string">&quot;pre-insert&quot;</span>, PreInsertEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PostLoadEventListener&gt; POST_LOAD = create( <span class="string">&quot;post-load&quot;</span>, PostLoadEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PostDeleteEventListener&gt; POST_DELETE = create( <span class="string">&quot;post-delete&quot;</span>, PostDeleteEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PostUpdateEventListener&gt; POST_UPDATE = create( <span class="string">&quot;post-update&quot;</span>, PostUpdateEventListener.class );</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> EventType&lt;PostInsertEventListener&gt; POST_INSERT = create( <span class="string">&quot;post-insert&quot;</span>, PostInsertEventListener.class );</span><br><span class="line">æ›´å¤šçš„äº‹ä»¶ç±»å‹ï¼Œä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ org.hibernate.event.spi.EventType ç±»ï¼Œäº†è§£æ›´å¤šï¼›åœ¨ session factory æ„å»ºçš„æ—¶å€™ï¼ŒEventListenerRegistryImpl è´Ÿè´£æ³¨å†Œè¿™äº›äº‹ä»¶ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ debug çš„å…³é”®èŠ‚ç‚¹ï¼š</span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†åŸç†ä¸å¸¸ç”¨ï¼ŒçŸ¥é“æœ‰è¿™ä¹ˆå›äº‹å³å¯</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa @Queryçš„ä½¿ç”¨</title>
    <url>/2020/10/14/SpringDataJpa%E7%9A%84@Query%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-Queryçš„ä½¿ç”¨"><a href="#Spring-Data-Jpa-Queryçš„ä½¿ç”¨" class="headerlink" title="Spring Data Jpa @Queryçš„ä½¿ç”¨"></a>Spring Data Jpa @Queryçš„ä½¿ç”¨</h1><blockquote>
<ol>
<li>å¿«é€Ÿä½“éªŒ @Query çš„æ–¹æ³•ã€</li>
<li>JpaQueryLookupStrategy å…³é”®æºç å‰–æã€</li>
<li>@Query çš„åŸºæœ¬ç”¨æ³•ã€</li>
<li>@Query ä¹‹ Projections åº”ç”¨è¿”å›æŒ‡å®š DTOã€</li>
<li>@Query åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•</li>
</ol>
</blockquote>
<h2 id="å¿«é€Ÿä½“éªŒ-Query-çš„æ–¹æ³•"><a href="#å¿«é€Ÿä½“éªŒ-Query-çš„æ–¹æ³•" class="headerlink" title="å¿«é€Ÿä½“éªŒ @Query çš„æ–¹æ³•"></a>å¿«é€Ÿä½“éªŒ @Query çš„æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.query.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDtoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">//é€šè¿‡queryæ³¨è§£æ ¹æ®nameæŸ¥è¯¢userä¿¡æ¯</span></span><br><span class="line">   <span class="meta">@Query(&quot;From User where name=:name&quot;)</span></span><br><span class="line">   <span class="function">User <span class="title">findByQuery</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String nameParam)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªæµ‹è¯•ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryQueryTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserDtoRepository userDtoRepository;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAnnotation</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//æ–°å¢ä¸€æ¡æ•°æ®æ–¹ä¾¿æµ‹è¯•      userDtoRepository.save(User.builder().name(&quot;jackxx&quot;).email(&quot;123456@126.com&quot;).sex(&quot;man&quot;).address(&quot;shanghai&quot;).build());</span></span><br><span class="line">      <span class="comment">//è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•æŸ¥çœ‹ç»“æœ</span></span><br><span class="line">      User user2 = userDtoRepository.findByQuery(<span class="string">&quot;jack&quot;</span>);</span><br><span class="line">      System.out.println(user2);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œçœ‹åˆ°è¿è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">user</span> <span class="params">(address, email, name, sex, version, id)</span> <span class="title">values</span> <span class="params">(?, ?, ?, ?, ?, ?)</span></span></span><br><span class="line"><span class="function">Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_, user0_.version as version6_0_ from user user0_ where user0_.name</span>=?</span><br><span class="line">User(id=<span class="number">1</span>, name=jack, email=<span class="number">123456</span>@<span class="number">126.</span>com, version=<span class="number">0</span>, sex=man, address=shanghai)</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ä¸æ˜¯é€šè¿‡æ–¹æ³•åæ¥ç”ŸæˆæŸ¥è¯¢è¯­æ³•ï¼Œè€Œæ˜¯ @Query æ³¨è§£åœ¨å…¶ä¸­èµ·äº†ä½œç”¨ï¼Œ</p>
<p>ä½¿ <code>From User where name=:name</code> JPQL ç”Ÿæ•ˆäº†ã€‚</p>
<h2 id="JpaQueryLookupStrategy-å…³é”®æºç å‰–æ"><a href="#JpaQueryLookupStrategy-å…³é”®æºç å‰–æ" class="headerlink" title="JpaQueryLookupStrategy å…³é”®æºç å‰–æ"></a>JpaQueryLookupStrategy å…³é”®æºç å‰–æ</h2><p>æ‰“å¼€ QueryExecutorMethodInterceptor ç±»ï¼Œæ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<p><img src="http://image.leonote.cn//20201013204422.png" alt=""></p>
<p>å†è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ—¶å€™åœ¨99è¡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç­–ç•¥æ˜¯CreateIfNotFoundï¼Œä¹Ÿå°±æ˜¯<strong>å¦‚æœæœ‰@Queryæ³¨è§£ï¼Œé‚£ä¹ˆä»¥@Queryçš„æ³¨è§£å†…å®¹ä¸ºå‡†ï¼Œå¯ä»¥å¿½ç•¥æ–¹æ³•å</strong>ã€‚</p>
<p>è¿›å…¥åˆ° lookupStrategy.resolveQuery é‡Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201013204655.png" alt=""></p>
<p>é€šè¿‡ä¸Šå›¾çš„æ–­ç‚¹å’Œçº¢æ¡†ä¹‹å¤„ï¼Œå‘ç°Spring Data JPA è¿™ä¸ªåœ°æ–¹ä½¿ç”¨äº†ç­–ç•¥ã€æ¨¡å¼ï¼Œå½“æˆ‘ä»¬è‡ªå·±å†™ç­–ç•¥æ¨¡å¼çš„æ—¶å€™ä¹Ÿå¯ä»¥è¿›è¡Œå‚è€ƒã€‚</p>
<p>å¾€ä¸‹ debugï¼Œè¿›å…¥åˆ° resolveQuery æ–¹æ³•é‡Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201013204820.png" alt=""></p>
<p>å›¾ä¸­ â‘ å¤„ï¼Œå¦‚æœ Query æ³¨è§£æ‰¾åˆ°äº†ï¼Œå°±ä¸ä¼šèµ°åˆ° â‘¡ å¤„äº†ã€‚</p>
<p>æŸ¥çœ‹ Query å±æ€§ï¼Œä½ ä¼šå‘ç°è¿™é‡ŒåŒæ—¶ç”Ÿæˆäº†ä¸¤ä¸ª SQLï¼š</p>
<ol>
<li>æŸ¥è¯¢æ€»æ•°çš„ Query å®šä¹‰</li>
<li>æŸ¥è¯¢ç»“æœçš„ Query å®šä¹‰</li>
</ol>
<p>å¦‚æœæƒ³çœ‹ Query å…·ä½“æ˜¯æ€ä¹ˆç”Ÿæˆçš„ã€ä¸Šé¢çš„ @Param æ³¨è§£æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Œå¯ä»¥åœ¨ä¸Šé¢çš„å›¾ â‘  å¤„ debug ç»§ç»­å¾€é‡Œé¢çœ‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201013205215.png" alt=""></p>
<h2 id="Query-çš„åŸºæœ¬ç”¨æ³•"><a href="#Query-çš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="@Query çš„åŸºæœ¬ç”¨æ³•"></a>@Query çš„åŸºæœ¬ç”¨æ³•</h2><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.data.jpa.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Query &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æŒ‡å®šJPQLçš„æŸ¥è¯¢è¯­å¥ã€‚ï¼ˆnativeQuery=trueçš„æ—¶å€™ï¼Œæ˜¯åŸç”Ÿçš„Sqlè¯­å¥ï¼‰</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">   <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">	* æŒ‡å®šcountçš„JPQLè¯­å¥ï¼Œå¦‚æœä¸æŒ‡å®šå°†æ ¹æ®queryè‡ªåŠ¨ç”Ÿæˆã€‚</span></span><br><span class="line"><span class="comment">    * ï¼ˆå¦‚æœå½“nativeQuery=trueçš„æ—¶å€™ï¼ŒæŒ‡çš„æ˜¯åŸç”Ÿçš„Sqlè¯­å¥ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">String <span class="title">countQuery</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ ¹æ®å“ªä¸ªå­—æ®µæ¥countï¼Œä¸€èˆ¬é»˜è®¤å³å¯ã€‚</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">   <span class="function">String <span class="title">countProjection</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é»˜è®¤æ˜¯falseï¼Œè¡¨ç¤ºvalueé‡Œé¢æ˜¯ä¸æ˜¯åŸç”Ÿçš„sqlè¯­å¥</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">nativeQuery</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¯ä»¥æŒ‡å®šä¸€ä¸ªqueryçš„åå­—ï¼Œå¿…é¡»å”¯ä¸€çš„ã€‚</span></span><br><span class="line"><span class="comment">	* å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ç”Ÿæˆè§„åˆ™æ˜¯ï¼š</span></span><br><span class="line"><span class="comment">    * &#123;$domainClass&#125;.$&#123;queryMethodName&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * å¯ä»¥æŒ‡å®šä¸€ä¸ªcountçš„queryçš„åå­—ï¼Œå¿…é¡»å”¯ä¸€çš„ã€‚</span></span><br><span class="line"><span class="comment">	* å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ç”Ÿæˆè§„åˆ™æ˜¯ï¼š</span></span><br><span class="line"><span class="comment">    * &#123;$domainClass&#125;.$&#123;queryMethodName&#125;.count</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">String <span class="title">countName</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Query ç”¨æ³•æ˜¯ä½¿ç”¨ JPQL ä¸ºå®ä½“åˆ›å»ºå£°æ˜å¼æŸ¥è¯¢æ–¹æ³•ã€‚æˆ‘ä»¬ä¸€èˆ¬åªéœ€è¦å…³å¿ƒ @Query é‡Œé¢çš„ value å’Œ nativeQueryã€countQuery çš„å€¼å³å¯ã€‚</p>
<p>ä½¿ç”¨å£°æ˜å¼ JPQL æŸ¥è¯¢æœ‰ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å¯åŠ¨çš„æ—¶å€™å°±çŸ¥é“ä½ çš„è¯­æ³•æ­£ç¡®ä¸æ­£ç¡®ã€‚</p>
<h3 id="JPQL-çš„è¯­æ³•"><a href="#JPQL-çš„è¯­æ³•" class="headerlink" title="JPQL çš„è¯­æ³•"></a>JPQL çš„è¯­æ³•</h3><p>æŸ¥è¯¢çš„è¯­æ³•ç»“æ„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> ...</span><br><span class="line">[<span class="keyword">WHERE</span> ...]</span><br><span class="line">[<span class="keyword">GROUP</span> <span class="keyword">BY</span> ... [<span class="keyword">HAVING</span> ...]]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> ...]</span><br></pre></td></tr></table></figure>

<p>å®ƒçš„è¯­æ³•ç»“æ„æœ‰ç‚¹ç±»ä¼¼ SQLï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ JPQL FROM åé¢è·Ÿçš„æ˜¯å¯¹è±¡ï¼Œè€Œ SQL é‡Œé¢çš„å­—æ®µå¯¹åº”çš„æ˜¯å¯¹è±¡é‡Œé¢çš„å±æ€§å­—æ®µã€‚</p>
<p>åŒç†æˆ‘ä»¬çœ‹ä¸€ä¸‹ update å’Œ delete çš„è¯­æ³•ç»“æ„ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> ... [<span class="keyword">WHERE</span> ...]</span><br><span class="line">UPDATE ... <span class="keyword">SET</span> ... [<span class="keyword">WHERE</span> ...]</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­â€œâ€¦â€çœç•¥çš„éƒ¨åˆ†æ˜¯å®ä½“å¯¹è±¡åå­—å’Œå®ä½“å¯¹è±¡é‡Œé¢çš„å­—æ®µåå­—ï¼Œè€Œå…¶ä¸­ç±»ä¼¼ SQL ä¸€æ ·åŒ…å«çš„è¯­æ³•å…³é”®å­—æœ‰ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  <span class="keyword">FROM</span>  <span class="keyword">WHERE</span>  UPDATE  <span class="keyword">DELETE</span>  <span class="keyword">JOIN</span>  <span class="keyword">OUTER</span>  <span class="keyword">INNER</span>  <span class="keyword">LEFT</span>  <span class="keyword">GROUP</span>  <span class="keyword">BY</span>  <span class="keyword">HAVING</span>  <span class="keyword">FETCH</span>  <span class="keyword">DISTINCT</span>  OBJECT  <span class="keyword">NULL</span>  <span class="literal">TRUE</span>  <span class="literal">FALSE</span>  <span class="keyword">NOT</span>  <span class="keyword">AND</span>  <span class="keyword">OR</span>  <span class="keyword">BETWEEN</span>  <span class="keyword">LIKE</span>  <span class="keyword">IN</span>  <span class="keyword">AS</span>  <span class="literal">UNKNOWN</span>  <span class="keyword">EMPTY</span>  <span class="keyword">MEMBER</span>  <span class="keyword">OF</span>  <span class="keyword">IS</span>  AVG  MAX  MIN  SUM  COUNT  <span class="keyword">ORDER</span>  <span class="keyword">BY</span>  <span class="keyword">ASC</span>  <span class="keyword">DESC</span>  MOD  UPPER  LOWER  TRIM  POSITION  <span class="keyword">CHARACTER_LENGTH</span>  <span class="keyword">CHAR_LENGTH</span>  BIT_LENGTH  <span class="built_in">CURRENT_TIME</span>  <span class="built_in">CURRENT_DATE</span>  <span class="built_in">CURRENT_TIMESTAMP</span>  <span class="keyword">NEW</span>  <span class="keyword">EXISTS</span>  <span class="keyword">ALL</span>  <span class="keyword">ANY</span>  <span class="keyword">SOME</span> </span><br></pre></td></tr></table></figure>


<p>é€šè¿‡æŸ¥çœ‹è¿™ä¸ª <a href="https://docs.oracle.com/html/E13946_04/ejb3_langref.html">Oracle çš„ JPQL æ–‡æ¡£</a>ï¼Œæ‰¾åˆ°è§£å†³é—®é¢˜çš„åŠæ³•ã€‚</p>
<h3 id="Query-ç”¨æ³•æ¡ˆä¾‹"><a href="#Query-ç”¨æ³•æ¡ˆä¾‹" class="headerlink" title="@Query ç”¨æ³•æ¡ˆä¾‹"></a>@Query ç”¨æ³•æ¡ˆä¾‹</h3><p> @Query æ€ä¹ˆä½¿ç”¨ã€æ€ä¹ˆä¼ é€’å‚æ•°ã€æ€ä¹ˆåˆ†é¡µ</p>
<h4 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹ 1"></a>æ¡ˆä¾‹ 1</h4><p>è¦åœ¨ Repository çš„æŸ¥è¯¢æ–¹æ³•ä¸Šå£°æ˜ä¸€ä¸ªæ³¨è§£ï¼Œè¿™é‡Œå°±æ˜¯ @Query æ³¨è§£æ ‡æ³¨çš„åœ°æ–¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">  <span class="meta">@Query(&quot;select u from User u where u.emailAddress = ?1&quot;)</span></span><br><span class="line">  <span class="function">User <span class="title">findByEmailAddress</span><span class="params">(String emailAddress)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ¡ˆä¾‹-2"><a href="#æ¡ˆä¾‹-2" class="headerlink" title="æ¡ˆä¾‹ 2"></a>æ¡ˆä¾‹ 2</h4><p>LIKE æŸ¥è¯¢ï¼Œæ³¨æ„ firstname ä¸ä¼šè‡ªåŠ¨åŠ ä¸Šâ€œ%â€å…³é”®å­—ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Query(&quot;select u from User u where u.firstname like %?1&quot;)</span></span><br><span class="line">  <span class="function">List&lt;User&gt; <span class="title">findByFirstnameEndsWith</span><span class="params">(String firstname)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ¡ˆä¾‹-3"><a href="#æ¡ˆä¾‹-3" class="headerlink" title="æ¡ˆä¾‹ 3"></a>æ¡ˆä¾‹ 3</h4><p>ç›´æ¥ç”¨åŸå§‹ SQLï¼ŒnativeQuery = true å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Query(value = &quot;SELECT * FROM USERS WHERE EMAIL_ADDRESS = ?1&quot;, nativeQuery = true)</span></span><br><span class="line">  <span class="function">User <span class="title">findByEmailAddress</span><span class="params">(String emailAddress)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šnativeQuery ä¸æ”¯æŒç›´æ¥ Sort çš„å‚æ•°æŸ¥è¯¢ã€‚</p>
</blockquote>
<h4 id="æ¡ˆä¾‹-4"><a href="#æ¡ˆä¾‹-4" class="headerlink" title="æ¡ˆä¾‹ 4"></a>æ¡ˆä¾‹ 4</h4><p>ä¸‹é¢æ˜¯nativeQuery çš„æ’åºé”™è¯¯çš„å†™æ³•ï¼Œä¼šå¯¼è‡´æ— æ³•å¯åŠ¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Query(value = &quot;select * from user_info where first_name=?1&quot;,nativeQuery = true)</span></span><br><span class="line">  <span class="function">List&lt;UserInfoEntity&gt; <span class="title">findByFirstName</span><span class="params">(String firstName,Sort sort)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ¡ˆä¾‹-5"><a href="#æ¡ˆä¾‹-5" class="headerlink" title="æ¡ˆä¾‹ 5"></a>æ¡ˆä¾‹ 5</h4><p>nativeQuery æ’åºçš„æ­£ç¡®å†™æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Query(value = &quot;select * from user_info where first_name=?1 order by ?2&quot;,nativeQuery = true)</span></span><br><span class="line"><span class="function">List&lt;UserInfoEntity&gt; <span class="title">findByFirstName</span><span class="params">(String firstName,String sort)</span></span>;</span><br><span class="line"><span class="comment">//è°ƒç”¨çš„åœ°æ–¹å†™æ³•last_nameæ˜¯æ•°æ®é‡Œé¢çš„å­—æ®µåï¼Œä¸æ˜¯å¯¹è±¡çš„å­—æ®µå</span></span><br><span class="line">repository.findByFirstName(<span class="string">&quot;jackzhang&quot;</span>,<span class="string">&quot;last_name&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢å‡ ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† @Query çš„å‡ ç§ç”¨æ³•ï¼Œä½ å°±ä¼šæ˜ç™½æ’åºã€å‚æ•°ã€ä½¿ç”¨æ–¹æ³•ã€LIKEã€åŸå§‹ SQL æ€ä¹ˆå†™ã€‚</p>
<h3 id="Query-çš„æ’åº"><a href="#Query-çš„æ’åº" class="headerlink" title="@Query çš„æ’åº"></a>@Query çš„æ’åº</h3><p>@Queryä¸­åœ¨ç”¨JPQLçš„æ—¶å€™ï¼Œæƒ³è¦å®ç°æ’åºï¼Œæ–¹æ³•ä¸Šç›´æ¥ç”¨ PageRequest æˆ–è€… Sort å‚æ•°éƒ½å¯ä»¥åšåˆ°ã€‚</p>
<p>åœ¨æ’åºå®ä¾‹ä¸­ï¼Œå®é™…ä½¿ç”¨çš„å±æ€§éœ€è¦ä¸å®ä½“æ¨¡å‹é‡Œé¢çš„å­—æ®µç›¸åŒ¹é…ï¼Œè¿™æ„å‘³ç€å®ƒä»¬éœ€è¦è§£æä¸ºæŸ¥è¯¢ä¸­ä½¿ç”¨çš„å±æ€§æˆ–åˆ«åã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¾‹å­ï¼Œè¿™æ˜¯ä¸€ä¸ªstate_field_path_expression JPQLçš„å®šä¹‰ï¼Œå¹¶ä¸” Sort çš„å¯¹è±¡æ”¯æŒä¸€äº›ç‰¹å®šçš„å‡½æ•°ã€‚</p>
<h4 id="æ¡ˆä¾‹-6"><a href="#æ¡ˆä¾‹-6" class="headerlink" title="æ¡ˆä¾‹ 6"></a>æ¡ˆä¾‹ 6</h4><p>Sort and JpaSort çš„ä½¿ç”¨ï¼Œå®ƒå¯ä»¥è¿›è¡Œæ’åºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Query(&quot;select u from User u where u.lastname like ?1%&quot;)</span></span><br><span class="line">  <span class="function">List&lt;User&gt; <span class="title">findByAndSort</span><span class="params">(String lastname, Sort sort)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Query(&quot;select u.id, LENGTH(u.firstname) as fn_len from User u where u.lastname like ?1%&quot;)</span></span><br><span class="line">  List&lt;Object[]&gt; findByAsArrayAndSort(String lastname, Sort sort);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨æ–¹çš„å†™æ³•ï¼Œå¦‚ä¸‹ï¼š</span></span><br><span class="line">repo.findByAndSort(<span class="string">&quot;lannister&quot;</span>, <span class="keyword">new</span> Sort(<span class="string">&quot;firstname&quot;</span>));               </span><br><span class="line">repo.findByAndSort(<span class="string">&quot;stark&quot;</span>, <span class="keyword">new</span> Sort(<span class="string">&quot;LENGTH(firstname)&quot;</span>));          </span><br><span class="line">repo.findByAndSort(<span class="string">&quot;targaryen&quot;</span>, JpaSort.unsafe(<span class="string">&quot;LENGTH(firstname)&quot;</span>));</span><br><span class="line">repo.findByAsArrayAndSort(<span class="string">&quot;bolton&quot;</span>, <span class="keyword">new</span> Sort(<span class="string">&quot;fn_len&quot;</span>));   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™ä¸ªæ¡ˆä¾‹è®²è¿°çš„æ˜¯æ’åºç”¨æ³•ï¼Œå†æ¥çœ‹ä¸‹ @Query çš„åˆ†é¡µç”¨æ³•ã€‚</p>
<h3 id="Query-çš„åˆ†é¡µ"><a href="#Query-çš„åˆ†é¡µ" class="headerlink" title="@Query çš„åˆ†é¡µ"></a>@Query çš„åˆ†é¡µ</h3><p>@Query çš„åˆ†é¡µåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«ä¸º JQPl çš„æ’åºå’Œ nativeQuery çš„æ’åºã€‚</p>
<h4 id="æ¡ˆä¾‹-7"><a href="#æ¡ˆä¾‹-7" class="headerlink" title="æ¡ˆä¾‹ 7"></a>æ¡ˆä¾‹ 7</h4><p>ç›´æ¥ç”¨ Page å¯¹è±¡æ¥å—æ¥å£ï¼Œå‚æ•°ç›´æ¥ç”¨ Pageable çš„å®ç°ç±»å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Query(value = &quot;select u from User u where u.lastname = ?1&quot;)</span></span><br><span class="line">  <span class="function">Page&lt;User&gt; <span class="title">findByLastname</span><span class="params">(String lastname, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨è€…çš„å†™æ³•</span></span><br><span class="line">repository.findByFirstName(<span class="string">&quot;jackzhang&quot;</span>,<span class="keyword">new</span> PageRequest(<span class="number">1</span>,<span class="number">10</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="æ¡ˆä¾‹-8"><a href="#æ¡ˆä¾‹-8" class="headerlink" title="æ¡ˆä¾‹ 8"></a>æ¡ˆä¾‹ 8</h4><p>@Query å¯¹åŸç”Ÿ SQL çš„åˆ†é¡µæ”¯æŒï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«å‹å¥½ï¼Œå› ä¸ºè¿™ç§å†™æ³•æ¯”è¾ƒâ€œéª‡å®¢â€ï¼Œå¯èƒ½éšç€ç‰ˆæœ¬çš„ä¸åŒä¼šæœ‰æ‰€å˜åŒ–ã€‚æˆ‘ä»¬ä»¥ MySQL ä¸ºä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfoEntity</span>, <span class="title">Integer</span>&gt;, <span class="title">JpaSpecificationExecutor</span>&lt;<span class="title">UserInfoEntity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Query(value = &quot;select * from user_info where first_name=?1 /* #pageable# */&quot;,</span></span><br><span class="line"><span class="meta">         countQuery = &quot;select count(*) from user_info where first_name=?1&quot;,</span></span><br><span class="line"><span class="meta">         nativeQuery = true)</span></span><br><span class="line">   <span class="function">Page&lt;UserInfoEntity&gt; <span class="title">findByFirstName</span><span class="params">(String firstName, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨è€…çš„å†™æ³•</span></span><br><span class="line"><span class="keyword">return</span> userRepository.findByFirstName(<span class="string">&quot;jackzhang&quot;</span>,<span class="keyword">new</span> PageRequest(<span class="number">1</span>,<span class="number">10</span>, Sort.Direction.DESC,<span class="string">&quot;last_name&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å°å‡ºæ¥çš„sql</span></span><br><span class="line">select  *   from  user_info  where  first_name=? <span class="comment">/* #pageable# */</span>  order by  last_name desc limit ?, ?</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šè¿™ä¸ªæ³¨é‡Š / #pageable# / å¿…é¡»æœ‰ã€‚</p>
<p>å¦å¤–ï¼Œéšç€ç‰ˆæœ¬çš„å˜åŒ–ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å¯èƒ½ä¼šè¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>æ­¤å¤–è¿˜æœ‰ä¸€ç§å®ç°æ–¹æ³•ï¼Œå°±æ˜¯è‡ªå·±å†™ä¸¤ä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œè‡ªå·±æ‰‹åŠ¨åˆ†é¡µã€‚</p>
</blockquote>
<h3 id="Param-ç”¨æ³•"><a href="#Param-ç”¨æ³•" class="headerlink" title="@Param ç”¨æ³•"></a>@Param ç”¨æ³•</h3><p>@Param æ³¨è§£æŒ‡å®šæ–¹æ³•å‚æ•°çš„å…·ä½“åç§°ï¼Œé€šè¿‡ç»‘å®šçš„å‚æ•°åå­—æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œè¿™æ ·ä¸éœ€è¦å…³å¿ƒå‚æ•°çš„é¡ºåºã€‚<strong>æ¯”è¾ƒæ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºå®ƒæ¯”è¾ƒåˆ©äºä»£ç é‡æ„</strong>ã€‚å¦‚æœä¸ç”¨ @Param ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå‚æ•°æ˜¯æœ‰åºçš„ï¼Œè¿™ä½¿å¾—æŸ¥è¯¢æ–¹æ³•å¯¹å‚æ•°ä½ç½®çš„é‡æ„å®¹æ˜“å‡ºé”™ã€‚æˆ‘ä»¬çœ‹ä¸ªæ¡ˆä¾‹ã€‚</p>
<h4 id="æ¡ˆä¾‹-9"><a href="#æ¡ˆä¾‹-9" class="headerlink" title="æ¡ˆä¾‹ 9"></a>æ¡ˆä¾‹ 9</h4><p>æ ¹æ® firstname å’Œ lastname å‚æ•°æŸ¥è¯¢ user å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Query(&quot;select u from User u where u.firstname = :firstname or u.lastname = :lastname&quot;)</span></span><br><span class="line">  <span class="function">User <span class="title">findByLastnameOrFirstname</span><span class="params">(<span class="meta">@Param(&quot;lastname&quot;)</span> String lastname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="meta">@Param(&quot;firstname&quot;)</span> String firstname)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æ¡ˆä¾‹-10"><a href="#æ¡ˆä¾‹-10" class="headerlink" title="æ¡ˆä¾‹ 10"></a>æ¡ˆä¾‹ 10</h3><p>æ ¹æ®å‚æ•°è¿›è¡ŒæŸ¥è¯¢ï¼Œtop 10 å‰é¢è¯´çš„â€œquery methodâ€å…³é”®å­—ç…§æ ·æœ‰ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Query(&quot;select u from User u where u.firstname = :firstname or u.lastname = :lastname&quot;)</span></span><br><span class="line">  <span class="function">User <span class="title">findTop10ByLastnameOrFirstname</span><span class="params">(<span class="meta">@Param(&quot;lastname&quot;)</span> String lastname,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="meta">@Param(&quot;firstname&quot;)</span> String firstname)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>é€šè¿‡ @Query å®šä¹‰è‡ªå·±çš„æŸ¥è¯¢æ–¹æ³•æ—¶ï¼Œå»ºè®®ä¹Ÿç”¨ Spring Data JPA çš„ name query çš„å‘½åæ–¹æ³•ï¼Œè¿™æ ·ä¸‹æ¥é£æ ¼å°±æ¯”è¾ƒç»Ÿä¸€äº†ã€‚</p>
</blockquote>
<h3 id="Query-ä¹‹-Projections-åº”ç”¨è¿”å›æŒ‡å®š-DTO"><a href="#Query-ä¹‹-Projections-åº”ç”¨è¿”å›æŒ‡å®š-DTO" class="headerlink" title="@Query ä¹‹ Projections åº”ç”¨è¿”å›æŒ‡å®š DTO"></a>@Query ä¹‹ Projections åº”ç”¨è¿”å›æŒ‡å®š DTO</h3><p><a href="https://docs.spring.io/spring-data/jpa/docs/2.0.7.RELEASE/reference/html/#projections">JPAæ–‡æ¡£ - 3.3.1 å…³äº Projections</a></p>
<p>æ–°å¢ä¸€å¼ è¡¨ UserExtendï¼Œé‡Œé¢åŒ…å«èº«ä»½è¯ã€å­¦å·ã€å¹´é¾„ç­‰ä¿¡æ¯ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„å®ä½“å˜æˆå¦‚ä¸‹æ¨¡æ ·ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserExtend</span> </span>&#123; <span class="comment">//ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> Long userId;</span><br><span class="line">   <span class="keyword">private</span> String idCard;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="keyword">private</span> String studentNumber;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123; <span class="comment">//ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Version</span></span><br><span class="line">   <span class="keyword">private</span> Long version;</span><br><span class="line">   <span class="keyword">private</span> String sex;</span><br><span class="line">   <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬æƒ³å®šä¹‰ä¸€ä¸ª DTO å¯¹è±¡ï¼Œé‡Œé¢åªè¦ nameã€emailã€idCardï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ç§åœºæ™¯éå¸¸å¸¸è§ï¼Œä½†å¥½å¤šäººä½¿ç”¨çš„éƒ½ä¸æ˜¯æœ€ä½³å®è·µï¼Œæˆ‘åœ¨è¿™é‡Œä»‹ç»å‡ ç§æ–¹å¼åšä¸€ä¸‹å¯¹æ¯”ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œåˆšå­¦ JPA çš„æ—¶å€™åˆ«æ‰‹åˆ«è„šçš„å†™æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDtoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æŸ¥è¯¢ç”¨æˆ·è¡¨é‡Œé¢çš„nameã€emailå’ŒUserExtendè¡¨é‡Œé¢çš„idCard</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u.name,u.email,e.idCard from User u,UserExtend e where u.id= e.userId and u.id=:id&quot;)</span></span><br><span class="line">   List&lt;Object[]&gt; findByUserId(<span class="meta">@Param(&quot;id&quot;)</span> Long id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æµ‹è¯•ç”¨ä¾‹æ¥å–ä¸Šé¢ findByUserId æ–¹æ³•è¿”å›çš„æ•°æ®ç»„ç»“æœå€¼ï¼Œå†å¡åˆ° DTO é‡Œé¢ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAnnotation</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–°å¢ä¸€æ¡ç”¨æˆ·æ•°æ®  userDtoRepository.save(User.builder().name(&quot;jack&quot;).email(&quot;123456@126.com&quot;).sex(&quot;man&quot;).address(&quot;shanghai&quot;).build());</span></span><br><span class="line"><span class="comment">//å†æ–°å¢ä¸€æ¡å’Œç”¨æˆ·ä¸€å¯¹ä¸€çš„UserExtendæ•°æ®  userExtendRepository.save(UserExtend.builder().userId(1L).idCard(&quot;shengfengzhenghao&quot;).ages(18).studentNumber(&quot;xuehao001&quot;).build());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥è¯¢æˆ‘ä»¬æƒ³è¦çš„ç»“æœ</span></span><br><span class="line">   List&lt;Object[]&gt; userArray = userDtoRepository.findByUserId(<span class="number">1L</span>);</span><br><span class="line">   System.out.println(String.valueOf(userArray.get(<span class="number">0</span>)[<span class="number">0</span>])+String.valueOf(userArray.get(<span class="number">0</span>)[<span class="number">1</span>]));</span><br><span class="line">   UserDto userDto = UserDto.builder().name(String.valueOf(userArray.get(<span class="number">0</span>)[<span class="number">0</span>])).build();</span><br><span class="line">   System.out.println(userDto);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®ç»éªŒçš„ä¸°å¯Œçš„â€œè€å¸æœºâ€ä¸€çœ‹å°±çŸ¥é“è¿™è‚¯å®šä¸æ˜¯æœ€ä½³å®è·µï¼Œè¿™å¤šéº»çƒ¦å‘€ï¼Œè‚¯å®šä¼šæœ‰æ›´ä¼˜è§£ã€‚é‚£ä¹ˆæˆ‘ä»¬å†å¯¹æ­¤ç¨åŠ æ”¹é€ ï¼Œç”¨ UserDto æ¥æ”¶è¿”å›ç»“æœã€‚</p>
<h4 id="åˆ©ç”¨-class-UserDto-è·å–æˆ‘ä»¬æƒ³è¦çš„ç»“æœ"><a href="#åˆ©ç”¨-class-UserDto-è·å–æˆ‘ä»¬æƒ³è¦çš„ç»“æœ" class="headerlink" title="åˆ©ç”¨ class UserDto è·å–æˆ‘ä»¬æƒ³è¦çš„ç»“æœ"></a>åˆ©ç”¨ class UserDto è·å–æˆ‘ä»¬æƒ³è¦çš„ç»“æœ</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª UserDto ç±»çš„å†…å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name,email,idCard;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹åˆ©ç”¨ @Query åœ¨ Repository é‡Œé¢æ€ä¹ˆå†™ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDtoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Query(&quot;select new com.example.jpa.example1.UserDto(CONCAT(u.name,&#x27;JK123&#x27;),u.email,e.idCard) from User u,UserExtend e where u.id= e.userId and u.id=:id&quot;)</span></span><br><span class="line">   <span class="function">UserDto <span class="title">findByUserDtoId</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ©ç”¨ JPQLï¼Œnew äº†ä¸€ä¸ª UserDtoï¼›å†é€šè¿‡æ„é€ æ–¹æ³•ï¼Œæ¥æ”¶æŸ¥è¯¢ç»“æœã€‚å…¶ä¸­ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬ç”¨ CONCAT çš„å…³é”®å­—åšäº†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥ã€‚</p>
<p>ä½ å¯ä»¥æŸ¥çœ‹<a href="https://docs.oracle.com/html/E13946_04/ejb3_langref.html">JPQLçš„ Oracle æ–‡æ¡£</a>ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æºç æ¥çœ‹æ”¯æŒçš„å…³é”®å­—æœ‰å“ªäº›ã€‚</p>
<p>æ‰“å¼€ ParameterizedFunctionExpression ä¼šå‘ç° Hibernate æ”¯æŒçš„å…³é”®å­—æœ‰è¿™ä¹ˆå¤šï¼Œéƒ½æ˜¯ MySQL æ•°æ®åº“çš„æŸ¥è¯¢å…³é”®å­—ã€‚</p>
<p><img src="http://image.leonote.cn//20201013213658.png" alt=""></p>
<p>ç„¶åï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ä¸Šé¢çš„æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAnnotationDto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  userDtoRepository.save(</span><br><span class="line">      User.builder().name(<span class="string">&quot;jack&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">      .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">  userExtendRepository.save(</span><br><span class="line">      UserExtend.builder()</span><br><span class="line">          .userId(<span class="number">1L</span>)</span><br><span class="line">          .idCard(<span class="string">&quot;shengfengzhenghao&quot;</span>)</span><br><span class="line">          .ages(<span class="number">18</span>)</span><br><span class="line">          .studentNumber(<span class="string">&quot;xuehao001&quot;</span>)</span><br><span class="line">          .build());</span><br><span class="line">  UserDto userDto = userDtoRepository.findByUserDtoId(<span class="number">1L</span>);</span><br><span class="line">  System.out.println(userDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œç»“æœå¦‚ä¸‹ã€‚è¿™æ—¶ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬æŒ‰ç…§é¢„æœŸæ“ä½œå¾—åˆ°äº† UserDto çš„ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">user</span> <span class="params">(address, email, name, sex, version, id)</span> <span class="title">values</span> <span class="params">(?, ?, ?, ?, ?, ?)</span></span></span><br><span class="line"><span class="function">Hibernate: insert into <span class="title">user_extend</span> <span class="params">(ages, id_card, student_number, user_id, id)</span> <span class="title">values</span> <span class="params">(?, ?, ?, ?, ?)</span></span></span><br><span class="line"><span class="function">Hibernate: <span class="title">select</span> <span class="params">(user0_.name||<span class="string">&#x27;JK123&#x27;</span>)</span> as col_0_0_, user0_.email as col_1_0_, userextend1_.id_card as col_2_0_ from user user0_ cross join user_extend userextend1_ where user0_.id</span>=userextend1_.user_id and user0_.id=?</span><br><span class="line">UserDto(name=jackJK123, email=<span class="number">123456</span>@<span class="number">126.</span>com, idCard=shengfengzhenghao)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ï¼Œä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ UserDto æ¥å£æ¥å®ç°ä¸€ä¸‹ã€‚</p>
<h4 id="åˆ©ç”¨-UserDto-æ¥å£è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœ"><a href="#åˆ©ç”¨-UserDto-æ¥å£è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœ" class="headerlink" title="åˆ©ç”¨ UserDto æ¥å£è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœ"></a>åˆ©ç”¨ UserDto æ¥å£è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœ</h4><p>é¦–å…ˆï¼Œæ–°å¢ä¸€ä¸ª UserSimpleDto æ¥å£æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ nameã€emailã€idCard ä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserSimpleDto</span> </span>&#123;</span><br><span class="line">   <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function">String <span class="title">getEmail</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function">String <span class="title">getIdCard</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œåœ¨ UserDtoRepository é‡Œé¢æ–°å¢ä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›ç»“æœæ˜¯ UserSimpleDto æ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDtoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ©ç”¨æ¥å£DTOè·å¾—è¿”å›ç»“æœï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ¯ä¸ªå­—æ®µéœ€è¦aså’Œæ¥å£é‡Œé¢çš„getæ–¹æ³•åå­—ä¿æŒä¸€æ ·</span></span><br><span class="line"><span class="meta">@Query(&quot;select CONCAT(u.name,&#x27;JK123&#x27;) as name,UPPER(u.email) as email ,e.idCard as idCard from User u,UserExtend e where u.id= e.userId and u.id=:id&quot;)</span></span><br><span class="line"><span class="function">UserSimpleDto <span class="title">findByUserSimpleDtoId</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæµ‹è¯•ç”¨ä¾‹å†™æ³•å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAnnotationDto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    userDtoRepository.save(</span><br><span class="line">        User.builder().name(<span class="string">&quot;jack&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">        .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">    userExtendRepository.save(</span><br><span class="line">        UserExtend.builder()</span><br><span class="line">            .userId(<span class="number">1L</span>)</span><br><span class="line">            .idCard(<span class="string">&quot;shengfengzhenghao&quot;</span>)</span><br><span class="line">            .ages(<span class="number">18</span>)</span><br><span class="line">            .studentNumber(<span class="string">&quot;xuehao001&quot;</span>)</span><br><span class="line">            .build());</span><br><span class="line">    UserSimpleDto userDto = userDtoRepository.findByUserSimpleDtoId(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(userDto);</span><br><span class="line">    System.out.println(userDto.getName() + <span class="string">&quot;:&quot;</span> + userDto.getEmail() + <span class="string">&quot;:&quot;</span> + userDto.getIdCard());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬æ‰§è¡Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@373c28e5</span><br><span class="line">jackJK123:<span class="number">123456</span>@<span class="number">126.</span>COM:shengfengzhenghao</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œæ¯”èµ· DTO æˆ‘ä»¬ä¸éœ€è¦ new äº†ï¼Œå¹¶ä¸”æ¥å£åªèƒ½è¯»ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿”å›çš„ç»“æœ DTO çš„èŒè´£å°±æ›´å•ä¸€äº†ï¼Œåªç”¨æ¥æŸ¥è¯¢ã€‚</p>
<blockquote>
<p>æ¥å£çš„æ–¹å¼æ˜¯æ¯”è¾ƒæ¨èçš„åšæ³•ï¼Œå› ä¸ºå®ƒæ˜¯åªè¯»çš„ï¼Œå¯¹æ„é€ æ–¹æ³•æ²¡æœ‰è¦æ±‚ï¼Œè¿”å›çš„å®é™…æ˜¯ HashMapã€‚</p>
</blockquote>
<h2 id="Query-åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•"><a href="#Query-åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•" class="headerlink" title="@Query åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•"></a>@Query åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•</h2><p>æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¥äº†è§£ä¸€ä¸‹å¦‚ä½•å®ç° @Query çš„åŠ¨æ€å‚æ•°æŸ¥è¯¢ã€‚</p>
<p>é¦–å…ˆï¼Œæ–°å¢ä¸€ä¸ª UserOnlyName æ¥å£ï¼ŒåªæŸ¥è¯¢ User é‡Œé¢çš„ name å’Œ email å­—æ®µã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å¾—è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserOnlyName</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getEmail</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œåœ¨æˆ‘ä»¬çš„ UserDtoRepository é‡Œé¢æ–°å¢ä¸¤ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªæ˜¯åˆ©ç”¨ JPQL å®ç°åŠ¨æ€æŸ¥è¯¢ï¼Œä¸€ä¸ªæ˜¯åˆ©ç”¨åŸå§‹ SQL å®ç°åŠ¨æ€æŸ¥è¯¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.query.Param;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDtoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ©ç”¨JQPlåŠ¨æ€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> email</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> UserSimpleDtoæ¥å£</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u.name as name,u.email as email from User u where (:name is null or u.name =:name) and (:email is null or u.email =:email)&quot;)</span></span><br><span class="line">   <span class="function">UserOnlyName <span class="title">findByUser</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name,<span class="meta">@Param(&quot;email&quot;)</span> String email)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ©ç”¨åŸå§‹sqlåŠ¨æ€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Query(value = &quot;select u.name as name,u.email as email from user u where (:#&#123;#user.name&#125; is null or u.name =:#&#123;#user.name&#125;) and (:#&#123;#user.email&#125; is null or u.email =:#&#123;#user.email&#125;)&quot;,nativeQuery = true)</span></span><br><span class="line"><span class="function">UserOnlyName <span class="title">findByUser</span><span class="params">(<span class="meta">@Param(&quot;user&quot;)</span> User user)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªæµ‹è¯•ç±»ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸Šé¢æ–¹æ³•çš„ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryDinamicDto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">userDtoRepository.save(</span><br><span class="line">User.builder().name(<span class="string">&quot;jack&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">.sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">   UserOnlyName userDto = userDtoRepository.findByUser(<span class="string">&quot;jack&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">   System.out.println(userDto.getName() + <span class="string">&quot;:&quot;</span> + userDto.getEmail());</span><br><span class="line">   UserOnlyName userDto2 = userDtoRepository.findByUser(User.builder().email(<span class="string">&quot;123456@126.com&quot;</span>).build());</span><br><span class="line">   System.out.println(userDto2.getName() + <span class="string">&quot;:&quot;</span> + userDto2.getEmail());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">user</span> <span class="params">(address, email, name, sex, version, id)</span> <span class="title">values</span> <span class="params">(?, ?, ?, ?, ?, ?)</span></span></span><br><span class="line"><span class="function"> : binding parameter [1] as [VARCHAR] - [shanghai]</span></span><br><span class="line"><span class="function"> : binding parameter [2] as [VARCHAR] - [123456@126.com]</span></span><br><span class="line"><span class="function"> : binding parameter [3] as [VARCHAR] - [jack]</span></span><br><span class="line"><span class="function"> : binding parameter [4] as [VARCHAR] - [man]</span></span><br><span class="line"><span class="function"> : binding parameter [5] as [BIGINT] - [0]</span></span><br><span class="line"><span class="function"> : binding parameter [6] as [BIGINT] - [1]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ <span class="title">where</span> <span class="params">(? is <span class="keyword">null</span> or user0_.name=?)</span> <span class="title">and</span> <span class="params">(? is <span class="keyword">null</span> or user0_.email=?)</span></span></span><br><span class="line"><span class="function"> : binding parameter [1] as [VARCHAR] - [jack]</span></span><br><span class="line"><span class="function"> : binding parameter [2] as [VARCHAR] - [jack]</span></span><br><span class="line"><span class="function"> : binding parameter [3] as [VARCHAR] - [<span class="keyword">null</span>]</span></span><br><span class="line"><span class="function"> : binding parameter [4] as [VARCHAR] - [<span class="keyword">null</span>]</span></span><br><span class="line"><span class="function">jack:123456@126.com</span></span><br><span class="line"><span class="function">Hibernate: select u.name as name,u.email as email from user u <span class="title">where</span> <span class="params">(? is <span class="keyword">null</span> or u.name =?)</span> <span class="title">and</span> <span class="params">(? is <span class="keyword">null</span> or u.email =?)</span></span></span><br><span class="line"><span class="function"> : binding parameter [1] as [VARBINARY] - [<span class="keyword">null</span>]</span></span><br><span class="line"><span class="function"> : binding parameter [2] as [VARBINARY] - [<span class="keyword">null</span>]</span></span><br><span class="line"><span class="function"> : binding parameter [3] as [VARCHAR] - [123456@126.com]</span></span><br><span class="line"><span class="function"> : binding parameter [4] as [VARCHAR] - [123456@126.com]</span></span><br><span class="line"><span class="function">jack:123456@126.com</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šå…¶ä¸­æˆ‘ä»¬æ‰“å°äº†ä¸€ä¸‹ SQL ä¼ å…¥çš„å‚æ•°ï¼Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬æ›´æ¸…æ¥šå‚æ•°éƒ½ä¼ å…¥äº†ä»€ä¹ˆå€¼ã€‚<br>ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«é‡‡ç”¨äº† JPQL çš„åŠ¨æ€å‚æ•°å’Œ SPEL çš„è¡¨è¾¾å¼æ–¹å¼è·å–å‚æ•°</p>
</blockquote>
<p>é€šè¿‡ä¸Šé¢çš„å®ä¾‹å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† :email is null or s.email = :email è¿™ç§æ–¹å¼æ¥å®ç°åŠ¨æ€æŸ¥è¯¢çš„æ•ˆæœï¼Œå®é™…å·¥ä½œä¸­ä¹Ÿå¯èƒ½æ¼”å˜å¾—å¾ˆå¤æ‚ã€‚</p>
<blockquote>
<ol>
<li>èƒ½ç”¨æ–¹æ³•åè¡¨ç¤ºçš„ï¼Œå°½é‡ç”¨æ–¹æ³•åè¡¨ç¤ºï¼Œå› ä¸ºè¿™æ ·è¯­ä¹‰æ¸…æ™°ã€ç®€å•å¿«é€Ÿï¼ŒåŸºæœ¬ä¸Šåªè¦ç¼–è¯‘é€šè¿‡ï¼Œä¸€å®šä¸ä¼šæœ‰é—®é¢˜ï¼›</li>
<li>èƒ½ç”¨ @Query é‡Œé¢çš„ JPQL è¡¨ç¤ºçš„ï¼Œå°±ç”¨ JPQLï¼Œè¿™æ ·ä¸ SQL æ— å…³ï¼Œä¸‡ä¸€å“ªå¤©æ¢æ•°æ®åº“äº†ï¼ŒåŸºæœ¬ä¸Šä»£ç ä¸ç”¨æ”¹å˜ï¼›</li>
<li>æœ€åå®åœ¨æ²¡æœ‰åŠæ³•äº†ï¼Œå¯ä»¥é€‰æ‹© nativeQuery å†™åŸå§‹ SQLï¼Œç‰¹åˆ«æ˜¯ä¸€å¼€å§‹ä» MyBatis è½¬è¿‡æ¥çš„åŒå­¦ï¼Œé€‰æ‹©å†™ SQL ä¼šæ›´å®¹æ˜“ä¸€äº›ã€‚</li>
</ol>
</blockquote>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Defining Query Methods</tag>
      </tags>
  </entry>
  <entry>
    <title>Defining Query Methodsè¯­æ³•</title>
    <url>/2020/09/22/SpringDataJpa%E7%9A%84DQM%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<h1 id="Defining-Query-Methods"><a href="#Defining-Query-Methods" class="headerlink" title="Defining Query Methods"></a>Defining Query Methods</h1><p>Spring Data JPA çš„æ–¹æ³•åå®šä¹‰æŸ¥è¯¢æ–¹æ³• ï¼ˆ Defining Query Methods ï¼‰å¯ä»¥ä½¿è¯­ä¹‰æ›´åŠ æ¸…æ™°ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚</p>
<p>DQM è¯­æ³•å…±æœ‰ 2 ç§</p>
<ol>
<li>ç›´æ¥é€šè¿‡æ–¹æ³•åå®ç°</li>
<li>@Query æ‰‹åŠ¨åœ¨æ–¹æ³•ä¸Šå®šä¹‰</li>
</ol>
<h2 id="å®šä¹‰æŸ¥è¯¢æ–¹æ³•çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•"><a href="#å®šä¹‰æŸ¥è¯¢æ–¹æ³•çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•" class="headerlink" title="å®šä¹‰æŸ¥è¯¢æ–¹æ³•çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•"></a>å®šä¹‰æŸ¥è¯¢æ–¹æ³•çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•</h2><p>è‹¥æƒ³è¦å®ç° CRUD çš„æ“ä½œï¼Œå¸¸è§„åšæ³•æ˜¯å†™ä¸€å¤§å † SQL è¯­å¥ã€‚ä½†åœ¨ JPA é‡Œé¢ï¼Œåªéœ€è¦ç»§æ‰¿ Spring Data Common é‡Œé¢çš„ä»»æ„ Repository æ¥å£æˆ–è€…å­æ¥å£ï¼Œç„¶åç›´æ¥é€šè¿‡æ–¹æ³•åå°±å¯ä»¥å®ç°ã€‚å…·ä½“ä½¿ç”¨æ­¥éª¤ï¼š</p>
<p>User å®ä½“çš„ <code>UserRepository</code> ç»§æ‰¿ Spring Data Common é‡Œé¢çš„ Repository æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">     <span class="function">User <span class="title">findByEmailAddress</span><span class="params">(String emailAddress)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº Service å±‚å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>UserRepository</code> æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJpa</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userRepository.deleteAll();</span><br><span class="line">        userRepository.findAll();</span><br><span class="line">        userRepository.findByEmailAddress(<span class="string">&quot;zjk@126.com&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç›´æ¥è°ƒç”¨ <code>CrudRepository</code> é‡Œé¢æš´éœ²çš„æ‰€æœ‰æ¥å£æ–¹æ³•ï¼Œä»¥åŠ <code>UserRepository</code> é‡Œé¢å®šä¹‰çš„æ–¹æ³•ï¼Œä¸éœ€è¦å†™ä»»ä½• SQL è¯­å¥ï¼Œä¹Ÿä¸éœ€è¦å†™ä»»ä½•å®ç°æ–¹æ³•ã€‚</p>
<h2 id="é€‰æ‹©æ€§æš´éœ²æ–¹æ³•"><a href="#é€‰æ‹©æ€§æš´éœ²æ–¹æ³•" class="headerlink" title="é€‰æ‹©æ€§æš´éœ²æ–¹æ³•"></a>é€‰æ‹©æ€§æš´éœ²æ–¹æ³•</h2><p>æœ‰æ—¶ä¸æƒ³æš´éœ² <code>CrudRepository</code> é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿æˆ‘ä»¬è®¤ä¸ºéœ€è¦æš´éœ²çš„é‚£äº›æ–¹æ³•çš„æ¥å£ã€‚</p>
<p>å‡å¦‚ <code>UserRepository</code> åªæƒ³æš´éœ² <code>findOne</code> å’Œ <code>save</code>ï¼Œé™¤äº†è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹å¤–ä¸å…è®¸ä»»ä½•çš„ User æ“ä½œï¼Œå…¶åšæ³•å¦‚ä¸‹ï¼š</p>
<p>é€‰æ‹©æ€§åœ°æš´éœ² CRUD æ–¹æ³•ï¼Œç›´æ¥ç»§æ‰¿Repositoryï¼ˆå› ä¸ºè¿™é‡Œé¢æ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼‰ï¼ŒæŠŠ<code>CrudRepository</code> é‡Œé¢çš„ <code>save</code> å’Œ <code>findOne</code> æ–¹æ³•å¤åˆ¶åˆ°æˆ‘ä»¬è‡ªå·±çš„ <code>MyBaseRepository</code> æ¥å£å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NoRepositoryBean</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MyBaseRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span> <span class="keyword">extends</span> <span class="title">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">findOne</span><span class="params">(ID id)</span></span>; </span><br><span class="line">    <span class="function">T <span class="title">save</span><span class="params">(T entity)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">MyBaseRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">     <span class="function">User <span class="title">findByEmailAddress</span><span class="params">(String emailAddress)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·åœ¨ Service å±‚å°±åªæœ‰ <code>findOne</code>ã€<code>save</code>ã€<code>findByEmailAddress</code> è¿™ 3 ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨ï¼Œä¸ä¼šæœ‰æ›´å¤šæ–¹æ³•äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ SimpleJpaRepository é‡Œé¢ä»»æ„å·²ç»å®ç°çš„æ–¹æ³•åšé€‰æ‹©æ€§æš´éœ²ã€‚</p>
<blockquote>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¾—å‡ºä»¥ä¸‹ 2 ç‚¹ç»“è®ºï¼š</p>
<ul>
<li>MyRepository Extends Repository æ¥å£å¯ä»¥å®ç° Defining Query Methods çš„åŠŸèƒ½ï¼›</li>
<li>ç»§æ‰¿å…¶ä»– Repository çš„å­æ¥å£ï¼Œæˆ–è€…è‡ªå®šä¹‰å­æ¥å£ï¼Œå¯ä»¥é€‰æ‹©æ€§åœ°æš´éœ² SimpleJpaRepository é‡Œé¢å·²ç»å®ç°çš„åŸºç¡€å…¬ç”¨æ–¹æ³•ã€‚</li>
</ul>
</blockquote>
<h2 id="æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½®"><a href="#æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½®" class="headerlink" title="æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½®"></a>æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½®</h2><p>é¸¡è‚‹ã€‚ã€‚</p>
<p>é€šè¿‡ @EnableJpaRepositories æ³¨è§£æ¥é…ç½®æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥ï¼Œè¯¦ç»†é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableJpaRepositories(queryLookupStrategy= QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND)</span></span><br></pre></td></tr></table></figure>

<p>QueryLookupStrategy.Key çš„å€¼å…± 3 ä¸ªï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>Create</strong>ï¼šç›´æ¥æ ¹æ®æ–¹æ³•åè¿›è¡Œåˆ›å»ºï¼Œè§„åˆ™æ˜¯æ ¹æ®æ–¹æ³•åç§°çš„æ„é€ è¿›è¡Œå°è¯•ï¼Œä¸€èˆ¬çš„æ–¹æ³•æ˜¯ä»æ–¹æ³•åä¸­åˆ é™¤ç»™å®šçš„ä¸€ç»„å·²çŸ¥å‰ç¼€ï¼Œå¹¶è§£æè¯¥æ–¹æ³•çš„å…¶ä½™éƒ¨åˆ†ã€‚å¦‚æœæ–¹æ³•åä¸ç¬¦åˆè§„åˆ™ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç†è§£ä¸ºï¼Œå³ä½¿é…ç½®äº† @Query ä¹Ÿæ˜¯æ²¡æœ‰ç”¨çš„ã€‚</li>
<li><strong>USE_DECLARED_QUERY</strong>ï¼šå£°æ˜æ–¹å¼åˆ›å»ºï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šå°è¯•æ‰¾åˆ°ä¸€ä¸ªå£°æ˜çš„æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¯ä»¥ç†è§£ä¸ºå¿…é¡»é…ç½® @Queryã€‚</li>
<li><strong>CREATE_IF_NOT_FOUND</strong>ï¼šè¿™ä¸ªæ˜¯==é»˜è®¤çš„==ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ä»¥ä¸Š 2 ç§æ–¹å¼çš„å…¼å®¹ç‰ˆã€‚å…ˆç”¨å£°æ˜æ–¹å¼ï¼ˆ@Queryï¼‰è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸æ–¹æ³•ç›¸åŒ¹é…çš„æŸ¥è¯¢ï¼Œé‚£ç”¨ Create çš„æ–¹æ³•ååˆ›å»ºè§„åˆ™åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢ï¼›è¿™ä¸¤è€…éƒ½ä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å°±ä¼šæŠ¥é”™ã€‚</li>
</ul>
<p>ä»¥ Spring Boot é¡¹ç›®ä¸ºä¾‹ï¼Œæ›´æ”¹å…¶é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableJpaRepositories(queryLookupStrategy= QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example1Application</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      SpringApplication.run(Example1Application.class, args);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Defining-Query-Method-è¯­æ³•"><a href="#Defining-Query-Method-è¯­æ³•" class="headerlink" title="Defining Query Method è¯­æ³•"></a>Defining Query Method è¯­æ³•</h2><blockquote>
<p>å¸¦æŸ¥è¯¢åŠŸèƒ½çš„æ–¹æ³•åï¼šæŸ¥è¯¢ç­–ç•¥ï¼ˆå…³é”®å­—ï¼‰+ æŸ¥è¯¢å­—æ®µ + ä¸€äº›é™åˆ¶æ€§æ¡ä»¶</p>
<p>å…·æœ‰è¯­ä¹‰æ¸…æ™°ã€åŠŸèƒ½å®Œæ•´çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å®é™…å·¥ä½œä¸­ 80% çš„ API æŸ¥è¯¢éƒ½å¯ä»¥ç®€å•å®ç°ã€‚</p>
</blockquote>
<p>ä¸¾ä¾‹è¯´æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PersonRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">// and çš„æŸ¥è¯¢å…³ç³»</span></span><br><span class="line">   <span class="function">List&lt;User&gt; <span class="title">findByEmailAddressAndLastname</span><span class="params">(EmailAddress emailAddress, String lastname)</span></span>;</span><br><span class="line">   <span class="comment">// åŒ…å« distinct å»é‡ï¼Œor çš„ sql è¯­æ³•</span></span><br><span class="line">   <span class="function">List&lt;User&gt; <span class="title">findDistinctPeopleByLastnameOrFirstname</span><span class="params">(String lastname, String firstname)</span></span>;</span><br><span class="line">   <span class="comment">// æ ¹æ® lastname å­—æ®µæŸ¥è¯¢å¿½ç•¥å¤§å°å†™</span></span><br><span class="line">   <span class="function">List&lt;User&gt; <span class="title">findByLastnameIgnoreCase</span><span class="params">(String lastname)</span></span>;</span><br><span class="line">   <span class="comment">// æ ¹æ® lastname å’Œ firstname æŸ¥è¯¢ equal å¹¶ä¸”å¿½ç•¥å¤§å°å†™</span></span><br><span class="line">   <span class="function">List&lt;User&gt; <span class="title">findByLastnameAndFirstnameAllIgnoreCase</span><span class="params">(String lastname, String firstname)</span></span>; </span><br><span class="line">  <span class="comment">// å¯¹æŸ¥è¯¢ç»“æœæ ¹æ® lastname æ’åºï¼Œæ­£åº</span></span><br><span class="line">   <span class="function">List&lt;User&gt; <span class="title">findByLastnameOrderByFirstnameAsc</span><span class="params">(String lastname)</span></span>;</span><br><span class="line">Â  <span class="comment">// å¯¹æŸ¥è¯¢ç»“æœæ ¹æ® lastname æ’åºï¼Œå€’åº</span></span><br><span class="line">   <span class="function">List&lt;User&gt; <span class="title">findByLastnameOrderByFirstnameDesc</span><span class="params">(String lastname)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¸¸ç”¨çš„å…³é”®å­—åˆ—è¡¨"><a href="#å¸¸ç”¨çš„å…³é”®å­—åˆ—è¡¨" class="headerlink" title="å¸¸ç”¨çš„å…³é”®å­—åˆ—è¡¨"></a>å¸¸ç”¨çš„å…³é”®å­—åˆ—è¡¨</h2><table>
<thead>
<tr>
<th align="center">Keyword</th>
<th align="center">Sample</th>
<th align="center">JPQL snippet</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>And</code></td>
<td align="center"><code>findByLastnameAndFirstname</code></td>
<td align="center"><code>â€¦ where x.lastname = ?1 and x.firstname = ?2</code></td>
</tr>
<tr>
<td align="center"><code>Or</code></td>
<td align="center"><code>findByLastnameOrFirstname</code></td>
<td align="center"><code>â€¦ where x.lastname = ?1 or x.firstname = ?2</code></td>
</tr>
<tr>
<td align="center"><code>Is</code>, <code>Equals</code></td>
<td align="center"><code>findByFirstname</code>  <code>findByFirstnameIs</code> <code>findByFirstnameEquals</code></td>
<td align="center"><code>â€¦ where x.firstname = ?1</code></td>
</tr>
<tr>
<td align="center"><code>Between</code></td>
<td align="center"><code>findByStartDateBetween</code></td>
<td align="center"><code>â€¦ where x.startDate between ?1 and ?2</code></td>
</tr>
<tr>
<td align="center"><code>LessThan</code></td>
<td align="center"><code>findByAgeLessThan</code></td>
<td align="center"><code>â€¦ where x.age &lt; ?1</code></td>
</tr>
<tr>
<td align="center"><code>LessThanEqual</code></td>
<td align="center"><code>findByAgeLessThanEqual</code></td>
<td align="center"><code>â€¦ where x.age &lt;= ?1</code></td>
</tr>
<tr>
<td align="center"><code>GreaterThan</code></td>
<td align="center"><code>findByAgeGreaterThan</code></td>
<td align="center"><code>â€¦ where x.age &gt; ?1</code></td>
</tr>
<tr>
<td align="center"><code>GreaterThanEqual</code></td>
<td align="center"><code>findByAgeGreaterThanEqual</code></td>
<td align="center"><code>â€¦ where x.age &gt;= ?1</code></td>
</tr>
<tr>
<td align="center"><code>After</code></td>
<td align="center"><code>findByStartDateAfter</code></td>
<td align="center"><code>â€¦ where x.startDate &gt; ?1</code></td>
</tr>
<tr>
<td align="center"><code>Before</code></td>
<td align="center"><code>findByStartDateBefore</code></td>
<td align="center"><code>â€¦ where x.startDate &lt; ?1</code></td>
</tr>
<tr>
<td align="center"><code>IsNull</code>, <code>Null</code></td>
<td align="center"><code>findByAge(Is)Null</code></td>
<td align="center"><code>â€¦ where x.age is null</code></td>
</tr>
<tr>
<td align="center"><code>IsNotNull</code>, <code>NotNull</code></td>
<td align="center"><code>findByAge(Is)NotNull</code></td>
<td align="center"><code>â€¦ where x.age not null</code></td>
</tr>
<tr>
<td align="center"><code>Like</code></td>
<td align="center"><code>findByFirstnameLike</code></td>
<td align="center"><code>â€¦ where x.firstname like ?1</code></td>
</tr>
<tr>
<td align="center"><code>NotLike</code></td>
<td align="center"><code>findByFirstnameNotLike</code></td>
<td align="center"><code>â€¦ where x.firstname not like ?1</code></td>
</tr>
<tr>
<td align="center"><code>StartingWith</code></td>
<td align="center"><code>findByFirstnameStartingWith</code></td>
<td align="center"><code>â€¦ where x.firstname like ?1</code> (parameter bound with appended <code>%</code>)</td>
</tr>
<tr>
<td align="center"><code>EndingWith</code></td>
<td align="center"><code>findByFirstnameEndingWith</code></td>
<td align="center"><code>â€¦ where x.firstname like ?1</code> (parameter bound with prepended <code>%</code>)</td>
</tr>
<tr>
<td align="center"><code>Containing</code></td>
<td align="center"><code>findByFirstnameContaining</code></td>
<td align="center"><code>â€¦ where x.firstname like ?1</code> (parameter bound wrapped in <code>%</code>)</td>
</tr>
<tr>
<td align="center"><code>OrderBy</code></td>
<td align="center"><code>findByAgeOrderByLastnameDesc</code></td>
<td align="center"><code>â€¦ where x.age = ?1 order by x.lastname desc</code></td>
</tr>
<tr>
<td align="center"><code>Not</code></td>
<td align="center"><code>findByLastnameNot</code></td>
<td align="center"><code>â€¦ where x.lastname &lt;&gt; ?1</code></td>
</tr>
<tr>
<td align="center"><code>In</code></td>
<td align="center"><code>findByAgeIn(Collection&lt;Age&gt; ages)</code></td>
<td align="center"><code>â€¦ where x.age in ?1</code></td>
</tr>
<tr>
<td align="center"><code>NotIn</code></td>
<td align="center"><code>findByAgeNotIn(Collection&lt;Age&gt; ages)</code></td>
<td align="center"><code>â€¦ where x.age not in ?1</code></td>
</tr>
<tr>
<td align="center"><code>True</code></td>
<td align="center"><code>findByActiveTrue()</code></td>
<td align="center"><code>â€¦ where x.active = true</code></td>
</tr>
<tr>
<td align="center"><code>False</code></td>
<td align="center"><code>findByActiveFalse()</code></td>
<td align="center"><code>â€¦ where x.active = false</code></td>
</tr>
<tr>
<td align="center"><code>IgnoreCase</code></td>
<td align="center"><code>findByFirstnameIgnoreCase</code></td>
<td align="center"><code>â€¦ where UPPER(x.firstame) = UPPER(?1)</code></td>
</tr>
</tbody></table>
<blockquote>
<p>ç»¼ä¸Šï¼Œæ€»ç»“ 3 ç‚¹ç»éªŒï¼š</p>
<ul>
<li>æ–¹æ³•åçš„è¡¨è¾¾å¼é€šå¸¸æ˜¯å®ä½“å±æ€§è¿æ¥è¿ç®—ç¬¦çš„ç»„åˆï¼Œå¦‚ Andã€orã€Betweenã€LessThanã€GreaterThanã€Like ç­‰å±æ€§è¿æ¥è¿ç®—è¡¨è¾¾å¼ï¼Œä¸åŒçš„æ•°æ®åº“ï¼ˆNoSQLã€MySQLï¼‰å¯èƒ½äº§ç”Ÿçš„æ•ˆæœä¸ä¸€æ ·ï¼Œå¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æ‰“å¼€ SQL æ—¥å¿—è§‚å¯Ÿã€‚</li>
<li>IgnoreCase å¯ä»¥é’ˆå¯¹å•ä¸ªå±æ€§ï¼ˆå¦‚ findByLastnameIgnoreCase(â€¦)ï¼‰ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹æŸ¥è¯¢æ¡ä»¶é‡Œé¢æ‰€æœ‰çš„å®ä½“å±æ€§å¿½ç•¥å¤§å°å†™ï¼ˆæ‰€æœ‰å±æ€§å¿…é¡»åœ¨ String æƒ…å†µä¸‹ï¼Œå¦‚ findByLastnameAndFirstnameAllIgnoreCase(â€¦)ï¼‰ã€‚</li>
<li>OrderBy å¯ä»¥åœ¨æŸäº›å±æ€§çš„æ’åºä¸Šæä¾›æ–¹å‘ï¼ˆAsc æˆ– Descï¼‰ï¼Œç§°ä¸ºé™æ€æ’åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªæ–¹ä¾¿çš„å‚æ•° Sort å®ç°æŒ‡å®šå­—æ®µçš„åŠ¨æ€æ’åºçš„æŸ¥è¯¢æ–¹æ³•ï¼ˆå¦‚ repository.findAll(Sort.by(Sort.Direction.ASC, â€œmyFieldâ€))ï¼‰ã€‚</li>
</ul>
</blockquote>
<p>ä¸Šè¿°è¡¨æ ¼è™½ç„¶å¤§å¤šæ˜¯ find å¼€å¤´çš„æ–¹æ³•ï¼Œä½†å…¶å® JPA è¿˜æ”¯æŒ readã€getã€queryã€streamã€countã€existsã€deleteã€remove ç­‰å‰ç¼€ï¼Œå¦‚å­—é¢æ„æ€ä¸€æ ·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ countã€deleteã€remove çš„ä¾‹å­ï¼Œå…¶ä»–å‰ç¼€å¯ä»¥ä¸¾ä¸€åä¸‰ã€‚å®ä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ€»æ•°</span></span><br><span class="line">     <span class="function"><span class="keyword">long</span> <span class="title">countByLastname</span><span class="params">(String lastname)</span></span>;</span><br><span class="line">    <span class="comment">// æ ¹æ®ä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ é™¤æ“ä½œï¼Œå¹¶è¿”å›åˆ é™¤è¡Œæ•°</span></span><br><span class="line">     <span class="function"><span class="keyword">long</span> <span class="title">deleteByLastname</span><span class="params">(String lastname)</span></span>;</span><br><span class="line">    <span class="comment">// æ ¹æ® Lastname åˆ é™¤ä¸€å † Userï¼Œå¹¶è¿”å›åˆ é™¤çš„ User</span></span><br><span class="line">     <span class="function">List&lt;User&gt; <span class="title">removeByLastname</span><span class="params">(String lastname)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é”®å­—éƒ½å®šä¹‰åœ¨ä¸‹é¢ä¸¤ä¸ªç±»é‡Œé¢</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.data.repository.query.parser.PartTree</span><br><span class="line">org.springframework.data.repository.query.parser.Part</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20200924192709.png" alt=""></p>
<p><img src="http://image.leonote.cn//20200924192724.png" alt=""></p>
<p>çœ‹æºç å°±å¯ä»¥çŸ¥é“æ¡†æ¶æ”¯æŒäº†å“ªäº›é€»è¾‘å…³é”®å­—ï¼Œæ¯”å¦‚ NotInã€Likeã€Inã€Exists ç­‰ï¼Œæœ‰çš„æ—¶å€™æ¯”æŸ¥æ–‡æ¡£å’Œä»»ä½•äººå†™çš„åšå®¢éƒ½å‡†ç¡®ã€è¿˜å¿«ã€‚</p>
<h2 id="Sort-æ’åºå’Œ-Pageable-åˆ†é¡µ"><a href="#Sort-æ’åºå’Œ-Pageable-åˆ†é¡µ" class="headerlink" title="Sort æ’åºå’Œ Pageable åˆ†é¡µ"></a>Sort æ’åºå’Œ Pageable åˆ†é¡µ</h2><p>Sort åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥å®ç°åŠ¨æ€æ’åº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Sort</span><span class="params">(Direction direction, String... properties)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>(direction, properties == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;&gt;() : Arrays.asList(properties));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Sort é‡Œé¢å†³å®šäº†æˆ‘ä»¬å“ªäº›å­—æ®µçš„æ’åºæ–¹å‘ï¼ˆASC æ­£åºã€DESC å€’åºï¼‰</p>
<p>Pageable åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥å®ç°åˆ†é¡µæ•ˆæœå’ŒåŠ¨æ€æ’åºåŒé‡æ•ˆæœ</p>
<p>Pageable çš„ Structureï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20200924193232.png" alt=""></p>
<h3 id="æ–¹æ³•ä¸€ï¼šPage"><a href="#æ–¹æ³•ä¸€ï¼šPage" class="headerlink" title="æ–¹æ³•ä¸€ï¼šPage"></a>æ–¹æ³•ä¸€ï¼šPage</h3><p>å…è®¸å°† org.springframework.data.domain.Pageable å®ä¾‹ä¼ é€’ç»™æŸ¥è¯¢æ–¹æ³•ï¼Œå°†åˆ†é¡µå‚æ•°æ·»åŠ åˆ°é™æ€å®šä¹‰çš„æŸ¥è¯¢ä¸­ï¼Œé€šè¿‡ Page è¿”å›çš„ç»“æœå¾—çŸ¥å¯ç”¨çš„å…ƒç´ å’Œé¡µé¢çš„æ€»æ•°ã€‚</p>
<p>è¿™ç§åˆ†é¡µæŸ¥è¯¢æ–¹æ³•å¯èƒ½æ˜¯æ˜‚è´µçš„ï¼ˆ<strong>ä¼šé»˜è®¤æ‰§è¡Œä¸€æ¡ count çš„ SQL è¯­å¥</strong>ï¼‰ï¼Œæ‰€ä»¥ç”¨çš„æ—¶å€™è¦è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Page&lt;User&gt; <span class="title">findByLastname</span><span class="params">(String lastname, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ³•äºŒï¼šSlice"><a href="#æ–¹æ³•äºŒï¼šSlice" class="headerlink" title="æ–¹æ³•äºŒï¼šSlice"></a>æ–¹æ³•äºŒï¼šSlice</h3><p>è¿”å›ç»“æœæ˜¯ Sliceï¼Œå› ä¸ºåªçŸ¥é“æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ª Slice å¯ç”¨ï¼Œè€Œä¸çŸ¥é“ countï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¾ƒå¤§çš„ç»“æœé›†æ—¶ï¼ŒåªçŸ¥é“æ•°æ®æ˜¯è¶³å¤Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨åœ¨ä¸šåŠ¡åœºæ™¯ä¸­æ—¶ä¸ç”¨å…³å¿ƒä¸€å…±æœ‰å¤šå°‘é¡µã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Slice&lt;User&gt; <span class="title">findByLastname</span><span class="params">(String lastname, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="æ–¹æ³•ä¸‰ï¼šList"><a href="#æ–¹æ³•ä¸‰ï¼šList" class="headerlink" title="æ–¹æ³•ä¸‰ï¼šList"></a>æ–¹æ³•ä¸‰ï¼šList</h3><p>å¦‚æœåªéœ€è¦æ’åºï¼Œéœ€åœ¨ org.springframework.data.domain.Sort å‚æ•°ä¸­æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œæ­£å¦‚ä¸Šé¢çœ‹åˆ°çš„ï¼Œåªéœ€è¿”å›ä¸€ä¸ª List ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;User&gt; <span class="title">findByLastname</span><span class="params">(String lastname, Sort sort)</span></span>;</span><br></pre></td></tr></table></figure>

<p>æ’åºé€‰é¡¹ä¹Ÿé€šè¿‡ Pageable å®ä¾‹å¤„ç†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPage å°†ä¸ä¼šåˆ›å»ºæ„å»ºå®é™…å®ä¾‹æ‰€éœ€çš„é™„åŠ å…ƒæ•°æ®ï¼ˆå³ä¸éœ€è¦è®¡ç®—å’ŒæŸ¥è¯¢åˆ†é¡µç›¸å…³æ•°æ®ï¼‰ï¼Œè€Œä»…ä»…ç”¨æ¥åšé™åˆ¶æŸ¥è¯¢ç»™å®šèŒƒå›´çš„å®ä½“ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;User&gt; <span class="title">findByLastname</span><span class="params">(String lastname, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>

<p>PageRequest é‡Œé¢æä¾›çš„å‡ ä¸ª of é™æ€æ–¹æ³•ï¼ˆå¤šæ€ï¼‰ï¼Œåˆ†åˆ«æ„å»ºé¡µç ã€é¡µé¢å¤§å°ã€æ’åºç­‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æŸ¥è¯¢useré‡Œé¢çš„lastname=jkçš„ç¬¬ä¸€é¡µï¼Œæ¯é¡µå¤§å°æ˜¯20æ¡ï¼›å¹¶ä¼šè¿”å›ä¸€å…±æœ‰å¤šå°‘é¡µçš„ä¿¡æ¯</span></span><br><span class="line">Page&lt;User&gt; users = userRepository.findByLastname(<span class="string">&quot;jk&quot;</span>, PageRequest.of(<span class="number">1</span>, <span class="number">20</span>));</span><br><span class="line"><span class="comment">//æŸ¥è¯¢useré‡Œé¢çš„lastname=jkçš„ç¬¬ä¸€é¡µçš„20æ¡æ•°æ®ï¼Œä¸çŸ¥é“ä¸€å…±å¤šå°‘æ¡</span></span><br><span class="line">Slice&lt;User&gt;Â users = userRepository.findByLastname(<span class="string">&quot;jk&quot;</span>, PageRequest.of(<span class="number">1</span>, <span class="number">20</span>));</span><br><span class="line"><span class="comment">//æŸ¥è¯¢å‡ºæ¥æ‰€æœ‰çš„useré‡Œé¢çš„lastname=jkçš„Useræ•°æ®ï¼Œå¹¶æŒ‰ç…§nameæ­£åºè¿”å›List</span></span><br><span class="line">List&lt;User&gt;Â users =Â userRepository.findByLastname(<span class="string">&quot;jk&quot;</span>, <span class="keyword">new</span> Sort(Sort.Direction.ASC, <span class="string">&quot;name&quot;</span>))</span><br><span class="line"><span class="comment">//æŒ‰ç…§createdAtå€’åºï¼ŒæŸ¥è¯¢å‰ä¸€ç™¾æ¡Useræ•°æ®</span></span><br><span class="line">List&lt;User&gt;Â users =Â userRepository.findByLastname(<span class="string">&quot;jk&quot;</span>, PageRequest.of(<span class="number">0</span>, <span class="number">100</span>, Sort.Direction.DESC, <span class="string">&quot;createdAt&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="é™åˆ¶æŸ¥è¯¢ç»“æœ-First-å’Œ-Top"><a href="#é™åˆ¶æŸ¥è¯¢ç»“æœ-First-å’Œ-Top" class="headerlink" title="é™åˆ¶æŸ¥è¯¢ç»“æœ First å’Œ Top"></a>é™åˆ¶æŸ¥è¯¢ç»“æœ First å’Œ Top</h2><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³ç›´æ¥æŸ¥è¯¢å‰å‡ æ¡æ•°æ®ï¼Œä¹Ÿä¸éœ€è¦åŠ¨æ€æ’åºï¼Œé‚£ä¹ˆå°±å¯ä»¥ç®€å•åœ°åœ¨æ–¹æ³•åå­—ä¸­ä½¿ç”¨ First å’Œ Top å…³é”®å­—ï¼Œæ¥é™åˆ¶è¿”å›æ¡æ•°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ userRepository é‡Œé¢å®šä¹‰çš„ä¸€äº›é™åˆ¶è¿”å›ç»“æœçš„ä½¿ç”¨ã€‚åœ¨æŸ¥è¯¢æ–¹æ³•ä¸ŠåŠ é™åˆ¶æŸ¥è¯¢ç»“æœçš„å…³é”®å­— First å’Œ Topã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">User <span class="title">findFirstByOrderByLastnameAsc</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">User <span class="title">findTopByOrderByAgeDesc</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findDistinctUserTop3ByLastname</span><span class="params">(String lastname, Pageable pageable)</span></span>;</span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findFirst10ByLastname</span><span class="params">(String lastname, Sort sort)</span></span>;</span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findTop10ByLastname</span><span class="params">(String lastname, Pageable pageable)</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>æŸ¥è¯¢æ–¹æ³•åœ¨ä½¿ç”¨ First æˆ– Top æ—¶ï¼Œæ•°å€¼å¯ä»¥è¿½åŠ åˆ° First æˆ– Top åé¢ï¼ŒæŒ‡å®šè¿”å›æœ€å¤§ç»“æœçš„å¤§å°ï¼›</li>
<li>å¦‚æœæ•°å­—è¢«çœç•¥ï¼Œåˆ™å‡è®¾ç»“æœå¤§å°ä¸º 1ï¼›</li>
<li>é™åˆ¶è¡¨è¾¾å¼ä¹Ÿæ”¯æŒ Distinct å…³é”®å­—ï¼›</li>
<li>å¦‚æœå°† Pageable ä½œä¸ºå‚æ•°ï¼Œä»¥ Top å’Œ First åé¢çš„æ•°å­—ä¸ºå‡†ï¼Œå³åˆ†é¡µå°†åœ¨é™åˆ¶ç»“æœä¸­åº”ç”¨ã€‚</li>
</ul>
</blockquote>
<h2 id="NonNullã€-NonNullApiã€-Nullable"><a href="#NonNullã€-NonNullApiã€-Nullable" class="headerlink" title="@NonNullã€@NonNullApiã€@Nullable"></a>@NonNullã€@NonNullApiã€@Nullable</h2><p>ä» Spring Data 2.0 å¼€å§‹ï¼ŒJPA æ–°å¢äº†<a href="https://docs.spring.io/spring-framework/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/NonNull.html">@NonNull</a> <a href="https://docs.spring.io/spring-framework/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/NonNullApi.html">@NonNullApi</a> <a href="https://docs.spring.io/spring/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/Nullable.html">@Nullable</a>ï¼Œæ˜¯å¯¹ null çš„å‚æ•°å’Œè¿”å›ç»“æœåšçš„æ”¯æŒã€‚</p>
<ul>
<li><p>@NonNullApiï¼šåœ¨<strong>åŒ…çº§åˆ«</strong>ç”¨äºå£°æ˜å‚æ•°ï¼Œä»¥åŠè¿”å›å€¼çš„é»˜è®¤è¡Œä¸ºæ˜¯ä¸æ¥å—æˆ–äº§ç”Ÿç©ºå€¼çš„ã€‚</p>
</li>
<li><p>@NonNullï¼šç”¨äºä¸èƒ½ä¸ºç©ºçš„å‚æ•°æˆ–è¿”å›å€¼ï¼ˆåœ¨ @NonNullApi é€‚ç”¨çš„å‚æ•°å’Œè¿”å›å€¼ä¸Šä¸éœ€è¦ï¼‰ã€‚</p>
</li>
<li><p>@Nullableï¼šç”¨äºå¯ä»¥ä¸ºç©ºçš„å‚æ•°æˆ–è¿”å›å€¼ã€‚</p>
</li>
</ul>
<p>æˆ‘åœ¨è‡ªå·±çš„ Repository æ‰€åœ¨ package çš„ package-info.java ç±»é‡Œé¢åšå¦‚ä¸‹å£°æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@org</span>.springframework.lang.NonNullApi</span><br><span class="line"><span class="keyword">package</span> com.myrespository;</span><br></pre></td></tr></table></figure>

<p>myRepository ä¸‹é¢çš„ UserRepository å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myrespository;                  </span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">Repository</span>&lt;<span class="title">User</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">User <span class="title">getByEmailAddress</span><span class="params">(EmailAddress emailAddress)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™å½“ emailAddress å‚æ•°ä¸º null çš„æ—¶å€™å°±ä¼šæŠ›å¼‚å¸¸ï¼Œå½“è¿”å›ç»“æœä¸º null çš„æ—¶å€™ä¹Ÿä¼šæŠ›å¼‚å¸¸ã€‚å› ä¸ºæˆ‘ä»¬åœ¨package çš„ package-info.javaé‡Œé¢æŒ‡å®šäº† NonNullApiï¼Œæ‰€æœ‰è¿”å›ç»“æœå’Œå‚æ•°ä¸èƒ½ä¸º Nullã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å½“æˆ‘ä»¬æ·»åŠ  @Nullable æ³¨è§£ä¹‹åï¼Œå‚æ•°å’Œè¿”å›ç»“æœè¿™ä¸ªæ—¶å€™å°±éƒ½ä¼šå…è®¸ä¸º null äº†ï¼›</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">User <span class="title">findByEmailAddress</span><span class="params">(<span class="meta">@Nullable</span> EmailAddress emailAdress)</span></span>;</span><br><span class="line"><span class="comment">//è¿”å›ç»“æœå…è®¸ä¸º nullï¼Œå‚æ•°ä¸å…è®¸ä¸º null çš„æƒ…å†µ</span></span><br><span class="line"><span class="function">Optional&lt;User&gt; <span class="title">findOptionalByEmailAddress</span><span class="params">(EmailAddress emailAddress)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œä¹Ÿå¯ä»¥å°†æ–¹æ³•åï¼ˆéå¸¸è¯­ä¹‰åŒ–çš„ repository é‡Œé¢æ‰€å®šä¹‰æ–¹æ³•å‘½åè§„èŒƒï¼‰çš„å¼ºåˆ¶çº¦å®šè§„èŒƒè¿ç”¨åˆ° controller å’Œ service å±‚ï¼Œè¿™æ ·å…¨éƒ¨ç»Ÿä¸€åï¼Œå¯ä»¥å‡å°‘å¾ˆå¤šçš„æ²Ÿé€šæˆæœ¬ã€‚Spring Data Common é‡Œé¢çš„ repository åŸºç±»ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥åº”ç”¨æ¨å¹¿åˆ° service å±‚å‘¢ï¼Ÿèƒ½å¦ä¹Ÿå»ºç«‹ä¸€ä¸ªè‡ªå·±çš„ baseServiceï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„å®æˆ˜ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseService</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Class&lt;T&gt; <span class="title">getDomainClass</span><span class="params">()</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">S <span class="title">save</span><span class="params">(S entity)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">saveAll</span><span class="params">(Iterable&lt;S&gt; entities)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(T entity)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(ID id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">(Iterable&lt;? extends T&gt; entities)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteInBatch</span><span class="params">(Iterable&lt;T&gt; entities)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAllInBatch</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">T <span class="title">getOne</span><span class="params">(ID id)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">Optional&lt;S&gt; <span class="title">findOne</span><span class="params">(Example&lt;S&gt; example)</span></span>;</span><br><span class="line">    <span class="function">Optional&lt;T&gt; <span class="title">findById</span><span class="params">(ID id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">findAll</span><span class="params">(Sort sort)</span></span>;</span><br><span class="line">    <span class="function">Page&lt;T&gt; <span class="title">findAll</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; example)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; example, Sort sort)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">Page&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; example, Pageable pageable)</span></span>;</span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">findAllById</span><span class="params">(Iterable&lt;ID&gt; ids)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function"><span class="keyword">long</span> <span class="title">count</span><span class="params">(Example&lt;S&gt; example)</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">(Example&lt;S&gt; example)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">existsById</span><span class="params">(ID id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line">    &lt;S extends T&gt; <span class="function">S <span class="title">saveAndFlush</span><span class="params">(S entity)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¨¡ä»¿ JpaRepository æ¥å£ä¹Ÿè‡ªå®šä¹‰äº†ä¸€ä¸ªè‡ªå·±çš„ BaseServiceï¼Œå£°æ˜äº†å¸¸ç”¨çš„ CRUDæ“ä½œã€‚å½“ç„¶äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥å»ºç«‹è‡ªå·±çš„ PagingAndSortingServiceã€ComplexityServiceã€SampleService ç­‰æ¥åˆ’åˆ†ä¸åŒçš„ serviceæ¥å£ï¼Œä¾›ä¸åŒç›®çš„ Service å­ç±»ç»§æ‰¿ã€‚</p>
<p>æˆ‘ä»¬å†æ¥æ¨¡ä»¿ä¸€ä¸ª SimpleJpaRepositoryï¼Œæ¥å®ç°è‡ªå·±çš„ BaseService çš„å®ç°ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseServiceImpl</span>&lt;<span class="title">T</span>, <span class="title">ID</span>, <span class="title">R</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt;&gt; <span class="keyword">implements</span> <span class="title">BaseService</span>&lt;<span class="title">T</span>, <span class="title">ID</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class, Class&gt; DOMAIN_CLASS_CACHE = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> R repository;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseServiceImpl</span><span class="params">(R repository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.repository = repository;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getDomainClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class thisClass = getClass();</span><br><span class="line">        Class&lt;T&gt; domainClass = DOMAIN_CLASS_CACHE.get(thisClass);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(domainClass)) &#123;</span><br><span class="line">            domainClass = GenericsUtils.getGenericClass(thisClass, <span class="number">0</span>);</span><br><span class="line">            DOMAIN_CLASS_CACHE.putIfAbsent(thisClass, domainClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> domainClass;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> R <span class="title">getRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">S <span class="title">save</span><span class="params">(S entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.save(entity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">saveAll</span><span class="params">(Iterable&lt;S&gt; entities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.saveAll(entities);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(T entity)</span> </span>&#123;</span><br><span class="line">        repository.delete(entity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(ID id)</span> </span>&#123;</span><br><span class="line">        repository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        repository.deleteAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">(Iterable&lt;? extends T&gt; entities)</span> </span>&#123;</span><br><span class="line">        repository.deleteAll(entities);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteInBatch</span><span class="params">(Iterable&lt;T&gt; entities)</span> </span>&#123;</span><br><span class="line">        repository.deleteInBatch(entities);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAllInBatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        repository.deleteAllInBatch();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getOne</span><span class="params">(ID id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.getOne(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">Optional&lt;S&gt; <span class="title">findOne</span><span class="params">(Example&lt;S&gt; example)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findOne(example);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Optional&lt;T&gt; <span class="title">findById</span><span class="params">(ID id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">findAll</span><span class="params">(Sort sort)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(sort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Page&lt;T&gt; <span class="title">findAll</span><span class="params">(Pageable pageable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(pageable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; example)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(example);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">List&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; example, Sort sort)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(example, sort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">Page&lt;S&gt; <span class="title">findAll</span><span class="params">(Example&lt;S&gt; example, Pageable pageable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(example, pageable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">findAllById</span><span class="params">(Iterable&lt;ID&gt; ids)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAllById(ids);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.count();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function"><span class="keyword">long</span> <span class="title">count</span><span class="params">(Example&lt;S&gt; example)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.count(example);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">(Example&lt;S&gt; example)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.exists(example);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">existsById</span><span class="params">(ID id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.existsById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        repository.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;S extends T&gt; <span class="function">S <span class="title">saveAndFlush</span><span class="params">(S entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.saveAndFlush(entity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»£ç å°±æ˜¯ BaseService å¸¸ç”¨çš„ CURL å®ç°ä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œé¢å¤§éƒ¨åˆ†ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨ Repository æä¾›çš„æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç»§æ‰¿ BaseServiceImpl çš„æ—¶å€™éœ€è¦ä¼ é€’è‡ªå·±çš„ Repositoryï¼Œå¦‚ä¸‹é¢å®ä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">BaseServiceImpl</span>&lt;<span class="title">User</span>, <span class="title">Long</span>, <span class="title">UserRepository</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserRepository repository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(repository);</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Defining Query Methods</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa DataSource åŠ è½½è¿‡ç¨‹</title>
    <url>/2020/10/14/SpringDataJpa%E7%9A%84DataSource%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="DataSource-ä¸ºä½•ç‰©ï¼ŸåŠ è½½è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ"><a href="#DataSource-ä¸ºä½•ç‰©ï¼ŸåŠ è½½è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ" class="headerlink" title="DataSource ä¸ºä½•ç‰©ï¼ŸåŠ è½½è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ"></a>DataSource ä¸ºä½•ç‰©ï¼ŸåŠ è½½è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</h1><h2 id="æ•°æ®æºæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ•°æ®æºæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ•°æ®æºæ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ•°æ®æºæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å½“æˆ‘ä»¬ç”¨ç¬¬ä¸‰æ–¹å·¥å…·å»è¿æ¥æ•°æ®åº“ï¼ˆMysqlï¼ŒOracle ç­‰ï¼‰çš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½ä¼šè®©æˆ‘ä»¬é€‰æ‹©æ•°æ®æºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115175120.png" alt=""></p>
<p>ä»¥ MySQL ä¸ºä¾‹ï¼Œå½“é€‰æ‹© MySQL çš„æ—¶å€™å°±ä¼šå¼¹å‡ºå¦‚ä¸‹å›¾æ˜¾ç¤ºçš„ç•Œé¢ï¼š</p>
<p><img src="http://image.leonote.cn//20201115175234.png" alt=""></p>
<p>å…¶ä¸­ï¼Œæˆ‘ä»¬åœ¨é€‰æ‹©äº† Driverï¼ˆé©±åŠ¨ï¼‰å’Œ Hostã€Userã€Password ç­‰ä¹‹åï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ª Connectionï¼Œç„¶åè¿æ¥åˆ°æ•°æ®åº“é‡Œé¢äº†ã€‚</p>
<p>åŒæ ·çš„é“ç†ï¼Œåœ¨ Java é‡Œé¢æˆ‘ä»¬ä¹Ÿéœ€è¦ç”¨åˆ° DataSource å»è¿æ¥æ•°æ®åº“ï¼Œè€Œ Java å®šä¹‰äº†ä¸€å¥— JDBC çš„åè®®æ ‡å‡†ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª javax.sql.DataSource æ¥å£ç±»ï¼Œé€šè¿‡å®ç°æ­¤ç±»å°±å¯ä»¥è¿›è¡Œæ•°æ®åº“è¿æ¥ï¼Œæˆ‘ä»¬é€šè¿‡æºç æ¥åˆ†æä¸€ä¸‹ã€‚</p>
<h3 id="DataSource-æºç åˆ†æ"><a href="#DataSource-æºç åˆ†æ" class="headerlink" title="DataSource æºç åˆ†æ"></a>DataSource æºç åˆ†æ</h3><p>DataSource æ¥å£é‡Œé¢ä¸»è¦çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSource</span> <span class="keyword">extends</span> <span class="title">CommonDataSource</span>, <span class="title">Wrapper</span> </span>&#123;</span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">  <span class="function">Connection <span class="title">getConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é€šè¿‡æºç å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ï¼ŒDataSource çš„ä¸»è¦ç›®çš„å°±æ˜¯è·å¾—æ•°æ®åº“è¿æ¥ï¼Œå°±åƒæˆ‘ä»¬å‰é¢ç”¨å·¥å…·è¿æ¥æ•°æ®åº“ä¸€æ ·ï¼Œåªä¸è¿‡å·¥å…·æ˜¯é€šè¿‡ç•Œé¢å®ç°çš„ï¼Œè€Œ DataSource æ˜¯é€šè¿‡ä»£ç å®ç°çš„ã€‚</p>
<p>é‚£ä¹ˆåœ¨<strong>ç¨‹åºé‡Œé¢å¦‚ä½•å®ç°</strong>å‘¢ï¼Ÿä¹Ÿæœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹çš„å®ç°æ–¹å¼ï¼Œå¸¸è§çš„æœ‰C3P0ã€BBCPã€Proxoolã€Druidã€Hikariï¼Œè€Œç›®å‰ Spring Boot é‡Œé¢æ˜¯é‡‡ç”¨ Hikari ä½œä¸ºé»˜è®¤æ•°æ®æºã€‚Hikari çš„ä¼˜ç‚¹æ˜¯ï¼šå¼€æºï¼Œç¤¾åŒºæ´»è·ƒï¼Œæ€§èƒ½é«˜ï¼Œç›‘æ§å®Œæ•´ã€‚æˆ‘ä»¬é€šè¿‡å·¥å…·çœ‹ä¸€ä¸‹é¡¹ç›®é‡Œé¢DataSource çš„å®ç°ç±»æœ‰å“ªäº›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115180504.png" alt=""></p>
<p>å…¶ä¸­ï¼Œå½“é‡‡ç”¨é»˜è®¤æ•°æ®æºçš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®æºçš„å®ç°ç±»æœ‰ï¼š</p>
<ul>
<li>h2 é‡Œé¢çš„ JdbcDataSource</li>
<li>MySQL è¿æ¥é‡Œé¢çš„ MysqlDataSource</li>
<li>HikariDataSourceï¼ˆé»˜è®¤æ•°æ®æºï¼Œä¹Ÿæ˜¯ Spring ç¤¾åŒºæ¨èçš„æœ€ä½³æ•°æ®æºï¼‰</li>
</ul>
<p>ç›´æ¥æ‰“å¼€ HikariDataSource çš„æºç çœ‹ä¸€ä¸‹ï¼Œå®ƒçš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HikariDataSource</span> <span class="keyword">extends</span> <span class="title">HikariConfig</span> <span class="keyword">implements</span> <span class="title">DataSource</span>, <span class="title">Closeable</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> HikariPool pool;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HikariDataSource</span><span class="params">(HikariConfig configuration)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">     configuration.validate();</span><br><span class="line">     configuration.copyStateTo(<span class="keyword">this</span>);</span><br><span class="line">     LOGGER.info(<span class="string">&quot;&#123;&#125; - Starting...&quot;</span>, configuration.getPoolName());</span><br><span class="line">     pool = fastPathPool = <span class="keyword">new</span> HikariPool(<span class="keyword">this</span>);</span><br><span class="line">     LOGGER.info(<span class="string">&quot;&#123;&#125; - Start completed.&quot;</span>, configuration.getPoolName());</span><br><span class="line">     <span class="keyword">this</span>.seal();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//è¿™ä¸ªæ˜¯æœ€ä¸»è¦çš„å®ç°é€»è¾‘ï¼Œå³é€šè¿‡è¿æ¥æ± è·å¾—è¿æ¥çš„é€»è¾‘</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (isClosed()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;HikariDataSource &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot; has been closed.&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (fastPathPool != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fastPathPool.getConnection();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// See http://en.wikipedia.org/wiki/Double-checked_locking#Usage_in_Java</span></span><br><span class="line">     HikariPool result = pool;</span><br><span class="line">     <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           result = pool;</span><br><span class="line">           <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">              validate();</span><br><span class="line">              LOGGER.info(<span class="string">&quot;&#123;&#125; - Starting...&quot;</span>, getPoolName());</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                 pool = result = <span class="keyword">new</span> HikariPool(<span class="keyword">this</span>);</span><br><span class="line">                 <span class="keyword">this</span>.seal();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">catch</span> (PoolInitializationException pie) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (pie.getCause() <span class="keyword">instanceof</span> SQLException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (SQLException) pie.getCause();</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> pie;</span><br><span class="line">                 &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              LOGGER.info(<span class="string">&quot;&#123;&#125; - Start completed.&quot;</span>, getPoolName());</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> result.getConnection();</span><br><span class="line">  &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°å…³é”®çš„ä¸¤ç‚¹é—®é¢˜ï¼š</p>
<ol>
<li><p>æ•°æ®æºçš„å…³é”®é…ç½®å±æ€§æœ‰å“ªäº›ï¼Ÿ</p>
</li>
<li><p>è¿æ¥æ€ä¹ˆè·å¾—ï¼Ÿè¿æ¥æ± çš„ä½œç”¨å¦‚ä½•ï¼Ÿ</p>
</li>
</ol>
<h3 id="Hikari-æ•°æ®æºçš„å…³é”®é…ç½®å±æ€§æœ‰å“ªäº›ï¼Ÿ"><a href="#Hikari-æ•°æ®æºçš„å…³é”®é…ç½®å±æ€§æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="Hikari æ•°æ®æºçš„å…³é”®é…ç½®å±æ€§æœ‰å“ªäº›ï¼Ÿ"></a>Hikari æ•°æ®æºçš„å…³é”®é…ç½®å±æ€§æœ‰å“ªäº›ï¼Ÿ</h3><p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒHikariConfig çš„é…ç½®é‡Œé¢æè¿°äº† Hikari æ•°æ®æºä¸»è¦çš„é…ç½®å±æ€§ï¼Œæˆ‘ä»¬æ‰“å¼€æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115181335.png" alt=""></p>
<p>é€šè¿‡ä¸Šé¢çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°æ®æºçš„å…³é”®é…ç½®ä¿¡æ¯ï¼šç”¨æˆ·åã€å¯†ç ã€è¿æ¥æ± çš„é…ç½®ã€jdbcUrlã€é©±åŠ¨çš„åå­—ç­‰ç­‰</p>
<h3 id="Hikari-æ•°æ®æºçš„è¿æ¥æ€ä¹ˆè·å¾—"><a href="#Hikari-æ•°æ®æºçš„è¿æ¥æ€ä¹ˆè·å¾—" class="headerlink" title="Hikari æ•°æ®æºçš„è¿æ¥æ€ä¹ˆè·å¾—"></a>Hikari æ•°æ®æºçš„è¿æ¥æ€ä¹ˆè·å¾—</h3><p>ä¸Šé¢æåˆ°çš„ç¬¬ 2 ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡ <code>getConnection</code> æ–¹æ³•é‡Œé¢çš„ä»£ç å¯ä»¥çœ‹åˆ° HikariPool çš„ç”¨æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯<strong>é€šè¿‡è¿æ¥æ± æ¥è·å¾—è¿æ¥çš„</strong>ï¼Œè¿™ä¸ªè¿æ¥ç”¨è¿‡ä¹‹åæ²¡æœ‰æ–­å¼€ï¼Œè€Œæ˜¯é‡æ–°æ”¾å›åˆ°è¿æ¥æ± é‡Œé¢ï¼ˆè¿™ä¸ªåœ°æ–¹ä½ ä¸€å®šè¦è°¨è®°ï¼Œå®ƒä¹Ÿè¯´æ˜äº† connection æ˜¯å¯ä»¥å…±äº«çš„ï¼‰ã€‚</p>
<p>è¿æ¥æ± çš„ç”¨é€”ï¼š</p>
<p>åˆ›å»ºè¿æ¥æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œè¿æ¥æ± æŠ€æœ¯å¯ä»¥å…±äº«ç°æœ‰çš„è¿æ¥ï¼Œä»¥å¢åŠ ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<h3 id="æ•°æ®æºã€é©±åŠ¨ã€è¿æ¥ã€è¿æ¥æ± çš„å…³ç³»"><a href="#æ•°æ®æºã€é©±åŠ¨ã€è¿æ¥ã€è¿æ¥æ± çš„å…³ç³»" class="headerlink" title="æ•°æ®æºã€é©±åŠ¨ã€è¿æ¥ã€è¿æ¥æ± çš„å…³ç³»"></a>æ•°æ®æºã€é©±åŠ¨ã€è¿æ¥ã€è¿æ¥æ± çš„å…³ç³»</h3><ul>
<li>æ•°æ®æºï¼ˆDataSourceï¼‰çš„ä½œç”¨æ˜¯ç»™åº”ç”¨ç¨‹åºæä¾›ä¸åŒ DB çš„è¿æ¥ connectionï¼›</li>
</ul>
<ul>
<li>è¿æ¥ï¼ˆConnectionï¼‰æ˜¯é€šè¿‡è¿æ¥æ± ï¼ˆPoolï¼‰è·å–çš„ï¼Œè¿™ä¸»è¦æ˜¯å‡ºäºè¿æ¥æ€§èƒ½çš„è€ƒè™‘ï¼›</li>
<li>åˆ›å»ºå¥½è¿æ¥ä¹‹åï¼Œé€šè¿‡æ•°æ®åº“çš„é©±åŠ¨ï¼ˆDriverï¼‰æ¥è¿›è¡Œæ•°æ®åº“æ“ä½œï¼›</li>
</ul>
<p>è€Œä¸åŒçš„ DBï¼ˆMySQL / H2 / Oracleï¼‰ï¼Œéƒ½æœ‰è‡ªå·±çš„é©±åŠ¨ç±»å’Œç›¸åº”çš„é©±åŠ¨ Jar åŒ…ã€‚</p>
<p>ç”¨ä¸€ä¸ªå›¾æ¥è¡¨ç¤ºä¸€ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn//20201115182131.png" alt=""></p>
<p>è€Œæˆ‘ä»¬å¸¸è¯´çš„ MySQL é©±åŠ¨ï¼Œå…¶å®å°±æ˜¯ <code>com.mysql.cj.jdbc.Driver</code>ï¼Œè€Œè¿™ä¸ªç±»ä¸»è¦å­˜åœ¨äº <code>mysql-connection-java:8.0*</code> çš„ jar é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„ä¸åŒçš„æ•°æ®åº“æ‰€ä»£è¡¨çš„é©±åŠ¨ jar åŒ…ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ spring boot 2.3.3 ç‰ˆæœ¬å¼•ç”¨çš„ <code>mysql-connection-java 8.0</code> ç‰ˆæœ¬é©±åŠ¨ jar åŒ…ï¼Œä¸åŒçš„æ•°æ®åº“å¼•ç”¨çš„ jar åŒ…æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼ŒH2 æ•°æ®æºä¸­ï¼Œæˆ‘ä»¬ç”¨çš„é©±åŠ¨ç±»æ˜¯ <code>org.h2.Driver</code>ï¼Œå…¶åŒ…å«åœ¨ <code>com.h2database:h2:1.4.*jar</code> åŒ…é‡Œé¢ã€‚</p>
<h2 id="æ•°æ®æºçš„åŠ è½½åŸç†å’Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#æ•°æ®æºçš„åŠ è½½åŸç†å’Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="æ•°æ®æºçš„åŠ è½½åŸç†å’Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>æ•°æ®æºçš„åŠ è½½åŸç†å’Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p> <code>spring.factories</code> æ–‡ä»¶å¯ä»¥çœ‹åˆ° JDBC æ•°æ®æºç›¸å…³çš„è‡ªåŠ¨åŠ è½½çš„ç±» <code>DataSourceAutoConfiguration</code>ï¼Œé‚£ä¹ˆå°±ä»è¿™ä¸ªç±»å¼€å§‹åˆ†æã€‚</p>
<h3 id="DataSourceAutoConfiguration-æ•°æ®æºçš„åŠ è½½è¿‡ç¨‹åˆ†æ"><a href="#DataSourceAutoConfiguration-æ•°æ®æºçš„åŠ è½½è¿‡ç¨‹åˆ†æ" class="headerlink" title="DataSourceAutoConfiguration æ•°æ®æºçš„åŠ è½½è¿‡ç¨‹åˆ†æ"></a>DataSourceAutoConfiguration æ•°æ®æºçš„åŠ è½½è¿‡ç¨‹åˆ†æ</h3><p><code>DataSourceAutoConfiguration</code> çš„å…³é”®æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°†spring.datasource.**çš„é…ç½®æ”¾åˆ°DataSourcePropertieså¯¹è±¡é‡Œé¢ï¼›</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(DataSourceProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceInitializationConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="comment">//é»˜è®¤é›†æˆçš„æ•°æ®æºï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯H2ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¿«é€Ÿå¯åŠ¨å’Œä¸Šæ‰‹ï¼Œä¸€èˆ¬ä¸åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨ï¼›</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@Conditional(EmbeddedDatabaseCondition.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line">   <span class="meta">@Import(EmbeddedDataSourceConfiguration.class)</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedDatabaseConfiguration</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//åŠ è½½ä¸åŒçš„æ•°æ®æºçš„é…ç½®</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@Conditional(PooledDataSourceCondition.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;)</span></span><br><span class="line">   <span class="meta">@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">         DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.Generic.class,</span></span><br><span class="line"><span class="meta">         DataSourceJmxConfiguration.class &#125;)</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PooledDataSourceConfiguration</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line">   ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸‰ç‚¹æœ€å…³é”®çš„ä¿¡æ¯ï¼š<br>ç¬¬ä¸€ï¼Œé€šè¿‡ <code>@EnableConfigurationProperties(DataSourceProperties.class)</code> å¯ä»¥çœ‹å¾—å‡ºæ¥ spring.datasource çš„é…ç½®é¡¹æœ‰å“ªäº›</p>
<p> <code>DataSourceProperties</code> å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProperties</span> <span class="keyword">implements</span> <span class="title">BeanClassLoaderAware</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> ClassLoader classLoader;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> generateUniqueName = <span class="keyword">true</span>;</span><br><span class="line">   <span class="keyword">private</span> Class&lt;? extends DataSource&gt; type;</span><br><span class="line">   <span class="keyword">private</span> String driverClassName;</span><br><span class="line">   <span class="keyword">private</span> String url;</span><br><span class="line">   <span class="keyword">private</span> String username;</span><br><span class="line">   <span class="keyword">private</span> String password;</span><br><span class="line">   <span class="comment">//è®¡ç®—ç¡®å®š driverName çš„å€¼æ˜¯ä»€ä¹ˆ</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">determineDriverClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.driverClassName)) &#123;</span><br><span class="line">      Assert.state(driverClassIsLoadable(), () -&gt; <span class="string">&quot;Cannot load driver class: &quot;</span> + <span class="keyword">this</span>.driverClassName);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.driverClassName;</span><br><span class="line">   &#125;</span><br><span class="line">   String driverClassName = <span class="keyword">null</span>;</span><br><span class="line">   <span class="comment">//æ­¤æ®µé€»è¾‘æ˜¯ï¼Œå½“æˆ‘ä»¬æ²¡æœ‰é…ç½®è‡ªå·±çš„ driverName çš„æ—¶å€™ï¼Œå®ƒä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„ DB çš„ urlè‡ªåŠ¨è®¡ç®—å‡ºæ¥ driverName çš„å€¼æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥å°±ä¼šå‘ç°æˆ‘ä»¬ç°åœ¨å¾ˆå¤š datasource é‡Œé¢çš„é…ç½®éƒ½çœå»äº† driver-name çš„é…ç½®ï¼Œè¿™æ˜¯ Spring Boot çš„åŠŸåŠ³ã€‚</span></span><br><span class="line">   <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.url)) &#123;</span><br><span class="line">      driverClassName = DatabaseDriver.fromJdbcUrl(<span class="keyword">this</span>.url).getDriverClassName();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!StringUtils.hasText(driverClassName)) &#123;</span><br><span class="line">      driverClassName = <span class="keyword">this</span>.embeddedDatabaseConnection.getDriverClassName();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!StringUtils.hasText(driverClassName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> DataSourceBeanCreationException(<span class="string">&quot;Failed to determine a suitable driver class&quot;</span>, <span class="keyword">this</span>,</span><br><span class="line">            <span class="keyword">this</span>.embeddedDatabaseConnection);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> driverClassName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é€šè¿‡ <code>DatabaseDriver</code> çš„æºç å¯ä»¥çœ‹åˆ° MySQL çš„é»˜è®¤é©±åŠ¨ Spring Boot æ˜¯é‡‡ç”¨ <code>com.mysql.cj.jdbc.Driver</code> æ¥å®ç°çš„ã€‚</p>
<p><img src="http://image.leonote.cn//20201115190314.png" alt=""></p>
<p>åŒæ—¶ï¼Œ<code>@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</code> ä¹Ÿå‘Šè¯‰æˆ‘ä»¬ï¼Œ<code>application.properties</code> é‡Œé¢çš„ datasource ç›¸å…³çš„å…¬å…±é…ç½®å¯ä»¥ä»¥ spring.datasource ä¸ºå¼€å¤´ï¼Œè¿™æ ·å½“å¯åŠ¨çš„æ—¶å€™ï¼Œ<code>DataSourceProperties</code> å°±ä¼šå°† datasource çš„ä¸€åˆ‡é…ç½®è‡ªåŠ¨åŠ è½½è¿›æ¥ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢åœ¨ <code>application.properties</code> é‡Œé¢çš„é…ç½®çš„ä¸€æ ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115190449.png" alt=""></p>
<p>è¿™é‡Œæœ‰ urlã€usernameã€passwordã€driver-class-name ç­‰å…³é”®é…ç½®ï¼Œä¸åŒæ•°æ®æºçš„å…¬å…±é…ç½®ä¹Ÿä¸å¤šã€‚</p>
<p>ç¬¬äºŒï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™ä¸€æ®µä»£ç ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ä¸åŒçš„æ•°æ®æºçš„é…ç½®æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(&#123; </span></span><br><span class="line"><span class="meta">    DataSourceConfiguration.Hikari.class, </span></span><br><span class="line"><span class="meta">    DataSourceConfiguration.Tomcat.class,</span></span><br><span class="line"><span class="meta">    DataSourceConfiguration.Dbcp2.class, </span></span><br><span class="line"><span class="meta">    DataSourceConfiguration.Generic.class,</span></span><br><span class="line"><span class="meta">    DataSourceJmxConfiguration.class &#125;)</span></span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€ <code>DataSourceConfiguration</code> çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createDataSource</span><span class="params">(DataSourceProperties properties, Class&lt;? extends DataSource&gt; type)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (T) properties.initializeDataSourceBuilder().type(type).build();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Tomcatè¿æ¥æ± æ•°æ®æºçš„é…ç½®ï¼Œå‰ææ¡ä»¶éœ€è¦å¼•å…¥tomcat-jdbc*.jar</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(org.apache.tomcat.jdbc.pool.DataSource.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(DataSource.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnProperty(name = &quot;spring.datasource.type&quot;, havingValue = &quot;org.apache.tomcat.jdbc.pool.DataSource&quot;,</span></span><br><span class="line"><span class="meta">         matchIfMissing = true)</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Tomcat</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.tomcat&quot;)</span></span><br><span class="line">      org.apache.tomcat.jdbc.pool.<span class="function">DataSource <span class="title">dataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">         org.apache.tomcat.jdbc.pool.DataSource dataSource = createDataSource(properties,</span><br><span class="line">               org.apache.tomcat.jdbc.pool.DataSource.class);</span><br><span class="line">         DatabaseDriver databaseDriver = DatabaseDriver.fromJdbcUrl(properties.determineUrl());</span><br><span class="line">         String validationQuery = databaseDriver.getValidationQuery();</span><br><span class="line">         <span class="keyword">if</span> (validationQuery != <span class="keyword">null</span>) &#123;</span><br><span class="line">            dataSource.setTestOnBorrow(<span class="keyword">true</span>);</span><br><span class="line">            dataSource.setValidationQuery(validationQuery);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> dataSource;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Hikariæ•°æ®æºçš„é…ç½®ï¼Œé»˜è®¤Spring BootåŠ è½½çš„æ˜¯Hikariæ•°æ®æº</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(HikariDataSource.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(DataSource.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnProperty(name = &quot;spring.datasource.type&quot;, havingValue = &quot;com.zaxxer.hikari.HikariDataSource&quot;,</span></span><br><span class="line"><span class="meta">         matchIfMissing = true)</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Hikari</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.hikari&quot;)</span></span><br><span class="line">      <span class="function">HikariDataSource <span class="title">dataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">         HikariDataSource dataSource = createDataSource(properties, HikariDataSource.class);</span><br><span class="line">         <span class="keyword">if</span> (StringUtils.hasText(properties.getName())) &#123;</span><br><span class="line">            dataSource.setPoolName(properties.getName());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> dataSource;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * DBCPæ•°æ®æºçš„é…ç½®ï¼ŒæŒ‰ç…§Spring Bootçš„è¯­æ³•ï¼Œæˆ‘ä»¬å¿…é¡»å¼•å…¥CommonsDbcp**.jarä¾èµ–æ‰æœ‰ç”¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@ConditionalOnClass(org.apache.commons.dbcp2.BasicDataSource.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(DataSource.class)</span></span><br><span class="line">   <span class="meta">@ConditionalOnProperty(name = &quot;spring.datasource.type&quot;, havingValue = &quot;org.apache.commons.dbcp2.BasicDataSource&quot;,</span></span><br><span class="line"><span class="meta">         matchIfMissing = true)</span></span><br><span class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Dbcp2</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.dbcp2&quot;)</span></span><br><span class="line">      org.apache.commons.dbcp2.<span class="function">BasicDataSource <span class="title">dataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> createDataSource(properties, org.apache.commons.dbcp2.BasicDataSource.class);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°æœ€å¸¸è§çš„ä¸‰ç§æ•°æ®æºçš„é…ç½®ï¼š</p>
<ul>
<li><p>HikariDataSource</p>
</li>
<li><p>tomcatçš„JDBC</p>
</li>
<li><p>apacheçš„dbcp</p>
</li>
</ul>
<p>è€Œæœ€ç»ˆç”¨å“ªä¸ªï¼Œå°±çœ‹ä½ å¼•ç”¨äº†å“ªä¸ª dataSource çš„ jar åŒ…ã€‚ä¸è¿‡ Spring Boot 2.0 ä¹‹åå°±æ¨èä½¿ç”¨ Hikari æ•°æ®æºäº†ã€‚</p>
<p>ç¬¬ä¸‰ï¼Œé€šè¿‡ <code>@ConfigurationProperties(prefix = &quot;spring.datasource.hikari&quot;)</code> å’Œ</p>
<p> <code>HikariDataSource dataSource(DataSourceProperties properties)</code> å¯ä»¥çŸ¥é“ï¼Œ<code>application.properties</code> é‡Œé¢ spring.datasource.hikari å¼€å¤´çš„é…ç½®ä¼šè¢«æ˜ å°„åˆ° <code>HikariDataSource</code> å¯¹è±¡ä¸­ï¼Œ <code>HikariDataSource</code> ç»§æ‰¿äº† HikariConfigã€‚</p>
<p>æ‰€ä»¥é¡ºç†æˆç« åœ°ï¼Œå°±å¯ä»¥çŸ¥é“ Hikari æ•°æ®æºçš„é…ç½®æœ‰å“ªäº›äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115190915.png" alt=""></p>
<p>Hikari çš„é…ç½®æ¯”è¾ƒå¤šï¼Œä½ å®é™…å·¥ä½œä¸­æƒ³è¦äº†è§£è¯¦ç»†é…ç½®ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹</p>
<p>è¿™é‡Œåªè¯´ä¸€ä¸‹æœ€éœ€è¦å…³å¿ƒçš„é…ç½®ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## æœ€å°ç©ºé—²é“¾æ¥æ•°é‡</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.minimum-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">## ç©ºé—²é“¾æ¥å­˜æ´»æœ€å¤§æ—¶é—´ï¼Œé»˜è®¤600000ï¼ˆ10åˆ†é’Ÿï¼‰</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.idle-timeout</span>=<span class="string">180000</span></span><br><span class="line"><span class="comment">## é“¾æ¥æ± æœ€å¤§é“¾æ¥æ•°ï¼Œé»˜è®¤æ˜¯10</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.maximum-pool-size</span>=<span class="string">10</span></span><br><span class="line"><span class="comment">## æ­¤å±æ€§æ§åˆ¶ä»æ± è¿”å›çš„é“¾æ¥çš„é»˜è®¤è‡ªåŠ¨æäº¤è¡Œä¸º,é»˜è®¤å€¼ï¼štrue</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.auto-commit</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">## æ•°æ®æºé“¾æ¥æ± çš„åç§°</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.pool-name</span>=<span class="string">MyHikariCP</span></span><br><span class="line"><span class="comment">## æ­¤å±æ€§æ§åˆ¶æ± ä¸­é“¾æ¥çš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå€¼0è¡¨ç¤ºæ— é™ç”Ÿå‘½å‘¨æœŸï¼Œé»˜è®¤1800000å³30åˆ†é’Ÿ</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.max-lifetime</span>=<span class="string">1800000</span></span><br><span class="line"><span class="comment">## æ•°æ®åº“é“¾æ¥è¶…æ—¶æ—¶é—´,é»˜è®¤30ç§’ï¼Œå³30000</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.connection-timeout</span>=<span class="string">30000</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.connection-test-query</span>=<span class="string">SELECT 1mysql</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä»‹ç»çš„ä¸»è¦æ˜¯é’ˆå¯¹è¿æ¥æ± çš„é…ç½®ï¼Œè¿æ¥æ± æˆ‘ä»¬ä¸èƒ½é…ç½®å¾—å¤ªå¤§ï¼Œå› ä¸º<strong>è¿æ¥æ± å¤ªå¤§çš„è¯ï¼Œä¼šæœ‰é¢å¤–çš„ CPU å¼€é”€ï¼Œå¤„ç†è¿æ¥æ± çš„çº¿ç¨‹åˆ‡æ¢åè€Œä¼šå¢åŠ ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼Œå‡ä½æ€§èƒ½</strong>ï¼›ç›¸åº”çš„ï¼Œ<strong>è¿æ¥æ± ä¹Ÿä¸èƒ½é…ç½®å¤ªå°ï¼Œå¤ªå°çš„è¯å¯èƒ½ä¼šå¢åŠ è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œä¹Ÿä¼šé™ä½ä¸šåŠ¡å¤„ç†çš„ååé‡</strong>ã€‚</p>
<h2 id="Hikari-æ•°æ®æºä¸‹çš„-MySQL-é…ç½®æœ€ä½³å®è·µ"><a href="#Hikari-æ•°æ®æºä¸‹çš„-MySQL-é…ç½®æœ€ä½³å®è·µ" class="headerlink" title="Hikari æ•°æ®æºä¸‹çš„ MySQL é…ç½®æœ€ä½³å®è·µ"></a>Hikari æ•°æ®æºä¸‹çš„ MySQL é…ç½®æœ€ä½³å®è·µ</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">##æ•°æ®æºçš„é…ç½®ï¼šlogger=Slf4JLogger&amp;profileSQL=trueæ˜¯ç”¨æ¥debugæ˜¾ç¤ºsqlçš„æ‰§è¡Œæ—¥å¿—çš„</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/test?logger=Slf4JLogger&amp;profileSQL=true</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">E6kroWaR9F</span></span><br><span class="line"><span class="comment">##é‡‡ç”¨é»˜è®¤çš„</span></span><br><span class="line"><span class="comment">#spring.datasource.hikari.connectionTimeout=30000</span></span><br><span class="line"><span class="comment">#spring.datasource.hikari.idleTimeout=300000</span></span><br><span class="line"><span class="comment">##æŒ‡å®šä¸€ä¸ªé“¾æ¥æ± çš„åå­—ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ†æçº¿ç¨‹é—®é¢˜</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.pool-name</span>=<span class="string">jpa-hikari-pool</span></span><br><span class="line"><span class="comment">##æœ€é•¿ç”Ÿå‘½å‘¨æœŸ15åˆ†é’Ÿå¤Ÿäº†</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.maxLifetime</span>=<span class="string">900000</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.maximumPoolSize</span>=<span class="string">8</span></span><br><span class="line"><span class="comment">##æœ€å¤§å’Œæœ€å°ç›¸å¯¹åº”å‡å°‘åˆ›å»ºçº¿ç¨‹æ± çš„æ¶ˆè€—ï¼›</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.minimumIdle</span>=<span class="string">8</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.connectionTestQuery</span>=<span class="string">select 1 from dual</span></span><br><span class="line"><span class="comment">##å½“é‡Šæ”¾è¿æ¥åˆ°è¿æ¥æ± ä¹‹åï¼Œé‡‡ç”¨é»˜è®¤çš„è‡ªåŠ¨æäº¤äº‹åŠ¡</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.autoCommit</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">##ç”¨æ¥æ˜¾ç¤ºé“¾æ¥æµ‹traceæ—¥å¿—</span></span><br><span class="line"><span class="meta">logging.level.com.zaxxer.hikari.HikariConfig</span>=<span class="string">DEBUG </span></span><br><span class="line"><span class="meta">logging.level.com.zaxxer.hikari</span>=<span class="string">TRACE</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢çš„æ—¥å¿—é…ç½®ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™å¯ä»¥çœ‹åˆ°è¿æ¥æ± çš„é…ç½®ç»“æœå’Œ MySQL çš„æ‰§è¡Œæ—¥å¿—ï¼š</p>
<ol>
<li>å¦‚ä¸‹æ—¥å¿—ï¼Œæ˜¾ç¤ºäº† Hikari çš„ config é…ç½®ã€‚</li>
</ol>
<p><img src="http://image.leonote.cn//20201115191251.png" alt=""></p>
<ol start="2">
<li>å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œåˆ°åº•è¦åœ¨ä¸€ä¸ª MySQL çš„ connection ä¸Šé¢æ‰§è¡Œå“ªäº› SQL å‘¢ï¼Ÿé€šè¿‡å¦‚ä¸‹æ—¥å¿—æˆ‘ä»¬å¯ä»¥çœ‹å¾—å‡ºæ¥ã€‚</li>
</ol>
<p><img src="http://image.leonote.cn//20201115191837.png" alt=""></p>
<ol start="3">
<li><p>é€šè¿‡å¼€å¯ <code>com.zaxxer.hikari.pool.HikariPool</code> ç±»çš„ debug çº§åˆ«ï¼Œå¯ä»¥å®æ—¶çœ‹åˆ°è¿æ¥æ± çš„ä½¿ç”¨æƒ…å†µï¼šè½¯ä»¶æ—¥å¿—å¦‚ä¸‹ï¼ˆä¸Šå›¾ä¹Ÿæœ‰ä½“ç°ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.zaxxer.hikari.pool.HikariPoolÂ  Â  Â  Â  : jpa-hikari-pool - Pool stats (total&#x3D;8, active&#x3D;1, idle&#x3D;7, waiting&#x3D;0)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>é€šè¿‡ä¸Šé¢çš„ç›‘æ§æ—¥å¿—ï¼Œä½ åœ¨å®é™…å·¥ä½œä¸­å¯ä»¥æ ¹æ®ä¸»æœºçš„ CPU æƒ…å†µå’Œä¸šåŠ¡å¤„ç†çš„è€—æ—¶æƒ…å†µï¼Œå†å¯¹è¿æ¥æ± åšé€‚å½“çš„è°ƒæ•´ï¼Œä½†æ˜¯æ³¨æ„å·®è·ä¸è¦å¤ªå¤§ï¼Œä¸è¦ä¸€ä¸‹å°†è¿æ¥æ± é…ç½®å‡ ç™¾ä¸ªï¼Œé‚£æ˜¯é”™è¯¯çš„é…ç½®ã€‚</p>
<h2 id="Hikari-æ•°æ®é€šè¿‡-Prometheus-çš„ç›‘æ§æŒ‡æ ‡åº”ç”¨"><a href="#Hikari-æ•°æ®é€šè¿‡-Prometheus-çš„ç›‘æ§æŒ‡æ ‡åº”ç”¨" class="headerlink" title="Hikari æ•°æ®é€šè¿‡ Prometheus çš„ç›‘æ§æŒ‡æ ‡åº”ç”¨"></a>Hikari æ•°æ®é€šè¿‡ Prometheus çš„ç›‘æ§æŒ‡æ ‡åº”ç”¨</h2><p>å°±åƒæ—¥å¿—é‡Œé¢æ‰“å°çš„ä¸€æ ·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.zaxxer.hikari.pool.HikariPool        : jpa-hikari-pool - Pool stats (total&#x3D;8, active&#x3D;0, idle&#x3D;8, waiting&#x3D;0)</span><br></pre></td></tr></table></figure>

<p>Hikari çš„ Metric ä¹Ÿå¸®æˆ‘ä»¬æä¾›äº† Prometheus çš„ç›‘æ§æŒ‡æ ‡ï¼Œå®ç°æ–¹æ³•å¾ˆç®€å•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ol>
<li><p>gradle ä¾èµ–é‡Œé¢æ·»åŠ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">implementation &#39;io.micrometer:micrometer-registry-prometheus&#39;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>application.properties</code> é‡Œé¢æ·»åŠ </p>
</li>
</ol>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Metrics related configurations</span></span><br><span class="line"><span class="meta">management.endpoint.metrics.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br><span class="line"><span class="meta">management.endpoint.prometheus.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å¯åŠ¨é¡¹ç›®ï¼Œé€šè¿‡ä¸‹å›¾ä¸­çš„åœ°å€å°±å¯ä»¥çœ‹åˆ°ï¼ŒPrometheus çš„ Metrics é‡Œé¢å¤šäº†å¾ˆå¤š HikariCP çš„æŒ‡æ ‡ã€‚</p>
<p><img src="http://image.leonote.cn//20201115192404.png" alt=""></p>
<p>å½“çœ‹åˆ°è¿™äº›æŒ‡æ ‡ä¹‹åï¼Œå°±å¯ä»¥æ ¹æ® Grafana ç¤¾åŒºé‡Œé¢æä¾›çš„ HikariCP çš„ç›‘æ§ <a href="https://grafana.com/grafana/dashboards/6083">Dashboards çš„é…ç½®æ–‡æ¡£åœ°å€</a>ï¼Œå¯¼å…¥åˆ°æˆ‘ä»¬è‡ªå·±çš„ Grafana é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡å›¾è¡¨çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p>
<p><img src="http://image.leonote.cn//20201115192657.png" alt=""></p>
<p>é€šè¿‡è¿™ç§æ ‡å‡†çš„æ¨¡æ¿å°±å¯ä»¥çŸ¥é“ JDBC çš„è¿æ¥æƒ…å†µã€Hikari çš„è¿æ¥æƒ…å†µï¼Œä»¥åŠæ¯ä¸ªè¿æ¥è¯·æ±‚æ—¶é—´ã€ä½¿ç”¨æ—¶é—´ã€‚è¿™æ ·å¯¹è¯Šæ–­ DB æ€§èƒ½é—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚</p>
<p>ä¸‹é¢å¯¹å…¶ä¸­ä¸€äº›å…³é”®æŒ‡æ ‡ä½œä¸€ä¸‹è¯´æ˜ï¼š</p>
<ol>
<li><p>totalConnectionsï¼šæ€»è¿æ¥æ•°ï¼ŒåŒ…æ‹¬ç©ºé—²çš„è¿æ¥å’Œä½¿ç”¨ä¸­çš„è¿æ¥ï¼Œå³ totalConnections = activeConnection + idleConnectionsï¼›</p>
</li>
<li><p>idleConnectionsï¼šç©ºé—²è¿æ¥æ•°ï¼Œä¹Ÿå«å¯ç”¨è¿æ¥æ•°ï¼Œä¹Ÿå°±æ˜¯è¿æ¥æ± é‡Œé¢ç°æˆçš„ DB è¿æ¥æ•°ï¼›</p>
</li>
<li><p>activeConnectionsï¼šæ´»è·ƒè¿æ¥æ•°ï¼Œéä¸šåŠ¡ç¹å¿™æœŸä¸€èˆ¬éƒ½æ˜¯ 0ï¼Œå¾ˆå¿«å°±ä¼šé‡Šæ”¾åˆ°è¿æ¥æ± é‡Œé¢å»ï¼›</p>
</li>
<li><p>pendingThreadsï¼šæ­£åœ¨ç­‰å¾…è¿æ¥çš„çº¿ç¨‹æ•°é‡ã€‚æ’æŸ¥æ€§èƒ½é—®é¢˜æ—¶ï¼Œè¿™ä¸ªæŒ‡æ ‡æ˜¯ä¸€ä¸ªé‡è¦çš„å‚è€ƒæŒ‡æ ‡ï¼Œå¦‚æœæ­£åœ¨ç­‰å¾…è¿æ¥çš„çº¿ç¨‹åœ¨ç›¸å½“é•¿ä¸€æ®µæ—¶é—´å†…æ•°é‡è¾ƒå¤šï¼Œè¯´æ˜æˆ‘ä»¬çš„è¿æ¥æ²¡æœ‰åˆ©ç”¨å¥½ï¼Œæ˜¯ä¸æ˜¯å ç”¨è¿æ¥çš„æ—¶é—´è¿‡é•¿äº†ï¼Ÿä¸€æ—¦æœ‰ pendingThreads çš„æ•°é‡äº†å¯ä»¥å‘ä¸ªå‘Šè­¦ï¼ŒæŸ¥æŸ¥åŸå› ï¼Œæˆ–è€…ä¼˜åŒ–ä¸€ä¸‹è¿æ¥æ± ï¼›</p>
</li>
<li><p>maxConnectionsï¼šæœ€å¤§è¿æ¥æ•°ï¼Œç»Ÿè®¡æŒ‡æ ‡ï¼Œç»Ÿè®¡åˆ°ç›®å‰ä¸ºæ­¢è¿æ¥çš„æœ€å¤§æ•°é‡ã€‚</p>
</li>
<li><p>minConnectionsï¼šæœ€å°è¿æ¥æ•°ï¼Œç»Ÿè®¡æŒ‡æ ‡ï¼Œç»Ÿè®¡åˆ°ç›®å‰ä¸ºæ­¢è¿æ¥çš„æœ€å°æ•°é‡ã€‚</p>
</li>
<li><p>usageTimeï¼šæ¯ä¸ªè¿æ¥ä½¿ç”¨çš„æ—¶é—´ï¼Œå½“è¿æ¥è¢«å›æ”¶çš„æ—¶å€™ä¼šè®°å½•æ­¤æŒ‡æ ‡ï¼›ä¸€èˆ¬éƒ½åœ¨ mã€s çº§åˆ«ï¼Œä¸€æ—¦åˆ° s çº§åˆ«äº†å¯ä»¥å‘ä¸ªå‘Šè­¦ï¼›</p>
</li>
<li><p>acquireTimeï¼šè·å–æ¯ä¸ªè¿æ¥éœ€è¦ç­‰å¾…æ—¶é—´ï¼Œä¸€ä¸ªè¯·æ±‚è·å–æ•°æ®åº“è¿æ¥åæˆ–è€…å› ä¸ºè¶…æ—¶å¤±è´¥åï¼Œä¼šè®°å½•æ­¤æŒ‡æ ‡ã€‚</p>
</li>
<li><p>connectionCreateTimeï¼šè¿æ¥åˆ›å»ºæ—¶é—´ã€‚</p>
</li>
</ol>
<p>åœ¨ Grafana å›¾è¡¨æˆ–è€… Prometheus é‡Œé¢éƒ½å¯ä»¥é…ç½®ä¸€äº›é‚®ä»¶æˆ–è€…çŸ­ä¿¡ç­‰å‘Šè­¦ï¼Œè¿™æ ·å½“æˆ‘ä»¬ DB è¿æ¥æ± å‘ç”Ÿé—®é¢˜çš„æ—¶å€™å°±èƒ½å®æ—¶çŸ¥é“ã€‚</p>
<p>æ„Ÿå…´è¶£å¯ä»¥ç ”ç©¶ä¸€ä¸‹ <a href="https://github.com/prometheus-operator/prometheus-operator">Prometheus Operator</a>ã€‚</p>
<h2 id="AliDruidDataSource-çš„é…ç½®ä¸ä»‹ç»"><a href="#AliDruidDataSource-çš„é…ç½®ä¸ä»‹ç»" class="headerlink" title="AliDruidDataSource çš„é…ç½®ä¸ä»‹ç»"></a>AliDruidDataSource çš„é…ç½®ä¸ä»‹ç»</h2><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œç”±äº HikariCP å’Œ Druid å„æœ‰åƒç§‹ï¼Œå›½å†…çš„å¾ˆå¤šå¼€å‘è€…éƒ½ä½¿ç”¨ AliDruid ä½œä¸ºæ•°æ®æºã€‚</p>
<h3 id="ç¬¬ä¸€æ­¥ï¼šå¼•å…¥-Gradle-ä¾èµ–"><a href="#ç¬¬ä¸€æ­¥ï¼šå¼•å…¥-Gradle-ä¾èµ–" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ Gradle ä¾èµ–"></a>ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ Gradle ä¾èµ–</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">implementation &#39;com.alibaba:druid-spring-boot-starter:1.2.1&#39;</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬äºŒæ­¥ï¼šé…ç½®æ•°æ®æº"><a href="#ç¬¬äºŒæ­¥ï¼šé…ç½®æ•°æ®æº" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šé…ç½®æ•°æ®æº"></a>ç¬¬äºŒæ­¥ï¼šé…ç½®æ•°æ®æº</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.datasource.druid.url</span>= <span class="string"># æˆ–spring.datasource.url= </span></span><br><span class="line"><span class="meta">spring.datasource.druid.username</span>= <span class="string"># æˆ–spring.datasource.username=</span></span><br><span class="line"><span class="meta">spring.datasource.druid.password</span>= <span class="string"># æˆ–spring.datasource.password=</span></span><br><span class="line"><span class="meta">spring.datasource.druid.driver-class-name</span>= <span class="string">#æˆ– spring.datasource.driver-class-name=</span></span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸‰æ­¥ï¼šé…ç½®è¿æ¥æ± "><a href="#ç¬¬ä¸‰æ­¥ï¼šé…ç½®è¿æ¥æ± " class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šé…ç½®è¿æ¥æ± "></a>ç¬¬ä¸‰æ­¥ï¼šé…ç½®è¿æ¥æ± </h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.datasource.druid.initial-size</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-active</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.min-idle</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-wait</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.pool-prepared-statements</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-pool-prepared-statement-per-connection-size</span>= <span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-open-prepared-statements</span>= <span class="string">#å’Œä¸Šé¢çš„ç­‰ä»·</span></span><br><span class="line"><span class="meta">spring.datasource.druid.validation-query</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.validation-query-timeout</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.test-on-borrow</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.test-on-return</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.test-while-idle</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.time-between-eviction-runs-millis</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.min-evictable-idle-time-millis</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.max-evictable-idle-time-millis</span>=<span class="string"></span></span><br><span class="line"><span class="meta">spring.datasource.druid.filters</span>= <span class="string">#é…ç½®å¤šä¸ªè‹±æ–‡é€—å·åˆ†éš”</span></span><br><span class="line"><span class="attr">....//more</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä»¥ä¸Šä¸‰æ­¥å°±å¯ä»¥å®Œæˆ Druid æ•°æ®æºçš„é…ç½®äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ HikariCP æ•°æ®æºç»™æ’é™¤æ‰ï¼Œè€Œå…¶ä»– Druid çš„é…ç½®ï¼Œæ¯”å¦‚ç›‘æ§ï¼Œå‚è€ƒ<a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<p>å…¶å®˜æ–¹çš„æºç ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§ä¸Šé¢åˆ†æ HikariCP æ•°æ®æºçš„æ–¹æ³•ï¼Œå¯ä»¥æ‰¾ä¸€ä¸‹ aliDruid çš„æºç ï¼Œ<a href="https://github.com/alibaba/druid/blob/master/druid-spring-boot-starter/src/main/java/com/alibaba/druid/spring/boot/autoconfigure/DruidDataSourceAutoConfigure.java">å…¶åŠ è½½çš„å…¥å£ç±»</a>ï¼Œä¸€æ­¥ä¸€æ­¥å»æŸ¥çœ‹å³å¯ã€‚</p>
<h2 id="Naming-å‘½åç­–ç•¥è¯¦è§£åŠå…¶å®è·µ"><a href="#Naming-å‘½åç­–ç•¥è¯¦è§£åŠå…¶å®è·µ" class="headerlink" title="Naming å‘½åç­–ç•¥è¯¦è§£åŠå…¶å®è·µ"></a>Naming å‘½åç­–ç•¥è¯¦è§£åŠå…¶å®è·µ</h2><p>åœ¨é…ç½® @Entity æ—¶ï¼Œä¸€å®šä¼šå¥½å¥‡è¡¨åã€å­—æ®µåã€å¤–é”®åã€å®ä½“å­—æ®µã€@Column å’Œæ•°æ®åº“çš„å­—æ®µä¹‹é—´ï¼Œæ˜ å°„å…³ç³»æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿé»˜è®¤è§„åˆ™æ˜ å°„è§„åˆ™åˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœå’Œé»˜è®¤ä¸ä¸€æ ·è¯¥æ€ä¹ˆæ‰©å±•ï¼Ÿ</p>
<h3 id="Hibernate-5-çš„å‘½åç­–ç•¥"><a href="#Hibernate-5-çš„å‘½åç­–ç•¥" class="headerlink" title="Hibernate 5 çš„å‘½åç­–ç•¥"></a>Hibernate 5 çš„å‘½åç­–ç•¥</h3><p>Hibernate 5 é‡Œé¢æŠŠå®ä½“å’Œæ•°æ®åº“çš„å­—æ®µåå’Œè¡¨åçš„æ˜ å°„åˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤</p>
<p>ç¬¬ä¸€æ­¥ï¼šé€šè¿‡<code>ImplicitNamingStrategy</code>å…ˆæ‰¾åˆ°å®ä¾‹é‡Œé¢å®šä¹‰çš„é€»è¾‘çš„å­—æ®µåå­—ã€‚</p>
<p>è¿™æ˜¯é€šè¿‡<code>ImplicitNamingStrategy</code> çš„å®ç°ç±»æŒ‡å®šé€»è¾‘å­—æ®µæŸ¥æ‰¾ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å½“å®ä½“é‡Œé¢å®šä¹‰äº† @Tableã€@Column æ³¨è§£çš„æ—¶å€™ï¼Œä»¥æ³¨è§£æŒ‡å®šåå­—è¿”å›ï¼›è€Œå½“æ²¡æœ‰è¿™äº›æ³¨è§£çš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯å®ä½“é‡Œé¢çš„å­—æ®µçš„åå­—ã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>org.hibernate.boot.model.naming.ImplicitNamingStrategy</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œ<code>ImplicitNamingStrategyJpaCompliantImpl</code> è¿™ä¸ªå®ç°ç±»å…¼å®¹ JPA 2.0 çš„å­—æ®µæ˜ å°„è§„èŒƒã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹å››ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li><p><code>ImplicitNamingStrategyLegacyHbmImpl</code>ï¼šå…¼å®¹ Hibernate è€ç‰ˆæœ¬ä¸­çš„å‘½åè§„èŒƒï¼›</p>
</li>
<li><p><code>ImplicitNamingStrategyLegacyJpaImpl</code>ï¼šå…¼å®¹ JPA 1.0 è§„èŒƒä¸­çš„å‘½åè§„èŒƒï¼›</p>
</li>
<li><p><code>ImplicitNamingStrategyComponentPathImpl</code>ï¼š@Embedded ç­‰æ³¨è§£æ ‡å¿—çš„ç»„ä»¶å¤„ç†æ˜¯é€šè¿‡ attributePath å®Œæˆçš„ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬åœ¨ä½¿ç”¨ @Embedded æ³¨è§£çš„æ—¶å€™ï¼Œå¦‚æœè¦æŒ‡å®šå‘½åè§„èŒƒï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿è¿™ä¸ªç±»æ¥å®ç°ï¼›</p>
</li>
<li><p><code>SpringImplicitNamingStrategy</code>ï¼šé»˜è®¤çš„ spring data 2.2.3 çš„ç­–ç•¥ï¼Œåªæ˜¯æ‰©å±•äº† <code>ImplicitNamingStrategyJpaCompliantImpl</code> é‡Œé¢çš„ <code>JoinTableName</code> çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115193538.png" alt=""></p>
</li>
</ul>
<p>è¿™é‡Œåªéœ€è¦å…³å¿ƒ <code>SpringImplicitNamingStrategy</code> å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„åŸºæœ¬ä¸Šç”¨ä¸åˆ°ã€‚</p>
<p> <code>SpringImplicitNamingStrategy</code> æ•ˆæœå¦‚ä½•å‘¢ï¼Ÿä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;userInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="keyword">private</span> String lastName;</span><br><span class="line">   <span class="meta">@Column(name = &quot;myAddress&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> String emailAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ç¬¬ä¸€æ­¥å¯ä»¥å¾—åˆ°å¦‚ä¸‹é€»è¾‘å­—æ®µçš„æ˜ å°„ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UserInfo -&gt; userInfo</span><br><span class="line">id-&gt;id</span><br><span class="line">ages-&gt;ages</span><br><span class="line">lastName -&gt; lastName</span><br><span class="line">emailAddress -&gt; myAddress</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šé€šè¿‡ <code>PhysicalNamingStrategy</code> å°†é€»è¾‘å­—æ®µè½¬åŒ–æˆæ•°æ®åº“çš„ç‰©ç†å­—æ®µåå­—ã€‚</p>
<p>å®ƒçš„å®ç°ç±»è´Ÿè´£å°†é€»è¾‘å­—æ®µè½¬åŒ–æˆå¸¦ä¸‹åˆ’çº¿ï¼Œæˆ–è€…ç»Ÿä¸€ç»™å­—æ®µåŠ ä¸Šå‰ç¼€ï¼Œåˆæˆ–è€…åŠ ä¸ŠåŒå¼•å·ç­‰æ ¼å¼çš„æ•°æ®åº“å­—æ®µåå­—ï¼Œå…¶ä¸»è¦çš„æ¥å£æ˜¯ï¼š<code>org.hibernate.boot.model.naming.PhysicalNamingStrategy</code>ï¼Œè€Œå®ƒçš„å®ç°ç±»ä¹Ÿåªæœ‰ä¸¤ä¸ªï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115194119.png" alt=""></p>
<ol>
<li><p><code>PhysicalNamingStrategyStandardImpl</code>ï¼šè¿™ä¸ªç±»ä»€ä¹ˆéƒ½æ²¡å¹²ï¼Œå³ç›´æ¥å°†ç¬¬ä¸€ä¸ªæ­¥éª¤å¾—åˆ°çš„é€»è¾‘å­—æ®µåå­—å½“æˆæ•°æ®åº“çš„å­—æ®µåå­—ä½¿ç”¨ã€‚è¿™ä¸ªä¸»è¦çš„åº”ç”¨åœºæ™¯æ˜¯ï¼Œå¦‚æœæŸäº›å­—æ®µçš„å‘½åæ ¼å¼ä¸æ˜¯ä¸‹åˆ’çº¿çš„æ ¼å¼ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡ @Column çš„æ–¹å¼æ˜¾ç¤ºå£°æ˜çš„è¯ï¼Œå¯ä»¥æŠŠé»˜è®¤ç¬¬äºŒæ­¥çš„ç­–ç•¥æ”¹æˆ <code>PhysicalNamingStrategyStandardImpl</code>ã€‚é‚£ä¹ˆå¦‚æœå†å¥—ç”¨ç¬¬ä¸€æ­¥çš„ä¾‹å­ï¼Œç»è¿‡è¿™ä¸ªç±»çš„è½¬åŒ–ä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">userInfo -&gt; userInfo</span><br><span class="line">id-&gt;id</span><br><span class="line">ages-&gt;ages</span><br><span class="line">lastName -&gt; lastName</span><br><span class="line">myAddress -&gt; myAddress</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºæ¥é€»è¾‘åå­—åˆ°ç‰©ç†åå­—æ˜¯ä¿æŒä¸å˜çš„ã€‚</p>
</li>
<li><p><code>SpringPhysicalNamingStrategy</code>ï¼šè¿™ä¸ªç±»æ˜¯å°†ç¬¬ä¸€æ­¥å¾—åˆ°çš„é€»è¾‘å­—æ®µåå­—çš„å¤§å†™å­—æ¯å‰é¢åŠ ä¸Šä¸‹åˆ’çº¿ï¼Œå¹¶ä¸”å…¨éƒ¨è½¬åŒ–æˆå°å†™ï¼Œå°†ä¼šæ ‡è¯†å‡ºæ˜¯å¦éœ€è¦åŠ ä¸ŠåŒå¼•å·ã€‚æ­¤ç§æ˜¯é»˜è®¤ç­–ç•¥ã€‚æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ä¸€æ­¥å¾—åˆ°çš„é€»è¾‘å­—æ®µå°±ä¼šå˜æˆå¦‚ä¸‹æ˜ å°„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">userInfo -&gt; user_info</span><br><span class="line">id-&gt;id</span><br><span class="line">ages-&gt;ages</span><br><span class="line">lastName -&gt; last_name</span><br><span class="line">myAddress -&gt; my_address</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>æŠŠåˆšæ‰çš„å®ä½“æ‰§è¡Œä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="keyword">create</span> <span class="keyword">table</span> user_info (id <span class="type">bigint</span> <span class="keyword">not</span> <span class="keyword">null</span>, create_time <span class="type">timestamp</span>, create_user_id <span class="type">integer</span>, last_modified_time <span class="type">timestamp</span>, last_modified_user_id <span class="type">integer</span>, version <span class="type">integer</span>, ages <span class="type">integer</span>, my_address <span class="type">varchar</span>(<span class="number">255</span>), last_name <span class="type">varchar</span>(<span class="number">255</span>), telephone <span class="type">varchar</span>(<span class="number">255</span>), <span class="keyword">primary</span> key (id))ï¼›</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ <code>SpringPhysicalNamingStrategy</code> ç±»é‡Œé¢è®¾ç½®æ–­ç‚¹æ¥éªŒè¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20201115194510.png" alt=""></p>
<h3 id="åŠ è½½åŸç†ä¸è‡ªå®šä¹‰æ–¹æ³•"><a href="#åŠ è½½åŸç†ä¸è‡ªå®šä¹‰æ–¹æ³•" class="headerlink" title="åŠ è½½åŸç†ä¸è‡ªå®šä¹‰æ–¹æ³•"></a>åŠ è½½åŸç†ä¸è‡ªå®šä¹‰æ–¹æ³•</h3><p>ä¿®æ”¹é»˜è®¤ç­–ç•¥ï¼Œåªéœ€è¦åœ¨ <code>application.properties</code> é‡Œé¢ä¿®æ”¹ä¸‹é¢ä»£ç æ‰€ç¤ºçš„ä¸¤ä¸ªé…ç½®ï¼Œæ¢æˆè‡ªå·±çš„è‡ªå®šä¹‰çš„ç±»å³å¯ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.jpa.hibernate.naming.implicit-strategy</span>=<span class="string">org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategy</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.naming.physical-strategy</span>=<span class="string">org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœç›´æ¥æœç´¢ï¼šspring.jpa.hibernate å°±ä¼šå‘ç°ï¼Œå…¶é»˜è®¤é…ç½®æ˜¯åœ¨ <code>org.springframework.boot.autoconfigure.orm.jpa.HibernateProerties</code> è¿™ç±»é‡Œé¢çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ–¹æ³•ä¸­è¿›è¡ŒåŠ è½½ã€‚</p>
<p><img src="http://image.leonote.cn//20201115194653.png" alt=""></p>
<p>å…¶ä¸­ï¼ŒIMPLICIT_NAMING_STRATEGY å’Œ PHYSICAL_NAMING_STRATEGY çš„å€¼å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼Œå®ƒæ˜¯ Hibernate 5 çš„é…ç½®å˜é‡ï¼Œç”¨æ¥æ”¹å˜ Hibernateçš„ naming çš„ç­–ç•¥ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">String</span> <span class="string">IMPLICIT_NAMING_STRATEGY = &quot;hibernate.implicit_naming_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PHYSICAL_NAMING_STRATEGY = &quot;hibernate.physical_naming_strategy&quot;;</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè‡ªå®šä¹‰çš„è¯ï¼Œç›´æ¥ç»§æ‰¿ <code>SpringPhysicalNamingStrategy</code> è¿™ä¸ªç±»ï¼Œç„¶åè¦†ç›–éœ€è¦å®ç°çš„æ–¹æ³•å³å¯ã€‚é‚£ä¹ˆå®ƒå®é™…çš„åº”ç”¨åœºæ™¯éƒ½æœ‰å“ªäº›å‘¢ï¼Ÿ</p>
<h3 id="è‡ªå®šä¹‰çš„å®é™…åº”ç”¨åœºæ™¯"><a href="#è‡ªå®šä¹‰çš„å®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="è‡ªå®šä¹‰çš„å®é™…åº”ç”¨åœºæ™¯"></a>è‡ªå®šä¹‰çš„å®é™…åº”ç”¨åœºæ™¯</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬æ¥è§¦åˆ°çš„ç³»ç»Ÿå¯èƒ½æ˜¯è€ç³»ç»Ÿï¼Œè¡¨å’Œå­—æ®µçš„å‘½åè§„èŒƒä¸ä¸€å®šæ˜¯ä¸‹åˆ’çº¿å½¢å¼ï¼Œæœ‰å¯èƒ½é©¼å³°å¼çš„å‘½åæ³•ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸åŒçš„ä¸šåŠ¡æœ‰ä¸åŒçš„è¡¨åå‰ç¼€ã€‚ä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¿®æ”¹ç¬¬äºŒé˜¶æ®µï¼šç‰©ç†æ˜ å°„çš„ç­–ç•¥ï¼Œæ”¹æˆ <code>PhysicalNamingStrategyStandardImpl</code> çš„å½¢å¼</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.jpa.hibernate.naming.physical-strategy</span>=<span class="string">org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¯ä»¥ä½¿ @Column/@Table ç­‰æ³¨è§£çš„è‡ªå®šä¹‰å€¼ç”Ÿæ•ˆï¼Œæˆ–è€…æ”¹æˆè‡ªå®šä¹‰çš„ <code>MyPhysicalNamingStrategy</code>ã€‚ä¸è¿‡<strong>ä¸å»ºè®®ä¿®æ”¹</strong> implicit-strategyï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦ï¼Œéœ€åªè¦åœ¨ physical-strategy ä¸Šåšæ–‡ç« å°±è¶³å¤Ÿäº†ã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>DataSource</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa çš„ Entity æ³¨è§£</title>
    <url>/2020/10/16/SpringDataJpa%E7%9A%84Entity%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-çš„-Entity-æ³¨è§£"><a href="#Spring-Data-Jpa-çš„-Entity-æ³¨è§£" class="headerlink" title="Spring Data Jpa çš„ Entity æ³¨è§£"></a>Spring Data Jpa çš„ Entity æ³¨è§£</h1><h2 id="JPA-åè®®ä¸­å…³äº-Entity-çš„ç›¸å…³è§„å®š"><a href="#JPA-åè®®ä¸­å…³äº-Entity-çš„ç›¸å…³è§„å®š" class="headerlink" title="JPA åè®®ä¸­å…³äº Entity çš„ç›¸å…³è§„å®š"></a>JPA åè®®ä¸­å…³äº Entity çš„ç›¸å…³è§„å®š</h2><p> JPA åè®®é‡Œé¢å…³äºå®ä½“åšäº†ä¸€äº›è§„å®šã€‚ï¼ˆæ¨èä¸€ä¸ªæŸ¥çœ‹ <a href="https://download.oracle.com/otn-pub/jcp/persistence-2_2-mrel-spec/JavaPersistence.pdf">JPA åè®®çš„å®˜æ–¹åœ°å€</a>ï¼‰</p>
<ol>
<li><p>å®ä½“æ˜¯ç›´æ¥è¿›è¡Œæ•°æ®åº“æŒä¹…åŒ–æ“ä½œçš„é¢†åŸŸå¯¹è±¡ï¼ˆå³ä¸€ä¸ªç®€å•çš„ POJOï¼Œå¯ä»¥æŒ‰ç…§ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†ï¼‰ï¼Œå¿…é¡»é€šè¿‡ @Entity æ³¨è§£è¿›è¡Œæ ‡ç¤ºã€‚</p>
</li>
<li><p>å®ä½“å¿…é¡»æœ‰ä¸€ä¸ª public æˆ–è€… protected çš„æ— å‚æ•°æ„é€ æ–¹æ³•ã€‚</p>
</li>
<li><p>æŒä¹…åŒ–æ˜ å°„çš„æ³¨è§£å¯ä»¥æ ‡ç¤ºåœ¨ Entity çš„å­—æ®µ field ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Column(length = 20, nullable = false)</span></span><br><span class="line"><span class="keyword">private</span> String userName;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥å°†æŒä¹…åŒ–æ³¨è§£è¿ç”¨åœ¨ Entity é‡Œé¢çš„ get/set æ–¹æ³•ä¸Šï¼Œé€šå¸¸æˆ‘ä»¬æ˜¯æ”¾åœ¨ get æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Column(length = 20, nullable = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span></span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">return</span> userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ¦‚æ‹¬èµ·æ¥ï¼Œå°±æ˜¯ Entity é‡Œé¢çš„æ³¨è§£ç”Ÿæ•ˆåªæœ‰ä¸¤ç§æ–¹å¼ï¼šå°†æ³¨è§£å†™åœ¨å­—æ®µä¸Šæˆ–è€…å°†æ³¨è§£å†™åœ¨æ–¹æ³•ä¸Šï¼ˆJPA é‡Œé¢ç§° Propertyï¼‰ã€‚</p>
<p><strong>æ³¨æ„ï¼šåœ¨åŒä¸€ä¸ª Entity é‡Œé¢åªèƒ½æœ‰ä¸€ç§æ–¹å¼ç”Ÿæ•ˆ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ³¨è§£è¦ä¹ˆå…¨éƒ¨å†™åœ¨ field ä¸Šé¢ï¼Œè¦ä¹ˆå°±å…¨éƒ¨å†™åœ¨ Property ä¸Šé¢ã€‚</p>
</blockquote>
<ol>
<li>åªè¦æ˜¯åœ¨ <code>@Entity</code> çš„å®ä½“é‡Œé¢è¢«æ³¨è§£æ ‡æ³¨çš„å­—æ®µï¼Œéƒ½ä¼šè¢«æ˜ å°„åˆ°æ•°æ®åº“ä¸­ï¼Œé™¤äº†ä½¿ç”¨ <code>@Transient</code> æ³¨è§£çš„å­—æ®µä¹‹å¤–ã€‚</li>
<li>å®ä½“é‡Œé¢å¿…é¡»è¦æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸»é”®æ ‡ç¤ºçš„å­—æ®µå¯ä»¥æ˜¯å•ä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å¤åˆä¸»é”®å­—æ®µã€‚</li>
</ol>
<blockquote>
<p>ğŸ¯æœ‰å…´è¶£å¯ä»¥è¯»ä¸€è¯» Java Persistence API åè®®ï¼Œè¿™æ ·åœ¨åš JPA å¼€å‘çš„æ—¶å€™å°±ä¼šé¡ºæ‰‹å¾ˆå¤šï¼Œå¯ä»¥ç†è§£å¾ˆå¤š Hibernate é‡Œé¢å®ç°æ–¹æ³•ã€‚å½“é‡åˆ°è§£å†³ä¸äº†çš„é—®é¢˜æ—¶ï¼Œå°±å»çœ‹åè®®ã€é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæ·±å…¥æŒ–æ˜ä¸€ä¸‹ï¼Œå¯èƒ½å°±ä¼šæ‰¾åˆ°ç­”æ¡ˆã€‚</p>
</blockquote>
<h2 id="JPA-é‡Œé¢æ”¯æŒçš„å“ªäº›æ³¨è§£"><a href="#JPA-é‡Œé¢æ”¯æŒçš„å“ªäº›æ³¨è§£" class="headerlink" title="JPA é‡Œé¢æ”¯æŒçš„å“ªäº›æ³¨è§£"></a>JPA é‡Œé¢æ”¯æŒçš„å“ªäº›æ³¨è§£</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨ IDEA å·¥å…·ï¼Œæ‰“å¼€ <code>@Entity</code> æ‰€åœ¨çš„åŒ…ï¼Œå°±å¯ä»¥çœ‹åˆ° JPA é‡Œé¢æ”¯æŒçš„æ³¨è§£æœ‰å“ªäº›ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201016130319.png" alt=""></p>
<p>åœ¨ jakarta.persistence-api çš„åŒ…è·¯å¾„ä¸‹é¢å¤§æ¦‚æœ‰ä¸€ç™¾å¤šä¸ªæ³¨è§£ï¼Œæ²¡äº‹çš„æ—¶å€™å¯ä»¥åˆ°è¿™é‡Œé¢ä¸€ä¸ªä¸€ä¸ªåœ°çœ‹ï¼Œä¹Ÿå¯ä»¥åˆ° JPA çš„åè®®é‡Œé¢å¯¹ç…§æŸ¥çœ‹æ–‡æ¡£ã€‚</p>
<p>è¿™é‡ŒåªæåŠä¸€äº›æœ€å¸¸è§çš„ï¼ŒåŒ…æ‹¬ <code>@Entity</code>ã€<code>@Table</code>ã€<code>@Access</code>ã€<code>@Id</code>ã€<code>@GeneratedValue</code>ã€<code>@Enumerated</code>ã€<code>@Basic</code>ã€<code>@Column</code>ã€<code>@Transient</code>ã€<code>@Lob</code>ã€<code>@Temporal</code> ç­‰ã€‚</p>
<ol>
<li><p><code>@Entity</code> ç”¨äºå®šä¹‰å¯¹è±¡å°†ä¼šæˆä¸ºè¢« JPA ç®¡ç†çš„å®ä½“ï¼Œå¿…å¡«ï¼Œå°†å­—æ®µæ˜ å°„åˆ°æŒ‡å®šçš„æ•°æ®åº“è¡¨ä¸­ï¼Œä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œç›´æ¥ç”¨åœ¨å®ä½“ç±»ä¸Šé¢å³å¯ï¼Œé€šè¿‡æºç è¡¨è¾¾çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(TYPE)</span> <span class="comment">//è¡¨ç¤ºæ­¤æ³¨è§£åªèƒ½ç”¨åœ¨classä¸Šé¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Entity &#123;</span><br><span class="line">   <span class="comment">//å¯é€‰ï¼Œé»˜è®¤æ˜¯å®ä½“ç±»çš„åå­—ï¼Œæ•´ä¸ªåº”ç”¨é‡Œé¢å…¨å±€å”¯ä¸€ã€‚</span></span><br><span class="line">   <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Table</code> ç”¨äºæŒ‡å®šæ•°æ®åº“çš„è¡¨åï¼Œè¡¨ç¤ºæ­¤å®ä½“å¯¹åº”çš„æ•°æ®åº“é‡Œé¢çš„è¡¨åï¼Œéå¿…å¡«ï¼Œé»˜è®¤è¡¨åå’Œ entity åå­—ä¸€æ ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(TYPE)</span> <span class="comment">//ä¸€æ ·åªèƒ½ç”¨åœ¨ç±»ä¸Šé¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Table &#123;</span><br><span class="line">   <span class="comment">//è¡¨çš„åå­—ï¼Œå¯é€‰ã€‚å¦‚æœä¸å¡«å†™ï¼Œç³»ç»Ÿè®¤ä¸ºå’Œå®ä½“çš„åå­—ä¸€æ ·ä¸ºè¡¨åã€‚</span></span><br><span class="line">   <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//æ­¤è¡¨æ‰€åœ¨schemaï¼Œå¯é€‰</span></span><br><span class="line">   <span class="function">String <span class="title">schema</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//å”¯ä¸€æ€§çº¦æŸï¼Œåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æœ‰ç”¨ï¼Œè¡¨åˆ›å»ºä¹‹ååé¢å°±ä¸éœ€è¦äº†ã€‚</span></span><br><span class="line">   UniqueConstraint[] uniqueConstraints() <span class="keyword">default</span> &#123; &#125;;</span><br><span class="line">   <span class="comment">//ç´¢å¼•ï¼Œåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ä½¿ç”¨ï¼Œè¡¨åˆ›å»ºä¹‹ååé¢å°±ä¸éœ€è¦äº†ã€‚</span></span><br><span class="line">   Index[] indexes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Access</code> ç”¨äºæŒ‡å®š entity é‡Œé¢çš„æ³¨è§£æ˜¯å†™åœ¨å­—æ®µä¸Šé¢ï¼Œè¿˜æ˜¯ get/set æ–¹æ³•ä¸Šé¢ç”Ÿæ•ˆï¼Œéå¿…å¡«ã€‚åœ¨é»˜è®¤ä¸å¡«å†™çš„æƒ…å†µä¸‹ï¼Œå½“å®ä½“é‡Œé¢çš„ç¬¬ä¸€ä¸ªæ³¨è§£å‡ºç°åœ¨å­—æ®µä¸Šæˆ–è€… get/set æ–¹æ³•ä¸Šé¢ï¼Œå°±ä»¥ç¬¬ä¸€æ¬¡å‡ºç°çš„æ–¹å¼ä¸ºå‡†ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå®ä½“é‡Œé¢çš„æ³¨è§£æ—¢æœ‰ç”¨åœ¨ field ä¸Šé¢ï¼Œåˆæœ‰ç”¨åœ¨ properties ä¸Šé¢çš„æ—¶å€™ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ä½ å°±ä¼šæ˜ç™½ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="keyword">private</span> Long id;</span><br><span class="line"><span class="meta">@Column(length = 20, nullable = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span></span>&#123;</span><br><span class="line">Â  Â  <span class="keyword">return</span> userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç”±äº <code>@Id</code> æ˜¯å®ä½“é‡Œé¢ç¬¬ä¸€ä¸ªå‡ºç°çš„æ³¨è§£ï¼Œå¹¶ä¸”ä½œç”¨åœ¨å­—æ®µä¸Šé¢ï¼Œæ‰€ä»¥æ‰€æœ‰å†™åœ¨ get/set æ–¹æ³•ä¸Šé¢çš„æ³¨è§£å°±ä¼šå¤±æ•ˆã€‚è€Œ <code>@Access</code> å¯ä»¥å¹²é¢„é»˜è®¤å€¼ï¼ŒæŒ‡å®šæ˜¯åœ¨ fields ä¸Šé¢ç”Ÿæ•ˆè¿˜æ˜¯åœ¨ properties ä¸Šé¢ç”Ÿæ•ˆã€‚æˆ‘ä»¬é€šè¿‡æºç çœ‹ä¸‹è¯­æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¡¨ç¤ºæ­¤æ³¨è§£å¯ä»¥è¿ç”¨åœ¨classä¸Š(é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±å¯ä»¥æŒ‡å®šæ­¤å®ä½“çš„é»˜è®¤æ³¨è§£ç”Ÿæ•ˆç­–ç•¥äº†)ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨æ–¹æ³•ä¸Šæˆ–è€…å­—æ®µä¸Š(è¡¨ç¤ºå¯ä»¥ç‹¬ç«‹è®¾ç½®æŸä¸€ä¸ªå­—æ®µæˆ–è€…æ–¹æ³•çš„ç”Ÿæ•ˆç­–ç•¥)ï¼›</span></span><br><span class="line"><span class="meta">@Target( &#123; TYPE, METHOD, FIELD &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Access &#123;</span><br><span class="line">    <span class="comment">//æŒ‡å®šæ˜¯å­—æ®µä¸Šé¢ç”Ÿæ•ˆè¿˜æ˜¯æ–¹æ³•ä¸Šé¢ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="function">AccessType <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">AccessType</span> </span>&#123;</span><br><span class="line">    FIELD,</span><br><span class="line">    PROPERTY</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Id</code> å®šä¹‰å±æ€§ä¸ºæ•°æ®åº“çš„ä¸»é”®ï¼Œä¸€ä¸ªå®ä½“é‡Œé¢å¿…é¡»æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä½†ä¸ä¸€å®šæ˜¯è¿™ä¸ªæ³¨è§£ï¼Œå¯ä»¥å’Œ <code>@GeneratedValue</code> é…åˆä½¿ç”¨æˆ–æˆå¯¹å‡ºç°ã€‚</p>
</li>
<li><p><code>@GeneratedValue</code> ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GeneratedValue &#123;</span><br><span class="line">    <span class="comment">//Idçš„ç”Ÿæˆç­–ç•¥</span></span><br><span class="line">    <span class="function">GenerationType <span class="title">strategy</span><span class="params">()</span> <span class="keyword">default</span> AUTO</span>;</span><br><span class="line">    <span class="comment">//é€šè¿‡ Sequences ç”Ÿæˆ Idï¼Œå¸¸è§çš„æ˜¯ Oracle æ•°æ®åº“ ID ç”Ÿæˆè§„åˆ™ï¼Œ</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ—¶å€™éœ€è¦é…åˆ @SequenceGenerator ä½¿ç”¨</span></span><br><span class="line">    <span class="function">String <span class="title">generator</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼ŒGenerationType ä¸€å…±æœ‰ä»¥ä¸‹å››ä¸ªå€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">GenerationType</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡è¡¨äº§ç”Ÿä¸»é”®ï¼Œæ¡†æ¶å€Ÿç”±è¡¨æ¨¡æ‹Ÿåºåˆ—äº§ç”Ÿä¸»é”®ï¼Œä½¿ç”¨è¯¥ç­–ç•¥å¯ä»¥ä½¿åº”ç”¨æ›´æ˜“äºæ•°æ®åº“ç§»æ¤</span></span><br><span class="line">    TABLE,</span><br><span class="line">    <span class="comment">//é€šè¿‡åºåˆ—äº§ç”Ÿä¸»é”®ï¼Œé€šè¿‡ @SequenceGenerator æ³¨è§£æŒ‡å®šåºåˆ—åï¼ŒMySql ä¸æ”¯æŒè¿™ç§æ–¹å¼</span></span><br><span class="line">    SEQUENCE,</span><br><span class="line">    <span class="comment">//é‡‡ç”¨æ•°æ®åº“ ID è‡ªå¢é•¿ï¼Œ ä¸€èˆ¬ç”¨äºmysqlæ•°æ®åº“</span></span><br><span class="line">    IDENTITY,</span><br><span class="line">    <span class="comment">//JPA è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç­–ç•¥ï¼Œæ˜¯é»˜è®¤é€‰é¡¹</span></span><br><span class="line">    AUTO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Enumerated</code> è¿™ä¸ªæ³¨è§£å¾ˆå¥½ç”¨ï¼Œå› ä¸ºå®ƒå¯¹ enum æä¾›äº†ä¸‹æ ‡å’Œ name ä¸¤ç§æ–¹å¼ï¼Œç”¨æ³•ç›´æ¥æ˜ å°„åœ¨ enum æšä¸¾ç±»å‹çš„å­—æ®µä¸Šã€‚è¯·çœ‹ä¸‹é¢æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;METHOD, FIELD&#125;)</span> <span class="comment">//ä½œç”¨åœ¨æ–¹æ³•å’Œå­—æ®µä¸Š</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Enumerated &#123;</span><br><span class="line">    <span class="comment">//æšä¸¾æ˜ å°„çš„ç±»å‹ï¼Œé»˜è®¤æ˜¯ORDINALï¼ˆå³æšä¸¾å­—æ®µçš„ä¸‹æ ‡ï¼‰ã€‚</span></span><br><span class="line">    <span class="function">EnumType <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ORDINAL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">EnumType</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ˜ å°„æšä¸¾å­—æ®µçš„ä¸‹æ ‡</span></span><br><span class="line">    ORDINAL,</span><br><span class="line">    <span class="comment">//æ˜ å°„æšä¸¾çš„Name</span></span><br><span class="line">    STRING</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¥çœ‹ä¸€ä¸ª User é‡Œé¢å…³äºæ€§åˆ«æšä¸¾çš„ä¾‹å­ï¼Œä½ å°±ä¼šçŸ¥é“ <code>@Enumerated</code> åœ¨è¿™é‡Œæ²¡ä»€ä¹ˆä½œç”¨äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ‰ä¸€ä¸ªæšä¸¾ç±»ï¼Œç”¨æˆ·çš„æ€§åˆ«</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Gender</span> </span>&#123;</span><br><span class="line">    MALE(<span class="string">&quot;ç”·æ€§&quot;</span>), FEMALE(<span class="string">&quot;å¥³æ€§&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Gender</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®ä½“ç±»@Enumeratedçš„å†™æ³•å¦‚ä¸‹</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;tb_user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;user_gender&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Gender gender;</span><br><span class="line">    .......................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™æ’å…¥ä¸¤æ¡æ•°æ®ï¼Œæ•°æ®åº“é‡Œé¢çš„å€¼ä¼šå˜æˆ MALE/FEMALEï¼Œè€Œä¸æ˜¯â€œç”·æ€§â€ / å¥³æ€§ã€‚</p>
<blockquote>
<p>ğŸ“Œ<strong>ç»éªŒåˆ†äº«ï¼š</strong> å¦‚æœæˆ‘ä»¬ç”¨ <code>@Enumeratedï¼ˆEnumType.ORDINALï¼‰</code>ï¼Œè¿™æ—¶å€™æ•°æ®åº“é‡Œé¢çš„å€¼æ˜¯ 0ã€1ã€‚ä½†æ˜¯å®é™…å·¥ä½œä¸­ï¼Œä¸å»ºè®®ç”¨æ•°å­—ä¸‹æ ‡ï¼Œå› ä¸ºæšä¸¾é‡Œé¢çš„å±æ€§å€¼æ˜¯ä¼šä¸æ–­æ–°å¢çš„ï¼Œå¦‚æœæ–°å¢ä¸€ä¸ªï¼Œä½ç½®å˜åŒ–äº†å°±æƒ¨äº†ã€‚å¹¶ä¸” 0ã€1ã€2 è¿™ç§ä¸‹æ ‡åœ¨æ•°æ®åº“é‡Œé¢çœ‹ç€éå¸¸ç—›è‹¦ï¼Œæ—¶é—´é•¿äº†å°±ä¼šä¸€ç‚¹ä¹Ÿçœ‹ä¸æ‡‚äº†ã€‚</p>
</blockquote>
</li>
<li><p><code>@Basic</code> è¡¨ç¤ºå±æ€§æ˜¯åˆ°æ•°æ®åº“è¡¨çš„å­—æ®µçš„æ˜ å°„ã€‚å¦‚æœå®ä½“çš„å­—æ®µä¸Šæ²¡æœ‰ä»»ä½•æ³¨è§£ï¼Œé»˜è®¤å³ä¸º <code>@Basic</code>ã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤æ‰€æœ‰çš„å­—æ®µè‚¯å®šæ˜¯å’Œæ•°æ®åº“è¿›è¡Œæ˜ å°„çš„ï¼Œå¹¶ä¸”é»˜è®¤ä¸º Eager ç±»å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Basic &#123;</span><br><span class="line">    <span class="comment">//å¯é€‰ï¼ŒEAGERï¼ˆé»˜è®¤ï¼‰ï¼šç«‹å³åŠ è½½ï¼›LAZYï¼šå»¶è¿ŸåŠ è½½ã€‚ï¼ˆLAZYä¸»è¦åº”ç”¨åœ¨å¤§å­—æ®µä¸Šé¢ï¼‰</span></span><br><span class="line">    <span class="function">FetchType <span class="title">fetch</span><span class="params">()</span> <span class="keyword">default</span> EAGER</span>;</span><br><span class="line">    <span class="comment">//å¯é€‰ã€‚è¿™ä¸ªå­—æ®µæ˜¯å¦å¯ä»¥ä¸ºnullï¼Œé»˜è®¤æ˜¯trueã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">optional</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Transient</code> è¡¨ç¤ºè¯¥å±æ€§å¹¶éä¸€ä¸ªåˆ°æ•°æ®åº“è¡¨çš„å­—æ®µçš„æ˜ å°„ï¼Œè¡¨ç¤ºéæŒä¹…åŒ–å±æ€§ã€‚JPA æ˜ å°„æ•°æ®åº“çš„æ—¶å€™å¿½ç•¥å®ƒï¼Œä¸ <code>@Basic</code> æœ‰ç›¸åçš„ä½œç”¨ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªå­—æ®µä¸Šé¢ <code>@Transient</code> å’Œ <code>@Basic</code> å¿…é¡»äºŒé€‰ä¸€ï¼Œè€Œä»€ä¹ˆéƒ½ä¸æŒ‡å®šçš„è¯ï¼Œé»˜è®¤æ˜¯ <code>@Basic</code>ã€‚</p>
</li>
<li><p><code>@Column</code> å®šä¹‰è¯¥å±æ€§å¯¹åº”æ•°æ®åº“ä¸­çš„åˆ—åã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Column &#123;</span><br><span class="line">    <span class="comment">//æ•°æ®åº“ä¸­çš„è¡¨çš„åˆ—åï¼›å¯é€‰ï¼Œå¦‚æœä¸å¡«å†™è®¤ä¸ºå­—æ®µåå’Œå®ä½“å±æ€§åä¸€æ ·ã€‚</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//æ˜¯å¦å”¯ä¸€ã€‚é»˜è®¤falseï¼Œå¯é€‰ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">unique</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">    <span class="comment">//æ•°æ®å­—æ®µæ˜¯å¦å…è®¸ç©ºã€‚å¯é€‰ï¼Œé»˜è®¤trueã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">nullable</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œinsertæ“ä½œçš„æ—¶å€™æ˜¯å¦åŒ…å«æ­¤å­—æ®µï¼Œé»˜è®¤ï¼Œtrueï¼Œå¯é€‰ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">insertable</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œupdateçš„æ—¶å€™æ˜¯å¦åŒ…å«æ­¤å­—æ®µï¼Œé»˜è®¤ï¼Œtrueï¼Œå¯é€‰ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">updatable</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">    <span class="comment">//è¡¨ç¤ºè¯¥å­—æ®µåœ¨æ•°æ®åº“ä¸­çš„å®é™…ç±»å‹ã€‚</span></span><br><span class="line">    <span class="function">String <span class="title">columnDefinition</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//æ•°æ®åº“å­—æ®µçš„é•¿åº¦ï¼Œå¯é€‰ï¼Œé»˜è®¤255</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> <span class="keyword">default</span> 255</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>@Temporal</code> ç”¨æ¥è®¾ç½® Date ç±»å‹çš„å±æ€§æ˜ å°„åˆ°å¯¹åº”ç²¾åº¦çš„å­—æ®µï¼Œå­˜åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li><code>@Temporal(TemporalType.DATE)</code> æ˜ å°„ä¸ºæ—¥æœŸï¼ˆ<strong>åªæœ‰æ—¥æœŸ</strong>ï¼‰</li>
<li><code>@Temporal(TemporalType.TIME)</code> æ˜ å°„ä¸ºæ—¥æœŸï¼ˆ<strong>åªæœ‰æ—¶é—´</strong>ï¼‰</li>
<li><code>@Temporal(TemporalType.TIMESTAMP)</code> æ˜ å°„ä¸ºæ—¥æœŸï¼ˆ<strong>æ—¥æœŸ+æ—¶é—´</strong>ï¼‰</li>
</ul>
</li>
</ol>
<p>çœ‹ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼Œæ„Ÿå—ä¸€ä¸‹ä¸Šé¢æåˆ°çš„æ³¨è§£çš„å®Œæ•´ç”¨æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;user_topic&quot;)</span></span><br><span class="line"><span class="meta">@Access(AccessType.FIELD)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserTopic</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;id&quot;, nullable = false)</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">   <span class="keyword">private</span> Integer id;</span><br><span class="line">   <span class="meta">@Column(name = &quot;title&quot;, nullable = true, length = 200)</span></span><br><span class="line">   <span class="keyword">private</span> String title;</span><br><span class="line">   <span class="meta">@Basic</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;create_user_id&quot;, nullable = true)</span></span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="meta">@Basic(fetch = FetchType.LAZY)</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;content&quot;, nullable = true, length = -1)</span></span><br><span class="line">   <span class="meta">@Lob</span></span><br><span class="line">   <span class="keyword">private</span> String content;</span><br><span class="line">   <span class="meta">@Basic(fetch = FetchType.LAZY)</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;image&quot;, nullable = true)</span></span><br><span class="line">   <span class="meta">@Lob</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">byte</span>[] image;</span><br><span class="line">   <span class="meta">@Basic</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;create_time&quot;, nullable = true)</span></span><br><span class="line">   <span class="meta">@Temporal(TemporalType.TIMESTAMP)</span></span><br><span class="line">   <span class="keyword">private</span> Date createTime;</span><br><span class="line">   <span class="meta">@Basic</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;create_date&quot;, nullable = true)</span></span><br><span class="line">   <span class="meta">@Temporal(TemporalType.DATE)</span></span><br><span class="line">   <span class="keyword">private</span> Date createDate;</span><br><span class="line">   <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">   <span class="meta">@Column(name = &quot;topic_type&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> Type type;</span><br><span class="line">   <span class="meta">@Transient</span></span><br><span class="line">   <span class="keyword">private</span> String transientSimple;</span><br><span class="line">   <span class="comment">//éæ•°æ®åº“æ˜ å°„å­—æ®µï¼Œä¸šåŠ¡ç±»å‹çš„å­—æ®µ</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getTransientSimple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> title + <span class="string">&quot;auto:jack&quot;</span> + type;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//æœ‰ä¸€ä¸ªæšä¸¾ç±»ï¼Œä¸»é¢˜çš„ç±»å‹</span></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> </span>&#123;</span><br><span class="line">      EN(<span class="string">&quot;è‹±æ–‡&quot;</span>), CN(<span class="string">&quot;ä¸­æ–‡&quot;</span>);</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> String des;</span><br><span class="line">      Type(String des) &#123;</span><br><span class="line">         <span class="keyword">this</span>.des = des;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®è¿™é‡Œé¢çš„å¾ˆå¤šæ³¨è§£éƒ½å¯ä»¥çœç•¥ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤çš„å°±å¯ä»¥ã€‚å¦‚ <code>@Basic</code>ã€<code>@Column</code> åå­—æœ‰ä¸€å®šçš„æ˜ å°„ç­–ç•¥ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>@Access</code> ä¹Ÿå¯ä»¥çœç•¥ï¼Œæˆ‘ä»¬åªè¦åœ¨è¿™äº›ç±»é‡Œé¢ä¿æŒä¸€è‡´å°±å¯ä»¥äº†ã€‚</p>
<h2 id="ç”Ÿæˆè¿™äº›æ³¨è§£çš„å°æŠ€å·§"><a href="#ç”Ÿæˆè¿™äº›æ³¨è§£çš„å°æŠ€å·§" class="headerlink" title="ç”Ÿæˆè¿™äº›æ³¨è§£çš„å°æŠ€å·§"></a>ç”Ÿæˆè¿™äº›æ³¨è§£çš„å°æŠ€å·§</h2><p>æœ‰æ—¶å€™è€çš„ Table éå¸¸å¤šï¼Œä¸€ä¸ªä¸€ä¸ªå»å†™ entity ä¼šç‰¹åˆ«ç´¯ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨ IDEA å·¥å…·ç›´æ¥å¸®æˆ‘ä»¬ç”Ÿæˆ Entity ç±»ã€‚å…³é”®æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆï¼Œ<strong>æ‰“å¼€ Persistence è§†å›¾ï¼Œç‚¹å‡» Generate Persistence Mapping</strong>ï¼Œæ¥ç€<strong>ç‚¹å‡»é€‰ä¸­æ•°æ®æº</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201016132432.png" alt=""></p>
<p>ç„¶åï¼Œ<strong>é€‰æ‹©è¡¨å’Œå­—æ®µï¼Œå¹¶ç‚¹å‡» OK</strong>ã€‚</p>
<p><img src="http://image.leonote.cn/20201016132931.png" alt=""></p>
<p>è¿™æ ·å°±å¯ä»¥ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„å®ä½“äº†ï¼Œå¤šç®€å•ã€‚å¦‚æœæ˜¯æ–°åº“ã€æ–°è¡¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆå®šä¹‰å¥½å®ä½“ï¼Œé€šè¿‡å®ä½“é…ç½® JPA çš„ spring.jpa.generate-ddl=trueï¼Œåå‘ç›´æ¥ç”Ÿæˆ DDL æ“ä½œæ•°æ®åº“ç”Ÿæˆè¡¨ç»“æ„ã€‚</p>
<blockquote>
<p>ğŸ¯æ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¦æŠŠå¤–é”®å…³è”å…³ç³»å…³é—­ï¼Œä¸ç„¶ä¼šå‡ºç°æ„æƒ³ä¸åˆ°çš„ ERRORï¼Œæ¯•ç«Ÿç”Ÿäº§ç¯å¢ƒä¸åŒå¼€å‘ç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¼€å‘ç¯å¢ƒç”Ÿæˆçš„è¡¨å¯¼å‡º DDL åˆ°ç”Ÿäº§æ‰§è¡Œã€‚åˆ©ç”¨ç”Ÿæˆ DDL æ¥åšæµ‹è¯•å’Œå†™æ¡ˆä¾‹ï¼Œå¯ä»¥çœå»åˆ›å»ºè¡¨çš„æ—¶é—´ï¼Œåªéœ€è¦å…³æ³¨ä»£ç å°±è¡Œäº†ã€‚</p>
</blockquote>
<h2 id="è”åˆä¸»é”®"><a href="#è”åˆä¸»é”®" class="headerlink" title="è”åˆä¸»é”®"></a>è”åˆä¸»é”®</h2><p>å¯ä»¥é€šè¿‡ javax.persistence.EmbeddedId å’Œ javax.persistence.IdClass ä¸¤ä¸ªæ³¨è§£å®ç°è”åˆä¸»é”®çš„æ•ˆæœã€‚</p>
<h3 id="å¦‚ä½•é€šè¿‡-IdClass-åšåˆ°è”åˆä¸»é”®ï¼Ÿ"><a href="#å¦‚ä½•é€šè¿‡-IdClass-åšåˆ°è”åˆä¸»é”®ï¼Ÿ" class="headerlink" title="å¦‚ä½•é€šè¿‡ @IdClass åšåˆ°è”åˆä¸»é”®ï¼Ÿ"></a>å¦‚ä½•é€šè¿‡ @IdClass åšåˆ°è”åˆä¸»é”®ï¼Ÿ</h3><p>ç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ª UserInfoID ç±»é‡Œé¢æ˜¯è”åˆä¸»é”®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoID</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name, telephone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šå†æ–°å»ºä¸€ä¸ª UserInfo çš„å®ä½“ï¼Œé‡‡ç”¨ @IdClass å¼•ç”¨è”åˆä¸»é”®ç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@IdClass(UserInfoID.class)</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šæ–°å¢ä¸€ä¸ª UserInfoRepository ç±»æ¥åš CRUD æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">UserInfoID</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæµ‹è¯•ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoRepositoryTest</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span> <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIdClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  userInfoRepository.save(UserInfo.builder().ages(<span class="number">1</span>)</span><br><span class="line">                         .name(<span class="string">&quot;jack&quot;</span>).telephone(<span class="string">&quot;123456789&quot;</span>).build());</span><br><span class="line">    Optional&lt;UserInfo&gt; userInfo =</span><br><span class="line">        userInfoRepository.findById(</span><br><span class="line">            UserInfoID.builder().name(<span class="string">&quot;jack&quot;</span>).telephone(<span class="string">&quot;123456789&quot;</span>).build());</span><br><span class="line">    System.out.println(userInfo.get());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">create table <span class="title">user_info</span> <span class="params">(name varchar(<span class="number">255</span>)</span> not <span class="keyword">null</span>, telephone <span class="title">varchar</span><span class="params">(<span class="number">255</span>)</span> not <span class="keyword">null</span>, ages integer, primary <span class="title">key</span> <span class="params">(name, telephone)</span>)</span></span><br><span class="line"><span class="function">Hibernate: select userinfo0_.name as name1_3_0_, userinfo0_.telephone as telephon2_3_0_, userinfo0_.ages as ages3_3_0_ from user_info userinfo0_ where userinfo0_.name</span>=? and userinfo0_.telephone=?</span><br><span class="line">UserInfo(ages=<span class="number">1</span>, name=jack, telephone=<span class="number">123456789</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¾‹å­ï¼Œè¡¨çš„ä¸»é”®æ˜¯ (name, telephone)ï¼Œè€Œ Entity é‡Œé¢ä¸å†æ˜¯ä¸€ä¸ª <code>@Id</code> å­—æ®µäº†ã€‚</p>
<h3 id="Embeddable-ä¸-EmbeddedId-æ³¨è§£ä½¿ç”¨"><a href="#Embeddable-ä¸-EmbeddedId-æ³¨è§£ä½¿ç”¨" class="headerlink" title="@Embeddable ä¸ @EmbeddedId æ³¨è§£ä½¿ç”¨"></a>@Embeddable ä¸ @EmbeddedId æ³¨è§£ä½¿ç”¨</h3><p>ç¬¬ä¸€æ­¥ï¼šåœ¨æˆ‘ä»¬ä¸Šé¢ä¾‹å­ä¸­çš„ UserInfoID é‡Œé¢æ·»åŠ  @Embeddable æ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Embeddable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoID</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name, telephone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šæ”¹ä¸€ä¸‹åˆšæ‰çš„ User å¯¹è±¡ï¼Œåˆ é™¤ <code>@IdClass</code>ï¼Œæ·»åŠ  <code>@EmbeddedId</code> æ³¨è§£ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="meta">@EmbeddedId</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoID userInfoID;</span><br><span class="line">   <span class="meta">@Column(unique = true)</span></span><br><span class="line">   <span class="keyword">private</span> String uniqueNumber;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šUserInfoRepository ä¸å˜ï¼Œæˆ‘ä»¬ç›´æ¥ä¿®æ”¹ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIdClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    userInfoRepository.save(</span><br><span class="line">        UserInfo.builder()</span><br><span class="line">            .ages(<span class="number">1</span>)</span><br><span class="line">         	.userInfoID(UserInfoID.builder().name(<span class="string">&quot;jack&quot;</span>)</span><br><span class="line">         			  .telephone(<span class="string">&quot;123456789&quot;</span>).build())</span><br><span class="line">            .build());</span><br><span class="line">    Optional&lt;UserInfo&gt; userInfo =</span><br><span class="line">        userInfoRepository.findById(</span><br><span class="line">            UserInfoID.builder().name(<span class="string">&quot;jack&quot;</span>).telephone(<span class="string">&quot;123456789&quot;</span>).build());</span><br><span class="line">    System.out.println(userInfo.get());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå®Œä¹‹åï¼Œä½ å¯ä»¥å¾—åˆ°ç›¸åŒçš„ç»“æœã€‚é‚£ä¹ˆ @IdClass å’Œ @EmbeddedId çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ol>
<li>åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼ŒEmbedded ç”¨çš„æ˜¯å¯¹è±¡ï¼Œè€Œ IdClass ç”¨çš„æ˜¯å…·ä½“çš„æŸä¸€ä¸ªå­—æ®µï¼›</li>
<li>äºŒè€…çš„JPQL ä¹Ÿä¼šä¸ä¸€æ ·ï¼š<ul>
<li>ç”¨ <code>@IdClass</code> JPQL çš„å†™æ³•ï¼š<code>SELECT u.name FROM UserInfo u</code></li>
<li>ç”¨ <code>@EmbeddedId</code> çš„ JPQL çš„å†™æ³•ï¼š<code>select u.userInfoId.name FROM UserInfo u</code></li>
</ul>
</li>
</ol>
<p>è”åˆä¸»é”®è¿˜æœ‰éœ€è¦æ³¨æ„çš„å°±æ˜¯ï¼Œå®ƒä¸å”¯ä¸€æ€§ç´¢å¼•çº¦æŸçš„åŒºåˆ«æ˜¯å†™æ³•ä¸åŒï¼Œå¦‚ä¸Šé¢æ‰€è®²ï¼Œå”¯ä¸€æ€§ç´¢å¼•çš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Column(unique = true)</span></span><br><span class="line"><span class="keyword">private</span> String uniqueNumber;</span><br></pre></td></tr></table></figure>

<h2 id="å®ä½“ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä½•å®ç°"><a href="#å®ä½“ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä½•å®ç°" class="headerlink" title="å®ä½“ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä½•å®ç°"></a>å®ä½“ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä½•å®ç°</h2><p>åœ¨ Java é¢å‘å¯¹è±¡çš„è¯­è¨€ç¯å¢ƒä¸­ï¼Œ<code>@Entity</code> ä¹‹é—´çš„å…³ç³»å¤šç§å¤šæ ·ï¼Œè€Œæ ¹æ® JPA çš„è§„èŒƒï¼Œå¤§è‡´å¯ä»¥å°†å…¶åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p>
<ol>
<li>çº¯ç²¹çš„ç»§æ‰¿ï¼Œå’Œè¡¨æ²¡å…³ç³»ï¼Œå¯¹è±¡ä¹‹é—´çš„å­—æ®µå…±äº«ã€‚åˆ©ç”¨æ³¨è§£ <code>@MappedSuperclass</code>ï¼Œåè®®è§„å®šçˆ¶ç±»ä¸èƒ½æ˜¯ <code>@Entity</code>ã€‚</li>
<li>å•è¡¨å¤šæ€é—®é¢˜ï¼ŒåŒä¸€å¼  Tableï¼Œè¡¨ç¤ºäº†ä¸åŒçš„å¯¹è±¡ï¼Œé€šè¿‡ä¸€ä¸ªå­—æ®µæ¥è¿›è¡ŒåŒºåˆ†ã€‚åˆ©ç”¨<code>@Inheritance(strategy = InheritanceType.SINGLE_TABLE)</code>æ³¨è§£å®Œæˆï¼Œåªæœ‰çˆ¶ç±»æœ‰ <code>@Table</code>ã€‚</li>
<li>å¤šè¡¨å¤šæ€ï¼Œæ¯ä¸€ä¸ªå­ç±»ä¸€å¼ è¡¨ï¼Œçˆ¶ç±»çš„è¡¨æ‹¥æœ‰æ‰€æœ‰å…¬ç”¨å­—æ®µã€‚é€šè¿‡<code>@Inheritance(strategy = InheritanceType.JOINED)</code>æ³¨è§£å®Œæˆï¼Œçˆ¶ç±»å’Œå­ç±»éƒ½æ˜¯è¡¨ï¼Œæœ‰å…¬ç”¨çš„å­—æ®µåœ¨çˆ¶è¡¨é‡Œé¢ã€‚</li>
<li>Object çš„ç»§æ‰¿ï¼Œæ•°æ®åº“é‡Œé¢æ¯ä¸€å¼ è¡¨æ˜¯åˆ†å¼€çš„ï¼Œç›¸äº’ç‹¬ç«‹ä¸å—å½±å“ã€‚é€šè¿‡<code>@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)</code>æ³¨è§£å®Œæˆï¼Œçˆ¶ç±»ï¼ˆå¯ä»¥æ˜¯ä¸€å¼ è¡¨ï¼Œä¹Ÿå¯ä»¥ä¸æ˜¯ï¼‰å’Œå­ç±»éƒ½æ˜¯è¡¨ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰å…³ç³»ã€‚</li>
</ol>
<h3 id="å•è¡¨å¤šæ€"><a href="#å•è¡¨å¤šæ€" class="headerlink" title="å•è¡¨å¤šæ€"></a>å•è¡¨å¤šæ€</h3><p><code>InheritanceType.SINGLE_TABLE</code></p>
<p>çˆ¶ç±»å®ä½“å¯¹è±¡ä¸å„ä¸ªå­å®ä½“å¯¹è±¡å…±ç”¨ä¸€å¼ è¡¨ï¼Œé€šè¿‡ä¸€ä¸ªå­—æ®µçš„ä¸åŒå€¼ä»£è¡¨ä¸åŒçš„å¯¹è±¡ã€‚</p>
<p>ä¸¾ä¾‹ï¼ŒæŠ½è±¡ä¸€ä¸ª Book å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="meta">@Entity(name=&quot;book&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Inheritance(strategy = InheritanceType.SINGLE_TABLE)</span></span><br><span class="line"><span class="meta">@DiscriminatorColumn(name=&quot;color&quot;, discriminatorType = DiscriminatorType.STRING)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ–°å»ºä¸€ä¸ª BlueBook å¯¹è±¡ï¼Œä½œä¸º Book çš„å­å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.DiscriminatorValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="meta">@DiscriminatorValue(&quot;blue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlueBook</span> <span class="keyword">extends</span> <span class="title">Book</span></span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String blueMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ–°å»ºä¸€ä¸ª RedBook å¯¹è±¡ï¼Œä½œä¸º Book çš„å¦ä¸€å­å¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//çº¢çš®ä¹¦</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DiscriminatorValue(&quot;red&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBook</span> <span class="keyword">extends</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String redMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶ï¼Œä¸€å…±æ–°å»ºäº†ä¸‰ä¸ª Entity å¯¹è±¡ï¼Œå…¶å®éƒ½æ˜¯æŒ‡ book è¿™ä¸€å¼ è¡¨ï¼Œé€šè¿‡ book è¡¨é‡Œé¢çš„ color å­—æ®µæ¥åŒºåˆ†çº¢ä¹¦è¿˜æ˜¯ç»¿ä¹¦ã€‚</p>
<p>æµ‹è¯•çœ‹çœ‹ç»“æœï¼Œæ–°å»ºä¸€ä¸ª RedBookRepository ç±»ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RedBookRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">RedBook</span>, <span class="title">Long</span>&gt;</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æ–°å»ºä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.example1.book.RedBook;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.example1.book.RedBookRepository;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBookRepositoryTest</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RedBookRepository redBookRepository;</span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRedBook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      RedBook redBook = <span class="keyword">new</span> RedBook();</span><br><span class="line">      redBook.setTitle(<span class="string">&quot;redbook&quot;</span>);</span><br><span class="line">      redBook.setRedMark(<span class="string">&quot;redmark&quot;</span>);</span><br><span class="line">      redBook.setId(<span class="number">1L</span>);</span><br><span class="line">      redBookRepository.saveAndFlush(redBook);</span><br><span class="line">      RedBook r = redBookRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">      System.out.println(r.getId() + <span class="string">&quot;:&quot;</span> + r.getTitle() + <span class="string">&quot;:&quot;</span> + r.getRedMark());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åçœ‹ä¸€ä¸‹æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">create table <span class="title">book</span> <span class="params">(color varchar(<span class="number">31</span>)</span> not <span class="keyword">null</span>, id bigint not <span class="keyword">null</span>, title <span class="title">varchar</span><span class="params">(<span class="number">255</span>)</span>, blue_mark <span class="title">varchar</span><span class="params">(<span class="number">255</span>)</span>, red_mark <span class="title">varchar</span><span class="params">(<span class="number">255</span>)</span>, primary <span class="title">key</span> <span class="params">(id)</span>)</span></span><br></pre></td></tr></table></figure>

<p>å‘ç°åªåˆ›å»ºäº†ä¸€å¼ è¡¨ï¼Œinsert äº†ä¸€æ¡æ•°æ®ï¼Œä½†æ˜¯ color å­—æ®µé»˜è®¤ç»™çš„æ˜¯ redã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">book</span> <span class="params">(title, red_mark, color, id)</span> <span class="title">values</span> <span class="params">(?, ?, <span class="string">&#x27;red&#x27;</span>, ?)</span></span></span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå†çœ‹ä¸€ä¸‹æ‰“å°ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>:redbook:redmark</span><br></pre></td></tr></table></figure>

<p>ç»“æœå®Œå…¨å’Œé¢„æœŸçš„ä¸€æ ·ï¼Œè¿™è¯´æ˜äº† RedBookã€BlueBookã€Bookï¼Œéƒ½æ˜¯ä¸€å¼ è¡¨ï¼Œé€šè¿‡å­—æ®µ color çš„å€¼ä¸ä¸€æ ·ï¼Œæ¥åŒºåˆ†ä¸åŒçš„å®ä½“ã€‚</p>
<h3 id="å¤šè¡¨å¤šæ€"><a href="#å¤šè¡¨å¤šæ€" class="headerlink" title="å¤šè¡¨å¤šæ€"></a>å¤šè¡¨å¤šæ€</h3><p><code>InheritanceType.JOINED</code></p>
<p>åœ¨è¿™ç§æ˜ å°„ç­–ç•¥é‡Œé¢ï¼Œç»§æ‰¿ç»“æ„ä¸­çš„æ¯ä¸€ä¸ªå®ä½“ï¼ˆentityï¼‰ç±»éƒ½ä¼šæ˜ å°„åˆ°æ•°æ®åº“é‡Œä¸€ä¸ªå•ç‹¬çš„è¡¨ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå®ä½“ï¼ˆentityï¼‰éƒ½ä¼šè¢«æ˜ å°„åˆ°æ•°æ®åº“ä¸­ï¼Œä¸€ä¸ªå®ä½“ï¼ˆentityï¼‰ç±»å¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€ä¸ªè¡¨ã€‚</p>
<p>å…¶ä¸­æ ¹å®ä½“ï¼ˆroot entityï¼‰å¯¹åº”çš„è¡¨ä¸­å®šä¹‰äº†ä¸»é”®ï¼ˆprimary keyï¼‰ï¼Œæ‰€æœ‰çš„å­ç±»å¯¹åº”çš„æ•°æ®åº“è¡¨éƒ½è¦å…±åŒä½¿ç”¨ Book é‡Œé¢çš„ @ID è¿™ä¸ªä¸»é”®ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¸‰ä¸ªå®ä½“ï¼Œæµ‹è¯•ä¸€ä¸‹InheritanceType.JOINEDï¼Œæ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="meta">@Entity(name=&quot;book&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Inheritance(strategy = InheritanceType.JOINED)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬ Book çˆ¶ç±»ã€æ”¹å˜ Inheritance ç­–ç•¥ã€åˆ é™¤ DiscriminatorColumnï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.PrimaryKeyJoinColumn;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="meta">@PrimaryKeyJoinColumn(name = &quot;book_id&quot;, referencedColumnName = &quot;id&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlueBook</span> <span class="keyword">extends</span> <span class="title">Book</span></span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String blueMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.PrimaryKeyJoinColumn;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@PrimaryKeyJoinColumn(name = &quot;book_id&quot;, referencedColumnName = &quot;id&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBook</span> <span class="keyword">extends</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String redMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼ŒBlueBook å’Œ RedBook ä¹Ÿåˆ é™¤ DiscriminatorColumnï¼Œæ–°å¢<code>@PrimaryKeyJoinColumn(name = &quot;book_id&quot;, referencedColumnName = &quot;id&quot;)</code>ï¼Œå’Œ book çˆ¶ç±»å…±ç”¨ä¸€ä¸ªä¸»é”®å€¼ï¼Œè€Œ RedBookRepository å’Œæµ‹è¯•ç”¨ä¾‹ä¸å˜ï¼Œæˆ‘ä»¬æ‰§è¡Œçœ‹ä¸€ä¸‹ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">create table <span class="title">blue_book</span> <span class="params">(blue_mark varchar(<span class="number">255</span>)</span>, book_id bigint not <span class="keyword">null</span>, primary <span class="title">key</span> <span class="params">(book_id)</span>)</span></span><br><span class="line"><span class="function">Hibernate: create table <span class="title">book</span> <span class="params">(id bigint not <span class="keyword">null</span>, title varchar(<span class="number">255</span>)</span>, primary <span class="title">key</span> <span class="params">(id)</span>)</span></span><br><span class="line"><span class="function">Hibernate: create table <span class="title">red_book</span> <span class="params">(red_mark varchar(<span class="number">255</span>)</span>, book_id bigint not <span class="keyword">null</span>, primary <span class="title">key</span> <span class="params">(book_id)</span>)</span></span><br><span class="line"><span class="function">Hibernate: alter table blue_book add constraint FK9uuwgq7a924vtnys1rgiyrlk7 foreign <span class="title">key</span> <span class="params">(book_id)</span> references book</span></span><br><span class="line"><span class="function">Hibernate: alter table red_book add constraint FKk8rvl61bjy9lgsr9nhxn5soq5 foreign <span class="title">key</span> <span class="params">(book_id)</span> references book</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸€å…±åˆ›å»ºäº†ä¸‰å¼ è¡¨ï¼Œå¹¶ä¸”æ–°å¢äº†ä¸¤ä¸ªå¤–é”®çº¦æŸï¼›</p>
<p>è€Œæˆ‘ä»¬ save çš„æ—¶å€™ä¹Ÿç”Ÿæˆäº†ä¸¤ä¸ª insert è¯­å¥ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">book</span> <span class="params">(title, id)</span> <span class="title">values</span> <span class="params">(?, ?)</span></span></span><br><span class="line"><span class="function">Hibernate: insert into <span class="title">red_book</span> <span class="params">(red_mark, book_id)</span> <span class="title">values</span> <span class="params">(?, ?)</span></span></span><br></pre></td></tr></table></figure>

<p>è€Œæ‰“å°ç»“æœä¾ç„¶ä¸å˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>:redbook:redmark</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•å’Œä¸Šé¢çš„ InheritanceType.SINGLE_TABLE åŒºåˆ«åœ¨äºè¡¨çš„æ•°é‡å’Œå…³ç³»ä¸ä¸€æ ·ï¼Œè¿™æ˜¯è¡¨è®¾è®¡çš„å¦ä¸€ç§æ–¹å¼ã€‚</p>
<h3 id="Object-çš„ç»§æ‰¿"><a href="#Object-çš„ç»§æ‰¿" class="headerlink" title="Object çš„ç»§æ‰¿"></a>Object çš„ç»§æ‰¿</h3><p><code>InheritanceType.TABLE_PER_CLASS</code> å’Œ <code>@MappedSuperClass</code> ä¸€æ ·</p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨ <code>@MappedSuperClass</code> ä¸»é”®çš„æ—¶å€™ï¼Œå¦‚æœä¸æŒ‡å®š @Inheritanceï¼Œé»˜è®¤å°±æ˜¯æ­¤ç§ TABLE_PER_CLASS æ¨¡å¼ã€‚å½“ç„¶äº†ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¾ç¤ºæŒ‡å®šï¼Œè¦æ±‚ç»§æ‰¿åŸºç±»çš„éƒ½æ˜¯ä¸€å¼ è¡¨ï¼Œè€Œçˆ¶ç±»ä¸æ˜¯è¡¨ï¼Œæ˜¯ java å¯¹è±¡çš„æŠ½è±¡ç±»ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p>
<p>é¦–å…ˆï¼Œè¿˜æ˜¯æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¸‰ä¸ªå®ä½“ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="meta">@Entity(name=&quot;book&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼ŒBook è¡¨é‡‡ç”¨ TABLE_PER_CLASS ç­–ç•¥ï¼Œå…¶å­å®ä½“ç±»éƒ½ä»£è¡¨å„è‡ªçš„è¡¨ï¼Œå®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBook</span> <span class="keyword">extends</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String redMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.book;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.EqualsAndHashCode;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper=false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlueBook</span> <span class="keyword">extends</span> <span class="title">Book</span></span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String blueMark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶ï¼Œä» RedBook å’Œ BlueBook é‡Œé¢å»æ‰ PrimaryKeyJoinColumnï¼Œ</p>
<p>è€Œ RedBookRepository å’Œæµ‹è¯•ç”¨ä¾‹ä¸å˜ï¼Œæˆ‘ä»¬æ‰§è¡Œçœ‹ä¸€ä¸‹ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">create table <span class="title">blue_book</span> <span class="params">(id bigint not <span class="keyword">null</span>, title varchar(<span class="number">255</span>)</span>, blue_mark <span class="title">varchar</span><span class="params">(<span class="number">255</span>)</span>, primary <span class="title">key</span> <span class="params">(id)</span>)</span></span><br><span class="line"><span class="function">Hibernate: create table <span class="title">book</span> <span class="params">(id bigint not <span class="keyword">null</span>, title varchar(<span class="number">255</span>)</span>, primary <span class="title">key</span> <span class="params">(id)</span>)</span></span><br><span class="line"><span class="function">Hibernate: create table <span class="title">red_book</span> <span class="params">(id bigint not <span class="keyword">null</span>, title varchar(<span class="number">255</span>)</span>, red_mark <span class="title">varchar</span><span class="params">(<span class="number">255</span>)</span>, primary <span class="title">key</span> <span class="params">(id)</span>)</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿˜æ˜¯åˆ›å»ºäº†ä¸‰å¼ è¡¨ï¼Œä½†ä¸‰å¼ è¡¨ä»€ä¹ˆå…³ç³»ä¹Ÿæ²¡æœ‰ã€‚</p>
<p>è€Œ insert è¯­å¥ä¹Ÿåªæœ‰ä¸€æ¡ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">red_book</span> <span class="params">(title, red_mark, id)</span> <span class="title">values</span> <span class="params">(?, ?, ?)</span></span></span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœè¿˜æ˜¯ä¸å˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>:redbook:redmark</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ä¸ä¸Šé¢ä¸¤ä¸ªç›¸æ¯”è¾ƒï¼Œè¯­ä¹‰æ›´åŠ æ¸…æ™°ï¼Œæ˜¯<strong>æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§åšæ³•</strong>ã€‚</p>
<h2 id="å…³äºç»§æ‰¿å…³ç³»çš„ç»éªŒä¹‹è°ˆ"><a href="#å…³äºç»§æ‰¿å…³ç³»çš„ç»éªŒä¹‹è°ˆ" class="headerlink" title="å…³äºç»§æ‰¿å…³ç³»çš„ç»éªŒä¹‹è°ˆ"></a>å…³äºç»§æ‰¿å…³ç³»çš„ç»éªŒä¹‹è°ˆ</h2><blockquote>
<p>ğŸ¯ä¸ªäººç»éªŒæ¥çœ‹ï¼Œ@Inheritance çš„è¿™ç§ä½¿ç”¨æ–¹å¼ä¼šé€æ¸è¢«æ·˜æ±°ï¼Œå› ä¸ºè¿™æ ·çš„è¡¨çš„è®¾è®¡å¾ˆå¤æ‚ï¼Œæœ¬åº”è¯¥åœ¨ä¸šåŠ¡å±‚é¢åšçš„äº‹æƒ…ï¼ˆå¤šæ€ï¼‰ï¼Œå´éƒ½åœ¨ dataSource çš„è¡¨çº§åˆ«åšäº†ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Entity æ³¨è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa Hibernate ä¸€çº§ç¼“å­˜</title>
    <url>/2021/01/26/SpringDataJpa%E7%9A%84Hibernate%E7%9A%84%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<h1 id="Hibernate-ä¸€çº§ç¼“å­˜"><a href="#Hibernate-ä¸€çº§ç¼“å­˜" class="headerlink" title="Hibernate ä¸€çº§ç¼“å­˜"></a>Hibernate ä¸€çº§ç¼“å­˜</h1><h2 id="ä¸€çº§ç¼“å­˜"><a href="#ä¸€çº§ç¼“å­˜" class="headerlink" title="ä¸€çº§ç¼“å­˜"></a>ä¸€çº§ç¼“å­˜</h2><h3 id="ä»€ä¹ˆæ˜¯ä¸€çº§ç¼“å­˜"><a href="#ä»€ä¹ˆæ˜¯ä¸€çº§ç¼“å­˜" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸€çº§ç¼“å­˜"></a>ä»€ä¹ˆæ˜¯ä¸€çº§ç¼“å­˜</h3><p>æŒ‰ç…§ Hibernate å’Œ JPA åè®®é‡Œé¢çš„è§£é‡Šï¼Œç»å¸¸è¯´çš„ First Level Cacheï¼ˆä¸€çº§ç¼“å­˜ï¼‰ä¹Ÿå°±æ˜¯ <code>PersistenceContext</code>ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€ä¸€çº§ç¼“å­˜çš„è½½ä½“æ˜¯ <code>Session</code> æˆ–è€… <code>EntityManager</code>ï¼›è€Œä¸€çº§ç¼“å­˜çš„å®ä½“ä¹Ÿå°±æ˜¯æ•°æ®åº“é‡Œé¢å¯¹åº”çš„å®ä½“ã€‚</p>
<p>åœ¨ <code>SessionImpl</code> çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç° <code>PersistenceContext</code> çš„å®ç°ç±» <code>StatefulPersistenceContext</code> æ˜¯é€šè¿‡ <code>HashMap</code> æ¥å­˜å‚¨å®ä½“ä¿¡æ¯çš„ã€‚</p>
<p>å…¶å…³é”®æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatefulPersistenceContext</span> <span class="keyword">implements</span> <span class="title">PersistenceContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">//æ ¹æ®EntityUniqueKeyä½œä¸ºkeyæ¥å‚¨å­˜Entity</span></span><br><span class="line">  <span class="keyword">private</span> HashMap&lt;EntityUniqueKey, Object&gt; entitiesByUniqueKey;</span><br><span class="line">  <span class="comment">//æ ¹æ®EntityUniqueKeyä½œä¸ºkeyå–å½“å‰å®ä½“</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">getEntity</span><span class="params">(EntityUniqueKey euk)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> entitiesByUniqueKey == <span class="keyword">null</span> ? <span class="keyword">null</span> : entitiesByUniqueKey.get( euk );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//å‚¨å­˜å®ä½“ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆåˆ›å»ºHashMap&lt;&gt;</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEntity</span><span class="params">(EntityUniqueKey euk, Object entity)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> ( entitiesByUniqueKey == <span class="keyword">null</span> ) &#123;</span><br><span class="line">        entitiesByUniqueKey = <span class="keyword">new</span> HashMap&lt;&gt;( INIT_COLL_SIZE );</span><br><span class="line">     &#125;</span><br><span class="line">     entitiesByUniqueKey.put( euk, entity );</span><br><span class="line">  &#125;</span><br><span class="line">......&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ EntityUniqueKey çš„æ ¸å¿ƒæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityUniqueKey</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String uniqueKeyName;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> String entityName;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Type keyType;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> EntityMode entityMode;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> hashCode;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">     EntityUniqueKey that = (EntityUniqueKey) other;</span><br><span class="line">     <span class="keyword">return</span> that != <span class="keyword">null</span> &amp;&amp; that.entityName.equals( entityName )</span><br><span class="line">           &amp;&amp; that.uniqueKeyName.equals( uniqueKeyName )</span><br><span class="line">           &amp;&amp; keyType.isEqual( that.key, key );</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œç”¨ <code>PersistenceContext</code> æ¥åˆ¤æ–­å®ä½“æ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯ä»¥ç›´æ¥æ ¹æ®å®ä½“é‡Œé¢çš„ä¸»é”®è¿›è¡Œã€‚</p>
<h3 id="ä¸€çº§ç¼“å­˜çš„ä½œç”¨"><a href="#ä¸€çº§ç¼“å­˜çš„ä½œç”¨" class="headerlink" title="ä¸€çº§ç¼“å­˜çš„ä½œç”¨"></a>ä¸€çº§ç¼“å­˜çš„ä½œç”¨</h3><p>ç”±äºä¸€çº§ç¼“å­˜å°±æ˜¯ <code>PersistenceContext</code>ï¼Œé‚£ä¹ˆä¸€çº§ç¼“å­˜çš„æœ€å¤§ä½œç”¨å°±æ˜¯<strong><em>ç®¡ç† Entity çš„ç”Ÿå‘½å‘¨æœŸ</em></strong>ã€‚</p>
<ol>
<li><p>Newï¼ˆTransientï¼‰çŠ¶æ€çš„ï¼Œä¸åœ¨ä¸€çº§ç¼“å­˜ç®¡ç†ä¹‹åˆ—ï¼Œè¿™æ˜¯æ–°åˆ›å»ºçš„ï¼›</p>
</li>
<li><p>Detached æ¸¸ç¦»çŠ¶æ€çš„ï¼Œä¸åœ¨ä¸€çº§ç¼“å­˜é‡Œé¢ï¼Œå’Œ New çš„å”¯ä¸€åŒºåˆ«æ˜¯å®ƒå¸¦æœ‰ä¸»é”®å’Œ Version ä¿¡æ¯ï¼›</p>
</li>
<li><p>Managerã€Removed çŠ¶æ€çš„å®ä½“åœ¨ä¸€çº§ç¼“å­˜ç®¡ç†ä¹‹åˆ—ï¼Œæ‰€æœ‰å¯¹è¿™ä¸¤ç§çŠ¶æ€çš„å®ä½“è¿›è¡Œçš„æ›´æ–°æ“ä½œï¼Œéƒ½ä¸ä¼šç«‹å³æ›´æ–°åˆ°æ•°æ®åº“é‡Œé¢ï¼Œåªæœ‰æ‰§è¡Œäº† flush ä¹‹åæ‰ä¼šåŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚</p>
</li>
</ol>
<p>ç”¨ä¸€å¼ å›¾(æ³¨ï¼šå›¾ç‰‡æ¥æºäºç½‘ç»œ)æ¥è¡¨ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129111859.png" alt=""></p>
<p>å¯¹äºå®ä½“ 1 æ¥è¯´ï¼Œæ–°å¢å’Œæ›´æ–°æ“ä½œéƒ½æ˜¯å…ˆè¿›è¡Œä¸€çº§ç¼“å­˜ï¼Œåªæœ‰ flush çš„æ—¶å€™æ‰ä¼šåŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚è€Œå½“æˆ‘ä»¬æ‰§è¡Œäº† <code>entityManager.clean()</code> æˆ–è€…æ˜¯ <code>entityManager.detach(entity1)</code>ï¼Œé‚£ä¹ˆå®ä½“ 1 å°±ä¼šå˜æˆæ¸¸ç¦»çŠ¶æ€ï¼Œè¿™æ—¶å†å¯¹å®ä½“ 1 è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœå†æ‰§è¡Œ flush çš„è¯ï¼Œå°±ä¸ä¼šåŒæ­¥åˆ° DB é‡Œé¢äº†ã€‚ç”¨ä»£ç æ¥è¯´æ˜ä¸€ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">    <span class="meta">@PersistenceContext(properties = &#123;@PersistenceProperty(</span></span><br><span class="line"><span class="meta">            name = &quot;org.hibernate.flushMode&quot;,</span></span><br><span class="line"><span class="meta">            value = &quot;MANUAL&quot;//æ‰‹åŠ¨flush</span></span><br><span class="line"><span class="meta">    )&#125;)</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLife</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo = UserInfo.builder().name(<span class="string">&quot;new name&quot;</span>).build();</span><br><span class="line">        <span class="comment">//æ–°å¢ä¸€ä¸ªå¯¹è±¡userInfoäº¤ç»™PersistenceContextç®¡ç†ï¼Œå³ä¸€çº§ç¼“å­˜</span></span><br><span class="line">        entityManager.persist(userInfo);</span><br><span class="line">        <span class="comment">//æ­¤æ—¶æ²¡æœ‰detachå’Œclearä¹‹å‰ï¼Œflushçš„æ—¶å€™è¿˜ä¼šäº§ç”Ÿæ›´æ–°SQL</span></span><br><span class="line">        userInfo.setName(<span class="string">&quot;old name&quot;</span>);</span><br><span class="line">        entityManager.flush();</span><br><span class="line">        entityManager.clear();</span><br><span class="line"><span class="comment">//        entityManager.detach(userInfo);</span></span><br><span class="line">        <span class="comment">// entityManagerå·²ç»clearï¼Œæ­¤æ—¶å·²ç»ä¸ä¼šå¯¹UserInfoè¿›è¡Œæ›´æ–°äº†</span></span><br><span class="line">        userInfo.setName(<span class="string">&quot;new name 11&quot;</span>);</span><br><span class="line">        entityManager.flush();</span><br><span class="line">        <span class="comment">//ç”±äºæœ‰cacheæœºåˆ¶ï¼Œç›¸åŒçš„å¯¹è±¡æŸ¥è¯¢åªä¼šè§¦å‘ä¸€æ¬¡æŸ¥è¯¢SQL</span></span><br><span class="line">        UserInfo u1 = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">        <span class="comment">//to do some thing</span></span><br><span class="line">        UserInfo u2 = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŠŠ SQL æ‰“å°ä¸€ä¸‹ï¼Œè¾“å‡ºåˆ°æ§åˆ¶å°çš„ SQL å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span><br><span class="line">Hibernate: update user_info <span class="built_in">set</span> create_time=?, create_user_id=?, last_modified_time=?, last_modified_user_id=?, version=?, ages=?, email_address=?, last_name=?, name=?, telephone=? <span class="built_in">where</span> id=? and version=?</span><br><span class="line">Hibernate: <span class="built_in">select</span> userinfo0_.id as id1_2_0_, userinfo0_.create_time as create_t2_2_0_, userinfo0_.create_user_id as create_u3_2_0_, userinfo0_.last_modified_time as last_mod4_2_0_, userinfo0_.last_modified_user_id as last_mod5_2_0_, userinfo0_.version as version6_2_0_, userinfo0_.ages as ages7_2_0_, userinfo0_.email_address as email_ad8_2_0_, userinfo0_.last_name as last_nam9_2_0_, userinfo0_.name as name10_2_0_, userinfo0_.telephone as telepho11_2_0_, rooms1_.user_info_id as user_inf1_3_1_, room2_.id as rooms_id2_3_1_, room2_.id as id1_1_2_, room2_.create_time as create_t2_1_2_, room2_.create_user_id as create_u3_1_2_, room2_.last_modified_time as last_mod4_1_2_, room2_.last_modified_user_id as last_mod5_1_2_, room2_.version as version6_1_2_, room2_.title as title7_1_2_ from user_info userinfo0_ left outer join user_info_rooms rooms1_ on userinfo0_.id=rooms1_.user_info_id left outer join room room2_ on rooms1_.rooms_id=room2_.id <span class="built_in">where</span> userinfo0_.id=?</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°æ²¡æœ‰ç¬¬äºŒæ¬¡æ›´æ–°ã€‚</p>
<p><strong>ä¸èƒ½è®¾ç½®ä¸€çº§ç¼“å­˜çš„å¤§å°</strong></p>
<p>ä»åº•å±‚åŸç†å¯ä»¥åˆ†æå‡ºï¼šä¸€çº§ç¼“å­˜ä¾èµ– Java å†…å­˜å †çš„å¤§å°ï¼Œæ‰€ä»¥å—åˆ°æœ€å¤§å †å’Œæœ€å°å †çš„é™åˆ¶ï¼Œå³æ¸…é™¤ä¸€çº§ç¼“å­˜çš„æœºåˆ¶å°±æ˜¯åˆ©ç”¨ JVM çš„ GC æœºåˆ¶ï¼Œæ¸…ç†æ‰ GC å°±ä¼šæ¸…ç†æ‰ä¸€çº§ç¼“å­˜ã€‚</p>
<p>æ‰€ä»¥å½“è¯·æ±‚å¹¶å‘é‡å¤§çš„æ—¶å€™ï¼ŒSession çš„å¯¹è±¡å°±ä¼šå˜å¾—å¾ˆå¤šï¼Œæ­¤æ—¶å°±ä¼šéœ€è¦æ›´å¤šå†…å­˜ã€‚å½“è¯·æ±‚ç»“æŸä¹‹åï¼Œéšç€ GC çš„å›æ”¶ï¼Œé‡Œé¢å°±ä¼šæ¸…é™¤ä¸€çº§ç¼“å­˜ç•™ä¸‹æ¥çš„å¯¹è±¡ã€‚</p>
<p><strong>ä¸èƒ½å…³é—­ä¸€çº§ç¼“å­˜</strong></p>
<p>é™¤éä¸ç”¨ Hibernate æˆ– JPAï¼Œæ”¹ç”¨ Mybatisï¼Œå› ä¸ºä¸€çº§ç¼“å­˜æ˜¯ JPA çš„æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€ã€‚</p>
<h2 id="Query-Plan-Cache"><a href="#Query-Plan-Cache" class="headerlink" title="Query Plan Cache"></a>Query Plan Cache</h2><p>JPA é‡Œé¢å¤§éƒ¨åˆ†çš„æŸ¥è¯¢éƒ½æ˜¯åŸºäº JPQL æŸ¥è¯¢è¯­æ³•ï¼Œä»è€Œä¼šæœ‰ä¸€ä¸ªè¿‡ç¨‹æŠŠ JPQL è½¬åŒ–æˆçœŸæ­£çš„ SQLï¼Œè€Œååˆ°æ•°æ®åº“é‡Œæ‰§è¡Œã€‚è€Œ JPQL è½¬åŒ–æˆåŸå§‹çš„ SQL æ—¶ï¼Œå°±ä¼šæ¶ˆè€—ä¸€å®šçš„æ€§èƒ½ï¼Œæ‰€ä»¥ Hibernate è®¾è®¡äº†ä¸€ä¸ª Query Plan Cache çš„æœºåˆ¶ï¼Œç”¨æ¥å­˜å‚¨ JPQL æˆ–è€… Criteria Query åˆ° Native SQL ä¸­è½¬åŒ–çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯è¯´ Query Plan Cache é‡Œé¢å­˜å‚¨äº†æœ€ç»ˆè¦æ‰§è¡Œçš„ SQLï¼Œä»¥åŠå‚æ•°å’Œè¿”å›ç»“æœçš„ç±»å‹ã€‚</p>
<h3 id="QueryPlanCache-æ˜¯ä»€ä¹ˆ"><a href="#QueryPlanCache-æ˜¯ä»€ä¹ˆ" class="headerlink" title="QueryPlanCache æ˜¯ä»€ä¹ˆ"></a>QueryPlanCache æ˜¯ä»€ä¹ˆ</h3><p>åœ¨ Hibernate ä¸­ï¼Œ<code>QueryPlanCache</code> å°±æ˜¯æŒ‡å…·ä½“çš„æŸä¸€ä¸ªç±»ã€‚æ ¸å¿ƒæºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.hibernate.engine.query.spi;</span><br><span class="line"><span class="comment">//å­˜å‚¨query plan å’Œ query parameter metdata</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueryPlanCache</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//queryPlanCacheçš„å­˜å‚¨ç»“æ„ä¸ºè‡ªå®šä¹‰çš„HashMapç»“æ„ï¼Œç”¨æ¥å­˜å‚¨JPQLåˆ°SQLçš„è½¬åŒ–è¿‡ç¨‹åŠå…¶SQLçš„æ‰§è¡Œè¯­å¥å’Œå‚æ•°ï¼Œè¿”å›ç»“æœçš„metadata;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoundedConcurrentHashMap queryPlanCache;</span><br><span class="line">    <span class="comment">//è¿™ä¸ªç”¨æ¥å­˜å‚¨@Queryçš„nativeQuery = trueçš„query planï¼Œå³åŸå§‹SQLçš„meta,åŒ…å«å‚æ•°å’Œreturn typeçš„ meta;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoundedConcurrentHashMap&lt;ParameterMetadataKey,ParameterMetadataImpl&gt; parameterMetadataCache;</span><br><span class="line">    <span class="comment">//QueryPlanCacheçš„æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QueryPlanCache</span><span class="params">(<span class="keyword">final</span> SessionFactoryImplementor factory, QueryPlanCreator queryPlanCreator)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.factory = factory;</span><br><span class="line">       <span class="keyword">this</span>.queryPlanCreator = queryPlanCreator;</span><br><span class="line">       <span class="comment">//maxParameterMetadataçš„ä¸ªæ•°ï¼Œè®¡ç®—é€»è¾‘ï¼Œå¯ä»¥è‡ªå®šä¹‰é…ç½®ï¼Œæˆ–è€…é‡‡ç”¨é»˜è®¤å€¼</span></span><br><span class="line">       Integer maxParameterMetadataCount = ConfigurationHelper.getInteger(</span><br><span class="line">             Environment.QUERY_PLAN_CACHE_PARAMETER_METADATA_MAX_SIZE,</span><br><span class="line">             factory.getProperties()</span><br><span class="line">       );</span><br><span class="line">       <span class="keyword">if</span> ( maxParameterMetadataCount == <span class="keyword">null</span> ) &#123;</span><br><span class="line">          maxParameterMetadataCount = ConfigurationHelper.getInt(</span><br><span class="line">                Environment.QUERY_PLAN_CACHE_MAX_STRONG_REFERENCES,</span><br><span class="line">                factory.getProperties(),</span><br><span class="line">                DEFAULT_PARAMETER_METADATA_MAX_COUNT</span><br><span class="line">          );</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//maxQueryPlançš„ä¸ªæ•°ï¼Œè®¡ç®—é€»è¾‘ï¼Œå¯ä»¥è‡ªå®šä¹‰é…ç½®å¤§å°ï¼Œæˆ–è€…é‡‡ç”¨é»˜è®¤å€¼</span></span><br><span class="line">       Integer maxQueryPlanCount = ConfigurationHelper.getInteger(</span><br><span class="line">             Environment.QUERY_PLAN_CACHE_MAX_SIZE,</span><br><span class="line">             factory.getProperties()</span><br><span class="line">       );</span><br><span class="line">       <span class="keyword">if</span> ( maxQueryPlanCount == <span class="keyword">null</span> ) &#123;</span><br><span class="line">          maxQueryPlanCount = ConfigurationHelper.getInt(</span><br><span class="line">                Environment.QUERY_PLAN_CACHE_MAX_SOFT_REFERENCES,</span><br><span class="line">                factory.getProperties(),</span><br><span class="line">                DEFAULT_QUERY_PLAN_MAX_COUNT</span><br><span class="line">          );</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//æ–°å»ºä¸€ä¸ª BoundedConcurrentHashMapçš„queryPlanCacheï¼Œç”¨æ¥å­˜å‚¨JPQLå’ŒCriteria Queryåˆ°SQLçš„è½¬åŒ–è¿‡ç¨‹</span></span><br><span class="line">       queryPlanCache = <span class="keyword">new</span> BoundedConcurrentHashMap( maxQueryPlanCount, <span class="number">20</span>, BoundedConcurrentHashMap.Eviction.LIRS );</span><br><span class="line">    <span class="comment">//æ–°å»ºä¸€ä¸ª BoundedConcurrentHashMapçš„parameterMetadataCacheï¼Œç”¨æ¥å­˜å‚¨Native SQLçš„è½¬åŒ–è¿‡ç¨‹</span></span><br><span class="line">       parameterMetadataCache = <span class="keyword">new</span> BoundedConcurrentHashMap&lt;&gt;(</span><br><span class="line">             maxParameterMetadataCount,</span><br><span class="line">             <span class="number">20</span>,</span><br><span class="line">             BoundedConcurrentHashMap.Eviction.LIRS</span><br><span class="line">       );</span><br><span class="line">       nativeQueryInterpreter = factory.getServiceRegistry().getService( NativeQueryInterpreter.class );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é»˜è®¤çš„parameterMetadataCacheçš„HashMapçš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œé»˜è®¤128æ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PARAMETER_METADATA_MAX_COUNT = <span class="number">128</span>;</span><br><span class="line">    <span class="comment">//é»˜è®¤çš„queryPlanCacheçš„HashMapå­˜å‚¨ç©ºé—´å¤§å°ï¼Œé»˜è®¤2048æ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_QUERY_PLAN_MAX_COUNT = <span class="number">2048</span>;</span><br><span class="line">......ä¸é‡è¦çš„ä»£ç å…ˆçœç•¥</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="QueryPlanCache-å­˜å‚¨çš„å†…å®¹"><a href="#QueryPlanCache-å­˜å‚¨çš„å†…å®¹" class="headerlink" title="QueryPlanCache å­˜å‚¨çš„å†…å®¹"></a>QueryPlanCache å­˜å‚¨çš„å†…å®¹</h3><p>æ–°å»ºä¸€ä¸ª <code>UserInfoRepository</code>ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">//æ²¡æœ‰ç”¨@Queryï¼Œç›´æ¥ä½¿ç”¨method name defining query</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findByNameAndCreateTimeBetween</span><span class="params">(String name, Instant begin, Instant endTime)</span></span>;</span><br><span class="line">   <span class="comment">//æ¼”ç¤ºSpELæ ¹æ®æ•°ç»„ä¸‹æ ‡å–å‚æ•°ï¼Œå’Œæ ¹æ®æ™®é€šçš„Parmaçš„åå­—:nameå–å‚æ•°</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.lastName like %:#&#123;[0]&#125; and u.name like %:name%&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findContainingEscaped</span><span class="params">(<span class="meta">@Param(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line">   <span class="comment">//SpELå–Parmaçš„åå­—customeré‡Œé¢çš„å±æ€§</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.name = :#&#123;#customer.name&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findUsersByCustomersFirstname</span><span class="params">(<span class="meta">@Param(&quot;customer&quot;)</span> UserInfo customer)</span></span>;</span><br><span class="line">   <span class="comment">//åˆ©ç”¨SpELæ ¹æ®ä¸€ä¸ªå†™æ­»çš„&#x27;jack&#x27;å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°</span></span><br><span class="line">   <span class="meta">@Query(&quot;select u from UserInfo u where u.name = ?#&#123;&#x27;jack&#x27;&#125;&quot;)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findOliverBySpELExpressionWithoutArgumentsWithQuestionmark</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="meta">@Query(value = &quot;select * from user_info where name=:name&quot;,nativeQuery = true)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findByName</span><span class="params">(<span class="meta">@Param(value = &quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ @Query å®šä¹‰çš„ nativeQuery=false çš„ JPQLï¼Œä¼šåœ¨å¯åŠ¨æˆåŠŸä¹‹åé¢„å…ˆæ”¾åœ¨ <code>QueryPlanCache</code> é‡Œé¢ï¼Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<p><img src="http://image.leonote.cn/20210129133738.png" alt=""></p>
<p>å‘ç°é‡Œé¢ <code>parameterMetadataCache</code> æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ”¾ç½® nativeQuery=true çš„ Query SQLï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•é‡Œé¢å®šä¹‰çš„å…¶ä»–ä¸‰ä¸ª @Query çš„ JPQL è§£æè¿‡ç¨‹ã€‚æ‰“å¼€ç¬¬ä¸€ä¸ªè¯¦ç»†çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129134958.png" alt=""></p>
<p> <code>QueryPlanCache</code> è¿˜æ˜¯èƒ½å­˜æŒºå¤šä¸œè¥¿çš„ï¼šnavtive sqlã€å‚æ•°ã€return ç­‰å„ç§ metadataã€‚ä¹Ÿå¯ä»¥çœ‹å‡ºä¸€ä¸ªç®€å•çš„ JPQL æŸ¥è¯¢ä¼šæœ‰äº›å ç”¨å †å†…å­˜ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤æ‚ç‚¹çš„é¡¹ç›®ï¼Œå„ç§æŸ¥è¯¢çš„ JPQL å¤šä¸€ç‚¹çš„è¯ï¼Œå¯åŠ¨æ‰€éœ€è¦çš„æœ€å°å †å†…å­˜ä¼šå ç”¨ 300Mã€400M çš„ç©ºé—´ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚</p>
<p>åœ¨ <code>UserInfoRepository</code> çš„äº”ä¸ªæ–¹æ³•ä¸­ï¼Œå‰©ä¸‹çš„ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ name defining query å’Œ nativeQuery=trueã€‚è¿™ä¸¤ç§æƒ…å†µæ˜¯ï¼Œå½“è°ƒç”¨çš„æ—¶å€™å‘ç° <code>QueryPlanCache</code> é‡Œé¢æ²¡æœ‰å®ƒä»¬ï¼Œäºæ˜¯å°±ä¼šè¢«å¢åŠ è¿›å»ï¼Œä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä» QueryPlanCache é‡Œé¢å–äº†ã€‚é‚£ä¹ˆåœ¨ Controller é‡Œé¢æ‰§è¡Œè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">userInfoRepository.findByNameAndCreateTimeBetween(<span class="string">&quot;JK&quot;</span>, Instant.now(),Instant.now());</span><br><span class="line">userInfoRepository.findByName(<span class="string">&quot;jack&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ç„¶åé€šè¿‡æ–­ç‚¹å°±ä¼šå‘ç° <code>QueryPlanCache</code> é‡Œé¢å¤šäº†ä¸¤ä¸ª Cacheï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129135226.png" alt=""></p>
<p>åŒæ—¶ï¼Œ<code>parameterMetadataCache</code> é‡Œé¢å°±ä¼šå¤šä¸€æ¡ key/value çš„ nativeQuery=true çš„è§£æè®°å½•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129142257.png" alt=""></p>
<p>æ€»ç»“èµ·æ¥å°±æ˜¯ï¼Œ<code>QueryPlanCache</code> ç”¨æ¥å­˜å‚¨çš„ JQPL æˆ–è€… SQL çš„ Metadata ä¿¡æ¯ï¼Œä»è€Œæå‡äº† Hibernate æ‰§è¡Œ JPQL çš„æ€§èƒ½ï¼Œå› ä¸ºåªæœ‰ç¬¬ä¸€æ¬¡éœ€è¦æŠŠ JPQL è½¬åŒ–æˆ SQLï¼Œåé¢çš„æ¯æ¬¡æ“ä½œå°±å¯ä»¥ç›´æ¥ä» <code>HashMap</code> ä¸­æ‰¾åˆ°å¯¹åº”çš„ SQLï¼Œç›´æ¥æ‰§è¡Œå°±å¯ä»¥äº†ã€‚</p>
<h3 id="QueryPlanCache-å’Œ-Session-æ˜¯ä»€ä¹ˆå…³ç³»"><a href="#QueryPlanCache-å’Œ-Session-æ˜¯ä»€ä¹ˆå…³ç³»" class="headerlink" title="QueryPlanCache å’Œ Session æ˜¯ä»€ä¹ˆå…³ç³»"></a>QueryPlanCache å’Œ Session æ˜¯ä»€ä¹ˆå…³ç³»</h3><p>åœ¨ <code>SessionFactoryImpl</code> çš„æ„é€ æ–¹æ³•é‡Œé¢ä¼š <code>new QueryPlanCache(...)</code>ï¼Œå…³é”®æºç å¦‚ä¸‹ã€‚</p>
<p><img src="http://image.leonote.cn/20210129142421.png" alt=""></p>
<p>è¯´æ˜è¿™ä¸ª application åªéœ€è¦åˆ›å»ºä¸€æ¬¡ <code>QueryPlanCache</code>ï¼Œæ•´ä¸ªé¡¹ç›®å‘¨æœŸæ˜¯å•ä¾‹çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¢«ä¸åŒçš„ Session å…±äº«ï¼Œé‚£ä¹ˆå¯ä»¥æŸ¥çœ‹ Session çš„å…³é”®æºç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129142504.png" alt=""></p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ª <code>SessionImpl</code> çš„å®ä¾‹åœ¨è·å¾— query plan ä¹‹å‰ï¼Œéƒ½ä¼šå»åŒä¸€ä¸ª <code>QueryPlanCache</code> é‡Œé¢æŸ¥è¯¢ä¸€ä¸‹ JPQL å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ã€‚æ‰€ä»¥å¯ä»¥çœ‹å¾—å‡ºæ¥ <code>QueryPlanCache</code> å’Œ <code>Session</code> çš„å…³ç³»æœ‰å¦‚ä¸‹å‡ ç‚¹ã€‚</p>
<ol>
<li><p><code>QueryPlanCache</code> åœ¨æ•´ä¸ª Spring Application å‘¨æœŸå†…å°±æ˜¯ä¸€ä¸ªå®ä¾‹</p>
</li>
<li><p>ä¸åŒçš„ Session ä½œç”¨åŸŸï¼Œå¯ä»¥ä»£è¡¨ä¸åŒçš„ <code>SessionImpl</code> å®ä¾‹å…±äº« <code>QueryPlanCache</code></p>
</li>
<li><p><code>QueryPlanCache</code> å’Œä¸€çº§ç¼“å­˜å®Œå…¨ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µ</p>
</li>
</ol>
<h3 id="QueryPlanCache-ä¸­-In-æŸ¥è¯¢å¼•å‘çš„å†…å­˜æ³„æ¼é—®é¢˜"><a href="#QueryPlanCache-ä¸­-In-æŸ¥è¯¢å¼•å‘çš„å†…å­˜æ³„æ¼é—®é¢˜" class="headerlink" title="QueryPlanCache ä¸­ In æŸ¥è¯¢å¼•å‘çš„å†…å­˜æ³„æ¼é—®é¢˜"></a>QueryPlanCache ä¸­ In æŸ¥è¯¢å¼•å‘çš„å†…å­˜æ³„æ¼é—®é¢˜</h3><p>åœ¨å®é™…çš„å·¥ä½œä¸­ä½¿ç”¨ JPA çš„æ—¶å€™ï¼Œä¼šå‘ç°å…¶å†…å­˜è¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶ç»™å›æ”¶æ‰ï¼Œç°è±¡å°±æ˜¯<strong>å †å†…å­˜éšç€æ—¶é—´çš„æ¨ç§»ä½¿ç”¨é‡è¶Šæ¥è¶Šå¤§</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¾ˆæ˜æ˜¾æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</p>
<p><img src="http://image.leonote.cn/20210129145136.png" alt=""></p>
<p>è€ŒæŠŠå †æ ˆæ‹¿å‡ºæ¥åˆ†æçš„è¯ä¼šå‘ç°ï¼Œå…¶å®æ˜¯ Hibernate çš„ <code>QueryPlanCache</code> å ç”¨äº†å¤§é‡çš„å†…å­˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129145215.png" alt=""></p>
<h4 id="In-æŸ¥è¯¢æ¡ä»¶å¼•å‘å†…å­˜æ³„æ¼çš„åŸå› "><a href="#In-æŸ¥è¯¢æ¡ä»¶å¼•å‘å†…å­˜æ³„æ¼çš„åŸå› " class="headerlink" title="In æŸ¥è¯¢æ¡ä»¶å¼•å‘å†…å­˜æ³„æ¼çš„åŸå› "></a>In æŸ¥è¯¢æ¡ä»¶å¼•å‘å†…å­˜æ³„æ¼çš„åŸå› </h4><p>åœ¨ <code>UserInfoRepository</code> é‡Œé¢æ–°å¢ä¸€ä¸ª In æ¡ä»¶çš„æŸ¥è¯¢æ–¹æ³•ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹å®é™…å·¥ä½œä¸­çš„ In æŸ¥è¯¢æ¡ä»¶çš„åœºæ™¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//æµ‹è¯•InæŸ¥è¯¢æ¡ä»¶çš„æƒ…å†µ</span></span><br><span class="line"><span class="function">List&lt;UserInfo&gt; <span class="title">findByNameAndUrlIn</span><span class="params">(String name, Collection&lt;String&gt; urls)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æœ‰ä¸ªéœ€æ±‚ï¼ŒæŸ¥è¯¢æ‹¥æœ‰ä¸ªäººåšå®¢åœ°å€çš„ç”¨æˆ·æœ‰å“ªäº›ï¼Ÿ Controller é‡Œé¢æœ‰å¦‚ä¸‹æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">getUserInfos</span><span class="params">(List&lt;String&gt; urls)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//æ ¹æ®urlsæ‰¹é‡æŸ¥è¯¢ï¼Œæ¨¡æ‹Ÿå®é™…å·¥ä½œä¸­çš„æ‰¹é‡æŸ¥è¯¢æƒ…å†µï¼Œå®é™…å·¥ä½œä¸­å¯èƒ½ä¼šæœ‰å¤§é‡çš„æ ¹æ®ä¸åŒçš„IDSæ‰¹é‡æŸ¥è¯¢çš„åœºæ™¯ï¼›</span></span><br><span class="line">  <span class="keyword">return</span> userInfoRepository.findByNameAndUrlIn(<span class="string">&quot;jack&quot;</span>,urls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> debug çœ‹ä¸€ä¸‹ <code>QueryPlanCache</code> é‡Œé¢çš„æƒ…å†µï¼Œä¼šå‘ç°éšç€ In æŸ¥è¯¢æ¡ä»¶çš„ä¸ªæ•°å¢åŠ ï¼Œä¼šç”Ÿæˆä¸åŒçš„ <code>QueryPlanCache</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†åˆ«æ˜¯ 1 ä¸ªå‚æ•°ã€3 ä¸ªå‚æ•°ã€6ä¸ªå‚æ•°çš„æƒ…å†µã€‚</p>
<p><img src="http://image.leonote.cn/20210129145613.png" alt=""></p>
<p>ä»å›¾ä¸­å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸šåŠ¡ä»£ç ä¸­æœ‰å„ç§ In çš„æŸ¥è¯¢æ“ä½œï¼Œä¸åŒçš„æŸ¥è¯¢æ¡ä»¶çš„ä¸ªæ•°è‚¯å®šåœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸­ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œç”šè‡³æœ‰äº›åœºæ™¯èƒ½ä¸€ä¸‹æŸ¥è¯¢åˆ°å‡ ç™¾ä¸ª ID å¯¹åº”çš„æ•°æ®ï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œé‚£å¾—ç”Ÿæˆå¤šå°‘ä¸ª In ç›¸å…³çš„ <code>QueryPlanCache</code> å‘€ã€‚</p>
<p>è€Œä¾æ® <code>QueryPlanCache</code> çš„åŸç†ï¼Œæ•´ä¸ªå·¥ç¨‹éƒ½æ˜¯å•ä¾‹çš„ï¼Œæ”¾è¿›å»ä¹‹åè‚¯å®šä¸ä¼šè¿›è¡Œå†…å­˜åƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œæ—¶é—´ä¹…äº†ä¹‹åå°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç”šè‡³ä¸€æ®µæ—¶é—´ä¹‹åè¿˜ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºçš„ç°è±¡å‘ç”Ÿã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³æ­¤ç±»é—®é¢˜å‘¢ï¼Ÿ</p>
<h4 id="è§£å†³-In-æŸ¥è¯¢æ¡ä»¶å†…å­˜æ³„æ¼çš„æ–¹æ³•"><a href="#è§£å†³-In-æŸ¥è¯¢æ¡ä»¶å†…å­˜æ³„æ¼çš„æ–¹æ³•" class="headerlink" title="è§£å†³ In æŸ¥è¯¢æ¡ä»¶å†…å­˜æ³„æ¼çš„æ–¹æ³•"></a>è§£å†³ In æŸ¥è¯¢æ¡ä»¶å†…å­˜æ³„æ¼çš„æ–¹æ³•</h4><h5 id="ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹ç¼“å­˜çš„æœ€å¤§æ¡æ•°é™åˆ¶"><a href="#ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹ç¼“å­˜çš„æœ€å¤§æ¡æ•°é™åˆ¶" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹ç¼“å­˜çš„æœ€å¤§æ¡æ•°é™åˆ¶"></a>ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹ç¼“å­˜çš„æœ€å¤§æ¡æ•°é™åˆ¶</h5><p>æ­£å¦‚ä¸Šé¢ä»‹ç»çš„ï¼Œé»˜è®¤ DEFAULT_QUERY_PLAN_MAX_COUNT = 2048ï¼Œä¹Ÿå°±æ˜¯ query plan çš„æœ€å¤§æ¡æ•°é™åˆ¶æ˜¯ 2048ã€‚è¿™æ ·é»˜è®¤å€¼å¯èƒ½æœ‰ç‚¹å¤§äº†ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ä¿®æ”¹é»˜è®¤å€¼ï¼Œè¯·çœ‹ä»£ç ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ä¿®æ”¹ é»˜è®¤çš„plan_cache_max_sizeï¼Œå¤ªå°ä¼šå½±å“JPQLçš„æ‰§è¡Œæ€§èƒ½ï¼Œæ‰€ä»¥æ ¹æ®å®é™…æƒ…å†µå¯ä»¥è‡ªç”±è°ƒæ•´ï¼Œä¸å®œå¤ªå°ï¼Œä¹Ÿä¸å®œå¤ªå¤§ï¼Œå¤ªå¤§å¯èƒ½ä¼šå¼•å‘å†…å­˜æº¢å‡º</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.query.plan_cache_max_size</span>=<span class="string">512</span></span><br><span class="line"><span class="comment">#ä¿®æ”¹ é»˜è®¤çš„native queryçš„cacheå¤§å°</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.query.plan_parameter_metadata_max_size</span>=<span class="string">128</span></span><br></pre></td></tr></table></figure>

<h5 id="ç¬¬äºŒç§æ–¹æ³•ï¼šæ ¹æ®-max-plan-count-é€‚å½“å¢åŠ å †å†…å­˜å¤§å°"><a href="#ç¬¬äºŒç§æ–¹æ³•ï¼šæ ¹æ®-max-plan-count-é€‚å½“å¢åŠ å †å†…å­˜å¤§å°" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•ï¼šæ ¹æ® max plan count é€‚å½“å¢åŠ å †å†…å­˜å¤§å°"></a>ç¬¬äºŒç§æ–¹æ³•ï¼šæ ¹æ® max plan count é€‚å½“å¢åŠ å †å†…å­˜å¤§å°</h5><p>å› ä¸º <code>QueryPlanMaxCount</code> æ˜¯æœ‰é™åˆ¶çš„ï¼Œé‚£ä¹ˆè‚¯å®šæœ€å¤§å †å†…å­˜çš„ä½¿ç”¨ä¹Ÿæ˜¯æœ‰å°é¡¶é™åˆ¶çš„ï¼Œæ‰¾åˆ°ä¸´ç•Œå€¼ä¿®æ”¹æœ€å°ã€æœ€å¤§å †å†…å­˜å³å¯ã€‚</p>
<h5 id="ç¬¬ä¸‰ç§æ–¹æ³•ï¼šå‡å°‘-In-çš„æŸ¥è¯¢-SQL-ç”Ÿæˆæ¡æ•°"><a href="#ç¬¬ä¸‰ç§æ–¹æ³•ï¼šå‡å°‘-In-çš„æŸ¥è¯¢-SQL-ç”Ÿæˆæ¡æ•°" class="headerlink" title="ç¬¬ä¸‰ç§æ–¹æ³•ï¼šå‡å°‘ In çš„æŸ¥è¯¢ SQL ç”Ÿæˆæ¡æ•°"></a>ç¬¬ä¸‰ç§æ–¹æ³•ï¼šå‡å°‘ In çš„æŸ¥è¯¢ SQL ç”Ÿæˆæ¡æ•°</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">### é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åŒçš„inæŸ¥è¯¢æ¡ä»¶çš„ä¸ªæ•°ä¼šç”Ÿæˆä¸åŒçš„plan query cacheï¼Œæˆ‘ä»¬å¼€å¯äº†in_clause_parameter_paddingä¹‹åä¼šå‡å°‘inç”Ÿæˆcacheçš„ä¸ªæ•°ï¼Œä¼šæ ¹æ®å‚æ•°çš„æ ¼å¼è¿ç”¨å‡ ä½•çš„ç®—æ³•ç”ŸæˆQueryCacheï¼›</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.query.in_clause_parameter_padding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>å½“ In çš„æ—¶å€™ï¼Œå‚æ•°ä¸ªæ•°ä¼šå¯¹åº”å½’å¹¶ <code>QueryPlanCache</code> å˜æˆ 1ã€2ã€4ã€8ã€16ã€32ã€64ã€128 ä¸ªå‚æ•°çš„ <code>QueryPlanCache</code>ã€‚é‚£ä¹ˆå†çœ‹ä¸€ä¸‹åˆšæ‰å‚æ•°ä¸ªæ•°åˆ†åˆ«åœ¨ 1ã€3ã€4ã€5ã€6ã€7ã€8 ä¸ªçš„æ—¶å€™ç”Ÿæˆ <code>QueryPlanCache</code> çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210129150017.png" alt=""></p>
<p>ä¼šå‘ç°ï¼ŒIn äº§ç”Ÿä¸ªæ•°æ˜¯ 1 ä¸ªçš„æ—¶å€™ï¼Œå®ƒä¼šå…±äº«å‚æ•°ä¸º 1 ä¸ªçš„ <code>QueryPlanCache</code>ï¼›è€Œå½“å‚æ•°æ˜¯ 3ã€4 ä¸ª In å‚æ•°çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šä½¿ç”¨ 4 ä¸ªå‚æ•°çš„ <code>QueryPlanCache</code>ï¼›ä»¥æ­¤ç±»æ¨ï¼Œå½“å‚æ•°æ˜¯ 5ã€6ã€7ã€8 ä¸ªçš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ 8 ä¸ªå‚æ•°çš„ <code>QueryPlanCache</code>â€¦â€¦è¿™ç§ç®—æ³•å¯ä»¥å¤§å¤§åœ°å‡å°‘ In çš„ä¸åŒæŸ¥è¯¢å‚æ•°ç”Ÿæˆçš„ <code>QueryPlanCache</code> ä¸ªæ•°ï¼Œå ç”¨çš„å†…å­˜è‡ªç„¶ä¼šå‡å°‘å¾ˆå¤šã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa Lazy Exception è§£å†³æ–¹æ³•</title>
    <url>/2021/01/12/SpringDataJpa%E7%9A%84LazyException%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-Lazy-Exception-è§£å†³æ–¹æ³•"><a href="#Spring-Data-Jpa-Lazy-Exception-è§£å†³æ–¹æ³•" class="headerlink" title="Spring Data Jpa Lazy Exception è§£å†³æ–¹æ³•"></a>Spring Data Jpa Lazy Exception è§£å†³æ–¹æ³•</h1><h2 id="ä»€ä¹ˆæ˜¯-LazyInitializationException-å¼‚å¸¸"><a href="#ä»€ä¹ˆæ˜¯-LazyInitializationException-å¼‚å¸¸" class="headerlink" title="ä»€ä¹ˆæ˜¯ LazyInitializationException å¼‚å¸¸"></a>ä»€ä¹ˆæ˜¯ LazyInitializationException å¼‚å¸¸</h2><p>é€šè¿‡ 4 ä¸ªæ­¥éª¤çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯ Lazy å¼‚å¸¸</p>
<p>ç¬¬ä¸€æ­¥ï¼šä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼ŒæŠŠ spring.jpa.open-in-view è®¾ç½®æˆ falseï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.jpa.open-in-view</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šæ–°å»ºä¸€ä¸ªä¸€å¯¹å¤šçš„å…³è”å®ä½“ï¼šUserInfo ç”¨æˆ·ä¿¡æ¯ï¼Œä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªåœ°å€ Addressã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="keyword">private</span> String lastName;</span><br><span class="line">   <span class="keyword">private</span> String emailAddress;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="comment">//å‡è®¾ä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªåœ°å€ï¼Œå–æ•°æ®çš„æ–¹å¼ç”¨ lazy çš„æ¨¡å¼(é»˜è®¤ä¹Ÿæ˜¯ lazy çš„)ï¼›é‡‡ç”¨ CascadeType.PERSIST æ–¹ä¾¿æ’å…¥æ¼”ç¤ºæ•°æ®ï¼›</span></span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;, cascade = CascadeType.PERSIST, fetch = FetchType.LAZY)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="comment">//ç»´æŠ¤å…³è”å…³ç³»çš„ä¸€æ–¹ï¼Œé»˜è®¤éƒ½æ˜¯ lazy æ¨¡å¼</span></span><br><span class="line">   <span class="meta">@ManyToOne</span></span><br><span class="line">   <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šå†æ–°å»ºä¸€ä¸ª Controllerï¼Œå–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¹¶ä¸”æŸ¥çœ‹ä¸€ä¸‹ Address çš„åœ°å€ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/info/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoFromPath</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">  UserInfo u1 =  userInfoRepository.findById(id).get();</span><br><span class="line">  <span class="comment">//è§¦å‘ lazy åŠ è½½ï¼Œå– userInfo é‡Œé¢çš„åœ°å€ä¿¡æ¯</span></span><br><span class="line">  System.out.println(u1.getAddressList().get(<span class="number">0</span>).getCity());</span><br><span class="line">  <span class="keyword">return</span> u1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ­¥ï¼šå¯åŠ¨é¡¹ç›®ï¼Œç›´æ¥å‘èµ·å¦‚ä¸‹è¯·æ±‚ï¼š</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line">### get user infoçš„æ¥å£</span><br><span class="line"><span class="keyword">GET</span> <span class="string">/user/info/1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8087</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±å¯ä»¥å¦‚æœŸå¾—åˆ° Lazy å¼‚å¸¸ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList, could not initialize proxy - no Session</span><br><span class="line">   at org.hibernate.collection.internal.AbstractPersistentCollection.throwLazyInitializationException(AbstractPersistentCollection.java:<span class="number">606</span>) ~[<span class="type">hibernate</span>-<span class="type">core</span>-<span class="number">5.4</span><span class="type">.20.Final.jar</span>:<span class="number">5.4</span><span class="type">.20.Final</span>]</span><br><span class="line">   at org.hibernate.collection.internal.AbstractPersistentCollection.withTemporarySessionIfNeeded(AbstractPersistentCollection.java:<span class="number">218</span>) ~[<span class="type">hibernate</span>-<span class="type">core</span>-<span class="number">5.4</span><span class="type">.20.Final.jar</span>:<span class="number">5.4</span><span class="type">.20.Final</span>]</span><br><span class="line">   at org.hibernate.collection.internal.AbstractPersistentCollection.initialize(AbstractPersistentCollection.java:<span class="number">585</span>) ~[<span class="type">hibernate</span>-<span class="type">core</span>-<span class="number">5.4</span><span class="type">.20.Final.jar</span>:<span class="number">5.4</span><span class="type">.20.Final</span>]</span><br><span class="line">   at org.hibernate.collection.internal.AbstractPersistentCollection.read(AbstractPersistentCollection.java:<span class="number">149</span>) ~[<span class="type">hibernate</span>-<span class="type">core</span>-<span class="number">5.4</span><span class="type">.20.Final.jar</span>:<span class="number">5.4</span><span class="type">.20.Final</span>]</span><br><span class="line">   at org.hibernate.collection.internal.PersistentBag.get(PersistentBag.java:<span class="number">561</span>) ~[<span class="type">hibernate</span>-<span class="type">core</span>-<span class="number">5.4</span><span class="type">.20.Final.jar</span>:<span class="number">5.4</span><span class="type">.20.Final</span>]</span><br><span class="line">   at com.example.jpa.demo.web.UserInfoController.getUserInfoFromPath(UserInfoController.java:<span class="number">29</span>) ~[<span class="type">main</span>/:<span class="type">na</span>]</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢çš„å¼‚å¸¸ä¿¡æ¯åŸºæœ¬å¯ä»¥çœ‹åˆ°ï¼Œ UserInfo å®ä½“å¯¹è±¡åŠ è½½ Address çš„æ—¶å€™ï¼Œäº§ç”Ÿäº† Lazy å¼‚å¸¸ï¼Œæ˜¯å› ä¸º no sessionã€‚é‚£ä¹ˆå‘ç”Ÿå¼‚å¸¸çš„æ ¹æœ¬åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒçš„åŠ è½½åŸç†æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</p>
<h2 id="Lazy-åŠ è½½æœºåˆ¶çš„åŸç†åˆ†æ"><a href="#Lazy-åŠ è½½æœºåˆ¶çš„åŸç†åˆ†æ" class="headerlink" title="Lazy åŠ è½½æœºåˆ¶çš„åŸç†åˆ†æ"></a>Lazy åŠ è½½æœºåˆ¶çš„åŸç†åˆ†æ</h2><p>JPA é‡Œæœ‰ Lazy çš„æœºåˆ¶ï¼Œæ‰€è°“çš„ Lazy å°±æ˜¯æŒ‡ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å…³è”å…³ç³»çš„æ—¶å€™ï¼Œåªæœ‰ç”¨åˆ°è¢«å…³è”å…³ç³»çš„ä¸€æ–¹æ‰ä¼šè¯·æ±‚æ•°æ®åº“å»åŠ è½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å…³è”å…³ç³»çš„çœŸå®æ•°æ®ä¸æ˜¯ç«‹é©¬åŠ è½½çš„ï¼Œåªæœ‰ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½ã€‚</p>
<p>è€Œ Hibernate çš„å®ç°æœºåˆ¶ä¸­æä¾›äº† PersistentCollection çš„æœºåˆ¶ï¼Œåˆ©ç”¨ä»£ç†æœºåˆ¶æ”¹å˜äº†å…³è”å…³ç³»çš„é›†åˆç±»å‹ï¼Œä»è€Œå®ç°äº†æ‡’åŠ è½½æœºåˆ¶ã€‚</p>
<h3 id="PersistentCollection-é›†åˆç±»"><a href="#PersistentCollection-é›†åˆç±»" class="headerlink" title="PersistentCollection é›†åˆç±»"></a>PersistentCollection é›†åˆç±»</h3><p>PersistentCollection æ˜¯ä¸€ä¸ªé›†åˆç±»çš„æ¥å£ï¼Œå®ç°ç±»åŒ…æ‹¬å¦‚ä¸‹å‡ ç§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210112100436.png" alt=""></p>
<p>ä¹Ÿå°±æ˜¯è¯´ Hibernate é€šè¿‡ PersistentCollection çš„å®ç°ç±» AbstractPersistentCollection çš„æ‰€æœ‰å­ç±»ï¼Œå¯¹ JDK é‡Œé¢æä¾›çš„ Listã€Mapã€SortMapã€Arrayã€Setã€SortedSet è¿›è¡Œäº†æ‰©å±•ï¼Œä»è€Œå®ç°äº†å…·æœ‰æ‡’åŠ è½½çš„ç‰¹æ€§ã€‚æ‰€ä»¥åœ¨ Hibernate é‡Œé¢æ”¯æŒçš„å…³è”å…³ç³»çš„ç±»å‹åªæœ‰ä¸‹é¢äº”ç§ã€‚</p>
<ul>
<li><p>java.util.List</p>
</li>
<li><p>java.util.Set</p>
</li>
<li><p>java.util.Map</p>
</li>
<li><p>java.util.SortedSet</p>
</li>
<li><p>java.util.SortedMap</p>
</li>
</ul>
<p>å…³äºè¿™å‡ ç§ç±»å‹ï¼ŒHibernate å®˜æ–¹ä¹Ÿæä¾›äº†æ‰©å±• AbstractPersistentCollection çš„æ–¹æ³•ã€‚</p>
<h3 id="PersistentBag-ä¸ºä¾‹è¯¦è§£åŸç†"><a href="#PersistentBag-ä¸ºä¾‹è¯¦è§£åŸç†" class="headerlink" title="PersistentBag ä¸ºä¾‹è¯¦è§£åŸç†"></a>PersistentBag ä¸ºä¾‹è¯¦è§£åŸç†</h3><p>é€šè¿‡ PersistentBag çš„å…³é”®æºç ï¼Œæ¥çœ‹ä¸€ä¸‹é›†åˆç±» List æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//PersistentBag ç»§æ‰¿ AbstractPersistentCollectionï¼Œä»è€Œç»§æ‰¿äº† PersistenceCollection çš„ä¸€äº›å…¬å…±åŠŸèƒ½ã€sessionçš„æŒæœ‰ã€lazyçš„ç‰¹æ€§ã€entityçš„çŠ¶æ€è½¬åŒ–ç­‰åŠŸèƒ½ï¼›åŒæ—¶ PersistentBag ä¹Ÿå®ç°äº† java.util.List çš„æ‰€æœ‰æ–¹æ³•ï¼Œå³å¯¹ List è¿›è¡Œè¯»å†™çš„æ—¶å€™åŒ…è£… lazy é€»è¾‘</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistentBag</span> <span class="keyword">extends</span> <span class="title">AbstractPersistentCollection</span> <span class="keyword">implements</span> <span class="title">List</span> </span>&#123;</span><br><span class="line">    <span class="comment">//PersistentBagæ„é€ æ–¹æ³•ï¼Œå½“åˆå§‹åŒ–å®ä½“å¯¹è±¡å¯¹é›†åˆåˆå§‹åŒ–çš„æ—¶å€™ï¼ŒæŠŠå½“å‰çš„Sessionä¿æŒä½</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersistentBag</span><span class="params">(SessionImplementor session)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>( (SharedSessionContractImplementor) session );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»è¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºæ¥å…¶å¯¹Listå’ŒArrayListçš„æ”¯æŒ</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersistentBag</span><span class="params">(SharedSessionContractImplementor session, Collection coll)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>( session );</span><br><span class="line">       providedCollection = coll;</span><br><span class="line">       <span class="keyword">if</span> ( coll <span class="keyword">instanceof</span> List ) &#123;</span><br><span class="line">          bag = (List) coll;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">          bag = <span class="keyword">new</span> ArrayList( coll );</span><br><span class="line">       &#125;</span><br><span class="line">       setInitialized();</span><br><span class="line">       setDirectlyAccessible( <span class="keyword">true</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®çš„ List çš„å®ç°æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨åŸæœ‰çš„ List åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢åŠ è°ƒç”¨çˆ¶ç±» AbstractPersistentCollection é‡Œé¢çš„ read() å’Œ write() æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">remove</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">       write();</span><br><span class="line">       <span class="keyword">return</span> bag.remove( i );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">set</span><span class="params">(<span class="keyword">int</span> i, Object o)</span> </span>&#123;</span><br><span class="line">       write();</span><br><span class="line">       <span class="keyword">return</span> bag.set( i, o );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">subList</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">       read();</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ListProxy( bag.subList( start, end ) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">entryExists</span><span class="params">(Object entry, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> entry != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// toStringè¢«è°ƒç”¨çš„æ—¶å€™ä¼šè§¦å‘read()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       read();</span><br><span class="line">       <span class="keyword">return</span> bag.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    .....<span class="comment">//å…¶ä»–æ–¹æ³•ç±»ä¼¼ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå†çœ‹ä¸€ä¸‹ AbstractPersistentCollection çš„å…³é”®å®ç°ï¼Œåœ¨ AbstractPersistentCollection ä¸­ä¼šæœ‰å¤§é‡é€šè¿‡ Session æ¥åˆå§‹åŒ–å…³è”å…³ç³»çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åŸºæœ¬æ˜¯åˆ©ç”¨å½“å‰ Session å’Œå½“å‰ Session ä¸­æŒæœ‰çš„ Connection æ¥é‡æ–°æ“ä½œ DBï¼Œä»è€Œå–åˆ°æ•°æ®åº“é‡Œé¢çš„æ•°æ®ã€‚</p>
<p>æ‰€ä»¥ LazyInitializationExcetion åŸºæœ¬éƒ½æ˜¯ä»è¿™ä¸ªç±»é‡Œé¢æŠ›å‡ºæ¥çš„ï¼Œä»æºç é‡Œé¢å¯ä»¥çœ‹åˆ°å…¶ä¸¥é‡ä¾èµ–å½“å‰çš„ Sessionï¼Œå…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210112102325.png" alt=""></p>
<p>æ‰€ä»¥åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŠŠ Session å…³é—­äº†ï¼Œæƒ³åˆ©ç”¨ Lazy çš„æœºåˆ¶åŠ è½½ç®¡ç†å…³ç³»ï¼Œå°±ä¼šå‘ç”Ÿå¼‚å¸¸äº†ã€‚é€šè¿‡å®ä¾‹çœ‹ä¸€ä¸‹ï¼Œåœ¨ä¸Šé¢ä¾‹å­çš„ Controller ä¸ŠåŠ ä¸€ä¸ª debug æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ˜¾ç¤ºçš„å†…å®¹ï¼šæˆ‘ä»¬çš„ Address æŒ‡å‘äº† PersistentBag ä»£ç†å®ä¾‹ç±»ã€‚</p>
<p><img src="http://image.leonote.cn/20210112103341.png" alt=""></p>
<p>åŒæ—¶å†è®¾ç½®æ–­ç‚¹çš„è¯ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒPersistentBag è¢«åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šä¼ è¿›æ¥ Session çš„ä¸Šä¸‹æ–‡ï¼Œå³åŒ…å« Datasource å’Œéœ€è¦æ‰§è¡Œ Lazy çš„ sqlã€‚</p>
<p>è€Œéœ€è¦æ‰§è¡Œ Lazy çš„ sqlï¼Œé€šè¿‡ debug çš„æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸ª instantiateï¼Œå…³é”®æ–­ç‚¹ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20210112103519.png" alt=""></p>
<p>å†ç»§ç»­ debug çš„è¯ï¼Œä¹Ÿä¼šçœ‹åˆ°è°ƒç”¨ AbstractPersistentCollection çš„åˆå§‹åŒ– Lazy çš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210112103612.png" alt=""></p>
<p>é€šè¿‡æºç åˆ†æå’Œå®ä¾‹è®²è§£ï¼Œå·²ç»åŸºæœ¬ä¸ŠçŸ¥é“äº† Lazy çš„åŸç†ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ Lazy çš„å…³è”å…³ç³»ä¼šåˆå§‹åŒ–æˆ PersistentCollectionï¼Œå¹¶ä¸”ä¾èµ–æŒæœ‰çš„ Sessionã€‚è€Œå½“æ“ä½œ Listã€Map ç­‰é›†åˆç±»çš„ä¸€äº›åŸºæœ¬æ–¹æ³•çš„æ—¶å€™ä¼šè§¦å‘ read()ï¼Œå¹¶åˆ©ç”¨å½“å‰çš„ Session è¿›è¡Œæ‡’åŠ è½½ã€‚</p>
<h2 id="Lazy-å¼‚å¸¸çš„å¸¸è§åœºæ™¯ä¸è§£å†³æ–¹æ³•"><a href="#Lazy-å¼‚å¸¸çš„å¸¸è§åœºæ™¯ä¸è§£å†³æ–¹æ³•" class="headerlink" title="Lazy å¼‚å¸¸çš„å¸¸è§åœºæ™¯ä¸è§£å†³æ–¹æ³•"></a>Lazy å¼‚å¸¸çš„å¸¸è§åœºæ™¯ä¸è§£å†³æ–¹æ³•</h2><h3 id="åœºæ™¯ä¸€ï¼šè·¨äº‹åŠ¡ï¼Œäº‹åŠ¡ä¹‹å¤–çš„åœºæ™¯"><a href="#åœºæ™¯ä¸€ï¼šè·¨äº‹åŠ¡ï¼Œäº‹åŠ¡ä¹‹å¤–çš„åœºæ™¯" class="headerlink" title="åœºæ™¯ä¸€ï¼šè·¨äº‹åŠ¡ï¼Œäº‹åŠ¡ä¹‹å¤–çš„åœºæ™¯"></a>åœºæ™¯ä¸€ï¼šè·¨äº‹åŠ¡ï¼Œäº‹åŠ¡ä¹‹å¤–çš„åœºæ™¯</h3><p> å½“ spring.jpa.open-in-view=false çš„æ—¶å€™ï¼Œæ¯ä¸ªäº‹åŠ¡å°±ä¼šç‹¬ç«‹æŒæœ‰ Sessionï¼›é‚£ä¹ˆåœ¨äº‹åŠ¡ä¹‹å¤–æ“ä½œ lazy çš„å…³è”å…³ç³»çš„æ—¶å€™ï¼Œå°±å®¹æ˜“å‘ç”Ÿ Lazy å¼‚å¸¸ã€‚</p>
<p>æ­£å¦‚ä¸Šé¢åˆ—ä¸¾çš„ Demo ä¸€æ ·ï¼Œä¸€å¼€å§‹å°±å°† open-in-view è®¾ç½®æˆäº† falseï¼Œè€Œ userInfoRepository.findById(id) åˆæ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼Œæ–¹æ³•æ“ä½œç»“æŸä¹‹åäº‹åŠ¡ç»“æŸï¼Œäº‹åŠ¡ç»“æŸä¹‹å session closeã€‚æ‰€ä»¥å†æ“ä½œ UserInfo ä¸­ Address å¯¹è±¡çš„æ—¶å€™ï¼Œå°±å‘ç”Ÿäº† Lazy å¼‚å¸¸ã€‚</p>
<p>å®é™…å·¥ä½œä¸­è¿™ç§æƒ…å†µæ¯”è¾ƒå¤šè§ï¼Œåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p><strong>ç¬¬ä¸€ç§æ–¹å¼ï¼šç®€å•ç²—æš´åœ°è®¾ç½®ä¸º spring.jpa.open-in-view=true</strong></p>
<p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯ä»¥çŸ¥é“æ— éå°±æ˜¯ Session çš„å…³é—­å¯¼è‡´äº† Lazy å¼‚å¸¸ï¼Œæ‰€ä»¥ç®€å•ç²—æš´çš„åŠæ³•å°±æ˜¯åŠ å¤§ Session çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°† Session çš„ç”Ÿå‘½å‘¨æœŸå’Œè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸè®¾ç½®æˆä¸€æ ·ã€‚ä½†æ˜¯ open-in-view å¯èƒ½ä¼šå¸¦æ¥çš„å‰¯ä½œç”¨å¿…é¡»è¦ç‰¢è®°äºå¿ƒï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ã€‚</p>
<ol>
<li><p>å®ƒå¯¹ Connection çš„å½±å“æ˜¯ä»€ä¹ˆï¼Ÿè¿æ¥æ± æœ‰æ²¡æœ‰å¾ˆå¥½åœ°ç›‘æ§ï¼Ÿåˆ©ç”¨ç‡æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p>
</li>
<li><p>å®ä½“çš„çŠ¶æ€åœ¨æ•´ä¸ª Session çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„å˜æ›´éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œæ•°æ®çš„æ›´æ–°æ˜¯ä¸æ˜¯é¢„æœŸçš„ï¼Œä½ è¦å¿ƒé‡Œæœ‰æ•°ã€‚</p>
</li>
<li><p>N+1 çš„ SQL æ˜¯ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ï¼Ÿï¼ˆè¿™ä¸ªä¸‹ä¸€è®²æˆ‘ä¼šè¯¦ç»†ä»‹ç»ï¼‰æ€§èƒ½æœ‰æ²¡æœ‰å½±å“ï¼Ÿç­‰ç­‰ã€‚</p>
</li>
</ol>
<p><strong>ç¬¬äºŒç§æ–¹å¼ï¼šä¹Ÿæ˜¯ç®€å•ç²—æš´æ”¹æˆ Eager æ¨¡å¼</strong></p>
<p>ç›´æ¥é‡‡ç”¨ Eager çš„æ¨¡å¼ï¼Œè¿™æ ·ä¹Ÿä¸ä¼šæœ‰ Lazy å¼‚å¸¸çš„é—®é¢˜ã€‚å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="comment">//ç›´æ¥é‡‡ç”¨eageræ¨¡å¼</span></span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,cascade = CascadeType.PERSIST,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ç§åšæ³•ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºæœ¬æ¥ä¸æƒ³æŸ¥ Address ä¿¡æ¯ï¼Œè¿™æ ·ä¼šç™½ç™½åœ°è§¦å‘å¯¹ Address çš„æŸ¥è¯¢ï¼Œå¯¼è‡´æ€§èƒ½æœ‰ç‚¹æµªè´¹ã€‚</p>
<p><strong>ç¬¬ä¸‰ç§æ–¹å¼ï¼šå°†å¯èƒ½å‘ç”Ÿ Lazy çš„æ“ä½œå’Œå–æ•°æ®æ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢</strong></p>
<p>æ”¹é€ ä¸€ä¸‹ä¸Šé¢ Demo çš„ Controller çš„å†™æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoController</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">   <span class="meta">@GetMapping(&quot;/user/info/&#123;id&#125;&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoFromPath</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//controller é‡Œé¢æ”¹è°ƒç”¨ service æ–¹æ³•ï¼Œè¿™ä¸ª service æ˜ç¡®åœ°è¿”å›äº† UserInfo å’Œ Address ä¿¡æ¯</span></span><br><span class="line">      UserInfo u1 =  userInfoService.getUserInfoAndAddress(id);</span><br><span class="line">      System.out.println(u1.getAddressList().get(<span class="number">0</span>).getCity());</span><br><span class="line">      <span class="keyword">return</span> u1;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>Service çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨é‡Œé¢ç”¨äº‹åŠ¡åŒ…è£…ï¼Œåˆ©ç”¨äº‹åŠ¡ï¼Œè®©å¯èƒ½è§¦å‘ Lazy çš„æ“ä½œæå‰åœ¨äº‹åŠ¡é‡Œé¢å‘ç”Ÿã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŠŠé€»è¾‘å°è£…åœ¨serviceæ–¹æ³•é‡Œé¢ï¼Œæ–¹æ³•åå­—è¯­ä¹‰è¦æ¸…æ™°ï¼Œå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ³•ä¼šå–UserInfoçš„ä¿¡æ¯å’ŒAddressçš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoAndAddress</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">   UserInfo u1 =  userInfoRepository.findById(id).get();</span><br><span class="line">   u1.getAddressList().size();<span class="comment">//åœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢è§¦å‘lazyï¼›ä¸éœ€è¦æŸ¥è¯¢addressçš„åœ°æ–¹å°±ä¸éœ€è¦è§¦å‘äº†</span></span><br><span class="line">   <span class="keyword">return</span> u1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™å°±è¦æ±‚å¯¹æ–¹æ³•åçš„è¯­ä¹‰å’Œæ³¨é‡Šæ¯”è¾ƒæ¸…æ™°äº†ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ Service è¿”å›çš„ä¾ç„¶è¿˜æ˜¯ UserInfo çš„å®ä½“ï¼Œå¦‚æœåœ¨å…³è”å…³ç³»å¤šçš„æƒ…å†µä¸‹ï¼Œä¾ç„¶æœ‰çŠ¯é”™çš„å¯èƒ½æ€§å‘ç”Ÿã€‚</p>
<p><strong>ç¬¬å››ç§æ–¹å¼ï¼šService å±‚ä¹‹å¤–éƒ½ç”¨ DTO æˆ–è€…å…¶ä»– POJOï¼Œè€Œä¸æ˜¯ Entity</strong></p>
<p>è¿™ç§æ˜¯æœ€å¤æ‚çš„ï¼Œä½†å´æ˜¯æœ€æœ‰æ•ˆçš„ã€ä¸ä¼šå‡ºé—®é¢˜çš„æ–¹å¼ï¼Œåœ¨ Service å±‚è¿”å› DTOï¼Œæ”¹é€ ä¸€ä¸‹ Service æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfoDto <span class="title">getUserInfoAndAddress</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">   UserInfo u1 =  userInfoRepository.findById(id).get();</span><br><span class="line">   <span class="comment">//æŒ‰ç…§ä¸šåŠ¡è¦æ±‚ï¼Œéœ€è¦ä»€ä¹ˆè¿”å›ä»€ä¹ˆå°±å¯ä»¥äº†ï¼Œè®©å®ä½“åœ¨serviceå±‚ä¹‹å¤–æ˜¯ä¸å¯è§çš„</span></span><br><span class="line">   <span class="keyword">return</span> UserInfoDto.builder().name(u1.getName()).addressList(u1.getAddressList()).build();/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ UserInfoDto ä¹Ÿå°±æ˜¯æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ›å»ºä¸åŒçš„ DTO å³å¯ã€‚ä¾‹å¦‚ï¼Œåªéœ€è¦ name å’Œ address çš„æ—¶å€™ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº† DTO è¿˜å¯ä»¥é‡‡ç”¨ä»»ä½•è¯­ä¹‰çš„ POJOï¼Œ<strong><em>å®—æ—¨å°±æ˜¯ Entity å¯¹ Service å±‚ä¹‹å¤–æ˜¯ä¸å¯è§çš„</em></strong>ã€‚ä¹Ÿå¯ä»¥é‡‡ç”¨ Projection çš„æ–¹å¼ï¼Œè¿”å›æ¥å£ç±»å‹çš„ POJOï¼Œè¿™æ ·æ§åˆ¶çš„ç²’åº¦æ›´ç»†ï¼Œè¯»å†™éƒ½å¯ä»¥åˆ†å¼€ã€‚å°† Entity æ§åˆ¶åœ¨ Service å±‚è¿˜æœ‰ä¸ªå¥½å¤„å°±æ˜¯ï¼Œæœ‰çš„æ—¶å€™ä¼šä½¿ç”¨å„ç§ RPC æ¡†æ¶è¿›è¡Œè¿œç¨‹æ–¹æ³•è°ƒåº¦ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ Service æ–¹æ³•é€šè¿‡ TCP åè®®ï¼Œä¾‹å¦‚ Dubboï¼Œè¿™æ ·ä¹Ÿå°±å¤©ç„¶æ”¯æŒäº†ã€‚</p>
<h3 id="åœºæ™¯äºŒï¼šå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™"><a href="#åœºæ™¯äºŒï¼šå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™" class="headerlink" title="åœºæ™¯äºŒï¼šå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™"></a>åœºæ™¯äºŒï¼šå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™</h3><p>æ—¢ç„¶è·¨äº‹åŠ¡å®¹æ˜“å‘ç”Ÿé—®é¢˜ï¼Œé‚£ä¹ˆå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™æ›´å®¹æ˜“å‘ç”Ÿ Lazy å¼‚å¸¸</p>
<p>å¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™ï¼Œå†å¥—ç”¨ä¸Šé¢çš„å››ç§æ–¹å¼ï¼Œä¼šå‘ç°ç¬¬ä¸€ç§æ–¹å¼å°±ä¸é€‚ç”¨äº†ï¼Œå› ä¸ºå¼‚æ­¥å¼€å¯çš„äº‹åŠ¡å’Œ DB æ“ä½œé»˜è®¤æ˜¯ä¸å— open-in-view æ§åˆ¶çš„ã€‚æ‰€ä»¥å¯ä»¥æ˜ç¡®åœ°çŸ¥é“ï¼Œå¼€å¯çš„å¼‚æ­¥æ–¹æ³•ä¼šç”¨åˆ°å®ä½“å‚æ•°çš„å“ªäº›å…³è”å…³ç³»ï¼Œæ˜¯å¦éœ€è¦æŒ‰ç…§ä¸Šé¢çš„ç¬¬ä¸‰ç§å’Œç¬¬å››ç§æ–¹å¼è¿›è¡Œæå‰å¤„ç†å‘¢ï¼Ÿè¿™äº›éƒ½æ˜¯éœ€è¦å¿ƒä¸­æœ‰æ•°çš„ï¼Œè€Œä¸æ˜¯ç®€å•åœ°æŠŠå¼‚æ­¥å¼€å¯å°±å®Œäº‹äº†ã€‚</p>
<h3 id="åœºæ™¯ä¸‰ï¼šController-ç›´æ¥è¿”å›å®ä½“ä¹Ÿä¼šäº§ç”Ÿ-Lazy-Exception"><a href="#åœºæ™¯ä¸‰ï¼šController-ç›´æ¥è¿”å›å®ä½“ä¹Ÿä¼šäº§ç”Ÿ-Lazy-Exception" class="headerlink" title="åœºæ™¯ä¸‰ï¼šController ç›´æ¥è¿”å›å®ä½“ä¹Ÿä¼šäº§ç”Ÿ Lazy Exception"></a>åœºæ™¯ä¸‰ï¼šController ç›´æ¥è¿”å›å®ä½“ä¹Ÿä¼šäº§ç”Ÿ Lazy Exception</h3><p>å·¥ä½œä¸­ç»å¸¸ä¸ºäº†çœäº‹ï¼Œç›´æ¥åœ¨ Contoller é‡Œé¢è¿”å› Entityï¼Œè¿™ä¸ªæ—¶å€™å¾ˆå®¹æ˜“å‘ç”Ÿ Lazy å¼‚å¸¸ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªåœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/info/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoFromPath</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> userInfoRepository.findById(id).get();<span class="comment">//controller å±‚ç›´æ¥å°† UserInfo è¿”å›ç»™ view å±‚äº†ï¼›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥å°† UserInfo å®ä½“å¯¹è±¡å½“æˆ VO å¯¹è±¡ï¼Œä¸”ç›´æ¥å½“æˆè¿”å›ç»“æœäº†ï¼Œå½“è¯·æ±‚ä¸Šé¢çš„ API çš„æ—¶å€™ä¹Ÿä¼šå‘ç”Ÿ Lazy å¼‚å¸¸ï¼Œçœ‹ä¸‹ä»£ç ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">o.hibernate.LazyInitializationException  : failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList, could not initialize proxy - no Session</span><br><span class="line">   org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList, could not initialize proxy - no Session</span><br></pre></td></tr></table></figure>

<p>æ­¤ VO å‘ç”Ÿçš„å¼‚å¸¸ä¸å…¶ä»– Lazy å¼‚å¸¸ä¸åŒçš„æ—¶å€™ï¼Œä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘ç°å¦‚ä¸‹ä¿¡æ¯ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Â Resolved [<span class="type">org.springframework.http.converter.HttpMessageNotWritableException</span>: <span class="type">Could</span> <span class="type">not</span> <span class="type">write</span> <span class="type">JSON</span>:Â Â <span class="type">failed</span> <span class="type">to</span> <span class="type">lazily</span> <span class="type">initialize</span> <span class="type">a</span> <span class="type">collection</span> <span class="type">of</span> <span class="type">role</span>: <span class="type">com.example.jpa.demo.db.UserInfo.addressList</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ—¥å¿—å¯ä»¥çŸ¥é“ï¼Œæ­¤æ—¶å‘ç”Ÿ Lazy å¼‚å¸¸çš„ä¸»è¦åŸå› æ˜¯ JSON ç³»åˆ—åŒ–çš„æ—¶å€™ä¼šè§¦å‘ Lazy åŠ è½½ã€‚è¿™ä¸ªæ—¶å€™å°±æœ‰äº†<strong>ç¬¬äº”ç§è§£å†³ Lazy å¼‚å¸¸çš„æ–¹å¼ï¼Œå°±æ˜¯åˆ©ç”¨ @JsonIgnoreProperties(â€œaddressListâ€) æ’é™¤æˆ‘ä»¬ä¸æƒ³åºåˆ—åŒ–çš„å±æ€§å³å¯ã€‚</strong></p>
<p>ä½†æ˜¯è¿™ç§æ–¹å¼çš„å¼Šç«¯æ˜¯ç”¨è¿™ä¸ªé›†åˆçš„åªèƒ½å…¨å±€é…ç½®ï¼Œæ²¡åŠæ³•æœ‰ç‰¹ä¾‹é…ç½®ã€‚å› æ­¤æœ€ä½³å®è·µè¿˜æ˜¯é‡‡ç”¨ä¸Šé¢æ‰€è¯´çš„ç¬¬ä¸€ç§æ–¹å¼å’Œç¬¬å››ç§æ–¹å¼ã€‚</p>
<h3 id="åœºæ™¯å››ï¼šè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å’Œ-filter-ä¸­æ— æ„çš„-toString-æ“ä½œ"><a href="#åœºæ™¯å››ï¼šè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å’Œ-filter-ä¸­æ— æ„çš„-toString-æ“ä½œ" class="headerlink" title="åœºæ™¯å››ï¼šè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å’Œ filter ä¸­æ— æ„çš„ toString æ“ä½œ"></a>åœºæ™¯å››ï¼šè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å’Œ filter ä¸­æ— æ„çš„ toString æ“ä½œ</h3><p>ç¬¬å››ä¸ª Lazy å¼‚å¸¸çš„åœºæ™¯å°±æ˜¯æ‰“å°ä¸€äº›æ—¥å¿—ï¼Œæˆ–è€…æ— æ„é—´è§¦å‘ toString çš„æ“ä½œä¹Ÿä¼šå‘ç”Ÿ Lazy å¼‚å¸¸ï¼Œè¿™ç§å¤„ç†æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ˆ<strong>ç¬¬å…­ç§å¤„ç† Lazy å¼‚å¸¸çš„æ–¹å¼ï¼‰ï¼štoString é‡Œé¢æ’é™¤æ‰ä¸éœ€è¦ Lazy åŠ è½½çš„å…³è”å…³ç³»å³å¯ã€‚</strong>å¦‚æœæˆ‘ä»¬ç”¨ lombok çš„è¯ï¼Œç›´æ¥ @ToString(exclude = â€œaddressListâ€) æ’é™¤æ‰å°±å¥½äº†ï¼Œå®Œæ•´ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ToString(exclude = &quot;addressList&quot;)</span></span><br><span class="line"><span class="meta">@JsonIgnoreProperties(&quot;addressList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">......&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šä»‹ç»çš„å››ä¸ª Lazy å¼‚å¸¸çš„åœºæ™¯å’Œå…­ç§å¤„ç†æ–¹å¼ï¼Œåœ¨å®é™…å·¥ä½œä¸­å¯ä»¥çµæ´»è¿ç”¨ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯è¦çŸ¥é“èƒŒåçš„åŸç†å’Œè§¦å‘ Lazy äº§ç”Ÿçš„æ€§èƒ½å½±å“æ˜¯ä»€ä¹ˆï¼ˆæ„å¤–çš„ SQL æ‰§è¡Œï¼‰ã€‚</p>
<p>Hibernate å®˜æ–¹è¿˜æä¾›äº†<strong>ç¬¬ä¸ƒç§å¤„ç† Lazy å¼‚å¸¸çš„æ–¹å¼ï¼šåˆ©ç”¨ Hibernate çš„é…ç½®</strong></p>
<p><strong>hibernate.enable_lazy_load_no_trans é…ç½®</strong></p>
<p>Hibernate å®˜æ–¹æä¾›äº† hibernate.enable_lazy_load_no_trans é…ç½®ï¼Œæ˜¯å¦å…è®¸åœ¨å…³é—­ä¹‹åä¾ç„¶æ”¯æŒ Lazy åŠ è½½ï¼Œæ­¤é JPA æ ‡å‡†ï¼Œæ‰€ä»¥åœ¨ç”¨çš„æ—¶å€™éœ€è¦å…³æ³¨ç‰ˆæœ¬å˜åŒ–ã€‚</p>
<p>å…¶ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥åœ¨ application.properties é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®å³å¯ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## è¿è¡Œåœ¨sessionå…³é—­ä¹‹åï¼Œé‡æ–°lazyæ“ä½œ</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.enable_lazy_load_no_trans</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ä¸éœ€è¦åšä»»ä½•å…¶ä»–ä¿®æ”¹ï¼Œå½“åœ¨äº‹åŠ¡ä¹‹å¤–ï¼Œç”šè‡³æ˜¯ Session ä¹‹å¤–ï¼Œè§¦å‘ Lazy æ“ä½œçš„æ—¶å€™ä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œä¹Ÿä¼šæ­£å¸¸åœ°è¿›è¡Œå–æ•°æ®ã€‚</p>
<p>ä½†æ˜¯å»ºè®®ä¸è¦ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºä¸€æ—¦å¼€å¯äº†è¿™ä¸ªå¯¹ Lazy çš„æ“ä½œå°±ä¸å¯æ§äº†ï¼Œä¼šå‘ç”Ÿé¢„æœŸä¹‹å¤–çš„ Lazy å¼‚å¸¸ï¼Œç„¶ååªèƒ½é€šè¿‡ä¸Šé¢æ‰€è¯´çš„å¤„ç† Lazy å¼‚å¸¸çš„ç¬¬ä¸‰ç§å’Œç¬¬å››ç§æ–¹å¼è§£å†³æˆé¢„æœŸä¹‹å†…çš„ï¼Œå¦åˆ™çš„è¯ï¼Œè¿˜ä¼šå¸¦æ¥å¾ˆå¤šé¢„æœŸä¹‹å¤–çš„ SQL æ‰§è¡Œã€‚è¿™å°±ä¼šé€ æˆä¸€ç§è¯¯è§£ï¼Œå³ä½¿ç”¨ Hibernate æˆ–è€… JPA ä¼šå¯¼è‡´æ€§èƒ½å˜å·®ï¼Œå…¶å®æœ¬è´¨åŸå› æ˜¯ä¸äº†è§£åŸç†ï¼Œæ²¡èƒ½æ­£ç¡®ä½¿ç”¨ã€‚</p>
<p>æ‰€ä»¥åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSpring Data JPA ä¸­ï¼Œhibernate.enable_lazy_load_no_trans é»˜è®¤æ˜¯ falseï¼Œè¿™å’Œ spring.jpa.open-in-view é»˜è®¤æ˜¯ true æ˜¯ç›¸åŒçš„é“ç†ã€‚æ‰€ä»¥å¦‚æœéƒ½é‡‡ç”¨ Spring Boot çš„é»˜è®¤é…ç½®ï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼›è€Œæœ‰çš„æ—¶å€™ä¸ºäº†æ›´ä¼˜çš„é…ç½®ï¼Œéœ€è¦çŸ¥é“åº•å±‚çš„åŸç†ï¼Œè¿™æ ·æ‰èƒ½åˆ¤æ–­å‡ºæ¥ä¸šåŠ¡åœºæ™¯çš„æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆã€‚</p>
<h2 id="Javax-persistence-PersistenceException-å¼‚å¸¸ç±»å‹"><a href="#Javax-persistence-PersistenceException-å¼‚å¸¸ç±»å‹" class="headerlink" title="Javax.persistence.PersistenceException å¼‚å¸¸ç±»å‹"></a>Javax.persistence.PersistenceException å¼‚å¸¸ç±»å‹</h2><p>é¡ºè—¤æ‘¸ç“œï¼Œå¯ä»¥çœ‹åˆ° LazyInitializationException æ˜¯ HibernateException é‡Œé¢çš„ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ° HibernateException çš„çˆ¶ç±» Javax.persistence.PersistenceException ä¸‹é¢æœ‰å¾ˆå¤šç»†åˆ†çš„å¼‚å¸¸ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210112110903.png" alt=""></p>
<p>å½“æˆ‘ä»¬é‡åˆ°å¼‚å¸¸çš„æ—¶å€™ä¸è¦æ…Œå¼ ï¼Œä»”ç»†çœ‹æ—¥å¿—åŸºæœ¬å°±èƒ½çŸ¥é“æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼Œä¸åŒçš„å¼‚å¸¸æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚ OptimisticLockException å°±éœ€è¦è¿›è¡Œé‡è¯•ï¼›è€Œé’ˆå¯¹ NoSuchBeanException çš„å¼‚å¸¸ï¼Œå°±è¦æ£€æŸ¥å®ä½“é…ç½®æ˜¯å¦å¦¥å½“ï¼Œé‡åˆ°å®é™…æƒ…å†µå†å®é™…åˆ†æå³å¯ã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa Persistence Context æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µ</title>
    <url>/2020/11/05/SpringDataJpa%E7%9A%84PersistenceContext%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/</url>
    <content><![CDATA[<h1 id="Persistence-Context-æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µ"><a href="#Persistence-Context-æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Persistence Context æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µ"></a>Persistence Context æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="EntityManagerFactory-å’Œ-Persistence-Unit-æ˜¯ä»€ä¹ˆ"><a href="#EntityManagerFactory-å’Œ-Persistence-Unit-æ˜¯ä»€ä¹ˆ" class="headerlink" title="EntityManagerFactory å’Œ Persistence Unit æ˜¯ä»€ä¹ˆ"></a>EntityManagerFactory å’Œ Persistence Unit æ˜¯ä»€ä¹ˆ</h2><p>æŒ‰ç…§ JPA åè®®é‡Œé¢çš„å®šä¹‰ï¼špersistence unit <strong><em>æ˜¯ä¸€äº›æŒä¹…åŒ–é…ç½®çš„é›†åˆï¼Œé‡Œé¢åŒ…å«äº†æ•°æ®æºçš„é…ç½®ã€EntityManagerFactory çš„é…ç½®</em></strong>ï¼ŒSpring 3.1 ä¹‹å‰ä¸»è¦æ˜¯é€šè¿‡ persistence.xml çš„æ–¹å¼æ¥é…ç½®ä¸€ä¸ª persistence unitï¼Œè€Œ Spring 3.1 ä¹‹åå·²ç»ä¸å†æ¨èè¿™ç§æ–¹å¼äº†ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† persistence unit çš„æ¦‚å¿µï¼Œåªéœ€è¦åœ¨é…ç½® <code>LocalContainerEntityManagerFactory</code> çš„æ—¶å€™ï¼ŒæŒ‡å®š persistence unit çš„åå­—å³å¯ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;db2EntityManagerFactory&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactory</span><span class="params">(EntityManagerFactoryBuilder builder, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                                   <span class="meta">@Qualifier(&quot;db2DataSource&quot;)</span> DataSource db2DataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.dataSource(db2DataSource)</span><br><span class="line">            .packages(<span class="string">&quot;com.example.jpa.example1.db2&quot;</span>) <span class="comment">//æ•°æ®2çš„å®ä½“æ‰€åœ¨çš„è·¯å¾„</span></span><br><span class="line">            .persistenceUnit(<span class="string">&quot;db2&quot;</span>)<span class="comment">// persistenceUnitçš„åå­—é‡‡ç”¨db2</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EntityManagerFactory çš„ç”¨é€”å°±æ¯”è¾ƒæ˜æ˜¾äº†ï¼Œå³æ ¹æ®ä¸åŒçš„æ•°æ®æºï¼Œæ¥ç®¡ç† Entity å’Œåˆ›å»º EntityMangerï¼Œåœ¨æ•´ä¸ª application çš„ç”Ÿå‘½å‘¨æœŸä¸­æ˜¯å•ä¾‹çŠ¶æ€ã€‚æ‰€ä»¥åœ¨ spring çš„ application é‡Œé¢è·å¾— EntityManagerFactory æœ‰ä¸¤ç§æ–¹å¼ã€‚</p>
<p><strong>ç¬¬ä¸€ç§ï¼šé€šè¿‡ Spring çš„ Bean çš„æ–¹å¼æ³¨å…¥ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier(value=&quot;db2EntityManagerFactory&quot;)</span> </span><br><span class="line"><span class="keyword">private</span> EntityManagerFactory entityManagerFactory;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹å¼æ˜¯æ¯”è¾ƒæ¨èçš„ï¼Œå®ƒåˆ©ç”¨äº† Spring è‡ªèº«çš„ Bean çš„ç®¡ç†æœºåˆ¶ã€‚</p>
<p><strong>ç¬¬äºŒç§ï¼šåˆ©ç”¨ java.persistence.PersistenceUnit æ³¨è§£çš„æ–¹å¼è·å–ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PersistenceUnit(&quot;db2&quot;)</span></span><br><span class="line"><span class="keyword">private</span> EntityManagerFactory entityManagerFactory;</span><br></pre></td></tr></table></figure>

<h2 id="EntityManager-å’Œ-PersistenceContext-æ˜¯ä»€ä¹ˆ"><a href="#EntityManager-å’Œ-PersistenceContext-æ˜¯ä»€ä¹ˆ" class="headerlink" title="EntityManager å’Œ PersistenceContext æ˜¯ä»€ä¹ˆ"></a>EntityManager å’Œ PersistenceContext æ˜¯ä»€ä¹ˆ</h2><p>æŒ‰ç…§ JPA åè®®çš„è§„èŒƒï¼ŒPersistenceContext æ˜¯ç”¨æ¥ç®¡ç†ä¼šè¯é‡Œé¢çš„ Entity çŠ¶æ€çš„ä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä½¿ Entity çš„å®ä¾‹æœ‰äº†ä¸åŒçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å®ä½“å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>è€Œè¿™äº›å®ä½“åœ¨ PersistenceContext ä¸­çš„ä¸åŒçŠ¶æ€éƒ½æ˜¯é€šè¿‡ EntityManager æä¾›çš„ä¸€äº›æ–¹æ³•è¿›è¡Œç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ol>
<li><p>PersistenceContext æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œæ˜¯ JPA åè®®å®šä¹‰çš„ï¼Œè€Œ Hibernate çš„å®ç°æ˜¯é€šè¿‡ Session åˆ›å»ºå’Œé”€æ¯çš„ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>ä¸€ä¸ª Session æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª PersistenceContext</strong>ï¼›</p>
</li>
<li><p>PersistenceContext æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œé‡Œé¢ç®¡ç†çš„æ˜¯ Entity çš„çŠ¶æ€ï¼›</p>
</li>
<li><p><strong>EntityManager æ˜¯é€šè¿‡ PersistenceContext åˆ›å»ºçš„</strong>ï¼Œç”¨æ¥ç®¡ç† PersistenceContext ä¸­ Entity çŠ¶æ€çš„æ–¹æ³•ï¼Œç¦»å¼€ PersistenceContext æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ŒEntityManager æ²¡æœ‰æ„ä¹‰ï¼›</p>
</li>
<li><p><strong>EntityManger æ˜¯æ“ä½œå¯¹è±¡çš„å”¯ä¸€å…¥å£ï¼Œä¸€ä¸ªè¯·æ±‚é‡Œé¢å¯èƒ½ä¼šæœ‰å¤šä¸ª EntityManger å¯¹è±¡</strong>ã€‚</p>
</li>
</ol>
<p>çœ‹ä¸€ä¸‹ PersistenceContext æ˜¯æ€ä¹ˆåˆ›å»ºçš„ã€‚ç›´æ¥æ‰“å¼€ SessionImpl çš„æ„é€ æ–¹æ³•ï¼Œå°±å¯ä»¥çŸ¥é“ PersistenceContext æ˜¯å’Œ Session çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//sessionå®ä¾‹åˆå§‹åŒ–çš„å…¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SessionImpl</span><span class="params">(SessionFactoryImpl factory, SessionCreationOptions options)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>( factory, options );</span><br><span class="line">   <span class="comment">//Sessioné‡Œé¢åˆ›å»ºäº†persistenceContextï¼Œæ¯æ¬¡sessionéƒ½æ˜¯æ–°å¯¹è±¡</span></span><br><span class="line">   <span class="keyword">this</span>.persistenceContext = createPersistenceContext();</span><br><span class="line"><span class="comment">// ......çœç•¥ä¸€äº›ä¸é‡è¦çš„ä»£ç    </span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> StatefulPersistenceContext <span class="title">createPersistenceContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> StatefulPersistenceContext( <span class="keyword">this</span> );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//StatefulPersistenceContextå°±æ˜¯PersistenceContextçš„å®ç°ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatefulPersistenceContext</span> <span class="keyword">implements</span> <span class="title">PersistenceContext</span> </span>&#123;</span><br><span class="line"><span class="comment">//    ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> EntityManger éœ€è¦é€šè¿‡ @PersistenceContext çš„æ–¹å¼è¿›è¡Œè·å–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PersistenceContext</span></span><br><span class="line"><span class="keyword">private</span> EntityManager em;</span><br></pre></td></tr></table></figure>

<p>è€Œå…¶ä¸­ @PersistenceContext çš„å±æ€§é…ç½®æœ‰å¦‚ä¸‹è¿™äº›ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PersistenceContext &#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//PersistenceContextUnitçš„åå­—ï¼Œå¤šæ•°æ®æºçš„æ—¶å€™æœ‰ç”¨</span></span><br><span class="line">    <span class="function">String <span class="title">unitName</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//æ˜¯æŒ‡åˆ›å»ºçš„EntityManagerçš„ç”Ÿå‘½å‘¨æœŸæ˜¯å­˜åœ¨äº‹åŠ¡å†…è¿˜æ˜¯å¯ä»¥è·¨äº‹åŠ¡ï¼Œé»˜è®¤ä¸ºç”Ÿå‘½å‘¨æœŸå’Œäº‹åŠ¡ä¸€æ ·ï¼›</span></span><br><span class="line">    <span class="function">PersistenceContextType <span class="title">type</span><span class="params">()</span> <span class="keyword">default</span> PersistenceContextType.TRANSACTION</span>;</span><br><span class="line">    <span class="comment">//åŒæ­¥çš„ç±»å‹ï¼šåªæœ‰SYNCHRONIZEDå’Œ UNSYNCHRONIZED ä¸¤ä¸ªå€¼ç”¨æ¥è¡¨ç¤ºï¼Œä½†å¼€å¯äº‹åŠ¡çš„æ—¶å€™æ˜¯å¦è‡ªåŠ¨åŠ å…¥å·²å¼€å¯çš„äº‹åŠ¡é‡Œé¢ï¼Œé»˜è®¤SYNCHRONIZEDè¡¨ç¤ºè‡ªåŠ¨åŠ å…¥ï¼Œä¸åˆ›å»ºæ–°çš„äº‹åŠ¡ã€‚è€ŒUNSYNCHRONIZEDè¡¨ç¤ºï¼Œä¸è‡ªåŠ¨åŠ å…¥ä¸Šä¸‹æ–‡å·²ç»æœ‰çš„äº‹åŠ¡ï¼Œè‡ªåŠ¨å¼€å¯æ–°çš„äº‹åŠ¡ï¼›è¿™é‡Œä½ ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„çœ‹ä¸€ä¸‹äº‹åŠ¡çš„æ—¥å¿—ï¼›</span></span><br><span class="line">    <span class="function">SynchronizationType <span class="title">synchronization</span><span class="params">()</span> <span class="keyword">default</span> SynchronizationType.SYNCHRONIZED</span>;</span><br><span class="line">    <span class="comment">//æŒä¹…åŒ–çš„é…ç½®å±æ€§ï¼Œè¿™é‡ŒæŒ‡hibernateä¸­AvailableSettingsé‡Œé¢çš„å€¼</span></span><br><span class="line">    PersistenceProperty[] properties() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€èˆ¬æƒ…å†µä¸‹ä¿æŒé»˜è®¤å³å¯ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªç”±ç»„åˆï¼Œä¸¾ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PersistenceContext(</span></span><br><span class="line"><span class="meta">      unitName = &quot;db2&quot;,//é‡‡ç”¨æ•°æ®æº2çš„</span></span><br><span class="line"><span class="meta">      //å¯ä»¥è·¨äº‹åŠ¡çš„EntityManager</span></span><br><span class="line"><span class="meta">      type = PersistenceContextType.EXTENDED,</span></span><br><span class="line"><span class="meta">      properties = &#123;</span></span><br><span class="line"><span class="meta">            //é€šè¿‡propertiesæ”¹å˜ä¸€ä¸‹è‡ªåŠ¨flushçš„æœºåˆ¶</span></span><br><span class="line"><span class="meta">            @PersistenceProperty(</span></span><br><span class="line"><span class="meta">                  name=&quot;org.hibernate.flushMode&quot;,</span></span><br><span class="line"><span class="meta">                  value= &quot;MANUAL&quot;//æ”¹æˆæ‰‹åŠ¨åˆ·æ–°æ–¹å¼</span></span><br><span class="line"><span class="meta">            )</span></span><br><span class="line"><span class="meta">      &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">private</span> EntityManager entityManager;</span><br></pre></td></tr></table></figure>

<h2 id="å®ä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#å®ä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å®ä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ"></a>å®ä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ</h2><p>æ—¢ç„¶ PersistenceContext æ˜¯å­˜å‚¨ Entity çš„ï¼Œé‚£ä¹ˆ Entity åœ¨ PersistenceContext é‡Œé¢è‚¯å®šæœ‰ä¸åŒçš„çŠ¶æ€ã€‚å¯¹æ­¤ï¼ŒJPA åè®®å®šä¹‰äº†å››ç§çŠ¶æ€ï¼šnewã€managerã€detachedã€removedã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201207132405.png" alt=""></p>
<h3 id="ç¬¬ä¸€ç§ï¼šNew-çŠ¶æ€çš„å¯¹è±¡"><a href="#ç¬¬ä¸€ç§ï¼šNew-çŠ¶æ€çš„å¯¹è±¡" class="headerlink" title="ç¬¬ä¸€ç§ï¼šNew çŠ¶æ€çš„å¯¹è±¡"></a>ç¬¬ä¸€ç§ï¼šNew çŠ¶æ€çš„å¯¹è±¡</h3><p>å½“ä½¿ç”¨å…³é”®å­— new çš„æ—¶å€™åˆ›å»ºçš„å®ä½“å¯¹è±¡ï¼Œç§°ä¸º new çŠ¶æ€çš„ Entity å¯¹è±¡ã€‚å®ƒéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>new çŠ¶æ€çš„å®ä½“ Id å’Œ Version å­—æ®µéƒ½æ˜¯ nullï¼›</li>
<li>new çŠ¶æ€çš„å®ä½“æ²¡æœ‰åœ¨ PersistenceContext ä¸­å‡ºç°è¿‡ã€‚</li>
</ul>
<p>é‚£ä¹ˆå¦‚æœè¦æŠŠ new çŠ¶æ€çš„ Entity æ”¾åˆ° PersistenceContext é‡Œé¢ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ol>
<li>æ‰§è¡Œ <code>entityManager.persist(entity)</code> æ–¹æ³•ï¼›</li>
<li>é€šè¿‡å…³è”å…³ç³»çš„å®ä½“å…³ç³»é…ç½® cascade=PERSIST or cascade=ALL è¿™ç§ç±»å‹ï¼Œå¹¶ä¸”å…³è”å…³ç³»çš„ä¸€æ–¹ï¼Œä¹Ÿæ‰§è¡Œäº† entityManager.persist(entity) æ–¹æ³•ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPersist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = UserInfo.builder().lastName(<span class="string">&quot;jack&quot;</span>).build();</span><br><span class="line">    <span class="comment">//é€šè¿‡ contains æ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨ PersistenceContext é‡Œé¢ï¼Œæ­¤æ—¶ä¸åœ¨</span></span><br><span class="line">    Assertions.assertFalse(entityManager.contains(userInfo));</span><br><span class="line">    <span class="comment">//é€šè¿‡ persist æ–¹æ³•æŠŠå¯¹è±¡æ”¾åˆ° PersistenceContext é‡Œé¢</span></span><br><span class="line">    entityManager.persist(userInfo);</span><br><span class="line">    <span class="comment">//é€šè¿‡ contains æ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨ PersistenceContext é‡Œé¢ï¼Œæ­¤æ—¶åœ¨</span></span><br><span class="line">    Assertions.assertTrue(entityManager.contains(userInfo));</span><br><span class="line">    Assertions.assertNotNull(userInfo.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬äºŒç§ï¼šDetachedï¼ˆæ¸¸ç¦»ï¼‰çš„å®ä½“å¯¹è±¡"><a href="#ç¬¬äºŒç§ï¼šDetachedï¼ˆæ¸¸ç¦»ï¼‰çš„å®ä½“å¯¹è±¡" class="headerlink" title="ç¬¬äºŒç§ï¼šDetachedï¼ˆæ¸¸ç¦»ï¼‰çš„å®ä½“å¯¹è±¡"></a>ç¬¬äºŒç§ï¼šDetachedï¼ˆæ¸¸ç¦»ï¼‰çš„å®ä½“å¯¹è±¡</h3><p>Detached çŠ¶æ€çš„å¯¹è±¡è¡¨ç¤ºå’Œ PersistenceContext è„±ç¦»å…³ç³»çš„ Entity å¯¹è±¡ã€‚å®ƒå’Œ new çŠ¶æ€çš„å¯¹è±¡çš„ä¸åŒç‚¹åœ¨äºï¼š</p>
<ul>
<li><p>Detached æœ‰æŒä¹…åŒ–çš„ ID</p>
</li>
<li><p>å˜æˆæŒä¹…åŒ–å¯¹è±¡éœ€è¦è¿›è¡Œ merger æ“ä½œï¼Œmerger æ“ä½œä¼š copy ä¸€ä¸ªæ–°çš„å®ä½“å¯¹è±¡ï¼Œç„¶åæŠŠæ–°çš„å®ä½“å¯¹è±¡å˜æˆ Manager çŠ¶æ€</p>
</li>
</ul>
<p>è€Œ Detached å’Œ new çŠ¶æ€çš„å¯¹è±¡ç›¸åŒç‚¹ä¹Ÿæœ‰ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li><p>éƒ½å’Œ PersistenceContext è„±ç¦»äº†å…³ç³»ï¼›</p>
</li>
<li><p>å½“æ‰§è¡Œ flush æ“ä½œæˆ–è€… commit æ“ä½œçš„æ—¶å€™ï¼Œä¸ä¼šè¿›è¡Œæ•°æ®åº“åŒæ­¥ã€‚</p>
</li>
</ul>
<p>å¦‚æœæƒ³è®© Manager(persist) çŠ¶æ€çš„å¯¹è±¡ä» PersistenceContext é‡Œé¢æ¸¸ç¦»å‡ºæ¥å˜æˆ Detached çš„çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ EntityManager çš„ Detach æ–¹æ³•å®ç°ï¼š<code>entityManager.detach(entity);</code></p>
<p>å½“æ‰§è¡Œå®Œ <code>entityManager.clear()</code>ã€<code>entityManager.close()</code>ï¼Œæˆ–è€…äº‹åŠ¡ <code>commit()</code>ã€äº‹åŠ¡ <code>rollback()</code> ä¹‹åï¼Œæ‰€æœ‰æ›¾ç»åœ¨ PersistenceContext é‡Œé¢çš„å®ä½“éƒ½ä¼šå˜æˆ Detached çŠ¶æ€ã€‚</p>
<p>è€Œæ¸¸ç¦»çŠ¶æ€çš„å¯¹è±¡æƒ³å›åˆ° PersistenceContext é‡Œé¢å˜æˆ manager çŠ¶æ€çš„è¯ï¼Œåªèƒ½æ‰§è¡Œ entityManager çš„ merge æ–¹æ³•ï¼š<code>entityManager.merge(entity);</code></p>
<p>æ¸¸ç¦»çŠ¶æ€çš„å®ä½“æ‰§è¡Œ EntityManager ä¸­ persist æ–¹æ³•çš„æ—¶å€™å°±ä¼šæŠ¥å¼‚å¸¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMergeException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡newçš„æ–¹å¼æ„å»ºä¸€ä¸ªæ¸¸ç¦»çŠ¶æ€çš„å¯¹è±¡</span></span><br><span class="line">    UserInfo userInfo = UserInfo.builder().id(<span class="number">1L</span>).lastName(<span class="string">&quot;jack&quot;</span>).version(<span class="number">1</span>).build();</span><br><span class="line">    <span class="comment">//éªŒè¯æ˜¯å¦å­˜åœ¨äºpersistence context é‡Œé¢ï¼Œnewçš„è‚¯å®šä¸å­˜åœ¨</span></span><br><span class="line">    Assertions.assertFalse(entityManager.contains(userInfo));</span><br><span class="line">    <span class="comment">//å½“æ‰§è¡Œpersistæ–¹æ³•çš„æ—¶å€™å°±ä¼šæŠ¥å¼‚å¸¸</span></span><br><span class="line">    Assertions.assertThrows(PersistentObjectException.class,()-&gt;entityManager.persist(userInfo));</span><br><span class="line">    <span class="comment">//detachedçŠ¶æ€çš„å®ä½“é€šè¿‡mergeçš„æ–¹å¼ä¿å­˜åœ¨äº†persistence contexté‡Œé¢</span></span><br><span class="line">   UserInfo user2 = entityManager.merge(userInfo);</span><br><span class="line">    <span class="comment">//éªŒè¯ä¸€ä¸‹å­˜åœ¨äºæŒä¹…åŒ–ä¸Šä¸‹æ–‡é‡Œé¢</span></span><br><span class="line">    Assertions.assertTrue(entityManager.contains(user2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸‰ç§ï¼šManagerï¼ˆpersistï¼‰-çŠ¶æ€çš„å®ä½“"><a href="#ç¬¬ä¸‰ç§ï¼šManagerï¼ˆpersistï¼‰-çŠ¶æ€çš„å®ä½“" class="headerlink" title="ç¬¬ä¸‰ç§ï¼šManagerï¼ˆpersistï¼‰ çŠ¶æ€çš„å®ä½“"></a>ç¬¬ä¸‰ç§ï¼šManagerï¼ˆpersistï¼‰ çŠ¶æ€çš„å®ä½“</h3><p>Manager çŠ¶æ€çš„å®ä½“ï¼Œæ˜¯æŒ‡åœ¨ PersistenceContext é‡Œé¢ç®¡ç†çš„å®ä½“ï¼Œè€Œæ­¤ç§çŠ¶æ€çš„å®ä½“å½“æˆ‘ä»¬æ‰§è¡Œäº‹åŠ¡çš„ commit()ï¼Œæˆ–è€… entityManager çš„ flush æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œæ•°æ®åº“çš„åŒæ­¥æ“ä½œã€‚å¯ä»¥è¯´æ˜¯å’Œæ•°æ®åº“çš„æ•°æ®æœ‰æ˜ å°„å…³ç³»ã€‚</p>
<p>New çŠ¶æ€å¦‚æœè¦å˜æˆ Manager çš„çŠ¶æ€ï¼Œéœ€è¦æ‰§è¡Œ persist æ–¹æ³•ï¼›è€Œ Detached çŠ¶æ€çš„å®ä½“å¦‚æœæƒ³å˜æˆ Manager çš„çŠ¶æ€ï¼Œåˆ™éœ€è¦æ‰§è¡Œ merge æ–¹æ³•ã€‚åœ¨ session çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä»»ä½•ä»æ•°æ®åº“é‡Œé¢æŸ¥è¯¢åˆ°çš„ Entity éƒ½ä¼šè‡ªåŠ¨æˆä¸º Manager çš„çŠ¶æ€ï¼Œå¦‚ entityManager.findById(id)ã€entityManager.getReference ç­‰æ–¹æ³•ã€‚</p>
<p>è€Œ Manager çŠ¶æ€çš„ Entity è¦åŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ï¼Œå¿…é¡»æ‰§è¡Œ EntityManager é‡Œé¢çš„ flush æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯¹ Entity å¯¹è±¡åšçš„ä»»ä½•å¢åˆ æ”¹æŸ¥ï¼Œå¿…é¡»é€šè¿‡ entityManager.flush() æ‰§è¡Œä¹‹åæ‰ä¼šå˜æˆ SQL åŒæ­¥åˆ° DB é‡Œé¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Rollback(value = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testManagerException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = UserInfo.builder().lastName(<span class="string">&quot;jack&quot;</span>).build();</span><br><span class="line">    entityManager.persist(userInfo);</span><br><span class="line">    System.out.println(<span class="string">&quot;æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql&quot;</span>);</span><br><span class="line">    entityManager.flush();</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql&quot;</span>);</span><br><span class="line">    Assertions.assertTrue(entityManager.contains(userInfo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql</span><br><span class="line">Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span><br><span class="line">æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬å››ç§ï¼šRemoved-çš„å®ä½“çŠ¶æ€"><a href="#ç¬¬å››ç§ï¼šRemoved-çš„å®ä½“çŠ¶æ€" class="headerlink" title="ç¬¬å››ç§ï¼šRemoved çš„å®ä½“çŠ¶æ€"></a>ç¬¬å››ç§ï¼šRemoved çš„å®ä½“çŠ¶æ€</h3><p>Removed çš„çŠ¶æ€ï¼Œæ˜¯æŒ‡åˆ é™¤äº†çš„å®ä½“ï¼Œä½†æ˜¯æ­¤å®ä½“è¿˜åœ¨ PersistenceContext é‡Œé¢ï¼Œåªæ˜¯åœ¨å…¶ä¸­è¡¨ç¤ºä¸º Removed çš„çŠ¶æ€ï¼Œå®ƒå’Œ Detached çŠ¶æ€çš„å®ä½“æœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯åœ¨ä¸åœ¨ PersistenceContext é‡Œé¢ï¼Œä½†éƒ½æœ‰ ID å±æ€§ã€‚</p>
<p>è€Œ Removed çŠ¶æ€çš„å®ä½“ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ entityManager.flush() æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šç”Ÿæˆä¸€æ¡ delete è¯­å¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚Removed çŠ¶æ€çš„å®ä½“ï¼Œåœ¨æ‰§è¡Œ flush() æ–¹æ³•ä¹‹å‰ï¼Œæ‰§è¡Œ entityManger.persist(removedEntity) æ–¹æ³•æ—¶å€™ï¼Œå°±ä¼šå»æ‰åˆ é™¤çš„è¡¨ç¤ºï¼Œå˜æˆ Managed çš„çŠ¶æ€å®ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = UserInfo.builder().lastName(<span class="string">&quot;jack&quot;</span>).build();</span><br><span class="line">    entityManager.persist(userInfo);</span><br><span class="line">    entityManager.flush();</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql&quot;</span>);           </span><br><span class="line">    entityManager.remove(userInfo);</span><br><span class="line">    entityManager.flush();</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰§è¡Œäº†flush()æ–¹æ³•ä¹‹åï¼Œåˆäº§ç”Ÿäº†delete sql&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span><br><span class="line">æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql</span><br><span class="line">Hibernate: delete from user_info <span class="built_in">where</span> id=? and version=?</span><br><span class="line">æ‰§è¡Œäº†flush()æ–¹æ³•ä¹‹åï¼Œåˆäº§ç”Ÿäº†delete sql</span><br></pre></td></tr></table></figure>

<p>MyBatis æ˜¯å¯¹æ•°æ®åº“çš„æ“ä½œæ‰€è§å³æ‰€å¾—çš„æ¨¡å¼ï¼›è€Œä½¿ç”¨ JPAï¼Œä½ çš„ä»»ä½•æ“ä½œéƒ½ä¸ä¼šäº§ç”Ÿ DB çš„sql</p>
<h2 id="EntityManager-çš„-flush-æ–¹æ³•"><a href="#EntityManager-çš„-flush-æ–¹æ³•" class="headerlink" title="EntityManager çš„ flush() æ–¹æ³•"></a>EntityManager çš„ flush() æ–¹æ³•</h2><p>flush æ–¹æ³•çš„ç”¨æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨éœ€è¦ DB åŒæ­¥ sql æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰§è¡Œ entityManager.flush() å³å¯</p>
<h3 id="Flush-çš„ä½œç”¨"><a href="#Flush-çš„ä½œç”¨" class="headerlink" title="Flush çš„ä½œç”¨"></a>Flush çš„ä½œç”¨</h3><p>flush é‡è¦çš„ã€å”¯ä¸€çš„ä½œç”¨ï¼Œå°±æ˜¯å°† Persistence Context ä¸­å˜åŒ–çš„å®ä½“è½¬åŒ–æˆ sql è¯­å¥ï¼ŒåŒæ­¥æ‰§è¡Œåˆ°æ•°æ®åº“é‡Œé¢ã€‚æ¢å¥è¯æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ‰§è¡Œ flush() æ–¹æ³•çš„è¯ï¼Œé€šè¿‡ EntityManager æ“ä½œçš„ä»»ä½• Entity è¿‡ç¨‹éƒ½ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚</p>
<p>è€Œ flush() æ–¹æ³•å¾ˆå¤šæ—¶å€™ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ“ä½œï¼Œè¿™é‡Œæˆ‘ç›´æ¥é€šè¿‡ entityManager æ“ä½œ flush() æ–¹æ³•ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ¼”ç¤ºæ‰§è¡Œè¿‡ç¨‹ã€‚å®é™…å·¥ä½œä¸­å¾ˆå°‘ä¼šè¿™æ ·æ“ä½œï¼Œè€Œæ˜¯ä¼šç›´æ¥åˆ©ç”¨ JPA å’Œ Hibernate åº•å±‚æ¡†æ¶å¸®æˆ‘ä»¬å®ç°çš„è‡ªåŠ¨ flush çš„æœºåˆ¶ã€‚</p>
<h3 id="Flush-çš„æœºåˆ¶"><a href="#Flush-çš„æœºåˆ¶" class="headerlink" title="Flush çš„æœºåˆ¶"></a>Flush çš„æœºåˆ¶</h3><p>JPA åè®®è§„å®šäº† EntityManager å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•ä¿®æ”¹ FlushModeã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//entity manager é‡Œé¢æä¾›çš„ä¿®æ”¹FlushModeçš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlushMode</span><span class="params">(FlushModeType flushMode)</span></span>;</span><br><span class="line"><span class="comment">//FlushModeTypeåªæœ‰ä¸¤ä¸ªå€¼ï¼Œè‡ªåŠ¨å’Œäº‹åŠ¡æäº¤ä¹‹å‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">FlushModeType</span> </span>&#123;</span><br><span class="line">    <span class="comment">//äº‹åŠ¡commitä¹‹å‰</span></span><br><span class="line">   COMMIT,</span><br><span class="line">    <span class="comment">//è‡ªåŠ¨è§„åˆ™ï¼Œé»˜è®¤</span></span><br><span class="line">   AUTO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ Hibernate è¿˜æä¾›äº†ä¸€ç§æ‰‹åŠ¨è§¦å‘çš„æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç çš„æ–¹å¼è¿›è¡Œä¿®æ”¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PersistenceContext(properties = &#123;@PersistenceProperty(</span></span><br><span class="line"><span class="meta">        name = &quot;org.hibernate.flushMode&quot;,</span></span><br><span class="line"><span class="meta">        value = &quot;MANUAL&quot;//æ‰‹åŠ¨flush</span></span><br><span class="line"><span class="meta">)&#125;)</span></span><br><span class="line"><span class="keyword">private</span> EntityManager entityManager;</span><br></pre></td></tr></table></figure>

<p>æ‰‹åŠ¨å’Œ commit çš„æ—¶å€™å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æ‰‹åŠ¨æ‰§è¡Œ flush æ–¹æ³•ï¼›äº‹åŠ¡å°±æ˜¯ä»£ç åœ¨æ‰§è¡Œäº‹åŠ¡ commit çš„æ—¶å€™ï¼Œå¿…é¡»è¦æ‰§è¡Œ flush() æ–¹æ³•</p>
<h3 id="Flush-çš„è‡ªåŠ¨æœºåˆ¶"><a href="#Flush-çš„è‡ªåŠ¨æœºåˆ¶" class="headerlink" title="Flush çš„è‡ªåŠ¨æœºåˆ¶"></a>Flush çš„è‡ªåŠ¨æœºåˆ¶</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJPA å’Œ Hibernate éƒ½æ˜¯é‡‡ç”¨çš„ AUTO çš„ Flush æœºåˆ¶ï¼Œè‡ªåŠ¨è§¦å‘çš„è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>äº‹åŠ¡ commit ä¹‹å‰ï¼Œå³æŒ‡æ‰§è¡Œ <code>transactionManager.commit()</code> ä¹‹å‰éƒ½ä¼šè§¦å‘ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼›</p>
</li>
<li><p>æ‰§è¡Œä»»ä½•çš„ JPQL æˆ–è€… native SQLï¼ˆä»£æ›¿ç›´æ¥æ“ä½œ Entity çš„æ–¹æ³•ï¼‰éƒ½ä¼šè§¦å‘ flushã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPersist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo = UserInfo.builder().lastName(<span class="string">&quot;jack&quot;</span>).build();</span><br><span class="line">        <span class="comment">//é€šè¿‡containsæ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨PersistenceContexté‡Œé¢ï¼Œæ­¤æ—¶ä¸åœ¨</span></span><br><span class="line">        Assertions.assertFalse(entityManager.contains(userInfo));</span><br><span class="line">        <span class="comment">//é€šè¿‡persistæ–¹æ³•æŠŠå¯¹è±¡æ”¾åˆ°PersistenceContexté‡Œé¢</span></span><br><span class="line">        entityManager.persist(userInfo);<span class="comment">//æ˜¯ç›´æ¥æ“ä½œEntityçš„ï¼Œä¸ä¼šè§¦å‘flushæ“ä½œ</span></span><br><span class="line">        <span class="comment">//entityManager.remove(userInfo);//æ˜¯ç›´æ¥æ“ä½œEntityçš„ï¼Œä¸ä¼šè§¦å‘flushæ“ä½œ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql&quot;</span>);</span><br><span class="line">        UserInfo userInfo2 = entityManager.find(UserInfo.class,<span class="number">2L</span>);<span class="comment">//æ˜¯ç›´æ¥æ“ä½œEntityçš„ï¼Œè¿™ä¸ªå°±ä¸ä¼šè§¦å‘flushæ“ä½œ</span></span><br><span class="line"><span class="comment">//        userInfoRepository.queryByFlushTest();//æ˜¯æ“ä½œJPQLçš„ï¼Œè¿™ä¸ªå°±ä¼šå…ˆè§¦å‘flushæ“ä½œï¼›</span></span><br><span class="line">        System.out.println(<span class="string">&quot;flush()æ–¹æ³•ï¼Œäº§ç”Ÿinsert sql&quot;</span>);</span><br><span class="line">        <span class="comment">//é€šè¿‡containsæ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨ PersistenceContext é‡Œé¢ï¼Œæ­¤æ—¶åœ¨</span></span><br><span class="line">        Assertions.assertTrue(entityManager.contains(userInfo));</span><br><span class="line">        Assertions.assertNotNull(userInfo.getId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåªæœ‰æ‰§è¡Œç±»ä¼¼ .queryByFlushTest() è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘ flushï¼Œå› ä¸ºå®ƒæ˜¯ç”¨çš„ JPQL çš„æœºåˆ¶æ‰§è¡Œçš„ã€‚</p>
<p>ä¸Šé¢çš„æ–¹æ³•è§¦å‘äº† flush çš„æ—¥å¿—ï¼Œä¼šè¾“å‡ºå¦‚ä¸‹æ ¼å¼ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™é‡Œå¤šäº†ä¸€ä¸ª insert è¯­å¥ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql</span><br><span class="line">Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span><br><span class="line">Hibernate: <span class="built_in">select</span> userinfo0_.id as id1_0_, userinfo0_.create_time as create_t2_0_, userinfo0_.create_user_id as create_u3_0_, userinfo0_.last_modified_time as last_mod4_0_, userinfo0_.last_modified_user_id as last_mod5_0_, userinfo0_.version as version6_0_, userinfo0_.ages as ages7_0_, userinfo0_.email_address as email_ad8_0_, userinfo0_.last_name as last_nam9_0_, userinfo0_.telephone as telepho10_0_ from user_info userinfo0_ <span class="built_in">where</span> userinfo0_.id=<span class="number">2</span></span><br><span class="line">flush()æ–¹æ³•ï¼Œäº§ç”Ÿinsert sql</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰è§¦å‘ flush çš„æ—¥å¿—è¾“å‡ºçš„æ˜¯å¦‚ä¸‹æ ¼å¼ï¼Œå…¶ä¸­æ²¡æœ‰ insert è¯­å¥ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql</span><br><span class="line">Hibernate: <span class="built_in">select</span> userinfo0_.id as id1_0_0_, userinfo0_.create_time as create_t2_0_0_, userinfo0_.create_user_id as create_u3_0_0_, userinfo0_.last_modified_time as last_mod4_0_0_, userinfo0_.last_modified_user_id as last_mod5_0_0_, userinfo0_.version as version6_0_0_, userinfo0_.ages as ages7_0_0_, userinfo0_.email_address as email_ad8_0_0_, userinfo0_.last_name as last_nam9_0_0_, userinfo0_.telephone as telepho10_0_0_ from user_info userinfo0_ <span class="built_in">where</span> userinfo0_.id=?</span><br><span class="line">flush()æ–¹æ³•ï¼Œäº§ç”Ÿinsert sql</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="Flush-ä¼šæ”¹å˜-SQL-çš„æ‰§è¡Œé¡ºåº"><a href="#Flush-ä¼šæ”¹å˜-SQL-çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="Flush ä¼šæ”¹å˜ SQL çš„æ‰§è¡Œé¡ºåº"></a>Flush ä¼šæ”¹å˜ SQL çš„æ‰§è¡Œé¡ºåº</h3><p>flush() æ–¹æ³•è°ƒç”¨ä¹‹åï¼ŒåŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œsql çš„æ‰§è¡Œé¡ºåºä¼šå˜æˆå¦‚ä¸‹æ¨¡å¼ï¼š</p>
<ul>
<li>insert çš„å…ˆæ‰§è¡Œ</li>
<li>delete çš„ç¬¬äºŒä¸ªæ‰§è¡Œ</li>
<li>update çš„ç¬¬ä¸‰ä¸ªæ‰§è¡Œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">entityManager.remove(u3);</span><br><span class="line">UserInfo userInfo = UserInfo.builder().lastName(<span class="string">&quot;jack&quot;</span>).build();</span><br><span class="line">entityManager.persist(userInfo);</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹æ‰§è¡Œçš„ sql ä¼šå˜æˆå¦‚ä¸‹æ¨¡æ ·ï¼Œå³å…ˆ insert å deleteã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Hibernate: insert into user_info ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span><br><span class="line">Hibernate: delete from user_info <span class="built_in">where</span> id=? and version=?</span><br></pre></td></tr></table></figure>

<p>è¿™ç§ä¼šæ”¹å˜é¡ºåºçš„ç°è±¡ï¼Œä¸»è¦æ˜¯ç”± persistence context çš„å®ä½“çŠ¶æ€æœºåˆ¶å¯¼è‡´çš„ï¼Œæ‰€ä»¥åœ¨ Hibernate çš„ç¯å¢ƒä¸­ï¼Œé¡ºåºä¼šå˜æˆå¦‚ä¸‹çš„ ActionQueue çš„æ¨¡å¼ï¼š</p>
<ul>
<li><p>OrphanRemovalAction</p>
</li>
<li><p>EntityInsertAction</p>
</li>
<li><p>EntityIdentityInsertAction</p>
</li>
<li><p>EntityUpdateAction</p>
</li>
<li><p>CollectionRemoveAction</p>
</li>
<li><p>CollectionUpdateAction</p>
</li>
<li><p>CollectionRecreateAction</p>
</li>
<li><p>EntityDeleteAction</p>
</li>
</ul>
<h3 id="Flush-ä¸äº‹åŠ¡-Commit-çš„å…³ç³»"><a href="#Flush-ä¸äº‹åŠ¡-Commit-çš„å…³ç³»" class="headerlink" title="Flush ä¸äº‹åŠ¡ Commit çš„å…³ç³»"></a>Flush ä¸äº‹åŠ¡ Commit çš„å…³ç³»</h3><p>å¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li><p>åœ¨å½“å‰çš„äº‹åŠ¡æ‰§è¡Œ commit çš„æ—¶å€™ï¼Œä¼šè§¦å‘ flush æ–¹æ³•ï¼›</p>
</li>
<li><p>åœ¨å½“å‰çš„äº‹åŠ¡æ‰§è¡Œå®Œ commit çš„æ—¶å€™ï¼Œå¦‚æœéš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»çš„è¯ï¼Œflush ä¹‹åæ‰§è¡Œçš„ updateã€insertã€delete çš„æ“ä½œï¼Œä¼šè¢«å…¶ä»–çš„æ–°äº‹åŠ¡çœ‹åˆ°æœ€æ–°ç»“æœï¼›</p>
</li>
<li><p>å‡è®¾å½“å‰çš„äº‹åŠ¡æ˜¯å¯é‡å¤è¯»çš„ï¼Œå½“æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œ flush æ–¹æ³•ä¹‹åï¼Œæ²¡æœ‰æ‰§è¡Œäº‹åŠ¡ commit æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡æ˜¯çœ‹ä¸åˆ°æœ€æ–°å€¼å˜åŒ–çš„ï¼Œä½†æ˜¯æœ€æ–°å€¼å˜åŒ–å¯¹å½“å‰æ²¡æœ‰ commit çš„äº‹åŠ¡æ˜¯æœ‰æ•ˆçš„ï¼›</p>
</li>
<li><p>å¦‚æœæ‰§è¡Œäº† flush ä¹‹åï¼Œå½“å‰äº‹åŠ¡å‘ç”Ÿäº† rollback æ“ä½œï¼Œé‚£ä¹ˆæ•°æ®å°†ä¼šè¢«å›æ»šï¼ˆæ•°æ®åº“çš„æœºåˆ¶ï¼‰ã€‚</p>
</li>
</ol>
<h3 id="saveAndFlush-å’Œ-save-çš„åŒºåˆ«"><a href="#saveAndFlush-å’Œ-save-çš„åŒºåˆ«" class="headerlink" title="saveAndFlush å’Œ save çš„åŒºåˆ«"></a>saveAndFlush å’Œ save çš„åŒºåˆ«</h3><p>**Repository é‡Œé¢æœ‰ä¸€ä¸ª saveAndFlush(entity); çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;S extends T&gt; <span class="function">S <span class="title">saveAndFlush</span><span class="params">(S entity)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//æ‰§è¡Œäº†saveæ–¹æ³•ä¹‹åï¼Œè°ƒç”¨äº†flush()æ–¹æ³•</span></span><br><span class="line">   S result = save(entity);</span><br><span class="line">   flush();</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œå¦ä¸€ä¸ª **Repository é‡Œé¢çš„ save çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ²¡æœ‰åš flush æ“ä½œï¼Œåªæ˜¯ï¼Œæ‰§è¡Œäº† persist æˆ–è€… merge çš„æ“ä½œ</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;S extends T&gt; <span class="function">S <span class="title">save</span><span class="params">(S entity)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (entityInformation.isNew(entity)) &#123;</span><br><span class="line">      em.persist(entity);</span><br><span class="line">      <span class="keyword">return</span> entity;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> em.merge(entity);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒºåˆ«æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li><p>saveAndFlush æ‰§è¡Œå®Œsaveï¼Œå†æ‰§è¡Œ flushï¼Œä¼š<strong>åˆ·æ–°æ•´ä¸ª PersistenceContext é‡Œé¢çš„å®ä½“</strong>å¹¶è¿›å…¥åˆ°æ•°æ®åº“é‡Œé¢ï¼Œé‚£ä¹ˆ<strong>å½“æˆ‘ä»¬é¢‘ç¹è°ƒç”¨ saveAndFlush å°±å¤±å»äº† cache çš„æ„ä¹‰</strong>ï¼Œè¿™ä¸ªæ—¶å€™å°±å’Œæ‰§è¡Œ mybatis çš„ saveOrUpdate æ˜¯ä¸€æ ·çš„æ•ˆæœï¼›</p>
</li>
<li><p>å½“å¤šæ¬¡è°ƒç”¨ç›¸åŒçš„ save æ–¹æ³•çš„æ—¶å€™ï¼Œæœ€ç»ˆ flush æ‰§è¡Œåªä¼šäº§ç”Ÿä¸€æ¡ sqlï¼Œåœ¨æ€§èƒ½ä¸Šä¼šæ¯” saveAndFlush é«˜ä¸€ç‚¹ï¼›</p>
</li>
<li><p>ä¸ç®¡æ˜¯ saveAndFlush è¿˜æ˜¯ saveï¼Œéƒ½å—å½“å‰äº‹åŠ¡æ§åˆ¶ï¼Œäº‹åŠ¡åœ¨æ²¡æœ‰ commit ä¹‹å‰ï¼Œéƒ½åªä¼šå½±å“å½“å‰äº‹åŠ¡çš„æ“ä½œï¼›</p>
</li>
</ol>
<p>ç»¼ä¸Šï¼Œä¸¤ç§æœ¬è´¨çš„åŒºåˆ«å°±æ˜¯ flush æ‰§è¡Œçš„æ—¶æœºä¸ä¸€æ ·è€Œå·²ï¼Œå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„äº‹åŠ¡ä¸€è‡´æ€§æ²¡æœ‰ä»»ä½•å½±å“ã€‚ç„¶è€Œæœ‰çš„æ—¶å€™ï¼Œå³ä½¿æˆ‘ä»¬è°ƒç”¨äº† flush çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ¡ sql éƒ½æ²¡æœ‰ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå†æ¥äº†è§£ä¸€ä¸ªæ¦‚å¿µï¼šDirtyã€‚</p>
<h2 id="Entity-çš„-Dirty-åˆ¤æ–­é€»è¾‘åŠå…¶ä½œç”¨"><a href="#Entity-çš„-Dirty-åˆ¤æ–­é€»è¾‘åŠå…¶ä½œç”¨" class="headerlink" title="Entity çš„ Dirty åˆ¤æ–­é€»è¾‘åŠå…¶ä½œç”¨"></a>Entity çš„ Dirty åˆ¤æ–­é€»è¾‘åŠå…¶ä½œç”¨</h2><p>åœ¨ PersistenceContext é‡Œé¢è¿˜æœ‰ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå°±æ˜¯<strong>å½“å®ä½“ä¸æ˜¯ Dirty çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä»»ä½•å˜åŒ–çš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šè¿›è¡Œä»»ä½• db æ“ä½œçš„</strong>ã€‚æ‰€ä»¥å³ä½¿æˆ‘ä»¬æ‰§è¡Œ flush å’Œ commitï¼Œå®ä½“æ²¡æœ‰å˜åŒ–ï¼Œå°±æ²¡æœ‰å¿…è¦æ‰§è¡Œï¼Œè¿™ä¹Ÿèƒ½å¤§å¤§å‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚Dirty çš„æ•ˆæœçš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æˆ‘ä»¬å‡è®¾æ•°æ®åº“é‡Œé¢å­˜åœ¨ä¸€æ¡id=1çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸åšä»»ä½•æ”¹å˜æ‰§è¡Œsaveæˆ–è€…saveAndFlushï¼Œé™¤äº†selectä¹‹å¤–ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•sqlè¯­å¥ï¼›</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Rollback(value = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDirty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">    userInfoRepository.saveAndFlush(userInfo);</span><br><span class="line">    userInfoRepository.save(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå½“æˆ‘ä»¬å°è¯•æ”¹å˜ä¸€ä¸‹ userInfo é‡Œé¢çš„å€¼ï¼Œå½“æ‰§è¡Œå¦‚ä¸‹æ–¹æ³•çš„æ—¶å€™å°±ä¼šäº§ç”Ÿ update çš„ sqlã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Rollback(value = false)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDirty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">    userInfo.setLastName(<span class="string">&quot;jack_test_dirty&quot;</span>);</span><br><span class="line">    userInfoRepository.saveAndFlush(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Entity-åˆ¤æ–­-Dirty-çš„è¿‡ç¨‹"><a href="#Entity-åˆ¤æ–­-Dirty-çš„è¿‡ç¨‹" class="headerlink" title="Entity åˆ¤æ–­ Dirty çš„è¿‡ç¨‹"></a>Entity åˆ¤æ–­ Dirty çš„è¿‡ç¨‹</h3><p><code>DefaultFlushEntityEventListener</code> çš„æºç é‡Œé¢ isUpdateNecessary çš„å…³é”®æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201207145648.png" alt=""></p>
<p>çœ‹ dirtyCheck çš„å®ç°ï¼Œå¯ä»¥çœ‹å‘ç°å¦‚ä¸‹å…³é”®ç‚¹ï¼Œä»è€Œæ‰¾å‡ºå‘ç”Ÿå˜åŒ–çš„ propertiesã€‚</p>
<p><img src="http://image.leonote.cn/20201207145808.png" alt=""></p>
<p>å†ä»”ç»†çœ‹ <code>persister.findDirtyï¼ˆvalues, loadedState, entity, sessionï¼‰</code>ï¼Œå¯ä»¥çœ‹å‡ºæ¥æºç é‡Œé¢æ˜¯é€šè¿‡ä¸€ä¸ªå­—æ®µä¸€ä¸ªå­—æ®µæ¯”è¾ƒçš„ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“ PersistenceContext ä¸­çš„å‰åä¸¤ä¸ª Entity çš„å“ªäº›å­—æ®µå‘ç”Ÿäº†å˜åŒ–ã€‚å› æ­¤å½“æˆ‘ä»¬æ‰§è¡Œå®Œ save ä¹‹åï¼Œæ²¡æœ‰äº§ç”Ÿä»»ä½• sqlï¼ˆå› ä¸ºæ²¡æœ‰å˜åŒ–ï¼‰ã€‚</p>
<blockquote>
<p>æ€»ç»“ï¼šåœ¨ flush çš„æ—¶å€™ï¼ŒHibernate ä¼šä¸€ä¸ªä¸ªåˆ¤æ–­å®ä½“çš„å‰åå¯¹è±¡ä¸­å“ªä¸ªå±æ€§å‘ç”Ÿå˜åŒ–äº†ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¸äº§ç”Ÿ update çš„ sql è¯­å¥ï¼›åªæœ‰å˜åŒ–æ‰ä¼šæ‰ç”Ÿ update sqlï¼Œå¹¶ä¸”å¯ä»¥åšåˆ°åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢çš„å¤šæ¬¡ update åˆå¹¶ï¼Œä»è€Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å‡è½» DB çš„å‹åŠ›ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa Session çš„ OpenInView å¯¹äº‹åŠ¡çš„å½±å“</title>
    <url>/2021/01/08/SpringDataJpa%E7%9A%84Session%E7%9A%84OpenInView%E5%AF%B9%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%BD%B1%E5%93%8D/</url>
    <content><![CDATA[<h1 id="Session-çš„-OpenInView-å¯¹äº‹åŠ¡çš„å½±å“"><a href="#Session-çš„-OpenInView-å¯¹äº‹åŠ¡çš„å½±å“" class="headerlink" title="Session çš„ OpenInView å¯¹äº‹åŠ¡çš„å½±å“"></a>Session çš„ OpenInView å¯¹äº‹åŠ¡çš„å½±å“</h1><p>Spring æ–°å¢äº†ä¸€ä¸ª spring.jpa.open-in-view çš„é…ç½®ï¼Œä½†æ˜¯ Hibernate æœ¬èº«å´æ²¡æœ‰è¿™ä¸ªé…ç½®ï¼Œä¸è¿‡å…¶åˆæ˜¯å’Œ Hibernate ä¸­çš„ Session ç›¸å…³çš„</p>
<h2 id="Session-æ˜¯ä»€ä¹ˆ"><a href="#Session-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Session æ˜¯ä»€ä¹ˆ"></a>Session æ˜¯ä»€ä¹ˆ</h2><p><img src="http://image.leonote.cn/20201209151809.png" alt=""></p>
<p>å…¶ä¸­ï¼ŒSessionImpl æ˜¯ Hibernate å®ç° JPA åè®®çš„ EntityManager çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œå³å®ç°ç±»ï¼›è€Œ Session æ˜¯ Hibernate ä¸­çš„æ¦‚å¿µï¼Œå®Œå…¨ç¬¦åˆ EntityManager çš„æ¥å£åè®®ï¼ŒåŒæ—¶åˆå®Œæˆäº† Hibernate çš„ç‰¹æ®Šå®ç°ã€‚</p>
<p>åœ¨ Spring Data JPA çš„æ¡†æ¶ä¸­ï¼Œå¯ä»¥ç‹­éš˜åœ°æŠŠ Session ç†è§£ä¸º EntityManagerï¼Œå› ä¸ºå…¶å¯¹äº JPA çš„ä»»ä½•æ“ä½œéƒ½æ˜¯é€šè¿‡ EntityManager çš„æ¥å£è¿›è¡Œçš„ï¼Œå¯ä»¥æŠŠ Session é‡Œé¢çš„å¤æ‚é€»è¾‘å½“æˆä¸€ä¸ªé»‘ç›’å­ã€‚å³ä½¿ SessionImpl èƒ½å¤Ÿå®ç° Hibernate çš„ Session æ¥å£ï¼Œä½†å¦‚æœä½¿ç”¨çš„æ˜¯ Spring Data JPAï¼Œé‚£ä¹ˆå®ç°å†å¤šçš„æ¥å£ä¹Ÿå’Œ Spring Data JPA æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚</p>
<p>é™¤éä¸ç”¨ JPA çš„æ¥å£ï¼Œç›´æ¥ç”¨ Hibernate çš„ Native æ¥å®ç°ï¼Œä½†æ˜¯ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºè¿‡ç¨‹å¤ªå¤æ‚äº†ã€‚</p>
<h2 id="SessionImpl-è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#SessionImpl-è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="SessionImpl è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>SessionImpl è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2><p>é€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ï¼Œè¯·çœ‹ä¸‹é¢è¿™å¼ å›¾ã€‚</p>
<p><img src="http://image.leonote.cn/20210108144559.png" alt=""></p>
<p>é€šè¿‡ SessionImpl çš„æºç å’Œ Structure çš„è§†å›¾ï¼Œå¯ä»¥â€œç®€å•ç²—æš´â€åœ°å¾—å‡ºå¦‚ä¸‹ç»“è®ºã€‚</p>
<p>SessionImpl æ˜¯ EntityManager çš„å®ç°ç±»ï¼Œå…¶å®ç°äº† JPA åè®®è§„å®šçš„ EntityManager çš„æ‰€æœ‰åŠŸèƒ½ï¼›å¦‚ï¼šEntityManager æš´éœ²çš„ flushModel çš„è®¾ç½®ï¼›EntityManager å¯¹ Transaction åšäº†â€œæ˜¯å¦å¼€å¯æ–°äº‹åŠ¡â€â€œæ˜¯å¦å…³é—­å½“å‰äº‹åŠ¡â€çš„é€»è¾‘ã€‚</p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒSessionImpl å®ç°äº† PersistenceContext å¯¹è±¡å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œä½¿å¾— PersistenceContext ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ Session çš„ç”Ÿå‘½å‘¨æœŸã€‚æ‰€ä»¥å¯ä»¥æŠ½è±¡åœ°ç†è§£ä¸ºï¼ŒSession æ˜¯å¯¹ä¸€äº›æ•°æ®åº“çš„æ“ä½œï¼Œéœ€è¦æ”¾åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡çš„é›†åˆä¸­ï¼Œå°±æ˜¯å¸¸è¯´çš„ä¸€çº§ç¼“å­˜ã€‚</p>
<p>Session çš„ open å’Œ close æ“ä½œï¼š</p>
<ul>
<li>open çš„æ—¶å€™åšäº†â€œæ˜¯å¦å¼€å¯äº‹åŠ¡â€â€œæ˜¯å¦è·å–è¿æ¥â€ç­‰é€»è¾‘ï¼›</li>
<li>close çš„æ—¶å€™åšäº†â€œæ˜¯å¦å…³é—­äº‹åŠ¡â€â€œé‡Šæ”¾è¿æ¥â€ç­‰åŠ¨ä½œï¼›</li>
</ul>
<p>Session çš„ä»»ä½•æ“ä½œéƒ½ç¦»ä¸å¼€äº‹åŠ¡å’Œè¿æ¥ï¼Œé‚£ä¹ˆè‚¯å®šç”¨å½“å‰çº¿ç¨‹ä¿å­˜äº†è¿™äº›èµ„æºã€‚</p>
<h2 id="JPA-é‡Œé¢çš„-open-in-view-æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"><a href="#JPA-é‡Œé¢çš„-open-in-view-æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ" class="headerlink" title="JPA é‡Œé¢çš„ open-in-view æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"></a>JPA é‡Œé¢çš„ open-in-view æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h2><p>open-in-view æ˜¯ Spring Boot è‡ªåŠ¨åŠ è½½ Spring Data JPA æä¾›çš„ä¸€ä¸ªé…ç½®ï¼Œå…¨ç§°ä¸º spring.jpa.open-in-view=trueï¼Œå®ƒåªæœ‰ true å’Œ false ä¸¤ä¸ªå€¼ï¼Œé»˜è®¤æ˜¯ trueã€‚</p>
<h3 id="open-in-view-çš„ä½œç”¨"><a href="#open-in-view-çš„ä½œç”¨" class="headerlink" title="open-in-view çš„ä½œç”¨"></a>open-in-view çš„ä½œç”¨</h3><p>åœ¨ <code>JpaBaseConfiguration</code> ä¸­æ‰¾åˆ°å…³é”®æºç ï¼Œé€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ open-in-view éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaBaseConfiguration</span> <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(WebMvcConfigurer.class)</span></span><br><span class="line"><span class="comment">//è¿™ä¸ªæä¾›äº†ä¸€ç§è‡ªå®šä¹‰æ³¨å†Œ OpenEntityManagerInViewInterceptor æˆ–è€… OpenEntityManagerInViewFilter çš„å¯èƒ½ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ Web çš„ MVC å±‚æ‰“å¼€ session çš„ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ Interceptorï¼Œå¦å¤–ä¸€ç§æ˜¯ Filterï¼›è¿™ä¸¤ä¸ªç±»ä»»é€‰å…¶ä¸€å³å¯ï¼Œé»˜è®¤ç”¨çš„æ˜¯ OpenEntityManagerInViewInterceptor.class;</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; OpenEntityManagerInViewInterceptor.class, OpenEntityManagerInViewFilter.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingFilterBean(OpenEntityManagerInViewFilter.class)</span></span><br><span class="line"><span class="comment">//è¿™é‡Œä½¿ç”¨äº† spring.jpa.open-in-view çš„é…ç½®ï¼Œåªæœ‰ä¸º true çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œè¿™ä¸ªé…ç½®ç±»ï¼Œå½“ä»€ä¹ˆéƒ½æ²¡é…ç½®çš„æ—¶å€™ï¼Œé»˜è®¤å°±æ˜¯ trueï¼Œä¹Ÿå°±æ˜¯é»˜è®¤æ­¤é…ç½®æ–‡ä»¶å°±ä¼šè‡ªåŠ¨åŠ è½½ï¼›æˆ‘ä»¬å¯ä»¥è®¾ç½®æˆ falseï¼Œå…³é—­åŠ è½½ï¼›</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;spring.jpa&quot;, name = &quot;open-in-view&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaWebConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(JpaWebConfiguration.class);</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> JpaProperties jpaProperties;</span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">JpaWebConfiguration</span><span class="params">(JpaProperties jpaProperties)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.jpaProperties = jpaProperties;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//å…³é”®é€»è¾‘åœ¨ OpenEntityManagerInViewInterceptor ç±»é‡Œé¢ï¼›åŠ è½½ OpenEntityManagerInViewInterceptor ç”¨æ¥åœ¨MVCçš„æ‹¦æˆªå™¨é‡Œé¢æ‰“å¼€ EntityManagerï¼Œè€Œå½“æˆ‘ä»¬æ²¡æœ‰é…ç½® spring.jpa.open-in-view çš„æ—¶å€™ï¼Œçœ‹ä¸‹é¢ä»£ç  spring å®¹å™¨ä¼šæ‰“å° warn æ—¥å¿—è­¦å‘Šæˆ‘ä»¬ï¼Œé»˜è®¤å¼€å¯äº† open-in-viewï¼Œæé†’æˆ‘ä»¬éœ€è¦æ³¨æ„å½±å“é¢ã€‚</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> OpenEntityManagerInViewInterceptor <span class="title">openEntityManagerInViewInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.jpaProperties.getOpenInView() == <span class="keyword">null</span>) &#123;</span><br><span class="line">         logger.warn(<span class="string">&quot;spring.jpa.open-in-view is enabled by default. &quot;</span></span><br><span class="line">               + <span class="string">&quot;Therefore, database queries may be performed during view &quot;</span></span><br><span class="line">               + <span class="string">&quot;rendering. Explicitly configure spring.jpa.open-in-view to disable this warning&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> OpenEntityManagerInViewInterceptor();</span><br><span class="line">   &#125; </span><br><span class="line">  <span class="comment">//åˆ©ç”¨ WebMvcConfigurer åŠ è½½ä¸Šé¢çš„ OpenEntityManagerInViewInterceptor æ‹¦æˆªå™¨è¿›å…¥åˆ°MVCé‡Œé¢ï¼›</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">openEntityManagerInViewInterceptorConfigurer</span><span class="params">(  OpenEntityManagerInViewInterceptor interceptor)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">            registry.addWebRequestInterceptor(interceptor);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">.....<span class="comment">//å…¶ä»–ä¸é‡è¦çš„ä»£ç çœç•¥</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œspring.jpa.open-in-view çš„ä¸»è¦ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬åŠ è½½ <code>OpenEntityManagerInViewInterceptor</code> è¿™ä¸ªç±»</p>
<h3 id="OpenEntityManagerInViewInterceptor-æºç åˆ†æ"><a href="#OpenEntityManagerInViewInterceptor-æºç åˆ†æ" class="headerlink" title="OpenEntityManagerInViewInterceptor æºç åˆ†æ"></a>OpenEntityManagerInViewInterceptor æºç åˆ†æ</h3><p>æ‰“å¼€è¿™ä¸€æºç åï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾æ‰€ç¤ºçš„ç•Œé¢ã€‚</p>
<p><img src="http://image.leonote.cn/20210108145528.png" alt=""></p>
<p>å¯ä»¥å‘ç°ï¼Œ<code>OpenEntityManagerInViewInterceptor</code> å®ç°äº† <code>WebRequestInterceptor</code> çš„æ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><p>public void preHandle(WebRequest request) ï¼šé‡Œé¢å®ç°äº†åœ¨æ¯æ¬¡çš„ Web MVC è¯·æ±‚ä¹‹å‰ï¼Œé€šè¿‡ createEntityManager æ–¹æ³•åˆ›å»º EntityManager å’Œ EntityManagerHolder çš„é€»è¾‘ï¼›</p>
</li>
<li><p>public void afterCompletion(WebRequest request, @Nullable Exception ex) ï¼šé‡Œé¢å®ç°äº†åœ¨æ¯æ¬¡ Web MVC çš„è¯·æ±‚ç»“æŸä¹‹åï¼Œå…³é—­ EntityManager çš„é€»è¾‘ã€‚</p>
</li>
</ul>
<p>ç»§ç»­çœ‹ createEntityManager æ–¹æ³•çš„å®ç°ï¼Œæ‰¾åˆ°å¦‚ä¸‹å…³é”®ä»£ç ï¼š</p>
<p><img src="http://image.leonote.cn/20210108150225.png" alt=""></p>
<p>ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ <code>SessionFactoryImpl</code> ä¸­çš„ createEntityManager() æ–¹æ³•ï¼Œ</p>
<ol>
<li>åˆ›å»ºäº†ä¸€ä¸ª <code>EntityManager</code> çš„å®ç° Sessionï¼›</li>
<li>é€šè¿‡æ‹¦æˆªå™¨åˆ›å»ºäº† EntityManager äº‹åŠ¡å¤„ç†é€»è¾‘ï¼Œé»˜è®¤æ˜¯ Join ç±»å‹ï¼ˆå³æœ‰äº‹åŠ¡å­˜åœ¨ä¼šåŠ å…¥ï¼‰ï¼›</li>
<li>builder.openSession() é€»è¾‘å°±æ˜¯ new SessionImpl(sessionFactory, this)ã€‚</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼šé€šè¿‡ open-in-view é…ç½®çš„æ‹¦æˆªå™¨ï¼Œä¼šå¸®æˆ‘ä»¬çš„æ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºä¸€ä¸ª SessionImpl å®ä¾‹ï¼›è€Œ SessionImpl é‡Œé¢å­˜å‚¨äº†æ•´ä¸ª PersistenceContext å’Œå„ç§äº‹åŠ¡è¿æ¥çŠ¶æ€ï¼Œå¯ä»¥åˆ¤æ–­å‡ºæ¥ Session çš„å®ä¾‹å¯¹è±¡<strong>æ¯”è¾ƒå¤§</strong>ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ‰“å¼€ spring.jap.open-in-view=true ä¼šå‘ç°ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚å¤„ç†çš„é€»è¾‘æ¯”è¾ƒè€—æ—¶ï¼Œç‰µæ¶‰åˆ°çš„å¯¹è±¡æ¯”è¾ƒå¤šï¼Œè¿™ä¸ªæ—¶å€™å°±æ¯”è¾ƒè€ƒéªŒæˆ‘ä»¬å¯¹ jvm çš„å†…å­˜é…ç½®ç­–ç•¥äº†ï¼Œå¦‚æœé…ç½®ä¸å¥½å°±ä¼šç»å¸¸å‡ºç°å†…å­˜æº¢å‡ºçš„ç°è±¡ã€‚å› æ­¤å½“å¤„ç†æ¯”è¾ƒè€—æ—¶çš„è¯·æ±‚å’Œæ‰¹é‡å¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚</p>
</blockquote>
<h3 id="EntityManager-Session-çš„æ‰“å¼€æ—¶æœºåŠæ‰©å±•åœºæ™¯"><a href="#EntityManager-Session-çš„æ‰“å¼€æ—¶æœºåŠæ‰©å±•åœºæ™¯" class="headerlink" title="EntityManager(Session) çš„æ‰“å¼€æ—¶æœºåŠæ‰©å±•åœºæ™¯"></a>EntityManager(Session) çš„æ‰“å¼€æ—¶æœºåŠæ‰©å±•åœºæ™¯</h3><p>é€šè¿‡ IDEA ï¼Œç›´æ¥ç‚¹å‡»å³é”®æŸ¥ public Session createEntityManager() æ­¤æ–¹æ³•è¢«ä½¿ç”¨åˆ°çš„åœ°æ–¹å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20210108151000.png" alt=""></p>
<p>å…¶ä¸­ï¼Œ<code>EntityManagerFactoryAccessor</code> æ˜¯ <code>OpenEntityManagerInViewInterceptor</code> çš„çˆ¶ç±»ï¼Œä»å›¾ä¸Šå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼ŒSession çš„åˆ›å»ºï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯ EntityManager çš„åˆ›å»ºï¼‰å¯¹æˆ‘ä»¬æœ‰ç”¨çš„æ—¶æœºï¼Œç›®å‰å°±æœ‰ä¸‰ç§ã€‚</p>
<ul>
<li><p>ç¬¬ä¸€ç§ï¼šWeb View Interceptorï¼Œé€šè¿‡ spring.jpa.open-in-view æ§åˆ¶ã€‚</p>
</li>
<li><p>ç¬¬äºŒç§ï¼šWeb Filterï¼Œè¿™ç§æ–¹å¼æ˜¯ Spring ç»™æˆ‘ä»¬æä¾›çš„å¦å¤–ä¸€ç§åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚æœ‰äº›è€—æ—¶çš„ã€æ‰¹é‡å¤„ç†çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä¸æƒ³åœ¨è¯·æ±‚çš„æ—¶å€™å¼€å¯ Sessionï¼Œè€Œæ˜¯æƒ³åœ¨å¤„ç†ç®€å•é€»è¾‘åï¼Œéœ€è¦ç”¨åˆ°å»¶è¿ŸåŠ è½½æœºåˆ¶çš„è¯·æ±‚æ—¶ Open Sessionã€‚å› ä¸ºå¼€å¯ Session åï¼Œæˆ‘ä»¬å†™æ¡†æ¶ä»£ç çš„æ—¶å€™å¯ä»¥åˆ©ç”¨ lazy æœºåˆ¶ã€‚è€Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>OpenEntityManagerInViewFilter</code>ï¼Œé…ç½®è¯·æ±‚ filter çš„è¿‡æ»¤æœºåˆ¶ï¼Œå®ç°ä¸åŒçš„è¯·æ±‚ä»¥åŠä¸åŒ Open Session çš„é€»è¾‘äº†ã€‚</p>
</li>
<li><p>ç¬¬ä¸‰ç§ï¼šJPA Transactionï¼Œè¿™ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨ <code>JpaTransactionManager</code>ï¼Œå®ç°åœ¨äº‹åŠ¡å¼€å¯çš„æ—¶å€™æ‰“å¼€ Sessionï¼Œåœ¨äº‹åŠ¡ç»“æŸçš„æ—¶å€™å…³é—­ Sessionã€‚</p>
</li>
</ul>
<blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹</p>
<p>Session çš„å¼€å¯æ—¶æœºæœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>æ¯ä¸ªè¯·æ±‚ä¹‹å‰</li>
<li>æ–°çš„äº‹åŠ¡å¼€å¯ä¹‹å‰</li>
</ul>
<p>Session çš„å…³é—­æ—¶æœºæ˜¯ä¸¤ä¸ªï¼š</p>
<ul>
<li>æ¯ä¸ªè¯·æ±‚ç»“æŸä¹‹å</li>
<li>äº‹åŠ¡å…³é—­ä¹‹å</li>
</ul>
</blockquote>
<p>æ­¤å¤–ï¼Œ<strong>EntityManager(Session) æ‰“å¼€ä¹‹åï¼Œèµ„æºå­˜å‚¨åœ¨å½“å‰çº¿ç¨‹é‡Œé¢ ï¼ˆThreadLocal</strong>ï¼‰ï¼Œæ‰€ä»¥ä¸€ä¸ª Session ä¸­å³ä½¿å¼€å¯äº†å¤šä¸ªäº‹åŠ¡ï¼Œä¹Ÿä¸ä¼šåˆ›å»ºå¤šä¸ª EntityManager æˆ–è€… Sessionã€‚</p>
<p>è€Œäº‹åŠ¡åœ¨å…³é—­ä¹‹å‰ï¼Œä¹Ÿä¼šæ£€æŸ¥ä¸€ä¸‹æ­¤ EntityManager / Session æ˜¯ä¸æ˜¯æˆ‘è¿™ä¸ªäº‹åŠ¡åˆ›å»ºçš„ï¼Œå¦‚æœæ˜¯å°±å…³é—­ï¼Œå¦‚æœä¸æ˜¯å°±ä¸å…³é—­ï¼Œä¸è¿‡å…¶ä¸ä¼šå…³é—­åœ¨äº‹åŠ¡èŒƒå›´ä¹‹å¤–åˆ›å»ºçš„ EntityManager / Sessionã€‚</p>
<p>è¿™ä¸ªæœºåˆ¶å…¶å®è¿˜ç»™æˆ‘ä»¬ä¸€äº›é¢å¤–æ€è€ƒï¼šæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è‡ªç”±é€‰æ‹©å¼€å¯ / å…³é—­ Session å‘¢ï¼Ÿä¸ä¸€å®šæ˜¯ view / filter / äº‹åŠ¡ï¼Œä»»ä½•å¤šäº‹åŠ¡ç»„åˆçš„ä»£ç æ¨¡å—éƒ½å¯ä»¥ã€‚åªè¦æˆ‘ä»¬çŸ¥é“ä»€ä¹ˆæ—¶é—´å¼€å¯ï¼Œä¿è¯ä¸€å®šèƒ½ close å°±æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>ä¸‹é¢é€šè¿‡æ—¥å¿—æ¥çœ‹ä¸€ä¸‹ä¸¤ç§æ‰“å¼€ã€å…³é—­ EntityManager çš„æ—¶æœºã€‚</p>
<h3 id="éªŒè¯-EntityManager-çš„åˆ›å»ºå’Œé‡Šæ”¾çš„æ—¥å¿—"><a href="#éªŒè¯-EntityManager-çš„åˆ›å»ºå’Œé‡Šæ”¾çš„æ—¥å¿—" class="headerlink" title="éªŒè¯ EntityManager çš„åˆ›å»ºå’Œé‡Šæ”¾çš„æ—¥å¿—"></a>éªŒè¯ EntityManager çš„åˆ›å»ºå’Œé‡Šæ”¾çš„æ—¥å¿—</h3><p>ç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ª UserController çš„æ–¹æ³•ï¼Œç”¨æ¥æ¨¡æ‹Ÿè¯·æ±‚ä¸¤æ®µäº‹åŠ¡çš„æƒ…å†µï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/user/info&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">saveUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">   UserInfo u2 = userInfoRepository.findById(<span class="number">1L</span>).orElse(<span class="keyword">null</span>);</span><br><span class="line">   <span class="keyword">if</span> (u2!=<span class="keyword">null</span>) &#123;</span><br><span class="line">      u2.setLastName(<span class="string">&quot;jack&quot;</span>+userInfo.getLastModifiedTime());</span><br><span class="line">      <span class="comment">//æ›´æ–°u2ï¼Œæ–°å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">      userInfoRepository.save(u2);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//æ›´æ–°userInfoï¼Œæ–°å¼€å¯ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.save(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢è°ƒç”¨äº†ä¸¤ä¸ª save æ“ä½œï¼Œæ²¡æœ‰æŒ‡å®šäº‹åŠ¡ã€‚å› ä¸º userInfoRepository çš„å®ç°ç±» SimpleJpaRepository çš„ save æ–¹æ³•ä¸Šé¢æœ‰ @Transactional æ³¨è§£ï¼Œæ‰€ä»¥æ¯ä¸ª userInfoRepository.save() æ–¹æ³•å°±ä¼šå¼€å¯æ–°çš„äº‹åŠ¡ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæœºåˆ¶åœ¨ä¸Šé¢çš„ Controller é‡Œé¢æ¨¡æ‹Ÿäº†ä¸¤ä¸ªäº‹åŠ¡ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šæ‰“å¼€ open-in-viewï¼ŒåŒæ—¶ä¿®æ”¹ä¸€äº›æ—¥å¿—çº§åˆ«ï¼Œæ–¹ä¾¿è§‚å¯Ÿï¼Œé…ç½®å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## æ‰“å¼€open-in-view</span></span><br><span class="line"><span class="meta">spring.jpa.open-in-view</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">## ä¿®æ”¹æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.orm.jpa.JpaTransactionManager</span>=<span class="string">trace</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.internal</span>=<span class="string">trace</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.engine.transaction.internal</span>=<span class="string">trace</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨é¡¹ç›®ï¼Œå‘é€å¦‚ä¸‹è¯·æ±‚ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#### update</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/user/info</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8087</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line">&#123;&quot;ages&quot;:10,&quot;id&quot;:3,&quot;version&quot;:0&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŸ¥çœ‹ä¸€ä¸‹æ—¥å¿—ï¼Œå…³é”®æ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210108151724.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¯·æ±‚äº† user/info ä¹‹åå°±å¼€å¯äº† Sessionï¼Œç„¶ååœ¨ Controller æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¼€å¯äº†ä¸¤æ®µäº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡ç»“æŸä¹‹åéƒ½æ²¡æœ‰å…³é—­ Sessionï¼Œè€Œæ˜¯ç­‰ä¸¤ä¸ªäº‹åŠ¡éƒ½ç»“æŸä¹‹åï¼Œå¹¶ä¸” Controller æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ‰ Closing Session çš„ã€‚ä¸­é—´è¿‡ç¨‹åªåˆ›å»ºäº†ä¸€æ¬¡ Sessionã€‚</p>
<p>ç¬¬å››æ­¥ï¼šå…¶ä»–éƒ½ä¸å˜çš„å‰æä¸‹ï¼Œæˆ‘ä»¬æŠŠ open-in-view æ”¹æˆ falseï¼Œå¦‚ä¸‹é¢è¿™è¡Œä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.jpa.open-in-view</span>=<span class="string">false</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ‰§è¡Œåˆšæ‰çš„è¯·æ±‚ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20210108151941.png" alt=""></p>
<p>é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­å¼€å¯äº†ä¸¤æ¬¡äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡åˆ›å»ºä¹‹åéƒ½ä¼šåˆ›å»ºä¸€ä¸ª Sessionï¼Œå³å¼€å¯äº†ä¸¤ä¸ª Sessionï¼Œæ¯ä¸ª Session çš„ ID æ˜¯ä¸ä¸€æ ·çš„ï¼›åœ¨æ¯ä¸ªäº‹åŠ¡ç»“æŸä¹‹åå…³é—­äº† Sessionï¼Œå…³é—­äº† EntityManagerã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„äº‹ä¾‹å’Œæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° spring.jpa.open-in-view å¯¹ session å’Œäº‹åŠ¡çš„å½±å“ï¼Œé‚£ä¹ˆå®ƒå¯¹æ•°æ®åº“çš„è¿æ¥æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ</p>
<h2 id="hibernate-connection-handling-mode-è¯¦è§£"><a href="#hibernate-connection-handling-mode-è¯¦è§£" class="headerlink" title="hibernate.connection.handling_mode è¯¦è§£"></a>hibernate.connection.handling_mode è¯¦è§£</h2><p>AvailableSettings ç±»ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä¸‰ä¸ªå…³é”®é…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šè·å¾— db è¿æ¥çš„æ–¹å¼ï¼Œhibernate5.2 ä¹‹åå·²ç»ä¸æ¨èä½¿ç”¨ï¼Œæ”¹ç”¨ hibernate.connection.handling_mode é…ç½®å½¢å¼</span></span><br><span class="line">String ACQUIRE_CONNECTIONS = <span class="string">&quot;hibernate.connection.acquisition_mode&quot;</span>;</span><br><span class="line"><span class="comment">// é‡Šæ”¾è¿æ¥çš„æ¨¡å¼æœ‰å“ªäº›ï¼Ÿhibernate5.2 ä¹‹åä¹Ÿä¸æ¨èä½¿ç”¨ï¼Œæ”¹ç”¨ hibernate.connection.handling_mode é…ç½®å½¢å¼</span></span><br><span class="line">String RELEASE_CONNECTIONS = <span class="string">&quot;hibernate.connection.release_mode&quot;</span>;</span><br><span class="line"><span class="comment">//æŒ‡å®šè·å–è¿æ¥å’Œé‡Šæ”¾è¿æ¥çš„æ¨¡å¼ï¼Œhibernate5.2 ä¹‹åæ–°å¢çš„é…ç½®é¡¹ï¼Œä»£æ›¿ä¸Šé¢ä¸¤ä¸ªæ—§çš„é…ç½®</span></span><br><span class="line">String CONNECTION_HANDLING = <span class="string">&quot;hibernate.connection.handling_mode&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆ hibernate.connection.handling_mode å¯¹åº”çš„é…ç½®æœ‰å“ªäº›å‘¢ï¼ŸHibernate 5 æä¾›äº†äº”ç§æ¨¡å¼ã€‚</p>
<h3 id="PhysicalConnectionHandlingMode-çš„äº”ç§æ¨¡å¼"><a href="#PhysicalConnectionHandlingMode-çš„äº”ç§æ¨¡å¼" class="headerlink" title="PhysicalConnectionHandlingMode çš„äº”ç§æ¨¡å¼"></a>PhysicalConnectionHandlingMode çš„äº”ç§æ¨¡å¼</h3><p>åœ¨ Hibernate 5.2 é‡Œé¢ï¼Œhibernate.connection.handling_mode è¿™ä¸ª Key å¯¹åº”çš„å€¼åœ¨ <code>PhysicalConnectionHandlingMode</code> æšä¸¾ç±»é‡Œé¢æœ‰å®šä¹‰ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">PhysicalConnectionHandlingMode</span> </span>&#123;</span><br><span class="line">   IMMEDIATE_ACQUISITION_AND_HOLD( IMMEDIATELY, ON_CLOSE ),</span><br><span class="line">   DELAYED_ACQUISITION_AND_HOLD( AS_NEEDED, ON_CLOSE ),</span><br><span class="line">   DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT( AS_NEEDED, AFTER_STATEMENT ),</span><br><span class="line">   DELAYED_ACQUISITION_AND_RELEASE_BEFORE_TRANSACTION_COMPLETION( AS_NEEDED, BEFORE_TRANSACTION_COMPLETION ),</span><br><span class="line">   DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION( AS_NEEDED, AFTER_TRANSACTION )</span><br><span class="line">   ;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ConnectionAcquisitionMode acquisitionMode;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ConnectionReleaseMode releaseMode;</span><br><span class="line">   PhysicalConnectionHandlingMode(</span><br><span class="line">      ConnectionAcquisitionMode acquisitionMode,</span><br><span class="line">      ConnectionReleaseMode releaseMode) &#123;</span><br><span class="line">      <span class="keyword">this</span>.acquisitionMode = acquisitionMode;</span><br><span class="line">      <span class="keyword">this</span>.releaseMode = releaseMode;</span><br><span class="line">   &#125;</span><br><span class="line">......<span class="comment">//ä¸é‡è¦ä»£ç å…ˆçœç•¥&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰äº”ç»„å€¼ï¼Œä¹Ÿå°±æ˜¯æŠŠåŸæ¥çš„ ConnectionAcquisitionMode å’Œ ConnectionReleaseMode åˆ†å¼€é…ç½®çš„æ¨¡å¼è¿›è¡Œäº†ç»„åˆé…ç½®ç®¡ç†</p>
<p><strong>IMMEDIATE_ACQUISITION_AND_HOLDï¼šç«‹å³è·å–ï¼Œä¸€ç›´ä¿æŒè¿æ¥åˆ° Session å…³é—­ã€‚</strong> å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š</p>
<ul>
<li><p>Session ä¸€æ—¦æ‰“å¼€å°±ä¼šè·å–è¿æ¥ï¼›</p>
</li>
<li><p>Session å…³é—­çš„æ—¶å€™é‡Šæ”¾è¿æ¥ï¼›</p>
</li>
</ul>
<ul>
<li><p>å¦‚æœ open-in-view=true çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬çš„è¯·æ±‚é‡Œé¢æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œæˆ–è€…æœ‰ä¸€äº›è€—æ—¶æ“ä½œï¼Œä¼šå¯¼è‡´æ•°æ®åº“çš„è¿æ¥é‡Šæ”¾ä¸åŠæ—¶ï¼Œä»è€Œå¯¼è‡´ DB è¿æ¥ä¸å¤Ÿç”¨ï¼Œå¦‚æœè¯·æ±‚é¢‘ç¹çš„è¯ï¼Œä¼šäº§ç”Ÿä¸å¿…è¦çš„ DB è¿æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæµªè´¹ CPU æ€§èƒ½ï¼›</p>
</li>
<li><p><em>å®¹æ˜“äº§ç”Ÿ DB è¿æ¥è·å–æ—¶é—´è¿‡é•¿çš„ç°è±¡ï¼Œä»è€Œå¯¼è‡´è¯·æ±‚å“åº”æ—¶é—´å˜é•¿</em>ã€‚</p>
</li>
</ul>
<p><strong>DELAYED_ACQUISITION_AND_HOLDï¼šå»¶è¿Ÿè·å–ï¼Œä¸€ç›´ä¿æŒè¿æ¥åˆ° Session å…³é—­ã€‚</strong> å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š</p>
<ul>
<li><p>è¡¨ç¤ºéœ€è¦çš„æ—¶å€™å†è·å–è¿æ¥ï¼Œéœ€è¦çš„æ—¶å€™æ˜¯æŒ‡è¿›è¡Œ DB æ“ä½œçš„æ—¶å€™ï¼Œè¿™é‡Œä¸»è¦æ˜¯æŒ‡äº‹åŠ¡æ‰“å¼€çš„æ—¶å€™ï¼Œå°±éœ€è¦è·å–è¿æ¥äº†ï¼ˆå› ä¸ºå¼€å¯äº‹åŠ¡çš„æ—¶å€™è¦æ‰§è¡Œâ€œAUTOCOMMIT=0â€çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œçš„æŒ‰éœ€å°±æ˜¯æŒ‡å¼€å¯äº‹åŠ¡ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥å…³é—­äº‹åŠ¡å¼€å¯çš„æ—¶å€™æ”¹å˜ AUTOCOMMIT çš„è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™çš„æŒ‰éœ€å°±æ˜¯æŒ‡æ‰§è¡Œ DB æ“ä½œçš„æ—¶å€™ï¼Œä¸ä¸€å®šå¼€å¯äº‹åŠ¡å°±ä¼šè·å¾— DB çš„è¿æ¥ï¼‰ï¼›</p>
</li>
<li><p>å…³é—­è¿æ¥çš„æ—¶æœºæ˜¯ Session Close çš„æ—¶å€™ï¼›</p>
</li>
<li><p>ä¸€ä¸ª Session é‡Œé¢åªæœ‰ä¸€ä¸ªè¿æ¥ï¼Œè€Œä¸€ä¸ªè¿æ¥é‡Œé¢å¯ä»¥æœ‰å¤šæ®µäº‹åŠ¡ï¼›æ¯”è¾ƒé€‚åˆä¸€ä¸ªè¯·æ±‚æœ‰å¤šæ®µäº‹åŠ¡çš„åœºæ™¯ï¼›</p>
</li>
<li><p>è¿™ä¸ªé…ç½®è§£å†³äº†ï¼Œå½“æ²¡æœ‰ DB æ“ä½œçš„æ—¶å€™ï¼Œå³æ²¡æœ‰äº‹åŠ¡çš„æ—¶å€™ä¸ä¼šè·å–æ•°æ®åº“è¿æ¥çš„é—®é¢˜ï¼›ä»è€Œå¯ä»¥å‡å°‘ä¸å¿…è¦çš„ DB è¿æ¥åˆ‡æ¢ï¼›</p>
</li>
<li><p>ä½†æ˜¯ä¸€æ—¦ä¸€ä¸ª Session åœ¨è¿›è¡Œäº† DB æ“ä½œä¹‹åï¼Œåˆåšäº†ä¸€äº›è€—æ—¶çš„æ“ä½œæ‰å…³é—­ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¯¼è‡´ DB è¿æ¥é‡Šæ”¾ä¸åŠæ—¶ï¼Œä»è€Œå¯¼è‡´ DB è¿æ¥çš„åˆ©ç”¨ç‡ä½ã€é«˜å¹¶å‘çš„æ—¶å€™è¯·æ±‚æ€§èƒ½ä¸‹é™ã€‚</p>
</li>
</ul>
<p><strong>DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENTï¼šå»¶è¿Ÿè·å–ï¼ŒStatement æ‰§è¡Œå®Œé‡Šæ”¾ã€‚</strong> å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š</p>
<ul>
<li><p>è¡¨ç¤ºç­‰éœ€è¦çš„æ—¶å€™å†è·å–è¿æ¥ï¼Œä¸æ˜¯ Session ä¸€æ‰“å¼€å°±ä¼šè·å–è¿æ¥ï¼›</p>
</li>
<li><p>åœ¨æ¯ä¸ª Statement çš„ SQL æ‰§è¡Œå®Œå°±é‡Šæ”¾è¿æ¥ï¼Œä¸€æ—¦æœ‰äº‹åŠ¡æ¯ä¸ª SQL æ‰§è¡Œå®Œé‡Šæ”¾æ»¡è¶³ä¸äº†ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„äº‹åŠ¡æ¨¡å¼å°±ä¸ç”Ÿæ•ˆäº†ï¼›</p>
</li>
<li><p>è¿™ç§æ–¹å¼é€‚åˆæ²¡æœ‰äº‹åŠ¡çš„æƒ…æ™¯ï¼Œå·¥ä½œä¸­ä¸å¸¸è§ï¼Œå¯èƒ½åˆ†å¸ƒå¼äº‹åŠ¡ä¸­æœ‰åœºæ™¯éœ€è¦ã€‚</p>
</li>
</ul>
<p><strong>DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTIONï¼šå»¶è¿Ÿè·å–ï¼Œäº‹åŠ¡æ‰§è¡Œä¹‹åé‡Šæ”¾ã€‚</strong> å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š</p>
<ul>
<li><p>è¡¨ç¤ºç­‰éœ€è¦çš„æ—¶å€™å†è·å–è¿æ¥ï¼Œä¸æ˜¯ Session ä¸€æ‰“å¼€å°±ä¼šè·å–è¿æ¥ï¼›</p>
</li>
<li><p>åœ¨äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åé‡Šæ”¾è¿æ¥ï¼ŒåŒä¸€ä¸ªäº‹åŠ¡å…±äº«ä¸€ä¸ªè¿æ¥ï¼›</p>
</li>
<li><p>è¿™ç§æƒ…å†µä¸‹ open-in-view çš„æ¨¡å¼å¯¹ DB è¿æ¥çš„æŒæœ‰å’Œäº‹åŠ¡ä¸€æ ·äº†ï¼Œæ¯”è¾ƒé€‚åˆä¸€ä¸ªè¯·æ±‚é‡Œé¢äº‹åŠ¡æ¨¡å—ä¸å¤šè¯·æ±‚çš„æƒ…å†µï¼›</p>
</li>
<li><p>å¦‚æœäº‹åŠ¡éƒ½æ§åˆ¶åœ¨ Service å±‚ï¼Œè¿™ä¸ªé…ç½®å°±éå¸¸å¥½ç”¨ï¼Œå…¶å¯¹ Connection çš„åˆ©ç”¨ç‡æ¯”è¾ƒé«˜ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åšåˆ°ä¸æµªè´¹ï¼›</p>
</li>
<li><p>è¿™ä¸ªé…ç½®ä¸é€‚åˆä¸€ä¸ª Session ç”Ÿå‘½å‘¨æœŸé‡Œé¢æœ‰å¾ˆå¤šç‹¬ç«‹äº‹åŠ¡çš„ä¸šåŠ¡æ¨¡å—ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šä½¿ä¸€ä¸ªè¯·æ±‚é‡Œé¢äº§ç”Ÿå¤§é‡æ²¡å¿…è¦çš„è·å–è¿æ¥ã€é‡Šæ”¾è¿æ¥çš„è¿‡ç¨‹ã€‚</p>
</li>
</ul>
<p><strong>DELAYED_ACQUISITION_AND_RELEASE_BEFORE_TRANSACTION_COMPLETIONï¼šå»¶è¿Ÿè·å–ï¼Œäº‹åŠ¡æ‰§è¡Œä¹‹å‰é‡Šæ”¾ã€‚</strong> å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š</p>
<ul>
<li><p>è¡¨ç¤ºç­‰éœ€è¦çš„æ—¶å€™å†è·å–è¿æ¥ï¼Œä¸æ˜¯ Session ä¸€æ‰“å¼€å°±ä¼šè·å–è¿æ¥ï¼›</p>
</li>
<li><p>åœ¨äº‹åŠ¡æ‰§è¡Œå®Œä¹‹å‰é‡Šæ”¾è¿æ¥ï¼Œè¿™ç§ä¸ä¿é™©ï¼Œä¹Ÿæ¯”è¾ƒå°‘ç”¨ã€‚</p>
</li>
</ul>
<h3 id="é»˜è®¤çš„æ¨¡å¼æ˜¯å“ªä¸ªï¼Ÿå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼ï¼Ÿ"><a href="#é»˜è®¤çš„æ¨¡å¼æ˜¯å“ªä¸ªï¼Ÿå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼ï¼Ÿ" class="headerlink" title="é»˜è®¤çš„æ¨¡å¼æ˜¯å“ªä¸ªï¼Ÿå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼ï¼Ÿ"></a>é»˜è®¤çš„æ¨¡å¼æ˜¯å“ªä¸ªï¼Ÿå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼ï¼Ÿ</h3><p>æ‰“å¼€æºç  <code>HibernateJpaVendorAdapter</code> ç±»é‡Œé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹åŠ è½½æ–¹å¼ã€‚</p>
<p><img src="http://image.leonote.cn/20210108153036.png" alt=""></p>
<p>Hibernate 5.2 ä»¥ä¸Šä½¿ç”¨çš„æ˜¯ DELAYED_ACQUISITION_AND_HOLD æ¨¡å¼ï¼Œå³æŒ‰éœ€è·å–ã€Session å…³é—­é‡Šæ”¾ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jpaProperties.put(<span class="string">&quot;hibernate.connection.handling_mode&quot;</span>, <span class="string">&quot;DELAYED_ACQUISITION_AND_HOLD&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è€Œ Hibernate 5.1 ä»¥å‰æ˜¯é€šè¿‡è®¾ç½® release_mode ç­‰äº ON_CLOSE çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯ Session å…³é—­é‡Šæ”¾ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jpaProperties.put(<span class="string">&quot;hibernate.connection.release_mode&quot;</span>, <span class="string">&quot;ON_CLOSE&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆï¼Œå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼å‘¢ï¼Ÿç›´æ¥åœ¨ application.properties æ–‡ä»¶é‡Œé¢åšå¦‚ä¸‹ä¿®æ”¹å³å¯ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆæŒ‰éœ€è·å–è¿æ¥ï¼Œäº‹åŠ¡æ‰§è¡Œå®Œä¹‹åé‡Šæ”¾è¿æ¥</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.connection.handling_mode</span>=<span class="string">DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION</span></span><br></pre></td></tr></table></figure>

<h3 id="handling-mode-çš„é…ç½®å¯¹è¿æ¥çš„å½±å“"><a href="#handling-mode-çš„é…ç½®å¯¹è¿æ¥çš„å½±å“" class="headerlink" title="handling_mode çš„é…ç½®å¯¹è¿æ¥çš„å½±å“"></a>handling_mode çš„é…ç½®å¯¹è¿æ¥çš„å½±å“</h3><p>ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä¸€ä¸‹ DELAYED_ACQUISITION_AND_HOLDï¼Œå³é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿æ¥æ± çš„æƒ…å†µæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯¹é…ç½®æ–‡ä»¶åšå¦‚ä¸‹é…ç½®ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">## åœ¨æ‹¦æˆªMVCå±‚å¼€å¯ Sessionï¼Œæ¨¡æ‹Ÿé»˜è®¤æƒ…å†µï¼Œè¿™æ¡å¯ä»¥ä¸éœ€è¦é…ç½®</span></span><br><span class="line"><span class="meta">spring.jpa.open-in-view</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">## é‡‡ç”¨é»˜è®¤æƒ…å†µ DELAYED_ACQUISITION_AND_HOLDï¼Œè¿™æ¡ä¹Ÿä¸éœ€è¦é…ç½®</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.connection.handling_mode</span>=<span class="string">DELAYED_ACQUISITION_AND_HOLD</span></span><br><span class="line"><span class="comment">## å¼€å¯ hikari çš„æ•°æ®åº“è¿æ¥æ± çš„ç›‘æ§ï¼š</span></span><br><span class="line"><span class="meta">logging.level.com.zaxxer.hikari</span>=<span class="string">TRACE</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ UserInfoController çš„å¦‚ä¸‹æ–¹æ³•é‡Œé¢ï¼Œé€šè¿‡ Thread.sleepï¼ˆ2 åˆ†é’Ÿï¼‰æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/user/info&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">saveUserInfo</span><span class="params">(<span class="meta">@RequestBody</span> UserInfo userInfo)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">   UserInfo u2 = userInfoRepository.findById(<span class="number">1L</span>).orElse(<span class="keyword">null</span>);</span><br><span class="line">   <span class="keyword">if</span> (u2!=<span class="keyword">null</span>) &#123;</span><br><span class="line">      u2.setLastName(<span class="string">&quot;jack&quot;</span>+userInfo.getLastModifiedTime());</span><br><span class="line">      userInfoRepository.save(u2);</span><br><span class="line">      System.out.println(<span class="string">&quot;æ¨¡æ‹Ÿäº‹åŠ¡æ‰§è¡Œå®Œä¹‹åè€—æ—¶æ“ä½œ........&quot;</span>);</span><br><span class="line">      Thread.sleep(<span class="number">1000</span>*<span class="number">60</span>*<span class="number">2L</span>);</span><br><span class="line">      System.out.println(<span class="string">&quot;è€—æ—¶æ“ä½œæ‰§è¡Œå®Œæ¯•.......&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.save(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®å¯åŠ¨ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹è¯·æ±‚ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">#### update</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/user/info</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8087</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line">&#123;&quot;ages&quot;:10,&quot;id&quot;:3,&quot;version&quot;:0&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™æ‰“å¼€æ—¥å¿—æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20210108153456.png" alt=""></p>
<p>åœ¨ save ä¹‹åï¼Œå³äº‹åŠ¡æäº¤ä¹‹åï¼ŒHikariPool é‡Œé¢çš„æ•°æ®åº“è¿æ¥ä¸€ç›´æ²¡æœ‰å½’è¿˜ï¼Œè€Œå¦‚æœæˆ‘ä»¬ç»§ç»­ç­‰å¾…çš„è¯ï¼Œåœ¨æ•´ä¸ª Session å…³é—­ä¹‹åï¼Œæ•°æ®åº“è¿æ¥æ‰ä¼šå½’è¿˜åˆ°è¿æ¥æ± é‡Œé¢ã€‚</p>
<p>è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å®é™…å·¥ä½œä¸­æœ‰è¿™æ ·çš„è€—æ—¶æ“ä½œï¼Œæ˜¯ä¸æ˜¯ç”¨ä¸äº†å‡ ä¸ªè¿™æ ·çš„è¯·æ±‚ï¼Œè¿æ¥æ± å°±ä¸å¤Ÿç”¨äº†ï¼Ÿä½†å…¶å®æ•°æ®åº“è¿æ¥æ²¡åšä»»ä½• DB ç›¸å…³çš„æ“ä½œï¼Œç™½ç™½è¢«æµªè´¹äº†ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šéªŒè¯ä¸€ä¸‹ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION æ¨¡å¼ã€‚</p>
<p>åªéœ€è¦å¯¹é…ç½®æ–‡ä»¶åšå¦‚ä¸‹ä¿®æ”¹ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.jpa.properties.hibernate.connection.handling_mode</span>=<span class="string">DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä»–ä»£ç éƒ½ä¸å˜ï¼Œæˆ‘ä»¬å†è¯·æ±‚åˆšæ‰çš„ API è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å¾—åˆ°å¦‚ä¸‹æ—¥å¿—ã€‚</p>
<p><img src="http://image.leonote.cn/20210108153632.png" alt=""></p>
<p>ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“æ‰§è¡Œå®Œ save(u2)ï¼Œäº‹åŠ¡æäº¤ä¹‹åï¼Œåšä¸€äº›è€—æ—¶æ“ä½œçš„æ—¶å€™ï¼Œå‘ç°æ­¤æ—¶æ•´ä¸ª Session ç”Ÿå‘½å‘¨æœŸæ˜¯æ²¡æœ‰æŒæœ‰æ•°æ®åº“è¿æ¥çš„ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ç»“æŸä¹‹åå°±è¿›è¡Œäº†é‡Šæ”¾ï¼Œè¿™æ ·å¤§å¤§æé«˜äº†æ•°æ®åº“è¿æ¥çš„åˆ©ç”¨ç‡ï¼Œå³ä½¿å¤§é‡è¯·æ±‚ä¹Ÿä¸ä¼šé€ æˆæ•°æ®åº“è¿æ¥ä¸å¤Ÿç”¨ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€äº› Hikari æ•°æ®æºè¿æ¥æ± ä¸‹ï¼Œ DB è¿æ¥è·å¾—çš„æ—¶é—´å‚è€ƒå€¼ã€‚</p>
<p>å…¶ä¸­ï¼Œå¯¹è¿æ¥çš„æ± çš„æŒæœ‰æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œå‡ ä¹ç›‘æ§ä¸åˆ° DB è¿æ¥ä¸å¤Ÿç”¨çš„æƒ…å†µã€‚</p>
<p><img src="http://image.leonote.cn/20210108154152.png" alt=""></p>
<p>å¯¹ DB è¿æ¥åˆ©ç”¨ç‡çš„ç›‘æ§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿æ¥çš„ Creationã€Acquire åŸºæœ¬ä¸Šæ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯è¿æ¥çš„ Usage &gt; 500ms å°±æœ‰äº›ä¸æ­£å¸¸äº†ï¼Œè¯´æ˜é‡Œé¢æœ‰ä¸€äº›è€—æ—¶æ“ä½œã€‚</p>
<p><img src="http://image.leonote.cn/20210108154259.png" alt=""></p>
<blockquote>
<p>ğŸ¯æ‰€ä»¥ï¼Œä¸€èˆ¬åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨ DELAYED_ACQUISITION_AND_HOLD å’Œ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION ä¹‹é—´åšé€‰æ‹©ï¼›é€šè¿‡æ—¥å¿—å’Œç›‘æ§ï¼Œä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ DELAYED_ACQUISITION_AND_HOLD æ¯”è¾ƒé€‚åˆä¸€ä¸ª Session é‡Œé¢æœ‰å¤§é‡äº‹åŠ¡çš„ä¸šåŠ¡åœºæ™¯ï¼Œè¿™æ ·ä¸ç”¨é¢‘ç¹åˆ‡æ¢æ•°æ®åº“è¿æ¥ã€‚</p>
<p>è€Œ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION æ¯”è¾ƒé€‚åˆæ—¥å¸¸çš„ API ä¸šåŠ¡è¯·æ±‚ï¼Œæ²¡æœ‰å¤§é‡çš„äº‹åŠ¡ï¼Œäº‹åŠ¡ç»“æŸå°±é‡Šæ”¾è¿æ¥çš„åœºæ™¯ã€‚</p>
</blockquote>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="Connection-å’Œ-Transaction-çš„å…³ç³»"><a href="#Connection-å’Œ-Transaction-çš„å…³ç³»" class="headerlink" title="Connection å’Œ Transaction çš„å…³ç³»"></a>Connection å’Œ Transaction çš„å…³ç³»</h3><ol>
<li><p>äº‹åŠ¡æ˜¯å»ºç«‹åœ¨ Connection ä¹‹ä¸Šçš„ï¼Œæ²¡æœ‰è¿æ¥å°±æ²¡æœ‰äº‹åŠ¡ã€‚</p>
</li>
<li><p>ä»¥ MySQL InnoDB ä¸ºä¾‹ï¼Œæ–°å¼€ä¸€ä¸ªè¿æ¥é»˜è®¤å¼€å¯äº‹åŠ¡ï¼Œé»˜è®¤æ¯ä¸ª SQL æ‰§è¡Œå®Œä¹‹åè‡ªåŠ¨æäº¤äº‹åŠ¡ã€‚</p>
</li>
<li><p>ä¸€ä¸ªè¿æ¥é‡Œé¢å¯ä»¥æœ‰å¤šæ¬¡ä¸²è¡Œçš„äº‹åŠ¡æ®µï¼›ä¸€ä¸ªäº‹åŠ¡åªèƒ½å±äºä¸€ä¸ª Connectionã€‚</p>
</li>
<li><p>äº‹åŠ¡ä¸äº‹åŠ¡ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œé‚£ä¹ˆè‡ªç„¶ä¸åŒè¿æ¥çš„ä¸åŒäº‹åŠ¡ä¹Ÿæ˜¯éš”ç¦»çš„ã€‚</p>
</li>
</ol>
<h3 id="EntityManagerã€Connection-å’Œ-Transaction-çš„å…³ç³»"><a href="#EntityManagerã€Connection-å’Œ-Transaction-çš„å…³ç³»" class="headerlink" title="EntityManagerã€Connection å’Œ Transaction çš„å…³ç³»"></a>EntityManagerã€Connection å’Œ Transaction çš„å…³ç³»</h3><ol>
<li><p>EntityManager é‡Œé¢æœ‰ DataSourceï¼Œå½“ EntityManager é‡Œé¢å¼€å¯äº‹åŠ¡çš„æ—¶å€™ï¼Œå…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹é‡Œé¢æ˜¯å¦æœ‰æ•°æ®åº“è¿æ¥ï¼Œå¦‚æœæœ‰ç›´æ¥ç”¨ã€‚</p>
</li>
<li><p>å¼€å¯äº‹åŠ¡ä¹‹å‰å…ˆå¼€å¯è¿æ¥ï¼›å…³é—­äº‹åŠ¡ï¼Œä¸ä¸€å®šå…³é—­è¿æ¥ã€‚</p>
</li>
<li><p>å¼€å¯ EntityManagerï¼Œä¸ä¸€å®šç«‹é©¬è·å¾—è¿æ¥ï¼›è·å¾—è¿æ¥ï¼Œä¸ä¸€å®šç«‹é©¬å¼€å¯äº‹åŠ¡ã€‚</p>
</li>
<li><p>å…³é—­ EntityManagerï¼Œä¸€å®šå…³é—­äº‹åŠ¡ï¼Œé‡Šæ”¾è¿æ¥ï¼›åä¹‹ä¸ç„¶ã€‚</p>
</li>
</ol>
<h3 id="Sessionã€EntityManagerã€Connection-å’Œ-Transaction-çš„å…³ç³»"><a href="#Sessionã€EntityManagerã€Connection-å’Œ-Transaction-çš„å…³ç³»" class="headerlink" title="Sessionã€EntityManagerã€Connection å’Œ Transaction çš„å…³ç³»"></a>Sessionã€EntityManagerã€Connection å’Œ Transaction çš„å…³ç³»</h3><ol>
<li>Session æ˜¯ EntityManager çš„å­ç±»ï¼ŒSessionImpl æ˜¯ Session å’Œ EntityManager çš„å®ç°ç±»ã€‚é‚£ä¹ˆè‡ªç„¶ EntityManager å’Œ Connectionã€Transaction çš„å…³ç³»åŒæ ·é€‚ç”¨ Sessionã€EntityManagerã€Connection å’Œ Transaction çš„å…³ç³»ã€‚</li>
<li>Session çš„ç”Ÿå‘½å‘¨æœŸå†³å®šäº† EntityManager çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ol>
<h3 id="Session-å’Œ-Transaction-çš„å…³ç³»"><a href="#Session-å’Œ-Transaction-çš„å…³ç³»" class="headerlink" title="Session å’Œ Transaction çš„å…³ç³»"></a>Session å’Œ Transaction çš„å…³ç³»</h3><ol>
<li><p>åœ¨ Hibernate çš„ JPA å®ç°é‡Œé¢ï¼Œå¼€å¯ Transaction ä¹‹å‰ï¼Œå¿…é¡»è¦å…ˆå¼€å¯ Sessionã€‚</p>
</li>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSession çš„ç”Ÿå‘½å‘¨æœŸç”± open-in-view å†³å®šæ˜¯è¯·æ±‚ä¹‹å‰å¼€å¯ï¼Œè¿˜æ˜¯äº‹åŠ¡ä¹‹å‰å¼€å¯ã€‚</p>
</li>
<li><p>äº‹åŠ¡å…³é—­äº†ï¼ŒSession ä¸ä¸€å®šå…³é—­ã€‚</p>
</li>
<li><p>Session å…³é—­äº†ï¼Œäº‹åŠ¡ä¸€å®šå…³é—­ã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•</title>
    <url>/2021/01/31/SpringDataJpa%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<h1 id="å¦‚ä½•åˆ©ç”¨å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è®©ä½ å¼€å‘æ•ˆç‡ç¿»å€ï¼Ÿ"><a href="#å¦‚ä½•åˆ©ç”¨å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è®©ä½ å¼€å‘æ•ˆç‡ç¿»å€ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ©ç”¨å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è®©ä½ å¼€å‘æ•ˆç‡ç¿»å€ï¼Ÿ"></a>å¦‚ä½•åˆ©ç”¨å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è®©ä½ å¼€å‘æ•ˆç‡ç¿»å€ï¼Ÿ</h1><p>Spring boot 2.1ï¼Œé‡Œé¢é»˜è®¤é›†æˆäº† junit5ï¼Œå…ˆä»æ•°æ®åº“å±‚å¼€å§‹</p>
<h2 id="Spring-Data-JPA-å•å…ƒæµ‹è¯•çš„æœ€ä½³å®è·µ"><a href="#Spring-Data-JPA-å•å…ƒæµ‹è¯•çš„æœ€ä½³å®è·µ" class="headerlink" title="Spring Data JPA å•å…ƒæµ‹è¯•çš„æœ€ä½³å®è·µ"></a>Spring Data JPA å•å…ƒæµ‹è¯•çš„æœ€ä½³å®è·µ</h2><h3 id="Spring-Data-JPA-Repository-çš„æµ‹è¯•ç”¨ä¾‹"><a href="#Spring-Data-JPA-Repository-çš„æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="Spring Data JPA Repository çš„æµ‹è¯•ç”¨ä¾‹"></a>Spring Data JPA Repository çš„æµ‹è¯•ç”¨ä¾‹</h3><p>ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ test çš„ä¾èµ–ï¼Œgradle çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">testImplementation <span class="string">&#x27;com.h2database:h2&#x27;</span></span><br><span class="line">testImplementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šåˆ©ç”¨é¡¹ç›®é‡Œé¢çš„å®ä½“å’Œ Repositoryï¼Œå‡è®¾é¡¹ç›®é‡Œé¢æœ‰ Address å’Œ AddressRepositoryï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Repositoryçš„DAOå±‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddressRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Address</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šæ–°å»º RepsitoryTestï¼Œ@DataJpaTest å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressRepository addressRepository;</span><br><span class="line">    <span class="comment">//æµ‹è¯•ä¸€ä¸‹ä¿å­˜å’ŒæŸ¥è¯¢</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Address address = Address.builder().city(<span class="string">&quot;shanghai&quot;</span>).build();</span><br><span class="line">        addressRepository.save(address);</span><br><span class="line">        List&lt;Address&gt; address1 = addressRepository.findAll();</span><br><span class="line">        address1.stream().forEach(address2 -&gt; System.out.println(address2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹å¯ä»¥çœ‹åˆ°ï¼Œç›´æ¥æ·»åŠ äº† <code>@DataJpaTest</code> æ³¨è§£ï¼Œç„¶ååˆ©ç”¨ Spring çš„æ³¨è§£ <code>@Autowired</code>ï¼Œå¼•å…¥äº† spring context é‡Œé¢ç®¡ç†çš„ AddressRepository å®ä¾‹ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨è¿™é‡Œé¢ä½¿ç”¨äº†é›†æˆæµ‹è¯•ï¼Œå³ç›´æ¥è¿æ¥çš„æ•°æ®åº“æ¥å®Œæˆæ“ä½œã€‚</p>
<p>ç¬¬å››æ­¥ï¼šç›´æ¥è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç»“æœã€‚</p>
<p><img src="http://image.leonote.cn//20210131101904.jpg" alt=""></p>
<p>é€šè¿‡æµ‹è¯•ç»“æœå¯ä»¥å‘ç°ï¼š</p>
<ol>
<li><p><strong>æµ‹è¯•æ–¹æ³•é»˜è®¤éƒ½ä¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œæµ‹è¯•å®Œäº†ä¹‹åå°±ä¼šè¿›è¡Œå›æ»š</strong>ï¼›</p>
</li>
<li><p>é‡Œé¢æ‰§è¡Œäº† insert å’Œ select ä¸¤ç§æ“ä½œï¼›</p>
</li>
<li><p>å¦‚æœå¼€å¯äº† Session Metrics çš„æ—¥å¿—çš„è¯ï¼Œä¹Ÿå¯ä»¥è§‚å¯Ÿå‡ºæ¥å…¶å‘ç”Ÿäº†ä¸€æ¬¡ connectionã€‚</p>
</li>
</ol>
<p>é€šè¿‡è¿™ä¸ªæ¡ˆä¾‹ï¼Œå¯ä»¥çŸ¥é“ Repository çš„æµ‹è¯•ç”¨ä¾‹å†™èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå…¶ä¸­ä¸»è¦åˆ©ç”¨äº† <code>@DataJpaTest</code> çš„æ³¨è§£ã€‚ä¸‹é¢æ‰“å¼€ <code>@DataJpaTest</code> çš„æºç ï¼Œçœ‹ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@BootstrapWith(DataJpaTestContextBootstrapper.class)</span> <span class="comment">//æµ‹è¯•ç¯å¢ƒçš„å¯åŠ¨æ–¹å¼</span></span><br><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span><span class="comment">//åŠ è½½äº†Springæµ‹è¯•ç¯å¢ƒ</span></span><br><span class="line"><span class="meta">@OverrideAutoConfiguration(enabled = false)</span></span><br><span class="line"><span class="meta">@TypeExcludeFilters(DataJpaTypeExcludeFilter.class)</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@AutoConfigureCache</span></span><br><span class="line"><span class="meta">@AutoConfigureDataJpa</span><span class="comment">//åŠ è½½äº†ä¾èµ–Spring Data JPAçš„åŸæœ‰é…ç½®</span></span><br><span class="line"><span class="meta">@AutoConfigureTestDatabase</span> <span class="comment">//åŠ è½½é»˜è®¤çš„æµ‹è¯•æ•°æ®åº“ï¼Œè¿™é‡Œé¢é‡‡ç”¨é»˜è®¤çš„H2</span></span><br><span class="line"><span class="meta">@AutoConfigureTestEntityManager</span><span class="comment">//åŠ è½½æµ‹è¯•æ‰€éœ€è¦çš„EntityManagerï¼Œä¸»è¦æ˜¯äº‹åŠ¡å¤„ç†æœºåˆ¶ä¸ä¸€æ ·</span></span><br><span class="line"><span class="meta">@ImportAutoConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataJpaTest &#123;</span><br><span class="line">   <span class="comment">//é»˜è®¤æ‰“å¼€sqlçš„æ§åˆ¶å°è¾“å‡º</span></span><br><span class="line">   <span class="meta">@PropertyMapping(&quot;spring.jpa.show-sql&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">showSql</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">......&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Repository-çš„æµ‹è¯•åœºæ™¯"><a href="#Repository-çš„æµ‹è¯•åœºæ™¯" class="headerlink" title="Repository çš„æµ‹è¯•åœºæ™¯"></a>Repository çš„æµ‹è¯•åœºæ™¯</h3><p>å¯èƒ½åœ¨å·¥ä½œä¸­ï¼Œæœ‰çš„åŒäº‹ä¼šè¯´æ²¡æœ‰å¿…è¦å†™ Repository çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå› ä¸ºå¥½å¤šæ–¹æ³•éƒ½æ˜¯æ¡†æ¶é‡Œé¢æä¾›çš„ï¼Œå†µä¸”è¿™ä¸ªä¸œè¥¿æ²¡æœ‰ä»€ä¹ˆé€»è¾‘ï¼Œå†™çš„æ—¶å€™æœ‰ç‚¹æµªè´¹æ—¶é—´ã€‚</p>
<p>å…¶å®ä¸ç„¶ï¼Œå¦‚æœèƒ½æŠŠ Repository çš„æµ‹è¯•ç”¨å†™å¥½çš„è¯ï¼Œè¿™å¯¹æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ç»å¯¹æ˜¯æœ‰æé«˜çš„ã€‚å¦åˆ™å½“ç»™ä½ ä¸€ä¸ªé¡¹ç›®ï¼Œè®©ä½ ç›´æ¥æ”¹é‡Œé¢çš„ä»£ç ï¼Œä½ å¯èƒ½å°±ä¼šæ¯”è¾ƒæ…Œï¼Œä¸æ•¢æ”¹ã€‚æ‰€æœ‰ä½ å°±è¦çŸ¥é“éƒ½æœ‰å“ªäº›åœºæ™¯æ˜¯å¿…é¡»è¦å†™ Repository çš„æµ‹è¯•ç”¨ä¾‹ã€‚</p>
<ul>
<li><p><strong>åœºæ™¯ä¸€</strong>ï¼šå½“æ–°å¢ä¸€ä¸ª Entity å’Œå®ä½“å¯¹åº”çš„ Repository çš„æ—¶å€™ï¼Œéœ€è¦å†™ä¸ªç®€å•çš„ save å’ŒæŸ¥è¯¢æµ‹è¯•ç”¨ä¾‹ï¼Œä¸»è¦ç›®çš„æ˜¯æ£€æŸ¥å®ä½“é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œå¦åˆ™å½“ä½ å†™äº†ä¸€å¤§å † Repository å’Œ Entity çš„æ—¶å€™ï¼Œå¯åŠ¨æŠ¥é”™ï¼Œä¸çŸ¥é“å“ªé‡Œé…ç½®å¾—æœ‰é—®é¢˜ï¼Œè¿™æ ·åè€Œä¼šé™ä½å¼€å‘æ•ˆç‡ï¼›</p>
</li>
<li><p><strong>åœºæ™¯äºŒ</strong>ï¼šå½“å®ä½“é‡Œé¢æœ‰ä¸€äº› POJO çš„é€»è¾‘ï¼Œæˆ–è€…æŸäº›å­—æ®µå¿…é¡»è¦æœ‰çš„æ—¶å€™ï¼Œå°±éœ€è¦å†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹ï¼Œå‡è®¾ Address å®ä½“é‡Œé¢ä¸éœ€è¦æœ‰ address å±æ€§å­—æ®µï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª @Transient çš„å­—æ®µå’Œè®¡ç®—é€»è¾‘ï¼Œè¿™æ—¶å°±éœ€è¦å†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹å»éªŒè¯ä¸€ä¸‹äº†ã€‚ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@JsonProperty(&quot;myCity&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="keyword">private</span> String address; <span class="comment">//å¿…è¦å­—æ®µ</span></span><br><span class="line">   <span class="meta">@Transient</span> <span class="comment">//éæ•°æ®åº“å­—æ®µï¼Œæœ‰ä¸€äº›ç®€å•è¿ç®—</span></span><br><span class="line">   <span class="keyword">private</span> String addressAndCity;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">getAddressAndCity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> address+<span class="string">&quot;ä¸€äº›ç®€å•é€»è¾‘&quot;</span>+city;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åœºæ™¯ä¸‰</strong>ï¼šå½“æœ‰è‡ªå®šä¹‰çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå°±å¯èƒ½éœ€è¦æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿”å›ç»“æœæ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddressRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Address</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">    <span class="function">Page&lt;Address&gt; <span class="title">findByAddress</span><span class="params">(<span class="meta">@Param(&quot;address&quot;)</span> String address, Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åœºæ™¯å››</strong>ï¼šå½“åˆ©ç”¨ @Query æ³¨è§£ï¼Œå†™äº†ä¸€äº› JPQL æˆ–è€… SQL çš„æ—¶å€™ï¼Œå°±éœ€è¦å†™ä¸€æ¬¡æµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddressRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Address</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡@Queryæ³¨è§£è‡ªå®šçš„JPQLæˆ–Navicat SQL</span></span><br><span class="line">    <span class="meta">@Query(value = &quot;FROM Address where deleted=false &quot;)</span></span><br><span class="line">    <span class="function">Page&lt;Address&gt; <span class="title">findAll</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå¯¹åº”çš„å¤æ‚ä¸€ç‚¹çš„æµ‹è¯•ç”¨ä¾‹å°±è¦å˜æˆå¦‚ä¸‹é¢è¿™æ®µä»£ç æ‰€ç¤ºçš„æ ·å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span></span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressRepository addressRepository;</span><br><span class="line">    <span class="meta">@BeforeAll</span> <span class="comment">//åˆ©ç”¨ @BeforeAllå‡†å¤‡ä¸€äº›Repositroyéœ€è¦çš„æµ‹æ•°æ®</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span><span class="comment">// ç”±äºæ¯ä¸ªæ–¹æ³•éƒ½æ˜¯æœ‰äº‹åŠ¡å›æ»šæœºåˆ¶çš„ï¼Œä¸ºäº†æµ‹è¯• Repository å¯èƒ½éœ€è¦æ¨¡æ‹Ÿä¸€äº›æ•°æ®ï¼Œæ‰€ä»¥æ”¹å˜å›æ»šæœºåˆ¶</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Address address = Address.builder().city(<span class="string">&quot;shanghaiDeleted&quot;</span>).deleted(<span class="keyword">true</span>).build();</span><br><span class="line">        addressRepository.save(address);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æµ‹è¯•æ²¡æœ‰åŒ…å«åˆ é™¤çš„è®°å½•</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">testFindAllNoDeleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Address&gt; address1 = addressRepository.findAll();</span><br><span class="line">        <span class="keyword">int</span> deleteSize = address1.stream().filter(d-&gt;d.equals(<span class="string">&quot;shanghaiDeleted&quot;</span>)).collect(Collectors.toList()).size();</span><br><span class="line">        Assertions.assertTrue(deleteSize==<span class="number">0</span>); <span class="comment">//æµ‹è¯•ä¸€ä¸‹ä¸åŒ…å«åˆ é™¤çš„æ¡æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åœºæ™¯äº”</strong>ï¼šå½“æµ‹è¯•ä¸€äº› JPA æˆ–è€… Hibernate çš„åº•å±‚ç‰¹æ€§çš„æ—¶å€™ï¼Œæµ‹è¯•ç”¨ä¾‹å¯ä»¥å¾ˆå¥½åœ°å¸®åŠ©æˆ‘ä»¬ã€‚å› ä¸ºå¦‚æœä¾èµ–é¡¹ç›®å¯åŠ¨æ¥åšæµ‹è¯•ï¼Œæ•ˆç‡å¤ªä½äº†ï¼Œä¾‹å¦‚ä¹‹å‰è®²çš„ä¸€äº› <code>@PersistenceContext</code> ç‰¹æ€§ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ç±»ä¼¼å¦‚ä¸‹çš„æµ‹è¯•ç”¨ä¾‹å®Œæˆæµ‹è¯•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span></span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@Import(TestConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">    <span class="comment">//æµ‹è¯•ä¸€äº›æ‰‹åŠ¨flushçš„æœºåˆ¶</span></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">            (properties = &#123;<span class="meta">@PersistenceProperty(</span></span><br><span class="line"><span class="meta">                    name = &quot;org.hibernate.flushMode&quot;,</span></span><br><span class="line"><span class="meta">                    value = &quot;MANUAL&quot;//æ‰‹åŠ¨flush</span></span><br><span class="line"><span class="meta">            )</span>&#125;)</span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeAll</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//æå‰å‡†å¤‡ä¸€äº›æ•°æ®æ–¹ä¾¿æµ‹è¯•</span></span><br><span class="line">        UserInfo u1 = UserInfo.builder().id(<span class="number">1L</span>).lastName(<span class="string">&quot;jack&quot;</span>).version(<span class="number">1</span>).build();</span><br><span class="line">        userInfoRepository.save(u1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLife</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo = UserInfo.builder().name(<span class="string">&quot;new name&quot;</span>).build();</span><br><span class="line">        <span class="comment">//æ–°å¢ä¸€ä¸ªå¯¹è±¡userInfoäº¤ç»™PersistenceContextç®¡ç†ï¼Œå³ä¸€çº§ç¼“å­˜</span></span><br><span class="line">        entityManager.persist(userInfo);</span><br><span class="line">        <span class="comment">//æ­¤æ—¶æ²¡æœ‰detachå’Œclearä¹‹å‰ï¼Œflushçš„æ—¶å€™è¿˜ä¼šäº§ç”Ÿæ›´æ–°SQL</span></span><br><span class="line">        userInfo.setName(<span class="string">&quot;old name&quot;</span>);</span><br><span class="line">        entityManager.flush();</span><br><span class="line">        entityManager.clear();</span><br><span class="line"><span class="comment">//        entityManager.detach(userInfo);</span></span><br><span class="line"><span class="comment">// 		  entityManagerå·²ç»clearï¼Œæ­¤æ—¶å·²ç»ä¸ä¼šå¯¹UserInfoè¿›è¡Œæ›´æ–°äº†</span></span><br><span class="line">        userInfo.setName(<span class="string">&quot;new name 11&quot;</span>);</span><br><span class="line">        entityManager.flush();</span><br><span class="line">        <span class="comment">//ç”±äºæœ‰cacheæœºåˆ¶ï¼Œç›¸åŒçš„å¯¹è±¡æŸ¥è¯¢åªä¼šè§¦å‘ä¸€æ¬¡æŸ¥è¯¢SQL</span></span><br><span class="line">        UserInfo u1 = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">        <span class="comment">//to do some thing</span></span><br><span class="line">        UserInfo u2 = userInfoRepository.findById(<span class="number">1L</span>).get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„åŒºåˆ«"><a href="#é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„åŒºåˆ«" class="headerlink" title="é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„åŒºåˆ«"></a>é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„åŒºåˆ«</h2><h3 id="ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•"><a href="#ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•" class="headerlink" title="ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•"></a>ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•</h3><p>é€šä¿—æ¥è®²ï¼Œå°±æ˜¯ä¸ä¾èµ–æœ¬ç±»ä¹‹å¤–çš„ä»»ä½•æ–¹æ³•å®Œæˆæœ¬ç±»é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•çš„æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ä¾èµ–æœ¬ç±»ä¹‹å¤–çš„ï¼Œéƒ½é€šè¿‡ Mock çš„æ–¹å¼è¿›è¡Œã€‚ã€‚</p>
<p><strong>Service å±‚å•å…ƒæµ‹è¯•</strong></p>
<p>é¦–å…ˆï¼Œæ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡ä¸­çš„ Service æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">   <span class="comment">//å‡è®¾æœ‰ä¸ª findByUserId çš„æ–¹æ³•ç»è¿‡ä¸€äº›ä¸šåŠ¡é€»è¾‘è®¡ç®—è¿”å›äº†ä¸€ä¸ªä¸šåŠ¡å¯¹è±¡ UserInfoDto</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfoDto <span class="title">findByUserId</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">      UserInfo userInfo = userInfoRepository.findById(userId).orElse(<span class="keyword">new</span> UserInfo());</span><br><span class="line">      <span class="comment">//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡è®¡ç®—æ”¹å˜ä¸€ä¸‹nameçš„å€¼è¿”å›</span></span><br><span class="line">      UserInfoDto userInfoDto = UserInfoDto.builder().name(userInfo.getName()+<span class="string">&quot;_HELLO&quot;</span>).id(userInfo.getId()).build();</span><br><span class="line">      <span class="keyword">return</span> userInfoDto;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œservice é€šè¿‡ Spring çš„ @Component æ³¨è§£è¿›è¡ŒåŠ è½½ï¼ŒUserInfoRepository é€šè¿‡ spring çš„ @Autowired æ³¨å…¥è¿›æ¥ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ findByUserId è¿™ä¸ªä¸šåŠ¡ service æ–¹æ³•ï¼Œå•å…ƒæµ‹è¯•å†™æ³•å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span><span class="comment">//é€šè¿‡è¿™ä¸ªæ³¨è§£åˆ©ç”¨Springçš„å®¹å™¨</span></span><br><span class="line"><span class="meta">@Import(UserInfoServiceImpl.class)</span><span class="comment">//å¯¼å…¥è¦æµ‹è¯•çš„UserInfoServiceImpl</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//åˆ©ç”¨springçš„å®¹å™¨ï¼Œå¯¼å…¥è¦æµ‹è¯•çš„UserInfoService</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">    <span class="meta">@MockBean</span> <span class="comment">//é‡Œé¢@MockBeanæ¨¡æ‹Ÿserviceä¸­ç”¨åˆ°çš„userInfoRepositoryï¼Œè¿™æ ·é¿å…çœŸå®è¯·æ±‚æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">    <span class="comment">// åˆ©ç”¨å•å…ƒæµ‹è¯•çš„æ€æƒ³ï¼Œmock userInfoService é‡Œé¢çš„ UserInfoRepositoryï¼Œè¿™æ ·Serviceå±‚å°±ä¸ç”¨è¿æ¥æ•°æ®åº“ï¼Œå°±å¯ä»¥æµ‹è¯•è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘äº†</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetUserInfoDto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//åˆ©ç”¨ Mockito æ¨¡æ‹Ÿå½“è°ƒç”¨ findById(1) çš„æ—¶å€™ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®</span></span><br><span class="line">         Mockito.when(userInfoRepository.findById(<span class="number">1L</span>))</span><br><span class="line">                    .thenReturn(java.util.Optional.ofNullable(UserInfo.builder().name(<span class="string">&quot;jack&quot;</span>).id(<span class="number">1L</span>).build()));</span><br><span class="line">        UserInfoDto userInfoDto = userInfoService.findByUserId(<span class="number">1L</span>);</span><br><span class="line">        <span class="comment">//ç»è¿‡ä¸€äº›serviceé‡Œé¢çš„é€»è¾‘è®¡ç®—ï¼ŒéªŒè¯ä¸€ä¸‹è¿”å›ç»“æœæ˜¯å¦æ­£ç¡®</span></span><br><span class="line">        Assertions.assertEquals(<span class="string">&quot;jack&quot;</span>,userInfoDto.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å¯ä»¥å®Œæˆ Service å±‚çš„æµ‹è¯•äº†ã€‚</p>
<p>å…¶ä¸­ <code>@ExtendWith(SpringExtension.class)</code> æ˜¯ spring boot ä¸ Junit 5 ç»“åˆä½¿ç”¨çš„æ—¶å€™ï¼Œå½“åˆ©ç”¨ Spring çš„ TestContext è¿›è¡Œ mock æµ‹è¯•æ—¶è¦ä½¿ç”¨çš„ã€‚æœ‰çš„æ—¶å€™å¦‚æœåšä¸€äº›ç®€å• Util çš„æµ‹è¯•ï¼Œå°±ä¸ä¸€å®šä¼šç”¨åˆ° SpringExtension.classã€‚</p>
<p>åœ¨ service çš„å•å…ƒæµ‹è¯•ä¸­ï¼Œä¸»è¦ç”¨åˆ°çš„çŸ¥è¯†ç‚¹æœ‰å››ä¸ªã€‚</p>
<ol>
<li><p>é€šè¿‡ <code>@ExtendWith(SpringExtension.class)</code> åŠ è½½ Spring çš„æµ‹è¯•æ¡†æ¶åŠå…¶ TestContextï¼›</p>
</li>
<li><p>é€šè¿‡ <code>@Import(UserInfoServiceImpl.class)</code> å¯¼å…¥å…·ä½“è¦æµ‹è¯•çš„ç±»ï¼Œè¿™æ · SpringTestContext å°±ä¸ç”¨åŠ è½½é¡¹ç›®é‡Œé¢çš„æ‰€æœ‰ç±»ï¼Œåªéœ€è¦åŠ è½½ UserInfoServiceImpl.class å°±å¯ä»¥äº†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œé€Ÿåº¦ï¼›</p>
</li>
<li><p>é€šè¿‡ <code>@MockBean</code> æ¨¡æ‹Ÿ UserInfoServiceImpl ä¾èµ–çš„ userInfoRepositoryï¼Œå¹¶ä¸”è‡ªåŠ¨æ³¨å…¥ Spring test context é‡Œé¢ï¼Œè¿™æ · Service é‡Œé¢å°±è‡ªåŠ¨æœ‰ä¾èµ–äº†ï¼›</p>
</li>
<li><p>åˆ©ç”¨ <code>Mockito.when().thenReturn()</code> çš„æœºåˆ¶ï¼Œæ¨¡æ‹Ÿæµ‹è¯•æ–¹æ³•ã€‚</p>
</li>
</ol>
<p>è¿™æ ·å°±å¯ä»¥é€šè¿‡ Assertions é‡Œé¢çš„æ–­è¨€æ¥æµ‹è¯• service æ–¹æ³•é‡Œé¢çš„é€»è¾‘æ˜¯å¦ç¬¦åˆé¢„æœŸäº†ã€‚</p>
<p><strong>Controller å±‚å•å…ƒæµ‹è¯•</strong></p>
<p>æ–°å¢ä¸€ä¸ª UserInfoController è·Ÿè¿› Id è·å¾— UserInfoDto çš„ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoController</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">   <span class="comment">//è·Ÿè¿›UserIdå–ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;&quot;)</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> UserInfoDto <span class="title">findByUserId</span><span class="params">(<span class="meta">@PathVariable</span> Long userId)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> userInfoService.findByUserId(userId);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Controller é‡Œé¢å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.demo;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.demo.service.UserInfoService;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.demo.service.dto.UserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.example.jpa.demo.web.UserInfoController;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.mockito.Mockito;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.mock.mockito.MockBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.mock.web.MockHttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.MockMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebMvcTest(UserInfoController.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line">    <span class="meta">@MockBean</span> <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å•å…ƒæµ‹è¯•mvcçš„controllerçš„æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetUserDto</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//åˆ©ç”¨ @MockBeanï¼Œå½“è°ƒç”¨ userInfoServiceçš„findByUserId(1)çš„æ—¶å€™è¿”å›ä¸€ä¸ªæ¨¡æ‹Ÿçš„UserInfoDtoæ•°æ®</span></span><br><span class="line">        Mockito.when(userInfoService.findByUserId(<span class="number">1L</span>))</span><br><span class="line">            .thenReturn(UserInfoDto.builder().name(<span class="string">&quot;jack&quot;</span>).id(<span class="number">1L</span>).build());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åˆ©ç”¨mvcéªŒè¯ä¸€ä¸‹Controlleré‡Œé¢çš„è§£å†³æ˜¯å¦OK</span></span><br><span class="line">        MockHttpServletResponse response = mvc</span><br><span class="line">                .perform(MockMvcRequestBuilders</span><br><span class="line">                        .get(<span class="string">&quot;/user/1/&quot;</span>)<span class="comment">//è¯·æ±‚çš„path</span></span><br><span class="line">                        .accept(MediaType.APPLICATION_JSON)<span class="comment">//è¯·æ±‚çš„mediaTypeï¼Œè¿™é‡Œé¢å¯ä»¥åŠ ä¸Šå„ç§éœ€è¦çš„Header</span></span><br><span class="line">                )</span><br><span class="line">                .andDo(print())<span class="comment">//æ‰“å°ä¸€ä¸‹</span></span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andExpect(MockMvcResultMatchers.jsonPath(<span class="string">&quot;$.name&quot;</span>).value(<span class="string">&quot;jack&quot;</span>))</span><br><span class="line">                .andReturn().getResponse();</span><br><span class="line">        System.out.println(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¸»è¦åˆ©ç”¨äº† <code>@WebMvcTest</code> æ³¨è§£ï¼Œæ¥å¼•å…¥è¦æµ‹è¯•çš„ Controllerã€‚æ‰“å¼€ <code>@WebMvcTest</code> å¯ä»¥çœ‹åˆ°å…³é”®æºç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131104539.jpg" alt=""></p>
<p><code>@WebMvcTest</code> åŠ è½½äº† <code>@ExtendWith(SpringExtension.class)</code>ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–æŒ‡å®šï¼Œå°±æ‹¥æœ‰äº† Spring çš„ test contextï¼Œå¹¶ä¸”ä¹Ÿè‡ªåŠ¨åŠ è½½äº† mvc æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ <code>WebMvctestContextbootstrapper</code>ã€‚</p>
<p>æœ‰çš„æ—¶å€™å¯èƒ½æœ‰ä¸€äº›å…¨å±€çš„ Filterï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­¤æ³¨è§£é‡Œé¢çš„ <code>includeFilters</code> å’Œ <code>excluedeFilters</code> åŠ è½½å’Œæ’é™¤éœ€è¦çš„ <code>WebMvcFilter</code> è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>å½“é€šè¿‡ <code>@WebMvcTest(UserInfoController.class)</code> å¯¼å…¥éœ€è¦æµ‹è¯•çš„ Controller ä¹‹åï¼Œå°±å¯ä»¥å†é€šè¿‡ <code>MockMvc</code> è¯·æ±‚åˆ°åŠ è½½çš„ Controller é‡Œé¢çš„ path äº†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <code>MockMvc</code> æä¾›çš„ä¸€äº›æ–¹æ³•å‘é€è¯·æ±‚ï¼ŒéªŒè¯ Controller çš„å“åº”ç»“æœã€‚</p>
<p>ä¸‹é¢æ¦‚æ‹¬ä¸€ä¸‹ Controller å±‚å•å…ƒæµ‹è¯•ä¸»è¦ç”¨åˆ°çš„ä¸‰ä¸ªçŸ¥è¯†ç‚¹ã€‚</p>
<ol>
<li><p>åˆ©ç”¨ <code>@WebMvcTest</code> æ³¨è§£ï¼ŒåŠ è½½è¦æµ‹è¯•çš„ Controllerï¼ŒåŒæ—¶ç”Ÿæˆ mvc æ‰€éœ€è¦çš„ Test Contextï¼›</p>
</li>
<li><p>åˆ©ç”¨ <code>@MockBean</code> é»˜è®¤ Controller é‡Œé¢çš„ä¾èµ–ï¼Œå¦‚ Serviceï¼Œå¹¶é€šè¿‡ <code>Mockito.when().thenReturn()ï¼›</code>çš„è¯­æ³• mock ä¾èµ–çš„æµ‹è¯•æ•°æ®ï¼›</p>
</li>
<li><p>åˆ©ç”¨ <code>MockMvc</code> ä¸­æä¾›çš„æ–¹æ³•ï¼Œå‘é€ Controller çš„ Rest é£æ ¼çš„è¯·æ±‚ï¼Œå¹¶éªŒè¯è¿”å›ç»“æœå’ŒçŠ¶æ€ç ã€‚</p>
</li>
</ol>
<h3 id="ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•"><a href="#ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•" class="headerlink" title="ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•"></a>ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•</h3><p>é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æŒ‡å¤šä¸ªæ¨¡å—æ”¾åœ¨ä¸€èµ·æµ‹è¯•ï¼Œå’Œå•å…ƒæµ‹è¯•æ­£å¥½ç›¸åï¼Œå¹¶éé‡‡ç”¨ mock çš„æ–¹å¼æµ‹è¯•ï¼Œè€Œæ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ã€‚ä¹Ÿå°±æ˜¯è¯´ä¾èµ– spring å®¹å™¨è¿›è¡Œå¼€å‘ï¼Œæ‰€æœ‰çš„ç±»ä¹‹é—´ç›´æ¥è°ƒç”¨ï¼Œæ¨¡æ‹Ÿåº”ç”¨çœŸå®å¯åŠ¨æ—¶å€™çš„çŠ¶æ€ã€‚</p>
<p><strong>Service å±‚çš„åŸºå±‚æµ‹è¯•ç”¨ä¾‹å†™æ³•</strong></p>
<p>è¿˜ç”¨åˆšæ‰çš„ä¾‹å­ï¼Œçœ‹ä¸€ä¸‹ UserInfoService é‡Œé¢çš„ findByUserId é€šè¿‡é›†æˆæµ‹è¯•å¦‚ä½•è¿›è¡Œã€‚æµ‹è¯•ç”¨ä¾‹çš„å†™æ³•å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses= UserInfoServiceImpl.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceIntegrationTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> UserInfoRepository userInfoRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@Rollback(false)</span><span class="comment">//å¦‚æœäº‹åŠ¡å›æ»šè®¾ç½®æˆfalseçš„è¯ï¼Œæ•°æ®åº“å¯ä»¥çœŸå®çœ‹åˆ°è¿™æ¡æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIntegtation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo u1 = UserInfo.builder().name(<span class="string">&quot;jack-db&quot;</span>).ages(<span class="number">20</span>).id(<span class="number">1L</span>).telephone(<span class="string">&quot;1233456&quot;</span>).build();</span><br><span class="line">        <span class="comment">//æ•°æ®åº“çœŸå®åŠ ä¸€æ¡æ•°æ®</span></span><br><span class="line">        userInfoRepository.save(u1);<span class="comment">//æ•°æ®åº“é‡Œé¢çœŸå®ä¿å­˜ä¸€æ¡æ•°æ®</span></span><br><span class="line">        UserInfoDto userInfoDto =  userInfoService.findByUserId(<span class="number">1L</span>);</span><br><span class="line">        userInfoDto.getName();</span><br><span class="line">        Assertions.assertEquals(userInfoDto.getName(),u1.getName()+<span class="string">&quot;_HELLO&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131105144.jpg" alt=""></p>
<p>è¿™æ—¶ä¼šå‘ç°æ•°æ®å·²ç»ä¸å†å›æ»šï¼Œä¹Ÿä¼šæ­£å¸¸åœ°æ‰§è¡Œ SQLï¼Œè€Œä¸æ˜¯é€šè¿‡ Mock çš„æ–¹å¼æµ‹è¯•ã€‚</p>
<p><strong>Controller å±‚çš„é›†æˆæµ‹è¯•ç”¨ä¾‹çš„å†™æ³•</strong></p>
<p>ç”¨é›†æˆæµ‹è¯•æŠŠåˆšæ‰ UserInfoCotroller å†™çš„ user/1/ æ¥å£æµ‹è¯•ä¸€ä¸‹ï¼Œå°†é›†æˆæµ‹è¯•çš„ä»£ç åšå¦‚ä¸‹æ”¹åŠ¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(classes = DemoApplication.class,</span></span><br><span class="line"><span class="meta">        webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span> <span class="comment">//åŠ è½½ DemoApplicationï¼ŒæŒ‡å®šä¸€ä¸ªéšæœºç«¯å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoControllerIntegrationTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@LocalServerPort</span> <span class="comment">//è·å¾—æ¨¡æ‹Ÿçš„éšæœºç«¯å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">//åˆ©ç”¨ RestTemplateï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAllUserDtoIntegration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfoDto userInfoDto = <span class="keyword">this</span>.restTemplate</span><br><span class="line">                .getForObject(<span class="string">&quot;http://localhost:&quot;</span> + port + <span class="string">&quot;/user/1&quot;</span>, UserInfoDto.class);<span class="comment">//çœŸå®è¯·æ±‚æœ‰ä¸€ä¸ªåå°çš„API</span></span><br><span class="line">        Assertions.assertNotNull(userInfoDto);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹æ—¥å¿—çš„è¯ï¼Œä¼šå‘ç°æ­¤æ¬¡çš„æµ‹è¯•ç”¨ä¾‹ä¼šåœ¨å†…éƒ¨å¯åŠ¨ä¸€ä¸ª tomcat å®¹å™¨ï¼Œç„¶åå†åˆ©ç”¨ TestResTemplate è¿›è¡ŒçœŸå®è¯·æ±‚ï¼Œè¿”å›æµ‹è¯•ç»“æœè¿›è¡Œæµ‹è¯•ã€‚</p>
<p>è€Œå…¶ä¸­ä¼šæ¶‰åŠä¸€ä¸ªæ³¨è§£ <code>@SpringBootTest</code>ï¼Œå®ƒç”¨æ¥æŒ‡å®š Spring åº”ç”¨çš„ç±»æ˜¯å“ªä¸ªï¼Œä¹Ÿå°±æ˜¯çœŸå®é¡¹ç›®çš„ Application å¯åŠ¨ç±»ï¼›ç„¶åä¼šæŒ‡å®šä¸€ä¸ªç«¯å£ï¼Œæ­¤å¤„å¿…é¡»ä½¿ç”¨éšæœºç«¯å£ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å†²çªï¼ˆå¦‚æœå¯åŠ¨çš„é›†æˆæµ‹è¯•æœ‰ç‚¹å¤šçš„æƒ…å†µï¼‰ã€‚æ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131105947.jpg" alt=""></p>
<p>å¦‚æœçœ‹ <code>@SprintBootTest</code> æºç çš„è¯ï¼Œä¼šå‘ç°è¿™ä¸ªæ³¨è§£ä¹Ÿæ˜¯åŠ è½½äº† Spring çš„æµ‹è¯•ç¯å¢ƒ SpringExtension.classï¼Œå¹¶ä¸”é‡Œé¢æœ‰å¾ˆå¤šå±æ€§å¯ä»¥è®¾ç½®ï¼Œæµ‹è¯•çš„æ—¶å€™çš„é…ç½®æ–‡ä»¶ properties å’Œä¸€äº›å¯åŠ¨çš„ç¯å¢ƒå˜é‡ WebEnvï¼›ç„¶ååˆåˆ©ç”¨äº† Spring Boot Test æä¾›çš„ <code>@LocalServerPort</code> è·å¾—å¯åŠ¨æ—¶å€™çš„ç«¯å£ã€‚æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210131112459.jpg" alt=""></p>
<p><strong>é›†æˆæµ‹è¯•çš„ä¸€äº›æ€è€ƒ</strong></p>
<ol>
<li><p>æ‰€æœ‰çš„æ–¹æ³•éƒ½éœ€è¦é›†æˆæµ‹è¯•å—ï¼Ÿ</p>
<p>è¿™æ˜¯å†™é›†æˆæµ‹è¯•ç”¨çš„æ—¶å€™éœ€è¦æ€è€ƒçš„ï¼Œå› ä¸ºé›†æˆæµ‹è¯•ç”¨ä¾‹éœ€è¦å†…éƒ¨å¯åŠ¨ Tomcat å®¹å™¨ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¯åŠ¨å¾—æ…¢ä¸€ç‚¹ã€‚å¦‚æœé¡¹ç›®åŠ è½½çš„é…ç½®æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼ŒåŠ¿å¿…ä¼šå¯¼è‡´æµ‹è¯•ä¹Ÿä¼šå˜æ…¢ã€‚å‡è®¾æµ‹è¯•ä¸€ä¸ªç®€å•çš„é€»è¾‘å°±éœ€è¦å¯åŠ¨æ•´ä¸ª Applicationï¼Œé‚£ä¹ˆæ˜¾ç„¶æ˜¯ä¸å¦¥çš„ã€‚</p>
<p>é‚£ä¹ˆæ•´ä¸ª Application ä¸éœ€è¦é›†æˆæµ‹è¯•å—ï¼Ÿä¹Ÿæ˜¾ç„¶ä¸æ˜¯çš„ï¼Œå› ä¸ºæœ‰äº›æ—¶å€™åªæœ‰é›†æˆåœ¨ä¸€èµ·æ‰ä¼šå‘ç”Ÿé—®é¢˜ï¼Œæœ€ç®€å•çš„ä¸€ä¸ªé›†æˆæµ‹è¯•æ˜¯éœ€è¦æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥ä¸€ä¸ªé¡¹ç›®é‡Œé¢ä¼šæœ‰ä¸ª ApplicationTests æ¥æµ‹è¯•é¡¹ç›®æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoApplicationTests</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æµ‹è¯•é¡¹ç›®æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸€å®šæ˜¯éé›†æˆæµ‹è¯•å°±æ˜¯å•å…ƒæµ‹è¯•å—ï¼Ÿ</p>
<p>å®é™…å·¥ä½œä¸­å¹¶æ²¡æœ‰åˆ’åˆ†é‚£ä¹ˆæ¸…æ¥šï¼Œæœ‰çš„æ—¶å€™é›†æˆäº† N ä¸ªç»„ä»¶ä¸€èµ·æµ‹è¯•ï¼Œå¯èƒ½å°±æ˜¯ä¸è¿æ•°æ®åº“ã€‚æ¯”å¦‚å¯èƒ½ä¼šä½¿ç”¨ Feign-Client æ ¹æ®ç¬¬ä¸‰æ–¹çš„æ¥å£è·å–ä¸€äº›æ•°æ®ï¼Œé‚£ä¹ˆæ­£å¸¸çš„åšæ³•å°±æ˜¯æ–°å»ºä¸€ä¸ª Serviceï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•æ™®é€šJSONè¿”å›ç»“æœï¼Œæ ¹æ®ç¬¬ä¸‰æ–¹æ¥å£å–ä¸€ä¸ªæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;aocFeignTest&quot;, url = &quot;http://room-api.staging.jack.net&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AppSettingService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/api/v1/app/globalSettings&quot;)</span></span><br><span class="line">    <span class="function">HashMap&lt;String,Object&gt; <span class="title">getAppSettings</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¦‚æœè¦æµ‹è¯•ï¼Œæ˜¾ç„¶ä¸éœ€è¦å¯åŠ¨æ•´ä¸ª Application æ¥å®Œæˆï¼Œä½†æ˜¯éœ€è¦æŒ‰éœ€åŠ è½½ä¸€äº› Configuration æ‰èƒ½æµ‹è¯•ï¼Œé‚£ä¹ˆæµ‹è¯•ç”¨ä¾‹ä¼šå˜æˆå¦‚ä¸‹æƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(SpringExtension.class)</span><span class="comment">//åˆ©ç”¨Springä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="meta">@Import(&#123;FeignSimpleConfiguration.class, FeignAutoConfiguration.class, HttpMessageConvertersAutoConfiguration.class, JacksonAutoConfiguration.class&#125;)</span><span class="comment">//å¯¼å…¥æ­¤å¤„Fegin-Clientæµ‹è¯•æ‰€éœ€è¦çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="meta">@EnableFeignClients(clients = AppSettingService.class)</span><span class="comment">//é€šè¿‡FeignClientçš„æ³¨è§£åŠ è½½AppSettingServiceå®¢æˆ·ç«¯ã€‚</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¾èµ–HTTPMessageConverterçš„ä½¿ç”¨æ–¹æ³•(import FeignSimpleConfiguration junit)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignJsonTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// åˆ©ç”¨Springçš„ä¸Šä¸‹æ–‡æ³¨å…¥appSettingService</span></span><br><span class="line">    <span class="keyword">private</span> AppSettingService appSettingService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJsonFeignClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String,Object&gt;  r = .getAppSettings();</span><br><span class="line">        Assert.assertNotNull(r.get(<span class="string">&quot;data&quot;</span>));<span class="comment">//æµ‹è¯•ä¸€ä¸‹æ¥å£è¿”å›çš„ç»“æœ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™å…¶å®å¹¶æ²¡æœ‰å¯åŠ¨è¿™ä¸ª Applicationï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿé›†æˆäº† Fegin-Client æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ Configurationï¼Œä»è€Œåˆ©ç”¨ SpringExtension åŠ è½½æ‰€éœ€è¦ä¾èµ–çš„ç±»ï¼Œå®Œæˆä¸€æ¬¡æµ‹è¯•ã€‚</p>
<p>æ‰€ä»¥ä¸€å®šè¦æ ¹æ®è‡ªå·±çš„å®é™…éœ€è¦é€‰æ‹©æ€§åœ°åŠ è½½ä¸€äº›ç±»æ¥å®Œæˆæµ‹è¯•ç”¨ä¾‹ï¼Œè€Œä¸æ˜¯æ¯æ¬¡æµ‹è¯•çš„æ—¶å€™éƒ½éœ€è¦æŠŠæ‰€æœ‰ç±»éƒ½åŠ è½½ä¸€éï¼Œè¿™æ ·è¿”å›ä¼šä½¿æµ‹è¯•ç”¨ä¾‹çš„æ—¶é—´å˜é•¿ï¼Œä»è€Œé™ä½å·¥ä½œæ•ˆç‡ã€‚</p>
</li>
</ol>
<h2 id="Junit-4-å’Œ-Junit-5-åœ¨-Spring-Boot-ä¸­çš„åŒºåˆ«"><a href="#Junit-4-å’Œ-Junit-5-åœ¨-Spring-Boot-ä¸­çš„åŒºåˆ«" class="headerlink" title="Junit 4 å’Œ Junit 5 åœ¨ Spring Boot ä¸­çš„åŒºåˆ«"></a>Junit 4 å’Œ Junit 5 åœ¨ Spring Boot ä¸­çš„åŒºåˆ«</h2><p>ç¬¬ä¸€ï¼ŒSpring Boot 2.2+ ä»¥ä¸Šçš„ç‰ˆæœ¬é»˜è®¤å¯¼å…¥çš„æ˜¯ Junit 5 çš„ jar åŒ…ä¾èµ–ï¼Œä»¥ä¸‹çš„ç‰ˆæœ¬é»˜è®¤å¯¼å…¥çš„æ˜¯ Junit 4 çš„ jar åŒ…ä¾èµ–çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ Spring Boot çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹ä¾èµ–çš„ jar åŒ…æ˜¯å¦é½å…¨ã€‚</p>
<p>ç¬¬äºŒï¼Œorg.junit.junit.Test å˜æˆäº† org.junit.jupiter.api.Testã€‚</p>
<p>ç¬¬ä¸‰ï¼Œä¸€äº›æ³¨è§£å‘ç”Ÿäº†å˜åŒ–ï¼š</p>
<ul>
<li><code>@Before</code> å˜æˆäº† <code>@BeforeEach</code></li>
<li><code>@After</code> å˜æˆäº† <code>@AfterEach</code></li>
<li><code>@BeforeClass</code> å˜æˆäº† <code>@BeforeAll</code></li>
<li><code>@AfterClass</code> å˜æˆäº† <code>@AfterAll</code></li>
<li><code>@Ignore</code> å˜æˆäº† <code>@Disabled</code></li>
<li><code>@Category</code> å˜æˆäº† <code>@Tag</code></li>
<li><code>@Rule</code> å’Œ <code>@ClassRule</code> æ²¡æœ‰äº†ï¼Œç”¨ <code>@ExtendWith</code> å’Œ <code>@RegisterExtension</code> ä»£æ›¿</li>
</ul>
<p>ç¬¬å››ï¼Œå¼•ç”¨ Spring çš„ä¸Šä¸‹æ–‡ <code>@RunWith(SpringRunner.class)</code> å˜æˆäº† <code>@ExtendWith(SpringExtension.class)</code>ã€‚</p>
<p>ç¬¬äº”ï¼Œorg.junit.Assert ä¸‹é¢çš„æ–­è¨€éƒ½ç§»åˆ°äº†org.junit.jupiter.api.Assertions ä¸‹é¢ï¼Œæ‰€ä»¥ä¸€äº›æ–­è¨€çš„å†™æ³•ä¼šå‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//junit4æ–­è¨€çš„å†™æ³•</span></span><br><span class="line">Assert.assertEquals(<span class="number">200</span>, result.getStatusCodeValue());</span><br><span class="line">Assert.assertEquals(<span class="keyword">true</span>, result.getBody().contains(<span class="string">&quot;employeeList&quot;</span>));</span><br><span class="line"><span class="comment">//junit5æ–­è¨€çš„å†™æ³•</span></span><br><span class="line">Assertions.assertEquals(<span class="number">400</span>, ex.getRawStatusCode());</span><br><span class="line">Assertions.assertEquals(<span class="keyword">true</span>, ex.getResponseBodyAsString().contains(<span class="string">&quot;Missing request header&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>ç¬¬å…­ï¼ŒJunit 5 æä¾› <code>@DisplayName(&quot;Test MyClass&quot;)</code> <a href="">ç”¨æ¥æ ‡è¯†æ­¤æ¬¡å•å…ƒæµ‹è¯•çš„åå­—</a>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DisplayName(&quot;Test MyClass&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClassTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="meta">@DisplayName(&quot;Verify MyClass.myMethod returns true&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testMyMethod</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;    </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa çš„å®¡è®¡åŠŸèƒ½</title>
    <url>/2020/11/05/SpringDataJpa%E7%9A%84%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD/</url>
    <content><![CDATA[<h1 id="JPA-çš„å®¡è®¡åŠŸèƒ½"><a href="#JPA-çš„å®¡è®¡åŠŸèƒ½" class="headerlink" title="JPA çš„å®¡è®¡åŠŸèƒ½"></a>JPA çš„å®¡è®¡åŠŸèƒ½</h1><p> JPA çš„å®¡è®¡åŠŸèƒ½ï¼Œå³ Auditing</p>
<h2 id="Auditing-æŒ‡çš„æ˜¯ä»€ä¹ˆ"><a href="#Auditing-æŒ‡çš„æ˜¯ä»€ä¹ˆ" class="headerlink" title="Auditing æŒ‡çš„æ˜¯ä»€ä¹ˆ"></a>Auditing æŒ‡çš„æ˜¯ä»€ä¹ˆ</h2><p>Auditing æ˜¯å¸®æˆ‘ä»¬åšå®¡è®¡ç”¨çš„ï¼Œå½“æˆ‘ä»¬æ“ä½œä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œéœ€è¦çŸ¥é“è¿™æ˜¯è°åˆ›å»ºçš„ã€ä»€ä¹ˆæ—¶é—´åˆ›å»ºçš„ã€æœ€åä¿®æ”¹äººæ˜¯è°ã€æœ€åä¿®æ”¹æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Œç”šè‡³éœ€è¦ä¿®æ”¹è®°å½•â€¦â€¦è¿™äº›éƒ½æ˜¯ Spring Data JPA é‡Œé¢çš„ Auditing æ”¯æŒçš„ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†å››ä¸ªæ³¨è§£æ¥å®Œæˆä¸Šé¢è¯´çš„ä¸€ç³»åˆ—äº‹æƒ…ï¼Œå¦‚ä¸‹ï¼š</p>
<p><code>@CreatedBy</code> æ˜¯å“ªä¸ªç”¨æˆ·åˆ›å»ºçš„ã€‚</p>
<p><code>@CreatedDate</code> åˆ›å»ºçš„æ—¶é—´ã€‚</p>
<p><code>@LastModifiedBy</code> æœ€åä¿®æ”¹å®ä½“çš„ç”¨æˆ·ã€‚</p>
<p><code>@LastModifiedDate</code> æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ã€‚</p>
<p>è¿™å°±æ˜¯ Auditing äº†</p>
<h2 id="Auditing-å¦‚ä½•å®ç°"><a href="#Auditing-å¦‚ä½•å®ç°" class="headerlink" title="Auditing å¦‚ä½•å®ç°"></a>Auditing å¦‚ä½•å®ç°</h2><p>åˆ©ç”¨ä¸Šé¢çš„å››ä¸ªæ³¨è§£å®ç°æ–¹æ³•ï¼Œä¸€å…±æœ‰ä¸‰ç§æ–¹å¼å®ç° Auditingã€‚</p>
<h3 id="æ–¹å¼ä¸€ï¼šç›´æ¥åœ¨å®ä¾‹é‡Œé¢æ·»åŠ æ³¨è§£"><a href="#æ–¹å¼ä¸€ï¼šç›´æ¥åœ¨å®ä¾‹é‡Œé¢æ·»åŠ æ³¨è§£" class="headerlink" title="æ–¹å¼ä¸€ï¼šç›´æ¥åœ¨å®ä¾‹é‡Œé¢æ·»åŠ æ³¨è§£"></a>æ–¹å¼ä¸€ï¼šç›´æ¥åœ¨å®ä¾‹é‡Œé¢æ·»åŠ æ³¨è§£</h3><p>åœ¨ User å®ä½“æ·»åŠ å››ä¸ªå­—æ®µï¼Œåˆ†åˆ«è®°å½•åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ã€æœ€åä¿®æ”¹äººã€æœ€åä¿®æ”¹æ—¶é—´ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šåœ¨ User é‡Œé¢æ·»åŠ å››ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”æ–°å¢ <code>@EntityListeners(AuditingEntityListener.class)</code> æ³¨è§£ã€‚</p>
<p>æ·»åŠ å®Œä¹‹åï¼ŒUser çš„å®ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addresses&quot;)</span></span><br><span class="line"><span class="meta">@EntityListeners(AuditingEntityListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">   <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">   <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">   <span class="keyword">private</span> Integer age;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;user&quot;)</span></span><br><span class="line">   <span class="meta">@JsonIgnore</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;UserAddress&gt; addresses;</span><br><span class="line">   <span class="keyword">private</span> Boolean deleted;</span><br><span class="line">   <span class="meta">@CreatedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="meta">@CreatedDate</span></span><br><span class="line">   <span class="keyword">private</span> Date createTime;</span><br><span class="line">   <span class="meta">@LastModifiedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line">   <span class="meta">@LastModifiedDate</span></span><br><span class="line">   <span class="keyword">private</span> Date lastModifiedTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>åœ¨ @Entity å®ä½“ä¸­æˆ‘ä»¬éœ€è¦åšä¸¤ç‚¹æ“ä½œï¼š</p>
<ol>
<li><p>å…¶ä¸­æœ€ä¸»è¦çš„å››ä¸ªå­—æ®µåˆ†åˆ«è®°å½•åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ã€æœ€åä¿®æ”¹äººã€æœ€åä¿®æ”¹æ—¶é—´ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CreatedBy</span></span><br><span class="line"><span class="keyword">private</span> Integer createUserId;</span><br><span class="line"><span class="meta">@CreatedDate</span></span><br><span class="line"><span class="keyword">private</span> Date createTime;</span><br><span class="line"><span class="meta">@LastModifiedBy</span></span><br><span class="line"><span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line"><span class="meta">@LastModifiedDate</span></span><br><span class="line"><span class="keyword">private</span> Date lastModifiedTime;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å…¶ä¸­ <code>AuditingEntityListener</code> ä¸èƒ½å°‘ï¼Œå¿…é¡»é€šè¿‡è¿™æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EntityListeners(AuditingEntityListener.class)</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>åœ¨ Entity çš„å®ä½“ä¸Šé¢è¿›è¡Œæ³¨è§£ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šå®ç° <code>AuditorAware</code> æ¥å£ï¼Œå‘Šè¯‰ JPA å½“å‰çš„ç”¨æˆ·æ˜¯è°ã€‚</p>
<p>éœ€è¦å®ç° <code>AuditorAware</code> æ¥å£ï¼Œä»¥åŠ <code>getCurrentAuditor</code> æ–¹æ³•ï¼Œå¹¶è¿”å›ä¸€ä¸ª Integer çš„ user IDã€‚è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰è¿”å›ä¿®æ”¹ç”¨æˆ·çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·å</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuditorAware</span> <span class="keyword">implements</span> <span class="title">AuditorAware</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">//éœ€è¦å®ç°AuditorAwareæ¥å£ï¼Œè¿”å›å½“å‰çš„ç”¨æˆ·ID</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Optional&lt;Integer&gt; <span class="title">getCurrentAuditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ServletRequestAttributes servletRequestAttributes =</span><br><span class="line">            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">      Integer userId = (Integer) servletRequestAttributes.getRequest().getSession().getAttribute(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> Optional.ofNullable(userId);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…³é”®çš„ä¸€æ­¥ï¼Œæ˜¯å®ç° <code>AuditorAware</code> æ¥å£çš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuditorAware</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">   <span class="function">T <span class="title">getCurrentAuditor</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ¯æ³¨æ„ï¼šè¿™é‡Œè·å¾—ç”¨æˆ· ID çš„æ–¹æ³•ä¸æ­¢è¿™ä¸€ç§ï¼Œå®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å°†å½“å‰çš„ user ä¿¡æ¯æ”¾åœ¨ Session ä¸­ï¼Œå¯èƒ½æŠŠå½“å‰ä¿¡æ¯æ”¾åœ¨ Redis ä¸­ï¼Œä¹Ÿå¯èƒ½æ”¾åœ¨ Spring çš„ security é‡Œé¢ç®¡ç†ã€‚</p>
</blockquote>
<p>æ­¤å¤–ï¼Œè¿™é‡Œçš„å®ç°ä¼šæœ‰ç•¥å¾®å·®å¼‚ï¼Œæˆ‘ä»¬ä»¥ security ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Authentication authentication =  SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line"><span class="keyword">if</span> (authentication == <span class="keyword">null</span> || !authentication.isAuthenticated()) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">Integer userId = ((LoginUserInfo) authentication.getPrincipal()).getUser().getId();</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶è·å– <code>userId</code> çš„ä»£ç å¯èƒ½ä¼šå˜æˆä¸Šé¢è¿™æ ·å­ã€‚</p>
<p>ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ <code>@EnableJpaAuditing</code> æ³¨è§£å¼€å¯ JPA çš„ Auditing åŠŸèƒ½ã€‚</p>
<p>ç¬¬ä¸‰æ­¥æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼Œå¦‚æœæƒ³ä½¿ä¸Šé¢çš„é…ç½®ç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯ JPA çš„ Auditing åŠŸèƒ½ï¼ˆé»˜è®¤æ²¡å¼€å¯ï¼‰ã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ³¨è§£æ˜¯ <code>@EnableJpaAuditing</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(JpaAuditingRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableJpaAuditing &#123;</span><br><span class="line"><span class="comment">//auditorç”¨æˆ·çš„è·å–æ–¹æ³•ï¼Œé»˜è®¤æ˜¯æ‰¾AuditorAwareçš„å®ç°ç±»ï¼›</span></span><br><span class="line"><span class="function">String <span class="title">auditorAwareRef</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"><span class="comment">//æ˜¯å¦åœ¨åˆ›å»ºä¿®æ”¹çš„æ—¶å€™è®¾ç½®æ—¶é—´ï¼Œé»˜è®¤æ˜¯true</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">setDates</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"><span class="comment">//åœ¨åˆ›å»ºçš„æ—¶å€™æ˜¯å¦åŒæ—¶ä½œä¸ºä¿®æ”¹ï¼Œé»˜è®¤æ˜¯true</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">modifyOnCreate</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"><span class="comment">//æ—¶é—´çš„ç”Ÿæˆæ–¹æ³•ï¼Œé»˜è®¤æ˜¯å–å½“å‰æ—¶é—´(ä¸ºä»€ä¹ˆæä¾›è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿå› ä¸ºæµ‹è¯•çš„æ—¶å€™æœ‰å¯èƒ½å¸Œæœ›æ—¶é—´ä¿æŒä¸å˜ï¼Œå®ƒæä¾›äº†ä¸€ç§è‡ªå®šä¹‰çš„æ–¹æ³•)ï¼›</span></span><br><span class="line"><span class="function">String <span class="title">dateTimeProviderRef</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨äº†è§£äº†<code>@EnableJpaAuditing</code>æ³¨è§£ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªConfiguration æ–‡ä»¶ï¼Œæ·»åŠ  <code>@EnableJpaAuditing</code> æ³¨è§£ï¼Œå¹¶ä¸”æŠŠæˆ‘ä»¬çš„ <code>MyAuditorAware</code> åŠ è½½è¿›å»å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJpaAuditing</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaConfiguration</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(name = &quot;myAuditorAware&quot;)</span></span><br><span class="line">   <span class="function">MyAuditorAware <span class="title">myAuditorAware</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> MyAuditorAware();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»éªŒä¹‹è°ˆ</p>
<ul>
<li>è¿™é‡Œè¯´ä¸€ä¸ª Configuration çš„æœ€ä½³å®è·µçš„å†™æ³•ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å•ç‹¬å†™ä¸€ä¸ªConfiguration çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æŠŠ<code>@EnableJpaAuditing</code> æ”¾åœ¨ Application çš„ç±»é‡Œé¢å‘¢ï¼Ÿå› ä¸ºè¿™æ ·çš„è¯ Configuration æ–‡ä»¶å¯ä»¥å•ç‹¬åŠ è½½ã€å•ç‹¬æµ‹è¯•ï¼Œå¦‚æœéƒ½æ”¾åœ¨ Application ç±»é‡Œé¢çš„è¯ï¼Œå²‚ä¸æ˜¯æ¯æ¬¡æµ‹è¯•éƒ½è¦å¯åŠ¨æ•´ä¸ªåº”ç”¨å—ï¼Ÿ</li>
</ul>
<ul>
<li><code>MyAuditorAware</code> ä¹Ÿå¯ä»¥é€šè¿‡ <code>@Componen</code>t æ³¨è§£è¿›è¡ŒåŠ è½½ï¼Œæˆ‘ä¸ºä»€ä¹ˆæ¨è @Bean çš„æ–¹å¼å‘¢ï¼Ÿå› ä¸ºè¿™ç§æ–¹å¼å¯ä»¥è®©ä½¿ç”¨çš„äººç›´æ¥é€šè¿‡æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶çŸ¥é“æˆ‘ä»¬è‡ªå®šä¹‰äº†å“ªäº›ç»„ä»¶ï¼Œä¸ä¼šè®©ç”¨çš„äººäº§ç”Ÿä¸å¿…è¦çš„æƒŠè®¶ï¼Œè¿™æ˜¯ä¸€ç‚¹å†™ framework çš„ç»éªŒï¼Œä¾›ä½ å‚è€ƒã€‚</li>
</ul>
<p>ç¬¬å››æ­¥ï¼šæˆ‘ä»¬å†™ä¸ªæµ‹è¯•ç”¨ä¾‹æµ‹è¯•ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="meta">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span></span><br><span class="line"><span class="meta">@Import(JpaConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@MockBean</span></span><br><span class="line">    MyAuditorAware myAuditorAware;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAuditing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ç”±äºæµ‹è¯•ç”¨ä¾‹æ¨¡æ‹Ÿweb contextç¯å¢ƒä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ©ç”¨@MockBeanï¼Œmockæ‰æˆ‘ä»¬çš„æ–¹æ³•ï¼ŒæœŸå¾…è¿”å›13è¿™ä¸ªç”¨æˆ·ID</span></span><br><span class="line">        Mockito.when(myAuditorAware.getCurrentAuditor()).thenReturn(Optional.of(<span class="number">13</span>));</span><br><span class="line">        <span class="comment">//æˆ‘ä»¬æ²¡æœ‰æ˜¾å¼çš„æŒ‡å®šæ›´æ–°æ—¶é—´ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°äººã€åˆ›å»ºäºº</span></span><br><span class="line">        User user = User.builder()</span><br><span class="line">                .name(<span class="string">&quot;jack&quot;</span>)</span><br><span class="line">                .email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                .sex(SexEnum.BOY)</span><br><span class="line">                .age(<span class="number">20</span>)</span><br><span class="line">                .build();</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">        <span class="comment">//éªŒè¯æ˜¯å¦æœ‰åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ï¼ŒUserIDæ˜¯å¦æ­£ç¡®ï¼›</span></span><br><span class="line">        List&lt;User&gt; users = userRepository.findAll();</span><br><span class="line">        Assertions.assertEquals(<span class="number">13</span>,users.get(<span class="number">0</span>).getCreateUserId());</span><br><span class="line">        Assertions.assertNotNull(users.get(<span class="number">0</span>).getLastModifiedTime());</span><br><span class="line">        System.out.println(users.get(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ©ç”¨ <code>@MockBean</code> æ¨¡æ‹Ÿ <code>MyAuditorAware</code> è¿”å›ç»“æœ 13 è¿™ä¸ª User IDï¼›</p>
<p>æˆ‘ä»¬æµ‹è¯•å¹¶éªŒè¯ create_user_id æ˜¯å¦æ˜¯æˆ‘ä»¬é¢„æœŸçš„ã€‚</p>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">User(id=1, name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null, createUserId=13, createTime=Sat Oct 03 21:19:57 CST 2020, lastModifiedUserId=13, lastModifiedTime=Sat Oct 03 21:19:57 CST 2020)</span><br></pre></td></tr></table></figure>

<p>ç»“æœå®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<h3 id="æ–¹å¼äºŒï¼šå®ä½“é‡Œé¢å®ç°Auditable-æ¥å£"><a href="#æ–¹å¼äºŒï¼šå®ä½“é‡Œé¢å®ç°Auditable-æ¥å£" class="headerlink" title="æ–¹å¼äºŒï¼šå®ä½“é‡Œé¢å®ç°Auditable æ¥å£"></a>æ–¹å¼äºŒï¼šå®ä½“é‡Œé¢å®ç°Auditable æ¥å£</h3><p>æˆ‘ä»¬æ”¹ä¸€ä¸‹ä¸Šé¢çš„ User å®ä½“å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addresses&quot;)</span></span><br><span class="line"><span class="meta">@EntityListeners(AuditingEntityListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Auditable</span>&lt;<span class="title">Integer</span>,<span class="title">Long</span>, <span class="title">Instant</span>&gt; </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">   <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">   <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">   <span class="keyword">private</span> Integer age;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;user&quot;)</span></span><br><span class="line">   <span class="meta">@JsonIgnore</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;UserAddress&gt; addresses;</span><br><span class="line">   <span class="keyword">private</span> Boolean deleted;</span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="keyword">private</span> Instant createTime;</span><br><span class="line">   <span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line">   <span class="keyword">private</span> Instant lastModifiedTime;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Optional&lt;Integer&gt; <span class="title">getCreatedBy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Optional.ofNullable(<span class="keyword">this</span>.createUserId);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedBy</span><span class="params">(Integer createdBy)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.createUserId = createdBy;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Optional&lt;Instant&gt; <span class="title">getCreatedDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Optional.ofNullable(<span class="keyword">this</span>.createTime);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedDate</span><span class="params">(Instant creationDate)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.createTime = creationDate;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Optional&lt;Integer&gt; <span class="title">getLastModifiedBy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Optional.ofNullable(<span class="keyword">this</span>.lastModifiedUserId);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastModifiedBy</span><span class="params">(Integer lastModifiedBy)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.lastModifiedUserId = lastModifiedBy;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastModifiedDate</span><span class="params">(Instant lastModifiedDate)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.lastModifiedTime = lastModifiedDate;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Optional&lt;Instant&gt; <span class="title">getLastModifiedDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Optional.ofNullable(<span class="keyword">this</span>.lastModifiedTime);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> id==<span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ç¬¬ä¸€ç§æ–¹å¼çš„å·®å¼‚æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¦å»æ‰ä¸Šé¢è¯´çš„å››ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”è¦å®ç°æ¥å£ Auditable çš„æ–¹æ³•ï¼Œä»£ç ä¼šå˜å¾—å¾ˆå†—ä½™å’Œå•°å”†ã€‚</p>
<p>è€Œå…¶ä»–éƒ½ä¸å˜ï¼Œæˆ‘ä»¬å†è·‘ä¸€æ¬¡åˆšæ‰çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå‘ç°æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚ä»ä»£ç çš„å¤æ‚ç¨‹åº¦æ¥çœ‹ï¼Œè¿™ç§æ–¹å¼<strong>ä¸æ¨èä½¿ç”¨</strong>ã€‚</p>
<h3 id="æ–¹å¼ä¸‰ï¼šåˆ©ç”¨-MappedSuperclass-æ³¨è§£"><a href="#æ–¹å¼ä¸‰ï¼šåˆ©ç”¨-MappedSuperclass-æ³¨è§£" class="headerlink" title="æ–¹å¼ä¸‰ï¼šåˆ©ç”¨ @MappedSuperclass æ³¨è§£"></a>æ–¹å¼ä¸‰ï¼šåˆ©ç”¨ @MappedSuperclass æ³¨è§£</h3><p>å®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³å…¬å…± BaseEntity çš„é—®é¢˜ï¼Œè€Œä¸”å…¶ä»£è¡¨çš„æ˜¯ç»§æ‰¿å®ƒçš„æ¯ä¸€ä¸ªç±»éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¡¨ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <code>@MappedSuperclass</code> çš„è¯­æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target(&#123;TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MappedSuperclass &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ƒæ³¨è§£é‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå…¶å®å°±æ˜¯ä»£è¡¨äº†æŠ½è±¡å…³ç³»ï¼Œå³æ‰€æœ‰å­ç±»çš„å…¬å…±å­—æ®µè€Œå·²ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ä¾‹ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª BaseEntityï¼Œé‡Œé¢æ”¾ä¸€äº›å®ä½“çš„å…¬å…±å­—æ®µå’Œæ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1.base;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.*;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.MappedSuperclass;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="meta">@EntityListeners(AuditingEntityListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@CreatedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="meta">@CreatedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant createTime;</span><br><span class="line">   <span class="meta">@LastModifiedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line">   <span class="meta">@LastModifiedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant lastModifiedTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š BaseEntity é‡Œé¢éœ€è¦ç”¨ä¸Šé¢æåˆ°çš„å››ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”åŠ ä¸Š<code>@EntityListeners(AuditingEntityListener.class)</code>ï¼Œè¿™æ ·æ‰€æœ‰çš„å­ç±»å°±ä¸éœ€è¦åŠ äº†ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šå®ä½“ç›´æ¥ç»§æ‰¿ BaseEntity å³å¯ã€‚</p>
<p>æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ User å®ä¾‹ç»§æ‰¿ BaseEntityï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addresses&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">   <span class="meta">@Enumerated(EnumType.STRING)</span></span><br><span class="line">   <span class="keyword">private</span> SexEnum sex;</span><br><span class="line">   <span class="keyword">private</span> Integer age;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;user&quot;)</span></span><br><span class="line">   <span class="meta">@JsonIgnore</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;UserAddress&gt; addresses;</span><br><span class="line">   <span class="keyword">private</span> Boolean deleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„è¯ï¼ŒUser å®ä½“å°±ä¸éœ€è¦å…³å¿ƒå¤ªå¤šï¼Œæˆ‘ä»¬åªå…³æ³¨è‡ªå·±éœ€è¦çš„é€»è¾‘å³å¯ï¼Œå¦‚ä¸‹ï¼š</p>
<p>å»æ‰äº† <code>@EntityListeners(AuditingEntityListener.class)</code>ï¼›</p>
<p>å»æ‰äº† <code>@CreatedBy</code>ã€<code>@CreatedDate</code>ã€<code>@LastModifiedBy</code>ã€<code>@LastModifiedDate</code> å››ä¸ªæ³¨è§£çš„å…¬å…±å­—æ®µã€‚</p>
<p>æ¥ç€æˆ‘ä»¬å†è·‘ä¸€ä¸‹ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå‘ç°æ•ˆæœè¿˜æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>è¿™ç§æ–¹å¼ï¼Œæ˜¯æˆ‘<strong>æœ€æ¨è</strong>çš„ï¼Œä¹Ÿæ˜¯å®é™…å·¥ä½œä¸­ä½¿ç”¨æœ€å¤šçš„ä¸€ç§æ–¹å¼ã€‚å®ƒçš„å¥½å¤„æ˜¾è€Œæ˜“è§å°±æ˜¯å…¬ç”¨æ€§å¼ºï¼Œä»£ç ç®€å•ï¼Œéœ€è¦å…³å¿ƒçš„å°‘ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„å®é™…æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…¶å®ä¹Ÿèƒ½å¾ˆå®¹æ˜“å‘ç° Auditing å¸®æˆ‘ä»¬è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹ã€‚</p>
<h2 id="JPA-çš„å®¡è®¡åŠŸèƒ½è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ"><a href="#JPA-çš„å®¡è®¡åŠŸèƒ½è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ" class="headerlink" title="JPA çš„å®¡è®¡åŠŸèƒ½è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ"></a>JPA çš„å®¡è®¡åŠŸèƒ½è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ</h2><ol>
<li><p>å¯ä»¥å¾ˆå®¹æ˜“åœ°è®©æˆ‘ä»¬å†™è‡ªå·±çš„ BaseEntityï¼ŒæŠŠä¸€äº›å…¬å…±çš„å­—æ®µæ”¾åœ¨é‡Œé¢ï¼Œä¸éœ€è¦æˆ‘ä»¬å…³å¿ƒå¤ªå¤šå’Œä¸šåŠ¡æ— å…³çš„å­—æ®µï¼Œæ›´å®¹æ˜“è®©æˆ‘ä»¬å…¬å¸çš„è¡¨æ›´åŠ ç»Ÿä¸€å’Œè§„èŒƒï¼Œå°±æ˜¯ç»Ÿä¸€åŠ ä¸Š <code>@CreatedBy</code>ã€<code>@CreatedDate</code>ã€<code>@LastModifiedBy</code>ã€<code>@LastModifiedDate</code> ç­‰ã€‚</p>
<p>å®é™…å·¥ä½œä¸­ï¼ŒBaseEntity å¯èƒ½è¿˜æ›´å¤æ‚ä¸€ç‚¹ï¼Œæ¯”å¦‚è¯´æŠŠ ID å’Œ @Version åŠ è¿›å»ï¼Œä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@MappedSuperclass</span></span><br><span class="line"><span class="meta">@EntityListeners(AuditingEntityListener.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="meta">@CreatedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer createUserId;</span><br><span class="line">   <span class="meta">@CreatedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant createTime;</span><br><span class="line">   <span class="meta">@LastModifiedBy</span></span><br><span class="line">   <span class="keyword">private</span> Integer lastModifiedUserId;</span><br><span class="line">   <span class="meta">@LastModifiedDate</span></span><br><span class="line">   <span class="keyword">private</span> Instant lastModifiedTime;</span><br><span class="line">   <span class="meta">@Version</span></span><br><span class="line">   <span class="keyword">private</span> Integer version;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Auditing åœ¨å®æˆ˜åº”ç”¨åœºæ™¯ä¸­ï¼Œæ¯”è¾ƒé€‚åˆåšåå°ç®¡ç†é¡¹ç›®ï¼Œå¯¹åº”çº¯ç²¹çš„ RESTAPI é¡¹ç›®ï¼Œæä¾›ç»™ç”¨æˆ·ç›´æ¥æŸ¥è¯¢çš„ API çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä¸€ä¸ªç‰¹æ®Šçš„ User IDã€‚</p>
</li>
</ol>
<h2 id="Auditing-çš„å®ç°åŸç†"><a href="#Auditing-çš„å®ç°åŸç†" class="headerlink" title="Auditing çš„å®ç°åŸç†"></a>Auditing çš„å®ç°åŸç†</h2><p>ç¬¬ä¸€æ­¥ï¼šè¿˜æ˜¯ä» <code>@EnableJpaAuditing</code> å…¥æ‰‹åˆ†æã€‚</p>
<p>æˆ‘ä»¬å‰é¢è®²äº†å®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™æ¬¡æˆ‘ä»¬åˆ†æä¸€ä¸‹å…¶åŠ è½½åŸç†ï¼Œçœ‹ä¸‹é¢çš„å›¾ï¼š</p>
<p><img src="http://image.leonote.cn/20201106150940.png" alt=""></p>
<p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œé¦–å…ˆ Auditing è¿™å¥—å°è£…æ˜¯ Spring Data JPA å®ç°çš„ï¼Œè€Œä¸æ˜¯ Java Persistence API è§„å®šçš„ï¼Œå…¶æ³¨è§£é‡Œé¢è¿˜æœ‰ä¸€é¡¹é‡è¦åŠŸèƒ½å°±æ˜¯ <code>@Import(JpaAuditingRegistrar.class)</code> è¿™ä¸ªç±»ï¼Œå®ƒå¸®æˆ‘ä»¬å¤„ç† Auditing çš„é€»è¾‘ã€‚</p>
<p>æˆ‘ä»¬çœ‹å…¶æºç ï¼Œä¸€æ­¥ä¸€æ­¥åœ° debug ä¸‹å»å¯ä»¥å‘ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201106151104.png" alt=""></p>
<p>è¿›ä¸€æ­¥è¿›å…¥åˆ°å¦‚ä¸‹æ–¹æ³•ä¸­ï¼š</p>
<p><img src="http://image.leonote.cn/20201106151437.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ° Spring å®¹å™¨ç»™ <code>AuditingEntityListener.class</code> æ³¨å…¥äº†ä¸€ä¸ª <code>AuditingHandler</code> çš„å¤„ç†ç±»ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šæ‰“å¼€ <code>AuditingEntityListener.class</code> çš„æºç åˆ†æ debug ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configurable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditingEntityListener</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="meta">@Nullable</span> ObjectFactory&lt;AuditingHandler&gt; handler;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuditingHandler</span><span class="params">(ObjectFactory&lt;AuditingHandler&gt; auditingHandler)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(auditingHandler, <span class="string">&quot;AuditingHandler must not be null!&quot;</span>);</span><br><span class="line">      <span class="keyword">this</span>.handler = auditingHandler;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PrePersist</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">touchForCreate</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(target, <span class="string">&quot;Entity must not be null!&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">         AuditingHandler object = handler.getObject();</span><br><span class="line">         <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            object.markCreated(target);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@PreUpdate</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">touchForUpdate</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(target, <span class="string">&quot;Entity must not be null!&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">         AuditingHandler object = handler.getObject();</span><br><span class="line">         <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</span><br><span class="line">            object.markModified(target);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>AuditingEntityListener</code> çš„å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåˆ©ç”¨äº† Java Persistence API é‡Œé¢çš„<code>@PrePersist</code>ã€<code>@PreUpdate</code> å›è°ƒå‡½æ•°ï¼Œåœ¨æ›´æ–°å’Œåˆ›å»ºä¹‹å‰é€šè¿‡<code>AuditingHandler</code> æ·»åŠ äº†ç”¨æˆ·ä¿¡æ¯å’Œæ—¶é—´ä¿¡æ¯ã€‚</p>
<h3 id="åŸç†åˆ†æç»“è®º"><a href="#åŸç†åˆ†æç»“è®º" class="headerlink" title="åŸç†åˆ†æç»“è®º"></a>åŸç†åˆ†æç»“è®º</h3><p>æŸ¥çœ‹ Auditing çš„å®ç°æºç ï¼Œå…¶å®ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ€è·¯ï¼Œå°±æ˜¯æ€ä¹ˆåˆ©ç”¨ <code>@PrePersist</code>ã€<code>@PreUpdate</code> ç­‰å›è°ƒå‡½æ•°å’Œ <code>@EntityListeners</code> å®šä¹‰è‡ªå·±çš„æ¡†æ¶ä»£ç ã€‚è¿™æ˜¯å€¼å¾—æˆ‘ä»¬å­¦ä¹ å’Œå‚è€ƒçš„ï¼Œæ¯”å¦‚è¯´ Auditing çš„æ“ä½œæ—¥å¿—åœºæ™¯ç­‰ã€‚</p>
<p>æƒ³æˆåŠŸé…ç½® Auditing åŠŸèƒ½ï¼Œå¿…é¡»å°† <code>@EnableJpaAuditing</code> å’Œ <code>@EntityListeners(AuditingEntityListener.class)</code> ä¸€èµ·ä½¿ç”¨æ‰æœ‰æ•ˆã€‚</p>
<p>æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ä¸é€šè¿‡ Spring data JPA ç»™æˆ‘ä»¬æä¾›çš„ Auditing åŠŸèƒ½ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ <code>@PrePersist</code>ã€<code>@PreUpdate</code> å›è°ƒå‡½æ•°æ³¨è§£åœ¨å®ä½“ä¸Šï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œå› ä¸ºå›è°ƒå‡½æ•°æ˜¯å®ç°çš„æœ¬è´¨ã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Auditing</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa è‡ªå®šä¹‰å‚æ•°è§£æå™¨</title>
    <url>/2020/11/13/SpringDataJpa%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8/</url>
    <content><![CDATA[<h1 id="è‡ªå®šä¹‰-HandlerMethodArgumentResolver"><a href="#è‡ªå®šä¹‰-HandlerMethodArgumentResolver" class="headerlink" title="è‡ªå®šä¹‰ HandlerMethodArgumentResolver"></a>è‡ªå®šä¹‰ HandlerMethodArgumentResolver</h1><p>å‚æ•°è§£æå™¨ â€“ Method Argument Resolver</p>
<ul>
<li><code>SpringDataWebConfiguration</code> ç±»æ˜¯å¦‚ä½•è¢«åŠ è½½çš„</li>
<li><code>PageableHandlerMethodArgumentResolver</code> æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„</li>
<li><code>SortHandlerMethodArgumentResolver</code> æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„</li>
<li>å¦‚ä½•å®šä¹‰è‡ªå·±çš„ <code>HandlerMethodArgumentResolvers</code> ç±»</li>
<li>è¿˜æœ‰æ²¡æœ‰å…¶ä»– Web åœºæ™¯éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰å‘¢</li>
</ul>
<h2 id="Page-å’Œ-Sort-å‚æ•°åŸç†"><a href="#Page-å’Œ-Sort-å‚æ•°åŸç†" class="headerlink" title="Page å’Œ Sort å‚æ•°åŸç†"></a>Page å’Œ Sort å‚æ•°åŸç†</h2><p>æ˜¯ <code>@EnableSpringDataWebSupport</code> æ³¨è§£å°†<code>SpringDataWebConfiguration</code>è¿™ä¸ªç±»åŠ è½½è¿›å»çš„ï¼Œè¿™ä¸ªç±»é‡Œé¢æŠŠåˆ†é¡µå’Œæ’åºçš„å‚æ•°åŠ è½½è¿›å»ï¼Œå…³é”®ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201113141756.png" alt=""></p>
<p>å…¶ä¸­ï¼Œ<code>@EnableSpringDataWebSupport</code> æ³¨è§£æ˜¯ Spring Data JPA å¯¹ Web æ”¯æŒéœ€è¦å¼€å¯çš„å…¥å£ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Spring Bootï¼Œæ‰€ä»¥ <code>@EnableSpringDataWebSupport</code> ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»æŒ‡å®šã€‚è¿™æ˜¯ç”±äº Spring Boot æœ‰è‡ªåŠ¨åŠ è½½çš„æœºåˆ¶ï¼Œ<code>SpringDataWebAutoConfiguration</code> ç±»é‡Œé¢å¼•ç”¨äº† <code>@EnableSpringDataWebSupport</code> çš„æ³¨è§£ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨å»å¼•ç”¨äº†ã€‚å…³é”®ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201113142007.png" alt=""></p>
<p>è€Œ Spring Boot çš„è‡ªåŠ¨åŠ è½½çš„æ ¸å¿ƒæ–‡ä»¶å°±æ˜¯ <code>spring.factories</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰“å¼€ spring-boot-autoconfigure-2.3.3.jar åŒ…ï¼Œçœ‹ä¸€ä¸‹ <code>spring.factories</code> æ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥æ‰¾åˆ° <code>SpringDataWebAutoConfiguration</code> è¿™ä¸ªé…ç½®ç±»ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn/20201116125713.png" alt=""></p>
<blockquote>
<p>ç»“è®ºï¼šåªè¦æ˜¯ Spring Boot é¡¹ç›®ï¼Œä»€ä¹ˆéƒ½ä¸éœ€è¦åšï¼Œå®ƒä¼šå¤©ç„¶åœ°è®© Spring Data JPA æ”¯æŒ Web ç›¸å…³çš„æ“ä½œã€‚</p>
</blockquote>
<p><img src="http://image.leonote.cn/20201116125905.png" alt=""></p>
<p>å› ä¸º <code>PageableHandlerMethodArgumentResolver</code> å’Œ <code>SortHandlerMethodArgumentResolver</code>  ä¸¤ä¸ªç±»æ˜¯é€šè¿‡ <code>SpringDataWebConfiguration</code> åŠ è½½è¿›å»çš„ï¼Œæ‰€ä»¥åŸºæœ¬å¯ä»¥çŸ¥é“ Spring Data JPA çš„ Page å’Œ Sort å‚æ•°æ˜¯å› ä¸º <code>SpringDataWebConfiguration</code> é‡Œé¢ @Bean çš„æ³¨å…¥æ‰ç”Ÿæ•ˆçš„ã€‚</p>
<p><img src="http://image.leonote.cn/20201116131624.png" alt=""></p>
<p>é€šè¿‡ <code>PageableHandlerMethodArgumentResolver</code> å’Œ <code>SortHandlerMethodArgumentResolver</code> è¿™ä¸¤ä¸ªç±»çš„æºç ï¼Œå¯ä»¥çŸ¥é“å®ƒä»¬å®ç°äº† <code>org.springframework.web.method.support.HandlerMethodArgumentResolver</code> è¿™ä¸ªæ¥å£ï¼Œä»è€Œå¯¹ Request é‡Œé¢çš„ Page å’Œ Sort çš„å‚æ•°åšäº†å¤„ç†é€»è¾‘å’Œè§£æé€»è¾‘ã€‚</p>
<p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œå¯èƒ½å­˜åœ¨ç‰¹æ®Šæƒ…å†µéœ€è¦å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œæ¯”å¦‚ Page çš„å‚æ•°å¯èƒ½éœ€è¦æ”¯æŒå¤šç§ Key çš„æƒ…å†µï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<h2 id="HandlerMethodArgumentResolver-ç”¨æ³•"><a href="#HandlerMethodArgumentResolver-ç”¨æ³•" class="headerlink" title="HandlerMethodArgumentResolver ç”¨æ³•"></a>HandlerMethodArgumentResolver ç”¨æ³•</h2><h3 id="æ¥å£æ–¹æ³•è¯¦è§£"><a href="#æ¥å£æ–¹æ³•è¯¦è§£" class="headerlink" title="æ¥å£æ–¹æ³•è¯¦è§£"></a>æ¥å£æ–¹æ³•è¯¦è§£</h3><p>ç†Ÿæ‚‰ MVC çš„äººéƒ½çŸ¥é“ï¼ŒHandlerMethodArgumentResolvers åœ¨ Spring MVC ä¸­çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ Controller é‡Œé¢çš„æ–¹æ³•å‚æ•°åšè§£æï¼Œå³å¯ä»¥æŠŠ Request é‡Œé¢çš„å€¼æ˜ å°„åˆ°æ–¹æ³•çš„å‚æ•°ä¸­ã€‚æ‰“å¼€æ­¤ç±»çš„æºç ä¼šå‘ç°åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">   <span class="comment">//æ£€æŸ¥æ–¹æ³•çš„å‚æ•°æ˜¯å¦æ”¯æŒå¤„ç†å’Œè½¬åŒ–</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span></span>;</span><br><span class="line">   <span class="comment">//æ ¹æ®requestä¸Šä¸‹æ–‡ï¼Œè§£ææ–¹æ³•çš„å‚æ•°</span></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">	<span class="function">Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">			NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ¥å£çš„åº”ç”¨åœºæ™¯éå¸¸å¹¿æ³›ï¼Œå¯ä»¥çœ‹åˆ°å…¶å­ç±»éå¸¸å¤šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201116135238.png" alt=""></p>
<p>å…¶ä¸­å‡ ä¸ªç±»çš„ä½œç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><code>PathVariableMapMethodArgumentResolver</code> ä¸“é—¨è§£æ @PathVariable é‡Œé¢çš„å€¼ï¼›</p>
</li>
<li><p><code>RequestResponseBodyMethodProcessor</code> ä¸“é—¨è§£æ @RequestBody æ³¨è§£çš„æ–¹æ³•å‚æ•°çš„å€¼ï¼›</p>
</li>
<li><p><code>RequestParamMethodArgumentResolver</code> ä¸“é—¨è§£æ @RequestParam çš„æ³¨è§£å‚æ•°çš„å€¼ï¼Œå½“æ–¹æ³•çš„å‚æ•°ä¸­æ²¡æœ‰ä»»ä½•æ³¨è§£çš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯ @RequestParamï¼›</p>
</li>
<li><p><code>PageableHandlerMethodArgumentResolver</code> ä¸“é—¨è§£æ @PageableDefault Pageable çš„å€¼</p>
</li>
<li><p><code>SortHandlerMethodArgumentResolver</code></p>
</li>
</ul>
<h3 id="ä¸-HttpMessageConverter-çš„å…³ç³»"><a href="#ä¸-HttpMessageConverter-çš„å…³ç³»" class="headerlink" title="ä¸ HttpMessageConverter çš„å…³ç³»"></a>ä¸ HttpMessageConverter çš„å…³ç³»</h3><p>æ‰“å¼€ <code>RequestResponseBodyMethodProcessor</code> å°±ä¼šå‘ç°ï¼Œè¿™ä¸ªç±»ä¸­ä¸»è¦å¤„ç†çš„æ˜¯ï¼Œæ–¹æ³•é‡Œé¢å¸¦ @RequestBody æ³¨è§£çš„å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201117095947.png" alt=""></p>
<p>è€Œå…¶ä¸­çš„ <code>readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType())</code> æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬ç‚¹è¿›å»ç»§ç»­è§‚å¯Ÿï¼Œå‘ç°é‡Œé¢<strong>ä¼šæ ¹æ® Http è¯·æ±‚çš„ MediaTypeï¼Œæ¥é€‰æ‹©ä¸åŒçš„ HttpMessageConverter è¿›è¡Œè½¬åŒ–</strong>ã€‚</p>
<blockquote>
<p>ä¸åŒçš„ <code>HttpMessageConverter</code> éƒ½æ˜¯ç”± <code>RequestResponseBodyMethodProcessor</code> è¿›è¡Œè°ƒç”¨çš„</p>
</blockquote>
<h2 id="HttpMessageConverter-çš„æ‰§è¡Œé¡ºåº"><a href="#HttpMessageConverter-çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="HttpMessageConverter çš„æ‰§è¡Œé¡ºåº"></a>HttpMessageConverter çš„æ‰§è¡Œé¡ºåº</h2><p>å½“æˆ‘ä»¬è‡ªå®šä¹‰ HandlerMethodArgumentResolver æ—¶ï¼Œé€šè¿‡ä¸‹é¢çš„æ–¹æ³•åŠ è½½è¿›å»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>&#123;</span><br><span class="line">   resolvers.add(myPageableHandlerMethodArgumentResolver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>List&lt;HandlerMethodArgumentResolver&gt;</code> é‡Œé¢<strong>è‡ªå®šä¹‰çš„ resolver çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„</strong>ï¼Œä¹Ÿå°±æ˜¯ä¼šä¼˜å…ˆæ‰§è¡Œ <code>HandlerMethodArgumentResolver</code> ä¹‹åï¼Œæ‰ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œç³»ç»Ÿé‡Œé¢è‡ªå¸¦çš„é‚£ä¸€æ‰¹ <code>HttpMessageConverter</code>ï¼ŒæŒ‰ç…§ List çš„é¡ºåºæ‰§è¡Œã€‚</p>
<p>Spring é‡Œé¢æœ‰ä¸ªæ‰§è¡Œæ•ˆç‡é—®é¢˜ï¼Œå°±æ˜¯ä¸€æ—¦ä¸€æ¬¡æ‰§è¡Œæ‰¾åˆ°äº†éœ€è¦çš„ <code>HandlerMethodArgumentResolver</code> çš„æ—¶å€™ï¼Œåˆ©ç”¨ <strong>Spring ä¸­çš„ç¼“å­˜æœºåˆ¶</strong>ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å°±ä¸ä¼šå†éå† <code>List&lt;HandlerMethodArgumentResolver&gt;</code> äº†ï¼Œè€Œæ˜¯ç›´æ¥ç”¨ä¸Šæ¬¡æ‰¾åˆ°çš„ <code>HandlerMethodArgumentResolver</code>ï¼Œè¿™æ ·æå‡äº†æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>å¦‚æœæƒ³è¦äº†è§£æ›´å¤šçš„ Resolverï¼Œå¯ä»¥çœ‹ä¸‹å›¾è¿™ä¸ªç±»çš„ä»£ç ï¼š</p>
<p><img src="http://image.leonote.cn/20201117100937.png" alt=""></p>
<h2 id="å¦‚ä½•è‡ªå®šä¹‰-HandlerMethodArgumentResolver"><a href="#å¦‚ä½•è‡ªå®šä¹‰-HandlerMethodArgumentResolver" class="headerlink" title="å¦‚ä½•è‡ªå®šä¹‰ HandlerMethodArgumentResolver"></a>å¦‚ä½•è‡ªå®šä¹‰ HandlerMethodArgumentResolver</h2><p>åœ¨å®é™…çš„å·¥ä½œä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å¯¹è€é¡¹ç›®è¿›è¡Œæ”¹ç‰ˆçš„å·¥ä½œï¼Œå¦‚æœè¦æˆ‘ä»¬æŠŠæ—§çš„ API æ¥å£æ”¹é€ æˆ JPA çš„æŠ€æœ¯å®ç°ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°éœ€è¦æ–°ã€è€å‚æ•°çš„é—®é¢˜ã€‚å‡è®¾åœ¨å®é™…åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ Page çš„å‚æ•°æ˜¯ page[number]ï¼Œè€Œ page size çš„å‚æ•°æ˜¯ page[size]ï¼Œçœ‹çœ‹åº”è¯¥æ€ä¹ˆåšã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šæ–°å»º MyPageableHandlerMethodArgumentResolver</strong></p>
<p>è¿™ä¸ªç±»çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li><p>ç”¨æ¥å…¼å®¹ ?page[size]=2&amp;page[number]=0 çš„å‚æ•°æƒ…å†µï¼›</p>
</li>
<li><p>æ”¯æŒ JPA æ–°çš„å‚æ•°å½¢å¼ ?size=2&amp;page=0ã€‚</p>
</li>
</ul>
<p>é€šè¿‡è‡ªå®šä¹‰çš„ <code>MyPageableHandlerMethodArgumentResolver</code> æ¥å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œè¯·çœ‹ä¸‹é¢è¿™æ®µä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡<span class="doctag">@Component</span>æŠŠæ­¤ç±»åŠ è½½åˆ°Springçš„å®¹å™¨é‡Œé¢å» </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPageableHandlerMethodArgumentResolver</span> <span class="keyword">extends</span> <span class="title">PageableHandlerMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">   <span class="comment">//æˆ‘ä»¬å‡è®¾sortçš„å‚æ•°æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‡‡ç”¨PageableHandlerMethodArgumentResolveré‡Œé¢çš„å†™æ³•</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SortHandlerMethodArgumentResolver DEFAULT_SORT_RESOLVER = <span class="keyword">new</span> SortHandlerMethodArgumentResolver();</span><br><span class="line">   <span class="comment">//ç»™å®šä¸¤ä¸ªé»˜è®¤å€¼</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEFAULT_PAGE = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEFAULT_SIZE = <span class="number">10</span>;</span><br><span class="line">   <span class="comment">//å…¼å®¹æ–°ç‰ˆï¼Œå¼•å…¥JPAçš„åˆ†é¡µå‚æ•°</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JPA_PAGE_PARAMETER = <span class="string">&quot;page&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JPA_SIZE_PARAMETER = <span class="string">&quot;size&quot;</span>;</span><br><span class="line">   <span class="comment">//å…¼å®¹åŸæ¥è€çš„åˆ†é¡µå‚æ•°</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PAGE_PARAMETER = <span class="string">&quot;page[number]&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SIZE_PARAMETER = <span class="string">&quot;page[size]&quot;</span>;</span><br><span class="line">   <span class="keyword">private</span> SortArgumentResolver sortResolver;</span><br><span class="line">   <span class="comment">//æ¨¡ä»¿ PageableHandlerMethodArgumentResolver é‡Œé¢çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MyPageableHandlerMethodArgumentResolver</span><span class="params">(<span class="meta">@Nullable</span> SortArgumentResolver sortResolver)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.sortResolver = sortResolver == <span class="keyword">null</span> ? DEFAULT_SORT_RESOLVER : sortResolver;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line"><span class="comment">//    å‡è®¾ç”¨æˆ‘ä»¬è‡ªå·±çš„ç±» MyPageRequest æ¥æ”¶å‚æ•°</span></span><br><span class="line">      <span class="keyword">return</span> MyPageRequest.class.equals(parameter.getParameterType());</span><br><span class="line">      <span class="comment">//åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¯æŒé€šè¿‡Spring Data JPAé‡Œé¢çš„Pageableå‚æ•°è¿›è¡Œæ¥æ”¶ï¼Œä¸¤ç§æ•ˆæœæ˜¯ä¸€æ ·çš„</span></span><br><span class="line"><span class="comment">//    return Pageable.class.equals(parameter.getParameterType());</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‚æ•°å°è£…é€»è¾‘pageå’Œsortï¼ŒJPAå‚æ•°çš„ä¼˜å…ˆçº§é«˜äºpage[number]å’Œpage[size]å‚æ•°</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">//public Pageable resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) &#123; //è¿™ç§æ˜¯Pageableçš„æ–¹å¼</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> MyPageRequest <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> </span>&#123;</span><br><span class="line">      String jpaPageString = webRequest.getParameter(JPA_PAGE_PARAMETER);</span><br><span class="line">      String jpaSizeString = webRequest.getParameter(JPA_SIZE_PARAMETER);</span><br><span class="line">      <span class="comment">//æˆ‘ä»¬åˆ†åˆ«å–å‚æ•°é‡Œé¢pageã€sortå’Œ page[number]ã€page[size]çš„å€¼</span></span><br><span class="line">      String pageString = webRequest.getParameter(DEFAULT_PAGE_PARAMETER);</span><br><span class="line">      String sizeString = webRequest.getParameter(DEFAULT_SIZE_PARAMETER);</span><br><span class="line">      <span class="comment">//å½“ä¸¤ä¸ªéƒ½æœ‰å€¼æ—¶å€™çš„ä¼˜å…ˆçº§ï¼ŒåŠå…¶é»˜è®¤å€¼çš„é€»è¾‘</span></span><br><span class="line">      Integer page = jpaPageString != <span class="keyword">null</span> ? Integer.valueOf(jpaPageString) : pageString != <span class="keyword">null</span> ? Integer.valueOf(pageString) : DEFAULT_PAGE;</span><br><span class="line">      <span class="comment">//åœ¨è¿™é‡ŒåŒæ—¶å¯ä»¥è®¡ç®— page+1çš„é€»è¾‘;å¦‚ï¼špage=page+1;</span></span><br><span class="line">      Integer size = jpaSizeString != <span class="keyword">null</span> ? Integer.valueOf(jpaSizeString) : sizeString != <span class="keyword">null</span> ? Integer.valueOf(sizeString) : DEFAULT_SIZE;</span><br><span class="line">       <span class="comment">//æˆ‘ä»¬å‡è®¾ï¼Œsortæ’åºçš„å–å€¼æ–¹æ³•å…ˆä¸å‘ç”Ÿæ”¹å˜</span></span><br><span class="line">      Sort sort = sortResolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);</span><br><span class="line"><span class="comment">//    å¦‚æœä½¿ç”¨ Pageable å‚æ•°æ¥æ”¶å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨è‡ªå®šä¹‰ MyPageRequest å¯¹è±¡ï¼Œç›´æ¥è¿”å› PageRequest;</span></span><br><span class="line"><span class="comment">//    return PageRequest.of(page,size,sort);</span></span><br><span class="line">      <span class="comment">//å°† page å’Œ size è®¡ç®—å‡ºæ¥çš„è®°è¿‡å°è£…åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ MyPageRequest ç±»é‡Œé¢å»</span></span><br><span class="line">      MyPageRequest myPageRequest = <span class="keyword">new</span> MyPageRequest(page, size,sort);</span><br><span class="line">      <span class="comment">//è¿”å› controller é‡Œé¢çš„å‚æ•°éœ€è¦çš„å¯¹è±¡ï¼›</span></span><br><span class="line">      <span class="keyword">return</span> myPageRequest;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç çš„é€»è¾‘å°±æ˜¯å– Request çš„ Page ç›¸å…³çš„å‚æ•°ï¼Œå°è£…åˆ°å¯¹è±¡ä¸­è¿”å›ç»™ Controller çš„æ–¹æ³•å‚æ•°é‡Œé¢ã€‚</p>
<p>å…¶ä¸­ MyPageRequest ä¸æ˜¯å¿…éœ€çš„ï¼Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºä¸åŒçš„åšæ³•ã€‚</p>
<p><strong>ç¬¬äºŒæ­¥ï¼šæ–°å»º MyPageRequest</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»§æ‰¿çˆ¶ç±»ï¼Œå¯ä»¥çœæ‰å¾ˆå¤šè®¡ç®— page å’Œ index çš„é€»è¾‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPageRequest</span> <span class="keyword">extends</span> <span class="title">PageRequest</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="title">MyPageRequest</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size, Sort sort)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(page, size, sort);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤ç±»ï¼Œæˆ‘ä»¬ç”¨æ¥æ¥æ”¶ Page ç›¸å…³çš„å‚æ•°å€¼ï¼Œä¹Ÿä¸æ˜¯å¿…éœ€çš„ã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥ï¼šimplements WebMvcConfigurer åŠ è½½ myPageableHandlerMethodArgumentResolver</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®ç° WebMvcConfigurer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> MyPageableHandlerMethodArgumentResolver myPageableHandlerMethodArgumentResolver;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼ŒæŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ myPageableHandlerMethodArgumentResolver åŠ è½½åˆ°åŸå§‹çš„ mvc çš„ resolvers é‡Œé¢å»</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> resolvers</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>&#123;</span><br><span class="line">      resolvers.add(myPageableHandlerMethodArgumentResolver);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ©ç”¨ Spring MVC çš„æœºåˆ¶åŠ è½½æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>myPageableHandlerMethodArgumentResolver</code>ï¼Œç”±äºè‡ªå®šä¹‰çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œæ‰€ä»¥ç”¨ MyPageRequest.class å’Œ Pageable.class éƒ½æ˜¯å¯ä»¥çš„</p>
<p><strong>ç¬¬å››æ­¥ï¼š Controller é‡Œé¢çš„å†™æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”¨ Pageable è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/users&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;UserInfo&gt; <span class="title">queryByPage</span><span class="params">(Pageable pageable, UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.findAll(Example.of(userInfo),pageable);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”¨ MyPageRequest è¿›è¡Œæ¥æ”¶</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/users/mypage&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;UserInfo&gt; <span class="title">queryByMyPage</span><span class="params">(MyPageRequest pageable, UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.findAll(Example.of(userInfo),pageable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ©ç”¨ Pageable å’Œ MyPageRequest ä¸¤ç§æ–¹å¼éƒ½æ˜¯å¯ä»¥çš„ã€‚</p>
<p><strong>ç¬¬äº”æ­¥ï¼šå¯åŠ¨é¡¹ç›®æµ‹è¯•ä¸€ä¸‹</strong></p>
<p>ä¾æ¬¡å¯ä»¥æµ‹è¯•ä¸‹é¢ä¸¤ç§æƒ…å†µï¼Œå‘ç°éƒ½æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/users?page[size]=2&amp;page[number]=0&amp;ages=10&amp;sort=id,desc</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/users?size=2&amp;page=0&amp;ages=10&amp;sort=id,desc</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/users/mypage?page[size]=2&amp;page[number]=0&amp;ages=10&amp;sort=id,desc</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/users/mypage?size=2&amp;page=0&amp;ages=10&amp;sort=id,desc</span><br></pre></td></tr></table></figure>

<p>æ¼”ç¤ºçš„ Controller æ–¹æ³•é‡Œé¢æœ‰å¤šä¸ªå‚æ•°çš„ï¼Œæ¯ä¸ªå‚æ•°éƒ½å„å¸å…¶èŒï¼Œæ‰¾åˆ°è‡ªå·±å¯¹åº”çš„ <code>HandlerMethodArgumentResolver</code>ï¼Œè¿™æ­£æ˜¯ Spring MVC æ¡†æ¶çš„ä¼˜é›…ä¹‹å¤„ã€‚</p>
<h2 id="å®é™…å·¥ä½œçš„å»ºè®®"><a href="#å®é™…å·¥ä½œçš„å»ºè®®" class="headerlink" title="å®é™…å·¥ä½œçš„å»ºè®®"></a>å®é™…å·¥ä½œçš„å»ºè®®</h2><p>è‡ªå®šä¹‰ HandlerMethodArgumentResolver åˆ°åº•å¯¹æˆ‘ä»¬çš„å·¥ä½œèµ·åˆ°å“ªäº›ä½œç”¨å‘¢ï¼Ÿ</p>
<h3 id="åœºæ™¯ä¸€"><a href="#åœºæ™¯ä¸€" class="headerlink" title="åœºæ™¯ä¸€"></a>åœºæ™¯ä¸€</h3><p>å½“æˆ‘ä»¬åœ¨ Controller é‡Œé¢å¤„ç†æŸäº›å‚æ•°æ—¶ï¼Œé‡å¤çš„æ­¥éª¤éå¸¸å¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘å†™ä¸€ä¸‹è‡ªå·±çš„æ¡†æ¶ï¼Œæ¥å¤„ç†è¯·æ±‚é‡Œé¢çš„å‚æ•°ï¼Œè€Œ Controller é‡Œé¢çš„ä»£ç å°±ä¼šå˜å¾—éå¸¸ä¼˜é›…ï¼Œä¸éœ€è¦å…³å¿ƒå…¶ä»–æ¡†æ¶ä»£ç ï¼Œåªè¦çŸ¥é“æ–¹æ³•çš„å‚æ•°æœ‰å€¼å°±å¯ä»¥äº†ã€‚</p>
<h3 id="åœºæ™¯äºŒ"><a href="#åœºæ™¯äºŒ" class="headerlink" title="åœºæ™¯äºŒ"></a>åœºæ™¯äºŒ</h3><p>å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨å®é™…å·¥ä½œä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤ JPA é‡Œé¢çš„ Page æ˜¯ä» 0 å¼€å§‹ï¼Œè€Œæˆ‘ä»¬å¯èƒ½æœ‰äº›è€çš„ä»£ç ä¹Ÿè¦ç»´æŠ¤ï¼Œå› ä¸ºè€çš„ä»£ç å¤§å¤šæ•°çš„ Page éƒ½ä¼šä» 1 å¼€å§‹ã€‚å¦‚æœæˆ‘ä»¬ä¸è‡ªå®šä¹‰ <code>HandlerMethodArgumentResolver</code>ï¼Œé‚£ä¹ˆåœ¨ç”¨åˆ°åˆ†é¡µæ—¶ï¼Œæ¯ä¸ª Controller çš„æ–¹æ³•é‡Œé¢éƒ½éœ€è¦å…³å¿ƒè¿™ä¸ªé€»è¾‘ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä½ å°±åº”è¯¥æƒ³åˆ°ä¸Šé¢åˆ—ä¸¾çš„è‡ªå®šä¹‰ <code>MyPageableHandlerMethodArgumentResolver</code> çš„ resolveArgument æ–¹æ³•çš„å®ç°ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•æˆ‘ä»¬åªéœ€è¦åœ¨é‡Œé¢ä¿®æ”¹ Page çš„è®¡ç®—é€»è¾‘å³å¯ã€‚</p>
<h3 id="åœºæ™¯ä¸‰"><a href="#åœºæ™¯ä¸‰" class="headerlink" title="åœºæ™¯ä¸‰"></a>åœºæ™¯ä¸‰</h3><p>å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨å®é™…çš„å·¥ä½œä¸­ï¼Œè¿˜ç»å¸¸ä¼šé‡åˆ°â€œå–å½“å‰ç”¨æˆ·â€çš„åº”ç”¨åœºæ™¯ã€‚æ­¤æ—¶ï¼Œæ™®é€šåšæ³•æ˜¯ï¼Œå½“ä½¿ç”¨åˆ°å½“å‰ç”¨æˆ·çš„ UserInfo æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦æ ¹æ®è¯·æ±‚ header çš„ token å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;user/info&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfo</span><span class="params">(<span class="meta">@RequestHeader</span> String token)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¼ªä»£ç </span></span><br><span class="line">    Long userId = redisTemplate.get(token);</span><br><span class="line">    UserInfo useInfo = userInfoRepository.getById(userId);</span><br><span class="line">    <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code>HandlerMethodArgumentResolver</code> æ¥å£æ¥å®ç°ï¼Œä»£ç å°±ä¼šå˜å¾—ä¼˜é›…è®¸å¤šã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<ol>
<li><p><strong>å®ç° HandlerMethodArgumentResolver æ¥å£</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoArgumentResolver</span> <span class="keyword">implements</span> <span class="title">HandlerMethodArgumentResolver</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> RedisTemplate redisTemplate;<span class="comment">//ä¼ªä»£ç ï¼Œå‡è®¾æˆ‘ä»¬tokenæ˜¯æ”¾åœ¨redisé‡Œé¢çš„</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> UserInfoRepository userInfoRepository;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">UserInfoArgumentResolver</span><span class="params">(RedisTemplate redisTemplate, UserInfoRepository userInfoRepository)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.redisTemplate = redisTemplate;<span class="comment">//ä¼ªä»£ç ï¼Œå‡è®¾æˆ‘ä»¬tokenæ˜¯æ”¾åœ¨redisé‡Œé¢çš„</span></span><br><span class="line">      <span class="keyword">this</span>.userInfoRepository = userInfoRepository;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsParameter</span><span class="params">(MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> UserInfo.class.isAssignableFrom(parameter.getParameterType());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params">                          NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      HttpServletRequest nativeRequest = (HttpServletRequest) webRequest.getNativeRequest();</span><br><span class="line">      String token = nativeRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">      Long userId = (Long) redisTemplate.opsForValue().get(token);<span class="comment">//ä¼ªä»£ç ï¼Œå‡è®¾æˆ‘ä»¬tokenæ˜¯æ”¾åœ¨redisé‡Œé¢çš„</span></span><br><span class="line">      UserInfo useInfo = userInfoRepository.getOne(userId);</span><br><span class="line">      <span class="keyword">return</span> useInfo;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åªéœ€è¦åœ¨ MyWebMvcConfigurer é‡Œé¢æŠŠ userInfoArgumentResolver æ·»åŠ è¿›å»å³å¯</strong>ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> MyPageableHandlerMethodArgumentResolver myPageableHandlerMethodArgumentResolver;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserInfoArgumentResolver userInfoArgumentResolver;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArgumentResolvers</span><span class="params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>&#123;</span><br><span class="line">      resolvers.add(myPageableHandlerMethodArgumentResolver);</span><br><span class="line">      <span class="comment">//æˆ‘ä»¬åªéœ€è¦æŠŠuserInfoArgumentResolveråŠ å…¥resolversä¸­å³å¯</span></span><br><span class="line">      resolvers.add(userInfoArgumentResolver);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åœ¨ Controller ä¸­ä½¿ç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoController</span> </span>&#123;</span><br><span class="line">  <span class="comment">//è·å¾—å½“å‰ç”¨æˆ·çš„ä¿¡æ¯</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;user/info&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfo</span><span class="params">(UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> userInfo;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//ç»™å½“å‰ç”¨æˆ· say hello</span></span><br><span class="line">  <span class="meta">@PostMapping(&quot;sayHello&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello &quot;</span> + userInfo.getTelephone();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Controller é‡Œé¢å¯ä»¥å®Œå…¨çœæ‰æ ¹æ® token ä» redis å–å½“å‰ç”¨æˆ·ä¿¡æ¯çš„è¿‡ç¨‹ï¼Œä¼˜åŒ–äº†æ“ä½œæµç¨‹ã€‚</p>
<h3 id="åœºæ™¯å››"><a href="#åœºæ™¯å››" class="headerlink" title="åœºæ™¯å››"></a>åœºæ™¯å››</h3><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šæ›´æ”¹ Pageable çš„é»˜è®¤å€¼å’Œå‚æ•°çš„åå­—ï¼Œä¹Ÿå¯ä»¥åœ¨ application.properties çš„æ–‡ä»¶é‡Œé¢é€šè¿‡å¦‚ä¸‹çš„ Key å€¼å¯¹è‡ªå®šä¹‰è¿›è¡Œé…ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201117104905.png" alt=""></p>
<h2 id="æ€è·¯æ‹“å±•"><a href="#æ€è·¯æ‹“å±•" class="headerlink" title="æ€è·¯æ‹“å±•"></a>æ€è·¯æ‹“å±•</h2><h3 id="WebMvcConfigurer-ä»‹ç»"><a href="#WebMvcConfigurer-ä»‹ç»" class="headerlink" title="WebMvcConfigurer ä»‹ç»"></a>WebMvcConfigurer ä»‹ç»</h3><p>å½“æˆ‘ä»¬åš Spring çš„ MVC å¼€å‘çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé€šè¿‡å®ç° <code>WebMvcConfigurer</code> å»åšä¸€äº›å…¬ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾å‡ ä¸ªå¸¸è§çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** æ‹¦æˆªå™¨é…ç½® */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry var1)</span></span>;</span><br><span class="line"><span class="comment">/** è§†å›¾è·³è½¬æ§åˆ¶å™¨ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span></span>;</span><br><span class="line"><span class="comment">/** é™æ€èµ„æºå¤„ç† */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span></span>;</span><br><span class="line"><span class="comment">/** é»˜è®¤é™æ€èµ„æºå¤„ç†å™¨ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span></span>;</span><br><span class="line"><span class="comment">/** è¿™é‡Œé…ç½®è§†å›¾è§£æå™¨ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">configureViewResolvers</span><span class="params">(ViewResolverRegistry registry)</span></span>;</span><br><span class="line"><span class="comment">/** é…ç½®å†…å®¹è£å†³çš„ä¸€äº›é€‰é¡¹ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span></span>;</span><br><span class="line"><span class="comment">/** è§£å†³è·¨åŸŸé—®é¢˜ */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span></span>;</span><br><span class="line"><span class="comment">/** æ·»åŠ å¯¹ controller çš„ Return çš„ç»“æœçš„å¤„ç† */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addReturnValueHandlers</span><span class="params">(List&lt;HandlerMethodReturnValueHandler&gt; handlers)</span></span>;</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬å®ç° Restful é£æ ¼çš„ API åè®®æ—¶ï¼Œä¼šç»å¸¸çœ‹åˆ°å…¶å¯¹ json å“åº”ç»“æœè¿›è¡Œäº†ç»Ÿä¸€çš„å°è£…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨ <code>HandlerMethodReturnValueHandler</code> æ¥å®ç°ï¼Œå†æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p>
<h3 id="ç”¨-Result-å¯¹-JSON-çš„è¿”å›ç»“æœè¿›è¡Œç»Ÿä¸€å°è£…"><a href="#ç”¨-Result-å¯¹-JSON-çš„è¿”å›ç»“æœè¿›è¡Œç»Ÿä¸€å°è£…" class="headerlink" title="ç”¨ Result å¯¹ JSON çš„è¿”å›ç»“æœè¿›è¡Œç»Ÿä¸€å°è£…"></a>ç”¨ Result å¯¹ JSON çš„è¿”å›ç»“æœè¿›è¡Œç»Ÿä¸€å°è£…</h3><p>ä¸‹é¢é€šè¿‡äº”ä¸ªæ­¥éª¤æ¥å®ç°ä¸€ä¸ªé€šè¿‡è‡ªå®šä¹‰æ³¨è§£ï¼Œåˆ©ç”¨<code>HandlerMethodReturnValueHandler</code> å®ç° JSON ç»“æœå°è£…çš„ä¾‹å­ã€‚</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ @WarpWithData</strong>ï¼Œè¡¨ç¤ºæ­¤æ³¨è§£åŒ…è£…çš„è¿”å›ç»“æœç”¨ Data è¿›è¡ŒåŒ…è£…ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="comment">/** è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£å¯¹è¿”å›ç»“æœè¿›è¡ŒåŒ…è£… */</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> WarpWithData &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒæ­¥ï¼šè‡ªå®šä¹‰ MyWarpWithDataHandlerMethodReturnValueHandlerï¼Œå¹¶ç»§æ‰¿ RequestResponseBodyMethodProcessor æ¥å®ç° HandlerMethodReturnValueHandler æ¥å£</strong>ï¼Œç”¨æ¥å¤„ç† Data åŒ…è£…çš„ç»“æœï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è‡ªå®šä¹‰è‡ªå·±çš„ return çš„å¤„ç†ç±»ï¼Œæˆ‘ä»¬ç›´æ¥ç»§æ‰¿ RequestResponseBodyMethodProcessorï¼Œè¿™æ ·çˆ¶ç±»é‡Œé¢çš„æ–¹æ³•æˆ‘ä»¬ç›´æ¥ä½¿ç”¨å°±å¯ä»¥äº†</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWarpWithDataHandlerMethodReturnValueHandler</span> <span class="keyword">extends</span> <span class="title">RequestResponseBodyMethodProcessor</span> <span class="keyword">implements</span> <span class="title">HandlerMethodReturnValueHandler</span> </span>&#123;</span><br><span class="line">   <span class="comment">//å‚è€ƒçˆ¶ç±» RequestResponseBodyMethodProcessor çš„åšæ³•</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MyWarpWithDataHandlerMethodReturnValueHandler</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(converters);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//åªå¤„ç†éœ€è¦åŒ…è£…çš„æ³¨è§£çš„æ–¹æ³•</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsReturnType</span><span class="params">(MethodParameter returnType)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> returnType.hasMethodAnnotation(WarpWithData.class);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//å°†è¿”å›ç»“æœåŒ…è£…ä¸€å±‚ Data</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter methodParameter, ModelAndViewContainer modelAndViewContainer, NativeWebRequest nativeWebRequest)</span> <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException </span>&#123;</span><br><span class="line">      Map&lt;String,Object&gt; res = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      res.put(<span class="string">&quot;data&quot;</span>,returnValue);</span><br><span class="line">      <span class="keyword">super</span>.handleReturnValue(res,methodParameter,modelAndViewContainer,nativeWebRequest);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰æ­¥ï¼šåœ¨ MyWebMvcConfigurer é‡Œé¢ç›´æ¥æŠŠ myWarpWithDataHandlerMethodReturnValueHandler åŠ å…¥ handlers é‡Œé¢å³å¯</strong>ï¼Œä¹Ÿæ˜¯é€šè¿‡è¦†ç›–çˆ¶ç±» WebMvcConfigurer é‡Œé¢çš„ addReturnValueHandlers æ–¹æ³•å®Œæˆçš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> MyWarpWithDataHandlerMethodReturnValueHandler myWarpWithDataHandlerMethodReturnValueHandler;</span><br><span class="line">   <span class="comment">//æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ myWarpWithDataHandlerMethodReturnValueHandler åŠ å…¥ handlers é‡Œé¢å³å¯</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addReturnValueHandlers</span><span class="params">(List&lt;HandlerMethodReturnValueHandler&gt; handlers)</span> </span>&#123;</span><br><span class="line">      handlers.add(myWarpWithDataHandlerMethodReturnValueHandler);</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> RequestMappingHandlerAdapter requestMappingHandlerAdapter;</span><br><span class="line">  <span class="comment">//ç”±äº HandlerMethodReturnValueHandler å¤„ç†çš„ä¼˜å…ˆçº§é—®é¢˜ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹æ³•ï¼ŒæŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ myWarpWithDataHandlerMethodReturnValueHandler æ”¾åˆ°ç¬¬ä¸€ä¸ªï¼›</span></span><br><span class="line">  <span class="meta">@PostConstruct</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers = Lists.newArrayList(myWarpWithDataHandlerMethodReturnValueHandler);</span><br><span class="line">     <span class="comment">// å–å‡ºåŸå§‹åˆ—è¡¨ï¼Œé‡æ–°è¦†ç›–è¿›å»ï¼›</span></span><br><span class="line">     returnValueHandlers.addAll(requestMappingHandlerAdapter.getReturnValueHandlers());</span><br><span class="line">     requestMappingHandlerAdapter.setReturnValueHandlers(returnValueHandlers);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åˆ©ç”¨ @PostConstruct è°ƒæ•´äº†ä¸€ä¸‹ HandlerMethodReturnValueHandler åŠ è½½çš„ä¼˜å…ˆçº§ï¼Œä½¿å…¶ç”Ÿæ•ˆã€‚</p>
<p><strong>ç¬¬å››æ­¥ï¼šController æ–¹æ³•ä¸­ç›´æ¥åŠ ä¸Š @WarpWithData æ³¨è§£</strong>ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@WarpWithData</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoFromPath</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> userInfoRepository.getOne(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äº”æ­¥ï¼šæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹</strong>ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">GET http://localhost:8089/user/1</span><br></pre></td></tr></table></figure>

<p>å°±ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¿”å›çš„ JSON ç»“æœå¤šäº†ä¸€ä¸ª Data åŒ…è£…ã€‚</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">Â  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">Â  Â  <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;version&quot;</span>: <span class="number">0</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;createUserId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;createTime&quot;</span>: <span class="string">&quot;2020-10-23T00:23:10.185Z&quot;</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;lastModifiedUserId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;lastModifiedTime&quot;</span>: <span class="string">&quot;2020-10-23T00:23:10.185Z&quot;</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;ages&quot;</span>: <span class="number">10</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;telephone&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">Â  Â  <span class="attr">&quot;hibernateLazyInitializer&quot;</span>: &#123;&#125;</span><br><span class="line">Â  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data JPA è‡ªå®šä¹‰è¿”å›å€¼</title>
    <url>/2020/09/27/SpringDataJpa%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%94%E5%9B%9E%E5%80%BC/</url>
    <content><![CDATA[<h1 id="Spring-Data-JPA-è‡ªå®šä¹‰è¿”å›å€¼"><a href="#Spring-Data-JPA-è‡ªå®šä¹‰è¿”å›å€¼" class="headerlink" title="Spring Data JPA è‡ªå®šä¹‰è¿”å›å€¼"></a>Spring Data JPA è‡ªå®šä¹‰è¿”å›å€¼</h1><p>æ‰“å¼€ SimpleJpaRepository ç›´æ¥çœ‹å®ƒçš„ Structure ï¼Œä»å®ƒå®ç°çš„æ–¹æ³•ä»¥åŠçˆ¶ç±»æ¥å£çš„æ–¹æ³•çœ‹åˆ°ï¼Œè¿”å›ç±»å‹åŒ…æ‹¬ï¼šOptionalã€Iterableã€Listã€Pageã€Longã€Booleanã€Entity ç­‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20200926195205.png" alt=""></p>
<p>è€Œå®é™…ä¸Šæ”¯æŒçš„è¿”å›ç±»å‹è¿˜è¦å¤šä¸€äº›ã€‚</p>
<p>ç”±äº Repository é‡Œé¢æ”¯æŒ Iterableï¼Œæ‰€ä»¥ java æ ‡å‡†çš„ Listã€Set éƒ½å¯ä»¥ä½œä¸ºè¿”å›ç»“æœï¼Œå¹¶ä¸”ä¹Ÿä¼šæ”¯æŒå…¶å­ç±»ã€‚</p>
<h2 id="æŸ¥è¯¢ç»“æœçš„è¿”å›å€¼"><a href="#æŸ¥è¯¢ç»“æœçš„è¿”å›å€¼" class="headerlink" title="æŸ¥è¯¢ç»“æœçš„è¿”å›å€¼"></a>æŸ¥è¯¢ç»“æœçš„è¿”å›å€¼</h2><h3 id="Streamable"><a href="#Streamable" class="headerlink" title="Streamable"></a>Streamable</h3><p>Spring Data é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„å­ç±» Streamableï¼ŒStreamable å¯ä»¥æ›¿ä»£ Iterable æˆ–ä»»ä½•é›†åˆç±»å‹ã€‚å®ƒè¿˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥è®¿é—® Streamï¼Œå¯ä»¥ç›´æ¥åœ¨å…ƒç´ ä¸Šè¿›è¡Œ â€¦.filter(â€¦) å’Œ â€¦.map(â€¦) æ“ä½œï¼Œå¹¶å°† Streamable è¿æ¥åˆ°å…¶ä»–å…ƒç´ ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸ªå…³äº UserRepository ç›´æ¥ç»§æ‰¿ JpaRepository çš„ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserRepository ç±»ï¼Œåœ¨æµ‹è¯•ç±»é‡Œé¢åšå¦‚ä¸‹è°ƒç”¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User user = userRepository.save(</span><br><span class="line">    	User.builder().name(<span class="string">&quot;jackxx&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">    	.sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">Assert.assertNotNull(user);</span><br><span class="line">Streamable&lt;User&gt; userStreamable = userRepository</span><br><span class="line">    .findAll(PageRequest.of(<span class="number">0</span>,<span class="number">10</span>))</span><br><span class="line">    .and(User.builder().name(<span class="string">&quot;jack222&quot;</span>).build());</span><br><span class="line">userStreamable.forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User(id=<span class="number">1</span>, name=jackxx, email=<span class="number">123456</span>@<span class="number">126.</span>com, sex=man, address=shanghai)</span><br><span class="line">User(id=<span class="keyword">null</span>, name=jack222, email=<span class="keyword">null</span>, sex=<span class="keyword">null</span>, address=<span class="keyword">null</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­ Streamable<code>&lt;User&gt;</code> userStreamableï¼Œå®ç°äº† Streamable çš„è¿”å›ç»“æœã€‚</p>
<h3 id="è‡ªå®šä¹‰-Streamable"><a href="#è‡ªå®šä¹‰-Streamable" class="headerlink" title="è‡ªå®šä¹‰ Streamable"></a>è‡ªå®šä¹‰ Streamable</h3><p>å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†è‡ªå®šä¹‰ Streamable çš„æ–¹æ³•ï¼Œä¸è¿‡åœ¨å®é™…å·¥ä½œä¸­å¾ˆå°‘å‡ºç°è¦è‡ªå®šä¹‰ä¿è¯ç»“æœç±»çš„æƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123; (<span class="number">1</span>)</span><br><span class="line">  <span class="function">MonetaryAmount <span class="title">getPrice</span><span class="params">()</span> </span>&#123; â€¦ &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RequiredArgConstructor(staticName = &quot;of&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Products</span> <span class="keyword">implements</span> <span class="title">Streamable</span>&lt;<span class="title">Product</span>&gt; </span>&#123; (<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">private</span> Streamable&lt;Product&gt; streamable;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> MonetaryAmount <span class="title">getTotal</span><span class="params">()</span> </span>&#123; (<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> streamable.stream() <span class="comment">//</span></span><br><span class="line">      .map(Priced::getPrice)</span><br><span class="line">      .reduce(Money.of(<span class="number">0</span>), MonetaryAmount::add);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ProductRepository</span> <span class="keyword">implements</span> <span class="title">Repository</span>&lt;<span class="title">Product</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function">Products <span class="title">findAllByDescriptionContaining</span><span class="params">(String text)</span></span>; (<span class="number">4</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå››ä¸ªæ­¥éª¤ä»‹ç»äº†è‡ªå®šä¹‰ Streamable çš„æ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<p>ï¼ˆ1ï¼‰Product å®ä½“ï¼Œå…¬å¼€ API ä»¥è®¿é—®äº§å“ä»·æ ¼ã€‚</p>
<p>ï¼ˆ2ï¼‰Streamable<code>&lt;Product&gt;</code> çš„åŒ…è£…ç±»å‹å¯ä»¥é€šè¿‡ Products.of(â€¦) æ„é€ ï¼ˆé€šè¿‡ Lombok æ³¨è§£åˆ›å»ºçš„å·¥å‚æ–¹æ³•ï¼‰ã€‚</p>
<p>ï¼ˆ3ï¼‰åŒ…è£…å™¨ç±»å‹åœ¨ Streamable<code>&lt;Product&gt;</code> ä¸Šå…¬å¼€äº†è®¡ç®—æ–°å€¼çš„å…¶ä»– APIã€‚</p>
<p>ï¼ˆ4ï¼‰å¯ä»¥å°†åŒ…è£…å™¨ç±»å‹ç›´æ¥ç”¨ä½œæŸ¥è¯¢æ–¹æ³•è¿”å›ç±»å‹ã€‚æ— é¡»è¿”å› Streamable<code>&lt;Product&gt;</code> å¹¶å°†å…¶æ‰‹åŠ¨åŒ…è£…åœ¨å­˜å‚¨åº“ Client ç«¯ä¸­ã€‚</p>
<p>å…¶åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å®ç° Streamableæ¥å£ï¼Œè‡ªå·±å®šä¹‰è‡ªå·±çš„å®ç°ç±»å³å¯ã€‚</p>
<p>æºç åœ¨ QueryExecutionResultHandler ï¼Œå®ƒé‡Œé¢æœ‰å¯¹ Streamable å­ç±»çš„åˆ¤æ–­ï¼Œæ¥æ”¯æŒè‡ªå®šä¹‰ Streamableï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn//20200926200136.png" alt=""></p>
<p>é€šè¿‡æºç ä½ ä¼šå‘ç° Streamable ä¸ºä»€ä¹ˆç”Ÿæ•ˆï¼Œä¸‹é¢æ¥çœ‹çœ‹å¸¸è§çš„é›†åˆç±»çš„è¿”å›å®ç°ã€‚</p>
<h3 id="List-Stream-Page-Slice"><a href="#List-Stream-Page-Slice" class="headerlink" title="List/Stream/Page/Slice"></a>List/Stream/Page/Slice</h3><p>é¦–å…ˆï¼Œæ–°å»ºæˆ‘ä»¬çš„ UserRepositoryï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.Query;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">//è‡ªå®šä¹‰ä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œè¿”å›Streamå¯¹è±¡ï¼Œå¹¶ä¸”æœ‰åˆ†é¡µå±æ€§</span></span><br><span class="line">    <span class="meta">@Query(&quot;select u from User u&quot;)</span></span><br><span class="line">    <span class="function">Stream&lt;User&gt; <span class="title">findAllByCustomQueryAndStream</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line">    <span class="comment">//æµ‹è¯•Sliceçš„è¿”å›ç»“æœ</span></span><br><span class="line">    <span class="meta">@Query(&quot;select u from User u&quot;)</span></span><br><span class="line">    <span class="function">Slice&lt;User&gt; <span class="title">findAllByCustomQueryAndSlice</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œä¿®æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ç±»ï¼Œå¦‚ä¸‹ï¼ŒéªŒè¯ä¸€ä¸‹ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.assertj.core.util.Lists;</span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Slice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.util.Streamable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Stream;</span><br><span class="line"><span class="meta">@DataJpaTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSaveUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        <span class="comment">//æˆ‘ä»¬æ–°å¢7æ¡æ•°æ®æ–¹ä¾¿æµ‹è¯•åˆ†é¡µç»“æœ</span></span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack1&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack2&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack3&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack4&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack5&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack6&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        userRepository.save(User.builder().name(<span class="string">&quot;jack7&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>)</span><br><span class="line">                            .sex(<span class="string">&quot;man&quot;</span>).address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">        <span class="comment">//æˆ‘ä»¬åˆ©ç”¨ObjectMapperå°†æˆ‘ä»¬çš„è¿”å›ç»“æœJson to String</span></span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="comment">//è¿”å›Streamç±»å‹ç»“æœï¼ˆ1ï¼‰</span></span><br><span class="line">        Stream&lt;User&gt; userStream = userRepository.findAllByCustomQueryAndStream(PageRequest.of(<span class="number">1</span>,<span class="number">3</span>));</span><br><span class="line">        userStream.forEach(System.out::println);</span><br><span class="line">        <span class="comment">//è¿”å›åˆ†é¡µæ•°æ®ï¼ˆ2ï¼‰</span></span><br><span class="line">        Page&lt;User&gt; userPage = userRepository.findAll(PageRequest.of(<span class="number">0</span>,<span class="number">3</span>));</span><br><span class="line">        System.out.println(objectMapper.writeValueAsString(userPage));</span><br><span class="line">        <span class="comment">//è¿”å›Sliceç»“æœï¼ˆ3ï¼‰</span></span><br><span class="line">        Slice&lt;User&gt; userSlice = userRepository.findAllByCustomQueryAndSlice(PageRequest.of(<span class="number">0</span>,<span class="number">3</span>));</span><br><span class="line">        System.out.println(objectMapper.writeValueAsString(userSlice));</span><br><span class="line">        <span class="comment">//è¿”å›Listç»“æœï¼ˆ4ï¼‰</span></span><br><span class="line">        List&lt;User&gt; userList = userRepository.findAllById(Lists.newArrayList(<span class="number">1L</span>,<span class="number">2L</span>));</span><br><span class="line">        System.out.println(objectMapper.writeValueAsString(userList));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å››ç§æµ‹è¯•ç»“æœï¼š</p>
<h4 id="ç¬¬ä¸€ç§ï¼šé€šè¿‡-Stream-lt-User-gt-å–ç¬¬äºŒé¡µçš„æ•°æ®"><a href="#ç¬¬ä¸€ç§ï¼šé€šè¿‡-Stream-lt-User-gt-å–ç¬¬äºŒé¡µçš„æ•°æ®" class="headerlink" title="ç¬¬ä¸€ç§ï¼šé€šè¿‡ Stream&lt;User&gt;å–ç¬¬äºŒé¡µçš„æ•°æ®"></a>ç¬¬ä¸€ç§ï¼šé€šè¿‡ Stream<code>&lt;User&gt;</code>å–ç¬¬äºŒé¡µçš„æ•°æ®</h4><p>å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User(id=<span class="number">4</span>, name=jack4, email=<span class="number">123456</span>@<span class="number">126.</span>com, sex=man, address=shanghai)</span><br><span class="line">User(id=<span class="number">5</span>, name=jack5, email=<span class="number">123456</span>@<span class="number">126.</span>com, sex=man, address=shanghai)</span><br><span class="line">User(id=<span class="number">6</span>, name=jack6, email=<span class="number">123456</span>@<span class="number">126.</span>com, sex=man, address=shanghai)</span><br></pre></td></tr></table></figure>

<p>Spring Data çš„æ”¯æŒå¯ä»¥é€šè¿‡ä½¿ç”¨ Java 8 Stream ä½œä¸ºè¿”å›ç±»å‹æ¥é€æ­¥å¤„ç†æŸ¥è¯¢æ–¹æ³•çš„ç»“æœã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæµçš„å…³é—­é—®é¢˜</strong>ï¼Œtry cache æ˜¯ä¸€ç§å¸¸ç”¨çš„å…³é—­æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;User&gt; stream;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   stream = repository.findAllByCustomQueryAndStream()</span><br><span class="line">   stream.forEach(â€¦);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (stream!=<span class="keyword">null</span>)&#123;</span><br><span class="line">      stream.close();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ç¬¬äºŒç§ï¼šè¿”å›-Page-lt-User-gt-çš„åˆ†é¡µæ•°æ®ç»“æœ"><a href="#ç¬¬äºŒç§ï¼šè¿”å›-Page-lt-User-gt-çš„åˆ†é¡µæ•°æ®ç»“æœ" class="headerlink" title="ç¬¬äºŒç§ï¼šè¿”å› Page&lt;User&gt; çš„åˆ†é¡µæ•°æ®ç»“æœ"></a>ç¬¬äºŒç§ï¼šè¿”å› Page<code>&lt;User&gt;</code> çš„åˆ†é¡µæ•°æ®ç»“æœ</h4><p>å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;content&quot;</span>:[</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack1&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">&quot;id&quot;</span>:<span class="number">2</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack2&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">&quot;id&quot;</span>:<span class="number">3</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack3&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line"> <span class="attr">&quot;pageable&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;sorted&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">   <span class="attr">&quot;unsorted&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;empty&quot;</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;pageNumber&quot;</span>:<span class="number">0</span>, <span class="comment">// å½“å‰é¡µç </span></span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span>:<span class="number">3</span>, <span class="comment">// é¡µç å¤§å°</span></span><br><span class="line">  <span class="attr">&quot;offset&quot;</span>:<span class="number">0</span>, <span class="comment">// åç§»é‡</span></span><br><span class="line">  <span class="attr">&quot;paged&quot;</span>:<span class="literal">true</span>, <span class="comment">// æ˜¯å¦åˆ†é¡µäº†</span></span><br><span class="line">  <span class="attr">&quot;unpaged&quot;</span>:<span class="literal">false</span></span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">&quot;totalPages&quot;</span>:<span class="number">3</span>, <span class="comment">// ä¸€å…±æœ‰å¤šå°‘é¡µ</span></span><br><span class="line"> <span class="attr">&quot;last&quot;</span>:<span class="literal">false</span>, <span class="comment">// æ˜¯å¦æ˜¯åˆ°æœ€å</span></span><br><span class="line"> <span class="attr">&quot;totalElements&quot;</span>:<span class="number">7</span>, <span class="comment">// æ€»è®°å½•æ•°</span></span><br><span class="line"> <span class="attr">&quot;numberOfElements&quot;</span>:<span class="number">3</span>, <span class="comment">// å½“å‰æ•°æ®ä¸‹æ ‡</span></span><br><span class="line"> <span class="attr">&quot;sort&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;sorted&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;unsorted&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;empty&quot;</span>:<span class="literal">true</span></span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">&quot;size&quot;</span>:<span class="number">3</span>, <span class="comment">// å½“å‰contentå¤§å°</span></span><br><span class="line"> <span class="attr">&quot;number&quot;</span>:<span class="number">0</span>, <span class="comment">// å½“å‰é¡µé¢ç çš„ç´¢å¼•</span></span><br><span class="line"> <span class="attr">&quot;first&quot;</span>:<span class="literal">true</span>, <span class="comment">// æ˜¯å¦æ˜¯ç¬¬ä¸€é¡µ</span></span><br><span class="line"> <span class="attr">&quot;empty&quot;</span>:<span class="literal">false</span> <span class="comment">// æ˜¯å¦æœ‰æ•°æ®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Page<code>&lt;User&gt;</code> è¿”å›äº†ç¬¬ä¸€ä¸ªé¡µçš„æ•°æ®ï¼Œå¹¶ä¸”å‘Šè¯‰æˆ‘ä»¬ä¸€å…±æœ‰ä¸‰ä¸ªéƒ¨åˆ†çš„æ•°æ®ï¼š</p>
<ul>
<li><strong>content</strong>ï¼šæ•°æ®çš„å†…å®¹ï¼Œç°åœ¨æŒ‡ User çš„ List 3 æ¡ã€‚</li>
<li><strong>pageable</strong>ï¼šåˆ†é¡µæ•°æ®ï¼ŒåŒ…æ‹¬æ’åºå­—æ®µæ˜¯ä»€ä¹ˆåŠå…¶æ–¹å‘ã€å½“å‰æ˜¯ç¬¬å‡ é¡µã€ä¸€å…±å¤šå°‘é¡µã€æ˜¯å¦æ˜¯æœ€åä¸€æ¡ç­‰ã€‚</li>
<li><strong>å½“å‰æ•°æ®çš„æè¿°</strong>ï¼š<ul>
<li>â€œsizeâ€ï¼š3ï¼Œå½“å‰ content å¤§å°</li>
<li>â€œnumberâ€ï¼š0ï¼Œå½“å‰é¡µé¢ç çš„ç´¢å¼•</li>
<li>â€œfirstâ€ï¼štrueï¼Œæ˜¯å¦æ˜¯ç¬¬ä¸€é¡µ</li>
<li>â€œemptyâ€ï¼šfalseï¼Œæ˜¯å¦æ²¡æœ‰æ•°æ®</li>
</ul>
</li>
</ul>
<h4 id="ç¬¬ä¸‰ç§ï¼šè¿”å›-Slice-lt-User-gt-ç»“æœ"><a href="#ç¬¬ä¸‰ç§ï¼šè¿”å›-Slice-lt-User-gt-ç»“æœ" class="headerlink" title="ç¬¬ä¸‰ç§ï¼šè¿”å› Slice&lt;User&gt; ç»“æœ"></a>ç¬¬ä¸‰ç§ï¼šè¿”å› Slice<code>&lt;User&gt;</code> ç»“æœ</h4><p>å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;content&quot;</span>:[</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">&quot;id&quot;</span>:<span class="number">4</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack4&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">&quot;id&quot;</span>:<span class="number">5</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack5&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="attr">&quot;id&quot;</span>:<span class="number">6</span>,</span><br><span class="line">   <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack6&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line"> <span class="attr">&quot;pageable&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;sorted&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">   <span class="attr">&quot;unsorted&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="attr">&quot;empty&quot;</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;pageNumber&quot;</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span>:<span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;offset&quot;</span>:<span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;paged&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;unpaged&quot;</span>:<span class="literal">false</span></span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">&quot;numberOfElements&quot;</span>:<span class="number">3</span>,</span><br><span class="line"> <span class="attr">&quot;sort&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;sorted&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;unsorted&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;empty&quot;</span>:<span class="literal">true</span></span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">&quot;size&quot;</span>:<span class="number">3</span>,</span><br><span class="line"> <span class="attr">&quot;number&quot;</span>:<span class="number">1</span>,</span><br><span class="line"> <span class="attr">&quot;first&quot;</span>:<span class="literal">false</span>,</span><br><span class="line"> <span class="attr">&quot;last&quot;</span>:<span class="literal">false</span>,</span><br><span class="line"> <span class="attr">&quot;empty&quot;</span>:<span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶æˆ‘ä»¬å‘ç°ä¸Šé¢çš„ Page è¿”å›ç»“æœå°‘äº†ï¼Œå°‘äº†è·Ÿè®°å½•æ•°ç›¸å…³çš„å†…å®¹</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;totalPages&quot;:3, // ä¸€å…±æœ‰å¤šå°‘é¡µ</span><br><span class="line">&quot;last&quot;:false, // æ˜¯å¦æ˜¯åˆ°æœ€å</span><br><span class="line">&quot;totalElements&quot;:7, // æ€»è®°å½•æ•°</span><br><span class="line">&quot;numberOfElements&quot;:3, // å½“å‰æ•°æ®ä¸‹æ ‡</span><br></pre></td></tr></table></figure>

<p>å†æ¯”è¾ƒä¸€ä¸‹ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æµ‹è¯•ç»“æœçš„æ‰§è¡Œ SQLï¼š</p>
<p>ç¬¬äºŒç§æ‰§è¡Œçš„æ˜¯æ™®é€šçš„åˆ†é¡µæŸ¥è¯¢ SQLï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æŸ¥è¯¢åˆ†é¡µæ•°æ®</span></span><br><span class="line">Hibernate: <span class="keyword">select</span> user0_.id <span class="keyword">as</span> id1_0_, user0_.address <span class="keyword">as</span> address2_0_, user0_.email <span class="keyword">as</span> email3_0_, user0_.name <span class="keyword">as</span> name4_0_, user0_.sex <span class="keyword">as</span> sex5_0_ <span class="keyword">from</span> <span class="keyword">user</span> user0_ limit ?</span><br><span class="line"><span class="comment">-- è®¡ç®—åˆ†é¡µæ•°æ®</span></span><br><span class="line">Hibernate: <span class="keyword">select</span> <span class="built_in">count</span>(user0_.id) <span class="keyword">as</span> col_0_0_ <span class="keyword">from</span> <span class="keyword">user</span> user0_</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰ç§æ‰§è¡Œçš„ SQL å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="keyword">select</span> user0_.id <span class="keyword">as</span> id1_0_, user0_.address <span class="keyword">as</span> address2_0_, user0_.email <span class="keyword">as</span> email3_0_, user0_.name <span class="keyword">as</span> name4_0_, user0_.sex <span class="keyword">as</span> sex5_0_ <span class="keyword">from</span> <span class="keyword">user</span> user0_ limit ? <span class="keyword">offset</span> ?</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼ŒåªæŸ¥è¯¢åç§»é‡ï¼Œä¸è®¡ç®—åˆ†é¡µæ•°æ®ï¼Œè¿™å°±æ˜¯ Page å’Œ Slice çš„ä¸»è¦åŒºåˆ«ã€‚æˆ‘ä»¬æ¥ç€çœ‹ç¬¬å››ç§æµ‹è¯•ç»“æœã€‚</p>
<h4 id="ç¬¬å››ç§ï¼šè¿”å›-List-lt-User-gt"><a href="#ç¬¬å››ç§ï¼šè¿”å›-List-lt-User-gt" class="headerlink" title="ç¬¬å››ç§ï¼šè¿”å› List&lt;User&gt;"></a>ç¬¬å››ç§ï¼šè¿”å› List<code>&lt;User&gt;</code></h4><p>å¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line"> &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>:<span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;jack2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;email&quot;</span>:<span class="string">&quot;123456@126.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;man&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;address&quot;</span>:<span class="string">&quot;shanghai&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¾ˆç®€å•åœ°æŸ¥è¯¢å‡ºæ¥ ID=1 å’Œ ID=2 çš„æ•°æ®ï¼Œæ²¡æœ‰åˆ†é¡µä¿¡æ¯ã€‚</p>
<p>ä¸Šé¢å››ç§æ–¹æ³•ä»‹ç»äº†å¸¸è§çš„å¤šæ¡æ•°æ®è¿”å›ç»“æœçš„å½¢å¼ï¼Œå•æ¡çš„æŸ¥è¯¢æ— éå°±æ˜¯å¯¹ JDK8 çš„ Optional çš„æ”¯æŒã€‚æ¯”å¦‚æ”¯æŒäº† Null çš„ä¼˜é›…åˆ¤æ–­ï¼Œå†ä¸€ä¸ªå°±æ˜¯æ”¯æŒç›´æ¥è¿”å› Entityï¼Œæˆ–è€…ä¸€äº›å­˜åœ¨ / ä¸å­˜åœ¨çš„ Boolean çš„ç»“æœå’Œä¸€äº› count æ¡æ•°çš„è¿”å›ç»“æœè€Œå·²ã€‚</p>
<h2 id="å¼‚æ­¥æŸ¥è¯¢è¿”å›å€¼"><a href="#å¼‚æ­¥æŸ¥è¯¢è¿”å›å€¼" class="headerlink" title="å¼‚æ­¥æŸ¥è¯¢è¿”å›å€¼"></a>å¼‚æ­¥æŸ¥è¯¢è¿”å›å€¼</h2><h3 id="Feature-CompletableFuture-ListenableFuture"><a href="#Feature-CompletableFuture-ListenableFuture" class="headerlink" title="Feature/CompletableFuture/ListenableFuture"></a>Feature/CompletableFuture/ListenableFuture</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Spring çš„å¼‚æ­¥æ–¹æ³•æ‰§è¡ŒRepositoryæŸ¥è¯¢ï¼Œè¿™æ„å‘³ç€æ–¹æ³•å°†åœ¨è°ƒç”¨æ—¶ç«‹å³è¿”å›ï¼Œå¹¶ä¸”å®é™…çš„æŸ¥è¯¢æ‰§è¡Œå°†å‘ç”Ÿåœ¨å·²æäº¤ç»™ Spring TaskExecutor çš„ä»»åŠ¡ä¸­ï¼Œæ¯”è¾ƒé€‚åˆå®šæ—¶ä»»åŠ¡çš„å®é™…åœºæ™¯ã€‚å¼‚æ­¥ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œç›´æ¥åŠ @Async æ³¨è§£å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="function">Future&lt;User&gt; <span class="title">findByFirstname</span><span class="params">(String firstname)</span></span>; (<span class="number">1</span>)</span><br><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="function">CompletableFuture&lt;User&gt; <span class="title">findOneByFirstname</span><span class="params">(String firstname)</span></span>; (<span class="number">2</span>)</span><br><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="function">ListenableFuture&lt;User&gt; <span class="title">findOneByLastname</span><span class="params">(String lastname)</span></span>;(<span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä¸‰ä¸ªå¼‚æ­¥æ–¹æ³•çš„è¿”å›ç»“æœï¼Œåˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šï¼š</p>
<ul>
<li>ç¬¬ä¸€å¤„ï¼šä½¿ç”¨ java.util.concurrent.Future çš„è¿”å›ç±»å‹ï¼›</li>
<li>ç¬¬äºŒå¤„ï¼šä½¿ç”¨ java.util.concurrent.CompletableFuture ä½œä¸ºè¿”å›ç±»å‹ï¼›</li>
<li>ç¬¬ä¸‰å¤„ï¼šä½¿ç”¨ org.springframework.util.concurrent.ListenableFuture ä½œä¸ºè¿”å›ç±»å‹ã€‚</li>
</ul>
<p>ä»¥ä¸Šæ˜¯å¯¹ @Async çš„æ”¯æŒï¼Œå…³äºå®é™…ä½¿ç”¨éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹å†…å®¹ï¼š</p>
<ul>
<li>åœ¨å®é™…å·¥ä½œä¸­ï¼Œç›´æ¥åœ¨ Repository è¿™ä¸€å±‚ä½¿ç”¨å¼‚æ­¥æ–¹æ³•çš„åœºæ™¯ä¸å¤šï¼Œä¸€èˆ¬éƒ½æ˜¯æŠŠå¼‚æ­¥æ³¨è§£æ”¾åœ¨ Service çš„æ–¹æ³•ä¸Šé¢ï¼Œè¿™æ ·çš„è¯ï¼Œå¯ä»¥æœ‰ä¸€äº›é¢å¤–é€»è¾‘ï¼Œå¦‚å‘çŸ­ä¿¡ã€å‘é‚®ä»¶ã€å‘æ¶ˆæ¯ç­‰é…åˆä½¿ç”¨ï¼›</li>
<li>ä½¿ç”¨å¼‚æ­¥çš„æ—¶å€™ä¸€å®šè¦é…ç½®çº¿ç¨‹æ± ï¼Œè¿™ç‚¹åˆ‡è®°ï¼Œå¦åˆ™â€œæ­»â€å¾—ä¼šå¾ˆéš¾çœ‹ï¼›</li>
</ul>
<blockquote>
<p>ğŸ“Œ ä¸‡ä¸€å¤±è´¥è¦æ€ä¹ˆå¤„ç†ï¼Ÿå…³äºäº‹åŠ¡æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢?</p>
</blockquote>
<p>æ¥ä¸‹æ¥çœ‹çœ‹ Repository å¯¹ Reactive æ˜¯å¦‚ä½•æ”¯æŒçš„ã€‚</p>
<h2 id="å¯¹-Reactive-æ”¯æŒ-flux-ä¸-Mono"><a href="#å¯¹-Reactive-æ”¯æŒ-flux-ä¸-Mono" class="headerlink" title="å¯¹ Reactive æ”¯æŒ flux ä¸ Mono"></a>å¯¹ Reactive æ”¯æŒ flux ä¸ Mono</h2><p>Spring Data Common é‡Œé¢å¯¹ Reactive è¿˜æ˜¯æœ‰æ”¯æŒçš„ï¼Œä½†æ˜¯ Common é‡Œé¢æä¾›çš„åªæ˜¯æ¥å£ï¼Œè€Œ JPA é‡Œé¢æ²¡æœ‰åšç›¸å…³çš„ Reactive çš„å®ç°ï¼Œæ‰€ä»¥Spring Data JPA ä¸æ”¯æŒ Reactive</p>
<p>å…¶ä»–å­æ¨¡å—ï¼Œå¦‚ mongoå®ç°äº†è¯¥æ¥å£</p>
<p>ä¸‹é¢æˆ‘ä»¬åœ¨ gradle é‡Œé¢å¼•ç”¨ä¸€ä¸ª Spring Data Common çš„å­æ¨¡å— implementation â€˜org.springframework.boot:spring-boot-starter-data-mongodbâ€™ æ¥åŠ è½½ä¾èµ–ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ‰“å¼€ Repository çœ‹ Hierarchy å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¤šäº†ä¸€ä¸ª Mongo çš„ Repository çš„å®ç°ï¼Œå¤©ç„¶åœ°æ”¯æŒç€ Reactive è¿™æ¡çº¿ã€‚</p>
<p><img src="http://image.leonote.cn//20200926201459.png" alt=""></p>
<p>ç›¸ä¿¡åˆ°è¿™é‡Œä½ èƒ½æ„Ÿå—åˆ° Spring Data Common çš„å¼ºå¤§æ”¯æŒï¼Œå¯¹ Repository æ¥å£çš„ä¸åŒå®ç°ä¹Ÿæœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸‹é¢æ‰“å¼€ ResultProcessor ç±»çš„æºç çœ‹ä¸€ä¸‹æ”¯æŒçš„ç±»å‹æœ‰å“ªäº›ã€‚</p>
<p><img src="http://image.leonote.cn//20200926201742.png" alt=""></p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º processResult çš„æ—¶å€™åˆ†åˆ«å¯¹ PageQueryã€Streamã€Reactive æœ‰äº†å„è‡ªçš„åˆ¤æ–­ï¼Œæˆ‘ä»¬ debug åˆ°è¿™é‡Œçš„æ—¶å€™æ¥çœ‹ä¸€ä¸‹ convertï¼Œè¿›å…¥åˆ°ç±»é‡Œé¢ã€‚</p>
<p><img src="http://image.leonote.cn//20200926201819.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ° QueryExecutorConverters é‡Œé¢å¯¹ JDK8ã€Guavaã€vavr ä¹Ÿåšäº†å„ç§æ”¯æŒï¼Œè‡ªè¡Œé˜…è¯»æºç </p>
<p>ä¸‹è¡¨åˆ—å‡ºäº† Spring Data JPA Query Method æœºåˆ¶æ”¯æŒçš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼š</p>
<blockquote>
<p>ğŸ“Œ Geospatial types (such as <code>GeoResult</code>, <code>GeoResults</code>, and <code>GeoPage</code>) are available only for data stores that support geospatial queries.</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">Return type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>void</code></td>
<td align="left">ä¸è¿”å›ç»“æœï¼Œä¸€èˆ¬æ˜¯æ›´æ–°æ“ä½œ</td>
</tr>
<tr>
<td align="left">Primitives</td>
<td align="left">Java çš„åŸºæœ¬ç±»å‹ï¼Œä¸€èˆ¬å¸¸è§çš„æ˜¯ç»Ÿè®¡æ“ä½œ ï¼ˆå¦‚ longã€boolean ç­‰ï¼‰</td>
</tr>
<tr>
<td align="left">Wrapper types</td>
<td align="left">Wrapper types Java çš„åŒ…è£…ç±»</td>
</tr>
<tr>
<td align="left"><code>T</code></td>
<td align="left">è¿”å›å”¯ä¸€çš„å®ä½“ï¼Œæ²¡æœ‰æŸ¥è¯¢ç»“æœè¿”å›<code>null</code> ï¼Œè¶…è¿‡ä¸€ä¸ªç»“æœä¼šæŠ›å‡º<code>IncorrectResultSizeDataAccessException</code></td>
</tr>
<tr>
<td align="left"><code>Iterator&lt;T&gt;</code></td>
<td align="left">An <code>Iterator</code>.</td>
</tr>
<tr>
<td align="left"><code>Collection&lt;T&gt;</code></td>
<td align="left">A <code>Collection</code>.</td>
</tr>
<tr>
<td align="left"><code>List&lt;T&gt;</code></td>
<td align="left">A <code>List</code>.</td>
</tr>
<tr>
<td align="left"><code>Optional&lt;T&gt;</code></td>
<td align="left">A Java 8 or Guava <code>Optional</code>. Expects the query method to return one result at most. If no result is found, <code>Optional.empty()</code> or <code>Optional.absent()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</td>
</tr>
<tr>
<td align="left"><code>Option&lt;T&gt;</code></td>
<td align="left">Either a Scala or Vavr <code>Option</code> type. Semantically the same behavior as Java 8â€™s <code>Optional</code>, described earlier.</td>
</tr>
<tr>
<td align="left"><code>Stream&lt;T&gt;</code></td>
<td align="left">A Java 8 <code>Stream</code>.</td>
</tr>
<tr>
<td align="left"><code>Streamable&lt;T&gt;</code></td>
<td align="left">A convenience extension of <code>Iterable</code> that directly exposes methods to stream, map and filter results, concatenate them etc.</td>
</tr>
<tr>
<td align="left">Types that implement <code>Streamable</code> and take a <code>Streamable</code> constructor or factory method argument</td>
<td align="left">Types that expose a constructor or <code>â€¦.of(â€¦)</code>/<code>â€¦.valueOf(â€¦)</code> factory method taking a <code>Streamable</code> as argument. See <a href="https://docs.spring.io/spring-data/jpa/docs/2.3.4.RELEASE/reference/html/#repositories.collections-and-iterables.streamable-wrapper">Returning Custom Streamable Wrapper Types</a> for details.</td>
</tr>
<tr>
<td align="left">Vavr <code>Seq</code>, <code>List</code>, <code>Map</code>, <code>Set</code></td>
<td align="left">Vavr collection types. See <a href="https://docs.spring.io/spring-data/jpa/docs/2.3.4.RELEASE/reference/html/#repositories.collections-and-iterables.vavr">Support for Vavr Collections</a> for details.</td>
</tr>
<tr>
<td align="left"><code>Future&lt;T&gt;</code></td>
<td align="left">A <code>Future</code>. Expects a method to be annotated with <code>@Async</code> and requires Springâ€™s asynchronous method execution capability to be enabled.</td>
</tr>
<tr>
<td align="left"><code>CompletableFuture&lt;T&gt;</code></td>
<td align="left">A Java 8 <code>CompletableFuture</code>. Expects a method to be annotated with <code>@Async</code> and requires Springâ€™s asynchronous method execution capability to be enabled.</td>
</tr>
<tr>
<td align="left"><code>ListenableFuture</code></td>
<td align="left">A <code>org.springframework.util.concurrent.ListenableFuture</code>. Expects a method to be annotated with <code>@Async</code> and requires Springâ€™s asynchronous method execution capability to be enabled.</td>
</tr>
<tr>
<td align="left"><code>Slice</code></td>
<td align="left">A sized chunk of data with an indication of whether there is more data available. Requires a <code>Pageable</code> method parameter.</td>
</tr>
<tr>
<td align="left"><code>Page&lt;T&gt;</code></td>
<td align="left">A <code>Slice</code> with additional information, such as the total number of results. Requires a <code>Pageable</code> method parameter.</td>
</tr>
<tr>
<td align="left"><code>GeoResult&lt;T&gt;</code></td>
<td align="left">A result entry with additional information, such as the distance to a reference location.</td>
</tr>
<tr>
<td align="left"><code>GeoResults&lt;T&gt;</code></td>
<td align="left">A list of <code>GeoResult&lt;T&gt;</code> with additional information, such as the average distance to a reference location.</td>
</tr>
<tr>
<td align="left"><code>GeoPage&lt;T&gt;</code></td>
<td align="left">A <code>Page</code> with <code>GeoResult&lt;T&gt;</code>, such as the average distance to a reference location.</td>
</tr>
<tr>
<td align="left"><code>Mono&lt;T&gt;</code></td>
<td align="left">A Project Reactor <code>Mono</code> emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</td>
</tr>
<tr>
<td align="left"><code>Flux&lt;T&gt;</code></td>
<td align="left">A Project Reactor <code>Flux</code> emitting zero, one, or many elements using reactive repositories. Queries returning <code>Flux</code> can emit also an infinite number of elements.</td>
</tr>
<tr>
<td align="left"><code>Single&lt;T&gt;</code></td>
<td align="left">A RxJava <code>Single</code> emitting a single element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</td>
</tr>
<tr>
<td align="left"><code>Maybe&lt;T&gt;</code></td>
<td align="left">A RxJava <code>Maybe</code> emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, <code>Mono.empty()</code> is returned. More than one result triggers an <code>IncorrectResultSizeDataAccessException</code>.</td>
</tr>
<tr>
<td align="left"><code>Flowable&lt;T&gt;</code></td>
<td align="left">A RxJava <code>Flowable</code> emitting zero, one, or many elements using reactive repositories. Queries returning <code>Flowable</code> can emit also an infinite number of elements.</td>
</tr>
</tbody></table>
<h3 id="å¸¸è§çš„-DTO-è¿”å›ç»“æœçš„æ”¯æŒæ–¹æ³•"><a href="#å¸¸è§çš„-DTO-è¿”å›ç»“æœçš„æ”¯æŒæ–¹æ³•" class="headerlink" title="å¸¸è§çš„ DTO è¿”å›ç»“æœçš„æ”¯æŒæ–¹æ³•"></a>å¸¸è§çš„ DTO è¿”å›ç»“æœçš„æ”¯æŒæ–¹æ³•</h3><p><strong>Projections çš„æ¦‚å¿µ</strong></p>
<p>Spring JPA å¯¹ Projections æ‰©å±•çš„æ”¯æŒï¼Œè¿™æ˜¯ä¸ªéå¸¸å¥½çš„ä¸œè¥¿ï¼Œä»å­—é¢æ„æ€ä¸Šç†è§£å°±æ˜¯æ˜ å°„ï¼ŒæŒ‡çš„æ˜¯å’Œ DB çš„æŸ¥è¯¢ç»“æœçš„å­—æ®µæ˜ å°„å…³ç³»ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿”å›çš„å­—æ®µå’Œ DB çš„æŸ¥è¯¢ç»“æœçš„å­—æ®µæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼›ä½†æœ‰çš„æ—¶å€™ï¼Œéœ€è¦è¿”å›ä¸€äº›æŒ‡å®šçš„å­—æ®µï¼Œæˆ–è€…è¿”å›ä¸€äº›å¤åˆå‹çš„å­—æ®µï¼Œè€Œä¸éœ€è¦å…¨éƒ¨è¿”å›ã€‚</p>
<p>ä¸€èˆ¬çš„åšæ³•æ˜¯è‡ªå·±å†™å„ç§ entity åˆ° view çš„å„ç§ convert çš„è½¬åŒ–é€»è¾‘ï¼Œè€Œ Spring Data æ­£æ˜¯è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œå…è®¸å¯¹ä¸“ç”¨è¿”å›ç±»å‹è¿›è¡Œå»ºæ¨¡ï¼Œæœ‰é€‰æ‹©åœ°è¿”å›åŒä¸€ä¸ªå®ä½“çš„ä¸åŒè§†å›¾å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢è¿˜ä»¥ User æŸ¥è¯¢å¯¹è±¡ä¸ºä¾‹ï¼Œçœ‹çœ‹æ€ä¹ˆè‡ªå®šä¹‰è¿”å› DTOï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">   <span class="keyword">private</span> String sex;</span><br><span class="line">   <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸Šé¢çš„åŸå§‹ User å®ä½“ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³è¿”å› User å¯¹è±¡é‡Œé¢çš„ name å’Œ emailï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿä¸‹é¢ä»‹ç»ä¸‰ç§æ–¹æ³•ã€‚</p>
<h4 id="ç¬¬ä¸€ç§ï¼šåŒä¸€å¼ -Tableï¼Œä¸åŒ-Entity"><a href="#ç¬¬ä¸€ç§ï¼šåŒä¸€å¼ -Tableï¼Œä¸åŒ-Entity" class="headerlink" title="ç¬¬ä¸€ç§ï¼šåŒä¸€å¼  Tableï¼Œä¸åŒ Entity"></a>ç¬¬ä¸€ç§ï¼šåŒä¸€å¼  Tableï¼Œä¸åŒ Entity</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªEntityç±»ï¼šé€šè¿‡ @Table æŒ‡å‘åŒä¸€å¼ è¡¨ï¼Œè¿™å¼ è¡¨å’Œ User å®ä¾‹é‡Œé¢çš„è¡¨ä¸€æ ·éƒ½æ˜¯ userï¼Œå®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;user&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserOnlyNameEmailEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@Id</span></span><br><span class="line">   <span class="meta">@GeneratedValue(strategy= GenerationType.AUTO)</span></span><br><span class="line">   <span class="keyword">private</span> Long id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæ–°å¢ä¸€ä¸ª UserOnlyNameEmailEntityRepositoryï¼Œåšå•ç‹¬çš„æŸ¥è¯¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserOnlyNameEmailEntityRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserOnlyNameEmailEntity</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹é‡Œé¢çš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProjections</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  userRepository.save(User.builder().id(<span class="number">1L</span>)</span><br><span class="line">  .name(<span class="string">&quot;jack12&quot;</span>)</span><br><span class="line">  .email(<span class="string">&quot;123456@126.com&quot;</span>).sex(<span class="string">&quot;man&quot;</span>)</span><br><span class="line">  .address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">    List&lt;User&gt; users= userRepository.findAll();</span><br><span class="line">    System.out.println(users);</span><br><span class="line">    UserOnlyNameEmailEntity uName = userOnlyNameEmailEntityRepository.getOne(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(uName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: <span class="function">insert into <span class="title">user</span> <span class="params">(address, email, name, sex, id)</span> <span class="title">values</span> <span class="params">(?, ?, ?, ?, ?)</span></span></span><br><span class="line"><span class="function">Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_</span></span><br><span class="line"><span class="function">[<span class="title">User</span><span class="params">(id=<span class="number">1</span>, name=jack12, email=<span class="number">123456</span>@<span class="number">126.</span>com, sex=man, address=shanghai)</span>]</span></span><br><span class="line"><span class="function">Hibernate: select useronlyna0_.id as id1_0_0_, useronlyna0_.email as email3_0_0_, useronlyna0_.name as name4_0_0_ from user useronlyna0_ where useronlyna0_.id</span>=?</span><br><span class="line">UserOnlyNameEmailEntity(id=<span class="number">1</span>, name=jack12, email=<span class="number">123456</span>@<span class="number">126.</span>com)</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå½“åœ¨ user è¡¨é‡Œé¢æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œè€Œ userRepository å’Œ userOnlyNameEmailEntityRepository æŸ¥è¯¢çš„éƒ½æ˜¯åŒä¸€å¼ è¡¨ userã€‚</p>
<blockquote>
<p>å¥½å¤„ï¼šç®€å•ã€æ–¹ä¾¿ï¼Œå¾ˆå®¹æ˜“å¯ä»¥æƒ³åˆ°ï¼›</p>
<p>ç¼ºç‚¹ï¼šé€šè¿‡ä¸¤ä¸ªå®ä½“éƒ½å¯ä»¥è¿›è¡Œ update æ“ä½œï¼Œå¦‚æœåŒä¸€ä¸ªé¡¹ç›®é‡Œé¢è¿™ç§å®ä½“æ¯”è¾ƒå¤šï¼Œ</p>
<p>â€‹          åˆ°æ—¶å€™å°±å®¹æ˜“ä¸çŸ¥é“æ˜¯è°æ›´æ–°çš„ï¼Œä»è€Œå¯¼è‡´å‡º bug ä¸å¥½å®šä½ï¼Œ</p>
<p> â€‹          å®ä½“èŒè´£åˆ’åˆ†ä¸æ˜ç¡®ã€‚</p>
</blockquote>
<h4 id="ç¬¬äºŒç§ï¼šå®šä¹‰-DTO-ç±»"><a href="#ç¬¬äºŒç§ï¼šå®šä¹‰-DTO-ç±»" class="headerlink" title="ç¬¬äºŒç§ï¼šå®šä¹‰ DTO ç±»"></a>ç¬¬äºŒç§ï¼šå®šä¹‰ DTO ç±»</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª DTO ç±»æ¥è¿”å›æˆ‘ä»¬æƒ³è¦çš„å­—æ®µï¼Œå®ƒæ˜¯ UserOnlyNameEmailDtoï¼Œç”¨æ¥æ¥æ”¶ nameã€email ä¸¤ä¸ªå­—æ®µçš„å€¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserOnlyNameEmailDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name, email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œåœ¨ UserRepository é‡Œé¢åšå¦‚ä¸‹ç”¨æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//æµ‹è¯•åªè¿”å›nameå’Œemailçš„DTO</span></span><br><span class="line">    <span class="function">UserOnlyNameEmailDto <span class="title">findByEmail</span><span class="params">(String email)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæµ‹è¯•ç”¨ä¾‹é‡Œé¢å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProjections</span><span class="params">()</span> </span>&#123;</span><br><span class="line">userRepository.save(User.builder().id(<span class="number">1L</span>)</span><br><span class="line">                    .name(<span class="string">&quot;jack12&quot;</span>).email(<span class="string">&quot;123456@126.com&quot;</span>).sex(<span class="string">&quot;man&quot;</span>)</span><br><span class="line">                    .address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">UserOnlyNameEmailDto userOnlyNameEmailDto = userRepository.findByEmail(<span class="string">&quot;123456@126.com&quot;</span>);</span><br><span class="line">System.out.println(userOnlyNameEmailDto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.email=?</span><br><span class="line">UserOnlyNameEmailDto(name=jack12, email=<span class="number">123456</span>@<span class="number">126.</span>com)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å»çœ‹æºç çš„è¯ï¼Œçœ‹å…³é”®çš„ PreferredConstructorDiscoverer ç±»æ—¶ä¼šå‘ç°ï¼Œ<strong>UserDTO é‡Œé¢åªèƒ½æœ‰ä¸€ä¸ªå…¨å‚æ•°æ„é€ æ–¹æ³•</strong>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn//20200926202327.png" alt=""></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒConstructor é€‰æ‹©çš„æ—¶å€™ä¼šå¸®æˆ‘ä»¬åšæ„é€ å‚æ•°çš„é€‰æ‹©ï¼Œå¦‚æœ DTO é‡Œé¢æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œå°±ä¼šæŠ¥è½¬åŒ–é”™è¯¯çš„å¼‚å¸¸ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¼‚å¸¸æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">No converter found capable of converting from type [com.example.jpa.example1.User] to type [com.example.jpa.example1.UserOnlyNameEmailDto </span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¼˜ç‚¹ï¼šè¿”å›çš„ç»“æœä¸éœ€è¦æ˜¯ä¸ªå®ä½“å¯¹è±¡ï¼Œå¯¹ DB ä¸èƒ½è¿›è¡Œé™¤äº†æŸ¥è¯¢ä¹‹å¤–çš„ä»»ä½•æ“ä½œï¼›</p>
<p>ç¼ºç‚¹ï¼šæœ‰ set æ–¹æ³•è¿˜å¯ä»¥æ”¹å˜é‡Œé¢çš„å€¼ï¼Œæ„é€ æ–¹æ³•ä¸èƒ½æ›´æ”¹ï¼Œå¿…é¡»å…¨å‚æ•°ï¼Œ</p>
<p>â€‹          è¿™æ ·å¦‚æœæ˜¯ä¸ç†Ÿæ‚‰ JPA çš„æ–°äººæ“ä½œçš„æ—¶å€™å¾ˆå®¹æ˜“å¼•å‘ Bugã€‚</p>
</blockquote>
<h4 id="ç¬¬ä¸‰ç§ï¼šå®šä¹‰-DTO-æ¥å£"><a href="#ç¬¬ä¸‰ç§ï¼šå®šä¹‰-DTO-æ¥å£" class="headerlink" title="ç¬¬ä¸‰ç§ï¼šå®šä¹‰ DTO æ¥å£"></a>ç¬¬ä¸‰ç§ï¼šå®šä¹‰ DTO æ¥å£</h4><p>æˆ‘ä»¬å†æ¥å­¦ä¹ ä¸€ç§è¿”å›ä¸åŒå­—æ®µçš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸ä¸Šé¢ä¸¤ç§çš„åŒºåˆ«æ˜¯åªéœ€è¦å®šä¹‰æ¥å£ï¼Œå®ƒçš„å¥½å¤„æ˜¯åªè¯»ï¼Œä¸éœ€è¦æ·»åŠ æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬ä½¿ç”¨èµ·æ¥éå¸¸çµæ´»ï¼Œä¸€èˆ¬å¾ˆéš¾äº§ç”Ÿ Bugï¼Œé‚£ä¹ˆå®ƒæ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ª UserOnlyName çš„æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserOnlyName</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getEmail</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jpa.example1;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥å£çš„æ–¹å¼è¿”å›DTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">UserOnlyName <span class="title">findByAddress</span><span class="params">(String address)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæµ‹è¯•ç”¨ä¾‹çš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProjections</span><span class="params">()</span> </span>&#123;</span><br><span class="line">userRepository.save(User.builder().name(<span class="string">&quot;jack12&quot;</span>)</span><br><span class="line">					.email(<span class="string">&quot;123456@126.com&quot;</span>).sex(<span class="string">&quot;man&quot;</span>)</span><br><span class="line">					.address(<span class="string">&quot;shanghai&quot;</span>).build());</span><br><span class="line">UserOnlyName userOnlyName = userRepository.findByAddress(<span class="string">&quot;shanghai&quot;</span>);</span><br><span class="line">System.out.println(userOnlyName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.address=?</span><br><span class="line">org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@1d369521</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™ä¼šå‘ç°æˆ‘ä»¬çš„ userOnlyName æ¥å£æˆäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‡Œé¢é€šè¿‡ Map çš„æ ¼å¼åŒ…å«äº†æˆ‘ä»¬çš„è¦è¿”å›å­—æ®µçš„å€¼ï¼ˆå¦‚ï¼šnameã€emailï¼‰ï¼Œæˆ‘ä»¬ç”¨çš„æ—¶å€™ç›´æ¥è°ƒç”¨æ¥å£é‡Œé¢çš„æ–¹æ³•å³å¯ï¼Œå¦‚ userOnlyName.getName() å³å¯ï¼›è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ¥å£ä¸ºåªè¯»ï¼Œå¹¶ä¸”è¯­ä¹‰æ›´æ¸…æ™°ï¼Œæ‰€ä»¥è¿™ç§æ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„åšæ³•ã€‚</p>
<p>å…¶ä¸­æºç æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘æ¥è¯´ä¸€ä¸ªç±»ï¼Œä½ å¯ä»¥é€šè¿‡ debugï¼Œçœ‹ä¸€ä¸‹æœ€ç»ˆ DTO å’Œæ¥å£è½¬åŒ–æ‰§è¡Œçš„ query æœ‰ä»€ä¹ˆä¸åŒï¼Œçœ‹ä¸‹å›¾ä¸­ debug æ˜¾ç¤ºçš„ Query è¯­å¥çš„ä½ç½®ï¼š</p>
<p>å›¾ä¸€ï¼šæ˜¯è¿”å› DTO æ¥å£å½¢å¼çš„ query ç”Ÿæˆçš„ JPQLï¼š</p>
<p><img src="http://image.leonote.cn//20200926202547.png" alt=""></p>
<p>å›¾äºŒï¼šæ˜¯è¿”å› DTO ç±»çš„æ—¶å€™ QueryStructure ç”Ÿæˆçš„ JPQL è¯­å¥ï¼š</p>
<p><img src="http://image.leonote.cn//20200926202709.png" alt=""></p>
<p>ä¸¤ç§æœ€å¤§çš„åŒºåˆ«æ˜¯ DTO ç±»éœ€è¦æ„é€ æ–¹æ³• new ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¬¬äºŒç§æ–¹æ³•é‡Œé¢éœ€è¦æ³¨æ„çš„ DTO æ„é€ å‡½æ•°çš„é—®é¢˜ï¼›è€Œé€šè¿‡å›¾ä¸€æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¥å£ç›´æ¥é€šè¿‡ as åˆ«åï¼Œæ˜ å°„æˆ hashmap å³å¯ï¼Œéå¸¸çµæ´»ã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>è‡ªå®šä¹‰è¿”å›å€¼</tag>
      </tags>
  </entry>
  <entry>
    <title>Stream API</title>
    <url>/2020/11/05/Stream%20API/</url>
    <content><![CDATA[<h1 id="Stream-ç®€ä»‹"><a href="#Stream-ç®€ä»‹" class="headerlink" title="Stream ç®€ä»‹"></a>Stream ç®€ä»‹</h1><h2 id="ä»€ä¹ˆæ˜¯æµ"><a href="#ä»€ä¹ˆæ˜¯æµ" class="headerlink" title="ä»€ä¹ˆæ˜¯æµ"></a>ä»€ä¹ˆæ˜¯æµ</h2><p><em>Stream</em> ä¸æ˜¯é›†åˆå…ƒç´ ï¼Œå®ƒä¸æ˜¯æ•°æ®ç»“æ„å¹¶ä¸ä¿å­˜æ•°æ®ï¼Œå®ƒæ˜¯æœ‰å…³ç®—æ³•å’Œè®¡ç®—çš„ã€‚</p>
<blockquote>
<p><strong>ä¸Iteratorçš„å¼‚åŒ</strong></p>
<p>â€‹    ç›¸åŒç‚¹ï¼š å•å‘çš„ï¼Œæ•°æ®åªèƒ½éå†ä¸€æ¬¡ã€‚</p>
<p>â€‹    ä¸åŒç‚¹ï¼š <em>stream</em>å¯ä»¥å¹¶è¡Œæ“ä½œ</p>
</blockquote>
<p><em>Stream</em> çš„å¦å¤–ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œ==æ•°æ®æºæœ¬èº«å¯ä»¥æ˜¯æ— é™çš„==ã€‚</p>
<p><em>Stream</em> çš„å¹¶è¡Œæ“ä½œä¾èµ–äº Java7 ä¸­å¼•å…¥çš„ Fork/Join æ¡†æ¶æ¥æ‹†åˆ†ä»»åŠ¡å’ŒåŠ é€Ÿå¤„ç†è¿‡ç¨‹ã€‚ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Java çš„å¹¶è¡ŒAPIæ¼”å˜å†ç¨‹åŸºæœ¬å¦‚ä¸‹ï¼š</span><br><span class="line">	1. 1.0-1.4 ä¸­çš„ java.lang.Thread</span><br><span class="line">	2. 5.0 ä¸­çš„ java.util.concurrent</span><br><span class="line">	3. 6.0 ä¸­çš„ Phasers ç­‰</span><br><span class="line">	4. 7.0 ä¸­çš„ Fork&#x2F;Join æ¡†æ¶</span><br><span class="line">	5. 8.0 ä¸­çš„ Lambda</span><br></pre></td></tr></table></figure>



<h2 id="ç”Ÿæˆ-Stream-Sourceæ–¹å¼"><a href="#ç”Ÿæˆ-Stream-Sourceæ–¹å¼" class="headerlink" title="ç”Ÿæˆ Stream Sourceæ–¹å¼"></a>ç”Ÿæˆ Stream Sourceæ–¹å¼</h2><h3 id="Collection-and-Array"><a href="#Collection-and-Array" class="headerlink" title="Collection and Array"></a>Collection and Array</h3><ul>
<li><code>Collection.stream()</code></li>
<li><code>Collection.parallelStream()</code></li>
<li><code>Arrays.stream(T array)</code> or <code>Stream.of()</code></li>
</ul>
<h3 id="BufferedReader"><a href="#BufferedReader" class="headerlink" title="BufferedReader"></a>BufferedReader</h3><ul>
<li><code>java.io.BufferedReader.lines()</code></li>
</ul>
<h3 id="é™æ€å·¥å‚"><a href="#é™æ€å·¥å‚" class="headerlink" title="é™æ€å·¥å‚"></a>é™æ€å·¥å‚</h3><ul>
<li><code>java.util.stream.IntStream.range()</code></li>
<li><code>java.nio.file.Files.walk()</code></li>
</ul>
<h3 id="è‡ªå·±æ„å»º"><a href="#è‡ªå·±æ„å»º" class="headerlink" title="è‡ªå·±æ„å»º"></a>è‡ªå·±æ„å»º</h3><ul>
<li><code>java.util.Spliterator</code></li>
</ul>
<h3 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h3><ul>
<li><code>Random.ints()</code></li>
<li><code>BitSet.stream()</code></li>
<li><code>Pattern.splitAsStream(java.lang.CharSequence)</code></li>
<li><code>JarFile.stream()</code></li>
</ul>
<p><strong>å¸¸è§çš„<em>stream</em>æ¥å£ç»§æ‰¿å…³ç³»å¦‚å›¾</strong></p>
<p><img src="image/1.png" alt="img"></p>
<p>å¯¹äºåŸºæœ¬æ•°å€¼å‹ï¼Œç›®å‰æœ‰ä¸‰ç§å¯¹åº”çš„åŒ…è£…ç±»å‹ Streamï¼š</p>
<p><code>IntStream</code>ã€<code>LongStream</code>ã€<code>DoubleStream</code>ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ <code>Stream&lt;Integer&gt;</code>ã€<code>Stream&lt;Long&gt;</code>ã€<code>Stream&lt;Double&gt;</code>ï¼Œä½†æ˜¯ boxing å’Œ unboxing ä¼šå¾ˆè€—æ—¶ï¼Œæ‰€ä»¥ç‰¹åˆ«ä¸ºè¿™ä¸‰ç§åŸºæœ¬æ•°å€¼å‹æä¾›äº†å¯¹åº”çš„ Streamã€‚</p>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆä¸ºä¸åŒæ•°æ®ç±»å‹è®¾ç½®ä¸åŒ<em>stream</em>æ¥å£</strong></p>
<ol>
<li>æé«˜æ€§èƒ½</li>
<li>å¢åŠ ç‰¹å®šæ¥å£å‡½æ•°</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆä¸æŠŠ<code>IntStream</code>ç­‰è®¾è®¡æˆ<code>Stream</code>çš„å­æ¥å£ï¼Ÿæ¯•ç«Ÿè¿™æ¥å£ä¸­çš„æ–¹æ³•åå¤§éƒ¨åˆ†æ˜¯ä¸€æ ·çš„ã€‚</strong></p>
<p>â€‹    è™½ç„¶è¿™äº›æ–¹æ³•çš„åå­—ç›¸åŒï¼Œä½†æ˜¯è¿”å›ç±»å‹ä¸åŒï¼Œå¦‚æœè®¾è®¡æˆçˆ¶å­æ¥å£å…³ç³»ï¼Œè¿™äº›æ–¹æ³•å°†ä¸èƒ½å…±å­˜ï¼Œ</p>
<p>â€‹    å› ä¸ºJavaä¸å…è®¸åªæœ‰è¿”å›ç±»å‹ä¸åŒçš„æ–¹æ³•é‡è½½ã€‚</p>
</blockquote>
<p>è™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹<em>stream</em>æ˜¯å®¹å™¨è°ƒç”¨<code>Collection.stream()</code>æ–¹æ³•å¾—åˆ°çš„ï¼Œä½†<em>stream</em>å’Œ<em>collections</em>æœ‰ä»¥ä¸‹ä¸åŒï¼š</p>
<ul>
<li><strong>æ— å­˜å‚¨</strong>ã€‚<em>stream</em>ä¸æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®ƒåªæ˜¯æŸç§æ•°æ®æºçš„ä¸€ä¸ªè§†å›¾ï¼Œæ•°æ®æºå¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒJavaå®¹å™¨æˆ–I/O channelç­‰ã€‚</li>
<li><strong>ä¸ºå‡½æ•°å¼ç¼–ç¨‹è€Œç”Ÿ</strong>ã€‚å¯¹<em>stream</em>çš„ä»»ä½•ä¿®æ”¹éƒ½ä¸ä¼šä¿®æ”¹èƒŒåçš„æ•°æ®æºï¼Œæ¯”å¦‚å¯¹<em>stream</em>æ‰§è¡Œè¿‡æ»¤æ“ä½œå¹¶ä¸ä¼šåˆ é™¤è¢«è¿‡æ»¤çš„å…ƒç´ ï¼Œè€Œæ˜¯ä¼šäº§ç”Ÿä¸€ä¸ªä¸åŒ…å«è¢«è¿‡æ»¤å…ƒç´ çš„æ–°<em>stream</em>ã€‚</li>
<li><strong>æƒ°å¼æ‰§è¡Œ</strong>ã€‚<em>stream</em>ä¸Šçš„æ“ä½œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåªæœ‰ç­‰åˆ°ç”¨æˆ·çœŸæ­£éœ€è¦ç»“æœçš„æ—¶å€™æ‰ä¼šæ‰§è¡Œã€‚</li>
<li><strong>å¯æ¶ˆè´¹æ€§</strong>ã€‚<em>stream</em>åªèƒ½è¢«â€œæ¶ˆè´¹â€ä¸€æ¬¡ï¼Œä¸€æ—¦éå†è¿‡å°±ä¼šå¤±æ•ˆï¼Œå°±åƒå®¹å™¨çš„è¿­ä»£å™¨é‚£æ ·ï¼Œæƒ³è¦å†æ¬¡éå†å¿…é¡»é‡æ–°ç”Ÿæˆã€‚</li>
</ul>
<h1 id="Stream-æ“ä½œ"><a href="#Stream-æ“ä½œ" class="headerlink" title="Stream æ“ä½œ"></a>Stream æ“ä½œ</h1><p>å¯¹<em>stream</em>çš„æ“ä½œåˆ†ä¸ºä¸ºä¸¤ç±»ï¼Œ<strong>ä¸­é—´æ“ä½œ(intermediate)å’Œç»“æŸæ“ä½œ(terminal)</strong>ï¼ŒäºŒè€…ç‰¹ç‚¹æ˜¯ï¼š</p>
<ol>
<li><strong>ä¸­é—´æ“ä½œæ€»æ˜¯ä¼šæƒ°å¼æ‰§è¡Œ</strong>ï¼Œè°ƒç”¨ä¸­é—´æ“ä½œåªä¼šç”Ÿæˆä¸€ä¸ªæ ‡è®°äº†è¯¥æ“ä½œçš„æ–°<em>stream</em>ï¼Œä»…æ­¤è€Œå·²ã€‚</li>
<li><strong>ç»“æŸæ“ä½œä¼šè§¦å‘å®é™…è®¡ç®—</strong>ï¼Œè®¡ç®—å‘ç”Ÿæ—¶ä¼šæŠŠæ‰€æœ‰ä¸­é—´æ“ä½œç§¯æ”’çš„æ“ä½œä»¥<em>pipeline</em>çš„æ–¹å¼æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿­ä»£æ¬¡æ•°ã€‚è®¡ç®—å®Œæˆä¹‹å<em>stream</em>å°±ä¼šå¤±æ•ˆã€‚</li>
</ol>
<p><strong><code>Stream</code>æ¥å£çš„éƒ¨åˆ†å¸¸è§æ–¹æ³•</strong></p>
<table>
<thead>
<tr>
<th>æ“ä½œç±»å‹</th>
<th>æ¥å£æ–¹æ³•</th>
</tr>
</thead>
<tbody><tr>
<td><strong>intermediate</strong></td>
<td><code>concat()</code> ã€<code>distinct()</code>ã€ <code>filter()</code>ã€ <code>flatMap()</code>ã€ <code>limit()</code>ã€ <code>map()</code>ã€ <code>peek()</code>ã€  <code>skip()</code>ã€ <code>sorted()</code> ã€<code>parallel()</code> ã€<code>sequential()</code>ã€ <code>unordered()</code></td>
</tr>
<tr>
<td><strong>terminal</strong></td>
<td><code>forEach()</code>ã€<code>forEachOrdered()</code>ã€<code>findFirst()</code>ã€ <code>findAny()</code> ã€<code>count()</code>  ã€<code>max()</code>ã€ <code>min()</code>ã€<code>anyMatch()</code>ã€<code>allMatch()</code> ã€<code>noneMatch()</code>ã€<code>toArray()</code>ã€ <code>collect()</code>ã€<code>reduce()</code></td>
</tr>
<tr>
<td><strong>short-circuiting</strong></td>
<td><code>anyMatch()</code>ã€ <code>allMatch()</code>ã€ <code>noneMatch()</code>ã€ <code>findFirst()</code>ã€ <code>findAny()</code>ã€ <code>limit()</code></td>
</tr>
</tbody></table>
<blockquote>
<p><strong>åŒºåˆ†ä¸­é—´æ“ä½œå’Œç»“æŸæ“ä½œæœ€ç®€å•çš„æ–¹æ³•</strong></p>
<p>â€‹    å°±æ˜¯çœ‹æ–¹æ³•çš„è¿”å›å€¼ï¼Œè¿”å›å€¼ä¸º<em>stream</em>çš„å¤§éƒ½æ˜¯ä¸­é—´æ“ä½œï¼Œå¦åˆ™æ˜¯ç»“æŸæ“ä½œã€‚</p>
</blockquote>
<h2 id="Terminal"><a href="#Terminal" class="headerlink" title="Terminal"></a>Terminal</h2><h3 id="forEach-forEachOrdered"><a href="#forEach-forEachOrdered" class="headerlink" title="forEach() / forEachOrdered()"></a>forEach() / forEachOrdered()</h3><p><code>void forEach(Consumer&lt;? super E&gt; action)</code></p>
<p><code>void forEachOrdered(Consumer&lt;? super E&gt; action)</code></p>
<p>ä½œç”¨æ˜¯å¯¹å®¹å™¨ä¸­çš„æ¯ä¸ªå…ƒç´ æ‰§è¡Œ<code>action</code>æŒ‡å®šçš„åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹å…ƒç´ è¿›è¡Œéå†ã€‚</p>
<p>ç”±äº<code>forEach()</code> / <code>forEachOrdered()</code> æ˜¯ç»“æŸæ–¹æ³•ï¼Œä¸Šè¿°ä»£ç ä¼šç«‹å³æ‰§è¡Œï¼Œè¾“å‡ºæ‰€æœ‰å­—ç¬¦ä¸²ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨Stream.forEach()è¿­ä»£</span></span><br><span class="line"> Stream.of(<span class="string">&quot;AAA&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCC&quot;</span>).parallel().forEach(System.out::println);</span><br><span class="line"> Stream.of(<span class="string">&quot;AAA&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCC&quot;</span>).parallel().forEachOrdered(System.out::println);</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>åŒºåˆ«</strong></p>
<p>â€‹    åœ¨å¹¶è¡Œæµä¸­ï¼Œ<code>forEachOrdered()</code>ä¼šä¿è¯æ˜¯é¡ºåºæ‰§è¡Œï¼Œè€Œ<code>forEach()</code>ä¸ä¼šã€‚</p>
</blockquote>
<h3 id="findFirst-findAny"><a href="#findFirst-findAny" class="headerlink" title="findFirst() / findAny()"></a>findFirst() / findAny()</h3><p>è¿™æ˜¯ä¸€ä¸ª terminal å…¼ short-circuiting æ“ä½œï¼Œå®ƒæ€»æ˜¯è¿”å› Stream çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…ç©ºã€‚</p>
<p>è¿”å›å€¼ç±»å‹ï¼šOptional</p>
<p>ç›®çš„æ˜¯å°½å¯èƒ½é¿å… <code>NullPointerException</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">    String strA = <span class="string">&quot; abcd &quot;</span>;</span><br><span class="line">	String strB = <span class="keyword">null</span>;</span><br><span class="line">    print(strA);</span><br><span class="line">	print(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	print(strB);</span><br><span class="line">	getLength(strA);</span><br><span class="line">	getLength(<span class="string">&quot;&quot;</span>);</span><br><span class="line">	getLength(strB);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Java 8</span></span><br><span class="line">     Optional.ofNullable(text).ifPresent(System.out::println);</span><br><span class="line">     <span class="comment">// Pre-Java 8</span></span><br><span class="line">     <span class="keyword">if</span> (text != <span class="keyword">null</span>) &#123;</span><br><span class="line">         System.out.println(text);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getLength</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Java 8</span></span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(text).map(String::length).orElse(-<span class="number">1</span>);</span><br><span class="line">     <span class="comment">// Pre-Java 8</span></span><br><span class="line">    <span class="comment">// return if (text != null) ? text.length() : -1;</span></span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>



<h3 id="count"><a href="#count" class="headerlink" title="count()"></a>count()</h3><p>æ±‚ç»“æœçš„ä¸ªæ•°ï¼Œç±»ä¼¼äºlistçš„size()æ–¹æ³•</p>
<p>è¿”å›å€¼ï¼šlongå‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">long</span> count = Stream.of(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;33&quot;</span>).filter(s -&gt; s.length() == <span class="number">1</span>).count();</span><br><span class="line">System.out.println(count);</span><br></pre></td></tr></table></figure>



<h3 id="max-min"><a href="#max-min" class="headerlink" title="max() / min()"></a>max() / min()</h3><p>æ±‚æœ€å¤§å€¼ï¼Œæœ€å°å€¼</p>
<p>å‚æ•°ï¼šComparatoræ¥å£</p>
<p>è¿”å›å€¼ï¼šoptional</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str1 = Stream.of(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;33&quot;</span>).max((s1, s2) -&gt; s1.length() - s2.length()).get();</span><br><span class="line">String str2 = Stream.of(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;33&quot;</span>).max(Comparator.comparingInt(String::length)).get();</span><br><span class="line">System.out.println(str1);</span><br><span class="line">System.out.println(str2);</span><br><span class="line"></span><br><span class="line">String str3 = Stream.of(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;33&quot;</span>).min((s1, s2) -&gt; s1.length() - s2.length()).get();</span><br><span class="line">String str4 = Stream.of(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;33&quot;</span>).min(Comparator.comparingInt(String::length)).get();</span><br><span class="line">System.out.println(str3);</span><br><span class="line">System.out.println(str4);</span><br></pre></td></tr></table></figure>



<h3 id="anyMatch"><a href="#anyMatch" class="headerlink" title="anyMatch()"></a>anyMatch()</h3><p>æŸ¥æ‰¾<em>stream</em>ä¸­æ˜¯å¦å­˜åœ¨ä»»ä½•ä¸€ä¸ªå…ƒç´ æ»¡è¶³åŒ¹é…æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸ºtrue å°±åœæ­¢éå†ï¼Œå¦åˆ™ç»§ç»­éå†ã€‚</p>
<p>å‚æ•°ï¼šPredicateæ¥å£</p>
<p>è¿”å›å€¼ï¼šboolean</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> isStartWithA = Stream.of(<span class="string">&quot;d2&quot;</span>, <span class="string">&quot;a2&quot;</span>, <span class="string">&quot;b1&quot;</span>, <span class="string">&quot;b3&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">		.map(String::toUpperCase)</span><br><span class="line">		.anyMatch(s -&gt; s.startsWith(<span class="string">&quot;A&quot;</span>));</span><br><span class="line">System.out.println(isStartWithA);</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>ä¸Šè¿°ä¾‹å­</strong></p>
<p>â€‹    éå†åˆ°a2ï¼Œåˆ™æ»¡è¶³<code>anyMatch</code>çš„æ¡ä»¶ï¼Œåˆ™é€€å‡ºéå†ï¼Œå¹¶è¿”å›trueã€‚</p>
</blockquote>
<h3 id="allMatch-noneMatch"><a href="#allMatch-noneMatch" class="headerlink" title="allMatch() / noneMatch()"></a>allMatch() / noneMatch()</h3><p><code>allMatch()</code>:  æŸ¥æ‰¾<em>stream</em>ä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦==éƒ½æ»¡è¶³==ç»™å®šçš„åŒ¹é…æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸º false å°±åœæ­¢éå†ï¼Œå¦åˆ™ç»§ç»­éå†ã€‚</p>
<p><code>noneMatch()</code>:  æŸ¥æ‰¾<em>stream</em>ä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦==éƒ½ä¸æ»¡è¶³==ç»™å®šçš„åŒ¹é…æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶ä¸º true å°±åœæ­¢éå†ï¼Œå¦åˆ™ç»§ç»­éå†ã€‚</p>
<p>å‚æ•°ï¼šPredicate æ¥å£</p>
<p>è¿”å›å€¼ï¼šboolean</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">boolean</span> isStartWithA = Stream.of(<span class="string">&quot;d2&quot;</span>, <span class="string">&quot;a2&quot;</span>, <span class="string">&quot;b1&quot;</span>, <span class="string">&quot;b3&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">		.map(String::toUpperCase)</span><br><span class="line">		.allMatch(s -&gt; s.startsWith(<span class="string">&quot;A&quot;</span>));</span><br><span class="line">	  <span class="comment">//.noneMatch(s -&gt; s.startsWith(&quot;A&quot;));</span></span><br><span class="line">System.out.println(isStartWithA);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹æ‰§è¡Œæµç¨‹ï¼Œå¯ä»¥é€‰æ‹©åœ¨è¡¨è¾¾å¼é‡Œè¾“å‡ºæ£€éªŒï¼š</p>
<p>â€‹    å¦‚ <code>allMatch()</code>ï¼Œå¯ä»¥æ›¿æ¢æˆ<code>noneMatch()</code> å’Œ<code>anyMatch()</code> </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream.of(<span class="string">&quot;d2&quot;</span>, <span class="string">&quot;a2&quot;</span>, <span class="string">&quot;b1&quot;</span>, <span class="string">&quot;b3&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">    .map(s -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;map: &quot;</span> + s);</span><br><span class="line">        <span class="keyword">return</span> s.toUpperCase();</span><br><span class="line">    &#125;)</span><br><span class="line">    .allMatch(s -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;allMatch: &quot;</span> + s);</span><br><span class="line">        <span class="keyword">return</span> s.startsWith(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="toArray"><a href="#toArray" class="headerlink" title="toArray()"></a>toArray()</h3><p><code>toArray()</code> å°†æµè½¬æ¢ä¸ºæ•°ç»„ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object[] toArray()</span><br><span class="line">&lt;A&gt; A[] toArray(IntFunction&lt;A[]&gt; generator)</span><br></pre></td></tr></table></figure>



<p>æ— å‚çš„ï¼Œè¿”å›ä¸€ä¸ªobjectå¯¹è±¡æ•°ç»„ï¼Œä¸€èˆ¬æ²¡ä»€ä¹ˆç”¨ã€‚</p>
<p>æœ‰å‚çš„ï¼Œéœ€è¦å†™ä¸€ä¸ª<code>funcation&lt;T,R&gt;</code>æ¥å£ï¼Œ è€Œ<code>IntFuncation&lt;R&gt;</code> æ˜¯<code>funcation&lt;T,R&gt;</code>æ¥å£çš„å­æ¥å£ï¼Œè§„å®šäº†è¾“å…¥æ˜¯<code>int</code>ç±»å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// :: è¡¨ç¤ºå¼•ç”¨ï¼Œä¸€ç§æ˜¯æ–¹æ³•(é™æ€ï¼Œå®ä¾‹)çš„å¼•ç”¨;</span></span><br><span class="line"><span class="comment">//            ä¸€ç§çš„æ„é€ æ–¹æ³•çš„å¼•ç”¨(æ„é€ çš„éœ€è¦åç€å†™,å¦‚new String[] &gt; String[]::new)</span></span><br><span class="line"></span><br><span class="line">IntFunction&lt;String[]&gt; function = String[]::<span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">String[] as = Stream.of(<span class="string">&quot;AAA&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCC&quot;</span>).parallel().toArray(function);</span><br><span class="line"></span><br><span class="line">System.out.println(Arrays.toString(as));</span><br></pre></td></tr></table></figure>



<h3 id="collect"><a href="#collect" class="headerlink" title="collect()"></a>collect()</h3><p><strong>1. Collection, Collections, collect, Collector, Collectors</strong></p>
<p><code>Collection</code>æ˜¯Javaé›†åˆçš„ç¥–å…ˆæ¥å£ã€‚<br><code>Collections</code>æ˜¯<code>java.util</code>åŒ…ä¸‹çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå†…æ¶µå„ç§å¤„ç†é›†åˆçš„é™æ€æ–¹æ³•ã€‚<br><code>java.util.stream.Stream#collect(java.util.stream.Collector&lt;? super T,A,R&gt;)</code>æ˜¯Streamçš„ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£æ”¶é›†æµã€‚<br><code>java.util.stream.Collector</code> æ˜¯ä¸€ä¸ªæ”¶é›†å‡½æ•°çš„æ¥å£, å£°æ˜äº†ä¸€ä¸ªæ”¶é›†å™¨çš„åŠŸèƒ½ã€‚<br><code>java.util.stream.Collectos</code>åˆ™æ˜¯ä¸€ä¸ªæ”¶é›†å™¨çš„å·¥å…·ç±»ï¼Œå†…ç½®äº†ä¸€ç³»åˆ—æ”¶é›†å™¨å®ç°ã€‚</p>
<p>å°† stream è½¬æ¢æˆ æ”¶é›†å™¨ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;R&gt; <span class="function">R <span class="title">collect</span><span class="params">(Supplier&lt;R&gt; supplier,</span></span></span><br><span class="line"><span class="function"><span class="params">                  BiConsumer&lt;R, ? <span class="keyword">super</span> T&gt; accumulator,</span></span></span><br><span class="line"><span class="function"><span class="params">                  BiConsumer&lt;R, R&gt; combiner)</span></span>;</span><br><span class="line">&lt;R, A&gt; <span class="function">R <span class="title">collect</span><span class="params">(Collector&lt;? <span class="keyword">super</span> T, A, R&gt; collector)</span></span></span><br></pre></td></tr></table></figure>



<p>ç¬¬ä¸€ç§æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;222&quot;</span>, <span class="string">&quot;333&quot;</span>, <span class="string">&quot;444&quot;</span>, <span class="string">&quot;555&quot;</span>);</span><br><span class="line">        <span class="comment">//Supplier&lt;R&gt;æ¥å£ ç”¨æ¥åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæŒ‡å®šæ•°æ®ç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">        <span class="comment">//BiConsumer&lt;R, ? super T&gt; accumulatoræ¥å£ ç”¨æ¥å£°æ˜ä¸€äº›æ“ä½œã€‚</span></span><br><span class="line">            <span class="comment">//	* å‚æ•°R æ˜¯æŒ‡supplieråˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œ</span></span><br><span class="line">            <span class="comment">//	* å‚æ•°T æ˜¯æŒ‡æ¯æ¬¡è¿­ä»£çš„å¯¹è±¡</span></span><br><span class="line">        <span class="comment">//BiConsumer&lt;R, R&gt; combineræ¥å£ æŒ‡å®šæ‰§è¡Œçš„å‚æ•°ç±»å‹ï¼Œä»¥åŠè¿”å›å€¼ç±»å‹</span></span><br><span class="line"></span><br><span class="line"> HashMap&lt;String, String&gt; map = list.stream()</span><br><span class="line">     .collect(HashMap::<span class="keyword">new</span>,</span><br><span class="line">             (hashMap, str) -&gt; hashMap.put(str, str),</span><br><span class="line"><span class="comment">//           (hashMap, hashMap2) -&gt; hashMap.putAll(hashMap2));</span></span><br><span class="line"><span class="comment">//           HashMap::putAll);</span></span><br><span class="line">             Map::putAll);</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>è§£é‡Š</strong></p>
<p>â€‹    1ã€æ¯æ¬¡å¾ªç¯éƒ½åˆ›å»ºä¸€ä¸ªhashMap</p>
<p>â€‹    2ã€æ¯æ¬¡å¾ªç¯éƒ½æŠŠå½“å‰éå†çš„å€¼ï¼Œå­˜å‚¨åœ¨åˆ›å»ºå‡ºæ¥çš„hashMapä¸­</p>
<p>â€‹    3ã€æœ€åå†ç”¨ä¸Šä¸€æ¬¡çš„hashMapï¼ŒputAllè¿™æ¬¡éå†çš„hashMapï¼Œæœ€åéå†å®Œåå°±ä¼šè¿”å›ä¸€ä¸ªæ€»çš„Map</p>
</blockquote>
<p>ç¬¬äºŒç§æ„é€ æ–¹æ³•ï¼š</p>
<p>â€‹    ä½¿ç”¨Collectorså·¥å…·ç±»</p>
<p><strong>2.Collectors</strong></p>
<p>collecté‡Œé¢çš„æ“ä½œç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚</p>
<p>å¯ä»¥æŠŠstreamï¼Œä½¿ç”¨æŸäº›æ•°æ®ç»“æ„å­˜å‚¨èµ·æ¥ã€‚è€Œcollectorså°±æ˜¯æ–¹ä¾¿æˆ‘ä»¬æ„é€ æ”¶é›†å™¨çš„ã€‚</p>
<p><code>Collectors.toList()</code> ï¼š æ„é€ ä¸€ä¸ªlist</p>
<p><code>Collectors.toSet()</code> ï¼š æ„é€ ä¸€ä¸ªset</p>
<p><code>Collectors.toCollection(ArrayList::new)</code> ï¼š æ„é€ ä¸€ä¸ªè‡ªå®šä¹‰æ”¶é›†å™¨ï¼Œå‚æ•°ç”¨è‡ªå®šä¹‰æ”¶é›†å™¨ï¼Œè¿™é‡Œç”¨liståªæ˜¯æ–¹ä¾¿ä¸¾ä¾‹</p>
<p><code>Collectors.joining()</code> ï¼š ==æ„é€ ä¸€ä¸ªstring==ï¼Œå‚æ•°æ˜¯åˆ†å‰²ç¬¦ï¼Œå‰ç¼€ï¼Œåç¼€</p>
<p><code>Collectors.toMap()</code>  å’Œ <code>Collectors.toConcurrentMap()</code> æœ‰ä¸‰ä¸ªæ–¹æ³•</p>
<p>æ„é€ æ–¹æ³•å·®ä¸å¤šï¼Œè¿™é‡Œåªåˆ—ä¸¾toMapçš„æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</span><br><span class="line">                                   Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; valueMapper)</span><br><span class="line">    </span><br><span class="line">Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</span><br><span class="line">                                   Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; valueMapper,</span><br><span class="line">                                   BinaryOperator&lt;U&gt; mergeFunction)</span><br><span class="line">    </span><br><span class="line">Collector&lt;T, ?, M&gt; toMap(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; keyMapper,</span><br><span class="line">                               Function&lt;? <span class="keyword">super</span> T, ? extends U&gt; valueMapper,</span><br><span class="line">                               BinaryOperator&lt;U&gt; mergeFunction,</span><br><span class="line">                               Supplier&lt;M&gt; mapSupplier)</span><br></pre></td></tr></table></figure>

<p>â€‹    </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;AAA&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">        <span class="comment">//Function.identity() : ä»£è¡¨å½“å‰éå†çš„å¯¹è±¡</span></span><br><span class="line">        <span class="comment">//ç¬¬ä¸€ç§æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//Function&lt;T, K&gt; : æ¥å£ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¾“å…¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å‡º </span></span><br><span class="line">		<span class="comment">//å¦‚ Function&lt;Party,String&gt; fun = party -&gt; party.getPartyType()</span></span><br><span class="line"> Map&lt;String, String&gt; collect = list.stream()</span><br><span class="line">    .collect(Collectors.toMap(Function.identity(), Function.identity()));</span><br><span class="line"></span><br><span class="line"> Map&lt;String, String&gt; collect1 = list.stream()</span><br><span class="line">     .collect(Collectors.toMap(String::toUpperCase, String::toLowerCase));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœkey,valueæ˜¯ç©ºçš„è¯ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œ</span></span><br><span class="line">		<span class="comment">//å› ä¸ºCollectors.toMap()åº•å±‚ä½¿ç”¨Map.merge()ï¼Œmergeä¸­key, valueä¸èƒ½ä¸ºç©º</span></span><br><span class="line"> Map&lt;String, String&gt; collect2 = list.stream()</span><br><span class="line"><span class="comment">//   .collect(Collectors.toMap(String::toUpperCase, null));</span></span><br><span class="line">     .collect(Collectors.toMap(<span class="keyword">null</span>, String::toUpperCase));</span><br><span class="line"> System.out.println(collect2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬äºŒç§æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// å®šä¹‰å½“keyé‡å¤æ—¶çš„æ“ä½œï¼ŒCollectors.toMap()æ–¹æ³•å¦‚æœkeyç›¸åŒï¼Œä¼šæŠ¥å¼‚å¸¸ï¼Œå¯ä»¥è‡ªå®šä¹‰å½“keyé‡å¤æ—¶çš„æ“ä½œ</span></span><br><span class="line">        <span class="comment">// BinaryOperator&lt;U&gt; mergeFunction</span></span><br><span class="line"> Map&lt;String, String&gt; collect3 = list.stream()</span><br><span class="line">     .collect(Collectors.toMap(</span><br><span class="line">                String::toUpperCase,</span><br><span class="line">                String::toLowerCase,</span><br><span class="line">                (oldValue, newValue) -&gt; oldValue));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç¬¬ä¸‰ç§æ„é€ æ–¹æ³•</span></span><br><span class="line">        <span class="comment">//Supplier&lt;M&gt; mapSupplier :è‡ªå®šä¹‰ä½¿ç”¨Mapçš„ç±»å‹</span></span><br><span class="line"> Map&lt;String, String&gt; collect4 = list.stream()</span><br><span class="line">     .collect(Collectors.toMap(</span><br><span class="line">                String::toUpperCase,</span><br><span class="line">                String::toLowerCase,</span><br><span class="line">                (oldValue, newValue) -&gt; oldValue,</span><br><span class="line"><span class="comment">//              HashMap::new));</span></span><br><span class="line"><span class="comment">//              ConcurrentHashMap::new));</span></span><br><span class="line">                LinkedHashMap::<span class="keyword">new</span>));</span><br></pre></td></tr></table></figure>



<blockquote>
<p>toMap å’Œ toConcurrentMap çš„å¼‚åŒ</p>
</blockquote>
<p><code>Collectors.summarizingInt(String::length)</code></p>
<p>â€‹    åŒç†æœ‰Doubleï¼ŒLong</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">IntSummaryStatistics collect = list.stream()</span><br><span class="line">.collect(Collectors.summarizingInt(String::length));</span><br><span class="line">System.out.println(collect.getMax());</span><br><span class="line">System.out.println(collect.getMin());</span><br><span class="line">System.out.println(collect.getSum());</span><br><span class="line">System.out.println(collect.getAverage());</span><br><span class="line">System.out.println(collect.getCount());</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç»Ÿä¸€æ±‚é•¿åº¦æœ€å¤§å€¼ï¼Œæœ€å°å€¼ï¼Œå¹³å‡æ•°ï¼Œæ±‚å’Œï¼Œæ±‚ä¸ªæ•°</p>
<p><code>Collectors.groupingBy()</code> æœ‰ä¸‰ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ—è¡¨åˆ†ç»„</p>
<p>æŒ‰functionçš„æ¡ä»¶ï¼Œåˆ†æˆå¤šä¸ªç»„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collector&lt;T, ?, Map&lt;K, List&lt;T&gt;&gt;&gt; groupingBy(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; classifier)</span><br><span class="line"></span><br><span class="line">Collector&lt;T, ?, Map&lt;K, D&gt;&gt; groupingBy(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; classifier,</span><br><span class="line">                                         Collector&lt;? <span class="keyword">super</span> T, A, D&gt; downstream) </span><br><span class="line">                                         </span><br><span class="line">Collector&lt;T, ?, M&gt; groupingBy(Function&lt;? <span class="keyword">super</span> T, ? extends K&gt; classifier,</span><br><span class="line">                                 Supplier&lt;M&gt; mapFactory,</span><br><span class="line">                                 Collector&lt;? <span class="keyword">super</span> T, A, D&gt; downstream)</span><br></pre></td></tr></table></figure>



<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">Map&lt;Integer, List&lt;String&gt;&gt; collect =  list.stream()</span><br><span class="line">     .collect(Collectors.groupingBy(String::length));</span><br><span class="line">Map&lt;Integer, Long&gt; collect1 =  list.stream()</span><br><span class="line">     .collect(Collectors.groupingBy(String::length, counting()));</span><br></pre></td></tr></table></figure>



<p><code>Collectors.partitioningBy()</code> ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œåˆ—è¡¨åˆ†å‰²</p>
<p>æŒ‰ç…§Predicateï¼Œåˆ†å‰²æˆä¸¤ç»„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collector&lt;T, ?, Map&lt;Boolean, D&gt;&gt; partitioningBy(Predicate&lt;? <span class="keyword">super</span> T&gt;)</span><br><span class="line">Collector&lt;T, ?, Map&lt;Boolean, D&gt;&gt; partitioningBy(Predicate&lt;? <span class="keyword">super</span> T&gt; predicate,</span><br><span class="line">                                                Collector&lt;? <span class="keyword">super</span> T, A, D&gt; downstream) </span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ†å‰²æ•°æ®å—</span></span><br><span class="line">Map&lt;Boolean, List&lt;Integer&gt;&gt; collectParty = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">		.collect(Collectors.partitioningBy(it -&gt; it % <span class="number">2</span> == <span class="number">0</span>));</span><br><span class="line">List&lt;Integer&gt; integers = collectParty.get(<span class="keyword">true</span>);</span><br><span class="line">System.out.println(integers);</span><br><span class="line"></span><br><span class="line">Map&lt;Boolean, Long&gt; partiCount = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">           .collect(Collectors.partitioningBy(it -&gt; it % <span class="number">2</span> == <span class="number">0</span>,</span><br><span class="line">           Collectors.counting()));</span><br><span class="line">System.out.println(<span class="string">&quot;partiCount: &quot;</span> + partiCount);</span><br><span class="line"><span class="comment">// æ‰“å°ç»“æœ</span></span><br><span class="line"><span class="comment">// partiCount: &#123;false=2, true=2&#125;</span></span><br></pre></td></tr></table></figure>



<p><strong>æ”¶é›†å™¨çš„æ„æˆ</strong></p>
<p><strong>1.</strong> åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æœå®¹å™¨(supplier())</p>
<p><strong>2.</strong>  å°†ä¸€ä¸ªæ–°çš„æ•°æ®å…ƒç´ åˆå¹¶åˆ°ä¸€ä¸ªç»“æœå®¹å™¨ä¸­(accumulator())</p>
<p><strong>3.</strong> å°†ä¸¤ä¸ªç»“æœå®¹å™¨åˆå¹¶æˆä¸€ä¸ª(combiner())</p>
<p><strong>4.</strong> åœ¨å®¹å™¨ä¸Šæ‰§è¡Œä¸€ä¸ªå¯é€‰çš„æœ€ç»ˆè½¬æ¢ (finisher()) </p>
<table>
<thead>
<tr>
<th>æ”¶é›†å™¨å‚æ•°åˆ—è¡¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>toList()</code></td>
</tr>
<tr>
<td><code>toSet()</code></td>
</tr>
<tr>
<td><code>toCollection(Supplier&lt;C&gt;)</code></td>
</tr>
<tr>
<td><code>counting()</code></td>
</tr>
<tr>
<td><code>collectingAndThen(Collector&lt;T, A, R&gt;, Function&lt;R, RR&gt;)</code></td>
</tr>
<tr>
<td><code>summingInt(ToIntFunction&lt;? super T&gt;)</code>                                                                                                       <code>summingLong(ToLongFunction&lt;? super T&gt;)</code>                                                                                  <code>summingDouble(ToDoubleFunction&lt;? super T&gt;)</code></td>
</tr>
<tr>
<td><code>maxBy(Comparator&lt;? super T&gt;)</code></td>
</tr>
<tr>
<td><code>minBy(Comparator&lt;? super T&gt;)</code></td>
</tr>
<tr>
<td><code>reducing(BinaryOperator&lt;T&gt;)</code>                                                                                                                                                                        <code>reducing(T, BinaryOperator&lt;T&gt;)</code>                                                                                                                                                                  <code>reducing(U, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;)</code></td>
</tr>
<tr>
<td><code>joining()</code>                                                                                                                                                                                           <code>joining(CharSequence)</code>                                                                                                                                                               <code>joining(CharSequence, CharSequence, CharSequence)</code></td>
</tr>
<tr>
<td><code>mapping(Function&lt;? super T, ? extends U&gt;, Collector&lt;? super U, A, R&gt;)</code></td>
</tr>
<tr>
<td><code>toMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;)</code>                                                              <code>toMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;)</code>                     <code>toMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;, Supplier&lt;M&gt;)</code> <code>toConcurrentMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;)</code>                          <code>toConcurrentMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;)</code> <code>toConcurrentMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;, Supplier&lt;M&gt;)</code></td>
</tr>
<tr>
<td><code>groupingBy(Function&lt;? super T, ? extends K&gt;)</code>                                                                                                             <code>groupingBy(Function&lt;? super T, ? extends K&gt;, Supplier&lt;M&gt;, Collector&lt;? super T, A, D&gt;)</code>                                                          <code>groupingBy(Function&lt;? super T, ? extends K&gt;, Collector&lt;? super T, A, D&gt;)</code>                                   <code>groupingByConcurrent(Function&lt;? super T, ? extends K&gt;)</code>                                                                    <code>groupingByConcurrent(Function&lt;? super T, ? extends K&gt;, Supplier&lt;M&gt;, Collector&lt;? super T, A, D&gt;)</code> <code>groupingByConcurrent(Function&lt;? super T, ? extends K&gt;, Collector&lt;? super T, A, D&gt;)</code></td>
</tr>
<tr>
<td><code>partitioningBy(Predicate&lt;? super T&gt;)</code>                                                                                                                         <code>partitioningBy(Predicate&lt;? super T&gt;, Collector&lt;? super T, A, D&gt;)</code></td>
</tr>
<tr>
<td><code>averagingDouble(ToDoubleFunction&lt;? super T&gt;)</code>                                                                                            <code>averagingInt(ToIntFunction&lt;? super T&gt;)</code>                                                                                                          <code>averagingLong(ToLongFunction&lt;? super T&gt;)</code></td>
</tr>
<tr>
<td><code>summarizingDouble(ToDoubleFunction&lt;? super T&gt;)</code>                                                                             <code>summarizingInt(ToIntFunction&lt;? super T&gt;)</code>                                                                                     <code>summarizingLong(ToLongFunction&lt;? super T&gt;)</code></td>
</tr>
</tbody></table>
<h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce()"></a>reduce()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">Optional&lt;T&gt; <span class="title">reduce</span><span class="params">(BinaryOperator&lt;T&gt; accumulator)</span></span>;</span><br><span class="line"><span class="function">T <span class="title">reduce</span><span class="params">(T identity, BinaryOperator&lt;T&gt; accumulator)</span></span>;</span><br><span class="line">&lt;U&gt; <span class="function">U <span class="title">reduce</span><span class="params">(U identity,BiFunction&lt;U, ? <span class="keyword">super</span> T, U&gt; accumulator,BinaryOperator&lt;U&gt; combiner)</span></span>;</span><br></pre></td></tr></table></figure>

<p>æ–¹å¼ä¸€ï¼š</p>
<p>ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼æ˜¯Streamçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯Streamçš„ç¬¬äºŒä¸ªå…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Optional accResult = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">        .reduce((acc, item) -&gt; &#123;</span><br><span class="line">            acc += item;</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>

<p>æ–¹å¼äºŒï¼šåœ¨æ–¹å¼ä¸€çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šåˆå§‹åŒ–çš„å€¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> accResult = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">            .reduce(<span class="number">0</span>, (acc, item) -&gt; &#123;</span><br><span class="line">                acc += item;</span><br><span class="line">                <span class="keyword">return</span> acc;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>





<h2 id="Intermediate"><a href="#Intermediate" class="headerlink" title="Intermediate"></a>Intermediate</h2><h3 id="filter"><a href="#filter" class="headerlink" title="filter()"></a>filter()</h3><p><code>Stream&lt;T&gt; filter(Predicate&lt;? super T&gt; predicate)</code></p>
<p>ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªåªåŒ…å«æ»¡è¶³predicateæ¡ä»¶å…ƒç´ çš„Streamã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¿ç•™é•¿åº¦ç­‰äº3çš„å­—ç¬¦ä¸²</span></span><br><span class="line">Stream&lt;String&gt; stream= Stream.of(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;love&quot;</span>, <span class="string">&quot;you&quot;</span>, <span class="string">&quot;too&quot;</span>);</span><br><span class="line">stream.filter(str -&gt; str.length()==<span class="number">3</span>)</span><br><span class="line">      .forEach(str -&gt; System.out.println(str));</span><br></pre></td></tr></table></figure>



<blockquote>
<p><strong>æ³¨æ„</strong></p>
<p>â€‹    ç”±äºfilter()æ˜¯ä¸ªä¸­é—´æ“ä½œï¼Œå¦‚æœåªè°ƒç”¨filter()ä¸ä¼šæœ‰å®é™…è®¡ç®—ï¼Œå› æ­¤ä¹Ÿä¸ä¼šè¾“å‡ºä»»ä½•ä¿¡æ¯ã€‚</p>
<p>â€‹    filter ä¿ç•™æ¡ä»¶ä¸ºtrueçš„å…ƒç´ ã€‚</p>
</blockquote>
<h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct()"></a>distinct()</h3><p><code>Stream&lt;T&gt; distinct()</code></p>
<p>ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªå»é™¤é‡å¤å…ƒç´ ä¹‹åçš„Streamã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;String&gt; stream= Stream.of(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;love&quot;</span>, <span class="string">&quot;you&quot;</span>, <span class="string">&quot;too&quot;</span>, <span class="string">&quot;too&quot;</span>);</span><br><span class="line">stream.distinct()</span><br><span class="line">	  .forEach(str -&gt; System.out.println(str));</span><br></pre></td></tr></table></figure>



<h3 id="sorted"><a href="#sorted" class="headerlink" title="sorted()"></a>sorted()</h3><p>æ’åºå‡½æ•°æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ç”¨è‡ªç„¶é¡ºåºæ’åºï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨æ’åº</p>
<p><code>åˆ†åˆ«ä¸ºStream&lt;T&gt;ã€€sorted()å’ŒStream&lt;T&gt;ã€€sorted(Comparator&lt;? super T&gt; comparator)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;String&gt; stream= Stream.of(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;love&quot;</span>, <span class="string">&quot;you&quot;</span>, <span class="string">&quot;too&quot;</span>);</span><br><span class="line">stream.sorted((str1, str2) -&gt; str1.length()-str2.length())</span><br><span class="line">      .forEach(str -&gt; System.out.println(str));</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä¸Šè¿°ä»£ç å°†è¾“å‡ºæŒ‰ç…§é•¿åº¦å‡åºæ’åºåçš„å­—ç¬¦ä¸²</p>
</blockquote>
<h3 id="map"><a href="#map" class="headerlink" title="map()"></a>map()</h3><p><code>&lt;R&gt; Stream&lt;R&gt; map(Function&lt;? super T,? extends R&gt; mapper)ï¼Œ</code></p>
<p>ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªå¯¹å½“å‰æ‰€æœ‰å…ƒç´ æ‰§è¡Œmapperä¹‹åçš„ç»“æœç»„æˆçš„Streamã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;String&gt; streamã€€= Stream.of(<span class="string">&quot;I&quot;</span>, <span class="string">&quot;love&quot;</span>, <span class="string">&quot;you&quot;</span>, <span class="string">&quot;too&quot;</span>);</span><br><span class="line">stream.map(str -&gt; str.toUpperCase())</span><br><span class="line">      .forEach(str -&gt; System.out.println(str));</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä¸Šè¿°ä»£ç å°†è¾“å‡ºåŸå­—ç¬¦ä¸²çš„å¤§å†™å½¢å¼ã€‚</p>
</blockquote>
<h3 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap()"></a>flatMap()</h3><p><code>&lt;R&gt; Stream&lt;R&gt; flatMap(Function&lt;? super T,? extends Stream&lt;? extends R&gt;&gt; mapper)</code></p>
<p>ä½œç”¨æ˜¯å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡ŒmapperæŒ‡å®šçš„æ“ä½œï¼Œå¹¶ç”¨æ‰€æœ‰mapperè¿”å›çš„<em>stream</em>ä¸­çš„å…ƒç´ ç»„æˆä¸€ä¸ªæ–°çš„<em>stream</em>ä½œä¸ºæœ€ç»ˆè¿”å›ç»“æœã€‚</p>
<p>é€šä¿—çš„è®²<code>flatMap()</code>çš„ä½œç”¨å°±ç›¸å½“äºæŠŠåŸ<em>stream</em>ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½â€æ‘Šå¹³â€ä¹‹åç»„æˆçš„<em>stream</em>ï¼Œè½¬æ¢å‰åå…ƒç´ çš„ä¸ªæ•°å’Œç±»å‹éƒ½å¯èƒ½ä¼šæ”¹å˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Stream&lt;List&lt;Integer&gt;&gt; stream = Stream.of(Arrays.asList(<span class="number">1</span>,<span class="number">2</span>), Arrays.asList(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">stream.flatMap(list -&gt; list.stream())</span><br><span class="line">      .forEach(i -&gt; System.out.println(i));</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä¸Šè¿°ä»£ç ä¸­ï¼ŒåŸæ¥çš„<em>stream</em>ä¸­æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«æ˜¯ä¸¤ä¸ª<code>List&lt;Integer&gt;</code>ï¼Œæ‰§è¡Œ<code>flatMap()</code>ä¹‹åï¼Œå°†æ¯ä¸ªListéƒ½â€œæ‘Šå¹³â€æˆäº†ä¸€ä¸ªä¸ªçš„æ•°å­—ï¼Œæ‰€ä»¥ä¼šæ–°äº§ç”Ÿä¸€ä¸ªç”±5ä¸ªæ•°å­—ç»„æˆçš„Streamã€‚æ‰€ä»¥æœ€ç»ˆå°†è¾“å‡º1~5è¿™5ä¸ªæ•°å­—ã€‚</p>
</blockquote>
<p><strong>å›¾ç¤º</strong></p>
<p><img src="image/2.png" alt="Stream flatMap"></p>
<h3 id="skip"><a href="#skip" class="headerlink" title="skip()"></a>skip()</h3><p>è·³è¿‡å‰é¢ n ä¸ªå¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">List&lt;String&gt; list2 = list.stream().skip(<span class="number">3</span>).collect(toList());</span><br><span class="line">System.out.println(list2); <span class="comment">//[DDD, EEE]</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; first = list.stream().skip(<span class="number">2</span>).findFirst();</span><br><span class="line">System.out.println(first.get());<span class="comment">//CCCC</span></span><br></pre></td></tr></table></figure>



<h3 id="limit"><a href="#limit" class="headerlink" title="limit()"></a>limit()</h3><p>è·å–é™å®šä¸ªæ•°çš„å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">List&lt;String&gt; list2 = list.stream().limit(<span class="number">2</span>).collect(toList());</span><br><span class="line">System.out.println(list2); <span class="comment">//[A, BBB]</span></span><br><span class="line"></span><br><span class="line">Optional&lt;String&gt; first = list.stream().limit(<span class="number">2</span>).findFirst();</span><br><span class="line">System.out.println(first.get());<span class="comment">//A</span></span><br></pre></td></tr></table></figure>



<h3 id="concat"><a href="#concat" class="headerlink" title="concat()"></a>concat()</h3><p>é™æ€æ–¹æ³•ï¼ŒæŠŠä¸¤ä¸ªStreamæ‹¼åœ¨ä¸€èµ·</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">List&lt;String&gt; list2 = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">List&lt;String&gt; collect = </span><br><span class="line">             Stream.concat(list.stream(), list2.stream())</span><br><span class="line">    		  .collect(Collectors.toList());</span><br><span class="line">System.out.println(collect); <span class="comment">//[A, BBB, CCCC, DDD, EEE, A, BBB, CCCC, DDD, EEE]</span></span><br></pre></td></tr></table></figure>



<h3 id="peek"><a href="#peek" class="headerlink" title="peek()"></a>peek()</h3><p>å¯ä»¥åšä¸€äº›å³æ—¶çš„æ“ä½œï¼ŒåŠŸèƒ½å’ŒforEachç›¸åŒ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line">       <span class="comment">//ABBBCCCCDDDEEE</span></span><br><span class="line">List&lt;String&gt; collect = list.stream()</span><br><span class="line">				.peek(System.out::print)</span><br><span class="line">				.filter(s -&gt; s.length() == <span class="number">3</span>)</span><br><span class="line">				.collect(Collectors.toList());</span><br><span class="line">System.out.println();</span><br><span class="line">System.out.println(collect);<span class="comment">//[BBB, DDD, EEE]</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å’Œforeachçš„ä¸åŒç‚¹ï¼š</p>
<p>â€‹    peek: ç”Ÿæˆä¸€ä¸ªåŒ…å«åŸ<em>stream</em>çš„æ‰€æœ‰å…ƒç´ çš„æ–°<em>stream</em>ï¼ŒåŒæ—¶ä¼šæä¾›ä¸€ä¸ªæ¶ˆè´¹å‡½æ•°ï¼ˆConsumerå®ä¾‹ï¼‰ï¼Œ</p>
<p>â€‹           æ–°<em>stream</em>æ¯ä¸ªå…ƒç´ è¢«æ¶ˆè´¹çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œç»™å®šçš„æ¶ˆè´¹å‡½æ•°ï¼›</p>
<p>â€‹    é€šä¿—çš„è®²ï¼špeekæ˜¯ä¸ªä¸­é—´æ“ä½œï¼Œå®ƒæä¾›äº†ä¸€ç§å¯¹æµä¸­æ‰€æœ‰å…ƒç´ æ“ä½œçš„æ–¹æ³•ï¼Œè€Œä¸ä¼šæŠŠè¿™ä¸ªæµæ¶ˆè´¹æ‰</p>
<p>â€‹                ï¼ˆforeachä¼šæŠŠæµæ¶ˆè´¹æ‰ï¼‰</p>
</blockquote>
<h3 id="parallel"><a href="#parallel" class="headerlink" title="parallel()"></a>parallel()</h3><p>å°†<em>stream<em>å˜æˆ å¹¶è¡Œ</em>stream</em></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;BBB&quot;</span>, <span class="string">&quot;CCCC&quot;</span>, <span class="string">&quot;DDD&quot;</span>, <span class="string">&quot;EEE&quot;</span>);</span><br><span class="line"><span class="keyword">boolean</span> isParallel = list.stream().parallel().isParallel();</span><br><span class="line">System.out.println(isParallel);<span class="comment">//true</span></span><br><span class="line"><span class="keyword">boolean</span> parallel = list.parallelStream().isParallel();</span><br><span class="line">System.out.println(parallel); <span class="comment">//true</span></span><br></pre></td></tr></table></figure>



<h3 id="sequential"><a href="#sequential" class="headerlink" title="sequential()"></a>sequential()</h3><h3 id="unordered"><a href="#unordered" class="headerlink" title="unordered()"></a>unordered()</h3>]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>lambda</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼ç¼“å­˜-Memcachedçš„åŸç†åŠæ¶æ„å‰–æ</title>
    <url>/2021/02/08/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-Memcached%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/</url>
    <content><![CDATA[<h1 id="Memcached-çš„åŸç†åŠæ¶æ„å‰–æ"><a href="#Memcached-çš„åŸç†åŠæ¶æ„å‰–æ" class="headerlink" title="Memcached çš„åŸç†åŠæ¶æ„å‰–æ"></a>Memcached çš„åŸç†åŠæ¶æ„å‰–æ</h1><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œç”¨æˆ·ä½“éªŒå¯ä»¥è¯´æ˜¯äº’è”ç½‘ä¼ä¸šæœ€çœ‹é‡çš„æŒ‡æ ‡ï¼Œè€Œåœ¨ç”¨æˆ·ä½“éªŒä¸­ï¼Œè¯·æ±‚å“åº”é€Ÿåº¦æ˜¯é¦–è¦çš„ã€‚å› æ­¤äº’è”ç½‘ç³»ç»Ÿå¯¹æ€§èƒ½çš„è¿½æ±‚æ˜¯æ°¸æ— æ­¢å¢ƒçš„ã€‚æ€§èƒ½äº‰éœ¸ï¼Œç¼“å­˜ä¸ºç‹ï¼ŒMemcachedï¼Œä½œä¸ºäº’è”ç½‘ç³»ç»Ÿä½¿ç”¨æœ€å¹¿æ³›ã€å½±å“æœ€å¤§çš„æ ‡é…ç¼“å­˜ç»„ä»¶ï¼Œå¯ä»¥è¯´çš„ä¸Šæ˜¯ç‹ä¸­ä¹‹ç‹ã€‚</p>
<h2 id="Memcached-åŸç†åŠç‰¹æ€§"><a href="#Memcached-åŸç†åŠç‰¹æ€§" class="headerlink" title="Memcached åŸç†åŠç‰¹æ€§"></a>Memcached åŸç†åŠç‰¹æ€§</h2><p><strong>åŸç†</strong></p>
<p>Memcached æ˜¯ä¸€ä¸ªå¼€æºçš„ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼ key/value å†…å­˜ç¼“å­˜ç³»ç»Ÿã€‚å®ƒä»¥ key/value é”®å€¼å¯¹çš„æ–¹å¼å­˜å‚¨æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªé”®å€¼ç±»å‹çš„ NoSQL ç»„ä»¶ã€‚</p>
<p>NoSQL å³ Not SQLï¼Œæ³›æŒ‡éå…³ç³»å‹æ•°æ®å­˜å‚¨ã€‚NoSQL æ˜¯é€šè¿‡èšåˆæ¨¡å‹æ¥è¿›è¡Œæ•°æ®å¤„ç†çš„ã€‚å…¶èšåˆæ¨¡å‹ä¸»è¦åˆ†ä¸ºï¼škey/value é”®å€¼å¯¹ã€åˆ—æ—ã€å›¾å½¢ç­‰å‡ ç§æ–¹å¼ã€‚å…¶ä¸­ key/value é”®å€¼ç±»ä¼¼æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„ mapï¼Œåªèƒ½é€šè¿‡ key æ¥è¿›è¡ŒæŸ¥æ‰¾å’Œå˜æ›´æ“ä½œã€‚æˆ‘ä»¬ä½¿ç”¨çš„ Memcachedã€Redis ç­‰éƒ½æ˜¯ key/value ç±»å‹çš„ NoSQL å­˜å‚¨ç»„ä»¶ã€‚</p>
<p>Memcached ç®€ç§° Mcï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„å†…å­˜å‹ç¼“å­˜ç»„ä»¶ï¼Œè¿™å°±æ„å‘³ç€ï¼ŒMc ä¸€æ—¦é‡å¯å°±ä¼šä¸¢å¤±æ‰€æœ‰çš„æ•°æ®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMc ç»„ä»¶ä¹‹é—´ç›¸äº’ä¸é€šä¿¡ï¼Œå®Œå…¨ç”± client å¯¹ key è¿›è¡Œ Hash ååˆ†å¸ƒå’ŒååŒã€‚Mc é‡‡ç”¨å¤šçº¿ç¨‹å¤„ç†è¯·æ±‚ï¼Œç”±ä¸€ä¸ªä¸»çº¿ç¨‹å’Œä»»æ„å¤šä¸ªå·¥ä½œçº¿ç¨‹åä½œï¼Œä»è€Œå……åˆ†åˆ©ç”¨å¤šæ ¸ï¼Œæå‡ IO æ•ˆç‡ã€‚</p>
<p><img src="http://image.leonote.cn//20210207102810.jpg" alt=""></p>
<p><strong>slab æœºåˆ¶</strong> </p>
<p>Mc å¹¶ä¸æ˜¯å°†æ‰€æœ‰æ•°æ®æ”¾åœ¨ä¸€èµ·æ¥è¿›è¡Œç®¡ç†çš„ï¼Œè€Œæ˜¯å°†å†…å­˜åˆ’åˆ†ä¸ºä¸€ç³»åˆ—ç›¸åŒå¤§å°çš„ slab ç©ºé—´åï¼Œæ¯ä¸ª slab åªç®¡ç†ä¸€å®šèŒƒå›´å†…çš„æ•°æ®å­˜å‚¨ã€‚ä¹Ÿå°±æ˜¯è¯´ Mc å†…éƒ¨é‡‡ç”¨ slab æœºåˆ¶æ¥ç®¡ç†å†…å­˜åˆ†é…ã€‚Mc å†…çš„å†…å­˜åˆ†é…ä»¥ slab ä¸ºå•ä½ï¼Œé»˜è®¤æƒ…å†µä¸‹<strong>ä¸€ä¸ª slab æ˜¯ 1MB</strong>ï¼Œå¯ä»¥é€šè¿‡ -I å‚æ•°åœ¨å¯åŠ¨æ—¶æŒ‡å®šå…¶ä»–æ•°å€¼ã€‚</p>
<p>slab ç©ºé—´å†…éƒ¨ï¼Œä¼šè¢«è¿›ä¸€æ­¥åˆ’åˆ†ä¸ºä¸€ç³»åˆ—å›ºå®šå¤§å°çš„ chunkã€‚æ¯ä¸ª chunk å†…éƒ¨å­˜å‚¨ä¸€ä¸ª Itemï¼Œåˆ©ç”¨ Item ç»“æ„å­˜å‚¨æ•°æ®ã€‚å› ä¸º chunk å¤§å°å›ºå®šï¼Œè€Œ key/value æ•°æ®çš„å¤§å°éšæœºã€‚æ‰€ä»¥ï¼ŒItemå­˜å‚¨å®Œ key/value æ•°æ®åï¼Œä¸€èˆ¬è¿˜ä¼šæœ‰å¤šä½™çš„ç©ºé—´ï¼Œè¿™ä¸ªå¤šä½™çš„ç©ºé—´å°±è¢«æµªè´¹äº†ã€‚ä¸ºäº†æå‡å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ï¼Œchunk size å°±ä¸èƒ½å¤ªå¤§ï¼Œè€Œè¦å°½é‡é€‰æ‹©ä¸ key/value size æ¥è¿‘çš„ ï¼Œä»è€Œå‡å°‘ chunk å†…æµªè´¹çš„ç©ºé—´ã€‚</p>
<p>Mc åœ¨åˆ†é…å†…å­˜æ—¶ï¼Œå…ˆå°†å†…å­˜æŒ‰å›ºå®šå¤§å°åˆ’åˆ†æˆ slabï¼Œç„¶åå†å°†ä¸åŒ slab åˆ†æ‹†å‡ºå›ºå®š size çš„ chunkã€‚è™½ç„¶ slab å†…çš„ chunk å¤§å°ç›¸åŒï¼Œä½†ä¸åŒ slab çš„ chunk size å¹¶ä¸åŒï¼ŒMc ä¼šæŒ‰ç…§ä¸€ä¸ªå›ºå®šæ¯”ä¾‹ï¼Œä½¿åˆ’åˆ†çš„ chunk size é€æ­¥å¢å¤§ï¼Œä»è€Œæ»¡è¶³ä¸åŒå¤§å° key/value å­˜å‚¨çš„éœ€è¦ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼Œä¸€ç»„å…·æœ‰ç›¸åŒ chunk size çš„æ‰€æœ‰ slabï¼Œå°±ç»„æˆä¸€ä¸ª slabclassã€‚ä¸åŒ slabclass çš„ chunk size æŒ‰é€’å¢å› å­ä¸€æ¬¡å¢åŠ ã€‚Mc å°±é€šè¿‡ slabclass æ¥ç®¡ç†ä¸€ç»„ slab å†…çš„å­˜å‚¨ç©ºé—´çš„ã€‚æ¯ä¸ª slabclass å†…éƒ¨æœ‰ä¸€ä¸ª freelist ï¼ŒåŒ…å«è¿™ç»„ slab é‡Œæ‰€æœ‰ç©ºé—²çš„ chunkï¼Œå½“éœ€è¦å­˜å‚¨æ•°æ®æ—¶ï¼Œä»è¿™ä¸ª freelist é‡Œé¢å¿«é€Ÿåˆ†é…ä¸€ä¸ª chunk åšå­˜å‚¨ç©ºé—´ã€‚å½“ Item æ•°æ®æ·˜æ±°å‰”é™¤æ—¶ï¼Œè¿™ä¸ª Item æ‰€åœ¨çš„ chunk åˆè¢«å›æ”¶è‡³è¿™ä¸ª freelistã€‚</p>
<p><img src="http://image.leonote.cn//20210207103148.jpg" alt=""></p>
<p>Mc åœ¨é€šè¿‡ slab æœºåˆ¶ç®¡ç†å†…å­˜åˆ†é…æ—¶ï¼Œå®é™… key/value æ˜¯å­˜åœ¨ Item ç»“æ„ä¸­ï¼Œæ‰€ä»¥å¯¹ key/value çš„å­˜å‚¨ç©ºé—´åˆ†é…å°±è½¬æ¢ä¸ºå¯¹ Item çš„åˆ†é…ã€‚è€Œ Item ç©ºé—´çš„åˆ†é…æœ‰ 2 ç§æ–¹å¼ï¼Œå¦‚æœ Mc æœ‰ç©ºé—²ç©ºé—´ï¼Œåˆ™ä» slabclass çš„ freelist åˆ†é…ï¼›å¦‚æœæ²¡æœ‰ç©ºé—²ç©ºé—´ï¼Œåˆ™ä»å¯¹åº” slabclass id å¯¹åº”çš„ LRU ä¸­å‰”é™¤ä¸€ä¸ª Itemï¼Œæ¥å¤ç”¨è¿™ä¸ª Item çš„ç©ºé—´ã€‚</p>
<p>åœ¨æŸ¥æ‰¾æˆ–å˜æ›´ä¸€ä¸ª key æ—¶ï¼Œé¦–å…ˆè¦å®šä½è¿™ä¸ª key æ‰€åœ¨çš„å­˜å‚¨ä½ç½®ã€‚Mc æ˜¯é€šè¿‡å“ˆå¸Œè¡¨ Hash table æ¥å®šä½ key çš„ã€‚Hash table å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå†…å­˜ç©ºé—´è¿ç»­çš„å¤§æ•°ç»„ï¼Œè€Œè¿™ä¸ªå¤§æ•°æ®çš„æ¯ä¸€ä¸ªæ§½ä½å¯¹åº”ä¸€ä¸ª key çš„ Hash å€¼ï¼Œè¿™ä¸ªæ§½ä½ä¹Ÿç§° bucketã€‚ç”±äºä¸åŒ key çš„ Hash å€¼å¯èƒ½ç›¸åŒï¼Œæ‰€ä»¥ Mc åœ¨ Hash table çš„æ¯ä¸ªæ…å†…éƒ¨å†ç”¨ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæ¥è§£å†³ Hash å†²çªçš„é—®é¢˜ã€‚</p>
<p>Mc å†…éƒ¨æ˜¯é€šè¿‡ LRU æ¥ç®¡ç†å­˜å‚¨ Item æ•°æ®çš„ï¼Œå½“å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šä» LRU é˜Ÿå°¾ä¸­å‰”é™¤ä¸€ä¸ªè¿‡æœŸæˆ–æœ€ä¸æ´»è·ƒçš„ keyï¼Œä¾›æ–°çš„ Item ä½¿ç”¨ã€‚</p>
<p><strong>ç‰¹æ€§</strong></p>
<ul>
<li><p>Mc æœ€å¤§çš„ç‰¹æ€§æ˜¯<strong>é«˜æ€§èƒ½</strong>ï¼Œå•èŠ‚ç‚¹å‹æµ‹æ€§èƒ½èƒ½è¾¾åˆ°ç™¾ä¸‡çº§çš„ QPSã€‚</p>
</li>
<li><p>å…¶æ¬¡å› ä¸º Mc çš„è®¿é—®åè®®å¾ˆç®€å•ï¼Œåªæœ‰ get/set/cas/touch/gat/stats ç­‰æœ‰é™çš„å‡ ä¸ªå‘½ä»¤ã€‚Mc çš„è®¿é—®åè®®ç®€å•ï¼Œè·Ÿå®ƒçš„å­˜å‚¨ç»“æ„ä¹Ÿæœ‰å…³ç³»ã€‚</p>
</li>
<li><p>Mc å­˜å‚¨ç»“æ„å¾ˆç®€å•ï¼Œåªå­˜å‚¨ç®€å•çš„ key/value é”®å€¼å¯¹ï¼Œè€Œä¸”å¯¹ value ç›´æ¥ä»¥äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨ï¼Œä¸è¯†åˆ«å†…éƒ¨å­˜å‚¨ç»“æ„ï¼Œæ‰€ä»¥æœ‰é™å‡ ä¸ªæŒ‡ä»¤å°±å¯ä»¥æ»¡è¶³æ“ä½œéœ€è¦ã€‚</p>
</li>
<li><p>Mc å®Œå…¨åŸºäºå†…å­˜æ“ä½œï¼Œåœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´ï¼Œåœ¨æœ‰æ–° key å†™è¿›æ¥æ—¶ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²å†…å­˜åˆ†é…ï¼Œå°±ä¼šå¯¹æœ€ä¸æ´»è·ƒçš„ key è¿›è¡Œ eviction å‰”é™¤æ“ä½œã€‚</p>
</li>
<li><p>æœ€åï¼ŒMc æœåŠ¡èŠ‚ç‚¹è¿è¡Œä¹Ÿç‰¹åˆ«ç®€å•ï¼Œä¸åŒ Mc èŠ‚ç‚¹ä¹‹é—´äº’ä¸é€šä¿¡ï¼Œç”± client è‡ªè¡Œè´Ÿè´£ç®¡ç†æ•°æ®åˆ†å¸ƒã€‚</p>
</li>
</ul>
<h2 id="Memcached-ç³»ç»Ÿæ¶æ„"><a href="#Memcached-ç³»ç»Ÿæ¶æ„" class="headerlink" title="Memcached ç³»ç»Ÿæ¶æ„"></a>Memcached ç³»ç»Ÿæ¶æ„</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMc çš„ç³»ç»Ÿæ¶æ„ä¸»è¦åŒ…æ‹¬<strong>ç½‘ç»œå¤„ç†æ¨¡å—</strong>ã€<strong>å¤šçº¿ç¨‹å¤„ç†æ¨¡å—</strong>ã€<strong>å“ˆå¸Œè¡¨</strong>ã€<strong>LRU</strong>ã€<strong>slab å†…å­˜åˆ†é…æ¨¡å—</strong> 5 éƒ¨åˆ†ã€‚Mc åŸºäº Libevent å®ç°äº†ç½‘ç»œå¤„ç†æ¨¡å—ï¼Œé€šè¿‡å¤šçº¿ç¨‹å¹¶å‘å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼›åŸºäºå“ˆå¸Œè¡¨å¯¹ key è¿›è¡Œå¿«é€Ÿå®šä½ï¼ŒåŸºäº LRU æ¥ç®¡ç†å†·æ•°æ®çš„å‰”é™¤æ·˜æ±°ï¼ŒåŸºäº slab æœºåˆ¶è¿›è¡Œå¿«é€Ÿçš„å†…å­˜åˆ†é…åŠå­˜å‚¨ã€‚</p>
<p><img src="http://image.leonote.cn//20210207104454.jpg" alt=""></p>
<h3 id="ç³»ç»Ÿæ¶æ„"><a href="#ç³»ç»Ÿæ¶æ„" class="headerlink" title="ç³»ç»Ÿæ¶æ„"></a>ç³»ç»Ÿæ¶æ„</h3><p>Mc åŸºäº Libevent å¼€å‘å®ç°äº†å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹ã€‚Mc çš„å¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹åˆ†ä¸ºä¸»çº¿ç¨‹ã€å·¥ä½œçº¿ç¨‹ã€‚è¿™äº›çº¿ç¨‹é€šè¿‡å¤šè·¯å¤ç”¨ IO æ¥è¿›è¡Œç½‘ç»œ IO æ¥å…¥ä»¥åŠè¯»å†™å¤„ç†ã€‚åœ¨ Linux ä¸‹ï¼Œé€šå¸¸ä½¿ç”¨ epollã€‚é€šè¿‡å¤šè·¯å¤ç”¨ IOï¼Œç‰¹åˆ«æ˜¯ epoll çš„ä½¿ç”¨ï¼ŒMc çº¿ç¨‹æ— é¡»éå†æ•´ä¸ªè¢«ä¾¦å¬çš„æè¿°ç¬¦é›†ï¼Œåªè¦åœ¨è¢«é€šçŸ¥åéå† Ready é˜Ÿåˆ—çš„æè¿°ç¬¦é›†åˆå°± OK äº†ã€‚è¿™äº›æè¿°ç¬¦æ˜¯åœ¨å„é¡¹å‡†å¤‡å·¥ä½œå®Œæˆä¹‹åï¼Œæ‰è¢«å†…æ ¸ IO äº‹ä»¶å¼‚æ­¥é€šçŸ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªåœ¨è¿æ¥åšå¥½å‡†å¤‡åï¼Œç³»ç»Ÿæ‰ä¼šè¿›è¡Œäº‹ä»¶é€šçŸ¥ï¼ŒMc æ‰ä¼šè¿›è¡Œ I/O æ“ä½œã€‚è¿™æ ·å°±ä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œä½¿ Mc åœ¨æ”¯æŒé«˜å¹¶å‘çš„åŒæ—¶ï¼Œæ‹¥æœ‰éå¸¸é«˜çš„ IO ååæ•ˆç‡ã€‚</p>
<p>Mc é™¤äº†ç”¨äº IO çš„ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹å¤–ï¼Œè¿˜ç”¨äºå¤šä¸ªè¾…åŠ©çº¿ç¨‹ï¼Œå¦‚ Item çˆ¬è™«çº¿ç¨‹ã€LRU ç»´æŠ¤çº¿ç¨‹ã€å“ˆå¸Œè¡¨ç»´æŠ¤çº¿ç¨‹ç­‰ï¼Œé€šè¿‡å¤šçº¿ç¨‹å¹¶å‘å·¥ä½œï¼ŒMc å¯ä»¥å……åˆ†åˆ©ç”¨æœºå™¨çš„å¤šä¸ªæ ¸å¿ƒï¼Œå®ç°å¾ˆå¥½çš„ç½‘ç»œ IO æ€§èƒ½å’Œæ•°æ®å¤„ç†èƒ½åŠ›ã€‚</p>
<p>Mc é€šè¿‡å“ˆå¸Œè¡¨å³ Hash table æ¥å¿«é€Ÿå®šä½ keyã€‚æ•°æ®å­˜å‚¨æ—¶ï¼Œæ•°æ® Item ç»“æ„åœ¨å­˜å…¥ slab ä¸­çš„ chunk åï¼Œä¹Ÿä¼šè¢«å­˜æ”¾åˆ° Hash table ä¸­ã€‚åŒæ—¶ï¼ŒMc çš„å“ˆå¸Œè¡¨ä¼šåœ¨æ¯ä¸ªæ¡¶ï¼Œé€šè¿‡ Item è®°å½•ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œä»¥æ­¤æ¥è§£å†³ä¸åŒ key åœ¨å“ˆå¸Œè¡¨ä¸­çš„ Hash å†²çªé—®é¢˜ã€‚ å½“éœ€è¦æŸ¥æ‰¾ç»™å®š key çš„ Item æ—¶ï¼Œé¦–å…ˆè®¡ç®— key çš„ Hash å€¼ï¼Œç„¶åå¯¹å“ˆå¸Œè¡¨ä¸­ä¸ Hash å€¼å¯¹åº”çš„ bucket ä¸­è¿›è¡Œæœç´¢ï¼Œé€šè¿‡è½®è¯¢ bucket é‡Œçš„å•å‘é“¾è¡¨ï¼Œæ‰¾åˆ°è¯¥ key å¯¹åº”çš„ Item æŒ‡é’ˆï¼Œè¿™æ ·å°±æ‰¾åˆ°äº† key å¯¹åº”çš„å­˜å‚¨ Itemï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210207104946.jpg" alt=""></p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒMc å¯¹å“ˆå¸Œè¡¨çš„æ’å…¥ã€æŸ¥æ‰¾æ“ä½œéƒ½æ˜¯åœ¨ä¸»è¡¨ä¸­è¿›è¡Œçš„ã€‚å½“è¡¨ä¸­ Item æ•°é‡å¤§äºå“ˆå¸Œè¡¨ bucket èŠ‚ç‚¹æ•°çš„ 1.5 å€æ—¶ï¼Œå°±å¯¹å“ˆå¸Œè¡¨è¿›è¡Œæ‰©å®¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ‰©å®¹æ—¶ï¼ŒMc å†…éƒ¨ä½¿ç”¨ä¸¤å¼  Hash tableï¼Œä¸€ä¸ªä¸»å“ˆå¸Œè¡¨ primary_hashtableï¼Œä¸€ä¸ªæ˜¯æ—§å“ˆå¸Œè¡¨ old_hashtableã€‚å½“æ‰©å®¹å¼€å§‹æ—¶ï¼ŒåŸæ¥çš„ä¸»å“ˆå¸Œè¡¨å°±æˆä¸ºæ—§å“ˆå¸Œè¡¨ï¼Œè€Œæ–°åˆ†é…ä¸€ä¸ª 2 å€å®¹é‡çš„å“ˆå¸Œè¡¨ä½œä¸ºæ–°çš„ä¸»è¡¨ã€‚æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œç»´æŠ¤çº¿ç¨‹ä¼šå°†æ—§è¡¨çš„ Item æŒ‡é’ˆï¼Œé€æ­¥å¤åˆ¶æ’å…¥åˆ°æ–°ä¸»å“ˆå¸Œè¡¨ã€‚è¿ç§»è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®è¿ç§»ä½ç½®ï¼Œç”¨æˆ·è¯·æ±‚ä¼šåŒæ—¶æŸ¥æ—§è¡¨å’Œæ–°çš„ä¸»è¡¨ï¼Œå½“æ•°æ®å…¨éƒ¨è¿ç§»å®Œæˆï¼Œæ‰€æœ‰çš„æ“ä½œå°±é‡æ–°å›åˆ°ä¸»è¡¨ä¸­è¿›è¡Œã€‚</p>
<p><img src="http://image.leonote.cn//20210207105104.jpg" alt=""></p>
<h4 id="LRU-æœºåˆ¶"><a href="#LRU-æœºåˆ¶" class="headerlink" title="LRU æœºåˆ¶"></a>LRU æœºåˆ¶</h4><p>Mc ä¸»è¦é€šè¿‡ LRU æœºåˆ¶ï¼Œæ¥è¿›è¡Œå†·æ•°æ®æ·˜æ±°çš„ã€‚è‡ª 1.4.24 ç‰ˆæœ¬ä¹‹åï¼ŒMc ä¸æ–­ä¼˜åŒ– LRU ç®—æ³•ï¼Œå½“å‰ Mc ç‰ˆæœ¬å·²é»˜è®¤å¯ç”¨<strong>åˆ†æ®µ LRU</strong> äº†ã€‚åœ¨å¯ç”¨åˆ†æ®µ LRU ä¹‹å‰ï¼Œæ¯ä¸ª slabclass id åªå¯¹åº”ä¸€ä¸ª COLD  LRUï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šç›´æ¥ä» COLD LRU å‰”é™¤æ•°æ®ã€‚è€Œåœ¨å¯ç”¨åˆ†æ®µ LRU ä¹‹åï¼Œæ¯ä¸ª slabclass id å°±æœ‰ <strong>TEMP</strong>ã€<strong>HOT</strong>ã€<strong>WARM</strong> å’Œ <strong>COLD</strong>  å››ä¸ª LRUã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<strong>TEMP LRU ä¸­ Item å‰©ä½™è¿‡æœŸæ—¶é—´é€šå¸¸å¾ˆçŸ­ï¼Œé»˜è®¤æ˜¯ 61 ç§’ä»¥å†…</strong>ã€‚è¯¥åˆ—é˜Ÿä¸­çš„ Item æ°¸è¿œä¸ä¼šå‘ç”Ÿåœ¨é˜Ÿåˆ—å†…æ¬è¿ï¼Œä¹Ÿä¸ä¼šè¿ç§»åˆ°å…¶ä»–é˜Ÿåˆ—ã€‚åœ¨æ’å…¥æ–° key/value æ—¶ï¼Œå¦‚æœ key çš„å‰©ä½™è¿‡æœŸæ—¶é—´å°äº 61 ç§’ï¼Œåˆ™ç›´æ¥è¿›å…¥ TEMP LRUã€‚åé¢ï¼Œåœ¨å¿…è¦æ—¶ç›´æ¥è¿›è¡Œè¿‡æœŸå³å¯ã€‚è¿™æ ·é¿å…äº†é”ç«äº‰ï¼Œæ€§èƒ½ä¹Ÿæ›´é«˜ã€‚</p>
<p><img src="http://image.leonote.cn//20210207105242.jpg" alt=""></p>
<p>å¯¹äº HOT LRUï¼Œå†…éƒ¨ä¸æ¬è¿ï¼Œå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœé˜Ÿå°¾ Item æ˜¯ Active çŠ¶æ€ï¼Œå³è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆä¼šè¿ç§»åˆ° WARM é˜Ÿåˆ—ï¼Œå¦åˆ™è¿ç§»åˆ° COLD é˜Ÿåˆ—ã€‚</p>
<p>å¯¹äº WARM LRUï¼Œå¦‚æœé˜Ÿåˆ—çš„ Item è¢«å†æ¬¡è®¿é—®ï¼Œå°±æ¬åˆ°é˜Ÿé¦–ï¼Œå¦åˆ™è¿ç§»åˆ° COLD é˜Ÿåˆ—ã€‚</p>
<p>å¯¹äº COLD LRUï¼Œå­˜æ”¾çš„æ˜¯æœ€ä¸æ´»è·ƒçš„ Itemï¼Œä¸€æ—¦å†…å­˜æ»¡äº†ï¼Œé˜Ÿå°¾çš„ Item ä¼šè¢«å‰”é™¤ã€‚å¦‚æœ COLD LRU é‡Œçš„ Item è¢«å†æ¬¡è®¿é—®ï¼Œä¼šè¿ç§»åˆ° WARM LRUã€‚</p>
<h4 id="slab-åˆ†é…æœºåˆ¶"><a href="#slab-åˆ†é…æœºåˆ¶" class="headerlink" title="slab åˆ†é…æœºåˆ¶"></a>slab åˆ†é…æœºåˆ¶</h4><p>ä¸€èˆ¬åº”ç”¨ç³»ç»Ÿçš„å†…å­˜åˆ†é…æ˜¯ç›´æ¥é‡‡ç”¨ malloc å’Œ free æ¥è¿›è¡Œåˆ†é…åŠå›æ”¶çš„ã€‚é•¿æ—¶é—´è¿è¡Œåï¼Œå†…å­˜ç¢ç‰‡è¶Šæ¥è¶Šå¤šï¼Œä¸¥é‡å¢åŠ ç³»ç»Ÿå†…å­˜ç®¡ç†å™¨çš„è´Ÿæ‹…ã€‚ç¢ç‰‡çš„ä¸æ–­äº§ç”Ÿï¼Œä¸ä»…å¯¼è‡´å¤§é‡çš„å†…å­˜æµªè´¹ï¼Œè€Œä¸”ç¢ç‰‡æ•´ç†è¶Šæ¥è¶Šå¤æ‚ï¼Œä¼šå¯¼è‡´å†…å­˜åˆ†é…è¶Šæ¥è¶Šæ…¢ï¼Œè¿›è€Œå¯¼è‡´ç³»ç»Ÿåˆ†é…é€Ÿåº¦å’Œå­˜å‚¨æ•ˆç‡è¶Šæ¥è¶Šå·®ã€‚Mc çš„ slab åˆ†é…æœºåˆ¶çš„å‡ºç°ï¼Œç¢ç‰‡é—®é¢˜è¿åˆƒè€Œè§£ã€‚ä¸‹é¢å…ˆæ¥ç®€å•äº†è§£ä¸€ä¸‹ Mc çš„ slab åˆ†é…æœºåˆ¶ã€‚</p>
<p>Mc é€šè¿‡ slab æœºåˆ¶æ¥åˆ†é…ç®¡ç†å†…å­˜çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å¯ä»¥è¯´ï¼Œslab åˆ†é…æœºåˆ¶çš„ä½¿ç”¨ï¼Œæ˜¯ Mc åˆ†é…åŠå­˜å‚¨é«˜æ€§èƒ½çš„å…³é”®æ‰€åœ¨ã€‚åœ¨ Mc å¯åŠ¨æ—¶ï¼Œä¼šåˆ›å»º <strong>64 ä¸ª slabclass</strong>ï¼Œä½†<strong>ç´¢å¼•ä¸º 0 çš„ slabclass åš slab é‡æ–°åˆ†é…ä¹‹ç”¨</strong>ï¼ŒåŸºæœ¬ä¸å‚ä¸å…¶ä»– slabclass çš„æ—¥å¸¸åˆ†é…æ´»åŠ¨ã€‚<strong>æ¯ä¸ª slabclass ä¼šæ ¹æ®éœ€è¦ä¸æ–­åˆ†é…é»˜è®¤å¤§å°ä¸º 1MB çš„ slab</strong>ã€‚</p>
<p>æ¯ä¸ª slab åˆè¢«åˆ†ä¸ºç›¸åŒå¤§å°çš„ chunkã€‚<strong>chunk å°±æ˜¯ Mc å­˜å‚¨æ•°æ®çš„åŸºæœ¬å­˜å‚¨å•ä½</strong>ã€‚<strong>slabclass 1 çš„ chunk size æœ€å°ï¼Œé»˜è®¤æœ€å° chunk çš„å¤§å°æ˜¯ 102 å­—èŠ‚</strong>ï¼Œåç»­çš„ slabclass ä¼šæŒ‰ç…§å¢é•¿å› å­é€æ­¥å¢å¤§ chunk sizeï¼Œå…·ä½“æ•°å€¼ä¼šè¿›ä¸€æ­¥å¯¹ 8 å–æ•´ã€‚<strong>Mc é»˜è®¤çš„å¢é•¿å› å­æ˜¯ 1.25</strong>ï¼Œå¯åŠ¨æ—¶å¯ä»¥é€šè¿‡ -f å°†å¢é•¿å› å­è®¾ä¸ºå…¶ä»–å€¼ã€‚æ¯”å¦‚é‡‡ç”¨é»˜è®¤å€¼ï¼Œslabclass 1 çš„ chunk size æ˜¯ 102ï¼Œslabclass 2 çš„ chunk size æ˜¯ 102Ã—1.25ï¼Œå†å¯¹ 8 å–æ•´åæ˜¯ 128ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// size = 127.5 = 102 * 1.25</span></span><br><span class="line"><span class="comment">// CHUNK_ALIGN_BYTES = 8</span></span><br><span class="line"><span class="keyword">if</span> (size % CHUNK_ALIGN_BYTES) &#123;</span><br><span class="line"> 	size += CHUNK_ALIGN_BYTES - (size % CHUNK_ALIGN_BYTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://image.leonote.cn//20210207105558.jpg" alt=""></p>
<p>Mc slab ä¸­çš„ chunk ä¸­é€šè¿‡ Item ç»“æ„å­˜ key/value é”®å€¼å¯¹ï¼ŒItem ç»“æ„ä½“çš„å¤´éƒ¨å­˜é“¾è¡¨çš„æŒ‡é’ˆã€flagã€è¿‡æœŸæ—¶é—´ç­‰ï¼Œç„¶åå­˜ key åŠ valueã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒItem å¹¶ä¸ä¼šå°† chunk å¡«æ»¡ï¼Œä½†ç”±äºæ¯ä¸ª key/value åœ¨å­˜å‚¨æ—¶ï¼Œéƒ½ä¼šæ ¹æ® kev/value sizeï¼Œé€‰æ‹©æœ€æ¥è¿‘çš„ slabclassï¼Œæ‰€ä»¥ chunk æµªè´¹çš„å­—èŠ‚éå¸¸æœ‰é™ï¼ŒåŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚</p>
<p>æ¯æ¬¡æ–°åˆ†é…ä¸€ä¸ª slab åï¼Œä¼šå°† slab ç©ºé—´ç­‰åˆ†æˆç›¸åŒ size çš„ chunkï¼Œè¿™äº› chunk ä¼šè¢«åŠ å…¥åˆ° slabclass çš„ freelist ä¸­ï¼Œåœ¨éœ€è¦æ—¶è¿›è¡Œåˆ†é…ã€‚åˆ†é…å‡ºå»çš„ chunk å­˜å‚¨ Item æ•°æ®ï¼Œåœ¨è¿‡æœŸè¢«å‰”é™¤åï¼Œä¼šå†æ¬¡è¿›å…¥ freelistï¼Œä¾›åç»­ä½¿ç”¨ã€‚</p>
<h4 id="ç½‘ç»œæ¨¡å‹"><a href="#ç½‘ç»œæ¨¡å‹" class="headerlink" title="ç½‘ç»œæ¨¡å‹"></a>ç½‘ç»œæ¨¡å‹</h4><p><strong>ä¸»çº¿ç¨‹</strong></p>
<p>Mc åŸºäº Libevent å®ç°å¤šçº¿ç¨‹ç½‘ç»œ IO æ¨¡å‹ã€‚Mc çš„ IO å¤„ç†çº¿ç¨‹åˆ†ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å„æœ‰ä¸€ä¸ª event_baseï¼Œæ¥ç›‘å¬ç½‘ç»œäº‹ä»¶ã€‚</p>
<ul>
<li>ä¸»çº¿ç¨‹è´Ÿè´£<strong>ç›‘å¬åŠå»ºç«‹è¿æ¥</strong>ã€‚</li>
<li>å·¥ä½œçº¿ç¨‹è´Ÿè´£å¯¹å»ºç«‹çš„è¿æ¥è¿›è¡Œ<strong>ç½‘ç»œ IO è¯»å–ã€å‘½ä»¤è§£æã€å¤„ç†åŠå“åº”</strong>ã€‚</li>
</ul>
<p>Mc ä¸»çº¿ç¨‹åœ¨ç›‘å¬ç«¯å£æ—¶ï¼Œå½“æœ‰è¿æ¥åˆ°æ¥ï¼Œä¸»çº¿ç¨‹ accept è¯¥è¿æ¥ï¼Œå¹¶å°†è¿æ¥è°ƒåº¦ç»™å·¥ä½œçº¿ç¨‹ã€‚è°ƒåº¦å¤„ç†é€»è¾‘ï¼Œä¸»çº¿ç¨‹å…ˆå°† fd å°è£…æˆä¸€ä¸ª CQ_ITEM ç»“æ„ï¼Œå¹¶å­˜å…¥æ–°è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œç„¶åè½®è¯¢ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå¹¶é€šè¿‡ç®¡é“å‘è¯¥å·¥ä½œçº¿ç¨‹å‘é€é€šçŸ¥ã€‚å·¥ä½œçº¿ç¨‹ç›‘å¬åˆ°é€šçŸ¥åï¼Œä¼šä»æ–°è¿æ¥é˜Ÿåˆ—è·å–ä¸€ä¸ªè¿æ¥ï¼Œç„¶åå¼€å§‹ä»è¿™ä¸ªè¿æ¥è¯»å–ç½‘ç»œ IO å¹¶å¤„ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ä¸»çº¿ç¨‹çš„è¿™ä¸ªå¤„ç†é€»è¾‘ä¸»è¦åœ¨çŠ¶æ€æœºä¸­æ‰§è¡Œï¼Œå¯¹åº”çš„è¿æ¥çŠ¶æ€ä¸º <code>conn_listening</code>ã€‚</p>
<p><img src="http://image.leonote.cn//20210207165431.jpg" alt=""></p>
<p><strong>å·¥ä½œçº¿ç¨‹</strong></p>
<p>å·¥ä½œçº¿ç¨‹ç›‘å¬åˆ°ä¸»çº¿ç¨‹çš„ç®¡é“é€šçŸ¥åï¼Œä¼šä»è¿æ¥é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªæ–°è¿æ¥ï¼Œç„¶åå°±ä¼šåˆ›å»ºä¸€ä¸ª conn ç»“æ„ä½“ï¼Œæ³¨å†Œè¯¥ conn è¯»äº‹ä»¶ï¼Œç„¶åç»§ç»­ç›‘å¬è¯¥è¿æ¥ä¸Šçš„ IO äº‹ä»¶ã€‚åç»­è¿™ä¸ªè¿æ¥æœ‰å‘½ä»¤è¿›æ¥æ—¶ï¼Œå·¥ä½œçº¿ç¨‹ä¼šè¯»å– client å‘æ¥çš„å‘½ä»¤ï¼Œè¿›è¡Œè§£æå¹¶å¤„ç†ï¼Œæœ€åè¿”å›å“åº”ã€‚å·¥ä½œçº¿ç¨‹çš„ä¸»è¦å¤„ç†é€»è¾‘ä¹Ÿæ˜¯åœ¨çŠ¶æ€æœºä¸­ï¼Œä¸€ä¸ªåå« <code>drive_machine</code> çš„å‡½æ•°ã€‚</p>
<p><strong>çŠ¶æ€æœº</strong></p>
<p>è¿™ä¸ªçŠ¶æ€æœºç”±ä¸»çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹å…±äº«ï¼Œå®é™…æ˜¯é‡‡ç”¨ switch-case æ¥å®ç°çš„ã€‚çŠ¶æ€æœºå‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œswitch è¿æ¥çš„ stateï¼Œç„¶åæ ¹æ®è¿æ¥çš„ä¸åŒçŠ¶æ€ï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘æ“ä½œï¼Œå¹¶è¿›è¡ŒçŠ¶æ€è½¬æ¢ã€‚</p>
<p><img src="http://image.leonote.cn//20210207170035.jpg" alt=""></p>
<p><strong>ä¸»çº¿ç¨‹çŠ¶æ€æœº</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»çº¿ç¨‹åœ¨çŠ¶æ€æœºä¸­åªå¤„ç† <code>conn_listening</code> çŠ¶æ€ï¼Œè´Ÿè´£ accept æ–°è¿æ¥å’Œè°ƒåº¦æ–°è¿æ¥ç»™å·¥ä½œçº¿ç¨‹ã€‚çŠ¶æ€æœºä¸­å…¶ä»–çŠ¶æ€å¤„ç†åŸºæœ¬éƒ½åœ¨å·¥ä½œçº¿ç¨‹ä¸­è¿›è¡Œã€‚ç”±äº Mc åŒæ—¶æ”¯æŒ TCPã€UDP åè®®ï¼Œè€Œäº’è”ç½‘ä¼ä¸šå¤§å¤šä½¿ç”¨ TCP åè®®ï¼Œå¹¶ä¸”é€šè¿‡æ–‡æœ¬åè®®ï¼Œæ¥è®¿é—® Mcï¼Œæ‰€ä»¥åé¢çŠ¶æ€æœºçš„ä»‹ç»ï¼Œå°†ä¸»è¦ç»“åˆ TCP æ–‡æœ¬åè®®æ¥è¿›è¡Œé‡ç‚¹åˆ†æã€‚</p>
<p><img src="http://image.leonote.cn//20210207170811.jpg" alt=""></p>
<p><strong>å·¥ä½œçº¿ç¨‹çŠ¶æ€æœº</strong></p>
<p>å·¥ä½œçº¿ç¨‹çš„çŠ¶æ€æœºå¤„ç†é€»è¾‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…æ‹¬åˆšå»ºç«‹ conn è¿æ¥ç»“æ„ä½“æ—¶è¿›è¡Œçš„ä¸€äº›é‡ç½®æ“ä½œï¼Œç„¶åæ³¨å†Œè¯»äº‹ä»¶ï¼Œåœ¨æœ‰æ•°æ®è¿›æ¥æ—¶ï¼Œè¯»å–ç½‘ç»œæ•°æ®ï¼Œå¹¶è¿›è¡Œè§£æå¹¶å¤„ç†ã€‚å¦‚æœæ˜¯è¯»å–æŒ‡ä»¤æˆ–ç»Ÿè®¡æŒ‡ä»¤ï¼Œè‡³æ­¤å°±åŸºæœ¬å¤„ç†å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°†å“åº”å†™å…¥è¿æ¥ç¼“å†²ã€‚å¦‚æœæ˜¯æ›´æ–°æŒ‡ä»¤ï¼Œåœ¨è¿›è¡Œåˆæ­¥å¤„ç†åï¼Œè¿˜ä¼šç»§ç»­è¯»å– value éƒ¨åˆ†ï¼Œå†è¿›è¡Œå­˜å‚¨æˆ–å˜æ›´ï¼Œå¾…å˜æ›´å®Œæ¯•åå°†å“åº”å†™å…¥è¿æ¥ç¼“å†²ã€‚æœ€åå†å°†å“åº”å†™ç»™ clientã€‚å“åº” client åï¼Œè¿æ¥ä¼šå†æ¬¡é‡ç½®è¿æ¥çŠ¶æ€ï¼Œç­‰å¾…è¿›å…¥ä¸‹ä¸€æ¬¡çš„å‘½ä»¤å¤„ç†å¾ªç¯ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸»è¦åŒ…å«äº† <code>conn_new_cmd</code>ã€<code>conn_waiting</code>ã€<code>conn_read</code>ã€<code>conn_parse_cmd</code>ã€<code>conn_nread</code>ã€<code>conn_write</code>ã€<code>conn_mwrite</code>ã€<code>conn_closing</code> è¿™ 8 ä¸ªçŠ¶æ€äº‹ä»¶ã€‚</p>
<h5 id="å·¥ä½œçº¿ç¨‹çŠ¶æ€äº‹ä»¶åŠé€»è¾‘å¤„ç†"><a href="#å·¥ä½œçº¿ç¨‹çŠ¶æ€äº‹ä»¶åŠé€»è¾‘å¤„ç†" class="headerlink" title="å·¥ä½œçº¿ç¨‹çŠ¶æ€äº‹ä»¶åŠé€»è¾‘å¤„ç†"></a>å·¥ä½œçº¿ç¨‹çŠ¶æ€äº‹ä»¶åŠé€»è¾‘å¤„ç†</h5><ul>
<li><p><code>conn_new_cmd</code></p>
<p>ä¸»çº¿ç¨‹é€šè¿‡è°ƒç”¨ dispatch_conn_newï¼ŒæŠŠæ–°è¿æ¥è°ƒåº¦ç»™å·¥ä½œçº¿ç¨‹åï¼Œworker çº¿ç¨‹åˆ›å»º conn å¯¹è±¡ï¼Œè¿™ä¸ªè¿æ¥åˆå§‹çŠ¶æ€å°±æ˜¯ <code>conn_new_cmd</code>ã€‚é™¤äº†é€šè¿‡æ–°å»ºè¿æ¥è¿›å…¥ <code>conn_new_cmd</code> çŠ¶æ€ä¹‹å¤–ï¼Œå¦‚æœè¿æ¥å‘½ä»¤å¤„ç†å®Œæ¯•ï¼Œå‡†å¤‡æ¥å—æ–°æŒ‡ä»¤æ—¶ï¼Œä¹Ÿä¼šå°†è¿æ¥çš„çŠ¶æ€è®¾ç½®ä¸º <code>conn_new_cmd</code> çŠ¶æ€ã€‚</p>
<p>è¿›å…¥ <code>conn_new_cmd</code> åï¼Œå·¥ä½œçº¿ç¨‹ä¼šè°ƒç”¨ reset_cmd_handler å‡½æ•°ï¼Œé‡ç½® conn çš„ cmd å’Œ substate å­—æ®µï¼Œå¹¶åœ¨å¿…è¦æ—¶å¯¹è¿æ¥ buf è¿›è¡Œæ”¶ç¼©ã€‚å› ä¸ºè¿æ¥åœ¨å¤„ç† client æ¥çš„å‘½ä»¤æ—¶ï¼Œå¯¹äºå†™æŒ‡ä»¤ï¼Œéœ€è¦åˆ†é…è¾ƒå¤§çš„è¯» buf æ¥å­˜å¾…æ›´æ–°çš„ key valueï¼Œè€Œå¯¹äºè¯»æŒ‡ä»¤ï¼Œåˆ™éœ€è¦åˆ†é…è¾ƒå¤§çš„å†™ buf æ¥ç¼“å†²å¾…å‘é€ç»™ client çš„ value ç»“æœã€‚æŒç»­è¿è¡Œä¸­ï¼Œéšç€å¤§ size value çš„ç›¸å…³æ“ä½œï¼Œè¿™äº›ç¼“å†²ä¼šå ç”¨å¾ˆå¤šå†…å­˜ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®ä¸€ä¸ªé˜€å€¼ï¼Œè¶…è¿‡é˜€å€¼åå°±è¿›è¡Œç¼“å†²å†…å­˜æ”¶ç¼©ï¼Œé¿å…è¿æ¥å ç”¨å¤ªå¤šå†…å­˜ã€‚åœ¨åç«¯æœåŠ¡ä»¥åŠä¸­é—´ä»¶å¼€å‘ä¸­ï¼Œè¿™ä¸ªæ“ä½œå¾ˆé‡è¦ï¼Œå› ä¸ºçº¿ä¸ŠæœåŠ¡çš„è¿æ¥å¾ˆå®¹æ˜“è¾¾åˆ°ä¸‡çº§åˆ«ï¼Œå¦‚æœä¸€ä¸ªè¿æ¥å ç”¨å‡ å KB ä»¥ä¸Šçš„å†…å­˜ï¼Œåç«¯ç³»ç»Ÿä»…è¿æ¥å°±ä¼šå ç”¨æ•°ç™¾ MB ç”šè‡³æ•° GB ä»¥ä¸Šçš„å†…å­˜ç©ºé—´ã€‚</p>
<p>å·¥ä½œçº¿ç¨‹å¤„ç†å®Œ <code>conn_new_cmd</code> çŠ¶æ€çš„ä¸»è¦é€»è¾‘åï¼Œå¦‚æœè¯»ç¼“å†²åŒºæœ‰æ•°æ®å¯ä»¥è¯»å–ï¼Œåˆ™è¿›å…¥ <code>conn_parse_cmd</code> çŠ¶æ€ï¼Œå¦åˆ™å°±ä¼šè¿›å…¥åˆ° <code>conn_waiting</code> çŠ¶æ€ï¼Œç­‰å¾…ç½‘ç»œæ•°æ®è¿›æ¥ã€‚</p>
</li>
<li><p><code>conn_waiting</code></p>
<p>è¿æ¥è¿›å…¥ <code>conn_waiting</code> çŠ¶æ€åï¼Œå¤„ç†é€»è¾‘å¾ˆç®€å•ï¼Œç›´æ¥é€šè¿‡ update_event å‡½æ•°æ³¨å†Œè¯»äº‹ä»¶å³å¯ï¼Œä¹‹åä¼šå°†è¿æ¥çŠ¶æ€æ›´æ–°ä¸º <code>conn_read</code>ã€‚</p>
</li>
<li><p><code>conn_read</code></p>
<p>å½“å·¥ä½œçº¿ç¨‹ç›‘å¬åˆ°ç½‘ç»œæ•°æ®è¿›æ¥ï¼Œè¿æ¥å°±è¿›å…¥ <code>conn_read</code> çŠ¶æ€ã€‚å¯¹ <code>conn_read</code> çš„å¤„ç†ï¼Œæ˜¯é€šè¿‡ try_read_network ä» socket ä¸­è¯»å–ç½‘ç»œæ•°æ®ã€‚å¦‚æœè¯»å–å¤±è´¥ï¼Œåˆ™è¿›å…¥ <code>conn_closing</code> çŠ¶æ€ï¼Œå…³é—­è¿æ¥ã€‚å¦‚æœæ²¡æœ‰è¯»å–åˆ°ä»»ä½•æ•°æ®ï¼Œåˆ™ä¼šè¿”å› <code>conn_waiting</code>ï¼Œç»§ç»­ç­‰å¾… client ç«¯çš„æ•°æ®åˆ°æ¥ã€‚å¦‚æœè¯»å–æ•°æ®æˆåŠŸï¼Œåˆ™ä¼šå°†è¯»å–çš„æ•°æ®å­˜å…¥ conn çš„ rbuf ç¼“å†²ï¼Œå¹¶è¿›å…¥ <code>conn_parse_cmd</code> çŠ¶æ€ï¼Œå‡†å¤‡è§£æ cmdã€‚</p>
</li>
<li><p><code>conn_parse_cmd</code></p>
<p><code>conn_parse_cmd</code> çŠ¶æ€çš„å¤„ç†é€»è¾‘å°±æ˜¯è§£æå‘½ä»¤ã€‚å·¥ä½œçº¿ç¨‹é¦–å…ˆé€šè¿‡ try_read_command è¯»å–è¿æ¥çš„è¯»ç¼“å†²ï¼Œå¹¶é€šè¿‡ \n æ¥åˆ†éš”æ•°æ®æŠ¥æ–‡çš„å‘½ä»¤ã€‚å¦‚æœå‘½ä»¤é¦–è¡Œé•¿åº¦å¤§äº 1024ï¼Œå…³é—­è¿æ¥ï¼Œè¿™å°±æ„å‘³ç€ key é•¿åº¦åŠ ä¸Šå…¶ä»–å„é¡¹å‘½ä»¤å­—æ®µçš„æ€»é•¿åº¦è¦å°äº 1024å­—èŠ‚ã€‚å½“ç„¶å¯¹äº keyï¼ŒMc æœ‰ä¸ªé»˜è®¤çš„æœ€å¤§é•¿åº¦ï¼Œkey_max_lengthï¼Œé»˜è®¤è®¾ç½®ä¸º 250å­—èŠ‚ã€‚æ ¡éªŒå®Œæ¯•é¦–è¡ŒæŠ¥æ–‡çš„é•¿åº¦ï¼Œæ¥ä¸‹æ¥ä¼šåœ¨ process_command å‡½æ•°ä¸­å¯¹é¦–è¡ŒæŒ‡ä»¤è¿›è¡Œå¤„ç†ã€‚</p>
<p>process_command ç”¨æ¥å¤„ç† Mc çš„æ‰€æœ‰åè®®æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ã€‚process_command ä¼šé¦–å…ˆæŒ‰ç…§ç©ºæ ¼åˆ†æ‹†æŠ¥æ–‡ï¼Œç¡®å®šå‘½ä»¤åè®®ç±»å‹ï¼Œåˆ†æ´¾ç»™ process_XX_command å‡½æ•°å¤„ç†ã€‚</p>
<p>Mc çš„å‘½ä»¤åè®®ä»ç›´è§‚é€»è¾‘ä¸Šå¯ä»¥åˆ†ä¸ºè·å–ç±»å‹ã€å˜æ›´ç±»å‹ã€å…¶ä»–ç±»å‹ã€‚ä½†ä»å®é™…å¤„ç†å±‚é¢åŒºåˆ†ï¼Œåˆ™å¯ä»¥ç»†åˆ†ä¸º get ç±»å‹ã€update ç±»å‹ã€delete ç±»å‹ã€ç®—æœ¯ç±»å‹ã€touch ç±»å‹ã€stats ç±»å‹ï¼Œä»¥åŠå…¶ä»–ç±»å‹ã€‚å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸ºï¼Œprocess_get_command, process_update_command, process_arithmetic_command, process_touch_commandç­‰ã€‚æ¯ä¸ªå¤„ç†å‡½æ•°èƒ½å¤Ÿå¤„ç†ä¸åŒçš„åè®®ï¼Œå…·ä½“å‚è§ä¸‹å›¾æ‰€ç¤ºæ€ç»´å¯¼å›¾ã€‚</p>
<p><img src="http://image.leonote.cn//20210207171745.jpg" alt=""></p>
</li>
</ul>
<blockquote>
<p>æ³¨æ„:</p>
<p><code>conn_parse_cmd</code> çš„çŠ¶æ€å¤„ç†ï¼Œåªæœ‰è¯»å–åˆ° \nï¼Œæœ‰äº†å®Œæ•´çš„å‘½ä»¤é¦–è¡Œåè®®ï¼Œæ‰ä¼šè¿›å…¥ process_commandï¼Œå¦åˆ™ä¼šè·³è½¬åˆ° <code>conn_waiting</code>ï¼Œç»§ç»­ç­‰å¾…å®¢æˆ·ç«¯çš„å‘½ä»¤æ•°æ®æŠ¥æ–‡ã€‚åœ¨ process_command å¤„ç†ä¸­ï¼Œå¦‚æœæ˜¯è·å–ç±»å‘½ä»¤ï¼Œåœ¨è·å–åˆ° key å¯¹åº”çš„ value åï¼Œåˆ™è·³è½¬åˆ° <code>conn_mwrite</code>ï¼Œå‡†å¤‡å†™å“åº”ç»™è¿æ¥ç¼“å†²ã€‚è€Œå¯¹äº update å˜æ›´ç±»å‹çš„æŒ‡ä»¤ï¼Œåˆ™éœ€è¦ç»§ç»­è¯»å– value æ•°æ®ï¼Œæ­¤æ—¶è¿æ¥ä¼šè·³è½¬åˆ° <code>conn_nread</code> çŠ¶æ€ã€‚åœ¨ <code>conn_parse_cmd</code> å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°ä»»ä½•å¤±è´¥ï¼Œéƒ½ä¼šè·³è½¬åˆ° <code>conn_closing</code> å…³é—­è¿æ¥ã€‚</p>
</blockquote>
<ul>
<li><p><code>complete_nread</code></p>
<p>å¯¹äº update ç±»å‹çš„åè®®æŒ‡ä»¤ï¼Œä» conn ç»§ç»­è¯»å– value æ•°æ®ã€‚è¯»å–åˆ° value æ•°æ®åï¼Œä¼šè°ƒç”¨ <code>complete_nread</code>ï¼Œè¿›è¡Œæ•°æ®å­˜å‚¨å¤„ç†ï¼›æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå‘ conn çš„ wbuf å†™å“åº”ç»“æœã€‚ç„¶å update ç±»å‹å¤„ç†çš„è¿æ¥è¿›å…¥åˆ° <code>conn_write</code> çŠ¶æ€ã€‚</p>
</li>
<li><p><code>conn_write</code></p>
<p>è¿æ¥ <code>conn_write</code> çŠ¶æ€å¤„ç†é€»è¾‘å¾ˆç®€å•ï¼Œç›´æ¥è¿›å…¥ <code>conn_mwrite</code> çŠ¶æ€ã€‚æˆ–è€…å½“ conn çš„ iovused ä¸º 0 æˆ–å¯¹äº udp åè®®ï¼Œå°†å“åº”å†™å…¥ conn æ¶ˆæ¯ç¼“å†²åï¼Œå†è¿›å…¥ <code>conn_mwrite</code> çŠ¶æ€ã€‚</p>
</li>
<li><p><code>conn_mwrite</code><br>è¿›å…¥ <code>conn_mwrite</code> çŠ¶æ€åï¼Œå·¥ä½œçº¿ç¨‹å°†é€šè¿‡ transmit æ¥å‘å®¢æˆ·ç«¯å†™æ•°æ®ã€‚å¦‚æœå†™æ•°æ®å¤±è´¥ï¼Œè·³è½¬åˆ° <code>conn_closing</code>ï¼Œå…³é—­è¿æ¥é€€å‡ºçŠ¶æ€æœºã€‚å¦‚æœå†™æ•°æ®æˆåŠŸï¼Œåˆ™è·³è½¬åˆ° <code>conn_new_cmd</code>ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡æ–°æŒ‡ä»¤çš„è·å–ã€‚</p>
</li>
<li><p><code>conn_closing</code><br>æœ€åä¸€ä¸ª <code>conn_closing</code> çŠ¶æ€ï¼Œå‰é¢æåˆ°è¿‡å¾ˆå¤šæ¬¡ï¼Œåœ¨ä»»ä½•çŠ¶æ€çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œå°±ä¼šè¿›å…¥åˆ°è¿™ä¸ªçŠ¶æ€ï¼Œå…³é—­è¿æ¥ï¼Œè¿™ä¸ªè¿æ¥ä¹Ÿå°± Game Overäº†ã€‚</p>
</li>
</ul>
<h5 id="Mc-å‘½ä»¤å¤„ç†å…¨æµç¨‹"><a href="#Mc-å‘½ä»¤å¤„ç†å…¨æµç¨‹" class="headerlink" title="Mc å‘½ä»¤å¤„ç†å…¨æµç¨‹"></a>Mc å‘½ä»¤å¤„ç†å…¨æµç¨‹</h5><p><img src="http://image.leonote.cn//20210207172216.jpg" alt=""></p>
<ul>
<li><p>Mc å¯åŠ¨åï¼Œä¸»çº¿ç¨‹ç›‘å¬å¹¶å‡†å¤‡æ¥å—æ–°è¿æ¥æ¥å…¥ã€‚å½“æœ‰æ–°è¿æ¥æ¥å…¥æ—¶ï¼Œä¸»çº¿ç¨‹è¿›å…¥ <code>conn_listening</code> çŠ¶æ€ï¼Œaccept æ–°è¿æ¥ï¼Œå¹¶å°†æ–°è¿æ¥è°ƒåº¦ç»™å·¥ä½œçº¿ç¨‹ã€‚</p>
</li>
<li><p>Worker çº¿ç¨‹ç›‘å¬ç®¡é“ï¼Œå½“æ”¶åˆ°ä¸»çº¿ç¨‹é€šè¿‡ç®¡é“å‘é€çš„æ¶ˆæ¯åï¼Œå·¥ä½œçº¿ç¨‹ä¸­çš„è¿æ¥è¿›å…¥ <code>conn_new_cmd</code> çŠ¶æ€ï¼Œåˆ›å»º conn ç»“æ„ä½“ï¼Œå¹¶åšä¸€äº›åˆå§‹åŒ–é‡ç½®æ“ä½œï¼Œç„¶åè¿›å…¥ <code>conn_waiting</code> çŠ¶æ€ï¼Œæ³¨å†Œè¯»äº‹ä»¶ï¼Œå¹¶ç­‰å¾…ç½‘ç»œ IOã€‚</p>
</li>
<li><p>æœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œè¿æ¥è¿›å…¥ <code>conn_read</code> çŠ¶æ€ï¼Œè¯»å–ç½‘ç»œæ•°æ®ã€‚</p>
</li>
<li><p>è¯»å–æˆåŠŸåï¼Œå°±è¿›å…¥ <code>conn_parse_cmd</code> çŠ¶æ€ï¼Œç„¶åæ ¹æ® Mc åè®®è§£ææŒ‡ä»¤ã€‚</p>
</li>
<li><p>å¯¹äºè¯»å–æŒ‡ä»¤ï¼Œè·å–åˆ° value ç»“æœåï¼Œè¿›å…¥ <code>conn_mwrite</code> çŠ¶æ€ã€‚</p>
</li>
<li><p>å¯¹äºå˜æ›´æŒ‡ä»¤ï¼Œåˆ™è¿›å…¥ <code>conn_nread</code>ï¼Œè¿›è¡Œ value çš„è¯»å–ï¼Œè¯»å–åˆ° value åï¼Œå¯¹ key è¿›è¡Œå˜æ›´ï¼Œå½“å˜æ›´å®Œæ¯•åï¼Œè¿›å…¥ <code>conn_write</code>ï¼Œç„¶åå°†ç»“æœå†™å…¥ç¼“å†²ã€‚ç„¶åå’Œè¯»å–æŒ‡ä»¤ä¸€æ ·ï¼Œä¹Ÿè¿›å…¥ <code>conn_mwrite</code> çŠ¶æ€ã€‚</p>
</li>
<li><p>è¿›å…¥åˆ° <code>conn_mwrite</code> çŠ¶æ€åï¼Œå°†ç»“æœå“åº”å‘é€ç»™ clientã€‚å‘é€å“åº”å®Œæ¯•åï¼Œå†æ¬¡è¿›å…¥åˆ° <code>conn_new_cmd</code> çŠ¶æ€ï¼Œè¿›è¡Œè¿æ¥é‡ç½®ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡å‘½ä»¤å¤„ç†å¾ªç¯ã€‚</p>
</li>
<li><p>åœ¨è¯»å–ã€è§£æã€å¤„ç†ã€å“åº”è¿‡ç¨‹ï¼Œé‡åˆ°ä»»ä½•å¼‚å¸¸å°±è¿›å…¥ <code>conn_closing</code>ï¼Œå…³é—­è¿æ¥ã€‚</p>
</li>
</ul>
<p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæä¾›æ€ç»´å¯¼å›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210207172334.jpg" alt=""></p>
<p>â€‹       </p>
]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼ç¼“å­˜-Memcachedè¿›é˜¶</title>
    <url>/2021/02/08/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-Memcached%E8%BF%9B%E9%98%B6/</url>
    <content><![CDATA[<h1 id="Memcachedè¿›é˜¶"><a href="#Memcachedè¿›é˜¶" class="headerlink" title="Memcachedè¿›é˜¶"></a>Memcachedè¿›é˜¶</h1><h2 id="Memcached-æ˜¯æ€ä¹ˆå®šä½keyçš„"><a href="#Memcached-æ˜¯æ€ä¹ˆå®šä½keyçš„" class="headerlink" title="Memcached æ˜¯æ€ä¹ˆå®šä½keyçš„"></a>Memcached æ˜¯æ€ä¹ˆå®šä½keyçš„</h2><h3 id="key-å®šä½"><a href="#key-å®šä½" class="headerlink" title="key å®šä½"></a>key å®šä½</h3><p><strong>å“ˆå¸Œè¡¨</strong></p>
<p>Mc å°†æ•°æ®å­˜å‚¨åœ¨ Item ä¸­ï¼Œç„¶åè¿™äº› Item ä¼šè¢« slabclass çš„ 4 ä¸ª LRU ç®¡ç†ã€‚è¿™äº› LRU éƒ½æ˜¯é€šè¿‡åŒå‘é“¾è¡¨å®ç°æ•°æ®è®°å½•çš„ã€‚åŒå‘é“¾è¡¨åœ¨è¿›è¡Œå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ä½ç½®æ—¶éƒ½éå¸¸é«˜æ•ˆï¼Œä½†å…¶è·å–å®šä½ key çš„æ€§èƒ½éå¸¸ä½ä¸‹ï¼Œåªèƒ½é€šè¿‡é“¾è¡¨éå†æ¥å®ç°ã€‚å› æ­¤ï¼ŒMc è¿˜é€šè¿‡ Hashtableï¼Œä¹Ÿå°±æ˜¯å“ˆå¸Œè¡¨ï¼Œæ¥è®°å½•ç®¡ç†è¿™äº› Itemï¼Œé€šè¿‡å¯¹ key è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œä»è€Œå¿«é€Ÿå®šä½å’Œè¯»å–è¿™äº› key/value æ‰€åœ¨çš„ Itemï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210220163845.jpg" alt=""></p>
<p>å“ˆå¸Œè¡¨ä¹Ÿç§°æ•£åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡æŠŠ key æ˜ å°„åˆ°å“ˆå¸Œè¡¨ä¸­çš„ä¸€ä¸ªä½ç½®æ¥å¿«é€Ÿè®¿é—®è®°å½•ï¼Œå®šä½ key çš„æ—¶é—´å¤æ‚åº¦åªæœ‰ O(1)ã€‚Mc çš„å“ˆå¸Œè¡¨å®é™…æ˜¯ä¸€ä¸ªä¸€ç»´æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªä½ç½®ç§°ä½œä¸€ä¸ª bucketï¼Œå³ä¸€ä¸ªæ¡¶ã€‚æ€§èƒ½è€ƒè™‘çš„éœ€è¦ï¼ŒMc çš„å“ˆå¸Œè¡¨çš„é•¿åº¦è®¾ç½®ä¸º 2 çš„ N æ¬¡æ–¹ã€‚Mc å¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šæ„å»ºä¸€ä¸ªæ‹¥æœ‰ 6.4ä¸‡ ä¸ªæ¡¶çš„å“ˆå¸Œè¡¨ï¼Œéšç€æ–° key çš„ä¸æ–­æ’å…¥ï¼Œå“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ è¶…è¿‡é˜€å€¼åï¼Œä¼šå¯¹å“ˆå¸Œè¡¨è¿›è¡Œæ‰©å®¹ï¼Œæœ€å¤§å¯ä»¥æ„å»º 2 çš„ 32 æ¬¡æ–¹ä¸ªæ¡¶çš„å“ˆå¸Œè¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´ Mc å“ˆå¸Œè¡¨ç»è¿‡å¤šæ¬¡æ‰©å®¹åï¼Œæœ€å¤šåªèƒ½æœ‰ä¸è¶…è¿‡ 43äº¿ ä¸ªæ¡¶ã€‚</p>
<p><strong>å“ˆå¸Œè¡¨è®¾è®¡</strong></p>
<p>å¯¹äºå“ˆå¸Œè¡¨è®¾è®¡ï¼Œæœ‰ 2 ä¸ªå…³é”®ç‚¹ï¼Œä¸€ä¸ªæ˜¯å“ˆå¸Œç®—æ³•ï¼Œä¸€ä¸ªæ˜¯å“ˆå¸Œå†²çªè§£å†³æ–¹æ¡ˆã€‚Mc ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•æœ‰ 2 ç§ï¼Œåˆ†åˆ«æ˜¯ Murmur3 Hash å’Œ Jenkins Hashã€‚Mc å½“å‰ç‰ˆæœ¬ï¼Œé»˜è®¤ä½¿ç”¨ Murmur3 Hash ç®—æ³•ã€‚ä¸åŒçš„ key é€šè¿‡ Hash è®¡ç®—ï¼Œè¢«å®šä½åˆ°äº†ç›¸åŒçš„æ¡¶ï¼Œè¿™å°±æ˜¯å“ˆå¸Œå†²çªã€‚Mc æ˜¯é€šè¿‡å¯¹æ¯ä¸ªæ¡¶å¯ç”¨ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œæ¥è§£å†³å“ˆå¸Œå†²çªé—®é¢˜çš„ã€‚</p>
<p><strong>å®šä½ key</strong></p>
<p>Memcached å®šä½ key æ—¶ï¼Œé¦–å…ˆæ ¹æ® key é‡‡ç”¨ Murmur3 æˆ–è€… Jenkins ç®—æ³•è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ª 32 ä½çš„æ— ç¬¦å·æ•´å‹è¾“å‡ºï¼Œå­˜å‚¨åˆ°å˜é‡ hv ä¸­ã€‚å› ä¸ºå“ˆå¸Œè¡¨ä¸€èˆ¬æ²¡æœ‰ 2^32 é‚£ä¹ˆå¤§ï¼Œæ‰€ä»¥éœ€è¦å°† key çš„å“ˆå¸Œå€¼æ˜ å°„åˆ°å“ˆå¸Œè¡¨çš„èŒƒå›´å†…ã€‚Mc é‡‡ç”¨æœ€ç®€å•çš„å–æ¨¡ç®—æ³•ä½œä¸ºæ˜ å°„å‡½æ•°ï¼Œå³é‡‡ç”¨ hv%hashsize è¿›è¡Œè®¡ç®—ã€‚ç”±äºæ™®é€šçš„å–æ¨¡è¿ç®—æ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥ Mc å°†å“ˆå¸Œè¡¨çš„é•¿åº¦è®¾ç½®ä¸º 2 çš„ n æ¬¡æ–¹ï¼Œé‡‡ç”¨ä½è¿ç®—è¿›è¡Œä¼˜åŒ–ï¼Œå³é‡‡ç”¨ hv&amp;hashmask æ¥è®¡ç®—ã€‚hashmask å³ 2 çš„ n æ¬¡æ–¹ å‡ 1ã€‚</p>
<p>å®šä½åˆ° key æ‰€åœ¨çš„æ¡¶çš„ä½ç½®åï¼Œå¦‚æœæ˜¯æ’å…¥ä¸€ä¸ªæ–°æ•°æ®ï¼Œåˆ™å°†æ•°æ® Item é‡‡ç”¨å¤´éƒ¨æ’å…¥æ³•æ’å…¥æ¡¶çš„å•å‘é“¾è¡¨ä¸­ã€‚å¦‚æœæ˜¯æŸ¥æ‰¾ï¼Œåˆ™è½®è¯¢å¯¹åº”å“ˆå¸Œæ¡¶ä¸­çš„é‚£ä¸ªå•å‘é“¾è¡¨ï¼Œä¾æ¬¡æ¯”å¯¹ key å­—ç¬¦ä¸²ï¼Œkey ç›¸åŒåˆ™æ‰¾åˆ°æ•°æ® Itemã€‚</p>
<p><img src="http://image.leonote.cn//20210220164215.jpg" alt=""></p>
<p>å¦‚æœå“ˆå¸Œè¡¨æ¡¶ä¸­å…ƒç´ å¤ªå¤šï¼Œè¿™ä¸ªé“¾è¡¨è½®è¯¢è€—æ—¶ä¼šæ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥åœ¨å“ˆå¸Œè¡¨ä¸­å…ƒç´ è¾¾åˆ°æ¡¶æ•°çš„ 1.5 å€ä¹‹åï¼ŒMc ä¼šå¯¹å“ˆå¸Œè¡¨è¿›è¡Œ 2 å€æ‰©å®¹ã€‚ç”±äºå“ˆå¸Œè¡¨æœ€å¤šåªæœ‰ 43 äº¿å·¦å³ä¸ªæ¡¶ï¼Œæ‰€ä»¥æ€§èƒ½è€ƒè™‘ï¼Œå•ä¸ª Mc èŠ‚ç‚¹æœ€å¤šå­˜å‚¨ 65äº¿ ä¸ª key/valueã€‚å¦‚æœè¦å­˜æ›´å¤š keyï¼Œåˆ™éœ€è¦ä¿®æ”¹ Mc æºç ï¼Œå°†æœ€å¤§å“ˆå¸Œï¼Œå³ HASHPOWER_MAXï¼Œ è¿›è¡Œè°ƒå¤§è®¾ç½®ã€‚</p>
<p><strong>å“ˆå¸Œè¡¨æ‰©å®¹</strong></p>
<p>å½“ Mc çš„å“ˆå¸Œè¡¨ä¸­ï¼ŒItem æ•°é‡å¤§äº 1.5 å€çš„å“ˆå¸Œæ¡¶æ•°é‡åï¼ŒMc å°±å¯¹å“ˆå¸Œè¡¨è¿›è¡Œæ‰©å®¹å¤„ç†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMc çš„å“ˆå¸Œæ‰©å®¹æ˜¯é€šè¿‡å“ˆå¸Œç»´æŠ¤çº¿ç¨‹è¿›è¡Œå¤„ç†çš„ã€‚å‡†å¤‡å¼€å§‹æ‰©å®¹æ—¶ï¼Œå“ˆå¸Œç»´æŠ¤çº¿ç¨‹ä¼šé¦–å…ˆå°†æ‰€æœ‰ IO å·¥ä½œçº¿ç¨‹å’Œè¾…åŠ©çº¿ç¨‹è¿›è¡Œæš‚åœï¼Œå…¶ä¸­è¾…åŠ©çº¿ç¨‹åŒ…æ‹¬ LRU ç»´æŠ¤çº¿ç¨‹ã€slab ç»´æŠ¤çº¿ç¨‹ã€LRU çˆ¬è™«çº¿ç¨‹ã€‚å¾…è¿™äº›çº¿ç¨‹æš‚åœåï¼Œå“ˆå¸Œç»´æŠ¤çº¿ç¨‹ä¼šå°†å½“å‰çš„ä¸»å“ˆå¸Œè¡¨è®¾ä¸ºæ—§å“ˆå¸Œè¡¨ï¼Œç„¶åå°†æ–°çš„ä¸»å“ˆå¸Œè¡¨æ‰©å®¹ä¹‹å‰çš„ 2 å€å®¹é‡ã€‚ç„¶åï¼Œå·¥ä½œçº¿ç¨‹åŠè¾…åŠ©çº¿ç¨‹ç»§ç»­å·¥ä½œï¼ŒåŒæ—¶å“ˆå¸Œç»´æŠ¤çº¿ç¨‹å¼€å§‹é€æ­¥å°† Item å…ƒç´ ä»æ—§å“ˆå¸Œè¡¨è¿ç§»åˆ°ä¸»å“ˆå¸Œè¡¨ã€‚</p>
<p><img src="http://image.leonote.cn//20210220171554.jpg" alt=""></p>
<p>Mc åœ¨å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ®è®¾ç½®çš„å·¥ä½œçº¿ç¨‹æ•°ï¼Œæ¥æ„å»º ä¸€ä¸ª Item é”å“ˆå¸Œè¡¨ï¼Œçº¿ç¨‹è¶Šå¤šï¼Œæ„å»ºçš„é”å“ˆå¸Œè¡¨è¶Šå¤§ï¼Œå¯¹äº 4 ä¸ªçº¿ç¨‹ï¼Œé”å“ˆå¸Œè¡¨æœ‰ 4096 ä¸ªæ¡¶ï¼Œå¯¹äº 10 ä¸ªçº¿ç¨‹ï¼Œé”å“ˆå¸Œè¡¨ä¼šæœ‰ 8192 ä¸ªæ¡¶ï¼ŒItem é”å“ˆå¸Œè¡¨æœ€å¤šæœ‰ 32k ä¸ªæ¡¶ï¼Œ1k æ˜¯ 1024ï¼Œå³æœ€å¤šå³ 32768 ä¸ªæ¡¶ã€‚Mc çš„é”å“ˆå¸Œè¡¨ä¸­ï¼Œæ¯ä¸ªæ¡¶å¯¹åº”ä¸€ä¸ª Item é”ï¼Œæ‰€ä»¥ Mc æœ€å¤šåªæœ‰ 32768 ä¸ª Item é”ã€‚</p>
<p>Mc å“ˆå¸Œè¡¨åœ¨è¯»å–ã€å˜æ›´ä»¥åŠæ‰©å®¹è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå…ˆå°† key hash å®šä½åˆ° Item é”å“ˆå¸Œè¡¨çš„é”æ¡¶ï¼Œç„¶åå¯¹ Item é”è¿›è¡ŒåŠ é”ï¼Œç„¶åå†è¿›è¡Œå®é™…æ“ä½œã€‚å®é™…ä¸Šï¼Œé™¤äº†åœ¨å“ˆå¸Œè¡¨ï¼Œåœ¨å…¶ä»–ä»»ä½•æ—¶å€™ï¼Œåªè¦æ¶‰åŠåˆ°åœ¨å¯¹ Item çš„æ“ä½œï¼Œéƒ½ä¼šæ ¹æ® Item ä¸­çš„ keyï¼Œè¿›è¡Œ Item å“ˆå¸Œé”æ¡¶åŠ é”ï¼Œä»¥é¿å… Item è¢«åŒæ—¶è¯»å†™è€Œäº§ç”Ÿè„æ•°æ®ã€‚Mc é»˜è®¤æœ‰ 4096 ä¸ªé”æ¡¶ï¼Œæ‰€ä»¥å¯¹ key åŠ é”æ—¶ï¼Œå†²çªçš„æ¦‚ç‡è¾ƒå°ï¼Œè€Œä¸” Mc å…¨éƒ¨æ˜¯å†…å­˜æ“ä½œï¼Œæ“ä½œé€Ÿåº¦å¾ˆå¿«ï¼Œå³ä¾¿ç”³è¯·æ—¶é”è¢«å ç”¨ï¼Œä¹Ÿä¼šå¾ˆå¿«è¢«é‡Šæ”¾ã€‚</p>
<p>Mc å“ˆå¸Œè¡¨åœ¨æ‰©å®¹æ—¶ï¼Œå“ˆå¸Œè¡¨ç»´æŠ¤çº¿ç¨‹ï¼Œæ¯æ¬¡æŒ‰ æ¡¶é“¾è¡¨çº¬åº¦ è¿ç§»ï¼Œå³ä¸€æ¬¡è¿ç§»ä¸€ä¸ªæ¡¶é‡Œå•å‘é“¾è¡¨çš„æ‰€æœ‰ Item å…ƒç´ ã€‚åœ¨æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¦æŸ¥æ‰¾æˆ–æ’å…¥ keyï¼Œä¼šå‚ç…§è¿ç§»ä½ç½®é€‰æ‹©å“ˆå¸Œè¡¨ã€‚å¦‚æœ key å¯¹åº”çš„å“ˆå¸Œæ¡¶åœ¨è¿ç§»ä½ç½®ä¹‹å‰ï¼Œåˆ™åˆ°æ–°çš„ä¸»å“ˆå¸Œè¡¨è¿›è¡ŒæŸ¥è¯¢æˆ–æ’å…¥ï¼Œå¦åˆ™åˆ°æ—§å“ˆå¸Œè¡¨è¿›è¡ŒæŸ¥è¯¢å’Œæ’å…¥ã€‚å¾…å…¨éƒ¨æ‰©å®¹è¿ç§»å®Œæ¯•ï¼Œæ‰€æœ‰çš„å¤„ç†å°±ä¼šå…¨éƒ¨åœ¨æ–°çš„ä¸»å“ˆå¸Œè¡¨è¿›è¡Œã€‚</p>
<h2 id="Memcached-å¦‚ä½•æ·˜æ±°å†·keyå’Œå¤±æ•ˆkey"><a href="#Memcached-å¦‚ä½•æ·˜æ±°å†·keyå’Œå¤±æ•ˆkey" class="headerlink" title="Memcached å¦‚ä½•æ·˜æ±°å†·keyå’Œå¤±æ•ˆkey"></a>Memcached å¦‚ä½•æ·˜æ±°å†·keyå’Œå¤±æ•ˆkey</h2><h3 id="æ·˜æ±°ç­–ç•¥"><a href="#æ·˜æ±°ç­–ç•¥" class="headerlink" title="æ·˜æ±°ç­–ç•¥"></a>æ·˜æ±°ç­–ç•¥</h3><p>Mc ä½œä¸ºç¼“å­˜ç»„ä»¶ï¼Œæ„å‘³ç€ Mc ä¸­åªèƒ½å­˜å‚¨è®¿é—®æœ€é¢‘ç¹çš„çƒ­æ•°æ®ï¼Œä¸€æ—¦å­˜å…¥æ•°æ®è¶…è¿‡å†…å­˜é™åˆ¶ï¼Œå°±éœ€è¦å¯¹ Mc ä¸­çš„å†· key è¿›è¡Œæ·˜æ±°å·¥ä½œã€‚Mc ä¸­çš„ key åŸºæœ¬éƒ½ä¼šæœ‰è¿‡æœŸæ—¶é—´ï¼Œåœ¨ key è¿‡æœŸåï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒMc å¹¶ä¸ä¼šç«‹å³åˆ é™¤è¿‡æœŸçš„ keyï¼Œè€Œæ˜¯ç”±ç»´æŠ¤çº¿ç¨‹é€æ­¥æ¸…ç†ï¼ŒåŒæ—¶ï¼Œåªæœ‰è¿™ä¸ªå¤±æ•ˆçš„ key è¢«è®¿é—®æ—¶ï¼Œæ‰ä¼šè¿›è¡Œåˆ é™¤ï¼Œä»è€Œå›æ”¶å­˜å‚¨ç©ºé—´ã€‚æ‰€ä»¥ Mc å¯¹ key ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œå³ Mc å¯¹ key çš„æ·˜æ±°ï¼ŒåŒ…æ‹¬å¤±æ•ˆå’Œåˆ é™¤å›æ”¶ä¸¤ä¸ªçº¬åº¦ï¼ŒçŸ¥è¯†ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210220210918.jpg" alt=""></p>
<p>key çš„å¤±æ•ˆï¼ŒåŒ…æ‹¬ key åœ¨ expire æ—¶é—´ä¹‹åçš„è¿‡æœŸï¼Œä»¥åŠç”¨æˆ·åœ¨ flush_all ä¹‹åå¯¹æ‰€æœ‰ key çš„è¿‡æœŸ 2 ç§æ–¹å¼ã€‚</p>
<p>è€Œ Mc å¯¹ key/value çš„åˆ é™¤å›æ”¶ï¼Œåˆ™æœ‰ 3 ç§æ–¹å¼ã€‚</p>
<ol>
<li><p>ç¬¬ä¸€ç§æ˜¯è·å–æ—¶çš„æƒ°æ€§åˆ é™¤ï¼Œå³ key åœ¨å¤±æ•ˆåï¼Œä¸ç«‹å³åˆ é™¤æ·˜æ±°ï¼Œè€Œåœ¨è·å–æ—¶ï¼Œæ£€æµ‹ key çš„çŠ¶æ€ï¼Œå¦‚æœå¤±æ•ˆï¼Œæ‰è¿›è¡ŒçœŸæ­£çš„åˆ é™¤å¹¶å›æ”¶å­˜å‚¨ç©ºé—´ã€‚</p>
</li>
<li><p>ç¬¬äºŒç§æ–¹å¼æ˜¯åœ¨éœ€è¦å¯¹ Item è¿›è¡Œå†…å­˜åˆ†é…ç”³è¯·æ—¶ï¼Œå¦‚æœå†…å­˜å·²å…¨éƒ¨ç”¨å®Œï¼Œä¸”è¯¥ Item å¯¹åº”çš„slabclass æ²¡æœ‰ç©ºé—²çš„ chunk å¯ç”¨ï¼Œç”³è¯·å¤±è´¥ï¼Œåˆ™ä¼šå¯¹ LRU é˜Ÿå°¾è¿›è¡ŒåŒæ­¥æ‰«æï¼Œå›æ”¶è¿‡æœŸå¤±æ•ˆçš„ keyï¼Œå¦‚æœæ²¡æœ‰å¤±æ•ˆçš„ keyï¼Œåˆ™ä¼šå¼ºåˆ¶åˆ é™¤ä¸€ä¸ª keyã€‚</p>
</li>
<li><p>ç¬¬ä¸‰ç§æ–¹å¼æ˜¯ LRU ç»´æŠ¤çº¿ç¨‹ï¼Œä¸å®šæœŸæ‰«æ 4 ä¸ª LRU é˜Ÿåˆ—ï¼Œå¯¹è¿‡æœŸ key/value è¿›è¡Œå¼‚æ­¥æ·˜æ±°ã€‚</p>
</li>
</ol>
<p><strong>flush_all</strong></p>
<p>Mc ä¸­ï¼Œkey å¤±æ•ˆé™¤äº†å¸¸è§„çš„åˆ°è¾¾è¿‡æœŸæ—¶é—´ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç”¨ flush_all çš„æ–¹å¼è¿›è¡Œå…¨éƒ¨è¿‡æœŸã€‚å¦‚æœç¼“å­˜æ•°æ®å†™å…¥å¼‚å¸¸ï¼Œå‡ºç°å¤§é‡è„æ•°æ®ï¼Œè€Œåˆæ²¡æœ‰ç®€å•çš„åŠæ³•å¿«é€Ÿæ‰¾å‡ºæ‰€æœ‰çš„è„æ•°æ®ï¼Œå¯ä»¥ç”¨ flush_all ç«‹å³è®©æ‰€æœ‰æ•°æ®å¤±æ•ˆï¼Œé€šè¿‡ key é‡æ–°ä» DB åŠ è½½çš„æ–¹å¼æ¥ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚flush_all å¯ä»¥è®© Mc èŠ‚ç‚¹çš„æ‰€æœ‰ key ç«‹å³å¤±æ•ˆï¼Œä¸è¿‡ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œéœ€è¦è®©å¤šä¸ª Mc èŠ‚ç‚¹çš„æ•°æ®åœ¨æŸä¸ªæ—¶é—´åŒæ—¶å¤±æ•ˆï¼Œè¿™æ—¶å°±å¯ä»¥ç”¨ flush_all çš„å»¶è¿Ÿå¤±æ•ˆæŒ‡ä»¤äº†ã€‚è¯¥æŒ‡ä»¤é€šè¿‡ flush_all æŒ‡ä»¤åé¢åŠ ä¸€ä¸ª expiretime å‚æ•°ï¼Œå¯ä»¥è®©å¤šä¸ª Mc åœ¨æŸä¸ªæ—¶é—´åŒæ—¶å¤±æ•ˆæ‰€æœ‰çš„ keyã€‚</p>
<p>flush_all åé¢æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œç­‰ä»·äº flush_all 0ï¼Œå³ç«‹å³å¤±æ•ˆæ‰€æœ‰çš„ keyã€‚å½“ Mc æ”¶åˆ° flush_all æŒ‡ä»¤åï¼Œå¦‚æœæ˜¯å»¶è¿Ÿå¤±æ•ˆï¼Œä¼šå°†å…¨å±€ setting ä¸­çš„ oldest_live è®¾ä¸ºæŒ‡å®š N ç§’åçš„æ—¶é—´æˆ³ï¼Œå³ N ç§’åå¤±æ•ˆï¼›å¦‚æœæ˜¯ç«‹å³å¤±æ•ˆï¼Œåˆ™å°†å…¨å±€ setting ä¸­çš„ oldest_cas è®¾ä¸ºå½“å‰æœ€å¤§çš„å…¨å±€ cas å€¼ã€‚è®¾ç½®å®Œè¿™ä¸ªå…¨å±€å˜é‡å€¼åï¼Œç«‹å³è¿”å›ã€‚å› æ­¤ï¼Œåœ¨ Mc é€šè¿‡ flush_all å¤±æ•ˆæ‰€æœ‰ key æ—¶ï¼Œå®é™…ä¸åšä»»ä½• key çš„åˆ é™¤æ“ä½œï¼Œè¿™äº› key ï¼Œåç»­ä¼šé€šè¿‡ç”¨æˆ·è¯·æ±‚åŒæ­¥åˆ é™¤ï¼Œæˆ– LRU ç»´æŠ¤çº¿ç¨‹çš„å¼‚æ­¥åˆ é™¤ï¼Œæ¥å®ŒæˆçœŸæ­£çš„åˆ é™¤åŠ¨ä½œã€‚</p>
<p><strong>æƒ°æ€§åˆ é™¤</strong></p>
<p>Mc ä¸­ï¼Œè¿‡æœŸå¤±æ•ˆ key çš„æƒ°æ€§ä¸»åŠ¨åˆ é™¤ï¼Œæ˜¯æŒ‡åœ¨ touchã€getã€gets ç­‰æŒ‡ä»¤å¤„ç†æ—¶ï¼Œé¦–å…ˆéœ€è¦æŸ¥è¯¢ keyï¼Œæ‰¾åˆ° key æ‰€åœ¨çš„ Itemï¼Œç„¶åæ ¡éªŒ key æ˜¯å¦è¿‡æœŸï¼Œæ˜¯å¦è¢« flushï¼Œå¦‚æœè¿‡æœŸæˆ–è¢« flushï¼Œåˆ™ç›´æ¥è¿›è¡ŒçœŸæ­£çš„åˆ é™¤å›æ”¶æ“ä½œã€‚</p>
<p>å¯¹äºæ ¡éªŒ key è¿‡æœŸå¾ˆå®¹æ˜“ï¼Œç›´æ¥åˆ¤æ–­è¿‡æœŸæ—¶é—´å³å¯ã€‚å¯¹äºæ£€æŸ¥ key æ˜¯å¦è¢« flushï¼Œå¤„ç†é€»è¾‘æ˜¯é¦–å…ˆæ£€æŸ¥ key çš„æœ€è¿‘è®¿é—®æ—¶é—´æ˜¯å¦å°äºå…¨å±€è®¾ç½®ä¸­çš„ oldest_liveï¼Œå¦‚æœå°äºåˆ™è¯´æ˜ key è¢« flush äº†ï¼›å¦åˆ™ï¼Œå†æ£€æŸ¥ key çš„ cas å”¯ä¸€ id å€¼ï¼Œå¦‚æœå°äºå…¨å±€è®¾ç½®ä¸­çš„ oldest_casï¼Œè¯´æ˜ä¹Ÿè¢« flush äº†ã€‚</p>
<p><strong>å†…å­˜åˆ†é…å¤±è´¥ï¼ŒLRU åŒæ­¥æ·˜æ±°</strong></p>
<p>Mc åœ¨æ’å…¥æˆ–å˜æ›´ key æ—¶ï¼Œé¦–å…ˆä¼šåœ¨é€‚åˆçš„ slabclass ä¸ºæ–°çš„ key/value åˆ†é…ä¸€ä¸ªç©ºé—²çš„ Item ç©ºé—´ï¼Œå¦‚æœåˆ†é…å¤±è´¥ï¼Œä¼šåŒæ­¥å¯¹è¯¥ slabclass çš„ COLD LRU è¿›è¡Œé˜Ÿå°¾å…ƒç´ æ·˜æ±°ï¼Œå¦‚æœæ·˜æ±°å›æ”¶æˆåŠŸï¼Œåˆ™ slabclass ä¼šå¤šä¸€ä¸ªç©ºé—²çš„ Itemï¼Œè¿™ä¸ª Item å°±å¯ä»¥è¢«å‰é¢é‚£ä¸ª key æ¥ä½¿ç”¨ã€‚å¦‚æœ COLD LRU é˜Ÿåˆ—æ²¡æœ‰ Item æ•°æ®ï¼Œåˆ™æ·˜æ±°å¤±è´¥ï¼Œæ­¤æ—¶ä¼šå¯¹ HOT LRU è¿›è¡Œé˜Ÿå°¾è½®è¯¢ï¼Œå¦‚æœ key è¿‡æœŸå¤±æ•ˆåˆ™è¿›è¡Œæ·˜æ±°å›æ”¶ï¼Œå¦åˆ™è¿›è¡Œè¿ç§»ã€‚</p>
<p><strong>LRU ç»´æŠ¤çº¿ç¨‹ï¼Œå¼‚æ­¥æ·˜æ±°</strong></p>
<p>åœ¨ key è¿›è¡Œè¯»å–ã€æ’å…¥æˆ–å˜æ›´æ—¶ï¼ŒåŒæ­¥è¿›è¡Œ key æ·˜æ±°å›æ”¶ï¼Œå¹¶ä¸æ˜¯ä¸€ç§é«˜æ•ˆçš„åŠæ³•ï¼Œå› ä¸ºæ·˜æ±°å›æ”¶æ“ä½œç›¸æ¯”è¯·æ±‚å¤„ç†ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé‡é‡çº§æ“ä½œï¼Œä¼šå¯¼è‡´ Mc æ€§èƒ½å¤§å¹…ä¸‹é™ã€‚å› æ­¤ Mc é¢å¤–å¢åŠ äº†ä¸€ä¸ª LRU ç»´æŠ¤çº¿ç¨‹ï¼Œå¯¹è¿‡æœŸå¤±æ•ˆ key è¿›è¡Œå›æ”¶ï¼Œåœ¨ä¸å¢åŠ è¯·æ±‚è´Ÿæ‹…çš„æƒ…å†µä¸‹ï¼Œå°½å¿«å›æ”¶å¤±æ•ˆ key é”å ç”¨çš„ç©ºé—´ã€‚</p>
<p>å‰é¢è®²åˆ°ï¼ŒMc æœ‰ 64 ä¸ª slabclassï¼Œå…¶ä¸­ 1<del>63 å· slabclass ç”¨äºå­˜å– Item æ•°æ®ã€‚å®é™…ä¸Šï¼Œä¸ºäº†ç®¡ç†è¿‡æœŸå¤±æ•ˆæ•°æ®ï¼Œ1</del>63 å· slabclass è¿˜åˆ†åˆ«å¯¹åº”äº† 4 ä¸ª LRUï¼Œåˆ†å¸ƒæ˜¯ TEMPã€HOTã€WARMã€COLD LRUã€‚æ‰€ä»¥è¿™å°±æ€»å…±æœ‰ 63*4 = 252 ä¸ª LRUã€‚LRU ç»´æŠ¤çº¿ç¨‹ï¼Œä¼šæŒ‰ç­–ç•¥é—´æ–­ sleepï¼Œå¾… sleep ç»“æŸï¼Œå°±å¼€å§‹å¯¹ 4 ä¸ª LRU è¿›è¡Œé˜Ÿå°¾æ¸…ç†å·¥ä½œã€‚</p>
<p>Mc åœ¨æ–°å†™å…¥ key æ—¶ï¼Œå¦‚æœ key çš„è¿‡æœŸæ—¶é—´å°äº 61sï¼Œå°±ä¼šç›´æ¥æ’å…¥åˆ° TEMP LRU ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚TEMP LRU æ²¡æœ‰é•¿åº¦é™åˆ¶ï¼Œå¯ä»¥ä¸€ç›´æ’å…¥ï¼ŒåŒæ—¶å› ä¸ºè¿‡æœŸæ—¶é—´çŸ­ï¼ŒTEMP LRU ä¸è¿›è¡Œé˜Ÿåˆ—å†…éƒ¨çš„æ¬è¿å’Œé˜Ÿåˆ—é—´çš„è¿ç§»ï¼Œç¡®ä¿å¤„ç†æ€§èƒ½æœ€ä½³ã€‚LRU ç»´æŠ¤çº¿ç¨‹åœ¨ sleep å®Œæ¯•åï¼Œé¦–å…ˆä¼šå¯¹ TEMP LRU é˜Ÿå°¾è¿›è¡Œ 500 æ¬¡è½®è¯¢ï¼Œç„¶ååœ¨æ¯æ¬¡è½®è¯¢æ—¶ï¼Œä¼šè¿›è¡Œ 5 æ¬¡å°å¾ªç¯ã€‚å°å¾ªç¯æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ keyæ˜¯å¦è¿‡æœŸå¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆåˆ™è¿›è¡Œå›æ”¶æ·˜æ±°ï¼Œç„¶åç»§ç»­å°å¾ªç¯ï¼›å¦‚æœé‡åˆ°ä¸€ä¸ªæ²¡å¤±æ•ˆçš„ keyï¼Œåˆ™å›æ”¶è¯¥ key å¹¶é€€å‡º TEMP LRU çš„æ¸…ç†å·¥ä½œã€‚å¦‚æœ TEMP LRU é˜Ÿå°¾ key å…¨éƒ¨å¤±æ•ˆï¼Œç»´æŠ¤çº¿ç¨‹ä¸€æ¬¡å¯ä»¥å›æ”¶ 500*5 å…± 2500 ä¸ªå¤±æ•ˆçš„ keyã€‚</p>
<p><img src="http://image.leonote.cn//20210220211300.jpg" alt=""></p>
<p>å¦‚ä¸‹å›¾ï¼ŒMC åœ¨æ–°å†™å…¥ key æ—¶ï¼Œå¦‚æœ key çš„è¿‡æœŸæ—¶é—´è¶…è¿‡ 61sï¼Œå°±ä¼šç›´æ¥æ’å…¥åˆ° HOT LRUã€‚HOT LRU ä¼šæœ‰å†…å­˜é™åˆ¶ï¼Œæ¯ä¸ª HOT LRU æ‰€å å†…å­˜ä¸å¾—è¶…è¿‡æ‰€åœ¨ slabclass æ€»å®é™…ä½¿ç”¨å†…å­˜çš„ 20%ã€‚LRU ç»´æŠ¤çº¿ç¨‹åœ¨æ‰§è¡Œæ—¥å¸¸ç»´æŠ¤å·¥ä½œæ—¶ï¼Œé¦–å…ˆå¯¹ TEMP LRU è¿›è¡Œæ¸…ç†ï¼Œæ¥ä¸‹æ¥å°±ä¼šå¯¹ HOT LRU è¿›è¡Œç»´æŠ¤ã€‚HOT LRU çš„ç»´æŠ¤ï¼Œä¹Ÿæ˜¯é¦–å…ˆè½®è¯¢ 500 æ¬¡ï¼Œæ¯æ¬¡è½®è¯¢è¿›è¡Œ 5 æ¬¡å°å¾ªç¯ï¼Œå°å¾ªç¯æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸå¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆåˆ™è¿›è¡Œå›æ”¶æ·˜æ±°ï¼Œç„¶åç»§ç»­å°å¾ªç¯ã€‚ç›´åˆ°é‡åˆ°æ²¡å¤±æ•ˆçš„ keyã€‚å¦‚æœè¿™ä¸ª key çš„çŠ¶æ€æ˜¯ ACTIVEï¼Œåˆ™è¿ç§»åˆ° WARM LRUã€‚å¯¹äºé ACTIVE çŠ¶æ€çš„ keyï¼Œå¦‚æœ HOT LRU å†…å­˜å ç”¨è¶…è¿‡é™åˆ¶ï¼Œåˆ™è¿ç§»åˆ° COLD LRUï¼Œå¦åˆ™è¿›è¡Œçº¾å›°æ€§æ¸…ç†æ‰è¯¥ keyï¼Œæ³¨æ„è¿™ç§çº¾å›°æ€§æ¸…ç†æ“ä½œä¸€èˆ¬ä¸ä¼šå‘ç”Ÿï¼Œä¸€æ—¦å‘ç”Ÿæ—¶ï¼Œè™½ç„¶ä¼šæ¸…ç†æ‰è¯¥ keyï¼Œä½†æ“ä½œå‡½æ•°æ­¤æ—¶ä¹Ÿè®¤å®šæœ¬æ¬¡æ“ä½œå›æ”¶å’Œæ¸…ç† keys æ•°ä»ç„¶ä¸º 0ã€‚</p>
<p><img src="http://image.leonote.cn//20210220211338.jpg" alt=""></p>
<p>å¦‚ä¸‹å›¾ï¼Œå¦‚æœ HOT LRU ä¸­å›æ”¶å’Œè¿ç§»çš„ keys æ•°ä¸º 0ï¼ŒLRU ç»´æŠ¤çº¿ç¨‹ä¼šå¯¹ WARM LRU è¿›è¡Œè½®è¯¢ã€‚WARM LRU ä¹Ÿæœ‰å†…å­˜é™åˆ¶ï¼Œæ¯ä¸ª WARM LRU æ‰€å å†…å­˜ä¸å¾—è¶…è¿‡æ‰€åœ¨ slabclass æ€»å®é™…ä½¿ç”¨å†…å­˜çš„ 40%ã€‚WARM LRU çš„ç»´æŠ¤ï¼Œä¹Ÿæ˜¯é¦–å…ˆè½®è¯¢ 500 æ¬¡ï¼Œæ¯æ¬¡è½®è¯¢è¿›è¡Œ 5 æ¬¡å°å¾ªç¯ï¼Œå°å¾ªç¯æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸå¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆåˆ™è¿›è¡Œå›æ”¶æ·˜æ±°ï¼Œç„¶åç»§ç»­å°å¾ªç¯ã€‚ç›´åˆ°é‡åˆ°æ²¡å¤±æ•ˆçš„ keyã€‚å¦‚æœè¿™ä¸ª key çš„çŠ¶æ€æ˜¯ ACTIVEï¼Œåˆ™å†…éƒ¨æ¬è¿åˆ° LRU é˜Ÿåˆ—å¤´éƒ¨ã€‚å¯¹äºé ACTIVE çŠ¶æ€çš„ keyï¼Œå¦‚æœ WARM LRU å†…å­˜å ç”¨è¶…è¿‡é™åˆ¶ï¼Œåˆ™è¿ç§»åˆ° COLD LRUï¼Œå¦åˆ™è¿›è¡Œçº¾å›°æ€§æ¸…ç†æ‰è¯¥ keyã€‚æ³¨æ„è¿™ç§çº¾å›°æ€§æ¸…ç†æ“ä½œä¸€èˆ¬ä¸ä¼šå‘ç”Ÿï¼Œä¸€æ—¦å‘ç”Ÿæ—¶ï¼Œè™½ç„¶ä¼šæ¸…ç†æ‰è¯¥ keyï¼Œä½†æ“ä½œå‡½æ•°æ­¤æ—¶ä¹Ÿè®¤å®šæœ¬æ¬¡æ“ä½œå›æ”¶å’Œæ¸…ç† keys æ•°ä»ç„¶ä¸º 0ã€‚</p>
<p><img src="http://image.leonote.cn//20210220211420.jpg" alt=""></p>
<p>LRU ç»´æŠ¤çº¿ç¨‹æœ€åä¼šå¯¹ COLD LRU è¿›è¡Œç»´æŠ¤ï¼Œå¦‚ä¸‹å›¾ã€‚ä¸ TEMP LRU ç›¸åŒï¼ŒCOLD LRU ä¹Ÿæ²¡æœ‰é•¿åº¦é™åˆ¶ï¼Œå¯ä»¥æŒç»­å­˜æ”¾æ•°æ®ã€‚COLD LRU çš„ç»´æŠ¤ï¼Œä¹Ÿæ˜¯é¦–å…ˆè½®è¯¢ 500 æ¬¡ï¼Œæ¯æ¬¡è½®è¯¢è¿›è¡Œ 5 æ¬¡å°å¾ªç¯ï¼Œå°å¾ªç¯æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸå¤±æ•ˆï¼Œå¦‚æœå¤±æ•ˆåˆ™è¿›è¡Œå›æ”¶æ·˜æ±°ï¼Œç„¶åç»§ç»­å°å¾ªç¯ã€‚ç›´åˆ°é‡åˆ°æ²¡å¤±æ•ˆçš„ keyã€‚å¦‚æœè¿™ä¸ª key çš„çŠ¶æ€æ˜¯ ACTIVEï¼Œåˆ™ä¼šè¿ç§»åˆ° WARM LRU é˜Ÿåˆ—å¤´éƒ¨ï¼Œå¦åˆ™ä¸å¤„ç†ç›´æ¥è¿”å›ã€‚</p>
<p><img src="http://image.leonote.cn//20210220211501.jpg" alt=""></p>
<p>LRU ç»´æŠ¤çº¿ç¨‹å¤„ç†æ—¶ï¼ŒTEMP LRU æ˜¯åœ¨ç‹¬ç«‹å¾ªç¯ä¸­è¿›è¡Œï¼Œå…¶ä»–ä¸‰ä¸ª LRU åœ¨å¦å¤–ä¸€ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼Œå¦‚æœ HOTã€WARMã€COLD LRU æ¸…ç†æˆ–ç§»åŠ¨çš„ keys æ•°ä¸º 0ï¼Œåˆ™é‚£ä¸ª 500 æ¬¡çš„å¤§å¾ªç¯å°±ç«‹å³åœæ­¢ã€‚</p>
<h2 id="ä¸ºä½•-Memcached-èƒ½é•¿æœŸç»´æŒé«˜æ€§èƒ½è¯»å†™"><a href="#ä¸ºä½•-Memcached-èƒ½é•¿æœŸç»´æŒé«˜æ€§èƒ½è¯»å†™" class="headerlink" title="ä¸ºä½• Memcached èƒ½é•¿æœŸç»´æŒé«˜æ€§èƒ½è¯»å†™"></a>ä¸ºä½• Memcached èƒ½é•¿æœŸç»´æŒé«˜æ€§èƒ½è¯»å†™</h2><h3 id="å†…å­˜ç®¡ç†-slab-æœºåˆ¶"><a href="#å†…å­˜ç®¡ç†-slab-æœºåˆ¶" class="headerlink" title="å†…å­˜ç®¡ç† slab æœºåˆ¶"></a>å†…å­˜ç®¡ç† slab æœºåˆ¶</h3><p><strong>slabclass</strong></p>
<p>Mc çš„ slab æœºåˆ¶æ˜¯é€šè¿‡ slabclass æ¥è¿›è¡Œè¿ä½œçš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚Mc åœ¨å¯åŠ¨æ—¶ï¼Œä¼šæ„å»ºé•¿åº¦ä¸º 64 çš„ slabclass æ•°ç»„ï¼Œå…¶ä¸­ 0 å· slabclass ç”¨äº slab çš„é‡æ–°åˆ†é…ï¼Œ1~63 å· slabclass å­˜å‚¨æ•°æ® Itemã€‚å­˜å‚¨æ•°æ®çš„æ¯ä¸ª slabclassï¼Œéƒ½ä¼šè®°å½•æœ¬ slabclass çš„ chunk sizeï¼ŒåŒæ—¶ä¸åŒ slabclass çš„ chunk size ä¼šæŒ‰é€’å¢å› å­å¢åŠ ï¼Œæœ€åä¸€ä¸ª slabclassï¼ˆå³ 63 å· slabclassï¼‰çš„ chunk size ä¼šç›´æ¥è®¾ä¸ºæœ€å¤§çš„ chunk sizeï¼Œé»˜è®¤æ˜¯ 0.5MBã€‚æ¯ä¸ª slabclass åœ¨æ²¡æœ‰ç©ºé—²çš„ chunk æ—¶ï¼ŒMc å°±ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªé»˜è®¤å¤§å°ä¸º 1MB çš„ slabï¼ŒåŒæ—¶æŒ‰ç…§æœ¬ slabclass çš„ chunk size è¿›è¡Œæ‹†åˆ†ï¼Œè¿™äº›åˆ†æ‹†å‡ºæ¥çš„ chunk ä¼šæŒ‰ Item ç»“æ„ä½“è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åè®°å½•åˆ° slabclass çš„ freelist é“¾è¡¨ä¸­ã€‚å½“æœ‰ key/value è¦å­˜å‚¨åœ¨æœ¬ slabclass æ—¶ï¼Œå°±ä» freelist åˆ†é…ä¸€ä¸ª Itemï¼Œä¾›å…¶ä½¿ç”¨ã€‚åŒæ—¶ï¼Œå¦‚æœ Item è¿‡æœŸäº†ï¼Œæˆ–è¢« flush_all å¤±æ•ˆäº†ï¼Œæˆ–åœ¨å†…å­˜ä¸å¤Ÿæ—¶è¢«å¼ºé¡¹å‰”é™¤äº†ï¼Œä¹Ÿä¼šåœ¨é€‚å½“æ—¶åˆ»ï¼Œé‡æ–°è¢«å›æ”¶åˆ° freelistï¼Œä»¥ä¾›åç»­åˆ†é…ä½¿ç”¨ã€‚</p>
<p><img src="http://image.leonote.cn//20210220212913.jpg" alt=""></p>
<p><strong>å­˜å‚¨ slab åˆ†é…</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒMc çš„å­˜å‚¨ç©ºé—´åˆ†é…æ˜¯ä»¥ slab ä¸ºå•ä½çš„ï¼Œæ¯ä¸ª slab çš„é»˜è®¤å¤§å°æ—¶ 1MBã€‚å› æ­¤åœ¨å­˜æ•°æ®æ—¶ï¼ŒMc çš„å†…å­˜æœ€å°åˆ†é…å•ä½æ˜¯ 1MBï¼Œåˆ†é…äº†è¿™ä¸ª 1MB çš„ slab åï¼Œæ‰ä¼šè¿›ä¸€æ­¥æŒ‰æ‰€åœ¨ slabclass çš„chunk size è¿›è¡Œç»†åˆ†ï¼Œåˆ†æ‹†å‡ºçš„ç›¸åŒ size çš„ chunkã€‚è¿™ä¸ª chunk ç”¨æ¥å­˜æ”¾ Item æ•°æ®ï¼ŒItem æ•°æ®åŒ…æ‹¬ Item ç»“æ„ä½“å­—æ®µï¼Œä»¥åŠ key/valueã€‚</p>
<p>ä¸€èˆ¬æ¥è®²ï¼ŒItem ç»“æ„ä½“åŠ key/value ä¸ä¼šå¡«æ»¡ chunkï¼Œä¼šå­˜åœ¨å°‘é‡å­—èŠ‚çš„æµªè´¹ï¼Œä½†è¿™ä¸ªæµªè´¹çš„å­—èŠ‚å¾ˆå°‘ï¼ŒåŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚Mc ä¸­ï¼Œslab ä¸€æ—¦åˆ†é…ï¼Œå°±ä¸ä¼šå†è¢«å›æ”¶ï¼Œä½†ä¼šæ ¹æ®è¿è¡ŒçŠ¶å†µï¼Œé‡æ–°åœ¨ä¸åŒ slabclass ä¹‹é—´è¿›è¡Œåˆ†é…ã€‚</p>
<p><img src="http://image.leonote.cn//20210220213031.jpg" alt=""></p>
<p>å½“ä¸€ä¸ª slabclass æ²¡æœ‰ç©ºé—² chunkï¼Œè€Œæ–°æ•°æ®æ’å…¥æ—¶ï¼Œå°±ä¼šå¯¹å…¶å°è¯•å¢åŠ ä¸€ä¸ªæ–°çš„ slabã€‚slabclass å¢åŠ æ–° slab æ—¶ï¼Œé¦–å…ˆä¼šä» 0 å·å…¨å±€ slabclass ä¸­å¤ç”¨ä¸€ä¸ªä¹‹å‰åˆ†é…çš„ slabï¼Œå¦‚æœ 0 å· slabclass æ²¡æœ‰ slabï¼Œåˆ™ä¼šå°è¯•ä»å†…å­˜å †ç©ºé—´ç›´æ¥åˆ†é…ä¸€ä¸ª slabã€‚å¦‚æœ 0 å·å…¨å±€ slabclass æ²¡æœ‰ç©ºé—² slabï¼Œè€Œä¸” Mc å†…å­˜åˆ†é…å·²ç»è¾¾åˆ° Mc è®¾å®šçš„ä¸Šé™å€¼ï¼Œå°±è¯´æ˜æ­¤æ—¶æ²¡æœ‰å¯é‡æ–°åˆ†é…çš„ slabï¼Œåˆ†é…æ–° slab å¤±è´¥ï¼Œç›´æ¥è¿”å›ã€‚</p>
<p>å½“ç„¶ï¼Œè™½ç„¶ slabclass åˆ†é… slab å¤±è´¥ï¼Œä½†å¹¶ä¸æ„å‘³ç€ Itemåˆ†é…ä¼šå¤±è´¥ï¼Œå‰é¢å·²ç»è®²åˆ°ï¼Œå¯ä»¥é€šè¿‡åŒæ­¥ LRU æ·˜æ±°ï¼Œå›æ”¶ä¹‹å‰åˆ†é…å‡ºå»çš„ Itemï¼Œä¾›æ–°çš„å­˜å‚¨è¯·æ±‚ä½¿ç”¨ã€‚</p>
<p><strong>Item</strong></p>
<p>Mc ä¸­ï¼Œslabclass ä¸­çš„ chunk ä¼šé¦–å…ˆç”¨ Item ç»“æ„ä½“è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åå­˜åˆ° freelist é“¾è¡¨ä¸­ï¼Œå¾…éœ€è¦åˆ†é…ç»™æ•°æ®å­˜å‚¨æ—¶ï¼Œå†ä» freelist ä¸­å–å‡ºï¼Œå­˜å…¥ key/valueï¼Œä»¥åŠå„ç§è¾…åŠ©å±æ€§ï¼Œç„¶åå†å­˜åˆ° LRU é“¾è¡¨åŠ Hashtable ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚Item ç»“æ„ä½“ï¼Œé¦–å…ˆæœ‰ä¸¤ä¸ª prevã€next æŒ‡é’ˆï¼Œåœ¨åˆ†é…ç»™å¾…å­˜å‚¨æ•°æ®ä¹‹å‰ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆç”¨æ¥ä¸²è” freelist é“¾è¡¨ï¼Œåœ¨åˆ†é…ä¹‹åï¼Œåˆ™ç”¨æ¥ä¸²è”æ‰€åœ¨çš„ LRU é“¾è¡¨ã€‚æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª h_next æŒ‡é’ˆï¼Œç”¨æ¥åœ¨åˆ†é…ä¹‹åä¸²è”å“ˆå¸Œè¡¨çš„æ¡¶å•å‘é“¾è¡¨ã€‚Item ç»“æ„ä½“è¿˜å­˜å‚¨äº†è¿‡æœŸæ—¶é—´ã€æ‰€å± slabclass idï¼Œkey é•¿åº¦ã€cas å”¯ä¸€ id å€¼ç­‰ï¼Œæœ€ååœ¨ Item ç»“æ„ä½“å°¾éƒ¨ï¼Œå­˜å‚¨äº† keyã€flagã€value é•¿åº¦ï¼Œä»¥åŠ value block æ•°æ®ã€‚åœ¨ value ä¹‹åçš„ chunk ç©ºé—´ï¼Œå°±è¢«æµªè´¹æ‰äº†ã€‚Item åœ¨ç©ºé—²æœŸé—´ï¼Œå³åˆå§‹åˆ†é…æ—¶ä»¥åŠè¢«å›æ”¶åï¼Œéƒ½è¢« freelist ç®¡ç†ã€‚åœ¨å­˜å‚¨æœŸé—´ï¼Œè¢«å“ˆå¸Œè¡¨ã€LRU ç®¡ç†ã€‚</p>
<p><img src="http://image.leonote.cn//20210220213232.jpg" alt=""></p>
<p><strong>å­˜å‚¨ Item åˆ†é…</strong></p>
<p>Mc é‡‡ç”¨ slab æœºåˆ¶ç®¡ç†åˆ†é…å†…å­˜ï¼Œé‡‡ç”¨ Item ç»“æ„å­˜å‚¨ key/valueï¼Œå› æ­¤å¯¹å­˜å‚¨ key/value çš„å†…å­˜åˆ†é…ï¼Œå°±è½¬æ¢ä¸ºå¯¹ Item çš„åˆ†é…ã€‚åˆ†é… Item ç©ºé—´æ—¶ï¼Œä¼šè¿›è¡Œ 10 æ¬¡å¤§å¾ªç¯ï¼Œç›´åˆ°åˆ†é…åˆ° Item  ç©ºé—´æ‰ä¼šæå‰è¿”å›ã€‚å¦‚æœå¾ªç¯äº† 10 æ¬¡ï¼Œè¿˜æ²¡æœ‰åˆ†é…åˆ° Item ç©ºé—´ï¼Œåˆ™å­˜å‚¨å¤±è´¥ï¼Œè¿”å›ä¸€ä¸ª SERVER_ERROR å“åº”ã€‚</p>
<p>åœ¨åˆ†é…è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆï¼Œå¦‚æœ slabclass çš„ freelist æœ‰ç©ºé—´ï¼Œåˆ™ç›´æ¥åˆ†é…ã€‚å¦åˆ™ï¼Œå°è¯•åˆ†é…ä¸€ä¸ªæ–°çš„ slabï¼Œæ–° slab ä¾æ¬¡å°è¯•ä»å…¨å±€ slab æ± ï¼ˆå³ 0 å· slabclassï¼‰ä¸­å¤ç”¨ä¸€ä¸ªç©ºé—² slabï¼Œå¦‚æœå…¨å±€ slab æ± æ²¡æœ‰ slabï¼Œåˆ™å°è¯•ä»å†…å­˜ç›´æ¥åˆ†é…ã€‚åˆ†é…æ–° slab æˆåŠŸåï¼Œä¼šæŒ‰ç…§ slabclass è®°å½•çš„ chunk size å¯¹ slab è¿›è¡Œåˆ†æ‹†ï¼Œå¹¶å°†åˆ†æ‹†å‡ºæ¥çš„ chunk æŒ‰ Item ç»“æ„åˆå§‹åŒ–åè®°å½•åˆ° freelistã€‚å¦‚æœå…¨å±€ slab æ± ä¸ºç©ºï¼Œä¸” Mc å†…å­˜åˆ†é…å·²ç»è¾¾åˆ°è®¾å®šçš„ä¸Šé™ï¼Œåˆ™èµ°æ–°å¢ slab çš„è·¯å¾„å¤±è´¥ï¼Œè½¬è€Œè¿›è¡Œ 5 æ¬¡å°å¾ªç¯ï¼Œå°è¯•ä» COLD LRU å›æ”¶è¿‡æœŸ keyï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸåˆ™ç›´æ¥å¼ºåˆ¶å‰”é™¤é˜Ÿå°¾çš„ä¸€ä¸ªæ­£å¸¸ keyã€‚å¦‚æœè¯¥ slabclass çš„ COLD LRU æ²¡æœ‰ Itemï¼Œåˆ™å¯¹å…¶ HOT LRU è¿›è¡Œå¤„ç†ï¼Œå¯¹ HOT é“¾è¡¨é˜Ÿå°¾ Item è¿›è¡Œå›æ”¶æˆ–è€…è¿ç§»ï¼Œä»¥æ–¹ä¾¿åœ¨ä¸‹æ¬¡å¾ªç¯ä¸­æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ Item ç©ºé—´ã€‚</p>
<p><strong>æ•°æ®å­˜å‚¨æœºç†</strong></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“éœ€è¦å­˜å‚¨ key/value æ•°æ®æ—¶ï¼Œé¦–å…ˆæ ¹æ® key/value sizeï¼Œä»¥åŠ Item ç»“æ„ä½“çš„ sizeï¼Œè®¡ç®—å‡ºå­˜å‚¨è¿™ä¸ª key/value éœ€è¦çš„å­—èŠ‚æ•°ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå­—èŠ‚æ•°é€‰æ‹©ä¸€ä¸ªèƒ½å­˜å‚¨çš„ chunk size æœ€å°çš„ slabclassã€‚å†ä»è¿™ä¸ª slabclass çš„ freelist åˆ†é…ä¸€ä¸ªç©ºé—²çš„ chunk ç»™è¿™ä¸ª key/value ä½¿ç”¨ã€‚å¦‚æœ freelist ä¸ºç©ºï¼Œé¦–å…ˆå°è¯•ä¸ºè¯¥ slabclass æ–°åˆ†é…ä¸€ä¸ª slabï¼Œå¦‚æœ slab åˆ†é…æˆåŠŸï¼Œåˆ™å°† slab æŒ‰ size åˆ†æ‹†å‡ºä¸€äº› chunkï¼Œé€šè¿‡ Item ç»“æ„åˆå§‹åŒ–åå¡«å……åˆ° freelistã€‚å¦‚æœ slab åˆ†é…å¤±è´¥ï¼Œåˆ™é€šè¿‡ LRU æ·˜æ±°å¤±æ•ˆçš„ Item æˆ–å¼ºè¡Œå‰”é™¤ä¸€ä¸ªæ­£å¸¸çš„ Itemï¼Œç„¶åè¿™äº› Item ä¹Ÿä¼šå¡«å……åˆ° freelistã€‚å½“ freelist æœ‰ Item æ—¶ï¼Œå³å¯åˆ†é…ç»™ key/valueã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šé‡è¯• 10 æ¬¡ï¼Œç›´åˆ°åˆ†é…åˆ° Item ä½ç½®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒItem åˆ†é…æ€»ä¼šæˆåŠŸï¼Œæå°æ¦‚ç‡æƒ…å†µä¸‹ä¹Ÿä¼šåˆ†é…å¤±è´¥ï¼Œå¦‚æœåˆ†é…å¤±è´¥ï¼Œåˆ™ä¼šå›å¤ä¸€ä¸ª SERVER_ERROR å“åº”ï¼Œé€šçŸ¥ client å­˜å‚¨å¤±è´¥ã€‚åˆ†é…åˆ°ä¸€ä¸ªç©ºé—²çš„ Item åï¼Œå°±ä¼šå¾€è¿™ä¸ª Item ç©ºé—´å†™å…¥è¿‡æœŸæ—¶é—´ã€flagã€slabclass idã€keyï¼Œä»¥åŠ value ç­‰ã€‚å¯¹äº set æŒ‡ä»¤ï¼Œå¦‚æœè¿™ä¸ª key è¿˜æœ‰ä¸€ä¸ªæ—§å€¼ï¼Œåœ¨å­˜å…¥æ–° value ä¹‹å‰ï¼Œè¿˜ä¼šå…ˆå°†è¿™ä¸ªæ—§å€¼åˆ é™¤æ‰ã€‚</p>
<p><img src="http://image.leonote.cn//20210220214440.jpg" alt=""></p>
<p>å½“å¯¹ key/value åˆ†é… Item æˆåŠŸï¼Œå¹¶å†™å…¥æ•°æ®åï¼Œæ¥ä¸‹æ¥å°±ä¼šå°†è¿™ä¸ª Item å­˜å…¥å“ˆå¸Œè¡¨ã€‚å› ä¸ºMc å“ˆå¸Œè¡¨å­˜åœ¨è¿ç§»çš„æƒ…å†µï¼Œæ‰€ä»¥å¯¹äºæ­£å¸¸åœºæ™¯ï¼Œç›´æ¥å­˜å…¥ä¸»å“ˆå¸Œè¡¨ã€‚åœ¨å“ˆå¸Œè¡¨è¿ç§»æœŸé—´ï¼Œéœ€è¦æ ¹æ®è¿ç§»ä½ç½®ï¼Œé€‰æ‹©å­˜å…¥ä¸»å“ˆå¸Œè¡¨è¿˜æ˜¯æ—§å“ˆå¸Œè¡¨ã€‚å­˜å…¥å“ˆå¸Œè¡¨ä¹‹åï¼Œè¿™ä¸ª key å°±å¯ä»¥å¿«é€Ÿå®šä½äº†ã€‚ç„¶åè¿™ä¸ª Item è¿˜ä¼šè¢«å­˜å…¥ LRUï¼ŒMc ä¼šæ ¹æ®è¿™ä¸ª key çš„è¿‡æœŸæ—¶é—´è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿‡æœŸæ—¶é—´å°äº 61sï¼Œåˆ™å­˜å…¥ TEMP LRUï¼Œå¦åˆ™å­˜å…¥ HOT LRUã€‚</p>
<p>è‡³æ­¤ï¼Œè¿™ä¸ª key/value å°±è¢«æ­£ç¡®åœ°å­˜å…¥ Mc äº†ï¼Œæ•°æ®å†…å®¹å†™å…¥ slabclass ä¸­æŸä¸ª slab çš„ chunk ä½ç½®ï¼Œè¯¥ chunk ç”¨ Item ç»“æ„å¡«å……ï¼Œè¿™ä¸ª Item ä¼šè¢«åŒæ—¶è®°å½•åˆ° Hashtable å’Œ LRUï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚é€šè¿‡ Hashtable å¯ä»¥å¿«é€Ÿå®šä½æŸ¥åˆ°è¿™ä¸ª keyï¼Œè€Œ LRU åˆ™ç”¨äº Item ç”Ÿå‘½å‘¨æœŸçš„æ—¥å¸¸ç»´æŠ¤ã€‚</p>
<p><img src="http://image.leonote.cn//20210220215002.jpg" alt=""></p>
<p>Mc å¯¹ Item ç”Ÿå‘½å‘¨æœŸçš„æ—¥å¸¸ç»´æŠ¤ï¼ŒåŒ…æ‹¬å¼‚æ­¥ç»´æŠ¤å’ŒåŒæ­¥ç»´æŠ¤ã€‚å¼‚æ­¥ç»´æŠ¤æ˜¯é€šè¿‡ LRU ç»´æŠ¤çº¿ç¨‹æ¥è¿›è¡Œçš„ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸å½±å“ client çš„æ­£å¸¸è¯·æ±‚ï¼Œåœ¨ LRU ç»´æŠ¤çº¿ç¨‹å†…ï¼Œå¯¹è¿‡æœŸã€å¤±æ•ˆ key è¿›è¡Œå›æ”¶ï¼Œå¹¶å¯¹ 4 ä¸ª LRU è¿›è¡Œé“¾è¡¨å†…æ¬è¿å’Œé“¾è¡¨é—´è¿ç§»ã€‚è¿™æ˜¯ Item ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ä¸»è¦å½¢å¼ã€‚åŒæ­¥ç»´æŠ¤ï¼Œç”±å·¥ä½œçº¿ç¨‹åœ¨å¤„ç†è¯·æ±‚å‘½ä»¤æ—¶è¿›è¡Œã€‚å·¥ä½œçº¿ç¨‹åœ¨å¤„ç† delete æŒ‡ä»¤æ—¶ï¼Œä¼šç›´æ¥å°† key/value è¿›è¡Œåˆ é™¤ã€‚åœ¨å­˜å‚¨æ–° key/value æ—¶ï¼Œå¦‚æœåˆ†é…å¤±è´¥ï¼Œä¼šè¿›è¡Œå¤±æ•ˆçš„ key å›æ”¶ï¼Œæˆ–è€…å¼ºè¡Œå‰”é™¤æ­£å¸¸çš„ Itemã€‚è¿™äº› Item è¢«å›æ”¶åï¼Œä¼šè¿›å…¥åˆ° slabclass çš„ freelist è¿›è¡Œé‡å¤ä½¿ç”¨ã€‚</p>
<h2 id="åè®®åˆ†æ"><a href="#åè®®åˆ†æ" class="headerlink" title="åè®®åˆ†æ"></a>åè®®åˆ†æ</h2><p><strong>å¼‚å¸¸é”™è¯¯å“åº”</strong></p>
<p>Mc åœ¨å¤„ç†æ‰€æœ‰ client ç«¯æŒ‡ä»¤æ—¶ï¼Œå¦‚æœé‡åˆ°é”™è¯¯ï¼Œå°±ä¼šè¿”å› 3 ç§é”™è¯¯ä¿¡æ¯ä¸­çš„ä¸€ç§ã€‚</p>
<ul>
<li><p>ç¬¬ä¸€ç§é”™è¯¯æ˜¯åè®®é”™è¯¯ï¼Œä¸€ä¸ªâ€ERROR\r\nâ€çš„å­—ç¬¦ä¸²ã€‚è¡¨æ˜ client å‘é€äº†ä¸€ä¸ªéæ³•å‘½ä»¤ã€‚</p>
</li>
<li><p>ç¬¬äºŒç§é”™è¯¯æ˜¯ client é”™è¯¯ï¼Œæ ¼å¼ä¸ºâ€CLIENT_ERROR &lt;error-æè¿°ä¿¡æ¯&gt;\r\nâ€ã€‚è¿™ä¸ªé”™è¯¯ä¿¡æ¯è¡¨æ˜ ï¼Œclient å‘é€çš„åè®®å‘½ä»¤æ ¼å¼æœ‰è¯¯ï¼Œæ¯”å¦‚å°‘äº†å­—æ®µã€å¤šäº†éæ³•å­—æ®µç­‰ã€‚</p>
</li>
<li><p>ç¬¬ä¸‰ç§é”™è¯¯æ˜¯â€SERVER_ERROR &lt;error-æè¿°ä¿¡æ¯&gt;\r\nâ€ã€‚è¿™ä¸ªé”™è¯¯ä¿¡æ¯è¡¨æ˜ Mc server ç«¯ï¼Œåœ¨å¤„ç†å‘½ä»¤æ—¶å‡ºç°çš„é”™è¯¯ã€‚æ¯”å¦‚åœ¨ç»™ key/value åˆ†é… Item ç©ºé—´å¤±è´¥åï¼Œä¼šè¿”å›â€SERVER_ERROR out of memory storing objectâ€ é”™è¯¯ä¿¡æ¯ã€‚</p>
</li>
</ul>
<p><strong>å­˜å‚¨åè®®å‘½ä»¤</strong></p>
<p>Mc çš„å­˜å‚¨åè®®å‘½ä»¤ä¸å¤šï¼Œåªæœ‰ 6 ä¸ªã€‚</p>
<p>Mc å­˜å‚¨æŒ‡ä»¤åˆ† 2 è¡Œã€‚ç¬¬ä¸€è¡Œæ˜¯æŠ¥æ–‡é¦–éƒ¨ï¼Œç¬¬äºŒè¡Œæ˜¯ value çš„ data block å—ã€‚è¿™ä¸¤éƒ¨åˆ†ç”¨ \r\n æ¥è¿›è¡Œåˆ†å‰²å’Œæ”¶å°¾ã€‚</p>
<p>å­˜å‚¨ç±»æŒ‡ä»¤çš„æŠ¥æ–‡é¦–è¡Œåˆ† 2 ç§æ ¼å¼ï¼Œå…¶ä¸­ä¸€ç§æ˜¯åœ¨ cmd å­˜å‚¨æŒ‡ä»¤ï¼Œåé¢è·Ÿ keyã€flagsã€expiretimeã€value å­—èŠ‚æ•°ï¼Œä»¥åŠä¸€ä¸ªå¯é€‰çš„ noreplyã€‚</p>
<p>å…¶ä¸­ flags æ˜¯ç”¨æˆ·è‡ªå·±è®¾è®¡çš„ä¸€ä¸ªç‰¹æ®Šå«ä¹‰æ•°å­—ï¼ŒMc å¯¹ flag åªå­˜å‚¨ï¼Œè€Œä¸è¿›è¡Œä»»ä½•é¢å¤–è§£æå¤„ç†ï¼Œexpiretime æ˜¯ key çš„è¿‡æœŸæ—¶é—´ï¼Œvalue å­—èŠ‚æ•°æ˜¯ value block å—çš„å­—èŠ‚é•¿åº¦ï¼Œè€Œå¸¦ä¸Š noreply æ˜¯æŒ‡ Mc å¤„ç†å®Œåé™é»˜å¤„ç†ï¼Œä¸è¿”å›ä»»ä½•å“åº”ç»™ clientã€‚</p>
<p>è¿™ç§ cmd æŒ‡ä»¤åŒ…æ‹¬æˆ‘ä»¬æœ€å¸¸ç”¨çš„ set æŒ‡ä»¤ï¼Œå¦å¤–è¿˜åŒ…æ‹¬ addã€replaceã€appendã€reppend ï¼Œæ€»å…± 5 ä¸ªæŒ‡ä»¤ï¼š</p>
<ul>
<li><p>Set å‘½ä»¤ç”¨äºå­˜å‚¨ä¸€ä¸ª key/valueï¼›</p>
</li>
<li><p>Add å‘½ä»¤æ˜¯åœ¨å½“ key ä¸å­˜åœ¨æ—¶ï¼Œæ‰å­˜å‚¨è¿™ä¸ª key/valueï¼›</p>
</li>
<li><p>Replace å‘½ä»¤ï¼Œæ˜¯å½“ key å­˜åœ¨æ—¶ï¼Œæ‰å­˜å‚¨è¿™ä¸ª key/valueï¼›</p>
</li>
<li><p>Append å‘½ä»¤ï¼Œæ˜¯å½“ key å­˜åœ¨æ—¶ï¼Œè¿½åŠ  data åˆ° value çš„å°¾éƒ¨ï¼›</p>
</li>
<li><p>Prepend å‘½ä»¤ï¼Œæ˜¯å½“ key å­˜åœ¨æ—¶ï¼Œå°† data åŠ åˆ° value çš„å¤´éƒ¨ã€‚</p>
</li>
</ul>
<p>å¦å¤–ä¸€ç§å­˜å‚¨åè®®æŒ‡ä»¤ï¼Œä¸»è¦æ ¼å¼å’Œå­—æ®µä¸å‰ä¸€ç§åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ª cas unique idï¼Œè¿™ç§æ ¼å¼åªæœ‰ cas æŒ‡ä»¤ä½¿ç”¨ã€‚cas æŒ‡ä»¤æ˜¯æŒ‡åªæœ‰å½“è¿™ä¸ª key å­˜åœ¨ï¼Œä¸”ä»æœ¬ client è·å–ä»¥æ¥ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•äººä¿®æ”¹è¿‡æ—¶ï¼Œæ‰è¿›è¡Œä¿®æ”¹ã€‚cas çš„è‹±æ–‡å«ä¹‰æ˜¯ compare and setï¼Œå³æ¯”è¾ƒæˆåŠŸåè®¾ç½®çš„æ„æ€ã€‚</p>
<p><strong>å­˜å‚¨å‘½ä»¤å“åº”</strong></p>
<p>Mc åœ¨å“åº”å­˜å‚¨åè®®æ—¶ï¼Œå¦‚æœé‡åˆ°é”™è¯¯ï¼Œå°±è¿”å›å‰é¢è¯´çš„3ç§é”™è¯¯ä¿¡æ¯ä¸­çš„ä¸€ç§ã€‚å¦åˆ™å°±ä¼šè¿”å›å¦‚ä¸‹ 4 ç§æ­£å¸¸çš„å“åº”ï¼Œâ€STORED\r\nâ€ã€â€EXISTS\r\nâ€ã€â€NOT_STORED\r\nâ€ã€â€NOT_FOUND\r\nâ€œã€‚</p>
<p>å…¶ä¸­ï¼Œstored è¡¨æ˜å­˜å‚¨ä¿®æ”¹æˆåŠŸã€‚NOT_STORED è¡¨æ˜æ•°æ®æ²¡æœ‰å­˜å‚¨æˆåŠŸï¼Œä½†å¹¶ä¸æ˜¯é‡åˆ°é”™è¯¯æˆ–å¼‚å¸¸ã€‚è¿™ä¸ªå“åº”ä¸€èˆ¬è¡¨æ˜ add æˆ– replace ç­‰æŒ‡ä»¤ï¼Œå‰ç½®æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œæ¯”å¦‚ addï¼Œè¿™ä¸ª key å·²ç»å­˜åœ¨ Mcï¼Œå°±ä¼š add æ–° key å¤±è´¥ã€‚replace æ—¶ï¼Œ key ä¸å­˜åœ¨ï¼Œä¹Ÿæ— æ³• replace æˆåŠŸã€‚EXISTS è¡¨æ˜å¾… cas çš„key å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œè€Œ NOT_FOUND æ˜¯æŒ‡å¾… cas çš„ key åœ¨ Mc ä¸­ä¸å­˜åœ¨ã€‚</p>
<p>Mc å¯¹å­˜å‚¨å‘½ä»¤çš„è¯·æ±‚åŠå“åº”åè®®ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„æ€ç»´å¯¼å›¾æ¥æœ‰ä¸€ä¸ªå®Œæ•´çš„å°è±¡ã€‚</p>
<p><img src="http://image.leonote.cn//20210220215930.jpg" alt=""></p>
<p><strong>è·å–å‘½ä»¤</strong></p>
<p>Mc çš„è·å–åè®®ï¼Œåªæœ‰ getã€gets ä¸¤ç§æŒ‡ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ ¼å¼ä¸º get/gets åï¼Œè·Ÿéšè‹¥å¹²ä¸ª keyï¼Œç„¶å \r\n ç»“æŸè¯·æ±‚å‘½ä»¤ã€‚get æŒ‡ä»¤åªè·å– key çš„ flag åŠ valueï¼Œgets ä¼šé¢å¤–å¤šè·å–ä¸€ä¸ª cas unique idå€¼ã€‚gets ä¸»è¦æ˜¯ä¸º cas æŒ‡ä»¤æœåŠ¡çš„ã€‚</p>
<p>è·å–å‘½ä»¤çš„å“åº”ï¼Œå°±æ˜¯ value å­—ä¸²ï¼Œåé¢è·Ÿä¸Š keyã€flagã€value å­—èŠ‚æ•°ï¼Œä»¥åŠ value çš„ data block å—ã€‚æœ€åè·Ÿä¸€ä¸ª END\r\n è¡¨æ˜æ‰€æœ‰å­˜åœ¨çš„ key/value å·²ç»è¿”å›ï¼Œå¦‚æœæ²¡æœ‰è¿”å›çš„ keyï¼Œåˆ™è¡¨æ˜è¿™ä¸ª key åœ¨ Mc ä¸­ä¸å­˜åœ¨ã€‚</p>
<p><img src="http://image.leonote.cn//20210220220006.jpg" alt=""></p>
<p><strong>å…¶ä»–æŒ‡ä»¤</strong></p>
<p>Mc çš„å…¶ä»–åè®®æŒ‡ä»¤åŒ…æ‹¬ deleteã€incrã€decrã€touchã€gatã€gatsã€slabsã€lruã€stats è¿™ 9 ç§æŒ‡ä»¤ã€‚</p>
<p>å…¶ä¸­ delete ç”¨äºåˆ é™¤ä¸€ä¸ª keyã€‚</p>
<p>incr/decr ç”¨äºå¯¹ä¸€ä¸ªæ— ç¬¦å·é•¿æ•´å‹æ•°å­—è¿›è¡ŒåŠ æˆ–å‡ã€‚</p>
<p>touchã€gatã€gats æ˜¯ Mc åæ¥å¢åŠ çš„æŒ‡ä»¤ï¼Œéƒ½å¯ä»¥ç”¨æ¥ä¿®æ”¹ key çš„è¿‡æœŸæ—¶é—´ã€‚ä¸åŒç‚¹æ˜¯ touch åªä¿®æ”¹ key çš„è¿‡æœŸæ—¶é—´ï¼Œä¸è·å– keyå¯¹åº”çš„valueã€‚</p>
<p>è€Œ gatã€gats æŒ‡ä»¤ï¼Œä¸ä»…ä¼šä¿®æ”¹ key çš„è¿‡æœŸæ—¶é—´ï¼Œè¿˜ä¼šè·å– key å¯¹åº”çš„ flag å’Œ value æ•°æ®ã€‚gats åŒ getsï¼Œè¿˜ä¼šé¢å¤–è·å– cas å”¯ä¸€ id å€¼ã€‚</p>
<p>Slabs reassign ç”¨äºåœ¨ Mc å†…å­˜è¾¾åˆ°è®¾å®šä¸Šé™åï¼Œå°† slab é‡æ–°åœ¨ä¸åŒçš„ slabclass ä¹‹é—´åˆ†é…ã€‚è¿™æ ·å¯ä»¥è§„é¿ Mc å¯åŠ¨åè‡ªåŠ¨åˆ†é…è€Œäº§ç”Ÿéšæœºæ€§ï¼Œä½¿ç‰¹æ®Š size çš„æ•°æ®ä¹Ÿå¾—åˆ°è¾ƒå¥½çš„å‘½ä¸­ç‡ã€‚Slabs automove æ˜¯ä¸€ä¸ªå¼€å…³æŒ‡ä»¤ï¼Œå½“æ‰“å¼€æ—¶ï¼Œå°±å…è®¸ Mc åå°çº¿ç¨‹è‡ªè¡Œå†³å®šä½•æ—¶å°† slab åœ¨slabclass ä¹‹é—´é‡æ–°åˆ†é…ã€‚</p>
<p>lru æŒ‡ä»¤ç”¨äº Mc LRU çš„è®¾ç½®å’Œè°ƒä¼˜ã€‚æ¯”å¦‚ LRU tune ç”¨äºè®¾ç½® HOTã€WARM LRU çš„å†…å­˜å æ¯”ã€‚LRU mode ç”¨æ¥è®¾ç½® Mc åªä½¿ç”¨ COLD LRUï¼Œè¿˜æ˜¯ä½¿ç”¨æ–°ç‰ˆçš„ 4 ä¸ª LRU çš„æ–°ç­–ç•¥ã€‚LRU TEMP_TTL ç”¨æ¥è®¾ç½® Mc çš„ TEMP LRU çš„TTLå€¼ï¼Œé»˜è®¤æ˜¯ 61sï¼Œå°äºè¿™ä¸ª TMEP_TTL çš„ keyä¼šè¢«æ’å…¥åˆ° TEMP LRUã€‚</p>
<p>Stats ç”¨äºè·å– Mc çš„å„ç§ç»Ÿè®¡æ•°æ®ã€‚Stats åé¢å¯ä»¥è·Ÿ statisticsã€slabsã€size ç­‰å‚æ•°ï¼Œæ¥è¿›ä¸€æ­¥è·å–æ›´å¤šä¸åŒçš„è¯¦ç»†ç»Ÿè®¡ã€‚</p>
<p><strong>Client ä½¿ç”¨</strong></p>
<p>Mc åœ¨äº’è”ç½‘ä¼ä¸šåº”ç”¨å¹¿æ³›ï¼Œçƒ­é—¨è¯­è¨€åŸºæœ¬éƒ½æœ‰ Mc client çš„å®ç°ã€‚ä»¥ Java è¯­è¨€ä¸ºä¾‹ï¼Œäº’è”ç½‘ä¸šç•Œå¹¿æ³›ä½¿ç”¨çš„æœ‰ Memcached-Java-Clientã€SpyMemcachedã€Xmemcached ç­‰ã€‚</p>
<p>Memcached-Java-Client æ¨å‡ºæ—¶é—´æ—©ï¼Œ10 å¹´å‰å°±è¢«å¹¿æ³›ä½¿ç”¨ï¼Œè¿™ä¸ª client æ€§èƒ½ä¸€èˆ¬ï¼Œä½†è¶³å¤Ÿç¨³å®šï¼Œå¾ˆå¤šäº’è”ç½‘ä¼ä¸šè‡³ä»Šä»åœ¨ä½¿ç”¨ã€‚ä¸è¿‡è¿™ä¸ª client å‡ å¹´å‰å°±åœæ­¢äº†æ›´æ–°ã€‚</p>
<p>SpyMemcached å‡ºç°çš„æ¯”è¾ƒæ™šï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†é«˜å¹¶å‘è®¿é—®åœºæ™¯ï¼Œç¨³å®šæ€§æ¬ ç¼ºã€‚è¿‘å‡ å¹´å˜æ›´å¾ˆå°‘ï¼ŒåŸºæœ¬åœæ­¢äº†æ›´æ–°ã€‚</p>
<p>Xmemcached æ€§èƒ½è¾ƒå¥½ï¼Œç»¼åˆè¡¨ç°æœ€ä½³ã€‚è€Œä¸”ç¤¾åŒºæ´»è·ƒåº¦é«˜ï¼Œè¿‘äº›å¹´ä¹Ÿä¸€ç›´åœ¨æŒç»­æ›´æ–°ä¸­ã€‚Java æ–°é¡¹ç›®å¯åŠ¨ï¼Œæ¨èä½¿ç”¨ Xmemcachedã€‚ </p>
<p>åœ¨ä½¿ç”¨ Mc client æ—¶ï¼Œæœ‰ä¸€äº›é€šç”¨æ€§çš„è°ƒä¼˜åŠæ”¹è¿›æ–¹æ¡ˆã€‚æ¯”å¦‚ï¼Œå¦‚æœè¯»å†™çš„ key/value è¾ƒå¤§ï¼Œéœ€è¦è®¾ç½®æ›´å¤§çš„ç¼“å†² bufï¼Œä»¥æé«˜æ€§èƒ½ã€‚åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œéœ€è¦å¯ç”¨ TCP_NODELAYï¼Œé¿å… 40ms çš„å»¶è¿Ÿé—®é¢˜ã€‚åŒæ—¶ï¼Œå¦‚æœå­˜å–çš„ key/value size è¾ƒå¤§ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªå‹ç¼©é˜€å€¼ï¼Œè¶…è¿‡é˜€å€¼ï¼Œå°±å¯¹value è¿›è¡Œå‹ç¼©ç®—æ³•ï¼Œå‡å°‘è¯»å†™åŠå­˜å‚¨çš„ç©ºé—´ã€‚</p>
<p>ä¸ºäº†é¿å…ç¼“å­˜é›ªå´©ï¼Œå¹¶æ›´å¥½åœ°åº”å¯¹æçƒ­ key åŠæ´ªæ°´æµé‡çš„é—®é¢˜ï¼Œè¿˜å¯ä»¥å¯¹ Mc client è¿›è¡Œå°è£…ï¼ŒåŠ å…¥å¤šå‰¯æœ¬ã€å¤šå±‚çº§ç­–ç•¥ï¼Œä½¿ Mc ç¼“å­˜ç³»ç»Ÿåœ¨ä»»ä½•åœºæ™¯ä¸‹ï¼Œéƒ½å¯åšåˆ°é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>çŸ¥è¯†ç‚¹ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210220220242.jpg" alt=""></p>
<p>Mc åè®®çš„æ€ç»´å¯¼å›¾</p>
<p><img src="http://image.leonote.cn//20210220220319.jpg" alt=""></p>
]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼“å­˜çš„åŸç†ã€å¼•å…¥ä¸è®¾è®¡</title>
    <url>/2020/10/14/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-%E7%BC%93%E5%AD%98%E7%9A%84%E5%8E%9F%E7%90%86%E3%80%81%E5%BC%95%E5%85%A5%E4%B8%8E%E8%AE%BE%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="ç¼“å­˜çš„åŸç†ã€å¼•å…¥ä¸è®¾è®¡"><a href="#ç¼“å­˜çš„åŸç†ã€å¼•å…¥ä¸è®¾è®¡" class="headerlink" title="ç¼“å­˜çš„åŸç†ã€å¼•å…¥ä¸è®¾è®¡"></a>ç¼“å­˜çš„åŸç†ã€å¼•å…¥ä¸è®¾è®¡</h1><h2 id="ä¸šåŠ¡æ•°æ®è®¿é—®æ€§èƒ½å¤ªä½æ€ä¹ˆåŠ"><a href="#ä¸šåŠ¡æ•°æ®è®¿é—®æ€§èƒ½å¤ªä½æ€ä¹ˆåŠ" class="headerlink" title="ä¸šåŠ¡æ•°æ®è®¿é—®æ€§èƒ½å¤ªä½æ€ä¹ˆåŠ"></a>ä¸šåŠ¡æ•°æ®è®¿é—®æ€§èƒ½å¤ªä½æ€ä¹ˆåŠ</h2><ol>
<li>ç¼“å­˜çš„åŸºæœ¬æ€æƒ³</li>
<li>ç¼“å­˜çš„ä¼˜ç‚¹</li>
<li>ç¼“å­˜çš„ä»£ä»·</li>
</ol>
<h3 id="ç¼“å­˜çš„å®šä¹‰"><a href="#ç¼“å­˜çš„å®šä¹‰" class="headerlink" title="ç¼“å­˜çš„å®šä¹‰"></a>ç¼“å­˜çš„å®šä¹‰</h3><ul>
<li><p>ç¼“å­˜æœ€åˆçš„å«ä¹‰ï¼Œæ˜¯æŒ‡ç”¨äºåŠ é€Ÿ CPU æ•°æ®äº¤æ¢çš„ RAMï¼Œå³éšæœºå­˜å–å­˜å‚¨å™¨ï¼Œé€šå¸¸è¿™ç§å­˜å‚¨å™¨ä½¿ç”¨æ›´æ˜‚è´µä½†å¿«é€Ÿçš„é™æ€ RAMï¼ˆSRAMï¼‰æŠ€æœ¯ï¼Œç”¨ä»¥å¯¹ DRAM è¿›è¡ŒåŠ é€Ÿã€‚è¿™æ˜¯ä¸€ä¸ªç‹­ä¹‰ç¼“å­˜çš„å®šä¹‰ã€‚</p>
</li>
<li><p>è€Œå¹¿ä¹‰ç¼“å­˜çš„å®šä¹‰åˆ™æ›´å®½æ³›ï¼Œä»»ä½•å¯ä»¥ç”¨äºæ•°æ®é«˜é€Ÿäº¤æ¢çš„å­˜å‚¨ä»‹è´¨éƒ½æ˜¯ç¼“å­˜ï¼Œå¯ä»¥æ˜¯ç¡¬ä»¶ä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶ã€‚</p>
</li>
</ul>
<p><img src="http://image.leonote.cn//20201014195605.png" alt=""></p>
<blockquote>
<p>ç¼“å­˜å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯é€šè¿‡å¼€è¾Ÿä¸€ä¸ªæ–°çš„æ•°æ®äº¤æ¢ç¼“å†²åŒºï¼Œæ¥è§£å†³åŸå§‹æ•°æ®è·å–ä»£ä»·å¤ªå¤§çš„é—®é¢˜ï¼Œè®©æ•°æ®å¾—åˆ°æ›´å¿«çš„è®¿é—®ã€‚ç›®å‰è®²çš„ç¼“å­˜ä¸»è¦æ˜¯æŒ‡å¹¿ä¹‰ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯äº’è”ç½‘äº§å“å¤§é‡ä½¿ç”¨çš„å„ç§ç¼“å­˜ç»„ä»¶å’ŒæŠ€æœ¯ã€‚</p>
</blockquote>
<h3 id="ç¼“å­˜åŸç†"><a href="#ç¼“å­˜åŸç†" class="headerlink" title="ç¼“å­˜åŸç†"></a>ç¼“å­˜åŸç†</h3><h4 id="ç¼“å­˜çš„åŸºæœ¬æ€æƒ³"><a href="#ç¼“å­˜çš„åŸºæœ¬æ€æƒ³" class="headerlink" title="ç¼“å­˜çš„åŸºæœ¬æ€æƒ³"></a>ç¼“å­˜çš„åŸºæœ¬æ€æƒ³</h4><p><img src="http://image.leonote.cn//20201014195847.png" alt=""></p>
<p>ç¼“å­˜æ„å»ºçš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨æ—¶é—´å±€é™æ€§åŸç†ï¼Œé€šè¿‡ç©ºé—´æ¢æ—¶é—´æ¥è¾¾åˆ°åŠ é€Ÿæ•°æ®è·å–çš„ç›®çš„ï¼ŒåŒæ—¶ç”±äºç¼“å­˜ç©ºé—´çš„æˆæœ¬è¾ƒé«˜ï¼Œåœ¨å®é™…è®¾è®¡æ¶æ„ä¸­è¿˜è¦è€ƒè™‘<strong>è®¿é—®å»¶è¿Ÿ</strong>å’Œ<strong>æˆæœ¬</strong>çš„æƒè¡¡é—®é¢˜ã€‚è¿™é‡Œé¢æœ‰ 3 ä¸ªå…³é”®ç‚¹ã€‚</p>
<ol>
<li><p>æ—¶é—´å±€é™æ€§åŸç†ï¼Œå³è¢«è·å–è¿‡ä¸€æ¬¡çš„æ•°æ®åœ¨æœªæ¥ä¼šè¢«å¤šæ¬¡å¼•ç”¨ï¼Œæ¯”å¦‚ä¸€æ¡å¾®åšè¢«ä¸€ä¸ªäººæ„Ÿå…´è¶£å¹¶é˜…è¯»åï¼Œå®ƒå¤§æ¦‚ç‡è¿˜ä¼šè¢«æ›´å¤šäººé˜…è¯»ï¼Œå½“ç„¶å¦‚æœå˜æˆçƒ­é—¨å¾®åšåï¼Œä¼šè¢«æ•°ä»¥ç™¾ä¸‡/åƒä¸‡è®¡ç®—çš„æ›´å¤šç”¨æˆ·æŸ¥çœ‹ã€‚</p>
</li>
<li><p>ä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œå› ä¸ºåŸå§‹æ•°æ®è·å–å¤ªæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€è¾Ÿä¸€å—é«˜é€Ÿç‹¬ç«‹ç©ºé—´ï¼Œæä¾›é«˜æ•ˆè®¿é—®ï¼Œæ¥è¾¾åˆ°æ•°æ®è·å–åŠ é€Ÿçš„ç›®çš„ã€‚</p>
</li>
<li><p>æ€§èƒ½æˆæœ¬ Tradeoffï¼Œæ„å»ºç³»ç»Ÿæ—¶å¸Œæœ›ç³»ç»Ÿçš„è®¿é—®æ€§èƒ½è¶Šé«˜è¶Šå¥½ï¼Œè®¿é—®å»¶è¿Ÿè¶Šä½å°è¶Šå¥½ã€‚ä½†ç»´æŒç›¸åŒæ•°æ®è§„æ¨¡çš„å­˜å‚¨åŠè®¿é—®ï¼Œæ€§èƒ½è¶Šé«˜å»¶è¿Ÿè¶Šå°ï¼Œæˆæœ¬ä¹Ÿä¼šè¶Šé«˜ï¼Œæ‰€ä»¥åœ¨ç³»ç»Ÿæ¶æ„è®¾è®¡æ—¶ï¼Œä½ éœ€è¦åœ¨ç³»ç»Ÿæ€§èƒ½å’Œå¼€å‘è¿è¡Œæˆæœ¬ä¹‹é—´åšå–èˆã€‚æ¯”å¦‚å·¦è¾¹è¿™å¼ å›¾ï¼Œç›¸åŒæˆæœ¬çš„å®¹é‡ï¼ŒSSD ç¡¬ç›˜å®¹é‡ä¼šæ¯”å†…å­˜å¤§ 10ï½30 å€ä»¥ä¸Šï¼Œä½†è¯»å†™å»¶è¿Ÿå´é«˜ 50ï½100 å€ã€‚</p>
</li>
</ol>
<h4 id="ç¼“å­˜çš„ä¼˜åŠ¿"><a href="#ç¼“å­˜çš„ä¼˜åŠ¿" class="headerlink" title="ç¼“å­˜çš„ä¼˜åŠ¿"></a>ç¼“å­˜çš„ä¼˜åŠ¿</h4><p>ç¼“å­˜çš„ä¼˜åŠ¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li><p>æå‡è®¿é—®æ€§èƒ½</p>
</li>
<li><p>é™ä½ç½‘ç»œæ‹¥å µ</p>
</li>
<li><p>å‡è½»æœåŠ¡è´Ÿè½½</p>
</li>
<li><p>å¢å¼ºå¯æ‰©å±•æ€§</p>
</li>
</ul>
<p>ç¼“å­˜å­˜å‚¨åŸå§‹æ•°æ®ï¼Œå¯ä»¥<strong>å¤§å¹…æå‡è®¿é—®æ€§èƒ½</strong>ã€‚ä¸è¿‡åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œç¼“å­˜ä¸­å­˜å‚¨çš„å¾€å¾€æ˜¯éœ€è¦é¢‘ç¹è®¿é—®çš„ä¸­é—´æ•°æ®ç”šè‡³æœ€ç»ˆç»“æœï¼Œè¿™äº›æ•°æ®ç›¸æ¯” DB ä¸­çš„åŸå§‹æ•°æ®å°å¾ˆå¤šï¼Œè¿™æ ·å°±å¯ä»¥<strong>å‡å°‘ç½‘ç»œæµé‡ï¼Œé™ä½ç½‘ç»œæ‹¥å µ</strong>ï¼ŒåŒæ—¶ç”±äºå‡å°‘äº†è§£æå’Œè®¡ç®—ï¼Œè°ƒç”¨æ–¹å’Œå­˜å‚¨æœåŠ¡çš„<strong>è´Ÿè½½ä¹Ÿå¯ä»¥å¤§å¹…é™ä½</strong>ã€‚ç¼“å­˜çš„è¯»å†™æ€§èƒ½å¾ˆé«˜ï¼Œé¢„çƒ­å¿«ï¼Œåœ¨æ•°æ®è®¿é—®å­˜åœ¨æ€§èƒ½ç“¶é¢ˆæˆ–é‡åˆ°çªå‘æµé‡ï¼Œç³»ç»Ÿè¯»å†™å‹åŠ›å¤§å¢æ—¶ï¼Œ<strong>å¯ä»¥å¿«é€Ÿéƒ¨ç½²</strong>ä¸Šçº¿ï¼ŒåŒæ—¶åœ¨æµé‡ç¨³å®šåï¼Œä¹Ÿå¯ä»¥éšæ—¶ä¸‹çº¿ï¼Œä»è€Œä½¿ç³»ç»Ÿçš„<strong>å¯æ‰©å±•æ€§å¤§å¤§å¢å¼º</strong>ã€‚</p>
<h4 id="ç¼“å­˜çš„ä»£ä»·"><a href="#ç¼“å­˜çš„ä»£ä»·" class="headerlink" title="ç¼“å­˜çš„ä»£ä»·"></a>ç¼“å­˜çš„ä»£ä»·</h4><p>ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œä»»ä½•äº‹æƒ…éƒ½æœ‰ä¸¤é¢æ€§ï¼Œç¼“å­˜ä¹Ÿä¸ä¾‹å¤–ï¼Œæˆ‘ä»¬åœ¨äº«å—ç¼“å­˜å¸¦æ¥ä¸€ç³»åˆ—å¥½å¤„çš„åŒæ—¶ï¼Œä¹Ÿæ³¨å®šéœ€è¦ä»˜å‡ºä¸€å®šçš„ä»£ä»·ã€‚</p>
<ul>
<li><p>é¦–å…ˆï¼ŒæœåŠ¡ç³»ç»Ÿä¸­å¼•å…¥ç¼“å­˜ï¼Œä¼š<strong>å¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦</strong>ã€‚</p>
</li>
<li><p>å…¶æ¬¡ï¼Œç”±äºç¼“å­˜ç›¸æ¯”åŸå§‹ DB å­˜å‚¨çš„<strong>æˆæœ¬æ›´é«˜</strong>ï¼Œæ‰€ä»¥ç³»ç»Ÿéƒ¨ç½²åŠè¿è¡Œçš„è´¹ç”¨ä¹Ÿä¼šæ›´é«˜ã€‚</p>
</li>
<li><p>æœ€åï¼Œç”±äºä¸€ä»½æ•°æ®åŒæ—¶å­˜åœ¨ç¼“å­˜å’Œ DB ä¸­ï¼Œç”šè‡³ç¼“å­˜å†…éƒ¨ä¹Ÿä¼šæœ‰å¤šä¸ªæ•°æ®å‰¯æœ¬ï¼Œå¤šä»½æ•°æ®å°±ä¼š<strong>å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜</strong>ï¼ŒåŒæ—¶ç¼“å­˜ä½“ç³»æœ¬èº«ä¹Ÿä¼šå­˜åœ¨<strong>å¯ç”¨æ€§é—®é¢˜å’Œåˆ†åŒºçš„é—®é¢˜</strong>ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åŠ å¼ºå¯¹ç¼“å­˜åŸç†ã€ç¼“å­˜ç»„ä»¶ä»¥åŠä¼˜ç§€ç¼“å­˜ä½“ç³»å®è·µçš„ç†è§£ï¼Œä»ç³»ç»Ÿæ¶æ„ä¹‹åˆå°±å¯¹ç¼“å­˜è¿›è¡Œè‰¯å¥½è®¾è®¡ï¼Œé™ä½ç¼“å­˜å¼•å…¥çš„å‰¯ä½œç”¨ï¼Œè®©ç¼“å­˜ä½“ç³»æˆä¸ºæœåŠ¡ç³»ç»Ÿé«˜æ•ˆç¨³å®šè¿è¡Œçš„å¼ºåŠ›åŸºçŸ³ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä¸€èˆ¬æ¥è®²ï¼ŒæœåŠ¡ç³»ç»Ÿçš„å…¨é‡åŸå§‹æ•°æ®å­˜å‚¨åœ¨ DB ä¸­ï¼ˆå¦‚ MySQLã€HBase ç­‰ï¼‰ï¼Œæ‰€æœ‰æ•°æ®çš„è¯»å†™éƒ½å¯ä»¥é€šè¿‡ DB æ“ä½œæ¥è·å–ã€‚ä½† DB è¯»å†™æ€§èƒ½ä½ã€å»¶è¿Ÿé«˜ï¼Œå¦‚ MySQL å•å®ä¾‹çš„è¯»å†™ QPS é€šå¸¸åªæœ‰åƒçº§åˆ«ï¼ˆ3000ï½6000ï¼‰ï¼Œè¯»å†™å¹³å‡è€—æ—¶ 10ï½100ms çº§åˆ«ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·è¯·æ±‚éœ€è¦æŸ¥ 20 ä¸ªä¸åŒçš„æ•°æ®æ¥èšåˆï¼Œä»…ä»… DB è¯·æ±‚å°±éœ€è¦æ•°ç™¾æ¯«ç§’ç”šè‡³æ•°ç§’ã€‚è€Œ cache çš„è¯»å†™æ€§èƒ½æ­£å¥½å¯ä»¥å¼¥è¡¥ DB çš„ä¸è¶³ï¼Œæ¯”å¦‚ Memcached çš„è¯»å†™ QPS å¯ä»¥è¾¾åˆ° 10ï½100ä¸‡ çº§åˆ«ï¼Œè¯»å†™å¹³å‡è€—æ—¶åœ¨ 1ms ä»¥ä¸‹ï¼Œç»“åˆå¹¶å‘è®¿é—®æŠ€æœ¯ï¼Œå•ä¸ªè¯·æ±‚å³ä¾¿æŸ¥ä¸Šç™¾æ¡æ•°æ®ï¼Œä¹Ÿå¯ä»¥è½»æ¾åº”å¯¹ã€‚</p>
<p>ä½† cache å®¹é‡å°ï¼Œåªèƒ½å­˜å‚¨éƒ¨åˆ†è®¿é—®é¢‘ç¹çš„çƒ­æ•°æ®ï¼ŒåŒæ—¶ï¼ŒåŒä¸€ä»½æ•°æ®å¯èƒ½åŒæ—¶å­˜åœ¨ cache å’Œ DBï¼Œå¦‚æœå¤„ç†ä¸å½“ï¼Œå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚æ‰€ä»¥æœåŠ¡ç³»ç»Ÿåœ¨å¤„ç†ä¸šåŠ¡è¯·æ±‚æ—¶ï¼Œéœ€è¦å¯¹ cache çš„è¯»å†™æ–¹å¼è¿›è¡Œé€‚å½“è®¾è®¡ï¼Œæ—¢è¦ä¿è¯æ•°æ®é«˜æ•ˆè¿”å›ï¼Œåˆè¦å°½é‡é¿å…æ•°æ®ä¸ä¸€è‡´ç­‰å„ç§é—®é¢˜ã€‚</p>
</blockquote>
<h2 id="å¦‚ä½•æ ¹æ®ä¸šåŠ¡æ¥é€‰æ‹©ç¼“å­˜æ¨¡å¼å’Œç»„ä»¶"><a href="#å¦‚ä½•æ ¹æ®ä¸šåŠ¡æ¥é€‰æ‹©ç¼“å­˜æ¨¡å¼å’Œç»„ä»¶" class="headerlink" title="å¦‚ä½•æ ¹æ®ä¸šåŠ¡æ¥é€‰æ‹©ç¼“å­˜æ¨¡å¼å’Œç»„ä»¶"></a>å¦‚ä½•æ ¹æ®ä¸šåŠ¡æ¥é€‰æ‹©ç¼“å­˜æ¨¡å¼å’Œç»„ä»¶</h2><ol>
<li>ç¼“å­˜çš„è¯»å†™æ¨¡å¼</li>
<li>ç¼“å­˜çš„åˆ†ç±»</li>
</ol>
<h3 id="ç¼“å­˜è¯»å†™æ¨¡å¼"><a href="#ç¼“å­˜è¯»å†™æ¨¡å¼" class="headerlink" title="ç¼“å­˜è¯»å†™æ¨¡å¼"></a>ç¼“å­˜è¯»å†™æ¨¡å¼</h3><p>å¦‚ä¸‹å›¾ï¼Œä¸šåŠ¡ç³»ç»Ÿè¯»å†™ç¼“å­˜æœ‰ 3 ç§æ¨¡å¼ï¼š</p>
<ul>
<li><p>Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰</p>
</li>
<li><p>Read/Write Throughï¼ˆè¯»å†™ç©¿é€ï¼‰</p>
</li>
<li><p>Write Behind Cachingï¼ˆå¼‚æ­¥ç¼“å­˜å†™å…¥ï¼‰</p>
</li>
</ul>
<p><img src="http://image.leonote.cn//20201014201011.png" alt=""></p>
<h4 id="Cache-Aside"><a href="#Cache-Aside" class="headerlink" title="Cache Aside"></a>Cache Aside</h4><p><img src="http://image.leonote.cn//20201014201115.png" alt=""></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒCache Aside æ¨¡å¼ä¸­ï¼Œä¸šåŠ¡åº”ç”¨æ–¹</p>
<ul>
<li>å¯¹äºå†™ï¼Œæ˜¯æ›´æ–° DB åï¼Œç›´æ¥å°† key ä» cache ä¸­åˆ é™¤ï¼Œç”± DB é©±åŠ¨ç¼“å­˜æ•°æ®çš„æ›´æ–°</li>
<li>å¯¹äºè¯»ï¼Œæ˜¯å…ˆè¯» cacheï¼Œå¦‚æœ cache missï¼Œåˆ™è¯» DBï¼ŒåŒæ—¶å°†æ•°æ®å›å†™åˆ° cache</li>
</ul>
<p>è¿™ç§æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œä¸šåŠ¡ç«¯å¤„ç†æ‰€æœ‰æ•°æ®è®¿é—®ç»†èŠ‚ï¼ŒåŒæ—¶åˆ©ç”¨ Lazy è®¡ç®—çš„æ€æƒ³ï¼Œæ›´æ–° DB åï¼Œç›´æ¥åˆ é™¤ cache å¹¶é€šè¿‡ DB æ›´æ–°ï¼Œç¡®ä¿æ•°æ®ä»¥ DB ç»“æœä¸ºå‡†ï¼Œåˆ™å¯ä»¥å¤§å¹…é™ä½ cache å’Œ DB ä¸­æ•°æ®ä¸ä¸€è‡´çš„æ¦‚ç‡ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ä¸“é—¨çš„å­˜å‚¨æœåŠ¡ï¼ŒåŒæ—¶æ˜¯å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„ä¸šåŠ¡ï¼Œæˆ–è€…æ˜¯ç¼“å­˜æ•°æ®æ›´æ–°æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡ï¼Œè¿™äº›æƒ…å†µéƒ½æ¯”è¾ƒé€‚åˆä½¿ç”¨ Cache Aside æ¨¡å¼ã€‚å¦‚å¾®åšå‘å±•åˆæœŸï¼Œä¸å°‘ä¸šåŠ¡é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œè¿™äº›ç¼“å­˜æ•°æ®éœ€è¦é€šè¿‡å¤šä¸ªåŸå§‹æ•°æ®è¿›è¡Œè®¡ç®—åè®¾ç½®ã€‚åœ¨éƒ¨åˆ†æ•°æ®å˜æ›´åï¼Œç›´æ¥åˆ é™¤ç¼“å­˜ã€‚åŒæ—¶ï¼Œä½¿ç”¨ä¸€ä¸ª Trigger ç»„ä»¶ï¼Œå®æ—¶è¯»å– DB çš„å˜æ›´æ—¥å¿—ï¼Œç„¶åé‡æ–°è®¡ç®—å¹¶æ›´æ–°ç¼“å­˜ã€‚å¦‚æœè¯»ç¼“å­˜çš„æ—¶å€™ï¼ŒTrigger è¿˜æ²¡å†™å…¥ cacheï¼Œåˆ™ç”±è°ƒç”¨æ–¹è‡ªè¡Œåˆ° DB åŠ è½½è®¡ç®—å¹¶å†™å…¥ cacheã€‚</p>
<blockquote>
<p>æ„Ÿè§‰ç›´æ¥ç”¨<code>@Cacheable</code>å’Œ<code>@CachePut</code>æ³¨è§£å°±åŸºæœ¬è¾¾åˆ°è¿™ä¸ªæ•ˆæœ</p>
</blockquote>
<h4 id="Read-Write-Through"><a href="#Read-Write-Through" class="headerlink" title="Read/Write Through"></a>Read/Write Through</h4><p><img src="http://image.leonote.cn//20201014202424.png" alt=""></p>
<p>å¦‚ä¸Šå›¾ï¼Œå¯¹äº Cache Aside æ¨¡å¼ï¼Œä¸šåŠ¡åº”ç”¨éœ€è¦åŒæ—¶ç»´æŠ¤ cache å’Œ DB ä¸¤ä¸ªæ•°æ®å­˜å‚¨æ–¹ï¼Œè¿‡äºç¹çï¼Œäºæ˜¯å°±æœ‰äº† Read/Write Through æ¨¡å¼ã€‚</p>
<p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸šåŠ¡åº”ç”¨åªå…³æ³¨ä¸€ä¸ªå­˜å‚¨æœåŠ¡å³å¯ï¼Œä¸šåŠ¡æ–¹çš„è¯»å†™ cache å’Œ DB çš„æ“ä½œï¼Œéƒ½ç”±å­˜å‚¨æœåŠ¡ä»£ç†ã€‚å­˜å‚¨æœåŠ¡æ”¶åˆ°ä¸šåŠ¡åº”ç”¨çš„å†™è¯·æ±‚æ—¶ï¼Œä¼šé¦–å…ˆæŸ¥ cacheï¼Œå¦‚æœæ•°æ®åœ¨ cache ä¸­ä¸å­˜åœ¨ï¼Œåˆ™åªæ›´æ–° DBï¼Œå¦‚æœæ•°æ®åœ¨ cache ä¸­å­˜åœ¨ï¼Œåˆ™å…ˆæ›´æ–° cacheï¼Œç„¶åæ›´æ–° DBã€‚è€Œå­˜å‚¨æœåŠ¡æ”¶åˆ°è¯»è¯·æ±‚æ—¶ï¼Œå¦‚æœå‘½ä¸­ cache ç›´æ¥è¿”å›ï¼Œå¦åˆ™å…ˆä» DB åŠ è½½ï¼Œå›ç§åˆ° cache åè¿”å›å“åº”ã€‚<strong>( cache ä¸ºå‡†)</strong></p>
<p>è¿™ç§æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œå­˜å‚¨æœåŠ¡å°è£…äº†æ‰€æœ‰çš„æ•°æ®å¤„ç†ç»†èŠ‚ï¼Œä¸šåŠ¡åº”ç”¨ç«¯ä»£ç åªç”¨å…³æ³¨ä¸šåŠ¡é€»è¾‘æœ¬èº«ï¼Œ<strong>ç³»ç»Ÿçš„éš”ç¦»æ€§æ›´ä½³</strong>ã€‚å¦å¤–ï¼Œè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå¦‚æœ cache ä¸­æ²¡æœ‰æ•°æ®åˆ™ä¸æ›´æ–°ï¼Œæœ‰ç¼“å­˜æ•°æ®æ‰æ›´æ–°ï¼Œ<strong>å†…å­˜æ•ˆç‡æ›´é«˜</strong>ã€‚</p>
<p>å¾®åš Feed çš„ Outbox Vectorï¼ˆå³ç”¨æˆ·æœ€æ–°å¾®åšåˆ—è¡¨ï¼‰å°±é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚ä¸€äº›ç²‰ä¸è¾ƒå°‘ä¸”ä¸æ´»è·ƒçš„ç”¨æˆ·å‘è¡¨å¾®åšåï¼ŒVector æœåŠ¡ä¼šé¦–å…ˆæŸ¥è¯¢ Vector Cacheï¼Œå¦‚æœ cache ä¸­æ²¡æœ‰è¯¥ç”¨æˆ·çš„ Outbox è®°å½•ï¼Œåˆ™ä¸å†™è¯¥ç”¨æˆ·çš„ cache æ•°æ®ï¼Œç›´æ¥æ›´æ–° DB åå°±è¿”å›ï¼Œåªæœ‰ cache ä¸­å­˜åœ¨æ‰ä¼šé€šè¿‡ CAS æŒ‡ä»¤è¿›è¡Œæ›´æ–°ã€‚</p>
<h4 id="Write-Behind-Caching"><a href="#Write-Behind-Caching" class="headerlink" title="Write Behind Caching"></a>Write Behind Caching</h4><p><img src="http://image.leonote.cn//20201014203613.png" alt=""></p>
<p>Write Behind Caching æ¨¡å¼ä¸ Read/Write Through æ¨¡å¼ç±»ä¼¼ï¼Œä¹Ÿç”±æ•°æ®å­˜å‚¨æœåŠ¡æ¥ç®¡ç† cache å’Œ DB çš„è¯»å†™ã€‚ä¸åŒç‚¹æ˜¯ï¼Œæ•°æ®æ›´æ–°æ—¶ï¼ŒRead/write Through æ˜¯åŒæ­¥æ›´æ–° cache å’Œ DBï¼Œè€Œ <strong>Write Behind Caching åˆ™æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–° DB</strong>ï¼Œè€Œæ˜¯æ”¹ä¸º<strong><em>å¼‚æ­¥æ‰¹é‡</em></strong>çš„æ–¹å¼æ¥æ›´æ–° DBã€‚è¯¥æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œ<em>æ•°æ®å­˜å‚¨çš„å†™æ€§èƒ½æœ€é«˜ï¼Œéå¸¸é€‚åˆä¸€äº›å˜æ›´ç‰¹åˆ«é¢‘ç¹çš„ä¸šåŠ¡</em>ï¼Œç‰¹åˆ«æ˜¯å¯ä»¥åˆå¹¶å†™è¯·æ±‚çš„ä¸šåŠ¡ï¼Œæ¯”å¦‚å¯¹ä¸€äº›è®¡æ•°ä¸šåŠ¡ï¼Œä¸€æ¡ Feed è¢«ç‚¹èµ 1ä¸‡ æ¬¡ï¼Œå¦‚æœæ›´æ–° 1ä¸‡ æ¬¡ DB ä»£ä»·å¾ˆå¤§ï¼Œè€Œåˆå¹¶æˆä¸€æ¬¡è¯·æ±‚ç›´æ¥åŠ  1ä¸‡ï¼Œåˆ™æ˜¯ä¸€ä¸ªéå¸¸è½»é‡çš„æ“ä½œã€‚ä½†è¿™ç§æ¨¡å‹æœ‰ä¸ªæ˜¾è‘—çš„ç¼ºç‚¹ï¼Œå³<em>æ•°æ®çš„ä¸€è‡´æ€§å˜å·®ï¼Œç”šè‡³åœ¨ä¸€äº›æç«¯åœºæ™¯ä¸‹å¯èƒ½ä¼šä¸¢å¤±æ•°æ®</em>ã€‚æ¯”å¦‚ç³»ç»Ÿ Crashã€æœºå™¨å®•æœºæ—¶ï¼Œå¦‚æœæœ‰æ•°æ®è¿˜æ²¡ä¿å­˜åˆ° DBï¼Œåˆ™ä¼šå­˜åœ¨ä¸¢å¤±çš„é£é™©ã€‚</p>
<blockquote>
<p>ğŸ“Œè¿™ç§è¯»å†™æ¨¡å¼é€‚åˆå˜æ›´é¢‘ç‡ç‰¹åˆ«é«˜ï¼Œä½†å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸å¤ªé«˜çš„ä¸šåŠ¡ï¼Œè¿™æ ·å†™æ“ä½œå¯ä»¥å¼‚æ­¥æ‰¹é‡å†™å…¥ DBï¼Œå‡å° DB å‹åŠ›ã€‚</p>
</blockquote>
<p>ä¸‰ç§æ¨¡å¼å„æœ‰ä¼˜åŠ£ï¼Œä¸å­˜åœ¨æœ€ä½³æ¨¡å¼ã€‚</p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿä¸å¯èƒ½è®¾è®¡å‡ºä¸€ä¸ªæœ€ä½³çš„å®Œç¾æ¨¡å¼å‡ºæ¥ï¼Œå¦‚åŒå‰é¢è®²åˆ°çš„ç©ºé—´æ¢æ—¶é—´ã€è®¿é—®å»¶è¿Ÿæ¢ä½æˆæœ¬ä¸€æ ·ï¼Œé«˜æ€§èƒ½å’Œå¼ºä¸€è‡´æ€§ä»æ¥éƒ½æ˜¯æœ‰å†²çªçš„ï¼Œç³»ç»Ÿè®¾è®¡ä»æ¥å°±æ˜¯å–èˆï¼Œéšå¤„éœ€è¦ trade-offã€‚</p>
<blockquote>
<p>é‡è¦çš„æ˜¯æ€æƒ³ï¼šå³å¦‚ä½•æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œæ›´å¥½çš„åš trade-offï¼Œä»è€Œè®¾è®¡å‡ºæ›´å¥½çš„æœåŠ¡ç³»ç»Ÿã€‚</p>
</blockquote>
<h3 id="ç¼“å­˜åˆ†ç±»åŠå¸¸ç”¨ç¼“å­˜ä»‹ç»"><a href="#ç¼“å­˜åˆ†ç±»åŠå¸¸ç”¨ç¼“å­˜ä»‹ç»" class="headerlink" title="ç¼“å­˜åˆ†ç±»åŠå¸¸ç”¨ç¼“å­˜ä»‹ç»"></a>ç¼“å­˜åˆ†ç±»åŠå¸¸ç”¨ç¼“å­˜ä»‹ç»</h3><h4 id="æŒ‰å®¿ä¸»å±‚æ¬¡åˆ†ç±»"><a href="#æŒ‰å®¿ä¸»å±‚æ¬¡åˆ†ç±»" class="headerlink" title="æŒ‰å®¿ä¸»å±‚æ¬¡åˆ†ç±»"></a>æŒ‰å®¿ä¸»å±‚æ¬¡åˆ†ç±»</h4><p>åˆ†ä¸ºæœ¬åœ° Cacheã€è¿›ç¨‹é—´ Cache å’Œè¿œç¨‹ Cacheã€‚</p>
<ul>
<li><p>æœ¬åœ° Cacheï¼šæ˜¯æŒ‡ä¸šåŠ¡è¿›ç¨‹å†…çš„ç¼“å­˜ï¼Œè¿™ç±»ç¼“å­˜ç”±äºåœ¨ä¸šåŠ¡ç³»ç»Ÿè¿›ç¨‹å†…ï¼Œæ‰€ä»¥è¯»å†™æ€§èƒ½è¶…é«˜ä¸”æ— ä»»ä½•ç½‘ç»œå¼€é”€ï¼Œä½†ä¸è¶³æ˜¯ä¼šéšç€ä¸šåŠ¡ç³»ç»Ÿé‡å¯è€Œä¸¢å¤±ã€‚</p>
</li>
<li><p>è¿›ç¨‹é—´ Cacheï¼šæ˜¯æœ¬æœºç‹¬ç«‹è¿è¡Œçš„ç¼“å­˜ï¼Œè¿™ç±»ç¼“å­˜è¯»å†™æ€§èƒ½è¾ƒé«˜ï¼Œä¸ä¼šéšç€ä¸šåŠ¡ç³»ç»Ÿé‡å¯ä¸¢æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥å¤§å¹…å‡å°‘ç½‘ç»œå¼€é”€ï¼Œä½†ä¸è¶³æ˜¯ä¸šåŠ¡ç³»ç»Ÿå’Œç¼“å­˜éƒ½åœ¨ç›¸åŒå®¿ä¸»æœºï¼Œè¿ç»´å¤æ‚ï¼Œä¸”å­˜åœ¨èµ„æºç«äº‰ã€‚( cache å’Œ project éƒ½åœ¨åŒä¸€ä¸ª Linux éƒ¨ç½² )</p>
</li>
<li><p>è¿œç¨‹ Cacheï¼šæ˜¯æŒ‡è·¨æœºå™¨éƒ¨ç½²çš„ç¼“å­˜ï¼Œè¿™ç±»ç¼“å­˜å› ä¸ºç‹¬ç«‹è®¾å¤‡éƒ¨ç½²ï¼Œå®¹é‡å¤§ä¸”æ˜“æ‰©å±•ï¼Œåœ¨äº’è”ç½‘ä¼ä¸šä½¿ç”¨æœ€å¹¿æ³›ã€‚ä¸è¿‡è¿œç¨‹ç¼“å­˜éœ€è¦è·¨æœºè®¿é—®ï¼Œåœ¨é«˜è¯»å†™å‹åŠ›ä¸‹ï¼Œå¸¦å®½å®¹æ˜“æˆä¸ºç“¶é¢ˆã€‚</p>
</li>
</ul>
<p>æœ¬åœ° Cache çš„ç¼“å­˜ç»„ä»¶æœ‰ Ehcacheã€Guava Cache ç­‰ï¼Œå¼€å‘è€…è‡ªå·±ä¹Ÿå¯ä»¥ç”¨ Mapã€Set ç­‰è½»æ¾æ„å»ºä¸€ä¸ªè‡ªå·±ä¸“ç”¨çš„æœ¬åœ° Cacheã€‚</p>
<p>è¿›ç¨‹é—´ Cache å’Œè¿œç¨‹ Cache çš„ç¼“å­˜ç»„ä»¶ç›¸åŒï¼Œåªæ˜¯éƒ¨ç½²ä½ç½®çš„å·®å¼‚ç½¢äº†ï¼Œè¿™ç±»ç¼“å­˜ç»„ä»¶æœ‰ Memcachedã€Redisã€Pika ç­‰ã€‚</p>
<h4 id="æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»"><a href="#æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»" class="headerlink" title="æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»"></a>æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»</h4><p>åˆ†ä¸ºå†…å­˜å‹ç¼“å­˜å’ŒæŒä¹…åŒ–å‹ç¼“å­˜ã€‚</p>
<ul>
<li><p>å†…å­˜å‹ç¼“å­˜å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼Œè¯»å†™æ€§èƒ½å¾ˆé«˜ï¼Œä½†ç¼“å­˜ç³»ç»Ÿé‡å¯æˆ– Crash åï¼Œå†…å­˜æ•°æ®ä¼šä¸¢å¤±ã€‚</p>
</li>
<li><p>æŒä¹…åŒ–å‹ç¼“å­˜å°†æ•°æ®å­˜å‚¨åˆ° SSD/Fusion-IO ç¡¬ç›˜ä¸­ï¼Œç›¸åŒæˆæœ¬ä¸‹ï¼Œè¿™ç§ç¼“å­˜çš„å®¹é‡ä¼šæ¯”å†…å­˜å‹ç¼“å­˜å¤§ 1 ä¸ªæ•°é‡çº§ä»¥ä¸Šï¼Œè€Œä¸”æ•°æ®ä¼šæŒä¹…åŒ–è½åœ°ï¼Œé‡å¯ä¸ä¸¢å¤±ï¼Œä½†è¯»å†™æ€§èƒ½ç›¸å¯¹ä½ 1ï½2 ä¸ªæ•°é‡çº§ã€‚Memcached æ˜¯å…¸å‹çš„å†…å­˜å‹ç¼“å­˜ï¼Œè€Œ Pika ä»¥åŠå…¶ä»–åŸºäº RocksDB å¼€å‘çš„ç¼“å­˜ç»„ä»¶ç­‰åˆ™å±äºæŒä¹…åŒ–å‹ç¼“å­˜ã€‚</p>
</li>
</ul>
<h2 id="è®¾è®¡ç¼“å­˜æ¶æ„æ—¶éœ€è¦è€ƒé‡å“ªäº›å› ç´ "><a href="#è®¾è®¡ç¼“å­˜æ¶æ„æ—¶éœ€è¦è€ƒé‡å“ªäº›å› ç´ " class="headerlink" title="è®¾è®¡ç¼“å­˜æ¶æ„æ—¶éœ€è¦è€ƒé‡å“ªäº›å› ç´ "></a>è®¾è®¡ç¼“å­˜æ¶æ„æ—¶éœ€è¦è€ƒé‡å“ªäº›å› ç´ </h2><h3 id="ç¼“å­˜çš„å¼•å…¥åŠæ¶æ„è®¾è®¡"><a href="#ç¼“å­˜çš„å¼•å…¥åŠæ¶æ„è®¾è®¡" class="headerlink" title="ç¼“å­˜çš„å¼•å…¥åŠæ¶æ„è®¾è®¡"></a>ç¼“å­˜çš„å¼•å…¥åŠæ¶æ„è®¾è®¡</h3><h4 id="ç¼“å­˜ç»„ä»¶é€‰æ‹©"><a href="#ç¼“å­˜ç»„ä»¶é€‰æ‹©" class="headerlink" title="ç¼“å­˜ç»„ä»¶é€‰æ‹©"></a>ç¼“å­˜ç»„ä»¶é€‰æ‹©</h4><p>åœ¨è®¾è®¡æ¶æ„ç¼“å­˜æ—¶ï¼Œé¦–å…ˆè¦é€‰å®šç¼“å­˜ç»„ä»¶ï¼Œæ¯”å¦‚è¦ç”¨ Local-Cacheï¼Œè¿˜æ˜¯ Redisã€Memcachedã€Pika ç­‰å¼€æºç¼“å­˜ç»„ä»¶ï¼Œå¦‚æœä¸šåŠ¡ç¼“å­˜éœ€æ±‚æ¯”è¾ƒç‰¹æ®Šï¼Œè¿˜è¦è€ƒè™‘æ˜¯ç›´æ¥å®šåˆ¶å¼€å‘ä¸€ä¸ªæ–°çš„ç¼“å­˜ç»„ä»¶ï¼Œè¿˜æ˜¯å¯¹å¼€æºç¼“å­˜è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ¥æ»¡è¶³ä¸šåŠ¡éœ€è¦ã€‚</p>
<h4 id="ç¼“å­˜æ•°æ®ç»“æ„è®¾è®¡"><a href="#ç¼“å­˜æ•°æ®ç»“æ„è®¾è®¡" class="headerlink" title="ç¼“å­˜æ•°æ®ç»“æ„è®¾è®¡"></a>ç¼“å­˜æ•°æ®ç»“æ„è®¾è®¡</h4><p>ç¡®å®šå¥½ç¼“å­˜ç»„ä»¶åï¼Œè¿˜è¦æ ¹æ®ä¸šåŠ¡è®¿é—®çš„ç‰¹ç‚¹ï¼Œè¿›è¡Œç¼“å­˜æ•°æ®ç»“æ„çš„è®¾è®¡ã€‚</p>
<p>å¯¹äºç›´æ¥ç®€å• KV è¯»å†™çš„ä¸šåŠ¡ï¼Œä½ å¯ä»¥å°†è¿™äº›ä¸šåŠ¡æ•°æ®å°è£…ä¸º Stringã€Jsonã€Protocol Buffer ç­‰æ ¼å¼ï¼Œåºåˆ—åŒ–æˆå­—èŠ‚åºåˆ—ï¼Œç„¶åç›´æ¥å†™å…¥ç¼“å­˜ä¸­ã€‚è¯»å–æ—¶ï¼Œå…ˆä»ç¼“å­˜ç»„ä»¶è·å–åˆ°æ•°æ®çš„å­—èŠ‚åºåˆ—ï¼Œå†è¿›è¡Œååºåˆ—åŒ–æ“ä½œå³å¯ã€‚å¯¹äºåªéœ€è¦å­˜å–éƒ¨åˆ†å­—æ®µæˆ–éœ€è¦åœ¨ç¼“å­˜ç«¯è¿›è¡Œè®¡ç®—çš„ä¸šåŠ¡ï¼Œå¯ä»¥æŠŠæ•°æ®è®¾è®¡ä¸º Hashã€Setã€Listã€Geo ç­‰ç»“æ„ï¼Œå­˜å‚¨åˆ°æ”¯æŒå¤æ‚é›†åˆæ•°æ®ç±»å‹çš„ç¼“å­˜ä¸­ï¼Œå¦‚ Redisã€Pika ç­‰ã€‚</p>
<h4 id="ç¼“å­˜åˆ†å¸ƒè®¾è®¡"><a href="#ç¼“å­˜åˆ†å¸ƒè®¾è®¡" class="headerlink" title="ç¼“å­˜åˆ†å¸ƒè®¾è®¡"></a>ç¼“å­˜åˆ†å¸ƒè®¾è®¡</h4><p>ç¡®å®šäº†ç¼“å­˜ç»„ä»¶ï¼Œè®¾è®¡å¥½äº†ç¼“å­˜æ•°æ®ç»“æ„ï¼Œæ¥ä¸‹æ¥å°±è¦è®¾è®¡ç¼“å­˜çš„åˆ†å¸ƒã€‚å¯ä»¥ä» 3 ä¸ªç»´åº¦æ¥è¿›è¡Œç¼“å­˜åˆ†å¸ƒè®¾è®¡ã€‚</p>
<ul>
<li><p>é¦–å…ˆï¼Œè¦é€‰æ‹©åˆ†å¸ƒå¼ç®—æ³•ï¼Œæ˜¯é‡‡ç”¨<strong>å–æ¨¡</strong>è¿˜æ˜¯<strong>ä¸€è‡´æ€§ Hash</strong> è¿›è¡Œåˆ†å¸ƒã€‚å–æ¨¡åˆ†å¸ƒçš„æ–¹æ¡ˆç®€å•ï¼Œæ¯ä¸ª key åªä¼šå­˜åœ¨ç¡®å®šçš„ç¼“å­˜èŠ‚ç‚¹ï¼Œä¸€è‡´æ€§ Hash åˆ†å¸ƒçš„æ–¹æ¡ˆç›¸å¯¹å¤æ‚ï¼Œä¸€ä¸ª key å¯¹åº”çš„ç¼“å­˜èŠ‚ç‚¹ä¸ç¡®å®šã€‚ä½†ä¸€è‡´æ€§ Hash åˆ†å¸ƒï¼Œå¯ä»¥åœ¨éƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œå°†å¤±æ•ˆèŠ‚ç‚¹çš„æ•°æ®è®¿é—®å‡è¡¡åˆ†æ•£åˆ°å…¶ä»–æ­£å¸¸å­˜æ´»çš„èŠ‚ç‚¹ï¼Œä»è€Œæ›´å¥½åœ°ä¿è¯äº†ç¼“å­˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚</p>
</li>
<li><p>å…¶æ¬¡ï¼Œåˆ†å¸ƒè¯»å†™è®¿é—®å¦‚ä½•è¿›è¡Œå®æ–½ï¼Œæ˜¯ç”±ç¼“å­˜ Client ç›´æ¥è¿›è¡Œ <strong>Hash åˆ†å¸ƒå®šä½è¯»å†™</strong>ï¼Œè¿˜æ˜¯é€šè¿‡ <strong>Proxy ä»£ç†æ¥è¿›è¡Œè¯»å†™</strong>è·¯ç”±ï¼ŸClient ç›´æ¥è¯»å†™ï¼Œè¯»å†™æ€§èƒ½æœ€ä½³ï¼Œä½†éœ€è¦ Client æ„ŸçŸ¥åˆ†å¸ƒç­–ç•¥ã€‚åœ¨ç¼“å­˜éƒ¨ç½²å‘ç”Ÿåœ¨çº¿å˜åŒ–æ—¶ï¼Œä¹Ÿéœ€è¦åŠæ—¶é€šçŸ¥æ‰€æœ‰ç¼“å­˜ Clientï¼Œé¿å…è¯»å†™å¼‚å¸¸ï¼Œå¦å¤–ï¼ŒClient å®ç°ä¹Ÿè¾ƒå¤æ‚ã€‚è€Œé€šè¿‡ Proxy è·¯ç”±ï¼ŒClient åªéœ€ç›´æ¥è®¿é—® Proxyï¼Œåˆ†å¸ƒé€»è¾‘åŠéƒ¨ç½²å˜æ›´éƒ½ç”± Proxy æ¥å¤„ç†ï¼Œå¯¹ä¸šåŠ¡åº”ç”¨å¼€å‘æœ€å‹å¥½ï¼Œä½†ä¸šåŠ¡è®¿é—®å¤šä¸€è·³ï¼Œè®¿é—®æ€§èƒ½ä¼šæœ‰ä¸€å®šçš„æŸå¤±ã€‚</p>
</li>
<li><p>æœ€åï¼Œç¼“å­˜ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœå¾…ç¼“å­˜çš„æ•°æ®é‡å¢é•¿è¿‡å¿«ï¼Œä¼šå¯¼è‡´å¤§é‡ç¼“å­˜æ•°æ®è¢«å‰”é™¤ï¼Œç¼“å­˜å‘½ä¸­ç‡ä¼šä¸‹é™ï¼Œæ•°æ®è®¿é—®æ€§èƒ½ä¼šéšä¹‹é™ä½ï¼Œè¿™æ ·å°±éœ€è¦å°†æ•°æ®ä»ç¼“å­˜èŠ‚ç‚¹è¿›è¡ŒåŠ¨æ€æ‹†åˆ†ï¼ŒæŠŠéƒ¨åˆ†æ•°æ®æ°´å¹³è¿ç§»åˆ°å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ã€‚è¿™ä¸ªè¿ç§»è¿‡ç¨‹éœ€è¦è€ƒè™‘ï¼Œæ˜¯ç”± Proxy è¿›è¡Œè¿ç§»è¿˜æ˜¯ç¼“å­˜ Server è‡ªèº«è¿›è¡Œè¿ç§»ï¼Œç”šè‡³æ ¹æœ¬å°±ä¸æ”¯æŒè¿ç§»ã€‚å¯¹äº Memcachedï¼Œä¸€èˆ¬ä¸æ”¯æŒè¿ç§»ï¼Œå¯¹ Redisï¼Œç¤¾åŒºç‰ˆæœ¬æ˜¯ä¾é ç¼“å­˜ Server è¿›è¡Œè¿ç§»ï¼Œè€Œå¯¹ Codis åˆ™æ˜¯é€šè¿‡ Adminã€Proxy é…åˆåç«¯ç¼“å­˜ç»„ä»¶è¿›è¡Œè¿ç§»ã€‚</p>
</li>
</ul>
<h4 id="ç¼“å­˜æ¶æ„éƒ¨ç½²åŠè¿ç»´ç®¡ç†"><a href="#ç¼“å­˜æ¶æ„éƒ¨ç½²åŠè¿ç»´ç®¡ç†" class="headerlink" title="ç¼“å­˜æ¶æ„éƒ¨ç½²åŠè¿ç»´ç®¡ç†"></a>ç¼“å­˜æ¶æ„éƒ¨ç½²åŠè¿ç»´ç®¡ç†</h4><p>è®¾è®¡å®Œæ¯•ç¼“å­˜çš„åˆ†å¸ƒç­–ç•¥åï¼Œæ¥ä¸‹æ¥å°±è¦è€ƒè™‘ç¼“å­˜çš„æ¶æ„éƒ¨ç½²åŠè¿ç»´ç®¡ç†äº†ã€‚æ¶æ„éƒ¨ç½²ä¸»è¦è€ƒè™‘å¦‚ä½•å¯¹ç¼“å­˜è¿›è¡Œåˆ†æ± ã€åˆ†å±‚ã€åˆ† IDCï¼Œä»¥åŠæ˜¯å¦éœ€è¦è¿›è¡Œå¼‚æ„å¤„ç†ã€‚</p>
<ol>
<li><p>æ ¸å¿ƒçš„ã€é«˜å¹¶å‘è®¿é—®çš„ä¸åŒæ•°æ®ï¼Œéœ€è¦åˆ†åˆ«åˆ†æ‹†åˆ°ç‹¬ç«‹çš„ç¼“å­˜æ± ä¸­ï¼Œè¿›è¡Œåˆ†åˆ«è®¿é—®ï¼Œé¿å…ç›¸äº’å½±å“ï¼›è®¿é—®é‡è¾ƒå°ã€éæ ¸å¿ƒçš„ä¸šåŠ¡æ•°æ®ï¼Œåˆ™å¯ä»¥æ··å­˜ã€‚</p>
</li>
<li><p>å¯¹æµ·é‡æ•°æ®ã€è®¿é—®è¶…è¿‡ 10ï½100ä¸‡ çº§çš„ä¸šåŠ¡æ•°æ®ï¼Œè¦è€ƒè™‘åˆ†å±‚è®¿é—®ï¼Œå¹¶ä¸”è¦åˆ†æ‘Šè®¿é—®é‡ï¼Œé¿å…ç¼“å­˜è¿‡è½½ã€‚</p>
</li>
<li><p>å¦‚æœä¸šåŠ¡ç³»ç»Ÿéœ€è¦å¤š IDC éƒ¨ç½²ç”šè‡³å¼‚åœ°å¤šæ´»ï¼Œåˆ™éœ€è¦å¯¹ç¼“å­˜ä½“ç³»ä¹Ÿè¿›è¡Œå¤š IDC éƒ¨ç½²ï¼Œè¦è€ƒè™‘å¦‚ä½•è·¨ IDC å¯¹ç¼“å­˜æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå¯ä»¥é‡‡ç”¨ç›´æ¥è·¨ IDC è¯»å†™ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ DataBus é…åˆé˜Ÿåˆ—æœºè¿›è¡Œä¸åŒ IDC çš„æ¶ˆæ¯åŒæ­¥ï¼Œç„¶åç”±æ¶ˆæ¯å¤„ç†æœºè¿›è¡Œç¼“å­˜æ›´æ–°ï¼Œè¿˜å¯ä»¥ç”±å„ä¸ª IDC çš„ DB Trigger è¿›è¡Œç¼“å­˜æ›´æ–°ã€‚</p>
</li>
<li><p>æŸäº›æç«¯åœºæ™¯ä¸‹ï¼Œè¿˜éœ€è¦æŠŠå¤šç§ç¼“å­˜ç»„ä»¶è¿›è¡Œç»„åˆä½¿ç”¨ï¼Œé€šè¿‡ç¼“å­˜å¼‚æ„è¾¾åˆ°æœ€ä½³è¯»å†™æ€§èƒ½ã€‚</p>
</li>
<li><p>ç«™åœ¨ç³»ç»Ÿå±‚é¢ï¼Œè¦æƒ³æ›´å¥½å¾—ç®¡ç†ç¼“å­˜ï¼Œè¿˜è¦è€ƒè™‘ç¼“å­˜çš„æœåŠ¡åŒ–ï¼Œè€ƒè™‘ç¼“å­˜ä½“ç³»å¦‚ä½•æ›´å¥½å¾—è¿›è¡Œé›†ç¾¤ç®¡ç†ã€ç›‘æ§è¿ç»´ç­‰ã€‚</p>
</li>
</ol>
<h3 id="ç¼“å­˜è®¾è®¡æ¶æ„çš„å¸¸è§è€ƒé‡ç‚¹"><a href="#ç¼“å­˜è®¾è®¡æ¶æ„çš„å¸¸è§è€ƒé‡ç‚¹" class="headerlink" title="ç¼“å­˜è®¾è®¡æ¶æ„çš„å¸¸è§è€ƒé‡ç‚¹"></a>ç¼“å­˜è®¾è®¡æ¶æ„çš„å¸¸è§è€ƒé‡ç‚¹</h3><p>åœ¨ç¼“å­˜è®¾è®¡æ¶æ„çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€äº›éå¸¸é‡è¦çš„è€ƒé‡ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåªæœ‰åˆ†ææ¸…æ¥šäº†è¿™äº›è€ƒé‡ç‚¹ï¼Œæ‰èƒ½è®¾è®¡æ¶æ„å‡ºæ›´ä½³çš„ç¼“å­˜ä½“ç³»ã€‚   </p>
<p><img src="http://image.leonote.cn//20201014211812.png" alt=""></p>
<h4 id="è¯»å†™æ–¹å¼"><a href="#è¯»å†™æ–¹å¼" class="headerlink" title="è¯»å†™æ–¹å¼"></a>è¯»å†™æ–¹å¼</h4><p>é¦–å…ˆæ˜¯ value çš„è¯»å†™æ–¹å¼ã€‚æ˜¯å…¨éƒ¨æ•´ä½“è¯»å†™ï¼Œè¿˜æ˜¯åªéƒ¨åˆ†è¯»å†™åŠå˜æ›´ï¼Ÿæ˜¯å¦éœ€è¦å†…éƒ¨è®¡ç®—ï¼Ÿæ¯”å¦‚ï¼Œç”¨æˆ·ç²‰ä¸æ•°ï¼Œå¾ˆå¤šæ™®é€šç”¨æˆ·çš„ç²‰ä¸æœ‰å‡ åƒåˆ°å‡ ä¸‡ï¼Œè€Œå¤§ V çš„ç²‰ä¸æ›´æ˜¯é«˜è¾¾å‡ åƒä¸‡ç”šè‡³è¿‡äº¿ï¼Œå› æ­¤ï¼Œè·å–ç²‰ä¸åˆ—è¡¨è‚¯å®šä¸èƒ½é‡‡ç”¨æ•´ä½“è¯»å†™çš„æ–¹å¼ï¼Œåªèƒ½éƒ¨åˆ†è·å–ã€‚å¦å¤–åœ¨åˆ¤æ–­æŸç”¨æˆ·æ˜¯å¦å…³æ³¨äº†å¦å¤–ä¸€ä¸ªç”¨æˆ·æ—¶ï¼Œä¹Ÿä¸éœ€è¦æ‹‰å–è¯¥ç”¨æˆ·çš„å…¨éƒ¨å…³æ³¨åˆ—è¡¨ï¼Œç›´æ¥åœ¨å…³æ³¨åˆ—è¡¨ä¸Šè¿›è¡Œæ£€æŸ¥åˆ¤æ–­ï¼Œç„¶åè¿”å› True/False æˆ– 0/1 çš„æ–¹å¼æ›´ä¸ºé«˜æ•ˆã€‚</p>
<h4 id="KV-size"><a href="#KV-size" class="headerlink" title="KV size"></a>KV size</h4><p>ç„¶åæ˜¯ä¸åŒä¸šåŠ¡æ•°æ®ç¼“å­˜ KV çš„ sizeã€‚å¦‚æœå•ä¸ªä¸šåŠ¡çš„ KV size è¿‡å¤§ï¼Œéœ€è¦åˆ†æ‹†æˆå¤šä¸ª KV æ¥ç¼“å­˜ã€‚ä½†æ˜¯ï¼Œä¸åŒç¼“å­˜æ•°æ®çš„ KV size å¦‚æœå·®å¼‚è¿‡å¤§ï¼Œä¹Ÿä¸èƒ½ç¼“å­˜åœ¨ä¸€èµ·ï¼Œé¿å…ç¼“å­˜æ•ˆç‡çš„ä½ä¸‹å’Œç›¸äº’å½±å“ã€‚</p>
<h4 id="key-çš„æ•°é‡"><a href="#key-çš„æ•°é‡" class="headerlink" title="key çš„æ•°é‡"></a>key çš„æ•°é‡</h4><p>key çš„æ•°é‡ä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦è€ƒè™‘å› ç´ ã€‚å¦‚æœ key æ•°é‡ä¸å¤§ï¼Œå¯ä»¥åœ¨ç¼“å­˜ä¸­å­˜ä¸‹å…¨é‡æ•°æ®ï¼ŒæŠŠç¼“å­˜å½“ DB å­˜å‚¨æ¥ç”¨ï¼Œå¦‚æœç¼“å­˜è¯»å– missï¼Œåˆ™è¡¨æ˜æ•°æ®ä¸å­˜åœ¨ï¼Œæ ¹æœ¬ä¸éœ€è¦å†å» DB æŸ¥è¯¢ã€‚å¦‚æœæ•°æ®é‡å·¨å¤§ï¼Œåˆ™åœ¨ç¼“å­˜ä¸­å°½å¯èƒ½åªä¿ç•™é¢‘ç¹è®¿é—®çš„çƒ­æ•°æ®ï¼Œå¯¹äºå†·æ•°æ®ç›´æ¥è®¿é—® DBã€‚</p>
<h4 id="è¯»å†™å³°å€¼"><a href="#è¯»å†™å³°å€¼" class="headerlink" title="è¯»å†™å³°å€¼"></a>è¯»å†™å³°å€¼</h4><p>å¦å¤–ï¼Œå¯¹ç¼“å­˜æ•°æ®çš„è¯»å†™å³°å€¼ï¼Œå¦‚æœå°äº 10ä¸‡ çº§åˆ«ï¼Œç®€å•åˆ†æ‹†åˆ°ç‹¬ç«‹ Cache æ± å³å¯ã€‚è€Œä¸€æ—¦æ•°æ®çš„è¯»å†™å³°å€¼è¶…è¿‡ 10ä¸‡ ç”šè‡³åˆ°è¾¾ 100ä¸‡ çº§çš„QPSï¼Œåˆ™éœ€è¦å¯¹ Cache è¿›è¡Œåˆ†å±‚å¤„ç†ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ Local-Cache é…åˆè¿œç¨‹ cacheï¼Œç”šè‡³è¿œç¨‹ç¼“å­˜å†…éƒ¨ç»§ç»­åˆ†å±‚å åŠ åˆ†æ± è¿›è¡Œå¤„ç†ã€‚å¾®åšä¸šåŠ¡ä¸­ï¼Œå¤§å¤šæ•°æ ¸å¿ƒä¸šåŠ¡çš„ Memcached è®¿é—®éƒ½é‡‡ç”¨çš„è¿™ç§å¤„ç†æ–¹å¼ã€‚</p>
<h4 id="å‘½ä¸­ç‡"><a href="#å‘½ä¸­ç‡" class="headerlink" title="å‘½ä¸­ç‡"></a>å‘½ä¸­ç‡</h4><p>ç¼“å­˜çš„å‘½ä¸­ç‡å¯¹æ•´ä¸ªæœåŠ¡ä½“ç³»çš„æ€§èƒ½å½±å“ç”šå¤§ã€‚å¯¹äºæ ¸å¿ƒé«˜å¹¶å‘è®¿é—®çš„ä¸šåŠ¡ï¼Œéœ€è¦é¢„ç•™è¶³å¤Ÿçš„å®¹é‡ï¼Œç¡®ä¿æ ¸å¿ƒä¸šåŠ¡ç¼“å­˜ç»´æŒè¾ƒé«˜çš„å‘½ä¸­ç‡ã€‚æ¯”å¦‚å¾®åšä¸­çš„ Feed Vector Cacheï¼Œå¸¸å¹´çš„å‘½ä¸­ç‡é«˜è¾¾ 99.5% ä»¥ä¸Šã€‚ä¸ºäº†æŒç»­ä¿æŒç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œç¼“å­˜ä½“ç³»éœ€è¦æŒç»­ç›‘æ§ï¼ŒåŠæ—¶è¿›è¡Œæ•…éšœå¤„ç†æˆ–æ•…éšœè½¬ç§»ã€‚åŒæ—¶åœ¨éƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹å¼‚å¸¸ã€å‘½ä¸­ç‡ä¸‹é™æ—¶ï¼Œæ•…éšœè½¬ç§»æ–¹æ¡ˆï¼Œéœ€è¦è€ƒè™‘æ˜¯é‡‡ç”¨ä¸€è‡´æ€§ Hash åˆ†å¸ƒçš„è®¿é—®æ¼‚ç§»ç­–ç•¥ï¼Œè¿˜æ˜¯é‡‡ç”¨æ•°æ®å¤šå±‚å¤‡ä»½ç­–ç•¥ã€‚</p>
<h4 id="è¿‡æœŸç­–ç•¥"><a href="#è¿‡æœŸç­–ç•¥" class="headerlink" title="è¿‡æœŸç­–ç•¥"></a>è¿‡æœŸç­–ç•¥</h4><ul>
<li><p>å¯ä»¥è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè®©å†· key è‡ªåŠ¨è¿‡æœŸï¼›</p>
</li>
<li><p>ä¹Ÿå¯ä»¥è®© key å¸¦ä¸Šæ—¶é—´æˆ³ï¼ŒåŒæ—¶è®¾ç½®è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚å¾ˆå¤šä¸šåŠ¡ç³»ç»Ÿå†…éƒ¨æœ‰è¿™æ ·ä¸€äº› <code>key:key_20190801</code>ã€‚</p>
</li>
</ul>
<h4 id="å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´"><a href="#å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´" class="headerlink" title="å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´"></a>å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´</h4><p>å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´åœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ä¹Ÿå¾ˆé‡è¦ï¼Œå¯¹äºä¸€äº›ç¼“å­˜ç©¿é€åï¼ŒåŠ è½½æ—¶é—´ç‰¹åˆ«é•¿æˆ–è€…éœ€è¦å¤æ‚è®¡ç®—çš„æ•°æ®ï¼Œè€Œä¸”è®¿é—®é‡è¿˜æ¯”è¾ƒå¤§çš„ä¸šåŠ¡æ•°æ®ï¼Œè¦é…ç½®æ›´å¤šå®¹é‡ï¼Œç»´æŒæ›´é«˜çš„å‘½ä¸­ç‡ï¼Œä»è€Œå‡å°‘ç©¿é€åˆ° DB çš„æ¦‚ç‡ï¼Œæ¥ç¡®ä¿æ•´ä¸ªç³»ç»Ÿçš„è®¿é—®æ€§èƒ½ã€‚</p>
<h4 id="ç¼“å­˜å¯è¿ç»´æ€§"><a href="#ç¼“å­˜å¯è¿ç»´æ€§" class="headerlink" title="ç¼“å­˜å¯è¿ç»´æ€§"></a>ç¼“å­˜å¯è¿ç»´æ€§</h4><p>å¯¹äºç¼“å­˜çš„å¯è¿ç»´æ€§è€ƒè™‘ï¼Œåˆ™éœ€è¦è€ƒè™‘ç¼“å­˜ä½“ç³»çš„é›†ç¾¤ç®¡ç†ï¼Œå¦‚ä½•è¿›è¡Œä¸€é”®æ‰©ç¼©å®¹ï¼Œå¦‚ä½•è¿›è¡Œç¼“å­˜ç»„ä»¶çš„å‡çº§å’Œå˜æ›´ï¼Œå¦‚ä½•å¿«é€Ÿå‘ç°å¹¶å®šä½é—®é¢˜ï¼Œå¦‚ä½•æŒç»­ç›‘æ§æŠ¥è­¦ï¼Œæœ€å¥½æœ‰ä¸€ä¸ªå®Œå–„çš„è¿ç»´å¹³å°ï¼Œå°†å„ç§è¿ç»´å·¥å…·è¿›è¡Œé›†æˆã€‚</p>
<h4 id="ç¼“å­˜å®‰å…¨æ€§"><a href="#ç¼“å­˜å®‰å…¨æ€§" class="headerlink" title="ç¼“å­˜å®‰å…¨æ€§"></a>ç¼“å­˜å®‰å…¨æ€§</h4><p>å¯¹äºç¼“å­˜çš„å®‰å…¨æ€§è€ƒè™‘ï¼Œä¸€æ–¹é¢å¯ä»¥é™åˆ¶æ¥æº IPï¼Œåªå…è®¸å†…ç½‘è®¿é—®ï¼ŒåŒæ—¶å¯¹äºä¸€äº›å…³é”®æ€§æŒ‡ä»¤ï¼Œéœ€è¦å¢åŠ è®¿é—®æƒé™ï¼Œé¿å…è¢«æ”»å‡»æˆ–è¯¯æ“ä½œæ—¶ï¼Œå¯¼è‡´é‡å¤§åæœã€‚</p>
]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼“å­˜è®¿é—®ç›¸å…³çš„ç»å…¸é—®é¢˜</title>
    <url>/2021/02/07/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-%E7%BC%93%E5%AD%98%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E7%9A%84%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="ç¼“å­˜è®¿é—®ç›¸å…³çš„ç»å…¸é—®é¢˜"><a href="#ç¼“å­˜è®¿é—®ç›¸å…³çš„ç»å…¸é—®é¢˜" class="headerlink" title="ç¼“å­˜è®¿é—®ç›¸å…³çš„ç»å…¸é—®é¢˜"></a>ç¼“å­˜è®¿é—®ç›¸å…³çš„ç»å…¸é—®é¢˜</h1><p>å®é™…ä¸Šï¼Œåœ¨ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡æ¶æ„ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šå‘ï¼Œå¾ˆå¤šçš„æ˜æªæš—ç®­ï¼Œå¦‚æœè®¾è®¡ä¸å½“ä¼šå¯¼è‡´å¾ˆå¤šä¸¥é‡çš„åæœã€‚</p>
<p>è®¾è®¡ä¸å½“ï¼š</p>
<ul>
<li>è½»åˆ™è¯·æ±‚å˜æ…¢ã€æ€§èƒ½é™ä½</li>
<li>é‡åˆ™ä¼šæ•°æ®ä¸ä¸€è‡´ã€ç³»ç»Ÿå¯ç”¨æ€§é™ä½ï¼Œç”šè‡³ä¼šå¯¼è‡´ç¼“å­˜é›ªå´©ï¼Œæ•´ä¸ªç³»ç»Ÿæ— æ³•å¯¹å¤–æä¾›æœåŠ¡</li>
</ul>
<p>ç¼“å­˜ä¸ƒå¤§ç»å…¸é—®é¢˜ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p> <img src="http://image.leonote.cn//20210206170529.jpg" alt=""></p>
<h2 id="ç¼“å­˜å¤±æ•ˆ"><a href="#ç¼“å­˜å¤±æ•ˆ" class="headerlink" title="ç¼“å­˜å¤±æ•ˆ"></a>ç¼“å­˜å¤±æ•ˆ</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>ç¼“å­˜ç¬¬ä¸€ä¸ªç»å…¸é—®é¢˜æ˜¯ç¼“å­˜å¤±æ•ˆã€‚</p>
<p>æœåŠ¡ç³»ç»ŸæŸ¥æ•°æ®ï¼Œé¦–å…ˆä¼šæŸ¥ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå°±è¿›ä¸€æ­¥æŸ¥ DBï¼Œæœ€åæŸ¥åˆ°æ•°æ®åå›ç§åˆ°ç¼“å­˜å¹¶è¿”å›ã€‚ç¼“å­˜çš„æ€§èƒ½æ¯” DB é«˜ 50<del>100 å€ä»¥ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æ•°æ®æŸ¥è¯¢å°½å¯èƒ½å‘½ä¸­ç¼“å­˜ï¼Œè¿™æ ·ç³»ç»Ÿè´Ÿè·æœ€å°ï¼Œæ€§èƒ½æœ€ä½³ã€‚ç¼“å­˜é‡Œçš„æ•°æ®å­˜å‚¨åŸºæœ¬ä¸Šéƒ½æ˜¯ä»¥ key ä¸ºç´¢å¼•è¿›è¡Œå­˜å‚¨å’Œè·å–çš„ã€‚ä¸šåŠ¡è®¿é—®æ—¶ï¼Œå¦‚æœå¤§é‡çš„ key åŒæ—¶è¿‡æœŸï¼Œå¾ˆå¤šç¼“å­˜æ•°æ®è®¿é—®éƒ½ä¼š missï¼Œè¿›è€Œç©¿é€åˆ° DBï¼ŒDB çš„å‹åŠ›å°±ä¼šæ˜æ˜¾ä¸Šå‡ï¼Œç”±äº DB çš„æ€§èƒ½è¾ƒå·®ï¼Œåªåœ¨ç¼“å­˜çš„ 1%</del>2% ä»¥ä¸‹ï¼Œè¿™æ ·è¯·æ±‚çš„<strong>æ…¢æŸ¥ç‡</strong>ä¼šæ˜æ˜¾ä¸Šå‡ã€‚è¿™å°±æ˜¯ç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ã€‚</p>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>å¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼Œç‰¹åˆ«æ˜¯å¾ˆå¤š key ä¸€èµ·å¤±æ•ˆçš„åŸå› ï¼Œè·Ÿæˆ‘ä»¬æ—¥å¸¸å†™<strong>ç¼“å­˜çš„è¿‡æœŸæ—¶é—´</strong>æ¯æ¯ç›¸å…³ã€‚</p>
<p>åœ¨å†™ç¼“å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæ ¹æ®ä¸šåŠ¡çš„è®¿é—®ç‰¹ç‚¹ï¼Œç»™<strong>æ¯ç§ä¸šåŠ¡æ•°æ®é¢„ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´</strong>ï¼Œåœ¨å†™ç¼“å­˜æ—¶æŠŠè¿™ä¸ªè¿‡æœŸæ—¶é—´å¸¦ä¸Šï¼Œè®©ç¼“å­˜æ•°æ®åœ¨è¿™ä¸ªå›ºå®šçš„è¿‡æœŸæ—¶é—´åè¢«æ·˜æ±°ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå› ä¸ºç¼“å­˜æ•°æ®æ˜¯é€æ­¥å†™å…¥çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é€æ­¥è¿‡æœŸè¢«æ·˜æ±°çš„ã€‚ä½†åœ¨æŸäº›åœºæ™¯ï¼Œä¸€å¤§æ‰¹æ•°æ®ä¼šè¢«ç³»ç»Ÿä¸»åŠ¨æˆ–è¢«åŠ¨ä» DB æ‰¹é‡åŠ è½½ï¼Œç„¶åå†™å…¥ç¼“å­˜ã€‚è¿™äº›æ•°æ®å†™å…¥ç¼“å­˜æ—¶ï¼Œç”±äºä½¿ç”¨ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨ç»å†è¿™ä¸ªè¿‡æœŸæ—¶é—´ä¹‹åï¼Œè¿™æ‰¹æ•°æ®å°±ä¼šä¸€èµ·åˆ°æœŸï¼Œä»è€Œè¢«ç¼“å­˜æ·˜æ±°ã€‚æ­¤æ—¶ï¼Œå¯¹è¿™æ‰¹æ•°æ®çš„æ‰€æœ‰è¯·æ±‚ï¼Œéƒ½ä¼šå‡ºç°ç¼“å­˜å¤±æ•ˆï¼Œä»è€Œéƒ½ç©¿é€åˆ° DBï¼ŒDB ç”±äºæŸ¥è¯¢é‡å¤ªå¤§ï¼Œå°±å¾ˆå®¹æ˜“å‹åŠ›å¤§å¢ï¼Œè¯·æ±‚å˜æ…¢ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>å¾ˆå¤šä¸šåŠ¡åœºæ™¯ï¼Œç¨ä¸æ³¨æ„ï¼Œå°±å‡ºç°å¤§é‡çš„ç¼“å­˜å¤±æ•ˆï¼Œè¿›è€Œå¯¼è‡´ç³»ç»Ÿ DB å‹åŠ›å¤§ã€è¯·æ±‚å˜æ…¢çš„æƒ…å†µã€‚æ¯”å¦‚åŒä¸€æ‰¹ç«è½¦ç¥¨ã€é£æœºç¥¨ï¼Œå½“å¯ä»¥å”®å–æ—¶ï¼Œç³»ç»Ÿä¼šä¸€æ¬¡æ€§åŠ è½½åˆ°ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜å†™å…¥æ—¶ï¼Œè¿‡æœŸæ—¶é—´æŒ‰ç…§é¢„å…ˆè®¾ç½®çš„è¿‡æœŸå€¼ï¼Œé‚£è¿‡æœŸæ—¶é—´åˆ°æœŸåï¼Œç³»ç»Ÿå°±ä¼šå› ç¼“å­˜å¤±æ•ˆå‡ºç°å˜æ…¢çš„é—®é¢˜ã€‚ç±»ä¼¼çš„ä¸šåŠ¡åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¾®åšä¸šåŠ¡ï¼Œä¼šæœ‰åå°ç¦»çº¿ç³»ç»Ÿï¼ŒæŒç»­è®¡ç®—çƒ­é—¨å¾®åšï¼Œæ¯å½“è®¡ç®—ç»“æŸï¼Œä¼šå°†è¿™æ‰¹çƒ­é—¨å¾®åšæ‰¹é‡å†™å…¥å¯¹åº”çš„ç¼“å­˜ã€‚è¿˜æ¯”å¦‚ï¼Œå¾ˆå¤šä¸šåŠ¡ï¼Œåœ¨éƒ¨ç½²æ–° IDC æˆ–æ–°ä¸šåŠ¡ä¸Šçº¿æ—¶ï¼Œä¼šè¿›è¡Œ<strong>ç¼“å­˜é¢„çƒ­</strong>ï¼Œä¹Ÿä¼šä¸€æ¬¡æ€§åŠ è½½å¤§æ‰¹çƒ­æ•°æ®ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>å¯¹äºæ‰¹é‡ key ç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ï¼ŒåŸå› æ—¢ç„¶æ˜¯é¢„ç½®çš„å›ºå®šè¿‡æœŸæ—¶é—´ï¼Œé‚£è§£å†³æ–¹æ¡ˆä¹Ÿä»è¿™é‡Œå…¥æ‰‹ã€‚è®¾è®¡ç¼“å­˜çš„è¿‡æœŸæ—¶é—´æ—¶ï¼Œä½¿ç”¨å…¬å¼ï¼š<code>è¿‡æœŸæ—¶é—´=base æ—¶é—´+éšæœºæ—¶é—´</code>ã€‚å³ç›¸åŒä¸šåŠ¡æ•°æ®å†™ç¼“å­˜æ—¶ï¼Œåœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¹‹ä¸Šï¼Œå†åŠ ä¸€ä¸ªéšæœºçš„è¿‡æœŸæ—¶é—´ï¼Œè®©æ•°æ®åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å†…æ…¢æ…¢è¿‡æœŸï¼Œé¿å…ç¬æ—¶å…¨éƒ¨è¿‡æœŸï¼Œå¯¹ DB é€ æˆè¿‡å¤§å‹åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210206172610.jpg" alt=""></p>
<h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>ç¬¬äºŒä¸ªç»å…¸é—®é¢˜æ˜¯ç¼“å­˜ç©¿é€ã€‚</p>
<p>ç¼“å­˜ç©¿é€æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„é—®é¢˜ã€‚å› ä¸ºç¼“å­˜ç©¿é€å‘ç”Ÿçš„æ¦‚ç‡å¾ˆä½ï¼Œæ‰€ä»¥ä¸€èˆ¬å¾ˆéš¾è¢«å‘ç°ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦ä½ å‘ç°äº†ï¼Œè€Œä¸”é‡è¿˜ä¸å°ï¼Œä½ å¯èƒ½ç«‹å³å°±ä¼šç»å†ä¸€ä¸ªå¿™ç¢Œçš„å¤œæ™šã€‚å› ä¸ºå¯¹äºæ­£å¸¸è®¿é—®ï¼Œè®¿é—®çš„æ•°æ®å³ä¾¿ä¸åœ¨ç¼“å­˜ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ DB åŠ è½½å›ç§åˆ°ç¼“å­˜ã€‚è€Œç¼“å­˜ç©¿é€ï¼Œåˆ™æ„å‘³ç€<strong>æœ‰ç‰¹æ®Šè®¿å®¢åœ¨æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„ keyï¼Œå¯¼è‡´æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šç©¿é€åˆ° DBï¼Œå¦‚æœè¿™ä¸ªç‰¹æ®Šè®¿å®¢å†æ§åˆ¶ä¸€æ‰¹è‚‰é¸¡æœºå™¨ï¼ŒæŒç»­è®¿é—®ä½ ç³»ç»Ÿé‡Œä¸å­˜åœ¨çš„ keyï¼Œå°±ä¼šå¯¹ DB äº§ç”Ÿå¾ˆå¤§çš„å‹åŠ›ï¼Œä»è€Œå½±å“æ­£å¸¸æœåŠ¡ã€‚</strong></p>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>ç¼“å­˜ç©¿é€å­˜åœ¨çš„åŸå› ï¼Œå°±æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ç³»ç»Ÿè®¾è®¡æ—¶ï¼Œæ›´å¤šè€ƒè™‘çš„æ˜¯<strong>æ­£å¸¸è®¿é—®è·¯å¾„</strong>ï¼Œå¯¹<strong>ç‰¹æ®Šè®¿é—®è·¯å¾„</strong>ã€<strong>å¼‚å¸¸è®¿é—®è·¯å¾„</strong>è€ƒè™‘ç›¸å¯¹æ¬ ç¼ºã€‚</p>
<p>ç¼“å­˜è®¿é—®è®¾è®¡çš„æ­£å¸¸è·¯å¾„ï¼Œæ˜¯å…ˆè®¿é—® cacheï¼Œcache miss åæŸ¥ DBï¼ŒDB æŸ¥è¯¢åˆ°ç»“æœåï¼Œå›ç§ç¼“å­˜è¿”å›ã€‚è¿™å¯¹äºæ­£å¸¸çš„ key è®¿é—®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·è®¿é—®çš„æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„ keyï¼ŒæŸ¥ DB è¿”å›ç©ºï¼ˆå³ä¸€ä¸ª NULLï¼‰ï¼Œé‚£å°±ä¸ä¼šæŠŠè¿™ä¸ªç©ºå†™å›cacheã€‚é‚£ä»¥åä¸ç®¡æŸ¥è¯¢å¤šå°‘æ¬¡è¿™ä¸ªä¸å­˜åœ¨çš„ keyï¼Œéƒ½ä¼š cache missï¼Œéƒ½ä¼šæŸ¥è¯¢ DBã€‚æ•´ä¸ªç³»ç»Ÿå°±ä¼šé€€åŒ–æˆä¸€ä¸ªâ€œå‰ç«¯+DBâ€œçš„ç³»ç»Ÿï¼Œç”±äº DB çš„åååªåœ¨ cache çš„ 1%~2% ä»¥ä¸‹ï¼Œå¦‚æœæœ‰ç‰¹æ®Šè®¿å®¢ï¼Œå¤§é‡è®¿é—®è¿™äº›ä¸å­˜åœ¨çš„ keyï¼Œå°±ä¼šå¯¼è‡´ç³»ç»Ÿçš„æ€§èƒ½ä¸¥é‡é€€åŒ–ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·çš„è®¿é—®ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>ç¼“å­˜ç©¿é€çš„ä¸šåŠ¡åœºæ™¯å¾ˆå¤šï¼Œæ¯”å¦‚é€šè¿‡ä¸å­˜åœ¨çš„ UID è®¿é—®ç”¨æˆ·ï¼Œé€šè¿‡ä¸å­˜åœ¨çš„è½¦æ¬¡ ID æŸ¥çœ‹è´­ç¥¨ä¿¡æ¯ã€‚ç”¨æˆ·è¾“å…¥é”™è¯¯ï¼Œå¶å°”å‡ ä¸ªè¿™ç§è¯·æ±‚é—®é¢˜ä¸å¤§ï¼Œä½†å¦‚æœæ˜¯å¤§é‡è¿™ç§è¯·æ±‚ï¼Œå°±ä¼šå¯¹ç³»ç»Ÿå½±å“éå¸¸å¤§ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ç§é—®é¢˜å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p>ç¬¬ä¸€ç§æ–¹æ¡ˆå°±æ˜¯ï¼ŒæŸ¥è¯¢è¿™äº›ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œç¬¬ä¸€æ¬¡æŸ¥ DBï¼Œè™½ç„¶æ²¡æŸ¥åˆ°ç»“æœè¿”å› NULLï¼Œä»ç„¶è®°å½•è¿™ä¸ª key åˆ°ç¼“å­˜ï¼Œåªæ˜¯è¿™ä¸ª key å¯¹åº”çš„ value æ˜¯ä¸€ä¸ªç‰¹æ®Šè®¾ç½®çš„å€¼ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯ï¼Œæ„å»ºä¸€ä¸ª <code>BloomFilter</code> ç¼“å­˜è¿‡æ»¤å™¨ï¼Œè®°å½•å…¨é‡æ•°æ®ï¼Œè¿™æ ·è®¿é—®æ•°æ®æ—¶ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ <code>BloomFilter</code> åˆ¤æ–­è¿™ä¸ª key æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ç›´æ¥è¿”å›å³å¯ï¼Œæ ¹æœ¬æ— éœ€æŸ¥ç¼“å­˜å’Œ DBã€‚</p>
<p><img src="http://image.leonote.cn//20210206173352.jpg" alt=""></p>
<p>ä¸è¿‡è¿™ä¸¤ç§æ–¹æ¡ˆåœ¨è®¾è®¡æ—¶ä»ç„¶æœ‰ä¸€äº›è¦æ³¨æ„çš„å‘ã€‚</p>
<p>å¯¹äºæ–¹æ¡ˆä¸€ï¼Œå¦‚æœç‰¹æ®Šè®¿å®¢æŒç»­è®¿é—®å¤§é‡çš„ä¸å­˜åœ¨çš„ keyï¼Œè¿™äº› key å³ä¾¿åªå­˜ä¸€ä¸ªç®€å•çš„é»˜è®¤å€¼ï¼Œä¹Ÿä¼šå ç”¨å¤§é‡çš„ç¼“å­˜ç©ºé—´ï¼Œå¯¼è‡´æ­£å¸¸ key çš„å‘½ä¸­ç‡ä¸‹é™ã€‚æ‰€ä»¥è¿›ä¸€æ­¥çš„æ”¹è¿›æªæ–½æ˜¯ï¼Œ<strong>å¯¹è¿™äº›ä¸å­˜åœ¨çš„ key åªå­˜è¾ƒçŸ­çš„æ—¶é—´ï¼Œè®©å®ƒä»¬å°½å¿«è¿‡æœŸ</strong>ï¼›æˆ–è€…<strong>å°†è¿™äº›ä¸å­˜åœ¨çš„ key å­˜åœ¨ä¸€ä¸ªç‹¬ç«‹çš„å…¬å…±ç¼“å­˜</strong>ï¼Œä»ç¼“å­˜æŸ¥æ‰¾æ—¶ï¼Œå…ˆæŸ¥æ­£å¸¸çš„ç¼“å­˜ç»„ä»¶ï¼Œå¦‚æœ missï¼Œåˆ™æŸ¥ä¸€ä¸‹å…¬å…±çš„éæ³• key çš„ç¼“å­˜ï¼Œå¦‚æœåè€…å‘½ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™ç©¿é€ DBï¼Œå¦‚æœæŸ¥å‡ºæ¥æ˜¯ç©ºï¼Œåˆ™å›ç§åˆ°éæ³• key ç¼“å­˜ï¼Œå¦åˆ™å›ç§åˆ°æ­£å¸¸ç¼“å­˜ã€‚</p>
<p>å¯¹äºæ–¹æ¡ˆäºŒï¼Œ<code>BloomFilter</code> è¦ç¼“å­˜å…¨é‡çš„ keyï¼Œè¿™å°±è¦æ±‚<strong>å…¨é‡çš„ key æ•°é‡ä¸å¤§ï¼Œ10äº¿ æ¡æ•°æ®ä»¥å†…æœ€ä½³</strong>ï¼Œå› ä¸º 10äº¿ æ¡æ•°æ®å¤§æ¦‚è¦å ç”¨ 1.2GB çš„å†…å­˜ã€‚ä¹Ÿå¯ä»¥ç”¨ <code>BloomFilter</code> ç¼“å­˜éæ³• keyï¼Œæ¯æ¬¡å‘ç°ä¸€ä¸ª key æ˜¯ä¸å­˜åœ¨çš„éæ³• keyï¼Œå°±è®°å½•åˆ° BloomFilter ä¸­ï¼Œè¿™ç§è®°å½•æ–¹æ¡ˆï¼Œä¼šå¯¼è‡´ <code>BloomFilter</code> å­˜å‚¨çš„ key æŒç»­é«˜é€Ÿå¢é•¿ï¼Œä¸ºäº†é¿å…è®°å½• key å¤ªå¤šè€Œå¯¼è‡´è¯¯åˆ¤ç‡å¢å¤§ï¼Œéœ€è¦å®šæœŸæ¸…é›¶å¤„ç†ã€‚</p>
<p><strong>BloomFilter</strong></p>
<p><code>BloomFilter</code> æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„æ•°æ®ç»“æ„ï¼Œä¸ä»…ä»…å¯ä»¥æŒ¡ä½éæ³• key æ”»å‡»ï¼Œè¿˜å¯ä»¥ä½æˆæœ¬ã€é«˜æ€§èƒ½åœ°å¯¹æµ·é‡æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼Œæ¯”å¦‚ä¸€ä¸ªç³»ç»Ÿæœ‰æ•°äº¿ç”¨æˆ·å’Œç™¾äº¿çº§æ–°é—» feedï¼Œå°±å¯ä»¥ç”¨ <code>BloomFilter</code> æ¥åˆ¤æ–­æŸä¸ªç”¨æˆ·æ˜¯å¦é˜…è¯»æŸæ¡æ–°é—» feedã€‚ä¸‹é¢æ¥å¯¹ <code>BloomFilter</code> æ•°æ®ç»“æ„åšä¸€ä¸ªåˆ†æï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210206174015.jpg" alt=""></p>
<p><code>BloomFilter</code> çš„ç›®çš„æ˜¯æ£€æµ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºä¸€ä¸ªé›†åˆå†…ã€‚å®ƒçš„åŸç†ï¼Œæ˜¯ç”¨ bit æ•°æ®ç»„æ¥è¡¨ç¤ºä¸€ä¸ªé›†åˆï¼Œå¯¹ä¸€ä¸ª key è¿›è¡Œå¤šæ¬¡ä¸åŒçš„ Hash æ£€æµ‹ï¼Œå¦‚æœæ‰€æœ‰ Hash å¯¹åº”çš„ bit ä½éƒ½æ˜¯ 1ï¼Œåˆ™è¡¨æ˜ key éå¸¸å¤§æ¦‚ç‡å­˜åœ¨ï¼Œ<strong>å¹³å‡å•è®°å½•å ç”¨ 1.2 å­—èŠ‚å³å¯è¾¾åˆ° 99%</strong>ï¼Œåªè¦æœ‰ä¸€æ¬¡ Hash å¯¹åº”çš„ bit ä½æ˜¯ 0ï¼Œå°±è¯´æ˜è¿™ä¸ª key è‚¯å®šä¸å­˜åœ¨äºè¿™ä¸ªé›†åˆå†…ã€‚</p>
<p><code>BloomFilter</code> çš„ç®—æ³•æ˜¯ï¼Œé¦–å…ˆåˆ†é…ä¸€å—å†…å­˜ç©ºé—´åš bit æ•°ç»„ï¼Œæ•°ç»„çš„ bit ä½åˆå§‹å€¼å…¨éƒ¨è®¾ä¸º 0ï¼ŒåŠ å…¥å…ƒç´ æ—¶ï¼Œé‡‡ç”¨ k ä¸ªç›¸äº’ç‹¬ç«‹çš„ Hash å‡½æ•°è®¡ç®—ï¼Œç„¶åå°†å…ƒç´  Hash æ˜ å°„çš„ K ä¸ªä½ç½®å…¨éƒ¨è®¾ç½®ä¸º 1ã€‚æ£€æµ‹ key æ—¶ï¼Œä»ç„¶ç”¨è¿™ k ä¸ª Hash å‡½æ•°è®¡ç®—å‡º k ä¸ªä½ç½®ï¼Œå¦‚æœä½ç½®å…¨éƒ¨ä¸º 1ï¼Œåˆ™è¡¨æ˜ key å­˜åœ¨ï¼Œå¦åˆ™ä¸å­˜åœ¨ã€‚</p>
<p><code>BloomFilter</code> çš„ä¼˜åŠ¿æ˜¯ï¼Œå…¨å†…å­˜æ“ä½œï¼Œæ€§èƒ½å¾ˆé«˜ã€‚å¦å¤–ç©ºé—´æ•ˆç‡éå¸¸é«˜ï¼Œè¦è¾¾åˆ° 1% çš„è¯¯åˆ¤ç‡ï¼Œå¹³å‡å•æ¡è®°å½•å ç”¨ 1.2 å­—èŠ‚å³å¯ã€‚è€Œä¸”ï¼Œå¹³å‡å•æ¡è®°å½•æ¯å¢åŠ  0.6 å­—èŠ‚ï¼Œè¿˜å¯è®©è¯¯åˆ¤ç‡ç»§ç»­å˜ä¸ºä¹‹å‰çš„ 1/10ï¼Œå³å¹³å‡å•æ¡è®°å½•å ç”¨ 1.8 å­—èŠ‚ï¼Œè¯¯åˆ¤ç‡å¯ä»¥è¾¾åˆ° 1/1000ï¼›å¹³å‡å•æ¡è®°å½•å ç”¨ 2.4 å­—èŠ‚ï¼Œè¯¯åˆ¤ç‡å¯ä»¥åˆ° 1/10000ï¼Œä»¥æ­¤ç±»æ¨ã€‚è¿™é‡Œçš„è¯¯åˆ¤ç‡æ˜¯æŒ‡ï¼Œ<code>BloomFilter</code> åˆ¤æ–­æŸä¸ª key å­˜åœ¨ï¼Œä½†å®ƒå®é™…ä¸å­˜åœ¨çš„æ¦‚ç‡ï¼Œå› ä¸ºå®ƒå­˜çš„æ˜¯ key çš„ Hash å€¼ï¼Œè€Œé key çš„å€¼ï¼Œæ‰€ä»¥æœ‰æ¦‚ç‡å­˜åœ¨è¿™æ ·çš„ keyï¼Œå®ƒä»¬å†…å®¹ä¸åŒï¼Œä½†å¤šæ¬¡ Hash åçš„ Hash å€¼éƒ½ç›¸åŒã€‚å¯¹äº <code>BloomFilter</code> åˆ¤æ–­ä¸å­˜åœ¨çš„ key ï¼Œåˆ™æ˜¯ 100% ä¸å­˜åœ¨çš„ï¼Œåè¯æ³•ï¼Œå¦‚æœè¿™ä¸ª key å­˜åœ¨ï¼Œé‚£å®ƒæ¯æ¬¡ Hash åå¯¹åº”çš„ Hash å€¼ä½ç½®è‚¯å®šæ˜¯ 1ï¼Œè€Œä¸ä¼šæ˜¯ 0ã€‚</p>
<h2 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>ç¬¬ä¸‰ä¸ªç»å…¸é—®é¢˜æ˜¯ç¼“å­˜é›ªå´©ã€‚</p>
<p>ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ã€‚ç¼“å­˜é›ªå´©æ˜¯æŒ‡éƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå¯¼è‡´æ•´ä¸ªç¼“å­˜ä½“ç³»ç”šè‡³ç”šè‡³æœåŠ¡ç³»ç»Ÿä¸å¯ç”¨çš„æƒ…å†µã€‚</p>
<p>ç¼“å­˜é›ªå´©æŒ‰ç…§ç¼“å­˜æ˜¯å¦ rehashï¼ˆå³æ˜¯å¦æ¼‚ç§»ï¼‰åˆ†ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><p>ç¼“å­˜ä¸æ”¯æŒ rehash å¯¼è‡´çš„ç³»ç»Ÿé›ªå´©ä¸å¯ç”¨</p>
</li>
<li><p>ç¼“å­˜æ”¯æŒ rehash å¯¼è‡´çš„ç¼“å­˜é›ªå´©ä¸å¯ç”¨</p>
</li>
</ul>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>åœ¨ä¸Šè¿°ä¸¤ç§æƒ…å†µä¸­ï¼Œç¼“å­˜ä¸è¿›è¡Œ rehash æ—¶äº§ç”Ÿçš„é›ªå´©ï¼Œä¸€èˆ¬æ˜¯ç”±äºè¾ƒå¤šç¼“å­˜èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œè¯·æ±‚ç©¿é€å¯¼è‡´ DB ä¹Ÿè¿‡è½½ä¸å¯ç”¨ï¼Œæœ€ç»ˆæ•´ä¸ªç³»ç»Ÿé›ªå´©ä¸å¯ç”¨çš„ã€‚è€Œç¼“å­˜æ”¯æŒ rehash æ—¶äº§ç”Ÿçš„é›ªå´©ï¼Œåˆ™å¤§å¤šè·Ÿæµé‡æ´ªå³°æœ‰å…³ï¼Œæµé‡æ´ªå³°åˆ°è¾¾ï¼Œå¼•å‘éƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹è¿‡è½½ Crashï¼Œç„¶åå›  rehash æ‰©æ•£åˆ°å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ï¼Œæœ€ç»ˆæ•´ä¸ªç¼“å­˜ä½“ç³»å¼‚å¸¸ã€‚</p>
<p>ç¬¬ä¸€ç§æƒ…å†µæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œç¼“å­˜èŠ‚ç‚¹ä¸æ”¯æŒ rehashï¼Œè¾ƒå¤šç¼“å­˜èŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œå¤§é‡ Cache è®¿é—®ä¼šå¤±è´¥ï¼Œæ ¹æ®ç¼“å­˜è¯»å†™æ¨¡å‹ï¼Œè¿™äº›è¯·æ±‚ä¼šè¿›ä¸€æ­¥è®¿é—® DBï¼Œè€Œä¸” DB å¯æ‰¿è½½çš„è®¿é—®é‡è¦è¿œæ¯”ç¼“å­˜å°çš„å¤šï¼Œè¯·æ±‚é‡è¿‡å¤§ï¼Œå°±å¾ˆå®¹æ˜“é€ æˆ DB è¿‡è½½ï¼Œå¤§é‡æ…¢æŸ¥è¯¢ï¼Œæœ€ç»ˆé˜»å¡ç”šè‡³ Crashï¼Œä»è€Œå¯¼è‡´æœåŠ¡å¼‚å¸¸ã€‚</p>
<p>ç¬¬äºŒç§æƒ…å†µæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºç¼“å­˜åˆ†å¸ƒè®¾è®¡æ—¶ï¼Œå¾ˆå¤šåŒå­¦ä¼šé€‰æ‹©ä¸€è‡´æ€§ Hash åˆ†å¸ƒæ–¹å¼ï¼ŒåŒæ—¶åœ¨éƒ¨åˆ†èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œé‡‡ç”¨ rehash ç­–ç•¥ï¼Œå³æŠŠå¼‚å¸¸èŠ‚ç‚¹è¯·æ±‚å¹³å‡åˆ†æ•£åˆ°å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€è‡´æ€§ Hash åˆ†å¸ƒ+rehash ç­–ç•¥å¯ä»¥å¾ˆå¥½å¾—è¿è¡Œï¼Œä½†åœ¨è¾ƒå¤§çš„æµé‡æ´ªå³°åˆ°ä¸´ä¹‹æ—¶ï¼Œå¦‚æœå¤§æµé‡ key æ¯”è¾ƒé›†ä¸­ï¼Œæ­£å¥½åœ¨æŸ 1ï½2 ä¸ªç¼“å­˜èŠ‚ç‚¹ï¼Œå¾ˆå®¹æ˜“å°†è¿™äº›ç¼“å­˜èŠ‚ç‚¹çš„å†…å­˜ã€ç½‘å¡è¿‡è½½ï¼Œç¼“å­˜èŠ‚ç‚¹å¼‚å¸¸ Crashï¼Œç„¶åè¿™äº›å¼‚å¸¸èŠ‚ç‚¹ä¸‹çº¿ï¼Œè¿™äº›å¤§æµé‡ key è¯·æ±‚åˆè¢« rehash åˆ°å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ï¼Œè¿›è€Œå¯¼è‡´å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ä¹Ÿè¢«è¿‡è½½ Crashï¼Œç¼“å­˜å¼‚å¸¸æŒç»­æ‰©æ•£ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªç¼“å­˜ä½“ç³»å¼‚å¸¸ï¼Œæ— æ³•å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>ç¼“å­˜é›ªå´©çš„ä¸šåŠ¡åœºæ™¯å¹¶ä¸å°‘è§ï¼Œå¾®åšã€Twitter ç­‰ç³»ç»Ÿåœ¨è¿è¡Œçš„æœ€åˆè‹¥å¹²å¹´éƒ½é‡åˆ°è¿‡å¾ˆå¤šæ¬¡ã€‚æ¯”å¦‚ï¼Œå¾®åšæœ€åˆå¾ˆå¤šä¸šåŠ¡ç¼“å­˜é‡‡ç”¨ä¸€è‡´æ€§ Hash+rehash ç­–ç•¥ï¼Œåœ¨çªå‘æ´ªæ°´æµé‡æ¥ä¸´æ—¶ï¼Œéƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹è¿‡è½½ Crash ç”šè‡³å®•æœºï¼Œç„¶åè¿™äº›å¼‚å¸¸èŠ‚ç‚¹çš„è¯·æ±‚è½¬åˆ°å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ï¼Œåˆå¯¼è‡´å…¶ä»–ç¼“å­˜èŠ‚ç‚¹è¿‡è½½å¼‚å¸¸ï¼Œæœ€ç»ˆæ•´ä¸ªç¼“å­˜æ± è¿‡è½½ã€‚å¦å¤–ï¼Œæœºæ¶æ–­ç”µï¼Œå¯¼è‡´ä¸šåŠ¡ç¼“å­˜å¤šä¸ªèŠ‚ç‚¹å®•æœºï¼Œå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ° DBï¼Œä¹Ÿå¯¼è‡´ DB è¿‡è½½è€Œé˜»å¡ï¼Œæ•´ä¸ªç³»ç»Ÿå¼‚å¸¸ã€‚æœ€åç¼“å­˜æœºå™¨å¤ç”µåï¼ŒDB é‡å¯ï¼Œæ•°æ®é€æ­¥åŠ çƒ­åï¼Œç³»ç»Ÿæ‰é€æ­¥æ¢å¤æ­£å¸¸ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>é¢„é˜²ç¼“å­˜é›ªå´©ï¼Œè¿™é‡Œç»™å‡º 3 ä¸ªè§£å†³æ–¹æ¡ˆã€‚</p>
<ul>
<li>æ–¹æ¡ˆä¸€ï¼Œå¯¹ä¸šåŠ¡ DB çš„è®¿é—®å¢åŠ è¯»å†™å¼€å…³ï¼Œå½“å‘ç° DB è¯·æ±‚å˜æ…¢ã€é˜»å¡ï¼Œ<strong>æ…¢è¯·æ±‚</strong>è¶…è¿‡é˜€å€¼æ—¶ï¼Œå°±ä¼šå…³é—­è¯»å¼€å…³ï¼Œéƒ¨åˆ†æˆ–æ‰€æœ‰è¯» DB çš„è¯·æ±‚è¿›è¡Œ failfast ç«‹å³è¿”å›ï¼Œå¾… DB æ¢å¤åå†æ‰“å¼€è¯»å¼€å…³ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ul>
<p><img src="http://image.leonote.cn//20210206180631.jpg" alt=""></p>
<ul>
<li>æ–¹æ¡ˆäºŒï¼Œå¯¹ç¼“å­˜å¢åŠ å¤šä¸ªå‰¯æœ¬ï¼Œç¼“å­˜å¼‚å¸¸æˆ–è¯·æ±‚ miss åï¼Œå†è¯»å–å…¶ä»–ç¼“å­˜å‰¯æœ¬ï¼Œè€Œä¸”å¤šä¸ªç¼“å­˜å‰¯æœ¬å°½é‡éƒ¨ç½²åœ¨ä¸åŒæœºæ¶ï¼Œä»è€Œç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œç¼“å­˜ç³»ç»Ÿéƒ½ä¼šæ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ã€‚</li>
</ul>
<ul>
<li>æ–¹æ¡ˆä¸‰ï¼Œå¯¹ç¼“å­˜ä½“ç³»è¿›è¡Œå®æ—¶ç›‘æ§ï¼Œå½“è¯·æ±‚è®¿é—®çš„<strong>æ…¢é€Ÿæ¯”</strong>è¶…è¿‡é˜€å€¼æ—¶ï¼ŒåŠæ—¶æŠ¥è­¦ï¼Œé€šè¿‡æœºå™¨æ›¿æ¢ã€æœåŠ¡æ›¿æ¢è¿›è¡ŒåŠæ—¶æ¢å¤ï¼›ä¹Ÿå¯ä»¥é€šè¿‡å„ç§è‡ªåŠ¨æ•…éšœè½¬ç§»ç­–ç•¥ï¼Œè‡ªåŠ¨å…³é—­å¼‚å¸¸æ¥å£ã€åœæ­¢è¾¹ç¼˜æœåŠ¡ã€åœæ­¢éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æªæ–½ï¼Œç¡®ä¿åœ¨æç«¯åœºæ™¯ä¸‹ï¼Œæ ¸å¿ƒåŠŸèƒ½çš„æ­£å¸¸è¿è¡Œã€‚</li>
</ul>
<p>å®é™…ä¸Šï¼Œå¾®åšå¹³å°ç³»ç»Ÿï¼Œè¿™ä¸‰ç§æ–¹æ¡ˆéƒ½é‡‡ç”¨äº†ï¼Œé€šè¿‡ä¸‰ç®¡é½ä¸‹ï¼Œè§„é¿ç¼“å­˜é›ªå´©çš„å‘ç”Ÿã€‚</p>
<h2 id="æ•°æ®ä¸ä¸€è‡´"><a href="#æ•°æ®ä¸ä¸€è‡´" class="headerlink" title="æ•°æ®ä¸ä¸€è‡´"></a>æ•°æ®ä¸ä¸€è‡´</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>ä¸ƒå¤§ç¼“å­˜ç»å…¸é—®é¢˜çš„ç¬¬å››ä¸ªé—®é¢˜æ˜¯æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p>åŒä¸€ä»½æ•°æ®ï¼Œå¯èƒ½ä¼šåŒæ—¶å­˜åœ¨ DB å’Œç¼“å­˜ä¹‹ä¸­ã€‚é‚£å°±æœ‰å¯èƒ½å‘ç”Ÿï¼ŒDB å’Œç¼“å­˜çš„æ•°æ®ä¸ä¸€è‡´ã€‚å¦‚æœç¼“å­˜æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå¤šä¸ªç¼“å­˜å‰¯æœ¬é‡Œçš„æ•°æ®ä¹Ÿå¯èƒ½ä¼šå‘ç”Ÿä¸ä¸€è‡´ç°è±¡ã€‚</p>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>ä¸ä¸€è‡´çš„é—®é¢˜å¤§å¤šè·Ÿç¼“å­˜æ›´æ–°å¼‚å¸¸æœ‰å…³ã€‚æ¯”å¦‚æ›´æ–° DB åï¼Œå†™ç¼“å­˜å¤±è´¥ï¼Œä»è€Œå¯¼è‡´ç¼“å­˜ä¸­å­˜çš„æ˜¯è€æ•°æ®ã€‚å¦å¤–ï¼Œå¦‚æœç³»ç»Ÿé‡‡ç”¨ä¸€è‡´æ€§ Hash åˆ†å¸ƒï¼ŒåŒæ—¶é‡‡ç”¨ rehash è‡ªåŠ¨æ¼‚ç§»ç­–ç•¥ï¼Œåœ¨èŠ‚ç‚¹å¤šæ¬¡ä¸Šä¸‹çº¿ä¹‹åï¼Œä¹Ÿä¼šäº§ç”Ÿè„æ•°æ®ã€‚ç¼“å­˜æœ‰å¤šä¸ªå‰¯æœ¬æ—¶ï¼Œæ›´æ–°æŸä¸ªå‰¯æœ¬å¤±è´¥ï¼Œä¹Ÿä¼šå¯¼è‡´è¿™ä¸ªå‰¯æœ¬çš„æ•°æ®æ˜¯è€æ•°æ®ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„åœºæ™¯ä¹Ÿä¸å°‘ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ç¼“å­˜æœºå™¨çš„å¸¦å®½è¢«æ‰“æ»¡ï¼Œæˆ–è€…æœºæˆ¿ç½‘ç»œå‡ºç°æ³¢åŠ¨æ—¶ï¼Œç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œæ–°æ•°æ®æ²¡æœ‰å†™å…¥ç¼“å­˜ï¼Œå°±ä¼šå¯¼è‡´ç¼“å­˜å’Œ DB çš„æ•°æ®ä¸ä¸€è‡´ã€‚ç¼“å­˜ rehash æ—¶ï¼ŒæŸä¸ªç¼“å­˜æœºå™¨åå¤å¼‚å¸¸ï¼Œå¤šæ¬¡ä¸Šä¸‹çº¿ï¼Œæ›´æ–°è¯·æ±‚å¤šæ¬¡ rehashã€‚è¿™æ ·ï¼Œä¸€ä»½æ•°æ®å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œä¸”æ¯æ¬¡ rehash åªæ›´æ–°æŸä¸ªèŠ‚ç‚¹ï¼Œå¯¼è‡´ä¸€äº›ç¼“å­˜èŠ‚ç‚¹äº§ç”Ÿè„æ•°æ®ã€‚</p>
<p><img src="http://image.leonote.cn//20210206191204.jpg" alt=""></p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>è¦å°½é‡ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚è¿™é‡Œä¹Ÿç»™å‡ºäº† 3 ä¸ªæ–¹æ¡ˆï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©ã€‚</p>
<ul>
<li><p>ç¬¬ä¸€ä¸ªæ–¹æ¡ˆï¼Œcache æ›´æ–°å¤±è´¥åï¼Œå¯ä»¥è¿›è¡Œé‡è¯•ï¼Œå¦‚æœé‡è¯•å¤±è´¥ï¼Œåˆ™å°†å¤±è´¥çš„ key å†™å…¥é˜Ÿåˆ—æœºæœåŠ¡ï¼Œå¾…ç¼“å­˜è®¿é—®æ¢å¤åï¼Œå°†è¿™äº› key ä»ç¼“å­˜åˆ é™¤ã€‚è¿™äº› key åœ¨å†æ¬¡è¢«æŸ¥è¯¢æ—¶ï¼Œé‡æ–°ä» DB åŠ è½½ï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>
</li>
<li><p>ç¬¬äºŒä¸ªæ–¹æ¡ˆï¼Œç¼“å­˜æ—¶é—´é€‚å½“è°ƒçŸ­ï¼Œè®©ç¼“å­˜æ•°æ®åŠæ—©è¿‡æœŸåï¼Œç„¶åä» DB é‡æ–°åŠ è½½ï¼Œç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
</li>
<li><p>ç¬¬ä¸‰ä¸ªæ–¹æ¡ˆï¼Œä¸é‡‡ç”¨ rehash æ¼‚ç§»ç­–ç•¥ï¼Œè€Œé‡‡ç”¨ç¼“å­˜åˆ†å±‚ç­–ç•¥ï¼Œå°½é‡é¿å…è„æ•°æ®äº§ç”Ÿã€‚</p>
</li>
</ul>
<h2 id="æ•°æ®å¹¶å‘ç«äº‰"><a href="#æ•°æ®å¹¶å‘ç«äº‰" class="headerlink" title="æ•°æ®å¹¶å‘ç«äº‰"></a>æ•°æ®å¹¶å‘ç«äº‰</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>ç¬¬äº”ä¸ªç»å…¸é—®é¢˜æ˜¯æ•°æ®å¹¶å‘ç«äº‰ã€‚</p>
<p>äº’è”ç½‘ç³»ç»Ÿï¼Œçº¿ä¸Šæµé‡è¾ƒå¤§ï¼Œç¼“å­˜è®¿é—®ä¸­å¾ˆå®¹æ˜“å‡ºç°æ•°æ®å¹¶å‘ç«äº‰çš„ç°è±¡ã€‚æ•°æ®å¹¶å‘ç«äº‰ï¼Œæ˜¯æŒ‡åœ¨é«˜å¹¶å‘è®¿é—®åœºæ™¯ï¼Œä¸€æ—¦ç¼“å­˜è®¿é—®æ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œå¤§é‡è¯·æ±‚å°±ä¼šå¹¶å‘æŸ¥è¯¢ DBï¼Œå¯¼è‡´ DB å‹åŠ›å¤§å¢çš„ç°è±¡ã€‚</p>
<p>æ•°æ®å¹¶å‘ç«äº‰ï¼Œä¸»è¦æ˜¯ç”±äºå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹ä¸­ï¼Œæœ‰<strong>å¤§é‡å¹¶å‘è¯·æ±‚è·å–ç›¸åŒçš„æ•°æ®</strong>ï¼Œè€Œè¿™ä¸ªæ•°æ® key å› ä¸ºæ­£å¥½è¿‡æœŸã€è¢«å‰”é™¤ç­‰å„ç§åŸå› åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè¿™äº›è¿›ç¨‹/çº¿ç¨‹ä¹‹é—´æ²¡æœ‰ä»»ä½•åè°ƒï¼Œç„¶åä¸€èµ·å¹¶å‘æŸ¥è¯¢ DBï¼Œè¯·æ±‚é‚£ä¸ªç›¸åŒçš„ keyï¼Œæœ€ç»ˆå¯¼è‡´ DB å‹åŠ›å¤§å¢ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="http://image.leonote.cn//20210206191523.jpg" alt=""></p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>æ•°æ®å¹¶å‘ç«äº‰åœ¨å¤§æµé‡ç³»ç»Ÿä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œæ¯”å¦‚è½¦ç¥¨ç³»ç»Ÿï¼Œå¦‚æœæŸä¸ªç«è½¦è½¦æ¬¡ç¼“å­˜ä¿¡æ¯è¿‡æœŸï¼Œä½†ä»ç„¶æœ‰å¤§é‡ç”¨æˆ·åœ¨æŸ¥è¯¢è¯¥è½¦æ¬¡ä¿¡æ¯ã€‚åˆæ¯”å¦‚å¾®åšç³»ç»Ÿä¸­ï¼Œå¦‚æœæŸæ¡å¾®åšæ­£å¥½è¢«ç¼“å­˜æ·˜æ±°ï¼Œä½†è¿™æ¡å¾®åšä»ç„¶æœ‰å¤§é‡çš„è½¬å‘ã€è¯„è®ºã€èµã€‚ä¸Šè¿°æƒ…å†µéƒ½ä¼šé€ æˆè¯¥è½¦æ¬¡ä¿¡æ¯ã€è¯¥æ¡å¾®åšå­˜åœ¨å¹¶å‘ç«äº‰è¯»å–çš„é—®é¢˜ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>è¦è§£å†³å¹¶å‘ç«äº‰ï¼Œæœ‰ 2 ç§æ–¹æ¡ˆã€‚</p>
<ul>
<li><p>æ–¹æ¡ˆä¸€æ˜¯ä½¿ç”¨<strong>å…¨å±€é”</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå³å½“ç¼“å­˜è¯·æ±‚ miss åï¼Œå…ˆå°è¯•åŠ å…¨å±€é”ï¼Œåªæœ‰åŠ å…¨å±€é”æˆåŠŸçš„çº¿ç¨‹ï¼Œæ‰å¯ä»¥åˆ° DB å»åŠ è½½æ•°æ®ã€‚å…¶ä»–è¿›ç¨‹/çº¿ç¨‹åœ¨è¯»å–ç¼“å­˜æ•°æ® miss æ—¶ï¼Œå¦‚æœå‘ç°è¿™ä¸ª key æœ‰å…¨å±€é”ï¼Œå°±è¿›è¡Œç­‰å¾…ï¼Œå¾…ä¹‹å‰çš„çº¿ç¨‹å°†æ•°æ®ä» DB å›ç§åˆ°ç¼“å­˜åï¼Œå†ä»ç¼“å­˜è·å–ã€‚</p>
<p><img src="http://image.leonote.cn//20210206191657.jpg" alt=""></p>
</li>
<li><p>æ–¹æ¡ˆäºŒæ˜¯ï¼Œå¯¹ç¼“å­˜æ•°æ®ä¿æŒå¤šä¸ªå¤‡ä»½ï¼Œå³ä¾¿å…¶ä¸­ä¸€ä¸ªå¤‡ä»½ä¸­çš„æ•°æ®è¿‡æœŸæˆ–è¢«å‰”é™¤äº†ï¼Œè¿˜å¯ä»¥è®¿é—®å…¶ä»–å¤‡ä»½ï¼Œä»è€Œå‡å°‘æ•°æ®å¹¶å‘ç«äº‰çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="http://image.leonote.cn//20210206191829.jpg" alt=""></p>
</li>
</ul>
<h2 id="Hot-key"><a href="#Hot-key" class="headerlink" title="Hot key"></a>Hot key</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>ç¬¬å…­ä¸ªç»å…¸é—®é¢˜æ˜¯ Hot keyã€‚</p>
<p>å¯¹äºå¤§å¤šæ•°äº’è”ç½‘ç³»ç»Ÿï¼Œæ•°æ®æ˜¯åˆ†å†·çƒ­çš„ã€‚æ¯”å¦‚æœ€è¿‘çš„æ–°é—»ã€æ–°å‘è¡¨çš„å¾®åšè¢«è®¿é—®çš„é¢‘ç‡æœ€é«˜ï¼Œè€Œæ¯”è¾ƒä¹…è¿œçš„ä¹‹å‰çš„æ–°é—»ã€å¾®åšè¢«è®¿é—®çš„é¢‘ç‡å°±ä¼šå°å¾ˆå¤šã€‚è€Œåœ¨çªå‘äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¤§é‡ç”¨æˆ·åŒæ—¶å»è®¿é—®è¿™ä¸ªçªå‘çƒ­ç‚¹ä¿¡æ¯ï¼Œè®¿é—®è¿™ä¸ª Hot keyï¼Œè¿™ä¸ªçªå‘çƒ­ç‚¹ä¿¡æ¯æ‰€åœ¨çš„ç¼“å­˜èŠ‚ç‚¹å°±å¾ˆå®¹æ˜“å‡ºç°è¿‡è½½å’Œå¡é¡¿ç°è±¡ï¼Œç”šè‡³ä¼šè¢« Crashã€‚</p>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>Hot key å¼•å‘ç¼“å­˜ç³»ç»Ÿå¼‚å¸¸ï¼Œä¸»è¦æ˜¯å› ä¸ºçªå‘çƒ­é—¨äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¶…å¤§é‡çš„è¯·æ±‚è®¿é—®çƒ­ç‚¹äº‹ä»¶å¯¹åº”çš„ keyï¼Œæ¯”å¦‚å¾®åšä¸­æ•°åä¸‡ã€æ•°ç™¾ä¸‡çš„ç”¨æˆ·åŒæ—¶å»åƒä¸€ä¸ªæ–°ç“œã€‚æ•°åä¸‡çš„è®¿é—®è¯·æ±‚åŒä¸€ä¸ª keyï¼Œæµé‡é›†ä¸­æ‰“åœ¨ä¸€ä¸ªç¼“å­˜èŠ‚ç‚¹æœºå™¨ï¼Œè¿™ä¸ªç¼“å­˜æœºå™¨å¾ˆå®¹æ˜“è¢«æ‰“åˆ°ç‰©ç†ç½‘å¡ã€å¸¦å®½ã€CPU çš„æé™ï¼Œä»è€Œå¯¼è‡´ç¼“å­˜è®¿é—®å˜æ…¢ã€å¡é¡¿ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>å¼•å‘ Hot key çš„ä¸šåŠ¡åœºæ™¯å¾ˆå¤šï¼Œæ¯”å¦‚æ˜æ˜Ÿç»“å©šã€ç¦»å©šã€å‡ºè½¨è¿™ç§ç‰¹æ®Šçªå‘äº‹ä»¶ï¼Œæ¯”å¦‚å¥¥è¿ã€æ˜¥èŠ‚è¿™äº›é‡å¤§æ´»åŠ¨æˆ–èŠ‚æ—¥ï¼Œè¿˜æ¯”å¦‚ç§’æ€ã€åŒ12ã€618 ç­‰çº¿ä¸Šä¿ƒé”€æ´»åŠ¨ï¼Œéƒ½å¾ˆå®¹æ˜“å‡ºç° Hot key çš„æƒ…å†µã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>è¦è§£å†³è¿™ç§æçƒ­ key çš„é—®é¢˜ï¼Œé¦–å…ˆè¦æ‰¾å‡ºè¿™äº› Hot key æ¥ã€‚å¯¹äºé‡è¦èŠ‚å‡æ—¥ã€çº¿ä¸Šä¿ƒé”€æ´»åŠ¨ã€é›†ä¸­æ¨é€è¿™äº›<strong>æå‰å·²çŸ¥çš„äº‹æƒ…ï¼Œå¯ä»¥æå‰è¯„ä¼°å‡ºå¯èƒ½çš„çƒ­ key æ¥</strong>ã€‚è€Œå¯¹äºçªå‘äº‹ä»¶ï¼Œæ— æ³•æå‰è¯„ä¼°ï¼Œå¯ä»¥<strong>é€šè¿‡ Sparkï¼Œå¯¹åº”æµä»»åŠ¡è¿›è¡Œå®æ—¶åˆ†æï¼ŒåŠæ—¶å‘ç°æ–°å‘å¸ƒçš„çƒ­ç‚¹ key</strong>ã€‚è€Œå¯¹äºä¹‹å‰å·²å‘å‡ºçš„äº‹æƒ…ï¼Œé€æ­¥å‘é…µæˆä¸ºçƒ­ key çš„ï¼Œåˆ™å¯ä»¥<strong>é€šè¿‡ Hadoop å¯¹æ‰¹å¤„ç†ä»»åŠ¡ç¦»çº¿è®¡ç®—ï¼Œæ‰¾å‡ºæœ€è¿‘å†å²æ•°æ®ä¸­çš„é«˜é¢‘çƒ­ key</strong>ã€‚</p>
<p>æ‰¾åˆ°çƒ­ key åï¼Œå°±æœ‰å¾ˆå¤šè§£å†³åŠæ³•äº†ã€‚é¦–å…ˆå¯ä»¥å°†è¿™äº›çƒ­ key è¿›è¡Œåˆ†æ•£å¤„ç†ï¼Œæ¯”å¦‚ä¸€ä¸ªçƒ­ key åå­—å« hotkeyï¼Œå¯ä»¥è¢«åˆ†æ•£ä¸º hotkey#1ã€hotkey#2ã€hotkey#3ï¼Œâ€¦â€¦hotkey#nï¼Œè¿™ n ä¸ª key åˆ†æ•£å­˜åœ¨å¤šä¸ªç¼“å­˜èŠ‚ç‚¹ï¼Œç„¶å client ç«¯è¯·æ±‚æ—¶ï¼Œéšæœºè®¿é—®å…¶ä¸­æŸä¸ªåç¼€çš„ hotkeyï¼Œè¿™æ ·å°±å¯ä»¥æŠŠçƒ­ key çš„è¯·æ±‚æ‰“æ•£ï¼Œé¿å…ä¸€ä¸ªç¼“å­˜èŠ‚ç‚¹è¿‡è½½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn//20210206193555.jpg" alt=""></p>
<p>å…¶æ¬¡ï¼Œä¹Ÿå¯ä»¥ key çš„åå­—ä¸å˜ï¼Œå¯¹ç¼“å­˜æå‰è¿›è¡Œå¤šå‰¯æœ¬+å¤šçº§ç»“åˆçš„ç¼“å­˜æ¶æ„è®¾è®¡ã€‚</p>
<p>å†æ¬¡ï¼Œå¦‚æœçƒ­ key è¾ƒå¤šï¼Œè¿˜å¯ä»¥é€šè¿‡ç›‘æ§ä½“ç³»å¯¹ç¼“å­˜çš„ SLA å®æ—¶ç›‘æ§ï¼Œé€šè¿‡å¿«é€Ÿæ‰©å®¹æ¥å‡å°‘çƒ­ key çš„å†²å‡»ã€‚</p>
<p>æœ€åï¼Œä¸šåŠ¡ç«¯è¿˜å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå°†è¿™äº›çƒ­ key è®°å½•åœ¨æœ¬åœ°ç¼“å­˜ï¼Œæ¥å‡å°‘å¯¹è¿œç¨‹ç¼“å­˜çš„å†²å‡»ã€‚</p>
<h2 id="Big-key"><a href="#Big-key" class="headerlink" title="Big key"></a>Big key</h2><p><strong>é—®é¢˜æè¿°</strong></p>
<p>æœ€åä¸€ä¸ªç»å…¸é—®é¢˜æ˜¯ Big keyï¼Œä¹Ÿå°±æ˜¯å¤§ Key çš„é—®é¢˜ã€‚å¤§ keyï¼Œæ˜¯æŒ‡åœ¨ç¼“å­˜è®¿é—®æ—¶ï¼Œ<strong>éƒ¨åˆ† Key çš„ Value è¿‡å¤§ï¼Œè¯»å†™ã€åŠ è½½æ˜“è¶…æ—¶çš„ç°è±¡</strong>ã€‚</p>
<p><strong>åŸå› åˆ†æ</strong></p>
<p>é€ æˆè¿™äº›å¤§ key æ…¢æŸ¥è¯¢çš„åŸå› å¾ˆå¤šã€‚å¦‚æœè¿™äº›å¤§ key å æ€»ä½“æ•°æ®çš„æ¯”ä¾‹å¾ˆå°ï¼Œå­˜ Mcï¼Œå¯¹åº”çš„ slab è¾ƒå°‘ï¼Œå¯¼è‡´å¾ˆå®¹æ˜“è¢«é¢‘ç¹å‰”é™¤ï¼ŒDB åå¤åŠ è½½ï¼Œä»è€Œå¯¼è‡´æŸ¥è¯¢è¾ƒæ…¢ã€‚å¦‚æœä¸šåŠ¡ä¸­è¿™ç§å¤§ key å¾ˆå¤šï¼Œè€Œè¿™ç§ key è¢«å¤§é‡è®¿é—®ï¼Œç¼“å­˜ç»„ä»¶çš„ç½‘å¡ã€å¸¦å®½å¾ˆå®¹æ˜“è¢«æ‰“æ»¡ï¼Œä¹Ÿä¼šå¯¼è‡´è¾ƒå¤šçš„å¤§ key æ…¢æŸ¥è¯¢ã€‚å¦å¤–ï¼Œå¦‚æœå¤§ key ç¼“å­˜çš„å­—æ®µè¾ƒå¤šï¼Œæ¯ä¸ªå­—æ®µçš„å˜æ›´éƒ½ä¼šå¼•å‘å¯¹è¿™ä¸ªç¼“å­˜æ•°æ®çš„å˜æ›´ï¼ŒåŒæ—¶è¿™äº› key ä¹Ÿä¼šè¢«é¢‘ç¹åœ°è¯»å–ï¼Œè¯»å†™ç›¸äº’å½±å“ï¼Œä¹Ÿä¼šå¯¼è‡´æ…¢æŸ¥ç°è±¡ã€‚æœ€åï¼Œå¤§ key ä¸€æ—¦è¢«ç¼“å­˜æ·˜æ±°ï¼ŒDB åŠ è½½å¯èƒ½éœ€è¦èŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´å¤§ key æŸ¥è¯¢æ…¢çš„é—®é¢˜ã€‚</p>
<p><strong>ä¸šåŠ¡åœºæ™¯</strong></p>
<p>å¤§ key çš„ä¸šåŠ¡åœºæ™¯ä¹Ÿæ¯”è¾ƒå¸¸è§ã€‚æ¯”å¦‚äº’è”ç½‘ç³»ç»Ÿä¸­éœ€è¦ä¿å­˜ç”¨æˆ·æœ€æ–° 1ä¸‡ ä¸ªç²‰ä¸çš„ä¸šåŠ¡ï¼Œæ¯”å¦‚ä¸€ä¸ªç”¨æˆ·ä¸ªäººä¿¡æ¯ç¼“å­˜ï¼ŒåŒ…æ‹¬åŸºæœ¬èµ„æ–™ã€å…³ç³»å›¾è°±è®¡æ•°ã€å‘ feed ç»Ÿè®¡ç­‰ã€‚å¾®åšçš„ feed å†…å®¹ç¼“å­˜ä¹Ÿå¾ˆå®¹æ˜“å‡ºç°ï¼Œä¸€èˆ¬ç”¨æˆ·å¾®åšåœ¨ 140 å­—ä»¥å†…ï¼Œä½†å¾ˆå¤šç”¨æˆ·ä¹Ÿä¼šå‘è¡¨ 1åƒ å­—ç”šè‡³æ›´é•¿çš„å¾®åšå†…å®¹ï¼Œè¿™äº›é•¿å¾®åšä¹Ÿå°±æˆäº†å¤§ keyï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="http://image.leonote.cn//20210206194147.jpg" alt=""></p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong></p>
<p>å¯¹äºå¤§ keyï¼Œç»™å‡º 3 ç§è§£å†³æ–¹æ¡ˆã€‚</p>
<ul>
<li>ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå¦‚æœæ•°æ®å­˜åœ¨ Mc ä¸­ï¼Œå¯ä»¥è®¾è®¡ä¸€ä¸ªç¼“å­˜é˜€å€¼ï¼Œå½“ value çš„é•¿åº¦è¶…è¿‡é˜€å€¼ï¼Œåˆ™å¯¹å†…å®¹å¯ç”¨å‹ç¼©ï¼Œè®© KV å°½é‡ä¿æŒå°çš„ sizeï¼Œå…¶æ¬¡è¯„ä¼°å¤§ key æ‰€å çš„æ¯”ä¾‹ï¼Œåœ¨ Mc å¯åŠ¨ä¹‹åˆï¼Œå°±ç«‹å³é¢„å†™è¶³å¤Ÿæ•°æ®çš„å¤§ keyï¼Œè®© Mc é¢„å…ˆåˆ†é…è¶³å¤Ÿå¤šçš„ trunk size è¾ƒå¤§çš„ slabã€‚ç¡®ä¿åé¢ç³»ç»Ÿè¿è¡Œæ—¶ï¼Œå¤§ key æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥è¿›è¡Œç¼“å­˜ã€‚       </li>
</ul>
<p>â€‹      <img src="http://image.leonote.cn//20210206194550.jpg" alt=""></p>
<ul>
<li><p>ç¬¬äºŒç§æ–¹æ¡ˆï¼Œå¦‚æœæ•°æ®å­˜åœ¨ Redis ä¸­ï¼Œæ¯”å¦‚ä¸šåŠ¡æ•°æ®å­˜ set æ ¼å¼ï¼Œå¤§ key å¯¹åº”çš„ set ç»“æ„æœ‰å‡ åƒå‡ ä¸‡ä¸ªå…ƒç´ ï¼Œè¿™ç§å†™å…¥ Redis æ—¶ä¼šæ¶ˆè€—å¾ˆé•¿çš„æ—¶é—´ï¼Œå¯¼è‡´ Redis å¡é¡¿ã€‚æ­¤æ—¶ï¼Œå¯ä»¥æ‰©å±•æ–°çš„æ•°æ®ç»“æ„ï¼ŒåŒæ—¶è®© client åœ¨è¿™äº›å¤§ key å†™ç¼“å­˜ä¹‹å‰ï¼Œè¿›è¡Œåºåˆ—åŒ–æ„å»ºï¼Œç„¶åé€šè¿‡ restore ä¸€æ¬¡æ€§å†™å…¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p> <img src="http://image.leonote.cn//20210206194719.jpg" alt=""></p>
</li>
<li><p>ç¬¬ä¸‰ç§æ–¹æ¡ˆæ—¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°†å¤§ key åˆ†æ‹†ä¸ºå¤šä¸ª keyï¼Œå°½é‡å‡å°‘å¤§ key çš„å­˜åœ¨ã€‚åŒæ—¶ç”±äºå¤§ key ä¸€æ—¦ç©¿é€åˆ° DBï¼ŒåŠ è½½è€—æ—¶å¾ˆå¤§ï¼Œæ‰€ä»¥å¯ä»¥å¯¹è¿™äº›å¤§ key è¿›è¡Œç‰¹æ®Šç…§é¡¾ï¼Œæ¯”å¦‚è®¾ç½®è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ç¼“å­˜å†…éƒ¨åœ¨æ·˜æ±° key æ—¶ï¼ŒåŒç­‰æ¡ä»¶ä¸‹ï¼Œå°½é‡ä¸æ·˜æ±°è¿™äº›å¤§ keyã€‚</p>
<p><img src="http://image.leonote.cn//20210206194824.jpg" alt=""></p>
</li>
</ul>
<blockquote>
<p>å¯¹äºäº’è”ç½‘ç³»ç»Ÿï¼Œç”±äºå®é™…ä¸šåŠ¡åœºæ™¯å¤æ‚ï¼Œæ•°æ®é‡ã€è®¿é—®é‡å·¨å¤§ï¼Œéœ€è¦æå‰è§„é¿ç¼“å­˜ä½¿ç”¨ä¸­çš„å„ç§å‘ã€‚å¯ä»¥é€šè¿‡æå‰ç†Ÿæ‚‰ Cache çš„ç»å…¸é—®é¢˜ï¼Œæå‰æ„å»ºé˜²å¾¡æªæ–½ï¼Œ é¿å…å¤§é‡ key åŒæ—¶å¤±æ•ˆï¼Œé¿å…ä¸å­˜åœ¨ key è®¿é—®çš„ç©¿é€ï¼Œå‡å°‘å¤§ keyã€çƒ­ key çš„ç¼“å­˜å¤±æ•ˆï¼Œå¯¹çƒ­ key è¿›è¡Œåˆ†æµã€‚å¯ä»¥é‡‡å–ä¸€ç³»åˆ—æªæ–½ï¼Œè®©è®¿é—®å°½é‡å‘½ä¸­ç¼“å­˜ï¼ŒåŒæ—¶ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥ç»“åˆä¸šåŠ¡æ¨¡å‹ï¼Œæå‰è§„åˆ’ cache ç³»ç»Ÿçš„ SLAï¼Œå¦‚ QPSã€å“åº”åˆ†å¸ƒã€å¹³å‡è€—æ—¶ç­‰ï¼Œå®æ–½ç›‘æ§ï¼Œä»¥æ–¹ä¾¿è¿ç»´åŠæ—¶åº”å¯¹ã€‚åœ¨é‡åˆ°éƒ¨åˆ†èŠ‚ç‚¹å¼‚å¸¸ï¼Œæˆ–è€…é‡åˆ°çªå‘æµé‡ã€æç«¯äº‹ä»¶æ—¶ï¼Œä¹Ÿèƒ½é€šè¿‡åˆ†æ± åˆ†å±‚ç­–ç•¥ã€key åˆ†æ‹†ç­‰ç­–ç•¥ï¼Œé¿å…æ•…éšœå‘ç”Ÿã€‚</p>
</blockquote>
<p>æœ€ç»ˆï¼Œä½ èƒ½åœ¨å„ç§å¤æ‚åœºæ™¯ä¸‹ï¼Œé¢å¯¹é«˜å¹¶å‘ã€æµ·é‡è®¿é—®ï¼Œé¢å¯¹çªå‘äº‹ä»¶å’Œæ´ªå³°æµé‡ï¼Œé¢å¯¹å„ç§ç½‘ç»œæˆ–æœºå™¨ç¡¬ä»¶æ•…éšœï¼Œéƒ½èƒ½ä¿æŒæœåŠ¡çš„é«˜æ€§èƒ½å’Œé«˜å¯ç”¨ã€‚</p>
]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>åŒæºç­–ç•¥</title>
    <url>/2020/05/29/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<blockquote>
<p>ã€è½¬è½½ã€‘</p>
<p>ä½œè€…ï¼šlaixiangran</p>
<p>é“¾æ¥ï¼š<a href="https://juejin.im/post/5ba1d4fe6fb9a05ce873d4ad">https://juejin.im/post/5ba1d4fe6fb9a05ce873d4ad</a></p>
</blockquote>
<h2 id="ä»€ä¹ˆæ˜¯æµè§ˆå™¨åŒæºç­–ç•¥"><a href="#ä»€ä¹ˆæ˜¯æµè§ˆå™¨åŒæºç­–ç•¥" class="headerlink" title="ä»€ä¹ˆæ˜¯æµè§ˆå™¨åŒæºç­–ç•¥"></a>ä»€ä¹ˆæ˜¯æµè§ˆå™¨åŒæºç­–ç•¥</h2><p>åŒæºç­–ç•¥ï¼ˆSame origin policyï¼‰æ˜¯ä¸€ç§çº¦å®šï¼Œå®ƒæ˜¯æµè§ˆå™¨æœ€æ ¸å¿ƒä¹Ÿæœ€åŸºæœ¬çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚æœç¼ºå°‘äº†åŒæºç­–ç•¥ï¼Œåˆ™æµè§ˆå™¨çš„æ­£å¸¸åŠŸèƒ½å¯èƒ½éƒ½ä¼šå—åˆ°å½±å“ã€‚å¯ä»¥è¯´ Web æ˜¯æ„å»ºåœ¨åŒæºç­–ç•¥åŸºç¡€ä¹‹ä¸Šçš„ï¼Œæµè§ˆå™¨åªæ˜¯é’ˆå¯¹åŒæºç­–ç•¥çš„ä¸€ç§å®ç°ã€‚</p>
<p>å®ƒçš„æ ¸å¿ƒå°±åœ¨äºå®ƒè®¤ä¸ºè‡ªä»»ä½•ç«™ç‚¹è£…è½½çš„ä¿¡èµ–å†…å®¹æ˜¯ä¸å®‰å…¨çš„ã€‚å½“è¢«æµè§ˆå™¨åŠä¿¡åŠç–‘çš„è„šæœ¬è¿è¡Œåœ¨æ²™ç®±æ—¶ï¼Œå®ƒä»¬åº”è¯¥åªè¢«å…è®¸è®¿é—®æ¥è‡ªåŒä¸€ç«™ç‚¹çš„èµ„æºï¼Œè€Œä¸æ˜¯é‚£äº›æ¥è‡ªå…¶å®ƒç«™ç‚¹å¯èƒ½æ€€æœ‰æ¶æ„çš„èµ„æºã€‚</p>
<p>æ‰€è°“åŒæºæ˜¯æŒ‡ï¼šåŸŸåã€åè®®ã€ç«¯å£ç›¸åŒã€‚</p>
<p>ä¸‹è¡¨æ˜¯ç›¸å¯¹äº <code>http://www.laixiangran.cn/home/index.html</code> çš„åŒæºæ£€æµ‹ç»“æœï¼š</p>
<table>
<thead>
<tr>
<th align="center">URL</th>
<th align="center">ç»“æœ</th>
<th align="center">åŸå› </th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="http://www.laixiangran.cn/home/index.html">http://www.laixiangran.cn/home/index.html</a></td>
<td align="center">æˆåŠŸ</td>
<td align="center">åŸŸåã€åè®®ã€ç«¯å£å‡ä¸åŒ</td>
</tr>
<tr>
<td align="center"><a href="https://www.laixiangran.cn/home/index.html">https://www.laixiangran.cn/home/index.html</a></td>
<td align="center">å¤±è´¥</td>
<td align="center">åè®®ä¸åŒ</td>
</tr>
<tr>
<td align="center"><a href="http://www.laixiangran.cn:8080/home/index.html">http://www.laixiangran.cn:8080/home/index.html</a></td>
<td align="center">å¤±è´¥</td>
<td align="center">ç«¯å£ä¸åŒ</td>
</tr>
<tr>
<td align="center"><a href="http://www.laixiangran.cn/other/index.html">http://www.laixiangran.cn/other/index.html</a></td>
<td align="center">å¤±è´¥</td>
<td align="center">åŸŸåä¸åŒ</td>
</tr>
</tbody></table>
<p>å¦å¤–ï¼ŒåŒæºç­–ç•¥åˆåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ol>
<li>DOM åŒæºç­–ç•¥ï¼šç¦æ­¢å¯¹ä¸åŒæºé¡µé¢ DOM è¿›è¡Œæ“ä½œã€‚è¿™é‡Œä¸»è¦åœºæ™¯æ˜¯ iframe è·¨åŸŸçš„æƒ…å†µï¼Œä¸åŒåŸŸåçš„ iframe æ˜¯é™åˆ¶äº’ç›¸è®¿é—®çš„ã€‚</li>
<li>XMLHttpRequest åŒæºç­–ç•¥ï¼šç¦æ­¢ä½¿ç”¨ XHR å¯¹è±¡å‘ä¸åŒæºçš„æœåŠ¡å™¨åœ°å€å‘èµ· HTTP è¯·æ±‚ã€‚</li>
</ol>
<h2 id="ä¸ºä»€ä¹ˆè¦æœ‰è·¨åŸŸé™åˆ¶"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰è·¨åŸŸé™åˆ¶" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰è·¨åŸŸé™åˆ¶"></a>ä¸ºä»€ä¹ˆè¦æœ‰è·¨åŸŸé™åˆ¶</h2><p>å› ä¸ºå­˜åœ¨æµè§ˆå™¨åŒæºç­–ç•¥ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰è·¨åŸŸé—®é¢˜ã€‚é‚£ä¹ˆæµè§ˆå™¨æ˜¯å‡ºäºä½•ç§åŸå› ä¼šæœ‰è·¨åŸŸçš„é™åˆ¶å‘¢ã€‚å…¶å®ä¸éš¾æƒ³åˆ°ï¼Œè·¨åŸŸé™åˆ¶ä¸»è¦çš„ç›®çš„å°±æ˜¯ä¸ºäº†ç”¨æˆ·çš„ä¸Šç½‘å®‰å…¨ã€‚</p>
<p>å¦‚æœæµè§ˆå™¨æ²¡æœ‰åŒæºç­–ç•¥ï¼Œä¼šå­˜åœ¨ä»€ä¹ˆæ ·çš„å®‰å…¨é—®é¢˜å‘¢ã€‚ä¸‹é¢ä» DOM åŒæºç­–ç•¥å’Œ XMLHttpRequest åŒæºç­–ç•¥æ¥ä¸¾ä¾‹è¯´æ˜ï¼š</p>
<p><strong>å¦‚æœæ²¡æœ‰ DOM åŒæºç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒåŸŸçš„ iframe ä¹‹é—´å¯ä»¥ç›¸äº’è®¿é—®ï¼Œé‚£ä¹ˆé»‘å®¢å¯ä»¥è¿™æ ·è¿›è¡Œæ”»å‡»ï¼š</strong></p>
<ol>
<li>åšä¸€ä¸ªå‡ç½‘ç«™ï¼Œé‡Œé¢ç”¨ iframe åµŒå¥—ä¸€ä¸ªé“¶è¡Œç½‘ç«™ <code>http://mybank.com</code>ã€‚</li>
<li>æŠŠ iframe å®½é«˜å•¥çš„è°ƒæ•´åˆ°é¡µé¢å…¨éƒ¨ï¼Œè¿™æ ·ç”¨æˆ·è¿›æ¥é™¤äº†åŸŸåï¼Œåˆ«çš„éƒ¨åˆ†å’Œé“¶è¡Œçš„ç½‘ç«™æ²¡æœ‰ä»»ä½•å·®åˆ«ã€‚</li>
<li>è¿™æ—¶å¦‚æœç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œæˆ‘ä»¬çš„ä¸»ç½‘ç«™å¯ä»¥è·¨åŸŸè®¿é—®åˆ° <code>http://mybank.com</code> çš„ dom èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ‹¿åˆ°ç”¨æˆ·çš„è´¦æˆ·å¯†ç äº†ã€‚</li>
</ol>
<p><strong>å¦‚æœæ²¡æœ‰ XMLHttpRequest åŒæºç­–ç•¥ï¼Œé‚£ä¹ˆé»‘å®¢å¯ä»¥è¿›è¡Œ CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ æ”»å‡»ï¼š</strong></p>
<ol>
<li>ç”¨æˆ·ç™»å½•äº†è‡ªå·±çš„é“¶è¡Œé¡µé¢ <code>http://mybank.com</code>ï¼Œ<code>http://mybank.com</code> å‘ç”¨æˆ·çš„ cookie ä¸­æ·»åŠ ç”¨æˆ·æ ‡è¯†ã€‚</li>
<li>ç”¨æˆ·æµè§ˆäº†æ¶æ„é¡µé¢ <code>http://evil.com</code>ï¼Œæ‰§è¡Œäº†é¡µé¢ä¸­çš„æ¶æ„ AJAX è¯·æ±‚ä»£ç ã€‚</li>
<li><code>http://evil.com</code> å‘ <code>http://mybank.com</code> å‘èµ· AJAX HTTP è¯·æ±‚ï¼Œè¯·æ±‚ä¼šé»˜è®¤æŠŠ <code>http://mybank.com</code> å¯¹åº” cookie ä¹ŸåŒæ—¶å‘é€è¿‡å»ã€‚</li>
<li>é“¶è¡Œé¡µé¢ä»å‘é€çš„ cookie ä¸­æå–ç”¨æˆ·æ ‡è¯†ï¼ŒéªŒè¯ç”¨æˆ·æ— è¯¯ï¼Œresponse ä¸­è¿”å›è¯·æ±‚æ•°æ®ã€‚æ­¤æ—¶æ•°æ®å°±æ³„éœ²äº†ã€‚</li>
<li>è€Œä¸”ç”±äº Ajax åœ¨åå°æ‰§è¡Œï¼Œç”¨æˆ·æ— æ³•æ„ŸçŸ¥è¿™ä¸€è¿‡ç¨‹ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œæœ‰äº†æµè§ˆå™¨åŒæºç­–ç•¥ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´å®‰å…¨çš„ä¸Šç½‘ã€‚</p>
<h2 id="è·¨åŸŸçš„è§£å†³æ–¹æ³•"><a href="#è·¨åŸŸçš„è§£å†³æ–¹æ³•" class="headerlink" title="è·¨åŸŸçš„è§£å†³æ–¹æ³•"></a>è·¨åŸŸçš„è§£å†³æ–¹æ³•</h2><p>ä»ä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°äº†æµè§ˆå™¨åŒæºç­–ç•¥çš„ä½œç”¨ï¼Œä¹Ÿæ­£æ˜¯æœ‰äº†è·¨åŸŸé™åˆ¶ï¼Œæ‰ä½¿æˆ‘ä»¬èƒ½å®‰å…¨çš„ä¸Šç½‘ã€‚ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦çªç ´è¿™æ ·çš„é™åˆ¶ï¼Œå› æ­¤ä¸‹é¢å°†ä»‹ç»å‡ ç§è·¨åŸŸçš„è§£å†³æ–¹æ³•ã€‚</p>
<h3 id="CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰"><a href="#CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰" class="headerlink" title="CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰"></a>CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰</h3><p>CORSï¼ˆCross-origin resource sharingï¼Œè·¨åŸŸèµ„æºå…±äº«ï¼‰æ˜¯ä¸€ä¸ª W3C æ ‡å‡†ï¼Œå®šä¹‰äº†åœ¨å¿…é¡»è®¿é—®è·¨åŸŸèµ„æºæ—¶ï¼Œæµè§ˆå™¨ä¸æœåŠ¡å™¨åº”è¯¥å¦‚ä½•æ²Ÿé€šã€‚CORS èƒŒåçš„åŸºæœ¬æ€æƒ³ï¼Œå°±æ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„ HTTP å¤´éƒ¨è®©æµè§ˆå™¨ä¸æœåŠ¡å™¨è¿›è¡Œæ²Ÿé€šï¼Œä»è€Œå†³å®šè¯·æ±‚æˆ–å“åº”æ˜¯åº”è¯¥æˆåŠŸï¼Œè¿˜æ˜¯åº”è¯¥å¤±è´¥ã€‚</p>
<p>CORS éœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼ŒIE æµè§ˆå™¨ä¸èƒ½ä½äº IE10ã€‚</p>
<p>æ•´ä¸ª CORS é€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒCORS é€šä¿¡ä¸åŒæºçš„ AJAX é€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘ç° AJAX è¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚</p>
<p>å› æ­¤ï¼Œå®ç° CORS é€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®ç°äº† CORS æ¥å£ï¼Œå°±å¯ä»¥è·¨æºé€šä¿¡ã€‚</p>
<p>æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚</p>
<p>åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äº<strong>ç®€å•è¯·æ±‚</strong>ã€‚</p>
<ol>
<li>è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š</li>
</ol>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
<ol>
<li>HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š</li>
</ol>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Last-Event-ID</li>
<li>Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼ application/x-www-form-urlencodedã€multipart/form-dataã€text/plain</li>
</ul>
<p>å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±äº<strong>éç®€å•è¯·æ±‚</strong>ã€‚</p>
<p>æµè§ˆå™¨å¯¹è¿™ä¸¤ç§è¯·æ±‚çš„å¤„ç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<h4 id="ç®€å•è¯·æ±‚"><a href="#ç®€å•è¯·æ±‚" class="headerlink" title="ç®€å•è¯·æ±‚"></a>ç®€å•è¯·æ±‚</h4><ol>
<li>åœ¨è¯·æ±‚ä¸­éœ€è¦é™„åŠ ä¸€ä¸ªé¢å¤–çš„ Origin å¤´éƒ¨ï¼Œå…¶ä¸­åŒ…å«è¯·æ±‚é¡µé¢çš„æºä¿¡æ¯ï¼ˆåè®®ã€åŸŸåå’Œç«¯å£ï¼‰ï¼Œä»¥ä¾¿æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå¤´éƒ¨ä¿¡æ¯æ¥å†³å®šæ˜¯å¦ç»™äºˆå“åº”ã€‚ä¾‹å¦‚ï¼š<code>Origin: http://www.laixiangran.cn</code></li>
<li>å¦‚æœæœåŠ¡å™¨è®¤ä¸ºè¿™ä¸ªè¯·æ±‚å¯ä»¥æ¥å—ï¼Œå°±åœ¨ Access-Control-Allow-Origin å¤´éƒ¨ä¸­å›å‘ç›¸åŒçš„æºä¿¡æ¯ï¼ˆå¦‚æœæ˜¯å…¬å…±èµ„æºï¼Œå¯ä»¥å›å‘ * ï¼‰ã€‚ä¾‹å¦‚ï¼š<code>Access-Control-Allow-Originï¼šhttp://www.laixiangran.cn</code></li>
<li>æ²¡æœ‰è¿™ä¸ªå¤´éƒ¨æˆ–è€…æœ‰è¿™ä¸ªå¤´éƒ¨ä½†æºä¿¡æ¯ä¸åŒ¹é…ï¼Œæµè§ˆå™¨å°±ä¼šé©³å›è¯·æ±‚ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä¼šå¤„ç†è¯·æ±‚ã€‚æ³¨æ„ï¼Œè¯·æ±‚å’Œå“åº”éƒ½ä¸åŒ…å« cookie ä¿¡æ¯ã€‚</li>
<li>å¦‚æœéœ€è¦åŒ…å« cookie ä¿¡æ¯ï¼Œajax è¯·æ±‚éœ€è¦è®¾ç½® xhr çš„å±æ€§ withCredentials ä¸º trueï¼ŒæœåŠ¡å™¨éœ€è¦è®¾ç½®å“åº”å¤´éƒ¨ <code>Access-Control-Allow-Credentials: true</code>ã€‚</li>
</ol>
<h4 id="éç®€å•è¯·æ±‚"><a href="#éç®€å•è¯·æ±‚" class="headerlink" title="éç®€å•è¯·æ±‚"></a>éç®€å•è¯·æ±‚</h4><p>æµè§ˆå™¨åœ¨å‘é€çœŸæ­£çš„è¯·æ±‚ä¹‹å‰ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ª Preflight è¯·æ±‚ç»™æœåŠ¡å™¨ï¼Œè¿™ç§è¯·æ±‚ä½¿ç”¨ OPTIONS æ–¹æ³•ï¼Œå‘é€ä¸‹åˆ—å¤´éƒ¨ï¼š</p>
<ul>
<li>Originï¼šä¸ç®€å•çš„è¯·æ±‚ç›¸åŒã€‚</li>
<li>Access-Control-Request-Method: è¯·æ±‚è‡ªèº«ä½¿ç”¨çš„æ–¹æ³•ã€‚</li>
<li>Access-Control-Request-Headers: ï¼ˆå¯é€‰ï¼‰è‡ªå®šä¹‰çš„å¤´éƒ¨ä¿¡æ¯ï¼Œå¤šä¸ªå¤´éƒ¨ä»¥é€—å·åˆ†éš”ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">Origin</span>: <span class="string">http://www.laixiangran.cn</span></span><br><span class="line"><span class="meta">Access-Control-Request-Method</span>: <span class="string">POST</span></span><br><span class="line"><span class="meta">Access-Control-Request-Headers</span>: <span class="string">NCZ</span></span><br></pre></td></tr></table></figure>

<p>å‘é€è¿™ä¸ªè¯·æ±‚åï¼ŒæœåŠ¡å™¨å¯ä»¥å†³å®šæ˜¯å¦å…è®¸è¿™ç§ç±»å‹çš„è¯·æ±‚ã€‚æœåŠ¡å™¨é€šè¿‡åœ¨å“åº”ä¸­å‘é€å¦‚ä¸‹å¤´éƒ¨ä¸æµè§ˆå™¨è¿›è¡Œæ²Ÿé€šï¼š</p>
<ul>
<li>Access-Control-Allow-Originï¼šä¸ç®€å•çš„è¯·æ±‚ç›¸åŒã€‚</li>
<li>Access-Control-Allow-Methods: å…è®¸çš„æ–¹æ³•ï¼Œå¤šä¸ªæ–¹æ³•ä»¥é€—å·åˆ†éš”ã€‚</li>
<li>Access-Control-Allow-Headers: å…è®¸çš„å¤´éƒ¨ï¼Œå¤šä¸ªæ–¹æ³•ä»¥é€—å·åˆ†éš”ã€‚</li>
<li>Access-Control-Max-Age: åº”è¯¥å°†è¿™ä¸ª Preflight è¯·æ±‚ç¼“å­˜å¤šé•¿æ—¶é—´ï¼ˆä»¥ç§’è¡¨ç¤ºï¼‰ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">Access-Control-Allow-Origin</span>: <span class="string">http://www.laixiangran.cn</span></span><br><span class="line"><span class="meta">Access-Control-Allow-Methods</span>: <span class="string">GET, POST</span></span><br><span class="line"><span class="meta">Access-Control-Allow-Headers</span>: <span class="string">NCZ</span></span><br><span class="line"><span class="meta">Access-Control-Max-Age</span>: <span class="string">1728000</span></span><br></pre></td></tr></table></figure>

<p>ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡ Preflight è¯·æ±‚å…è®¸è¯¥è¯·æ±‚ä¹‹åï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„ CORS è¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·äº†ã€‚</p>
<h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul>
<li>CORS é€šä¿¡ä¸åŒæºçš„ AJAX é€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ï¼Œå®¹æ˜“ç»´æŠ¤ã€‚</li>
<li>æ”¯æŒæ‰€æœ‰ç±»å‹çš„ HTTP è¯·æ±‚ã€‚</li>
</ul>
<h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li>å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ IE10 ä»¥ä¸‹çš„æµè§ˆå™¨ã€‚</li>
<li>ç¬¬ä¸€æ¬¡å‘é€éç®€å•è¯·æ±‚æ—¶ä¼šå¤šä¸€æ¬¡è¯·æ±‚ã€‚</li>
</ul>
<h3 id="JSONP-è·¨åŸŸ"><a href="#JSONP-è·¨åŸŸ" class="headerlink" title="JSONP è·¨åŸŸ"></a>JSONP è·¨åŸŸ</h3><p>ç”±äº <code>script</code> æ ‡ç­¾ä¸å—æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œå…è®¸è·¨åŸŸå¼•ç”¨èµ„æºã€‚å› æ­¤å¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»º script æ ‡ç­¾ï¼Œç„¶ååˆ©ç”¨ src å±æ€§è¿›è¡Œè·¨åŸŸï¼Œè¿™ä¹Ÿå°±æ˜¯ JSONP è·¨åŸŸçš„åŸºæœ¬åŸç†ã€‚</p>
<p>ç›´æ¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜ JSONP å®ç°è·¨åŸŸçš„æµç¨‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. å®šä¹‰ä¸€ä¸ª å›è°ƒå‡½æ•° handleResponse ç”¨æ¥æ¥æ”¶è¿”å›çš„æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. åŠ¨æ€åˆ›å»ºä¸€ä¸ª script æ ‡ç­¾ï¼Œå¹¶ä¸”å‘Šè¯‰åç«¯å›è°ƒå‡½æ•°åå« handleResponse</span></span><br><span class="line"><span class="keyword">var</span> body = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> script = <span class="built_in">document</span>.gerElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">script.src = <span class="string">&#x27;http://www.laixiangran.cn/json?callback=handleResponse&#x27;</span>;</span><br><span class="line">body.appendChild(script);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. é€šè¿‡ script.src è¯·æ±‚ `http://www.laixiangran.cn/json?callback=handleResponse`ï¼Œ</span></span><br><span class="line"><span class="comment">// 4. åç«¯èƒ½å¤Ÿè¯†åˆ«è¿™æ ·çš„ URL æ ¼å¼å¹¶å¤„ç†è¯¥è¯·æ±‚ï¼Œç„¶åè¿”å› handleResponse(&#123;&quot;name&quot;: &quot;laixiangran&quot;&#125;) ç»™æµè§ˆå™¨</span></span><br><span class="line"><span class="comment">// 5. æµè§ˆå™¨åœ¨æ¥æ”¶åˆ° handleResponse(&#123;&quot;name&quot;: &quot;laixiangran&quot;&#125;) ä¹‹åç«‹å³æ‰§è¡Œ ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ handleResponse æ–¹æ³•ï¼Œè·å¾—åç«¯è¿”å›çš„æ•°æ®ï¼Œè¿™æ ·å°±å®Œæˆä¸€æ¬¡è·¨åŸŸè¯·æ±‚äº†ã€‚</span></span><br></pre></td></tr></table></figure>

<h4 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul>
<li>ä½¿ç”¨ç®€ä¾¿ï¼Œæ²¡æœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œç›®å‰æœ€æµè¡Œçš„ä¸€ç§è·¨åŸŸæ–¹æ³•ã€‚</li>
</ul>
<h4 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li>åªæ”¯æŒ GET è¯·æ±‚ã€‚</li>
<li>ç”±äºæ˜¯ä»å…¶å®ƒåŸŸä¸­åŠ è½½ä»£ç æ‰§è¡Œï¼Œå› æ­¤å¦‚æœå…¶ä»–åŸŸä¸å®‰å…¨ï¼Œå¾ˆå¯èƒ½ä¼šåœ¨å“åº”ä¸­å¤¹å¸¦ä¸€äº›æ¶æ„ä»£ç ã€‚</li>
<li>è¦ç¡®å®š JSONP è¯·æ±‚æ˜¯å¦å¤±è´¥å¹¶ä¸å®¹æ˜“ã€‚è™½ç„¶ HTML5 ç»™ script æ ‡ç­¾æ–°å¢äº†ä¸€ä¸ª onerror äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä½†æ˜¯å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚</li>
</ul>
<h3 id="å›¾åƒ-Ping-è·¨åŸŸ"><a href="#å›¾åƒ-Ping-è·¨åŸŸ" class="headerlink" title="å›¾åƒ Ping è·¨åŸŸ"></a>å›¾åƒ Ping è·¨åŸŸ</h3><p>ç”±äº <code>img</code> æ ‡ç­¾ä¸å—æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œå…è®¸è·¨åŸŸå¼•ç”¨èµ„æºã€‚å› æ­¤å¯ä»¥é€šè¿‡ img æ ‡ç­¾çš„ src å±æ€§è¿›è¡Œè·¨åŸŸï¼Œè¿™ä¹Ÿå°±æ˜¯å›¾åƒ Ping è·¨åŸŸçš„åŸºæœ¬åŸç†ã€‚</p>
<p>ç›´æ¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜å›¾åƒ Ping å®ç°è·¨åŸŸçš„æµç¨‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> img = <span class="keyword">new</span> Image();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ onload åŠ onerror äº‹ä»¶å¯ä»¥çŸ¥é“å“åº”æ˜¯ä»€ä¹ˆæ—¶å€™æ¥æ”¶åˆ°çš„ï¼Œä½†æ˜¯ä¸èƒ½è·å–å“åº”æ–‡æœ¬</span></span><br><span class="line">img.onload = img.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯·æ±‚æ•°æ®é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²å½¢å¼å‘é€</span></span><br><span class="line">img.src = <span class="string">&#x27;http://www.laixiangran.cn/test?name=laixiangran&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="ä¼˜ç‚¹-2"><a href="#ä¼˜ç‚¹-2" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul>
<li>ç”¨äºå®ç°è·Ÿè¸ªç”¨æˆ·ç‚¹å‡»é¡µé¢æˆ–åŠ¨æ€å¹¿å‘Šæ›å…‰æ¬¡æ•°æœ‰è¾ƒå¤§çš„ä¼˜åŠ¿ã€‚</li>
</ul>
<h4 id="ç¼ºç‚¹-2"><a href="#ç¼ºç‚¹-2" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ul>
<li>åªæ”¯æŒ GET è¯·æ±‚ã€‚</li>
<li>åªèƒ½æµè§ˆå™¨ä¸æœåŠ¡å™¨çš„å•å‘é€šä¿¡ï¼Œå› ä¸ºæµè§ˆå™¨ä¸èƒ½è®¿é—®æœåŠ¡å™¨çš„å“åº”æ–‡æœ¬ã€‚</li>
</ul>
<h3 id="æœåŠ¡å™¨ä»£ç†"><a href="#æœåŠ¡å™¨ä»£ç†" class="headerlink" title="æœåŠ¡å™¨ä»£ç†"></a>æœåŠ¡å™¨ä»£ç†</h3><p>æµè§ˆå™¨æœ‰è·¨åŸŸé™åˆ¶ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸å­˜åœ¨è·¨åŸŸé—®é¢˜ï¼Œæ‰€ä»¥å¯ä»¥ç”±æœåŠ¡å™¨è¯·æ±‚æ‰€æœ‰åŸŸçš„èµ„æºå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>æœåŠ¡å™¨ä»£ç†æ˜¯ä¸‡èƒ½çš„ã€‚</p>
<h3 id="document-domain-è·¨åŸŸ"><a href="#document-domain-è·¨åŸŸ" class="headerlink" title="document.domain è·¨åŸŸ"></a>document.domain è·¨åŸŸ</h3><p>å¯¹äºä¸»åŸŸåç›¸åŒï¼Œè€Œå­åŸŸåä¸åŒçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ document.domain æ¥è·¨åŸŸã€‚è¿™ç§æ–¹å¼éå¸¸é€‚ç”¨äº iframe è·¨åŸŸçš„æƒ…å†µã€‚</p>
<p>æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ªé¡µé¢ï¼Œå®ƒçš„åœ°å€æ˜¯ <code>http://www.laixiangran.cn/a.html</code>ï¼Œåœ¨è¿™ä¸ªé¡µé¢é‡Œé¢æœ‰ä¸€ä¸ª iframeï¼Œå®ƒçš„ src æ˜¯ <code>http://laixiangran.cn/b.html</code>ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªé¡µé¢ä¸å®ƒé‡Œé¢çš„ iframe æ¡†æ¶æ˜¯ä¸åŒåŸŸçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯æ— æ³•é€šè¿‡åœ¨é¡µé¢ä¸­ä¹¦å†™ js ä»£ç æ¥è·å– iframe ä¸­çš„ä¸œè¥¿çš„ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œdocument.domain å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ï¼Œæˆ‘ä»¬åªè¦æŠŠ <code>http://www.laixiangran.cn/a.html</code> å’Œ <code>http://laixiangran.cn/b.html</code> è¿™ä¸¤ä¸ªé¡µé¢çš„ document.domain éƒ½è®¾æˆç›¸åŒçš„åŸŸåå°±å¯ä»¥äº†ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œdocument.domain çš„è®¾ç½®æ˜¯æœ‰é™åˆ¶çš„ï¼Œæˆ‘ä»¬åªèƒ½æŠŠ document.domain è®¾ç½®æˆè‡ªèº«æˆ–æ›´é«˜ä¸€çº§çš„çˆ¶åŸŸï¼Œä¸”ä¸»åŸŸå¿…é¡»ç›¸åŒã€‚ä¾‹å¦‚ï¼š<code>a.b.laixiangran.cn</code> ä¸­æŸä¸ªæ–‡æ¡£çš„ document.domain å¯ä»¥è®¾æˆ <code>a.b.laixiangran.cn</code>ã€<code>b.laixiangran.cn</code> ã€<code>laixiangran.cn</code> ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä½†æ˜¯ä¸å¯ä»¥è®¾æˆ <code>c.a.b.laixiangran.cn</code> ï¼Œå› ä¸ºè¿™æ˜¯å½“å‰åŸŸçš„å­åŸŸï¼Œä¹Ÿä¸å¯ä»¥è®¾æˆ <code>baidu.com</code>ï¼Œå› ä¸ºä¸»åŸŸå·²ç»ä¸ç›¸åŒäº†ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨é¡µé¢ <code>http://www.laixiangran.cn/a.html</code> ä¸­è®¾ç½®document.domainï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://laixiangran.cn/b.html&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myIframe&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;test()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.domain = <span class="string">&#x27;laixiangran.cn&#x27;</span>; <span class="comment">// è®¾ç½®æˆä¸»åŸŸ</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="built_in">document</span>.getElementById(<span class="string">&#x27;myIframe&#x27;</span>).contentWindow);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨é¡µé¢ <code>http://laixiangran.cn/b.html</code> ä¸­ä¹Ÿè®¾ç½® document.domainï¼Œè€Œä¸”è¿™ä¹Ÿæ˜¯å¿…é¡»çš„ï¼Œè™½ç„¶è¿™ä¸ªæ–‡æ¡£çš„ domain å°±æ˜¯ <code>laixiangran.cn</code>ï¼Œä½†æ˜¯è¿˜æ˜¯å¿…é¡»æ˜¾å¼åœ°è®¾ç½® document.domain çš„å€¼ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.domain = <span class="string">&#x27;laixiangran.cn&#x27;</span>; <span class="comment">// document.domain è®¾ç½®æˆä¸ä¸»é¡µé¢ç›¸åŒ</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œ<code>http://www.laixiangran.cn/a.html</code> å°±å¯ä»¥é€šè¿‡ js è®¿é—®åˆ° <code>http://laixiangran.cn/b.html</code> ä¸­çš„å„ç§å±æ€§å’Œå¯¹è±¡äº†ã€‚</p>
<h3 id="window-name-è·¨åŸŸ"><a href="#window-name-è·¨åŸŸ" class="headerlink" title="window.name è·¨åŸŸ"></a><a href="http://window.name">window.name</a> è·¨åŸŸ</h3><p>window å¯¹è±¡æœ‰ä¸ª name å±æ€§ï¼Œè¯¥å±æ€§æœ‰ä¸ªç‰¹å¾ï¼šå³åœ¨ä¸€ä¸ªçª—å£ï¼ˆwindowï¼‰çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçª—å£è½½å…¥çš„æ‰€æœ‰çš„é¡µé¢ï¼ˆä¸ç®¡æ˜¯ç›¸åŒåŸŸçš„é¡µé¢è¿˜æ˜¯ä¸åŒåŸŸçš„é¡µé¢ï¼‰éƒ½æ˜¯å…±äº«ä¸€ä¸ª <code>window.name</code> çš„ï¼Œæ¯ä¸ªé¡µé¢å¯¹ <code>window.name</code> éƒ½æœ‰è¯»å†™çš„æƒé™ï¼Œ<code>window.name</code> æ˜¯æŒä¹…å­˜åœ¨ä¸€ä¸ªçª—å£è½½å…¥è¿‡çš„æ‰€æœ‰é¡µé¢ä¸­çš„ï¼Œå¹¶ä¸ä¼šå› æ–°é¡µé¢çš„è½½å…¥è€Œè¿›è¡Œé‡ç½®ã€‚</p>
<p>é€šè¿‡ä¸‹é¢çš„ä¾‹å­ä»‹ç»å¦‚ä½•é€šè¿‡ <a href="http://window.name">window.name</a> æ¥è·¨åŸŸè·å–æ•°æ®çš„ã€‚</p>
<p>é¡µé¢ <code>http://www.laixiangran.cn/a.html</code> çš„ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://laixiangran.cn/b.html&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myIframe&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;test()&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 2. iframeè½½å…¥ &quot;http://laixiangran.cn/b.html é¡µé¢åä¼šæ‰§è¡Œè¯¥å‡½æ•°</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> iframe = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myIframe&#x27;</span>);</span></span><br><span class="line">        </span><br><span class="line"><span class="javascript">        <span class="comment">// é‡ç½® iframe çš„ onload äº‹ä»¶ç¨‹åºï¼Œ</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// æ­¤æ—¶ç»è¿‡åé¢ä»£ç é‡ç½® src ä¹‹åï¼Œ</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// http://www.laixiangran.cn/a.html é¡µé¢ä¸è¯¥ iframe åœ¨åŒä¸€ä¸ªæºäº†ï¼Œå¯ä»¥ç›¸äº’è®¿é—®äº†</span></span></span><br><span class="line"><span class="javascript">        iframe.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> data = iframe.contentWindow.name; <span class="comment">// 4. è·å– iframe é‡Œçš„ window.name</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(data); <span class="comment">// hello world!</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line"><span class="javascript">        <span class="comment">// 3. é‡ç½®ä¸€ä¸ªä¸ http://www.laixiangran.cn/a.html é¡µé¢åŒæºçš„é¡µé¢</span></span></span><br><span class="line"><span class="javascript">        iframe.src = <span class="string">&#x27;http://www.laixiangran.cn/c.html&#x27;</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¡µé¢ <code>http://laixiangran.cn/b.html</code> çš„ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 1. ç»™å½“å‰çš„ window.name è®¾ç½®ä¸€ä¸ª http://www.laixiangran.cn/a.html é¡µé¢æƒ³è¦å¾—åˆ°çš„æ•°æ®å€¼ </span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.name = <span class="string">&quot;hello world!&quot;</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="location-hash-è·¨åŸŸ"><a href="#location-hash-è·¨åŸŸ" class="headerlink" title="location.hash è·¨åŸŸ"></a>location.hash è·¨åŸŸ</h3><p>location.hash æ–¹å¼è·¨åŸŸï¼Œæ˜¯å­æ¡†æ¶ä¿®æ”¹çˆ¶æ¡†æ¶ src çš„ hash å€¼ï¼Œé€šè¿‡è¿™ä¸ªå±æ€§è¿›è¡Œä¼ é€’æ•°æ®ï¼Œä¸”æ›´æ”¹ hash å€¼ï¼Œé¡µé¢ä¸ä¼šåˆ·æ–°ã€‚ä½†æ˜¯ä¼ é€’çš„æ•°æ®çš„å­—èŠ‚æ•°æ˜¯æœ‰é™çš„ã€‚</p>
<p>é¡µé¢ <code>http://www.laixiangran.cn/a.html</code> çš„ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://laixiangran.cn/b.html&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myIframe&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;test()&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 2. iframeè½½å…¥ &quot;http://laixiangran.cn/b.html é¡µé¢åä¼šæ‰§è¡Œè¯¥å‡½æ•°</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 3. è·å–é€šè¿‡ http://laixiangran.cn/b.html é¡µé¢è®¾ç½® hash å€¼</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> data = <span class="built_in">window</span>.location.hash;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(data);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¡µé¢ <code>http://laixiangran.cn/b.html</code> çš„ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 1. è®¾ç½®çˆ¶é¡µé¢çš„ hash å€¼</span></span></span><br><span class="line"><span class="javascript">    parent.location.hash = <span class="string">&quot;world&quot;</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="postMessage-è·¨åŸŸ"><a href="#postMessage-è·¨åŸŸ" class="headerlink" title="postMessage è·¨åŸŸ"></a>postMessage è·¨åŸŸ</h3><p>window.postMessage(messageï¼ŒtargetOrigin) æ–¹æ³•æ˜¯ HTML5 æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥å‘å…¶å®ƒçš„ window å¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œæ— è®ºè¿™ä¸ª window å¯¹è±¡æ˜¯å±äºåŒæºæˆ–ä¸åŒæºã€‚è¿™ä¸ªåº”è¯¥å°±æ˜¯ä»¥åè§£å†³ dom è·¨åŸŸé€šç”¨æ–¹æ³•äº†ã€‚</p>
<p>è°ƒç”¨ postMessage æ–¹æ³•çš„ window å¯¹è±¡æ˜¯æŒ‡è¦æ¥æ”¶æ¶ˆæ¯çš„é‚£ä¸€ä¸ª window å¯¹è±¡ï¼Œè¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•° message ä¸ºè¦å‘é€çš„æ¶ˆæ¯ï¼Œç±»å‹åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼›ç¬¬äºŒä¸ªå‚æ•° targetOrigin ç”¨æ¥é™å®šæ¥æ”¶æ¶ˆæ¯çš„é‚£ä¸ª window å¯¹è±¡æ‰€åœ¨çš„åŸŸï¼Œå¦‚æœä¸æƒ³é™å®šåŸŸï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ *ã€‚</p>
<p>éœ€è¦æ¥æ”¶æ¶ˆæ¯çš„ window å¯¹è±¡ï¼Œå¯æ˜¯é€šè¿‡ç›‘å¬è‡ªèº«çš„ message äº‹ä»¶æ¥è·å–ä¼ è¿‡æ¥çš„æ¶ˆæ¯ï¼Œæ¶ˆæ¯å†…å®¹å‚¨å­˜åœ¨è¯¥äº‹ä»¶å¯¹è±¡çš„ data å±æ€§ä¸­ã€‚</p>
<p>é¡µé¢ <code>http://www.laixiangran.cn/a.html</code> çš„ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://laixiangran.cn/b.html&quot;</span> <span class="attr">id</span>=<span class="string">&quot;myIframe&quot;</span> <span class="attr">onload</span>=<span class="string">&quot;test()&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 1. iframeè½½å…¥ &quot;http://laixiangran.cn/b.html é¡µé¢åä¼šæ‰§è¡Œè¯¥å‡½æ•°</span></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 2. è·å– http://laixiangran.cn/b.html é¡µé¢çš„ window å¯¹è±¡ï¼Œ</span></span></span><br><span class="line"><span class="javascript">        <span class="comment">// ç„¶åé€šè¿‡ postMessage å‘ http://laixiangran.cn/b.html é¡µé¢å‘é€æ¶ˆæ¯</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> iframe = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myIframe&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> win = iframe.contentWindow;</span></span><br><span class="line"><span class="javascript">        win.postMessage(<span class="string">&#x27;æˆ‘æ˜¯æ¥è‡ª http://www.laixiangran.cn/a.html é¡µé¢çš„æ¶ˆæ¯&#x27;</span>, <span class="string">&#x27;*&#x27;</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¡µé¢ <code>http://laixiangran.cn/b.html</code> çš„ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// æ³¨å†Œ message äº‹ä»¶ç”¨æ¥æ¥æ”¶æ¶ˆæ¯</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        e = e || event; <span class="comment">// è·å–äº‹ä»¶å¯¹è±¡</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(e.data); <span class="comment">// é€šè¿‡ data å±æ€§å¾—åˆ°å‘é€æ¥çš„æ¶ˆæ¯</span></span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>åŒæºç­–ç•¥</category>
      </categories>
      <tags>
        <tag>åŒæºç­–ç•¥</tag>
        <tag>æµè§ˆå™¨</tag>
        <tag>CORF</tag>
        <tag>è·¨åŸŸ</tag>
      </tags>
  </entry>
  <entry>
    <title>ECMAScript</title>
    <url>/2020/11/09/ECMAScript/</url>
    <content><![CDATA[<h1 id="ECMAScript"><a href="#ECMAScript" class="headerlink" title="ECMAScript"></a>ECMAScript</h1><blockquote>
<p>ES å…¨ç§° ECMAScriptï¼ŒECMAScript æ˜¯ ECMA åˆ¶å®šçš„æ ‡å‡†åŒ–è„šæœ¬è¯­è¨€</p>
</blockquote>
<h2 id="ES6æ–°ç‰¹æ€§ï¼ˆ2015ï¼‰"><a href="#ES6æ–°ç‰¹æ€§ï¼ˆ2015ï¼‰" class="headerlink" title="ES6æ–°ç‰¹æ€§ï¼ˆ2015ï¼‰"></a>ES6æ–°ç‰¹æ€§ï¼ˆ2015ï¼‰</h2><p>ES6ä¸­çš„ç‰¹æ€§æ¯”è¾ƒå¤šã€‚ åˆ—ä¸¾å‡ ä¸ªå¸¸ç”¨çš„ï¼š</p>
<ul>
<li>ç±»</li>
<li>æ¨¡å—åŒ–</li>
<li>ç®­å¤´å‡½æ•°</li>
<li>å‡½æ•°å‚æ•°é»˜è®¤å€¼</li>
<li>æ¨¡æ¿å­—ç¬¦ä¸²</li>
<li>è§£æ„èµ‹å€¼</li>
<li>å»¶å±•æ“ä½œç¬¦</li>
<li>å¯¹è±¡å±æ€§ç®€å†™</li>
<li>Promise</li>
<li>Let ä¸ Const</li>
</ul>
<h3 id="ç±»ï¼ˆclassï¼‰"><a href="#ç±»ï¼ˆclassï¼‰" class="headerlink" title="ç±»ï¼ˆclassï¼‰"></a>ç±»ï¼ˆclassï¼‰</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">   <span class="comment">// æ„é€ å‡½æ•°ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™å°†ä¼šè¢«è°ƒç”¨ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªä¸å¸¦å‚æ•°çš„é»˜è®¤æ„é€ å‡½æ•°.</span></span><br><span class="line">   <span class="function"><span class="title">constructor</span>(<span class="params">name, color</span>)</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.name = name;</span><br><span class="line">     <span class="built_in">this</span>.color = color;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// toString æ˜¯åŸå‹å¯¹è±¡ä¸Šçš„å±æ€§</span></span><br><span class="line">   <span class="function"><span class="title">toString</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">&#x27;name:&#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;,color:&#x27;</span> + <span class="built_in">this</span>.color);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> animal = <span class="keyword">new</span> Animal(<span class="string">&#x27;dog&#x27;</span>,<span class="string">&#x27;white&#x27;</span>); <span class="comment">//å®ä¾‹åŒ– Animal</span></span><br><span class="line">animal.toString();</span><br><span class="line"><span class="built_in">console</span>.log(animal.hasOwnProperty(<span class="string">&#x27;name&#x27;</span>)); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(animal.hasOwnProperty(<span class="string">&#x27;toString&#x27;</span>)); <span class="comment">// false</span></span><br><span class="line"><span class="built_in">console</span>.log(animal.__proto__.hasOwnProperty(<span class="string">&#x27;toString&#x27;</span>)); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="title">constructor</span>(<span class="params">action</span>)</span> &#123;</span><br><span class="line">   <span class="comment">// å­ç±»å¿…é¡»è¦åœ¨constructorä¸­æŒ‡å®š super å‡½æ•°ï¼Œå¦åˆ™åœ¨æ–°å»ºå®ä¾‹çš„æ—¶å€™ä¼šæŠ¥é”™.</span></span><br><span class="line">   <span class="comment">// å¦‚æœæ²¡æœ‰ç½®é¡¶consructor, é»˜è®¤å¸¦superå‡½æ•°çš„constructorå°†ä¼šè¢«æ·»åŠ </span></span><br><span class="line">   <span class="built_in">super</span>(<span class="string">&#x27;cat&#x27;</span>,<span class="string">&#x27;white&#x27;</span>);</span><br><span class="line">   <span class="built_in">this</span>.action = action;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="title">toString</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="built_in">super</span>.toString());</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cat = <span class="keyword">new</span> Cat(<span class="string">&#x27;catch&#x27;</span>)</span><br><span class="line">cat.toString();</span><br><span class="line"><span class="comment">// å®ä¾‹cat æ˜¯ Cat å’Œ Animal çš„å®ä¾‹ï¼Œå’Œ Es5 å®Œå…¨ä¸€è‡´ã€‚</span></span><br><span class="line"><span class="built_in">console</span>.log(cat <span class="keyword">instanceof</span> Cat); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(cat <span class="keyword">instanceof</span> Animal); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="æ¨¡å—åŒ–-Module"><a href="#æ¨¡å—åŒ–-Module" class="headerlink" title="æ¨¡å—åŒ–(Module)"></a>æ¨¡å—åŒ–(Module)</h3><p>ES5 ä¸æ”¯æŒåŸç”Ÿçš„æ¨¡å—åŒ–ï¼Œåœ¨ ES6 ä¸­æ¨¡å—ä½œä¸ºé‡è¦çš„ç»„æˆéƒ¨åˆ†è¢«æ·»åŠ è¿›æ¥ã€‚æ¨¡å—çš„åŠŸèƒ½ä¸»è¦ç”± export å’Œ import ç»„æˆã€‚æ¯ä¸€ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±å•ç‹¬çš„ä½œç”¨åŸŸï¼Œæ¨¡å—ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å…³ç³»æ˜¯é€šè¿‡ export æ¥è§„å®šæ¨¡å—å¯¹å¤–æš´éœ²çš„æ¥å£ï¼Œé€šè¿‡ import æ¥å¼•ç”¨å…¶å®ƒæ¨¡å—æä¾›çš„æ¥å£ã€‚åŒæ—¶è¿˜ä¸ºæ¨¡å—åˆ›é€ äº†å‘½åç©ºé—´ï¼Œé˜²æ­¢å‡½æ•°çš„å‘½åå†²çªã€‚</p>
<h4 id="å¯¼å‡º-export"><a href="#å¯¼å‡º-export" class="headerlink" title="å¯¼å‡º(export)"></a>å¯¼å‡º(export)</h4><p>ES6 å…è®¸åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ä½¿ç”¨ export æ¥å¯¼å‡ºå¤šä¸ªå˜é‡æˆ–å‡½æ•°ã€‚</p>
<h5 id="å¯¼å‡ºå˜é‡"><a href="#å¯¼å‡ºå˜é‡" class="headerlink" title="å¯¼å‡ºå˜é‡"></a>å¯¼å‡ºå˜é‡</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> name = <span class="string">&#x27;Rainbow&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ES6ä¸ä»…æ”¯æŒå˜é‡çš„å¯¼å‡ºï¼Œä¹Ÿæ”¯æŒå¸¸é‡çš„å¯¼å‡ºã€‚ </p>
<p><code>export const sqrt = Math.sqrt // å¯¼å‡ºå¸¸é‡</code></p>
</blockquote>
<p>ES6 å°†ä¸€ä¸ªæ–‡ä»¶è§†ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œä¸Šé¢çš„æ¨¡å—é€šè¿‡ export å‘å¤–è¾“å‡ºäº†ä¸€ä¸ªå˜é‡ã€‚ä¸€ä¸ªæ¨¡å—ä¹Ÿå¯ä»¥åŒæ—¶å¾€å¤–é¢è¾“å‡ºå¤šä¸ªå˜é‡ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//test.js</span></span><br><span class="line"> <span class="keyword">var</span> name = <span class="string">&#x27;Rainbow&#x27;</span>;</span><br><span class="line"> <span class="keyword">var</span> age = <span class="string">&#x27;24&#x27;</span>;</span><br><span class="line"> <span class="keyword">export</span> &#123;name, age&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="å¯¼å‡ºå‡½æ•°"><a href="#å¯¼å‡ºå‡½æ•°" class="headerlink" title="å¯¼å‡ºå‡½æ•°"></a>å¯¼å‡ºå‡½æ•°</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// myModule.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">myModule</span>(<span class="params">someArg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> someArg;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h4 id="å¯¼å…¥-import"><a href="#å¯¼å…¥-import" class="headerlink" title="å¯¼å…¥(import)"></a>å¯¼å…¥(import)</h4><p>å®šä¹‰å¥½æ¨¡å—çš„è¾“å‡ºä»¥åå°±å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ªæ¨¡å—é€šè¿‡ import å¼•ç”¨ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;myModule&#125; <span class="keyword">from</span> <span class="string">&#x27;myModule&#x27;</span> <span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;name,age&#125; <span class="keyword">from</span> <span class="string">&#x27;test&#x27;</span> <span class="comment">// test.js</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸€æ¡ import è¯­å¥å¯ä»¥åŒæ—¶å¯¼å…¥é»˜è®¤å‡½æ•°å’Œå…¶å®ƒå˜é‡ã€‚<code>import defaultMethod, &#123; otherMethod &#125; from &#39;xxx.js&#39;</code></p>
</blockquote>
<h3 id="ç®­å¤´ï¼ˆArrowï¼‰å‡½æ•°"><a href="#ç®­å¤´ï¼ˆArrowï¼‰å‡½æ•°" class="headerlink" title="ç®­å¤´ï¼ˆArrowï¼‰å‡½æ•°"></a>ç®­å¤´ï¼ˆArrowï¼‰å‡½æ•°</h3><p><code>=&gt;</code>ä¸åªæ˜¯å…³é”®å­— function çš„ç®€å†™ï¼Œå®ƒè¿˜å¸¦æ¥äº†å…¶å®ƒå¥½å¤„ã€‚ç®­å¤´å‡½æ•°ä¸åŒ…å›´å®ƒçš„ä»£ç å…±äº«åŒä¸€ä¸ª<code>this</code>ï¼Œèƒ½å¸®ä½ å¾ˆå¥½çš„è§£å†³ <code>this</code> çš„æŒ‡å‘é—®é¢˜ã€‚æœ‰ç»éªŒçš„ JavaScript å¼€å‘è€…éƒ½ç†Ÿæ‚‰è¯¸å¦‚<code>var self = this</code>æˆ–<code>var that = this</code>è¿™ç§å¼•ç”¨å¤–å›´ <code>this</code> çš„æ¨¡å¼ã€‚ä½†å€ŸåŠ©<code>=&gt;</code>ï¼Œå°±ä¸éœ€è¦è¿™ç§æ¨¡å¼äº†ã€‚</p>
<h4 id="ç®­å¤´å‡½æ•°çš„ç»“æ„"><a href="#ç®­å¤´å‡½æ•°çš„ç»“æ„" class="headerlink" title="ç®­å¤´å‡½æ•°çš„ç»“æ„"></a>ç®­å¤´å‡½æ•°çš„ç»“æ„</h4><p>ç®­å¤´å‡½æ•°çš„ç®­å¤´<code>=&gt;</code>ä¹‹å‰æ˜¯ä¸€ä¸ªç©ºæ‹¬å·ã€å•ä¸ªçš„å‚æ•°åã€æˆ–ç”¨æ‹¬å·æ‹¬èµ·çš„å¤šä¸ªå‚æ•°åï¼Œè€Œç®­å¤´ä¹‹åå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼‰ï¼Œæˆ–è€…æ˜¯ç”¨èŠ±æ‹¬å·æ‹¬èµ·çš„å‡½æ•°ä½“ï¼ˆéœ€è¦è‡ªè¡Œé€šè¿‡ return æ¥è¿”å›å€¼ï¼Œå¦åˆ™è¿”å›çš„æ˜¯ undefinedï¼‰ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç®­å¤´å‡½æ•°çš„ä¾‹å­</span></span><br><span class="line">()=&gt;<span class="number">1</span></span><br><span class="line">v=&gt;v+<span class="number">1</span></span><br><span class="line">(a,b)=&gt;a+b</span><br><span class="line">()=&gt;&#123;</span><br><span class="line">    alert(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">e=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1000</span>/e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸è®ºæ˜¯ç®­å¤´å‡½æ•°è¿˜æ˜¯ bindï¼Œæ¯æ¬¡è¢«æ‰§è¡Œéƒ½è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ï¼Œå› æ­¤å¦‚æœä½ è¿˜éœ€è¦å‡½æ•°çš„å¼•ç”¨å»åšä¸€äº›åˆ«çš„äº‹æƒ…ï¼ˆè­¬å¦‚å¸è½½ç›‘å¬å™¨ï¼‰ï¼Œé‚£ä¹ˆä½ å¿…é¡»è‡ªå·±ä¿å­˜è¿™ä¸ªå¼•ç”¨ã€‚</p>
</blockquote>
<h4 id="å¸è½½ç›‘å¬å™¨æ—¶çš„é™·é˜±"><a href="#å¸è½½ç›‘å¬å™¨æ—¶çš„é™·é˜±" class="headerlink" title="å¸è½½ç›‘å¬å™¨æ—¶çš„é™·é˜±"></a>å¸è½½ç›‘å¬å™¨æ—¶çš„é™·é˜±</h4><p><strong>é”™è¯¯çš„åšæ³•</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PauseMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        AppStateIOS.addEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="built_in">this</span>.onAppPaused.bind(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        AppStateIOS.removeEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="built_in">this</span>.onAppPaused.bind(<span class="built_in">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">onAppPaused</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ­£ç¡®çš„åšæ³•</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PauseMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(props);</span><br><span class="line">        <span class="built_in">this</span>._onAppPaused = <span class="built_in">this</span>.onAppPaused.bind(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        AppStateIOS.addEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="built_in">this</span>._onAppPaused);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        AppStateIOS.removeEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="built_in">this</span>._onAppPaused);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">onAppPaused</span>(<span class="params">event</span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤ä¸Šè¿°çš„åšæ³•å¤–ï¼Œè¿˜å¯ä»¥è¿™æ ·åšï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PauseMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        AppStateIOS.addEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="built_in">this</span>.onAppPaused);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        AppStateIOS.removeEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="built_in">this</span>.onAppPaused);</span><br><span class="line">    &#125;</span><br><span class="line">    onAppPaused = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//æŠŠå‡½æ•°ç›´æ¥ä½œä¸ºä¸€ä¸ªarrow functionçš„å±æ€§æ¥å®šä¹‰ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å°±ç»‘å®šå¥½äº†thisæŒ‡é’ˆ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å‡½æ•°å‚æ•°é»˜è®¤å€¼"><a href="#å‡½æ•°å‚æ•°é»˜è®¤å€¼" class="headerlink" title="å‡½æ•°å‚æ•°é»˜è®¤å€¼"></a><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/default_parameters">å‡½æ•°å‚æ•°é»˜è®¤å€¼</a></h3><p>ES6æ”¯æŒåœ¨å®šä¹‰å‡½æ•°çš„æ—¶å€™ä¸ºå…¶è®¾ç½®é»˜è®¤å€¼ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">height = <span class="number">50</span>, color = <span class="string">&#x27;red&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ä½¿ç”¨é»˜è®¤å€¼ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">height, color</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> height = height || <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">var</span> color = color || <span class="string">&#x27;red&#x27;</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å†™ä¸€èˆ¬æ²¡é—®é¢˜ï¼Œä½†å½“<strong>å‚æ•°çš„å¸ƒå°”å€¼ä¸º false</strong> æ—¶ï¼Œå°±ä¼šæœ‰é—®é¢˜äº†ã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬è¿™æ ·è°ƒç”¨fooå‡½æ•°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">foo(<span class="number">0</span>, <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>å› ä¸º 0 çš„å¸ƒå°”å€¼ä¸º falseï¼Œè¿™æ · height çš„å–å€¼å°†æ˜¯50ã€‚åŒç† color çš„å–å€¼ä¸º â€˜redâ€™ã€‚</p>
<p>æ‰€ä»¥è¯´ï¼Œ<strong>å‡½æ•°å‚æ•°é»˜è®¤å€¼</strong>ä¸ä»…èƒ½æ˜¯ä»£ç å˜å¾—æ›´åŠ ç®€æ´è€Œä¸”èƒ½è§„é¿ä¸€äº›é—®é¢˜ã€‚</p>
<h3 id="æ¨¡æ¿å­—ç¬¦ä¸²"><a href="#æ¨¡æ¿å­—ç¬¦ä¸²" class="headerlink" title="æ¨¡æ¿å­—ç¬¦ä¸²"></a>æ¨¡æ¿å­—ç¬¦ä¸²</h3><p>ES6 æ”¯æŒæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œä½¿å¾—å­—ç¬¦ä¸²çš„æ‹¼æ¥æ›´åŠ çš„ç®€æ´ã€ç›´è§‚ã€‚</p>
<p>ä¸ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;Your name is &#x27;</span> + first + <span class="string">&#x27; &#x27;</span> + last + <span class="string">&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">`Your name is <span class="subst">$&#123;first&#125;</span> <span class="subst">$&#123;last&#125;</span>.`</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ ES6 ä¸­é€šè¿‡<code>$&#123;&#125;</code>å°±å¯ä»¥å®Œæˆå­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œåªéœ€è¦å°†å˜é‡æ”¾åœ¨å¤§æ‹¬å·ä¹‹ä¸­ã€‚</p>
<h3 id="è§£æ„èµ‹å€¼"><a href="#è§£æ„èµ‹å€¼" class="headerlink" title="è§£æ„èµ‹å€¼"></a><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">è§£æ„èµ‹å€¼</a></h3><p>è§£æ„èµ‹å€¼è¯­æ³•æ˜¯ JavaScript çš„ä¸€ç§è¡¨è¾¾å¼ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä»<strong>æ•°ç»„</strong>æˆ–è€…<strong>å¯¹è±¡</strong>ä¸­<strong>å¿«é€Ÿæå–å€¼èµ‹ç»™å®šä¹‰çš„å˜é‡</strong>ã€‚</p>
<h4 id="è·å–æ•°ç»„ä¸­çš„å€¼"><a href="#è·å–æ•°ç»„ä¸­çš„å€¼" class="headerlink" title="è·å–æ•°ç»„ä¸­çš„å€¼"></a>è·å–æ•°ç»„ä¸­çš„å€¼</h4><p>ä»æ•°ç»„ä¸­è·å–å€¼å¹¶èµ‹å€¼åˆ°å˜é‡ä¸­ï¼Œå˜é‡çš„é¡ºåºä¸æ•°ç»„ä¸­å¯¹è±¡é¡ºåºå¯¹åº”ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> foo = [<span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span>, <span class="string">&quot;four&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> [a, b, c] = foo;</span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// &quot;one&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(b); <span class="comment">// &quot;two&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(c); <span class="comment">// &quot;three&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœä½ è¦å¿½ç•¥æŸäº›å€¼ï¼Œä½ å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„å†™æ³•è·å–ä½ æƒ³è¦çš„å€¼</span></span><br><span class="line"><span class="keyword">var</span> [first, , , last] = foo;</span><br><span class="line"><span class="built_in">console</span>.log(first); <span class="comment">// &quot;one&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(last); <span class="comment">// &quot;four&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½ ä¹Ÿå¯ä»¥è¿™æ ·å†™</span></span><br><span class="line"><span class="keyword">var</span> a, b; <span class="comment">//å…ˆå£°æ˜å˜é‡</span></span><br><span class="line"></span><br><span class="line">[a, b] = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(b); <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡æœ‰ä»æ•°ç»„ä¸­çš„è·å–åˆ°å€¼ï¼Œä½ å¯ä»¥ä¸ºå˜é‡è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a, b;</span><br><span class="line"></span><br><span class="line">[a=<span class="number">5</span>, b=<span class="number">7</span>] = [<span class="number">1</span>];</span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(b); <span class="comment">// 7</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è§£æ„èµ‹å€¼å¯ä»¥æ–¹ä¾¿çš„äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">[a, b] = [b, a];</span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// 3</span></span><br><span class="line"><span class="built_in">console</span>.log(b); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<h4 id="è·å–å¯¹è±¡ä¸­çš„å€¼"><a href="#è·å–å¯¹è±¡ä¸­çš„å€¼" class="headerlink" title="è·å–å¯¹è±¡ä¸­çš„å€¼"></a>è·å–å¯¹è±¡ä¸­çš„å€¼</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> student = &#123;</span><br><span class="line">  name:<span class="string">&#x27;Ming&#x27;</span>,</span><br><span class="line">  age:<span class="string">&#x27;18&#x27;</span>,</span><br><span class="line">  city:<span class="string">&#x27;Shanghai&#x27;</span>  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;name, age, city&#125; = student;</span><br><span class="line"><span class="built_in">console</span>.log(name); <span class="comment">// &quot;Ming&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(age); <span class="comment">// &quot;18&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(city); <span class="comment">// &quot;Shanghai&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="å»¶å±•æ“ä½œç¬¦-Spread-operator"><a href="#å»¶å±•æ“ä½œç¬¦-Spread-operator" class="headerlink" title="å»¶å±•æ“ä½œç¬¦( Spread operator )"></a>å»¶å±•æ“ä½œç¬¦( Spread operator )</h3><p>å»¶å±•æ“ä½œç¬¦<code>...</code>å¯ä»¥åœ¨<strong>å‡½æ•°è°ƒç”¨</strong>/<strong>æ•°ç»„æ„é€ </strong>æ—¶ï¼Œå°†æ•°ç»„è¡¨è¾¾å¼æˆ–è€… string åœ¨è¯­æ³•å±‚é¢å±•å¼€ï¼›è¿˜å¯ä»¥åœ¨æ„é€ å¯¹è±¡æ—¶ï¼Œå°†å¯¹è±¡è¡¨è¾¾å¼æŒ‰ key-value çš„æ–¹å¼å±•å¼€ã€‚</p>
<h4 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><p><strong>å‡½æ•°è°ƒç”¨</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">myFunction(...iterableObj);</span><br></pre></td></tr></table></figure>

<p><strong>æ•°ç»„æ„é€ æˆ–å­—ç¬¦ä¸²</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[...iterableObj, <span class="string">&#x27;4&#x27;</span>, ...<span class="string">&#x27;hello&#x27;</span>, <span class="number">6</span>];</span><br></pre></td></tr></table></figure>

<p>æ„é€ å¯¹è±¡æ—¶ï¼Œè¿›è¡Œ<strong>å…‹éš†æˆ–è€…å±æ€§æ‹·è´</strong>ï¼ˆECMAScript 2018è§„èŒƒæ–°å¢ç‰¹æ€§ï¼‰</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> objClone = &#123; ...obj &#125;;</span><br></pre></td></tr></table></figure>

<h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h4><p><strong>åœ¨å‡½æ•°è°ƒç”¨æ—¶ä½¿ç”¨å»¶å±•æ“ä½œç¬¦</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">x, y, z</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y + z;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ä½¿ç”¨å»¶å±•æ“ä½œç¬¦</span></span><br><span class="line"><span class="built_in">console</span>.log(sum.apply(<span class="literal">null</span>, numbers));</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨å»¶å±•æ“ä½œç¬¦</span></span><br><span class="line"><span class="built_in">console</span>.log(sum(...numbers));<span class="comment">// 6</span></span><br></pre></td></tr></table></figure>

<p><strong>æ„é€ æ•°ç»„</strong></p>
<p>æ²¡æœ‰å±•å¼€è¯­æ³•çš„æ—¶å€™ï¼Œåªèƒ½ç»„åˆä½¿ç”¨ pushã€spliceã€concat ç­‰æ–¹æ³•ï¼Œæ¥å°†å·²æœ‰æ•°ç»„å…ƒç´ å˜æˆæ–°æ•°ç»„çš„ä¸€éƒ¨åˆ†ã€‚æœ‰äº†å±•å¼€è¯­æ³•ï¼Œæ„é€ æ–°æ•°ç»„ä¼šå˜å¾—æ›´ç®€å•ã€æ›´ä¼˜é›…ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> stuendts = [<span class="string">&#x27;Jine&#x27;</span>, <span class="string">&#x27;Tom&#x27;</span>]; </span><br><span class="line"><span class="keyword">const</span> persons = [<span class="string">&#x27;Tony&#x27;</span>, ...stuendts, <span class="string">&#x27;Aaron&#x27;</span>, <span class="string">&#x27;Anna&#x27;</span>];</span><br><span class="line">conslog.log(persions) <span class="comment">// [&quot;Tony&quot;, &quot;Jine&quot;, &quot;Tom&quot;, &quot;Aaron&quot;, &quot;Anna&quot;]</span></span><br></pre></td></tr></table></figure>

<p>å’Œå‚æ•°åˆ—è¡¨çš„å±•å¼€ç±»ä¼¼ï¼Œ<code>...</code> åœ¨æ„é€ å­—æ•°ç»„æ—¶ï¼Œå¯ä»¥åœ¨ä»»æ„ä½ç½®å¤šæ¬¡ä½¿ç”¨ã€‚</p>
<p><strong>æ•°ç»„æ‹·è´</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> arr2 = [...arr]; <span class="comment">// ç­‰åŒäº arr.slice()</span></span><br><span class="line">arr2.push(<span class="number">4</span>); </span><br><span class="line"><span class="built_in">console</span>.log(arr2) <span class="comment">//[1, 2, 3, 4]</span></span><br></pre></td></tr></table></figure>

<p>å±•å¼€è¯­æ³•å’Œ Object.assign() è¡Œä¸ºä¸€è‡´, æ‰§è¡Œçš„éƒ½æ˜¯æµ…æ‹·è´(åªéå†ä¸€å±‚)ã€‚</p>
<p><strong>è¿æ¥å¤šä¸ªæ•°ç»„</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr1 = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line"><span class="keyword">var</span> arr2 = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">var</span> arr3 = [...arr1, ...arr2]; <span class="comment">// å°† arr2 ä¸­æ‰€æœ‰å…ƒç´ é™„åŠ åˆ° arr1 åé¢å¹¶è¿”å›</span></span><br><span class="line"><span class="comment">// ç­‰åŒäº</span></span><br><span class="line"><span class="keyword">var</span> arr4 = arr1.concat(arr2);</span><br></pre></td></tr></table></figure>

<p>åœ¨ECMAScript 2018ä¸­å»¶å±•æ“ä½œç¬¦å¢åŠ äº†å¯¹<strong>å¯¹è±¡</strong>çš„æ”¯æŒ</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj1 = &#123; <span class="attr">foo</span>: <span class="string">&#x27;bar&#x27;</span>, <span class="attr">x</span>: <span class="number">42</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj2 = &#123; <span class="attr">foo</span>: <span class="string">&#x27;baz&#x27;</span>, <span class="attr">y</span>: <span class="number">13</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> clonedObj = &#123; ...obj1 &#125;;</span><br><span class="line"><span class="comment">// å…‹éš†åçš„å¯¹è±¡: &#123; foo: &quot;bar&quot;, x: 42 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mergedObj = &#123; ...obj1, ...obj2 &#125;;</span><br><span class="line"><span class="comment">// åˆå¹¶åçš„å¯¹è±¡: &#123; foo: &quot;baz&quot;, x: 42, y: 13 &#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="åœ¨Reactä¸­çš„åº”ç”¨"><a href="#åœ¨Reactä¸­çš„åº”ç”¨" class="headerlink" title="åœ¨Reactä¸­çš„åº”ç”¨"></a>åœ¨Reactä¸­çš„åº”ç”¨</h4><p>é€šå¸¸æˆ‘ä»¬åœ¨å°è£…ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œä¼šå¯¹å¤–å…¬å¼€ä¸€äº› props ç”¨äºå®ç°åŠŸèƒ½ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹åœ¨å¤–éƒ¨ä½¿ç”¨éƒ½åº”æ˜¾ç¤ºçš„ä¼ é€’ props ã€‚ä½†æ˜¯å½“ä¼ é€’å¤§é‡çš„propsæ—¶ï¼Œä¼šéå¸¸ç¹çï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong><code>...</code>(å»¶å±•æ“ä½œç¬¦ï¼Œç”¨äºå–å‡ºå‚æ•°å¯¹è±¡çš„æ‰€æœ‰å¯éå†å±æ€§)</strong> æ¥è¿›è¡Œä¼ é€’ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥è¿™æ ·å†™ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;CustomComponent name =<span class="string">&#x27;Jine&#x27;</span> age =&#123;<span class="number">21</span>&#125; /&gt;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>...</code> ï¼Œç­‰åŒäºä¸Šé¢çš„å†™æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> params = &#123;</span><br><span class="line">	name: <span class="string">&#x27;Jine&#x27;</span>,</span><br><span class="line">	age: <span class="number">21</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;CustomComponent &#123;...params&#125; /&gt;</span><br></pre></td></tr></table></figure>

<p>é…åˆè§£æ„èµ‹å€¼é¿å…ä¼ å…¥ä¸€äº›ä¸éœ€è¦çš„å‚æ•°</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> params = &#123;</span><br><span class="line">	name: <span class="string">&#x27;123&#x27;</span>,</span><br><span class="line">	title: <span class="string">&#x27;456&#x27;</span>,</span><br><span class="line">	type: <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123; type, ...other &#125; = params;</span><br><span class="line"></span><br><span class="line">&lt;CustomComponent type=<span class="string">&#x27;normal&#x27;</span> number=&#123;<span class="number">2</span>&#125; &#123;...other&#125; /&gt;</span><br><span class="line"><span class="comment">//ç­‰åŒäº</span></span><br><span class="line">&lt;CustomComponent type=<span class="string">&#x27;normal&#x27;</span> number=&#123;<span class="number">2</span>&#125; name=<span class="string">&#x27;123&#x27;</span> title=<span class="string">&#x27;456&#x27;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹è±¡å±æ€§ç®€å†™"><a href="#å¯¹è±¡å±æ€§ç®€å†™" class="headerlink" title="å¯¹è±¡å±æ€§ç®€å†™"></a>å¯¹è±¡å±æ€§ç®€å†™</h3><p>åœ¨ES6ä¸­å…è®¸æˆ‘ä»¬åœ¨è®¾ç½®ä¸€ä¸ªå¯¹è±¡çš„å±æ€§çš„æ—¶å€™ä¸æŒ‡å®šå±æ€§åã€‚</p>
<p><strong>ä¸ä½¿ç”¨ES6</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> name=<span class="string">&#x27;Ming&#x27;</span>, age=<span class="string">&#x27;18&#x27;</span>, city=<span class="string">&#x27;Shanghai&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> student = &#123;</span><br><span class="line">    name:name,</span><br><span class="line">    age:age,</span><br><span class="line">    city:city</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(student); <span class="comment">//&#123;name: &quot;Ming&quot;, age: &quot;18&quot;, city: &quot;Shanghai&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹è±¡ä¸­å¿…é¡»åŒ…å«å±æ€§å’Œå€¼ï¼Œæ˜¾å¾—éå¸¸å†—ä½™ã€‚</p>
<p><strong>ä½¿ç”¨ES6</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> name=<span class="string">&#x27;Ming&#x27;</span>, age=<span class="string">&#x27;18&#x27;</span>, city=<span class="string">&#x27;Shanghai&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> student = &#123;</span><br><span class="line">    name,</span><br><span class="line">    age,</span><br><span class="line">    city</span><br><span class="line">&#125;;</span><br><span class="line">console.log(student); <span class="comment">//&#123;name: &quot;Ming&quot;, age: &quot;18&quot;, city: &quot;Shanghai&quot;&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯¹è±¡ä¸­ç›´æ¥å†™å˜é‡ï¼Œéå¸¸ç®€æ´ã€‚</p>
<h3 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Using_promises">Promise</a></h3><p>Promise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆcallbackæ›´åŠ çš„ä¼˜é›…ã€‚å®ƒæœ€æ—©ç”±ç¤¾åŒºæå‡ºå’Œå®ç°çš„ï¼ŒES6 å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼ŒåŸç”Ÿæä¾›äº†Promiseå¯¹è±¡ã€‚</p>
<p><strong>ä¸ä½¿ç”¨ES6</strong></p>
<p>åµŒå¥—ä¸¤ä¸ª setTimeout å›è°ƒå‡½æ•°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Hello&#x27;</span>); <span class="comment">// 1ç§’åè¾“å‡º &quot;Hello&quot;</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Hi&#x27;</span>); <span class="comment">// 2ç§’åè¾“å‡º &quot;Hi&quot;</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ES6</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> waitSecond = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">waitSecond</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;Hello&quot;</span>); <span class="comment">// 1ç§’åè¾“å‡º&quot;Hello&quot;</span></span><br><span class="line">      <span class="keyword">return</span> waitSecond;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Hi&quot;</span>); <span class="comment">// 2ç§’åè¾“å‡º&quot;Hi&quot;</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„çš„ä»£ç ä½¿ç”¨ä¸¤ä¸ª then æ¥è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ä¸²è¡ŒåŒ–ï¼Œé¿å…äº†å›è°ƒåœ°ç‹±ï¼š</p>
<h3 id="æ”¯æŒ-let-ä¸-const"><a href="#æ”¯æŒ-let-ä¸-const" class="headerlink" title="æ”¯æŒ let ä¸ const"></a>æ”¯æŒ let ä¸ const</h3><p>åœ¨ä¹‹å‰ JS æ˜¯æ²¡æœ‰å—çº§ä½œç”¨åŸŸçš„ï¼Œconst ä¸ let å¡«è¡¥äº†è¿™æ–¹ä¾¿çš„ç©ºç™½ï¼Œconst ä¸ let éƒ½æ˜¯å—çº§ä½œç”¨åŸŸã€‚</p>
<p>ä½¿ç”¨ var å®šä¹‰çš„å˜é‡ä¸ºå‡½æ•°çº§ä½œç”¨åŸŸ</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">// è¾“å‡º10</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ let ä¸ const å®šä¹‰çš„å˜é‡ä¸ºå—çº§ä½œç”¨åŸŸ</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">//-1 or Errorâ€œReferenceError: a is not definedâ€</span></span><br></pre></td></tr></table></figure>

<h2 id="ES7æ–°ç‰¹æ€§ï¼ˆ2016ï¼‰"><a href="#ES7æ–°ç‰¹æ€§ï¼ˆ2016ï¼‰" class="headerlink" title="ES7æ–°ç‰¹æ€§ï¼ˆ2016ï¼‰"></a>ES7æ–°ç‰¹æ€§ï¼ˆ2016ï¼‰</h2><p>ES2016æ·»åŠ äº†ä¸¤ä¸ªå°çš„ç‰¹æ€§æ¥è¯´æ˜æ ‡å‡†åŒ–è¿‡ç¨‹ï¼š</p>
<ul>
<li>æ•°ç»„ includes() æ–¹æ³•ï¼Œç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œæ ¹æ®æƒ…å†µï¼Œå¦‚æœåŒ…å«åˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</li>
<li>a ** b æŒ‡æ•°è¿ç®—ç¬¦ï¼Œå®ƒä¸ Math.pow(a, b) ç›¸åŒã€‚</li>
</ul>
<h3 id="Array-prototype-includes"><a href="#Array-prototype-includes" class="headerlink" title="Array.prototype.includes()"></a>Array.prototype.includes()</h3><p><code>includes()</code> å‡½æ•°ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œå¦‚æœåŒ…å«åˆ™è¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚</p>
<p><code>includes</code> å‡½æ•°ä¸ <code>indexOf</code> å‡½æ•°å¾ˆç›¸ä¼¼ï¼Œä¸‹é¢ä¸¤ä¸ªè¡¨è¾¾å¼æ˜¯ç­‰ä»·çš„ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">arr.includes(x)</span><br><span class="line">arr.indexOf(x) &gt;= <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ ES7 ä¹‹å‰çš„åšæ³•</p>
<p>ä½¿ç”¨<code>indexOf()</code>éªŒè¯æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªå…ƒç´ ï¼Œè¿™æ—¶éœ€è¦æ ¹æ®è¿”å›å€¼æ˜¯å¦ä¸º-1æ¥åˆ¤æ–­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [<span class="string">&#x27;react&#x27;</span>, <span class="string">&#x27;angular&#x27;</span>, <span class="string">&#x27;vue&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (arr.indexOf(<span class="string">&#x27;react&#x27;</span>) !== -<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reactå­˜åœ¨&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ ES7 çš„ includes()</p>
<p>ä½¿ç”¨ includes() éªŒè¯æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªå…ƒç´ ï¼Œè¿™æ ·æ›´åŠ ç›´è§‚ç®€å•</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [<span class="string">&#x27;react&#x27;</span>, <span class="string">&#x27;angular&#x27;</span>, <span class="string">&#x27;vue&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (arr.includes(<span class="string">&#x27;react&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;reactå­˜åœ¨&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æŒ‡æ•°æ“ä½œç¬¦"><a href="#æŒ‡æ•°æ“ä½œç¬¦" class="headerlink" title="æŒ‡æ•°æ“ä½œç¬¦"></a>æŒ‡æ•°æ“ä½œç¬¦</h3><p>åœ¨ ES7 ä¸­å¼•å…¥äº†æŒ‡æ•°è¿ç®—ç¬¦<code>**</code>ï¼Œ<code>**</code>å…·æœ‰ä¸<code>Math.pow(..)</code>ç­‰æ•ˆçš„è®¡ç®—ç»“æœã€‚</p>
<p><strong>ä¸ä½¿ç”¨æŒ‡æ•°æ“ä½œç¬¦</strong></p>
<p>ä½¿ç”¨è‡ªå®šä¹‰çš„é€’å½’å‡½æ•° calculateExponent æˆ–è€… Math.pow() è¿›è¡ŒæŒ‡æ•°è¿ç®—ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateExponent</span>(<span class="params">base, exponent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (exponent === <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> base * calculateExponent(base, exponent - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(calculateExponent(<span class="number">2</span>, <span class="number">10</span>)); <span class="comment">// è¾“å‡º1024</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Math</span>.pow(<span class="number">2</span>, <span class="number">10</span>)); <span class="comment">// è¾“å‡º1024</span></span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨æŒ‡æ•°æ“ä½œç¬¦</strong></p>
<p>ä½¿ç”¨æŒ‡æ•°è¿ç®—ç¬¦**ï¼Œå°±åƒ+ã€-ç­‰æ“ä½œç¬¦ä¸€æ ·ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">2</span>**<span class="number">10</span>);<span class="comment">// è¾“å‡º1024</span></span><br></pre></td></tr></table></figure>

<h2 id="ES8æ–°ç‰¹æ€§ï¼ˆ2017ï¼‰"><a href="#ES8æ–°ç‰¹æ€§ï¼ˆ2017ï¼‰" class="headerlink" title="ES8æ–°ç‰¹æ€§ï¼ˆ2017ï¼‰"></a>ES8æ–°ç‰¹æ€§ï¼ˆ2017ï¼‰</h2><ul>
<li>async/await</li>
<li><code>Object.values()</code></li>
<li><code>Object.entries()</code></li>
<li>String padding: <code>padStart()</code>å’Œ<code>padEnd()</code>ï¼Œå¡«å……å­—ç¬¦ä¸²è¾¾åˆ°å½“å‰é•¿åº¦</li>
<li>å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å·</li>
<li><code>Object.getOwnPropertyDescriptors()</code></li>
<li><code>ShareArrayBuffer</code>å’Œ<code>Atomics</code>å¯¹è±¡ï¼Œç”¨äºä»å…±äº«å†…å­˜ä½ç½®è¯»å–å’Œå†™å…¥</li>
</ul>
<h3 id="async-await"><a href="#async-await" class="headerlink" title="async/await"></a>async/await</h3><p> ES6 æä¾›çš„ Promise æ–¹æ³•å’Œ ES7 æä¾›çš„ Async/Await è¯­æ³•ç³–å¯ä»¥æ›´å¥½è§£å†³å¤šå±‚å›è°ƒé—®é¢˜</p>
<p>Promise å¯¹è±¡ç”¨äºè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆçŠ¶æ€ï¼ˆå®Œæˆæˆ–å¤±è´¥ï¼‰ï¼Œä»¥åŠå…¶è¿”å›çš„å€¼ã€‚</p>
<ul>
<li>async è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª async å‡½æ•°ï¼Œå³å¼‚æ­¥å‡½æ•°ã€‚</li>
<li>await æ“ä½œç¬¦ç”¨äºç­‰å¾…ä¸€ä¸ª Promise å¯¹è±¡ã€‚å®ƒåªèƒ½åœ¨å¼‚æ­¥å‡½æ•° async function ä¸­ä½¿ç”¨ï¼ŒPromise è¿”å›ç»“æœåï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</li>
<li>await åé¢è·Ÿç€çš„åº”è¯¥æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼ˆå½“ç„¶ï¼Œå…¶ä»–è¿”å›å€¼ä¹Ÿæ²¡å…³ç³»ï¼Œåªæ˜¯ä¼šç«‹å³æ‰§è¡Œï¼Œä¸è¿‡é‚£æ ·å°±æ²¡æœ‰æ„ä¹‰äº†â€¦ï¼‰</li>
<li>await ç­‰å¾…çš„è™½ç„¶æ˜¯ Promise å¯¹è±¡ï¼Œä½†ä¸å¿…å†™.then(..)ï¼Œç›´æ¥å¯ä»¥å¾—åˆ°è¿”å›å€¼ã€‚</li>
</ul>
<h3 id="Object-values"><a href="#Object-values" class="headerlink" title="Object.values()"></a>Object.values()</h3><p><code>Object.values()</code>æ˜¯ä¸€ä¸ªä¸<code>Object.keys()</code>ç±»ä¼¼çš„æ–°å‡½æ•°ï¼Œä½†è¿”å›çš„æ˜¯Objectè‡ªèº«å±æ€§çš„æ‰€æœ‰å€¼ï¼Œä¸åŒ…æ‹¬ç»§æ‰¿çš„å€¼ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬è¦éå†å¦‚ä¸‹å¯¹è±¡<code>obj</code>çš„æ‰€æœ‰å€¼ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;<span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span>&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸ä½¿ç”¨Object.values() :ES7</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> vals=<span class="built_in">Object</span>.keys(obj).map(<span class="function"><span class="params">key</span>=&gt;</span>obj[key]);</span><br><span class="line"><span class="built_in">console</span>.log(vals);<span class="comment">//[1, 2, 3]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä½¿ç”¨Object.values() :ES8</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> values=<span class="built_in">Object</span>.values(obj1);</span><br><span class="line"><span class="built_in">console</span>.log(values);<span class="comment">//[1, 2, 3]</span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹å‡º<code>Object.values()</code>ä¸ºæˆ‘ä»¬çœå»äº†éå†keyï¼Œå¹¶æ ¹æ®è¿™äº›keyè·å–valueçš„æ­¥éª¤ã€‚</p>
<h3 id="Object-entries"><a href="#Object-entries" class="headerlink" title="Object.entries()"></a>Object.entries()</h3><p><code>Object.entries()</code>å‡½æ•°è¿”å›ä¸€ä¸ªç»™å®šå¯¹è±¡è‡ªèº«å¯æšä¸¾å±æ€§çš„é”®å€¼å¯¹çš„æ•°ç»„ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éå†ä¸Šæ–‡ä¸­çš„<code>obj</code>å¯¹è±¡çš„æ‰€æœ‰å±æ€§çš„keyå’Œvalueï¼š</p>
<blockquote>
<p>ä¸ä½¿ç”¨Object.entries() :ES7</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;key:&#x27;</span>+key+<span class="string">&#x27; value:&#x27;</span>+obj[key]);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//key:a value:1</span></span><br><span class="line"><span class="comment">//key:b value:2</span></span><br><span class="line"><span class="comment">//key:c value:3</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä½¿ç”¨Object.entries() :ES8</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> [key,value] <span class="keyword">of</span> <span class="built_in">Object</span>.entries(obj1))&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`key: <span class="subst">$&#123;key&#125;</span> value:<span class="subst">$&#123;value&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//key:a value:1</span></span><br><span class="line"><span class="comment">//key:b value:2</span></span><br><span class="line"><span class="comment">//key:c value:3</span></span><br></pre></td></tr></table></figure>

<h3 id="String-padding"><a href="#String-padding" class="headerlink" title="String padding"></a>String padding</h3><p>åœ¨ ES8 ä¸­ String æ–°å¢äº†ä¸¤ä¸ªå®ä¾‹å‡½æ•°<code>String.prototype.padStart</code>å’Œ<code>String.prototype.padEnd</code>ï¼Œå…è®¸å°†ç©ºå­—ç¬¦ä¸²æˆ–å…¶ä»–å­—ç¬¦ä¸²æ·»åŠ åˆ°åŸå§‹å­—ç¬¦ä¸²çš„å¼€å¤´æˆ–ç»“å°¾ã€‚</p>
<blockquote>
<p>String.padStart(targetLength,[padString])</p>
</blockquote>
<ul>
<li>targetLengthï¼šå½“å‰å­—ç¬¦ä¸²éœ€è¦å¡«å……åˆ°çš„ç›®æ ‡é•¿åº¦ã€‚å¦‚æœè¿™ä¸ªæ•°å€¼å°äºå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦ä¸²æœ¬èº«ã€‚</li>
<li>padString(å¯é€‰)ï¼šå¡«å……å­—ç¬¦ä¸²ã€‚å¦‚æœå­—ç¬¦ä¸²å¤ªé•¿ï¼Œä½¿å¡«å……åçš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡äº†ç›®æ ‡é•¿åº¦ï¼Œåˆ™åªä¿ç•™æœ€å·¦ä¾§çš„éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†ä¼šè¢«æˆªæ–­ï¼Œæ­¤å‚æ•°çš„ç¼ºçœå€¼ä¸º â€œ â€œã€‚</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;0.0&#x27;</span>.padStart(<span class="number">4</span>,<span class="string">&#x27;10&#x27;</span>)) <span class="comment">//10.0</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;0.0&#x27;</span>.padStart(<span class="number">20</span>)) <span class="comment">// 0.00</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>String.padEnd(targetLength,padString])</p>
</blockquote>
<ul>
<li>targetLengthï¼šå½“å‰å­—ç¬¦ä¸²éœ€è¦å¡«å……åˆ°çš„ç›®æ ‡é•¿åº¦ã€‚å¦‚æœè¿™ä¸ªæ•°å€¼å°äºå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ™è¿”å›å½“å‰å­—ç¬¦ä¸²æœ¬èº«ã€‚</li>
<li>padString(å¯é€‰)ï¼šå¡«å……å­—ç¬¦ä¸²ã€‚å¦‚æœå­—ç¬¦ä¸²å¤ªé•¿ï¼Œä½¿å¡«å……åçš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡äº†ç›®æ ‡é•¿åº¦ï¼Œåˆ™åªä¿ç•™æœ€å·¦ä¾§çš„éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†ä¼šè¢«æˆªæ–­ï¼Œæ­¤å‚æ•°çš„ç¼ºçœå€¼ä¸º â€œ â€œï¼›</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;0.0&#x27;</span>.padEnd(<span class="number">4</span>,<span class="string">&#x27;0&#x27;</span>))  <span class="comment">//0.00    </span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;0.0&#x27;</span>.padEnd(<span class="number">10</span>,<span class="string">&#x27;0&#x27;</span>)) <span class="comment">// 0.00000000</span></span><br></pre></td></tr></table></figure>

<h3 id="å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å·"><a href="#å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å·" class="headerlink" title="å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å·"></a>å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å·</h3><p>ä¸»è¦ä½œç”¨æ˜¯æ–¹ä¾¿ä½¿ç”¨ git è¿›è¡Œå¤šäººåä½œå¼€å‘æ—¶ä¿®æ”¹åŒä¸€ä¸ªå‡½æ•°å‡å°‘ä¸å¿…è¦çš„è¡Œå˜æ›´ã€‚</p>
<h3 id="Object-getOwnPropertyDescriptors"><a href="#Object-getOwnPropertyDescriptors" class="headerlink" title="Object.getOwnPropertyDescriptors()"></a>Object.getOwnPropertyDescriptors()</h3><p><code>Object.getOwnPropertyDescriptors()</code>å‡½æ•°ç”¨æ¥è·å–ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰è‡ªèº«å±æ€§çš„æè¿°ç¬¦ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•è‡ªèº«å±æ€§ï¼Œåˆ™è¿”å›ç©ºå¯¹è±¡ã€‚</p>
<p>å‡½æ•°åŸå‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptors(obj)</span><br></pre></td></tr></table></figure>

<p>è¿”å›<code>obj</code>å¯¹è±¡çš„æ‰€æœ‰è‡ªèº«å±æ€§çš„æè¿°ç¬¦ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•è‡ªèº«å±æ€§ï¼Œåˆ™è¿”å›ç©ºå¯¹è±¡ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj2 = &#123;</span><br><span class="line">	name: <span class="string">&#x27;Jine&#x27;</span>,</span><br><span class="line">	<span class="keyword">get</span> <span class="title">age</span>() &#123; <span class="keyword">return</span> <span class="string">&#x27;18&#x27;</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptors(obj2)</span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   age: &#123;</span></span><br><span class="line"><span class="comment">//     configurable: true,</span></span><br><span class="line"><span class="comment">//     enumerable: true,</span></span><br><span class="line"><span class="comment">//     get: function age()&#123;&#125;, //the getter function</span></span><br><span class="line"><span class="comment">//     set: undefined</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   name: &#123;</span></span><br><span class="line"><span class="comment">//     configurable: true,</span></span><br><span class="line"><span class="comment">//     enumerable: true,</span></span><br><span class="line"><span class="comment">//		value:&quot;Jine&quot;,</span></span><br><span class="line"><span class="comment">//		writable:true</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="SharedArrayBufferå¯¹è±¡"><a href="#SharedArrayBufferå¯¹è±¡" class="headerlink" title="SharedArrayBufferå¯¹è±¡"></a>SharedArrayBufferå¯¹è±¡</h3><p>SharedArrayBuffer å¯¹è±¡ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé€šç”¨çš„ï¼Œå›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºï¼Œç±»ä¼¼äº ArrayBuffer å¯¹è±¡ï¼Œå®ƒä»¬éƒ½å¯ä»¥ç”¨æ¥åœ¨å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ä¸Šåˆ›å»ºè§†å›¾ã€‚ä¸ ArrayBuffer ä¸åŒçš„æ˜¯ï¼ŒSharedArrayBuffer ä¸èƒ½è¢«åˆ†ç¦»ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>length æ‰€åˆ›å»ºçš„æ•°ç»„ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥å­—èŠ‚(byte)ä¸ºå•ä½ã€‚  </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;SharedArrayBuffer&#125;</span> </span>ä¸€ä¸ªå¤§å°æŒ‡å®šçš„æ–° SharedArrayBuffer å¯¹è±¡ã€‚å…¶å†…å®¹è¢«åˆå§‹åŒ–ä¸º 0ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">new</span> SharedArrayBuffer(length)</span><br></pre></td></tr></table></figure>

<h3 id="Atomicså¯¹è±¡"><a href="#Atomicså¯¹è±¡" class="headerlink" title="Atomicså¯¹è±¡"></a>Atomicså¯¹è±¡</h3><p>Atomics å¯¹è±¡æä¾›äº†ä¸€ç»„é™æ€æ–¹æ³•ç”¨æ¥å¯¹ SharedArrayBuffer å¯¹è±¡è¿›è¡ŒåŸå­æ“ä½œã€‚</p>
<p>è¿™äº›åŸå­æ“ä½œå±äº Atomics æ¨¡å—ã€‚ä¸ä¸€èˆ¬çš„å…¨å±€å¯¹è±¡ä¸åŒï¼ŒAtomics ä¸æ˜¯æ„é€ å‡½æ•°ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ new æ“ä½œç¬¦è°ƒç”¨ï¼Œä¹Ÿä¸èƒ½å°†å…¶å½“ä½œå‡½æ•°ç›´æ¥è°ƒç”¨ã€‚Atomics çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼ˆä¸ Math å¯¹è±¡ä¸€æ ·ï¼‰ã€‚</p>
<p>å¤šä¸ªå…±äº«å†…å­˜çš„çº¿ç¨‹èƒ½å¤ŸåŒæ—¶è¯»å†™åŒä¸€ä½ç½®ä¸Šçš„æ•°æ®ã€‚åŸå­æ“ä½œä¼šç¡®ä¿æ­£åœ¨è¯»æˆ–å†™çš„æ•°æ®çš„å€¼æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå³ä¸‹ä¸€ä¸ªåŸå­æ“ä½œä¸€å®šä¼šåœ¨ä¸Šä¸€ä¸ªåŸå­æ“ä½œç»“æŸåæ‰ä¼šå¼€å§‹ï¼Œå…¶æ“ä½œè¿‡ç¨‹ä¸ä¼šä¸­æ–­ã€‚</p>
<ul>
<li>Atomics.add()</li>
</ul>
<blockquote>
<p>å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸ç»™å®šçš„å€¼ç›¸åŠ ï¼Œå¹¶è¿”å›ç›¸åŠ å‰è¯¥å…ƒç´ çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.and()</li>
</ul>
<blockquote>
<p>å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸ç»™å®šçš„å€¼ç›¸ä¸ï¼Œå¹¶è¿”å›ä¸æ“ä½œå‰è¯¥å…ƒç´ çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.compareExchange()</li>
</ul>
<blockquote>
<p>å¦‚æœæ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ ä¸ç»™å®šçš„å€¼ä¸ç­‰ï¼Œåˆ™å°†å…¶æ›´æ–°ä¸ºæ–°çš„å€¼ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ åŸå…ˆçš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.exchange()</li>
</ul>
<blockquote>
<p>å°†æ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ æ›´æ–°ä¸ºç»™å®šçš„å€¼ï¼Œå¹¶è¿”å›è¯¥å…ƒç´ æ›´æ–°å‰çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.load()</li>
</ul>
<blockquote>
<p>è¿”å›æ•°ç»„ä¸­æŒ‡å®šå…ƒç´ çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.or()</li>
</ul>
<blockquote>
<p>å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸ç»™å®šçš„å€¼ç›¸æˆ–ï¼Œå¹¶è¿”å›æˆ–æ“ä½œå‰è¯¥å…ƒç´ çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.store()</li>
</ul>
<blockquote>
<p>å°†æ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ è®¾ç½®ä¸ºç»™å®šçš„å€¼ï¼Œå¹¶è¿”å›è¯¥å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.sub()</li>
</ul>
<blockquote>
<p>å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸ç»™å®šçš„å€¼ç›¸å‡ï¼Œå¹¶è¿”å›ç›¸å‡å‰è¯¥å…ƒç´ çš„å€¼ã€‚</p>
</blockquote>
<ul>
<li>Atomics.xor()</li>
</ul>
<blockquote>
<p>å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸ç»™å®šçš„å€¼ç›¸å¼‚æˆ–ï¼Œå¹¶è¿”å›å¼‚æˆ–æ“ä½œå‰è¯¥å…ƒç´ çš„å€¼ã€‚</p>
</blockquote>
<p>wait() å’Œ wake() æ–¹æ³•é‡‡ç”¨çš„æ˜¯ Linux ä¸Šçš„ futexes æ¨¡å‹ï¼ˆfast user-space mutexï¼Œå¿«é€Ÿç”¨æˆ·ç©ºé—´äº’æ–¥é‡ï¼‰ï¼Œå¯ä»¥è®©è¿›ç¨‹ä¸€ç›´ç­‰å¾…ç›´åˆ°æŸä¸ªç‰¹å®šçš„æ¡ä»¶ä¸ºçœŸï¼Œä¸»è¦ç”¨äºå®ç°é˜»å¡ã€‚</p>
<ul>
<li>Atomics.wait()</li>
</ul>
<blockquote>
<p>æ£€æµ‹æ•°ç»„ä¸­æŸä¸ªæŒ‡å®šä½ç½®ä¸Šçš„å€¼æ˜¯å¦ä»ç„¶æ˜¯ç»™å®šå€¼ï¼Œæ˜¯åˆ™ä¿æŒæŒ‚èµ·ç›´åˆ°è¢«å”¤é†’æˆ–è¶…æ—¶ã€‚è¿”å›å€¼ä¸º â€œokâ€ã€â€not-equalâ€ æˆ– â€œtime-outâ€ã€‚è°ƒç”¨æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸å…è®¸é˜»å¡ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå¤§å¤šæ•°æµè§ˆå™¨éƒ½ä¸å…è®¸åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ wait()ï¼‰ã€‚</p>
</blockquote>
<ul>
<li>Atomics.wake()</li>
</ul>
<blockquote>
<p>å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­æ­£åœ¨æ•°ç»„æŒ‡å®šä½ç½®çš„å…ƒç´ ä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚è¿”å›å€¼ä¸ºæˆåŠŸå”¤é†’çš„çº¿ç¨‹æ•°é‡ã€‚</p>
</blockquote>
<ul>
<li>Atomics.isLockFree(size)</li>
</ul>
<blockquote>
<p>å¯ä»¥ç”¨æ¥æ£€æµ‹å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒç¡¬ä»¶çº§çš„åŸå­æ“ä½œã€‚å¯¹äºæŒ‡å®šå¤§å°çš„æ•°ç»„ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿæ”¯æŒç¡¬ä»¶çº§çš„åŸå­æ“ä½œï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™å°±æ„å‘³ç€å¯¹äºè¯¥æ•°ç»„ï¼ŒAtomics å¯¹è±¡ä¸­çš„å„åŸå­æ“ä½œéƒ½åªèƒ½ç”¨é”æ¥å®ç°ã€‚æ­¤å‡½æ•°é¢å‘çš„æ˜¯æŠ€æœ¯ä¸“å®¶ã€‚â€“&gt;</p>
</blockquote>
<h2 id="ES9æ–°ç‰¹æ€§ï¼ˆ2018ï¼‰"><a href="#ES9æ–°ç‰¹æ€§ï¼ˆ2018ï¼‰" class="headerlink" title="ES9æ–°ç‰¹æ€§ï¼ˆ2018ï¼‰"></a>ES9æ–°ç‰¹æ€§ï¼ˆ2018ï¼‰</h2><ul>
<li>å¼‚æ­¥è¿­ä»£</li>
<li>Promise.finally()</li>
<li>Rest/Spread å±æ€§</li>
<li><a href="http://esnext.justjavac.com/proposal/regexp-named-groups.html">æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„</a>ï¼ˆRegular Expression Named Capture Groupsï¼‰</li>
<li><a href="https://segmentfault.com/a/1190000006824133">æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€</a>ï¼ˆlookbehindï¼‰</li>
<li>æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼</li>
<li><a href="https://juejin.im/post/6844903622870827022#heading-1">æ­£åˆ™è¡¨è¾¾å¼ Unicode è½¬ä¹‰</a></li>
<li><a href="https://juejin.im/post/6844903622870827022#heading-1">éè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸²</a></li>
</ul>
<h3 id="å¼‚æ­¥è¿­ä»£"><a href="#å¼‚æ­¥è¿­ä»£" class="headerlink" title="å¼‚æ­¥è¿­ä»£"></a>å¼‚æ­¥è¿­ä»£</h3><p>åœ¨<code>async/await</code>çš„æŸäº›æ—¶åˆ»ï¼Œä½ å¯èƒ½å°è¯•åœ¨åŒæ­¥å¾ªç¯ä¸­è°ƒç”¨å¼‚æ­¥å‡½æ•°ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> array) &#123;</span><br><span class="line">    <span class="keyword">await</span> doSomething(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç ä¸ä¼šæ­£å¸¸è¿è¡Œï¼Œä¸‹é¢è¿™æ®µåŒæ ·ä¹Ÿä¸ä¼šï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  array.forEach(<span class="keyword">async</span> i =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> doSomething(i);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç ä¸­ï¼Œå¾ªç¯æœ¬èº«ä¾æ—§ä¿æŒåŒæ­¥ï¼Œå¹¶åœ¨åœ¨å†…éƒ¨å¼‚æ­¥å‡½æ•°ä¹‹å‰å…¨éƒ¨è°ƒç”¨å®Œæˆã€‚</p>
<p>ES2018 å¼•å…¥å¼‚æ­¥è¿­ä»£å™¨ï¼ˆasynchronous iteratorsï¼‰ï¼Œè¿™å°±åƒå¸¸è§„è¿­ä»£å™¨ï¼Œé™¤äº†<code>next()</code>æ–¹æ³•è¿”å›ä¸€ä¸ªPromiseã€‚å› æ­¤<code>await</code>å¯ä»¥å’Œ<code>for...of</code>å¾ªç¯ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¸²è¡Œçš„æ–¹å¼è¿è¡Œå¼‚æ­¥æ“ä½œã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">let</span> i <span class="keyword">of</span> array) &#123;</span><br><span class="line">    doSomething(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Promise-finally"><a href="#Promise-finally" class="headerlink" title="Promise.finally()"></a>Promise.finally()</h3><p>ä¸€ä¸ª Promise è°ƒç”¨é“¾è¦ä¹ˆæˆåŠŸåˆ°è¾¾æœ€åä¸€ä¸ª<code>.then()</code>ï¼Œè¦ä¹ˆå¤±è´¥è§¦å‘<code>.catch()</code>ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ æƒ³è¦åœ¨æ— è®ºPromiseè¿è¡ŒæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿è¡Œç›¸åŒçš„ä»£ç ï¼Œä¾‹å¦‚æ¸…é™¤ï¼Œåˆ é™¤å¯¹è¯ï¼Œå…³é—­æ•°æ®åº“è¿æ¥ç­‰ã€‚</p>
<p><code>.finally()</code>å…è®¸ä½ æŒ‡å®šæœ€ç»ˆçš„é€»è¾‘ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomething</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  doSomething1()</span><br><span class="line">  .then(doSomething2)</span><br><span class="line">  .then(doSomething3)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;)</span><br><span class="line">  .finally(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// finish here!</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rest-Spread-å±æ€§"><a href="#Rest-Spread-å±æ€§" class="headerlink" title="Rest/Spread å±æ€§"></a>Rest/Spread å±æ€§</h3><p>ES2015 å¼•å…¥äº†<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Rest_parameters">Restå‚æ•°</a>å’Œ<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax">æ‰©å±•è¿ç®—ç¬¦</a>ã€‚ä¸‰ä¸ªç‚¹ï¼ˆâ€¦ï¼‰ä»…ç”¨äºæ•°ç»„ã€‚Restå‚æ•°è¯­æ³•å…è®¸æˆ‘ä»¬å°†ä¸€ä¸ªä¸å®šæ•°é‡çš„å‚æ•°è¡¨ç¤ºä¸ºä¸€ä¸ªæ•°ç»„ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">restParam(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restParam</span>(<span class="params">p1, p2, ...p3</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// p1 = 1</span></span><br><span class="line">  <span class="comment">// p2 = 2</span></span><br><span class="line">  <span class="comment">// p3 = [3, 4, 5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å±•å¼€æ“ä½œç¬¦ä»¥ç›¸åçš„æ–¹å¼å·¥ä½œï¼Œå°†æ•°ç»„è½¬æ¢æˆå¯ä¼ é€’ç»™å‡½æ•°çš„å•ç‹¬å‚æ•°ã€‚ä¾‹å¦‚<code>Math.max()</code>è¿”å›ç»™å®šæ•°å­—ä¸­çš„æœ€å¤§å€¼ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> values = [<span class="number">99</span>, <span class="number">100</span>, -<span class="number">1</span>, <span class="number">48</span>, <span class="number">16</span>];</span><br><span class="line"><span class="built_in">console</span>.log( <span class="built_in">Math</span>.max(...values) ); <span class="comment">// 100</span></span><br></pre></td></tr></table></figure>

<p>ES2018 ä¸ºå¯¹è±¡è§£æ„æä¾›äº†å’Œæ•°ç»„ä¸€æ ·çš„Restå‚æ•°ï¼ˆï¼‰å’Œå±•å¼€æ“ä½œç¬¦ï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> myObject = &#123;</span><br><span class="line">  a: <span class="number">1</span>,</span><br><span class="line">  b: <span class="number">2</span>,</span><br><span class="line">  c: <span class="number">3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; a, ...x &#125; = myObject;</span><br><span class="line"><span class="comment">// a = 1</span></span><br><span class="line"><span class="comment">// x = &#123; b: 2, c: 3 &#125;</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨å®ƒç»™å‡½æ•°ä¼ é€’å‚æ•°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">restParam(&#123;</span><br><span class="line">  a: <span class="number">1</span>,</span><br><span class="line">  b: <span class="number">2</span>,</span><br><span class="line">  c: <span class="number">3</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restParam</span>(<span class="params">&#123; a, ...x &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// a = 1</span></span><br><span class="line">  <span class="comment">// x = &#123; b: 2, c: 3 &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿæ•°ç»„ä¸€æ ·ï¼ŒRestå‚æ•°åªèƒ½åœ¨å£°æ˜çš„ç»“å°¾å¤„ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œå®ƒåªé€‚ç”¨äºæ¯ä¸ªå¯¹è±¡çš„é¡¶å±‚ï¼Œå¦‚æœå¯¹è±¡ä¸­åµŒå¥—å¯¹è±¡åˆ™æ— æ³•é€‚ç”¨ã€‚</p>
<p>æ‰©å±•è¿ç®—ç¬¦å¯ä»¥åœ¨å…¶ä»–å¯¹è±¡å†…ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> obj1 = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>, <span class="attr">c</span>: <span class="number">3</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> obj2 = &#123; ...obj1, <span class="attr">z</span>: <span class="number">26</span> &#125;;</span><br><span class="line"><span class="comment">// obj2 is &#123; a: 1, b: 2, c: 3, z: 26 &#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦æ‹·è´ä¸€ä¸ªå¯¹è±¡ï¼Œåƒæ˜¯è¿™æ ·<code>obj2 = &#123;...obj1&#125;</code>ï¼Œä½†æ˜¯ <strong>è¿™åªæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æµ…æ‹·è´</strong>ã€‚å¦å¤–ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡Açš„å±æ€§æ˜¯å¯¹è±¡Bï¼Œé‚£ä¹ˆåœ¨å…‹éš†åçš„å¯¹è±¡ cloneB ä¸­ï¼Œè¯¥å±æ€§æŒ‡å‘å¯¹è±¡Bã€‚</p>
<h3 id="æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„"><a href="#æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„"></a>æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„</h3><p>JavaScript æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥è¿”å›ä¸€ä¸ªåŒ¹é…çš„å¯¹è±¡â€”â€”ä¸€ä¸ªåŒ…å«åŒ¹é…å­—ç¬¦ä¸²çš„ç±»æ•°ç»„ï¼Œä¾‹å¦‚ï¼šä»¥<code>YYYY-MM-DD</code>çš„æ ¼å¼è§£ææ—¥æœŸï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span></span><br><span class="line">  reDate = <span class="regexp">/([0-9]&#123;4&#125;)-([0-9]&#123;2&#125;)-([0-9]&#123;2&#125;)/</span>,</span><br><span class="line">  match  = reDate.exec(<span class="string">&#x27;2018-04-30&#x27;</span>),</span><br><span class="line">  year   = match[<span class="number">1</span>], <span class="comment">// 2018</span></span><br><span class="line">  month  = match[<span class="number">2</span>], <span class="comment">// 04</span></span><br><span class="line">  day    = match[<span class="number">3</span>]; <span class="comment">// 30</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„ä»£ç å¾ˆéš¾è¯»æ‡‚ï¼Œå¹¶ä¸”æ”¹å˜æ­£åˆ™è¡¨è¾¾å¼çš„ç»“æ„æœ‰å¯èƒ½æ”¹å˜åŒ¹é…å¯¹è±¡çš„ç´¢å¼•ã€‚</p>
<p>ES2018 å…è®¸å‘½åæ•è·ç»„ä½¿ç”¨ç¬¦å·<code>?&lt;name&gt;</code>ï¼Œåœ¨æ‰“å¼€æ•è·æ‹¬å·<code>(</code>åç«‹å³å‘½åï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span></span><br><span class="line">  reDate = <span class="regexp">/(?&lt;year&gt;[0-9]&#123;4&#125;)-(?&lt;month&gt;[0-9]&#123;2&#125;)-(?&lt;day&gt;[0-9]&#123;2&#125;)/</span>,</span><br><span class="line">  match  = reDate.exec(<span class="string">&#x27;2018-04-30&#x27;</span>),</span><br><span class="line">  year   = match.groups.year,  <span class="comment">// 2018</span></span><br><span class="line">  month  = match.groups.month, <span class="comment">// 04</span></span><br><span class="line">  day    = match.groups.day;   <span class="comment">// 30</span></span><br></pre></td></tr></table></figure>

<p>ä»»ä½•åŒ¹é…å¤±è´¥çš„å‘½åç»„éƒ½å°†è¿”å›<code>undefined</code>ã€‚</p>
<p>å‘½åæ•è·ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨<code>replace()</code>æ–¹æ³•ä¸­ã€‚ä¾‹å¦‚å°†æ—¥æœŸè½¬æ¢ä¸ºç¾å›½çš„ MM-DD-YYYY æ ¼å¼ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span></span><br><span class="line">  reDate = <span class="regexp">/(?&lt;year&gt;[0-9]&#123;4&#125;)-(?&lt;month&gt;[0-9]&#123;2&#125;)-(?&lt;day&gt;[0-9]&#123;2&#125;)/</span>,</span><br><span class="line">  d      = <span class="string">&#x27;2018-04-30&#x27;</span>,</span><br><span class="line">  usDate = d.replace(reDate, <span class="string">&#x27;$&lt;month&gt;-$&lt;day&gt;-$&lt;year&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€"><a href="#æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€"></a>æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€</h3><p>ç›®å‰ JavaScript åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­æ”¯æŒå…ˆè¡Œæ–­è¨€ï¼ˆlookaheadï¼‰ã€‚è¿™æ„å‘³ç€åŒ¹é…ä¼šå‘ç”Ÿï¼Œä½†ä¸ä¼šæœ‰ä»»ä½•æ•è·ï¼Œå¹¶ä¸”æ–­è¨€æ²¡æœ‰åŒ…å«åœ¨æ•´ä¸ªåŒ¹é…å­—æ®µä¸­ã€‚ä¾‹å¦‚ä»ä»·æ ¼ä¸­æ•è·è´§å¸ç¬¦å·ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span></span><br><span class="line">  reLookahead = <span class="regexp">/\D(?=\d+)/</span>,</span><br><span class="line">  match       = reLookahead.exec(<span class="string">&#x27;$123.89&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log( match[<span class="number">0</span>] ); <span class="comment">// $</span></span><br></pre></td></tr></table></figure>

<p>ES2018 å¼•å…¥ä»¥ç›¸åŒæ–¹å¼å·¥ä½œä½†æ˜¯åŒ¹é…å‰é¢çš„åå‘æ–­è¨€ï¼ˆlookbehindï¼‰ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥å¿½ç•¥è´§å¸ç¬¦å·ï¼Œå•çº¯çš„æ•è·ä»·æ ¼çš„æ•°å­—ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span></span><br><span class="line">  reLookbehind = <span class="regexp">/(?&lt;=\D)\d+/</span>,</span><br><span class="line">  match        = reLookbehind.exec(<span class="string">&#x27;$123.89&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log( match[<span class="number">0</span>] ); <span class="comment">// 123.89</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šæ˜¯ <strong>è‚¯å®šåå‘æ–­è¨€</strong>ï¼Œéæ•°å­—<code>\D</code>å¿…é¡»å­˜åœ¨ã€‚åŒæ ·çš„ï¼Œè¿˜å­˜åœ¨ <strong>å¦å®šåå‘æ–­è¨€</strong>ï¼Œè¡¨ç¤ºä¸€ä¸ªå€¼å¿…é¡»ä¸å­˜åœ¨ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span></span><br><span class="line">  reLookbehindNeg = <span class="regexp">/(?&lt;!\D)\d+/</span>,</span><br><span class="line">  match           = reLookbehind.exec(<span class="string">&#x27;$123.89&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log( match[<span class="number">0</span>] ); <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<h3 id="æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼"><a href="#æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼"></a>æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼</h3><p>æ­£åˆ™è¡¨è¾¾å¼ä¸­ç‚¹<code>.</code>åŒ¹é…é™¤å›è½¦å¤–çš„ä»»ä½•å•å­—ç¬¦ï¼Œæ ‡è®°<code>s</code>æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œå…è®¸è¡Œç»ˆæ­¢ç¬¦çš„å‡ºç°ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/hello.world/.test(<span class="string">&#x27;hello\nworld&#x27;</span>);  <span class="comment">// false</span></span><br><span class="line">/hello.world/s.test(<span class="string">&#x27;hello\nworld&#x27;</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="æ­£åˆ™è¡¨è¾¾å¼-Unicode-è½¬ä¹‰"><a href="#æ­£åˆ™è¡¨è¾¾å¼-Unicode-è½¬ä¹‰" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼ Unicode è½¬ä¹‰"></a>æ­£åˆ™è¡¨è¾¾å¼ Unicode è½¬ä¹‰</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ¬åœ°è®¿é—® Unicode å­—ç¬¦å±æ€§æ˜¯ä¸è¢«å…è®¸çš„ã€‚ES2018æ·»åŠ äº† Unicode å±æ€§è½¬ä¹‰â€”â€”å½¢å¼ä¸º<code>\p&#123;...&#125;</code>å’Œ<code>\P&#123;...&#125;</code>ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä½¿ç”¨æ ‡è®° <code>u</code> (unicode) è®¾ç½®ï¼Œåœ¨<code>\p</code>å—å„¿å†…ï¼Œå¯ä»¥ä»¥é”®å€¼å¯¹çš„æ–¹å¼è®¾ç½®éœ€è¦åŒ¹é…çš„å±æ€§è€Œéå…·ä½“å†…å®¹ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> reGreekSymbol = <span class="regexp">/\p&#123;Script=Greek&#125;/u</span>;</span><br><span class="line">reGreekSymbol.test(<span class="string">&#x27;Ï€&#x27;</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>æ­¤ç‰¹æ€§å¯ä»¥é¿å…ä½¿ç”¨ç‰¹å®š Unicode åŒºé—´æ¥è¿›è¡Œå†…å®¹ç±»å‹åˆ¤æ–­ï¼Œæå‡å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<h3 id="éè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸²"><a href="#éè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸²" class="headerlink" title="éè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸²"></a>éè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸²</h3><p>ä¹‹å‰ï¼Œ<code>\u</code>å¼€å§‹ä¸€ä¸ª unicode è½¬ä¹‰ï¼Œ<code>\x</code>å¼€å§‹ä¸€ä¸ªåå…­è¿›åˆ¶è½¬ä¹‰ï¼Œ<code>\</code>åè·Ÿä¸€ä¸ªæ•°å­—å¼€å§‹ä¸€ä¸ªå…«è¿›åˆ¶è½¬ä¹‰ã€‚è¿™ä½¿å¾—åˆ›å»ºç‰¹å®šçš„å­—ç¬¦ä¸²å˜å¾—ä¸å¯èƒ½ï¼Œä¾‹å¦‚Windowsæ–‡ä»¶è·¯å¾„ <code>C:\uuu\xxx\111</code>ã€‚æ›´å¤šç»†èŠ‚å‚è€ƒ<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings">æ¨¡æ¿å­—ç¬¦ä¸²</a>ã€‚</p>
<h2 id="ES10æ–°ç‰¹æ€§ï¼ˆ2019ï¼‰"><a href="#ES10æ–°ç‰¹æ€§ï¼ˆ2019ï¼‰" class="headerlink" title="ES10æ–°ç‰¹æ€§ï¼ˆ2019ï¼‰"></a>ES10æ–°ç‰¹æ€§ï¼ˆ2019ï¼‰</h2><ul>
<li>è¡Œåˆ†éš”ç¬¦ï¼ˆU + 2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU + 2029ï¼‰ç¬¦å·ç°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸JSONåŒ¹é…</li>
<li>æ›´åŠ å‹å¥½çš„ JSON.stringify</li>
<li>æ–°å¢äº†Arrayçš„<code>flat()</code>æ–¹æ³•å’Œ<code>flatMap()</code>æ–¹æ³•</li>
<li>æ–°å¢äº†Stringçš„<code>trimStart()</code>æ–¹æ³•å’Œ<code>trimEnd()</code>æ–¹æ³•</li>
<li><code>Object.fromEntries()</code></li>
<li><code>Symbol.prototype.description</code></li>
<li><code>String.prototype.matchAll</code></li>
<li><code>Function.prototype.toString()</code>ç°åœ¨è¿”å›ç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š</li>
<li>ç®€åŒ–<code>try &#123;&#125; catch &#123;&#125;</code>,ä¿®æ”¹ <code>catch</code> ç»‘å®š</li>
<li>æ–°çš„åŸºæœ¬æ•°æ®ç±»å‹<code>BigInt</code></li>
<li>globalThis</li>
<li>import()</li>
<li>Legacy RegEx</li>
<li>ç§æœ‰çš„å®ä¾‹æ–¹æ³•å’Œè®¿é—®å™¨</li>
</ul>
<h3 id="è¡Œåˆ†éš”ç¬¦ï¼ˆU-2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU-2029ï¼‰ç¬¦å·ç°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸-JSON-åŒ¹é…"><a href="#è¡Œåˆ†éš”ç¬¦ï¼ˆU-2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU-2029ï¼‰ç¬¦å·ç°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸-JSON-åŒ¹é…" class="headerlink" title="è¡Œåˆ†éš”ç¬¦ï¼ˆU + 2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU + 2029ï¼‰ç¬¦å·ç°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸ JSON åŒ¹é…"></a>è¡Œåˆ†éš”ç¬¦ï¼ˆU + 2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU + 2029ï¼‰ç¬¦å·ç°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸ JSON åŒ¹é…</h3><p>ä»¥å‰ï¼Œè¿™äº›ç¬¦å·åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­è¢«è§†ä¸ºè¡Œç»ˆæ­¢ç¬¦ï¼Œå› æ­¤ä½¿ç”¨å®ƒä»¬ä¼šå¯¼è‡´ SyntaxError å¼‚å¸¸ã€‚</p>
<h3 id="æ›´åŠ å‹å¥½çš„-JSON-stringify"><a href="#æ›´åŠ å‹å¥½çš„-JSON-stringify" class="headerlink" title="æ›´åŠ å‹å¥½çš„ JSON.stringify"></a>æ›´åŠ å‹å¥½çš„ JSON.stringify</h3><p>å¦‚æœè¾“å…¥ Unicode æ ¼å¼ä½†æ˜¯è¶…å‡ºèŒƒå›´çš„å­—ç¬¦ï¼Œåœ¨åŸå…ˆ JSON.stringify è¿”å›æ ¼å¼é”™è¯¯çš„Unicode å­—ç¬¦ä¸²ã€‚ç°åœ¨å®ç°äº†ä¸€ä¸ªæ”¹å˜ JSON.stringify çš„<a href="https://github.com/tc39/proposal-well-formed-stringify">ç¬¬3é˜¶æ®µææ¡ˆ</a>ï¼Œå› æ­¤å®ƒä¸ºå…¶è¾“å‡ºè½¬ä¹‰åºåˆ—ï¼Œä½¿å…¶æˆä¸ºæœ‰æ•ˆUnicodeï¼ˆå¹¶ä»¥UTF-8è¡¨ç¤ºï¼‰</p>
<h3 id="æ–°å¢äº†-Array-çš„-flat-æ–¹æ³•å’Œ-flatMap-æ–¹æ³•"><a href="#æ–°å¢äº†-Array-çš„-flat-æ–¹æ³•å’Œ-flatMap-æ–¹æ³•" class="headerlink" title="æ–°å¢äº† Array çš„ flat() æ–¹æ³•å’Œ flatMap() æ–¹æ³•"></a>æ–°å¢äº† Array çš„ flat() æ–¹æ³•å’Œ flatMap() æ–¹æ³•</h3><p><code>flat()</code> å’Œ <code>flatMap()</code>æœ¬è´¨ä¸Šå°±æ˜¯æ˜¯å½’çº³ï¼ˆreduceï¼‰ ä¸ åˆå¹¶ï¼ˆconcatï¼‰çš„æ“ä½œã€‚</p>
<h4 id="Array-prototype-flat"><a href="#Array-prototype-flat" class="headerlink" title="Array.prototype.flat()"></a>Array.prototype.flat()</h4><p><code>flat()</code> æ–¹æ³•ä¼šæŒ‰ç…§ä¸€ä¸ªå¯æŒ‡å®šçš„æ·±åº¦é€’å½’éå†æ•°ç»„ï¼Œå¹¶å°†æ‰€æœ‰å…ƒç´ ä¸éå†åˆ°çš„å­æ•°ç»„ä¸­çš„å…ƒç´ åˆå¹¶ä¸ºä¸€ä¸ªæ–°æ•°ç»„è¿”å›ã€‚</p>
<ul>
<li><code>flat()</code>æ–¹æ³•æœ€åŸºæœ¬çš„ä½œç”¨å°±æ˜¯æ•°ç»„é™ç»´</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr1 = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>]];</span><br><span class="line">arr1.flat(); </span><br><span class="line"><span class="comment">// [1, 2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr2 = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>]]];</span><br><span class="line">arr2.flat();</span><br><span class="line"><span class="comment">// [1, 2, 3, 4, [5, 6]]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr3 = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>]]];</span><br><span class="line">arr3.flat(<span class="number">2</span>);</span><br><span class="line"><span class="comment">// [1, 2, 3, 4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨ Infinity ä½œä¸ºæ·±åº¦ï¼Œå±•å¼€ä»»æ„æ·±åº¦çš„åµŒå¥—æ•°ç»„</span></span><br><span class="line">arr3.flat(<span class="literal">Infinity</span>); </span><br><span class="line"><span class="comment">// [1, 2, 3, 4, 5, 6]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å…¶æ¬¡ï¼Œè¿˜å¯ä»¥åˆ©ç”¨<code>flat()</code>æ–¹æ³•çš„ç‰¹æ€§æ¥å»é™¤æ•°ç»„çš„ç©ºé¡¹</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr4 = [<span class="number">1</span>, <span class="number">2</span>, , <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">arr4.flat();</span><br><span class="line"><span class="comment">// [1, 2, 4, 5]</span></span><br></pre></td></tr></table></figure>

<h4 id="Array-prototype-flatMap"><a href="#Array-prototype-flatMap" class="headerlink" title="Array.prototype.flatMap()"></a>Array.prototype.flatMap()</h4><p><code>flatMap()</code> æ–¹æ³•é¦–å…ˆä½¿ç”¨æ˜ å°„å‡½æ•°æ˜ å°„æ¯ä¸ªå…ƒç´ ï¼Œç„¶åå°†ç»“æœå‹ç¼©æˆä¸€ä¸ªæ–°æ•°ç»„ã€‚å®ƒä¸ map å’Œ æ·±åº¦å€¼1 çš„ flat å‡ ä¹ç›¸åŒï¼Œä½† flatMap é€šå¸¸åœ¨åˆå¹¶æˆä¸€ç§æ–¹æ³•çš„æ•ˆç‡ç¨å¾®é«˜ä¸€äº›ã€‚ è¿™é‡Œæˆ‘ä»¬æ‹¿mapæ–¹æ³•ä¸flatMapæ–¹æ³•åšä¸€ä¸ªæ¯”è¾ƒã€‚</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">arr1.map(<span class="function"><span class="params">x</span> =&gt;</span> [x * <span class="number">2</span>]); </span><br><span class="line"><span class="comment">// [[2], [4], [6], [8]]</span></span><br><span class="line"></span><br><span class="line">arr1.flatMap(<span class="function"><span class="params">x</span> =&gt;</span> [x * <span class="number">2</span>]);</span><br><span class="line"><span class="comment">// [2, 4, 6, 8]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åªä¼šå°† flatMap ä¸­çš„å‡½æ•°è¿”å›çš„æ•°ç»„ â€œå‹å¹³â€ ä¸€å±‚</span></span><br><span class="line">arr1.flatMap(<span class="function"><span class="params">x</span> =&gt;</span> [[x * <span class="number">2</span>]]);</span><br><span class="line"><span class="comment">// [[2], [4], [6], [8]]</span></span><br></pre></td></tr></table></figure>

<h3 id="æ–°å¢äº†Stringçš„-trimStart-æ–¹æ³•å’Œ-trimEnd-æ–¹æ³•"><a href="#æ–°å¢äº†Stringçš„-trimStart-æ–¹æ³•å’Œ-trimEnd-æ–¹æ³•" class="headerlink" title="æ–°å¢äº†Stringçš„ trimStart() æ–¹æ³•å’Œ trimEnd() æ–¹æ³•"></a>æ–°å¢äº†Stringçš„ trimStart() æ–¹æ³•å’Œ trimEnd() æ–¹æ³•</h3><p>æ–°å¢çš„è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆå¥½ç†è§£ï¼Œåˆ†åˆ«å»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºç™½å­—ç¬¦ã€‚</p>
<h3 id="Object-fromEntries"><a href="#Object-fromEntries" class="headerlink" title="Object.fromEntries()"></a>Object.fromEntries()</h3><p><code>Object.entries()</code>æ–¹æ³•çš„ä½œç”¨æ˜¯è¿”å›ä¸€ä¸ªç»™å®šå¯¹è±¡è‡ªèº«å¯æšä¸¾å±æ€§çš„é”®å€¼å¯¹æ•°ç»„ï¼Œå…¶æ’åˆ—ä¸ä½¿ç”¨ forâ€¦in å¾ªç¯éå†è¯¥å¯¹è±¡æ—¶è¿”å›çš„é¡ºåºä¸€è‡´ï¼ˆåŒºåˆ«åœ¨äº for-in å¾ªç¯ä¹Ÿæšä¸¾åŸå‹é“¾ä¸­çš„å±æ€§ï¼‰ã€‚</p>
<p><strong>è€Œ<code>Object.fromEntries()</code> åˆ™æ˜¯ <code>Object.entries()</code> çš„åè½¬ã€‚</strong></p>
<p><code>Object.fromEntries()</code> å‡½æ•°ä¼ å…¥ä¸€ä¸ªé”®å€¼å¯¹çš„åˆ—è¡¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¸¦æœ‰è¿™äº›é”®å€¼å¯¹çš„æ–°å¯¹è±¡ã€‚è¿™ä¸ªè¿­ä»£å‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªèƒ½å¤Ÿå®ç°@iteratoræ–¹æ³•çš„çš„å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚å®ƒç”Ÿæˆä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå…ƒç´ çš„ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å°†ç”¨ä½œå±æ€§é”®çš„å€¼ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸è¯¥å±æ€§é”®å…³è”çš„å€¼ã€‚</p>
<ul>
<li>é€šè¿‡ Object.fromEntriesï¼Œ å¯ä»¥å°† Map è½¬åŒ–ä¸º Object:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>([ [<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>], [<span class="string">&#x27;baz&#x27;</span>, <span class="number">42</span>] ]);</span><br><span class="line"><span class="keyword">const</span> obj = <span class="built_in">Object</span>.fromEntries(map);</span><br><span class="line"><span class="built_in">console</span>.log(obj); <span class="comment">// &#123; foo: &quot;bar&quot;, baz: 42 &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ Object.fromEntriesï¼Œ å¯ä»¥å°† Array è½¬åŒ–ä¸º Object:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [ [<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;a&#x27;</span>], [<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;b&#x27;</span>], [<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;c&#x27;</span>] ];</span><br><span class="line"><span class="keyword">const</span> obj = <span class="built_in">Object</span>.fromEntries(arr);</span><br><span class="line"><span class="built_in">console</span>.log(obj); <span class="comment">// &#123; 0: &quot;a&quot;, 1: &quot;b&quot;, 2: &quot;c&quot; &#125;</span></span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure>

<h3 id="Symbol-prototype-description"><a href="#Symbol-prototype-description" class="headerlink" title="Symbol.prototype.description"></a>Symbol.prototype.description</h3><p>é€šè¿‡å·¥å‚å‡½æ•° Symbol() åˆ›å»ºç¬¦å·æ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©é€šè¿‡å‚æ•°æä¾›å­—ç¬¦ä¸²ä½œä¸ºæè¿°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> sym = <span class="built_in">Symbol</span>(<span class="string">&#x27;The description&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>ä»¥å‰ï¼Œè®¿é—®æè¿°çš„å”¯ä¸€æ–¹æ³•æ˜¯å°†ç¬¦å·è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">assert.equal(<span class="built_in">String</span>(sym), <span class="string">&#x27;Symbol(The description)&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å¼•å…¥äº†getter Symbol.prototype.description ä»¥ç›´æ¥è®¿é—®æè¿°ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">assert.equal(sym.description, <span class="string">&#x27;The description&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="String-prototype-matchAll"><a href="#String-prototype-matchAll" class="headerlink" title="String.prototype.matchAll"></a>String.prototype.matchAll</h3><p><code>matchAll()</code> æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼åŠåˆ†ç»„æ•è·ç»“æœçš„è¿­ä»£å™¨ã€‚ åœ¨ matchAll å‡ºç°ä¹‹å‰ï¼Œé€šè¿‡åœ¨å¾ªç¯ä¸­è°ƒç”¨ regexp.exec æ¥è·å–æ‰€æœ‰åŒ¹é…é¡¹ä¿¡æ¯ï¼ˆ regexp éœ€ä½¿ç”¨ /g æ ‡å¿—ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> regexp = <span class="built_in">RegExp</span>(<span class="string">&#x27;foo*&#x27;</span>,<span class="string">&#x27;g&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;table football, foosball&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((matches = regexp.exec(str)) !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Found <span class="subst">$&#123;matches[<span class="number">0</span>]&#125;</span>. Next starts at <span class="subst">$&#123;regexp.lastIndex&#125;</span>.`</span>);</span><br><span class="line">  <span class="comment">// expected output: &quot;Found foo. Next starts at 9.&quot;</span></span><br><span class="line">  <span class="comment">// expected output: &quot;Found foo. Next starts at 19.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨ matchAll ï¼Œå°±å¯ä»¥ä¸å¿…ä½¿ç”¨ while å¾ªç¯åŠ  exec æ–¹å¼ï¼ˆä¸”æ­£åˆ™è¡¨è¾¾å¼éœ€ä½¿ç”¨ï¼gæ ‡å¿—ï¼‰ã€‚ä½¿ç”¨ matchAll ä¼šå¾—åˆ°ä¸€ä¸ªè¿­ä»£å™¨çš„è¿”å›å€¼ï¼Œé…åˆ forâ€¦ofï¼Œarray spreadï¼Œor Array.from() å¯ä»¥æ›´æ–¹ä¾¿å®ç°åŠŸèƒ½ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> regexp = <span class="built_in">RegExp</span>(<span class="string">&#x27;foo*&#x27;</span>,<span class="string">&#x27;g&#x27;</span>); </span><br><span class="line"><span class="keyword">const</span> str = <span class="string">&#x27;table football, foosball&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> matches = str.matchAll(regexp);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> match <span class="keyword">of</span> matches) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(match);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Array [ &quot;foo&quot; ]</span></span><br><span class="line"><span class="comment">// Array [ &quot;foo&quot; ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// matches iterator is exhausted after the for..of iteration</span></span><br><span class="line"><span class="comment">// Call matchAll again to create a new iterator</span></span><br><span class="line">matches = str.matchAll(regexp);</span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span>.from(matches, <span class="function"><span class="params">m</span> =&gt;</span> m[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">// Array [ &quot;foo&quot;, &quot;foo&quot; ]</span></span><br></pre></td></tr></table></figure>

<h4 id="matchAll-å¯ä»¥æ›´å¥½çš„ç”¨äºåˆ†ç»„"><a href="#matchAll-å¯ä»¥æ›´å¥½çš„ç”¨äºåˆ†ç»„" class="headerlink" title="matchAll å¯ä»¥æ›´å¥½çš„ç”¨äºåˆ†ç»„"></a>matchAll å¯ä»¥æ›´å¥½çš„ç”¨äºåˆ†ç»„</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> regexp = <span class="regexp">/t(e)(st(\d?))/g</span>;</span><br><span class="line"><span class="keyword">var</span> str = <span class="string">&#x27;test1test2&#x27;</span>;</span><br><span class="line"></span><br><span class="line">str.match(regexp); </span><br><span class="line"><span class="comment">// Array [&#x27;test1&#x27;, &#x27;test2&#x27;]</span></span><br><span class="line"><span class="keyword">let</span> array = [...str.matchAll(regexp)];</span><br><span class="line"></span><br><span class="line">array[<span class="number">0</span>];</span><br><span class="line"><span class="comment">// [&#x27;test1&#x27;, &#x27;e&#x27;, &#x27;st1&#x27;, &#x27;1&#x27;, index: 0, input: &#x27;test1test2&#x27;, length: 4]</span></span><br><span class="line">array[<span class="number">1</span>];</span><br><span class="line"><span class="comment">// [&#x27;test2&#x27;, &#x27;e&#x27;, &#x27;st2&#x27;, &#x27;2&#x27;, index: 5, input: &#x27;test1test2&#x27;, length: 4]</span></span><br></pre></td></tr></table></figure>

<h3 id="Function-prototype-toString-ç°åœ¨è¿”å›ç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š"><a href="#Function-prototype-toString-ç°åœ¨è¿”å›ç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š" class="headerlink" title="Function.prototype.toString() ç°åœ¨è¿”å›ç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š"></a>Function.prototype.toString() ç°åœ¨è¿”å›ç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> /* <span class="title">comment</span> */ <span class="title">foo</span> /* <span class="title">another</span> <span class="title">comment</span> */(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹‹å‰ä¸ä¼šæ‰“å°æ³¨é‡Šéƒ¨åˆ†</span></span><br><span class="line"><span class="built_in">console</span>.log(foo.toString()); <span class="comment">// function foo()&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ES2019 ä¼šæŠŠæ³¨é‡Šä¸€åŒæ‰“å°</span></span><br><span class="line"><span class="built_in">console</span>.log(foo.toString()); <span class="comment">// function /* comment */ foo /* another comment */ ()&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®­å¤´å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> bar <span class="comment">/* comment */</span> = <span class="comment">/* another comment */</span> <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(bar.toString()); <span class="comment">// () =&gt; &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ä¿®æ”¹-catch-ç»‘å®š"><a href="#ä¿®æ”¹-catch-ç»‘å®š" class="headerlink" title="ä¿®æ”¹ catch ç»‘å®š"></a>ä¿®æ”¹ catch ç»‘å®š</h3><p>åœ¨ ES10 ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡è¯­æ³•ä¸º catch å­å¥ç»‘å®šå¼‚å¸¸å˜é‡ï¼Œæ— è®ºæ˜¯å¦æœ‰å¿…è¦ã€‚å¾ˆå¤šæ—¶å€™ catch å—æ˜¯å¤šä½™çš„ã€‚ ES10 ææ¡ˆä½¿æˆ‘ä»¬èƒ½å¤Ÿç®€å•çš„æŠŠå˜é‡çœç•¥æ‰ã€‚</p>
<p>ä¸ç®—å¤§çš„æ”¹åŠ¨ã€‚</p>
<p>ä¹‹å‰æ˜¯</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;&#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨æ˜¯</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;&#125; <span class="keyword">catch</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ–°çš„åŸºæœ¬æ•°æ®ç±»å‹-BigInt"><a href="#æ–°çš„åŸºæœ¬æ•°æ®ç±»å‹-BigInt" class="headerlink" title="æ–°çš„åŸºæœ¬æ•°æ®ç±»å‹ BigInt"></a>æ–°çš„åŸºæœ¬æ•°æ®ç±»å‹ BigInt</h3><p>ç°åœ¨çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå€¼ç±»å‹ï¼‰ä¸æ­¢5ç§ï¼ˆES6ä¹‹åæ˜¯å…­ç§ï¼‰ï¼ŒåŠ ä¸Š BigInt ä¸€å…±æœ‰ä¸ƒç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ï¼š Stringã€Numberã€Booleanã€Nullã€Undefinedã€Symbolã€BigInt</p>
]]></content>
      <categories>
        <category>å‰ç«¯</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>ECMAScript</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa HibernateåŠ è½½è¿‡ç¨‹ä¸é…ç½®é¡¹</title>
    <url>/2020/11/20/SpringDataJpa%E7%9A%84Hibernate%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E4%B8%8E%E9%85%8D%E7%BD%AE%E9%A1%B9/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-HibernateåŠ è½½è¿‡ç¨‹ä¸é…ç½®é¡¹"><a href="#Spring-Data-Jpa-HibernateåŠ è½½è¿‡ç¨‹ä¸é…ç½®é¡¹" class="headerlink" title="Spring Data Jpa HibernateåŠ è½½è¿‡ç¨‹ä¸é…ç½®é¡¹"></a>Spring Data Jpa HibernateåŠ è½½è¿‡ç¨‹ä¸é…ç½®é¡¹</h1><h2 id="Hibernate-æ¶æ„åˆ†æ"><a href="#Hibernate-æ¶æ„åˆ†æ" class="headerlink" title="Hibernate æ¶æ„åˆ†æ"></a>Hibernate æ¶æ„åˆ†æ</h2><p>é¦–å…ˆçœ‹ä¸€ä¸‹ Hibernate å®˜æ–¹æä¾›çš„æ¶æ„å›¾</p>
<p><img src="http://image.leonote.cn/20201120152718.png" alt=""></p>
<p>ä»æ¶æ„å›¾ä¸Šå¯ä»¥çŸ¥é“ Hibernate å®ç°çš„ ORM çš„æ¥å£æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>Hibernate è‡ªå·±çš„ API æ¥å£</li>
<li>Java Persistence API çš„æ¥å£</li>
</ul>
<p>Hibernate æ¯” Java Persistence API æ—©å‡ å¹´å‘å±•çš„ï¼Œåæ¥æ‰æœ‰äº† Java çš„æŒä¹…åŒ–åè®®ï¼ŒHibernate æ˜¯ Spring Data JPA æŒä¹…åŒ–æ“ä½œçš„æ ¸å¿ƒã€‚</p>
<p>å†ä»ç±»ä¸Šé¢å…·ä½“çœ‹ä¸€ä¸‹ï¼Œå…³é”®ç±»çš„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20201120152958.png" alt=""></p>
<p>ç»“åˆç±»çš„å…³ç³»å›¾æ¥çœ‹ï¼ŒSession æ¥å£å’Œ SessionFactory æ¥å£éƒ½æ˜¯ Hibernate çš„æ¦‚å¿µï¼Œè€Œ EntityManger å’Œ EntityManagerFactory éƒ½æ˜¯ Java Persistence API åè®®è§„å®šçš„æ¥å£ã€‚</p>
<p>ä¸è¿‡ HibernateEntityManger ä» Hibernate 5.2 ä¹‹åå°±å¼€å§‹ä¸æ¨èä½¿ç”¨äº†ï¼Œè€Œæ˜¯å»ºè®®ç›´æ¥ä½¿ç”¨ EntityManager æ¥å£å³å¯ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹ Hibernate åœ¨ Spring BOOT é‡Œé¢æ˜¯å¦‚ä½•è¢«åŠ è½½è¿›å»çš„ã€‚</p>
<h2 id="Hibernate-5-åœ¨-Spring-Boot-2-é‡Œé¢çš„åŠ è½½è¿‡ç¨‹"><a href="#Hibernate-5-åœ¨-Spring-Boot-2-é‡Œé¢çš„åŠ è½½è¿‡ç¨‹" class="headerlink" title="Hibernate 5 åœ¨ Spring Boot 2 é‡Œé¢çš„åŠ è½½è¿‡ç¨‹"></a>Hibernate 5 åœ¨ Spring Boot 2 é‡Œé¢çš„åŠ è½½è¿‡ç¨‹</h2><p>ä¸åŒçš„ Spring Boot ç‰ˆæœ¬ï¼Œå¯èƒ½åŠ è½½ç±»çš„å®ç°é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯åˆ†æè¿‡ç¨‹éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<p>å…ˆæ‰“å¼€ spring.factories æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­å¯ä»¥è‡ªåŠ¨åŠ è½½ Hibernate çš„åªæœ‰ä¸€ä¸ªç±»ï¼Œé‚£å°±æ˜¯ <code>HibernateJpaAutoConfiguration</code>ã€‚</p>
<p><img src="http://image.leonote.cn/20201120153722.png" alt=""></p>
<p><code>HibernateJpaAutoConfiguration</code> å°±æ˜¯ Spring Boot åŠ è½½ Hibernate çš„ä¸»è¦å…¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ‰“å¼€è¿™ä¸ªç±»çœ‹ä¸€ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; LocalContainerEntityManagerFactoryBean.class, EntityManager.class, SessionImplementor.class &#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(JpaProperties.class)</span><span class="comment">//JPAPropertiesçš„é…ç½®</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="meta">@Import(HibernateJpaConfiguration.class)</span> <span class="comment">//hibernateåŠ è½½çš„å…³é”®ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateJpaAutoConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªéœ€è¦å…³æ³¨çš„å°±æ˜¯ JpaProperties ç±»ï¼Œå› ä¸ºé€šè¿‡è¿™ä¸ªç±»å¯ä»¥é—´æ¥çŸ¥é“ï¼Œapplication.properties é‡Œé¢å¯ä»¥é…ç½®çš„ spring.jpa çš„å±æ€§æœ‰å“ªäº›ã€‚</p>
<h3 id="JpaProperties-å±æ€§"><a href="#JpaProperties-å±æ€§" class="headerlink" title="JpaProperties å±æ€§"></a>JpaProperties å±æ€§</h3><p>æ‰“å¼€ JpaProperties ç±»çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20201120153919.png" alt=""></p>
<p>é€šè¿‡è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ application.properties é‡Œé¢å¾—åˆ°å¦‚ä¸‹é…ç½®é¡¹ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯ä»¥é…ç½®JPAçš„å®ç°è€…çš„åŸå§‹å±æ€§çš„é…ç½®ï¼Œå¦‚ï¼šè¿™é‡Œç”¨çš„JPAçš„å®ç°è€…æ˜¯hibernate</span></span><br><span class="line"><span class="comment"># é‚£ä¹ˆhibernateé‡Œé¢çš„ä¸€äº›å±æ€§è®¾ç½®å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®ç°</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.hbm2ddl.auto</span>=<span class="string">none</span></span><br><span class="line"><span class="comment">#hibernateçš„persistence.xmlæ–‡ä»¶æœ‰å“ªäº›ï¼Œç›®å‰å·²ç»ä¸æ¨èä½¿ç”¨</span></span><br><span class="line"><span class="comment">#spring.jpa.mapping-resources=</span></span><br><span class="line"><span class="comment"># æŒ‡å®šæ•°æ®æºçš„ç±»å‹ï¼Œå¦‚æœä¸æŒ‡å®šï¼ŒSpring BootåŠ è½½Datasourceçš„æ—¶å€™ä¼šæ ¹æ®URLçš„åè®®è‡ªå·±åˆ¤æ–­</span></span><br><span class="line"><span class="comment"># å¦‚ï¼šspring.datasource.url=jdbc:mysql://localhost:3306/test ä¸Šé¢å¯ä»¥æ˜ç¡®çŸ¥é“æ˜¯mysqlæ•°æ®æºï¼Œæ‰€ä»¥è¿™ä¸ªå¯ä»¥ä¸éœ€è¦æŒ‡å®šï¼›</span></span><br><span class="line"><span class="comment"># åº”ç”¨åœºæ™¯ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä»£ç†çš„æ–¹å¼ï¼Œå¯èƒ½é€šè¿‡datasource.urlæ²¡åŠæ³•åˆ¤æ–­æ•°æ®æºç±»å‹çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æŒ‡å®šï¼Œå¯é€‰çš„å€¼æœ‰ï¼šDB2,H2,HSQL,INFORMIX,MYSQL,ORACLE,POSTGRESQL,SQL_SERVER,SYBASE)</span></span><br><span class="line"><span class="meta">spring.jpa.database</span>=<span class="string">mysql</span></span><br><span class="line"><span class="comment"># æ˜¯å¦åœ¨å¯åŠ¨é˜¶æ®µæ ¹æ®å®ä½“åˆå§‹åŒ–æ•°æ®åº“çš„schemaï¼Œé»˜è®¤falseï¼Œå½“æˆ‘ä»¬ç”¨å†…å­˜æ•°æ®åº“åšæµ‹è¯•çš„æ—¶å€™å¯ä»¥æ‰“å¼€ï¼Œå¾ˆæœ‰ç”¨</span></span><br><span class="line"><span class="meta">spring.jpa.generate-ddl</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># å’Œspring.jpa.databaseç”¨æ³•å·®ä¸å¤šï¼ŒæŒ‡å®šæ•°æ®åº“çš„å¹³å°ï¼Œé»˜è®¤ä¼šè‡ªå·±å‘ç°ï¼›ä¸€èˆ¬ä¸éœ€è¦æŒ‡å®šï¼Œdatabase-platformæŒ‡å®šçš„å¿…é¡»æ˜¯org.hibernate.dialect.Dialectçš„å­ç±»ï¼Œå¦‚mysqlé»˜è®¤æ˜¯ç”¨ä¸‹é¢çš„platform</span></span><br><span class="line"><span class="meta">spring.jpa.database-platform</span>=<span class="string">org.hibernate.dialect.MySQLInnoDBDialect</span></span><br><span class="line"><span class="comment"># æ˜¯å¦åœ¨viewå±‚æ‰“å¼€sessionï¼Œé»˜è®¤æ˜¯trueï¼Œå…¶å®å¤§éƒ¨åˆ†åœºæ™¯ä¸éœ€è¦æ‰“å¼€ï¼Œå¯ä»¥è®¾ç½®æˆfalseï¼Œ</span></span><br><span class="line"><span class="meta">spring.jpa.open-in-view</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># æ˜¯å¦æ˜¾ç¤ºsqlï¼Œå½“æ‰§è¡ŒJPAçš„æ•°æ®åº“æ“ä½œçš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯falseï¼Œåœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæ‰“å¼€ï¼Œæœ‰åŠ©äºåˆ†æsqlæ˜¯ä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„</span></span><br><span class="line"><span class="comment"># åœ¨ç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™å»ºè®®ç»™è¿™ä¸ªè®¾ç½®æˆfalseï¼Œæ”¹ç”±logging.level.org.hibernate.SQL=DEBUGä»£æ›¿ï¼Œè¿™æ ·çš„è¯æ—¥å¿—é»˜è®¤æ˜¯åŸºäºlogbackè¾“å‡ºçš„</span></span><br><span class="line"><span class="comment"># è€Œä¸æ˜¯ç›´æ¥æ‰“å°åˆ°æ§åˆ¶å°çš„ï¼Œæœ‰åˆ©äºå¢åŠ traceIdå’Œçº¿ç¨‹IDç­‰ä¿¡æ¯ï¼Œä¾¿äºåˆ†æ</span></span><br><span class="line"><span class="meta">spring.jpa.show-sql</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œspring.jpa.show-sql=true è¾“å‡ºçš„ sql æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯å•çº¿ç¨‹çš„ System.out.println çš„æ•ˆæœï¼Œå¦‚æœæ˜¯åœ¨çº¿ä¸Šç¯å¢ƒï¼Œå¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å°±ä¸çŸ¥é“æ˜¯å“ªä¸ªçº¿ç¨‹è¾“å‡ºæ¥çš„ï¼Œè€Œ <code>logging.level.org.hibernate.SQL=DEBUG</code> è¾“å‡ºçš„ sql æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">2020-11-08 16:54:22.275 DEBUG 6589 --- [nio-8087-exec-1] org.hibernate.SQL </span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¯ä»¥è½»æ˜“çŸ¥é“çº¿ç¨‹ ID å’Œæ‰§è¡Œæ—¶é—´ï¼Œç”šè‡³å¯ä»¥æœ‰ tranceID å’Œ spanID è¿›è¡Œæ—¥å¿—è·Ÿè¸ªï¼Œæ–¹ä¾¿åˆ†ææ˜¯å“ªä¸ªçº¿ç¨‹æ‰“å°çš„ã€‚</p>
<h3 id="HibernateJpaConfiguration-åˆ†æ"><a href="#HibernateJpaConfiguration-åˆ†æ" class="headerlink" title="HibernateJpaConfiguration åˆ†æ"></a>HibernateJpaConfiguration åˆ†æ</h3><p>å®ƒæ˜¯é€šè¿‡ HibernateJpaAutoConfiguration é‡Œé¢çš„ <code>@Import(HibernateJpaConfiguration.class)</code> å¯¼å…¥è¿›æ¥åŠ è½½çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(HibernateProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnSingleCandidate(DataSource.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HibernateJpaConfiguration</span> <span class="keyword">extends</span> <span class="title">JpaBaseConfiguration</span> </span>&#123;</span><br><span class="line">...... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æºç å¯ä»¥å¾—åˆ° Hibernate åœ¨ JPA ä¸­é…ç½®çš„ä¸‰ä¸ªé‡è¦çº¿ç´¢</p>
<p><strong>ç¬¬ä¸€ä¸ªçº¿ç´¢ï¼šHibernateProperties è¿™ä¸ªé…ç½®ç±»å¯¹åº”çš„æ˜¯ spring.jpa.hibernate çš„é…ç½®</strong></p>
<p><code>@EnableConfigurationProperties(HibernateProperties.class)</code> å¯ç”¨äº† HibernateProperties çš„é…ç½®ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20201120155250.png" alt=""></p>
<p>å…¶ä¸­å¯ä»¥çœ‹åˆ° application.properties çš„é…ç½®é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># naming çš„ç‰©ç†ç­–ç•¥å€¼æœ‰ï¼šorg.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy(é»˜è®¤)å’Œorg.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.naming.physical-strategy</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># ddlçš„ç”Ÿæˆç­–ç•¥ï¼Œé»˜è®¤noneï¼›å¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šä»»ä½•æ•°æ®æºçš„urlï¼Œé‡‡ç”¨çš„æ˜¯springçš„é›†æˆæ•°æ®æºï¼Œä¹Ÿå°±æ˜¯å†…å­˜æ•°æ®æºH2çš„æ—¶å€™ï¼Œé»˜è®¤å€¼æ˜¯create-drop;</span></span><br><span class="line"><span class="comment"># æ‰€ä»¥å½“æˆ‘ä»¬æ¯æ¬¡ç”¨H2çš„æ—¶å€™ä»€ä¹ˆéƒ½æ²¡åšï¼Œå®ƒå°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºè¡¨ç­‰ï¼Œå†…å­˜æ•°æ®åº“å’Œå†™æµ‹è¯•ç”¨çš„æ—¶å€™ï¼Œcreate-dropå°±éå¸¸æ–¹ä¾¿äº†ï¼›ä¸è¿‡ï¼Œç”Ÿäº§æ•°æ®åº“ä¸€å®šè¦è®¾ç½®æˆnone;</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.ddl-auto</span>=<span class="string">none</span></span><br><span class="line"><span class="comment"># å½“ @Id é…ç½®æˆ @GeneratedValue(strategy= GenerationType.AUTO) çš„æ—¶å€™</span></span><br><span class="line"><span class="comment"># æ˜¯å¦é‡‡ç”¨ hibernate çš„ Id-generator-mappings(å³ä¼šé»˜è®¤å¸®æˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨hibernate_sequenceæ¥å­˜å‚¨å’Œç”ŸæˆID)ï¼Œé»˜è®¤æ˜¯true</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.use-new-id-generator-mappings</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒä¸ªçº¿ç´¢ï¼šHibernateJpaConfiguration çš„çˆ¶ç±» JpaBaseConfiguration ä¹Ÿä¼šä¼˜å…ˆåŠ è½½ï¼Œæ­¤ç±»å°±æ˜¯ Spring Boot åŠ è½½ JPA çš„æ ¸å¿ƒé€»è¾‘</strong></p>
<p>æ‰“å¼€ JpaBaseConfiguration ç±»çœ‹ä¸€ä¸‹æºç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(JpaProperties.class)</span></span><br><span class="line"><span class="comment">// DataSourceInitializedPublisher ç”¨æ¥è¿›è¡Œæ•°æ®æºçš„åˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line"><span class="meta">@Import(DataSourceInitializedPublisher.Registrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JpaBaseConfiguration</span> <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">JpaBaseConfiguration</span><span class="params">(DataSource dataSource, JpaProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">      ObjectProvider&lt;JtaTransactionManager&gt; jtaTransactionManager)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.dataSource = dataSource;</span><br><span class="line">   <span class="keyword">this</span>.properties = properties;</span><br><span class="line">   <span class="comment">//jtaTransactionManager èµ‹å€¼ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬ç”¨ä¸åˆ°ï¼Œä¸€èˆ¬ç”¨æ¥è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯æ‰ä¼šç”¨åˆ°ã€‚</span></span><br><span class="line">   <span class="keyword">this</span>.jtaTransactionManager = jtaTransactionManager.getIfAvailable(); </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŠ è½½ JPA çš„å®ç°æ–¹å¼</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JpaVendorAdapter <span class="title">jpaVendorAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//createJpaVendorAdapter æ˜¯ç”±å­ç±» HibernateJpaConfiguration å®ç°çš„ï¼Œåˆ›å»ºJPAçš„å®ç°ç±»</span></span><br><span class="line">   AbstractJpaVendorAdapter adapter = createJpaVendorAdapter();</span><br><span class="line">   adapter.setShowSql(<span class="keyword">this</span>.properties.isShowSql());</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.properties.getDatabase() != <span class="keyword">null</span>) &#123;</span><br><span class="line">      adapter.setDatabase(<span class="keyword">this</span>.properties.getDatabase());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.properties.getDatabasePlatform() != <span class="keyword">null</span>) &#123;</span><br><span class="line">   adapter.setDatabasePlatform(<span class="keyword">this</span>.properties.getDatabasePlatform());</span><br><span class="line">   &#125;</span><br><span class="line">   adapter.setGenerateDdl(<span class="keyword">this</span>.properties.isGenerateDdl());</span><br><span class="line">   <span class="keyword">return</span> adapter;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Import(DataSourceInitializedPublisher.Registrar.class)</code> æ˜¯ç”¨æ¥åˆå§‹åŒ–æ•°æ®çš„ï¼›ä»æ„é€ å‡½æ•°ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å…¶æ˜¯å¦æœ‰ç”¨åˆ° <code>jtaTransactionManager</code>ï¼ˆè¿™ä¸ªæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡æ‰ä¼šç”¨åˆ°ï¼‰ï¼›è€Œ createJpaVendorAdapter() æ˜¯åœ¨ HibernateJpaConfiguration é‡Œé¢å®ç°çš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HibernateJpaConfiguration</span> <span class="keyword">extends</span> <span class="title">JpaBaseConfiguration</span> </span>&#123;</span><br><span class="line"><span class="comment">//è¿™é‡Œæ˜¯hibernateå’ŒJpaçš„ç»“åˆï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„HibernateJpaVendorAdapterä½œä¸ºJPAçš„å®ç°è€…ï¼Œå¯ä»¥æ‰“å¼€HibernateJpaVendorAdapteré‡Œé¢è®¾ç½®ä¸€äº›æ–­ç‚¹ï¼Œå°±ä¼šçŸ¥é“Spring bootæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥åŠ è½½Hibernateçš„äº†ï¼›</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AbstractJpaVendorAdapter <span class="title">createJpaVendorAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å·²ç»çŸ¥é“äº† HibernateJpaVendorAdapter çš„åŠ è½½é€»è¾‘ï¼Œè€Œ HibernateJpaVendorAdapter é‡Œé¢å®ç°äº† Hibernate çš„åˆå§‹åŒ–é€»è¾‘</p>
<p><strong>ç¬¬ä¸‰ä¸ªçº¿ç´¢ï¼šspring.jpa.properties é…ç½®é¡¹æœ‰å“ªäº›</strong></p>
<p>å¦‚æœæ¥ç€åœ¨ HibernateJpaConfiguration ç±»é‡Œé¢ debug æŸ¥çœ‹å…³é”®ä»£ç çš„è¯ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<p><img src="http://image.leonote.cn/20201120163348.png" alt=""></p>
<p>ä¸Šå›¾ä¸­çš„ä»£ç æ˜¾ç¤ºï¼ŒJpaProperties ç±»é‡Œé¢çš„ properties å±æ€§ï¼Œä¹Ÿå°±æ˜¯ spring.jpa.properties çš„é…ç½®åŠ è½½åˆ°äº† vendorProperties é‡Œé¢ã€‚è€Œ properties é‡Œé¢æ˜¯ HashMap ç»“æ„ï¼Œé‚£ä¹ˆå®ƒéƒ½å¯ä»¥æ”¯æŒå“ªäº›é…ç½®å‘¢ï¼Ÿ</p>
<p>æ‰“å¼€ org.hibernate.cfg.AvailableSettings å¯ä»¥çœ‹åˆ° Hibernate æ”¯æŒçš„é…ç½®é¡¹å¤§æ¦‚æœ‰ 100 å¤šä¸ªé…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">String</span> <span class="string">JPA_PERSISTENCE_PROVIDER = &quot;javax.persistence.provider&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_TRANSACTION_TYPE = &quot;javax.persistence.transactionType&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_JTA_DATASOURCE = &quot;javax.persistence.jtaDataSource&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_NON_JTA_DATASOURCE = &quot;javax.persistence.nonJtaDataSource&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_JDBC_DRIVER = &quot;javax.persistence.jdbc.driver&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_JDBC_URL = &quot;javax.persistence.jdbc.url&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_JDBC_USER = &quot;javax.persistence.jdbc.user&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_JDBC_PASSWORD = &quot;javax.persistence.jdbc.password&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_SHARED_CACHE_MODE = &quot;javax.persistence.sharedCache.mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_SHARED_CACHE_RETRIEVE_MODE =&quot;javax.persistence.cache.retrieveMode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_SHARED_CACHE_STORE_MODE =&quot;javax.persistence.cache.storeMode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_VALIDATION_MODE = &quot;javax.persistence.validation.mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_VALIDATION_FACTORY = &quot;javax.persistence.validation.factory&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_PERSIST_VALIDATION_GROUP = &quot;javax.persistence.validation.group.pre-persist&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_UPDATE_VALIDATION_GROUP = &quot;javax.persistence.validation.group.pre-update&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_REMOVE_VALIDATION_GROUP = &quot;javax.persistence.validation.group.pre-remove&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_LOCK_SCOPE = &quot;javax.persistence.lock.scope&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_LOCK_TIMEOUT = &quot;javax.persistence.lock.timeout&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CDI_BEAN_MANAGER = &quot;javax.persistence.bean.manager&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CLASSLOADERS = &quot;hibernate.classLoaders&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">TC_CLASSLOADER = &quot;hibernate.classLoader.tccl_lookup_precedence&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">APP_CLASSLOADER = &quot;hibernate.classLoader.application&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">RESOURCES_CLASSLOADER = &quot;hibernate.classLoader.resources&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HIBERNATE_CLASSLOADER = &quot;hibernate.classLoader.hibernate&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ENVIRONMENT_CLASSLOADER = &quot;hibernate.classLoader.environment&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_METAMODEL_GENERATION = &quot;hibernate.ejb.metamodel.generation&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_METAMODEL_POPULATION = &quot;hibernate.ejb.metamodel.population&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">STATIC_METAMODEL_POPULATION = &quot;hibernate.jpa.static_metamodel.population&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CONNECTION_PROVIDER =&quot;hibernate.connection.provider_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DRIVER =&quot;hibernate.connection.driver_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">URL =&quot;hibernate.connection.url&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USER =&quot;hibernate.connection.username&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PASS =&quot;hibernate.connection.password&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ISOLATION =&quot;hibernate.connection.isolation&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">AUTOCOMMIT = &quot;hibernate.connection.autocommit&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">POOL_SIZE =&quot;hibernate.connection.pool_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DATASOURCE =&quot;hibernate.connection.datasource&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CONNECTION_PROVIDER_DISABLES_AUTOCOMMIT= &quot;hibernate.connection.provider_disables_autocommit&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CONNECTION_PREFIX = &quot;hibernate.connection&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JNDI_CLASS =&quot;hibernate.jndi.class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JNDI_URL =&quot;hibernate.jndi.url&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JNDI_PREFIX = &quot;hibernate.jndi&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DIALECT =&quot;hibernate.dialect&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DIALECT_RESOLVERS = &quot;hibernate.dialect_resolvers&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">STORAGE_ENGINE = &quot;hibernate.dialect.storage_engine&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SCHEMA_MANAGEMENT_TOOL = &quot;hibernate.schema_management_tool&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">TRANSACTION_COORDINATOR_STRATEGY = &quot;hibernate.transaction.coordinator_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JTA_PLATFORM = &quot;hibernate.transaction.jta.platform&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PREFER_USER_TRANSACTION = &quot;hibernate.jta.prefer_user_transaction&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JTA_PLATFORM_RESOLVER = &quot;hibernate.transaction.jta.platform_resolver&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JTA_CACHE_TM = &quot;hibernate.jta.cacheTransactionManager&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JTA_CACHE_UT = &quot;hibernate.jta.cacheUserTransaction&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JDBC_TYLE_PARAMS_ZERO_BASE = &quot;hibernate.query.sql.jdbc_style_params_base&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEFAULT_CATALOG = &quot;hibernate.default_catalog&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEFAULT_SCHEMA = &quot;hibernate.default_schema&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEFAULT_CACHE_CONCURRENCY_STRATEGY = &quot;hibernate.cache.default_cache_concurrency_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_NEW_ID_GENERATOR_MAPPINGS = &quot;hibernate.id.new_generator_mappings&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">FORCE_DISCRIMINATOR_IN_SELECTS_BY_DEFAULT = &quot;hibernate.discriminator.force_in_select&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">IMPLICIT_DISCRIMINATOR_COLUMNS_FOR_JOINED_SUBCLASS = &quot;hibernate.discriminator.implicit_for_joined&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">IGNORE_EXPLICIT_DISCRIMINATOR_COLUMNS_FOR_JOINED_SUBCLASS = &quot;hibernate.discriminator.ignore_explicit_for_joined&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_NATIONALIZED_CHARACTER_DATA = &quot;hibernate.use_nationalized_character_data&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SCANNER_DEPRECATED = &quot;hibernate.ejb.resource_scanner&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SCANNER = &quot;hibernate.archive.scanner&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SCANNER_ARCHIVE_INTERPRETER = &quot;hibernate.archive.interpreter&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SCANNER_DISCOVERY = &quot;hibernate.archive.autodetection&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">IMPLICIT_NAMING_STRATEGY = &quot;hibernate.implicit_naming_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PHYSICAL_NAMING_STRATEGY = &quot;hibernate.physical_naming_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ARTIFACT_PROCESSING_ORDER = &quot;hibernate.mapping.precedence&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">KEYWORD_AUTO_QUOTING_ENABLED = &quot;hibernate.auto_quote_keyword&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">XML_MAPPING_ENABLED = &quot;hibernate.xml_mapping_enabled&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SESSION_FACTORY_NAME = &quot;hibernate.session_factory_name&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SESSION_FACTORY_NAME_IS_JNDI = &quot;hibernate.session_factory_name_is_jndi&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SHOW_SQL =&quot;hibernate.show_sql&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">FORMAT_SQL =&quot;hibernate.format_sql&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_SQL_COMMENTS =&quot;hibernate.use_sql_comments&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">MAX_FETCH_DEPTH = &quot;hibernate.max_fetch_depth&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEFAULT_BATCH_FETCH_SIZE = &quot;hibernate.default_batch_fetch_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_STREAMS_FOR_BINARY = &quot;hibernate.jdbc.use_streams_for_binary&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_SCROLLABLE_RESULTSET = &quot;hibernate.jdbc.use_scrollable_resultset&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_GET_GENERATED_KEYS = &quot;hibernate.jdbc.use_get_generated_keys&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">STATEMENT_FETCH_SIZE = &quot;hibernate.jdbc.fetch_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">STATEMENT_BATCH_SIZE = &quot;hibernate.jdbc.batch_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">BATCH_STRATEGY = &quot;hibernate.jdbc.factory_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">BATCH_VERSIONED_DATA = &quot;hibernate.jdbc.batch_versioned_data&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JDBC_TIME_ZONE = &quot;hibernate.jdbc.time_zone&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">AUTO_CLOSE_SESSION = &quot;hibernate.transaction.auto_close_session&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">FLUSH_BEFORE_COMPLETION = &quot;hibernate.transaction.flush_before_completion&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ACQUIRE_CONNECTIONS = &quot;hibernate.connection.acquisition_mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">RELEASE_CONNECTIONS = &quot;hibernate.connection.release_mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CONNECTION_HANDLING = &quot;hibernate.connection.handling_mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CURRENT_SESSION_CONTEXT_CLASS = &quot;hibernate.current_session_context_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_IDENTIFIER_ROLLBACK = &quot;hibernate.use_identifier_rollback&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_REFLECTION_OPTIMIZER = &quot;hibernate.bytecode.use_reflection_optimizer&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ENFORCE_LEGACY_PROXY_CLASSNAMES = &quot;hibernate.bytecode.enforce_legacy_proxy_classnames&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ALLOW_ENHANCEMENT_AS_PROXY = &quot;hibernate.bytecode.allow_enhancement_as_proxy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_TRANSLATOR = &quot;hibernate.query.factory_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_SUBSTITUTIONS = &quot;hibernate.query.substitutions&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_STARTUP_CHECKING = &quot;hibernate.query.startup_check&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CONVENTIONAL_JAVA_CONSTANTS = &quot;hibernate.query.conventional_java_constants&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SQL_EXCEPTION_CONVERTER = &quot;hibernate.jdbc.sql_exception_converter&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">WRAP_RESULT_SETS = &quot;hibernate.jdbc.wrap_result_sets&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">NATIVE_EXCEPTION_HANDLING_51_COMPLIANCE = &quot;hibernate.native_exception_handling_51_compliance&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ORDER_UPDATES = &quot;hibernate.order_updates&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ORDER_INSERTS = &quot;hibernate.order_inserts&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_CALLBACKS_ENABLED = &quot;hibernate.jpa_callbacks.enabled&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEFAULT_NULL_ORDERING = &quot;hibernate.order_by.default_null_ordering&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">LOG_JDBC_WARNINGS =  &quot;hibernate.jdbc.log.warnings&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">BEAN_CONTAINER = &quot;hibernate.resource.beans.container&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_CONFIG_PREFIX = &quot;hibernate.c3p0&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_MAX_SIZE = &quot;hibernate.c3p0.max_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_MIN_SIZE = &quot;hibernate.c3p0.min_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_TIMEOUT = &quot;hibernate.c3p0.timeout&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_MAX_STATEMENTS = &quot;hibernate.c3p0.max_statements&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_ACQUIRE_INCREMENT = &quot;hibernate.c3p0.acquire_increment&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">C3P0_IDLE_TEST_PERIOD = &quot;hibernate.c3p0.idle_test_period&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROXOOL_CONFIG_PREFIX = &quot;hibernate.proxool&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROXOOL_PREFIX = PROXOOL_CONFIG_PREFIX;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROXOOL_XML = &quot;hibernate.proxool.xml&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROXOOL_PROPERTIES = &quot;hibernate.proxool.properties&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROXOOL_EXISTING_POOL = &quot;hibernate.proxool.existing_pool&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROXOOL_POOL_ALIAS = &quot;hibernate.proxool.pool_alias&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CACHE_REGION_FACTORY = &quot;hibernate.cache.region.factory_class&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CACHE_KEYS_FACTORY = &quot;hibernate.cache.keys_factory&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CACHE_PROVIDER_CONFIG = &quot;hibernate.cache.provider_configuration_file_resource_path&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_SECOND_LEVEL_CACHE = &quot;hibernate.cache.use_second_level_cache&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_QUERY_CACHE = &quot;hibernate.cache.use_query_cache&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_CACHE_FACTORY = &quot;hibernate.cache.query_cache_factory&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CACHE_REGION_PREFIX = &quot;hibernate.cache.region_prefix&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_MINIMAL_PUTS = &quot;hibernate.cache.use_minimal_puts&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_STRUCTURED_CACHE = &quot;hibernate.cache.use_structured_entries&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">AUTO_EVICT_COLLECTION_CACHE = &quot;hibernate.cache.auto_evict_collection_cache&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_DIRECT_REFERENCE_CACHE_ENTRIES = &quot;hibernate.cache.use_reference_entries&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEFAULT_ENTITY_MODE = &quot;hibernate.default_entity_mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">GLOBALLY_QUOTED_IDENTIFIERS = &quot;hibernate.globally_quoted_identifiers&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">GLOBALLY_QUOTED_IDENTIFIERS_SKIP_COLUMN_DEFINITIONS = &quot;hibernate.globally_quoted_identifiers_skip_column_definitions&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CHECK_NULLABILITY = &quot;hibernate.check_nullability&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">BYTECODE_PROVIDER = &quot;hibernate.bytecode.provider&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPAQL_STRICT_COMPLIANCE= &quot;hibernate.query.jpaql_strict_compliance&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PREFER_POOLED_VALUES_LO = &quot;hibernate.id.optimizer.pooled.prefer_lo&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PREFERRED_POOLED_OPTIMIZER = &quot;hibernate.id.optimizer.pooled.preferred&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_PLAN_CACHE_MAX_STRONG_REFERENCES = &quot;hibernate.query.plan_cache_max_strong_references&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_PLAN_CACHE_MAX_SOFT_REFERENCES = &quot;hibernate.query.plan_cache_max_soft_references&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_PLAN_CACHE_MAX_SIZE = &quot;hibernate.query.plan_cache_max_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_PLAN_CACHE_PARAMETER_METADATA_MAX_SIZE = &quot;hibernate.query.plan_parameter_metadata_max_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">NON_CONTEXTUAL_LOB_CREATION = &quot;hibernate.jdbc.lob.non_contextual_creation&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_AUTO = &quot;hibernate.hbm2ddl.auto&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DATABASE_ACTION = &quot;javax.persistence.schema-generation.database.action&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_SCRIPTS_ACTION = &quot;javax.persistence.schema-generation.scripts.action&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_CONNECTION = &quot;javax.persistence.schema-generation-connection&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DB_NAME = &quot;javax.persistence.database-product-name&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DB_MAJOR_VERSION = &quot;javax.persistence.database-major-version&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DB_MINOR_VERSION = &quot;javax.persistence.database-minor-version&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_CREATE_SOURCE = &quot;javax.persistence.schema-generation.create-source&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DROP_SOURCE = &quot;javax.persistence.schema-generation.drop-source&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_CREATE_SCRIPT_SOURCE = &quot;javax.persistence.schema-generation.create-script-source&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DROP_SCRIPT_SOURCE = &quot;javax.persistence.schema-generation.drop-script-source&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_SCRIPTS_CREATE_TARGET = &quot;javax.persistence.schema-generation.scripts.create-target&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_SCRIPTS_DROP_TARGET = &quot;javax.persistence.schema-generation.scripts.drop-target&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_IMPORT_FILES = &quot;hibernate.hbm2ddl.import_files&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_LOAD_SCRIPT_SOURCE = &quot;javax.persistence.sql-load-script-source&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_IMPORT_FILES_SQL_EXTRACTOR = &quot;hibernate.hbm2ddl.import_files_sql_extractor&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_CREATE_NAMESPACES = &quot;hibernate.hbm2ddl.create_namespaces&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DLL_CREATE_NAMESPACES = &quot;hibernate.hbm2dll.create_namespaces&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_CREATE_SCHEMAS = &quot;javax.persistence.create-database-schemas&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DLL_CREATE_SCHEMAS = HBM2DDL_CREATE_SCHEMAS;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_FILTER_PROVIDER = &quot;hibernate.hbm2ddl.schema_filter_provider&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_JDBC_METADATA_EXTRACTOR_STRATEGY = &quot;hibernate.hbm2ddl.jdbc_metadata_extraction_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_DELIMITER = &quot;hibernate.hbm2ddl.delimiter&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_CHARSET_NAME = &quot;hibernate.hbm2ddl.charset_name&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HBM2DDL_HALT_ON_ERROR = &quot;hibernate.hbm2ddl.halt_on_error&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JMX_ENABLED = &quot;hibernate.jmx.enabled&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JMX_PLATFORM_SERVER = &quot;hibernate.jmx.usePlatformServer&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JMX_AGENT_ID = &quot;hibernate.jmx.agentId&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JMX_DOMAIN_NAME = &quot;hibernate.jmx.defaultDomain&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JMX_SF_NAME = &quot;hibernate.jmx.sessionFactoryName&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JMX_DEFAULT_OBJ_NAME_DOMAIN = &quot;org.hibernate.core&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CUSTOM_ENTITY_DIRTINESS_STRATEGY = &quot;hibernate.entity_dirtiness_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_ENTITY_WHERE_CLAUSE_FOR_COLLECTIONS = &quot;hibernate.use_entity_where_clause_for_collections&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">MULTI_TENANT = &quot;hibernate.multiTenancy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">MULTI_TENANT_CONNECTION_PROVIDER = &quot;hibernate.multi_tenant_connection_provider&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">MULTI_TENANT_IDENTIFIER_RESOLVER = &quot;hibernate.tenant_identifier_resolver&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">INTERCEPTOR = &quot;hibernate.session_factory.interceptor&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SESSION_SCOPED_INTERCEPTOR = &quot;hibernate.session_factory.session_scoped_interceptor&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">STATEMENT_INSPECTOR = &quot;hibernate.session_factory.statement_inspector&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ENABLE_LAZY_LOAD_NO_TRANS = &quot;hibernate.enable_lazy_load_no_trans&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">HQL_BULK_ID_STRATEGY = &quot;hibernate.hql.bulk_id_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">BATCH_FETCH_STYLE = &quot;hibernate.batch_fetch_style&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DELAY_ENTITY_LOADER_CREATIONS = &quot;hibernate.loader.delay_entity_loader_creations&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JTA_TRACK_BY_THREAD = &quot;hibernate.jta.track_by_thread&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JACC_CONTEXT_ID = &quot;hibernate.jacc_context_id&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JACC_PREFIX = &quot;hibernate.jacc&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JACC_ENABLED = &quot;hibernate.jacc.enabled&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ENABLE_SYNONYMS = &quot;hibernate.synonyms&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">EXTRA_PHYSICAL_TABLE_TYPES = &quot;hibernate.hbm2ddl.extra_physical_table_types&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">DEPRECATED_EXTRA_PHYSICAL_TABLE_TYPES = &quot;hibernate.hbm2dll.extra_physical_table_types&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">UNIQUE_CONSTRAINT_SCHEMA_UPDATE_STRATEGY = &quot;hibernate.schema_update.unique_constraint_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">GENERATE_STATISTICS = &quot;hibernate.generate_statistics&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">LOG_SESSION_METRICS = &quot;hibernate.session.events.log&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">LOG_SLOW_QUERY = &quot;hibernate.session.events.log.LOG_QUERIES_SLOWER_THAN_MS&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">AUTO_SESSION_EVENTS_LISTENER = &quot;hibernate.session.events.auto&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PROCEDURE_NULL_PARAM_PASSING = &quot;hibernate.proc.param_null_passing&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CREATE_EMPTY_COMPOSITES_ENABLED = &quot;hibernate.create_empty_composites.enabled&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ALLOW_JTA_TRANSACTION_ACCESS = &quot;hibernate.jta.allowTransactionAccess&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ALLOW_UPDATE_OUTSIDE_TRANSACTION = &quot;hibernate.allow_update_outside_transaction&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">COLLECTION_JOIN_SUBQUERY = &quot;hibernate.collection_join_subquery&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">ALLOW_REFRESH_DETACHED_ENTITY = &quot;hibernate.allow_refresh_detached_entity&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">MERGE_ENTITY_COPY_OBSERVER = &quot;hibernate.event.merge.entity_copy_observer&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">USE_LEGACY_LIMIT_HANDLERS = &quot;hibernate.legacy_limit_handler&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">VALIDATE_QUERY_PARAMETERS = &quot;hibernate.query.validate_parameters&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">CRITERIA_LITERAL_HANDLING_MODE = &quot;hibernate.criteria.literal_handling_mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">PREFER_GENERATOR_NAME_AS_DEFAULT_SEQUENCE_NAME = &quot;hibernate.model.generator_name_as_sequence_name&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_TRANSACTION_COMPLIANCE = &quot;hibernate.jpa.compliance.transaction&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_QUERY_COMPLIANCE = &quot;hibernate.jpa.compliance.query&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_LIST_COMPLIANCE = &quot;hibernate.jpa.compliance.list&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_CLOSED_COMPLIANCE = &quot;hibernate.jpa.compliance.closed&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_PROXY_COMPLIANCE = &quot;hibernate.jpa.compliance.proxy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_CACHING_COMPLIANCE = &quot;hibernate.jpa.compliance.caching&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">JPA_ID_GENERATOR_GLOBAL_SCOPE_COMPLIANCE = &quot;hibernate.jpa.compliance.global_id_generators&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">TABLE_GENERATOR_STORE_LAST_USED = &quot;hibernate.id.generator.stored_last_used&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">FAIL_ON_PAGINATION_OVER_COLLECTION_FETCH = &quot;hibernate.query.fail_on_pagination_over_collection_fetch&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">IMMUTABLE_ENTITY_UPDATE_QUERY_HANDLING_MODE = &quot;hibernate.query.immutable_entity_update_query_handling_mode&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">IN_CLAUSE_PARAMETER_PADDING = &quot;hibernate.query.in_clause_parameter_padding&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">QUERY_STATISTICS_MAX_SIZE = &quot;hibernate.statistics.query_max_size&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">SEQUENCE_INCREMENT_SIZE_MISMATCH_STRATEGY = &quot;hibernate.id.sequence.increment_size_mismatch_strategy&quot;;</span></span><br><span class="line"><span class="attr">String</span> <span class="string">OMIT_JOIN_OF_SUPERCLASS_TABLES = &quot;hibernate.query.omit_join_of_superclass_tables&quot;;</span></span><br></pre></td></tr></table></figure>

<h3 id="AvailableSettings-é‡Œé¢çš„é…ç½®é¡¹çš„ç”¨æ³•"><a href="#AvailableSettings-é‡Œé¢çš„é…ç½®é¡¹çš„ç”¨æ³•" class="headerlink" title="AvailableSettings é‡Œé¢çš„é…ç½®é¡¹çš„ç”¨æ³•"></a>AvailableSettings é‡Œé¢çš„é…ç½®é¡¹çš„ç”¨æ³•</h3><p>åªéœ€è¦å°† AvailableSettings å˜é‡çš„å€¼æ”¾åˆ° spring.jpa.properties é‡Œé¢å³å¯ï¼Œå¦‚ä¸‹è¿™äº›æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">##å¼€å¯hibernate statisticsçš„ä¿¡æ¯ï¼Œå¦‚sessionã€è¿æ¥ç­‰æ—¥å¿—ï¼š</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.generate_statistics</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># æ ¼å¼åŒ– SQL</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.format_sql</span>: <span class="string">true</span></span><br><span class="line"><span class="comment"># æ˜¾ç¤º SQL</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.show_sql</span>: <span class="string">true</span></span><br><span class="line"><span class="comment"># æ·»åŠ  HQL ç›¸å…³çš„æ³¨é‡Šä¿¡æ¯</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.use_sql_comments</span>: <span class="string">true</span></span><br><span class="line"><span class="comment"># hbm2ddlçš„ç­–ç•¥ validate, update, create, create-drop, noneï¼Œå»ºè®®é…ç½®æˆvalidateï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™æ ·åœ¨æˆ‘ä»¬å¯åŠ¨é¡¹ç›®çš„æ—¶å€™å°±çŸ¥é“ç”Ÿäº§æ•°æ®åº“çš„è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®çš„äº†ï¼Œè€Œä¸ç”¨ç­‰åˆ°è¿è¡ŒæœŸé—´æ‰å‘ç°é—®é¢˜ã€‚</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.hbm2ddl.auto</span>=<span class="string">validate</span></span><br><span class="line"><span class="comment"># å…³è”å…³ç³»çš„æ—¶å€™å–æ•°æ®çš„æ·±åº¦ï¼Œé»˜è®¤æ˜¯3å±‚ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æˆ2çº§ï¼Œé˜²æ­¢å…¶ä»–å¼€å‘ä¹±ç”¨ï¼Œæé«˜sqlæ€§èƒ½</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.max_fetch_depth</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"># æ‰¹é‡fetchå¤§å°é»˜è®¤ -1</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.default_batch_fetch_size</span>= <span class="string">100</span></span><br><span class="line"><span class="comment"># äº‹åŠ¡å®Œæˆä¹‹å‰æ˜¯å¦è¿›è¡Œflushæ“ä½œï¼Œå³åŒæ­¥åˆ°dbé‡Œé¢å»ï¼Œé»˜è®¤æ˜¯true</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.transaction.flush_before_completion</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># äº‹åŠ¡ç»“æŸä¹‹åæ˜¯å¦å…³é—­sessionï¼Œé»˜è®¤false</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.transaction.auto_close_session</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># æœ‰çš„æ—¶å€™ä¸åªè¦æ‰¹é‡æŸ¥è¯¢ï¼Œä¹Ÿä¼šæ‰¹é‡æ›´æ–°ï¼Œé»˜è®¤batch sizeæ˜¯15ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè‡ªç”±è°ƒæ•´ï¼Œå¯ä»¥æé«˜æ‰¹é‡æ›´æ–°çš„æ•ˆç‡ï¼›</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.jdbc.batch_size</span>=<span class="string">100</span></span><br></pre></td></tr></table></figure>

<h3 id="è‡ªåŠ¨åŠ è½½è¿‡ç¨‹ç±»ä¹‹é—´çš„å…³ç³»å›¾"><a href="#è‡ªåŠ¨åŠ è½½è¿‡ç¨‹ç±»ä¹‹é—´çš„å…³ç³»å›¾" class="headerlink" title="è‡ªåŠ¨åŠ è½½è¿‡ç¨‹ç±»ä¹‹é—´çš„å…³ç³»å›¾"></a>è‡ªåŠ¨åŠ è½½è¿‡ç¨‹ç±»ä¹‹é—´çš„å…³ç³»å›¾</h3><p><img src="http://image.leonote.cn/20201120164350.png" alt=""></p>
<p>ä»ä¸Šå›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºä»¥ä¸‹å‡ ç‚¹å†…å®¹ã€‚</p>
<ol>
<li><code>JpaBaseConfiguration</code> æ˜¯ Jpa å’Œ Hibernate è¢«åŠ è½½çš„åŸºçŸ³ï¼Œé‡Œé¢é€šè¿‡ <code>BeanFactoryAware</code> çš„æ¥å£çš„ bean åŠ è½½ç”Ÿå‘½å‘¨æœŸä¹Ÿå®ç°äº†ä¸€äº›é€»è¾‘ã€‚</li>
<li><code>HibernateJpaConfiguration</code> æ˜¯ JpaBaseConfiguration çš„å­ç±»ï¼Œè¦†ç›–äº†ä¸€äº›çˆ¶ç±»é‡Œé¢çš„é…ç½®ç›¸å…³çš„ç‰¹æ®Šé€»è¾‘ï¼Œå¹¶ä¸”é‡Œé¢å¼•ç”¨äº† <code>JpaPropeties</code> å’Œ <code>HibernateProperties</code> çš„é…ç½®é¡¹ã€‚</li>
<li><code>HibernateJpaAutoConfiguration</code> æ˜¯ Spring Boot è‡ªåŠ¨åŠ è½½ HibernateJpaConfiguration çš„æ¡¥æ¢ï¼Œèµ·åˆ°äº†å¯¼å…¥å’ŒåŠ è½½ HibernateJpaConfiguration çš„ä½œç”¨ã€‚</li>
<li><code>JpaRepositoriesAutoConfiguration</code> å’Œ <code>HibernateJpaAutoConfiguration</code>ã€<code>DataSourceAutoConfiguration</code> åˆ†åˆ«åŠ è½½ JpaRepositories çš„é€»è¾‘å’Œ Hibernate/JPAã€æ•°æ®æºï¼Œéƒ½æ˜¯è¢« spring.factories è‡ªåŠ¨è£…é…è¿›å…¥åˆ° Spring Boot é‡Œé¢çš„ï¼Œè€Œä¸‰è€…ä¹‹é—´æœ‰åŠ è½½çš„å…ˆåé¡ºåºã€‚</li>
<li>ä¸Šå›¾çš„ UML è¿˜å±•ç¤ºäº†å‡ ä¸ª Configuration ç±»çš„åŠ è½½é¡ºåºå’Œä¾èµ–å…³ç³»ï¼Œé¡ºåºæ˜¯ä»ä¸Šåˆ°ä¸‹è¿›è¡ŒåŠ è½½çš„<ul>
<li>DataSourceAutoConfiguration æœ€å…ˆåŠ è½½</li>
<li>HibernateJpaAutoConfiguration ç¬¬äºŒé¡ºåºåŠ è½½</li>
<li>JpaRepositoriesAutoConfiguration æœ€ååŠ è½½</li>
</ul>
</li>
</ol>
<h2 id="Spring-Data-JPA-Repositories-Bootstrap-Mode"><a href="#Spring-Data-JPA-Repositories-Bootstrap-Mode" class="headerlink" title="Spring Data JPA Repositories Bootstrap Mode"></a>Spring Data JPA Repositories Bootstrap Mode</h2><p>äº†è§£å®Œäº† Hibernate åœ¨ Spring Boot é‡Œé¢çš„åŠ è½½è¿‡ç¨‹ï¼Œé‚£ä¹ˆæ¥çœ‹ä¸‹ JpaRepositoriesAutoConfiguration çš„ä¸»è¦ä½œç”¨æœ‰å“ªäº›ï¼Ÿ</p>
<p>é€šè¿‡ä¸Šé¢åˆ†äº«çš„æ•´ä¸ªåŠ è½½è¿‡ç¨‹å¯ä»¥å‘ç°ï¼š</p>
<ul>
<li>DataSourceAutoConfiguration å®Œæˆäº†æ•°æ®æºçš„åŠ è½½</li>
<li>HibernateJpaAutoConfiguration å®Œæˆäº† Hibernate çš„åŠ è½½è¿‡ç¨‹</li>
<li>JpaRepositoriesAutoConfiguration å®Œæˆäº†å„ç§ JpaRepositories çš„åŠ è½½è¿‡ç¨‹ï¼Œè¿™æ˜¯ Spring Data JPA çš„ä¸»è¦å®ç°é€»è¾‘ï¼Œå’Œ Hibernateã€æ•°æ®æºæ²¡ä»€ä¹ˆå…³ç³»ã€‚</li>
</ul>
<p>å¯ä»¥é€šè¿‡ <code>JpaRepositoriesAutoConfiguration</code> çš„æºç å‘ç°å…¶ä¸»è¦èŒè´£å’Œå®ç°æ–¹å¼ï¼Œåˆ©ç”¨å¼‚æ­¥çº¿ç¨‹æ± åˆå§‹åŒ– repositoriesï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š</p>
<p><img src="http://image.leonote.cn/20201120165726.png" alt=""></p>
<p>è€Œå…¶ä¸­åŠ è½½ repositories æœ‰ä¸‰ç§æ–¹å¼ï¼Œå³ <code>spring.data.jpa.repositories.bootstrap-mode</code> çš„ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«ä¸º <strong>deferred</strong>ã€ <strong>lazy</strong>ã€ <strong>default</strong></p>
<ul>
<li><strong>deferred</strong>ï¼šæ˜¯é»˜è®¤å€¼ï¼Œè¡¨ç¤ºåœ¨<strong>å¯åŠ¨çš„æ—¶å€™ä¼šè¿›è¡Œæ•°æ®åº“å­—æ®µçš„æ£€æŸ¥</strong>ï¼Œè€Œ repositories ç›¸å…³çš„å®ä¾‹çš„åˆå§‹åŒ–æ˜¯ lazy æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨åˆ° repositories å®ä¾‹çš„æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™ä¸ª<strong>æ¯”è¾ƒé€‚åˆç”¨åœ¨æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒ</strong>ä¸­ï¼Œå› ä¸ºæµ‹è¯•ä¸å¯èƒ½è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œä¸‡ä¸€è°å¤šåŠ ä¸ªå­—æ®µæˆ–è€…å°‘ä¸€ä¸ªå­—æ®µï¼Œè¿™æ ·åœ¨å¯åŠ¨çš„é˜¶æ®µå°±å¯ä»¥åŠæ—¶å‘ç°é—®é¢˜ï¼Œä¸èƒ½ç­‰è¿›è¡Œåˆ°ç”Ÿäº§ç¯å¢ƒæ‰æš´éœ²ã€‚</li>
<li><strong>lazy</strong>ï¼š<strong>è¡¨ç¤ºå¯åŠ¨é˜¶æ®µä¸ä¼šè¿›è¡Œæ•°æ®åº“å­—æ®µçš„æ£€æŸ¥ï¼Œä¹Ÿä¸ä¼šåˆå§‹åŒ– repositories ç›¸å…³çš„å®ä¾‹</strong>ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨åˆ° repositories å®ä¾‹çš„æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™ä¸ª<strong>æ¯”è¾ƒé€‚åˆç”¨åœ¨å¼€å‘çš„é˜¶æ®µï¼Œå¯ä»¥åŠ å¿«åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦</strong>ã€‚å¦‚æœç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†æé«˜ä¸šåŠ¡é«˜å³°æœŸé—´æ°´å¹³æ¥æ‰©å±•åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚</li>
<li><strong>default</strong>ï¼šé»˜è®¤åŠ è½½æ–¹å¼ï¼Œä½†ä» Spring Boot 2.0 ä¹‹åå°±ä¸æ˜¯é»˜è®¤å€¼äº†ï¼Œè¡¨ç¤º<strong>ç«‹å³éªŒè¯ã€ç«‹å³åˆå§‹åŒ– repositories å®ä¾‹</strong>ï¼Œè¿™ç§æ–¹å¼å¯åŠ¨çš„é€Ÿåº¦æœ€æ…¢ï¼Œä½†æ˜¯æœ€ä¿é™©ï¼Œ<strong>è¿è¡ŒæœŸé—´çš„è¯·æ±‚æœ€å¿«</strong>ï¼Œå› ä¸ºé¿å…äº†ç¬¬ä¸€æ¬¡è¯·æ±‚åˆå§‹åŒ– repositories å®ä¾‹çš„è¿‡ç¨‹ã€‚</li>
</ul>
<p>æˆ‘ä»¬é€šè¿‡åœ¨ application.properties é‡Œé¢ä¿®æ”¹è¿™ä¸€è¡Œä»£ç ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ lazy çš„åŠ è½½æ–¹å¼ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.data.jpa.repositories.bootstrap-mode</span>=<span class="string">lazy</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯åŠ¨é¡¹ç›®ï¼Œå°±ä¼šå‘ç°åœ¨ tomcat å®¹å™¨åŠ è½½å®Œä¹‹åï¼Œæ²¡æœ‰ç”¨åˆ° UserInfoRepository ä¹‹å‰ï¼Œè¿™ä¸ª UserInfoRepository æ˜¯ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–çš„ã€‚è€Œå½“æˆ‘ä»¬å‘ä¸€ä¸ªè¯·æ±‚ç”¨åˆ°äº† UserInfoRepositoryï¼Œå°±è¿›è¡Œäº†åˆå§‹åŒ–ã€‚</p>
<p>é€šè¿‡æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨çš„çº¿ç¨‹å’Œåˆå§‹åŒ–çš„çº¿ç¨‹æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œåˆå§‹åŒ–çš„çº¿ç¨‹æ˜¯ NIO çº¿ç¨‹çš„åå­—ï¼Œè¡¨ç¤º request çš„ http çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20201120170349.png" alt=""></p>
<h2 id="Debug-æ—¶å€™ï¼Œæ—¥å¿—çš„é…ç½®"><a href="#Debug-æ—¶å€™ï¼Œæ—¥å¿—çš„é…ç½®" class="headerlink" title="Debug æ—¶å€™ï¼Œæ—¥å¿—çš„é…ç½®"></a>Debug æ—¶å€™ï¼Œæ—¥å¿—çš„é…ç½®</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">### æ—¥å¿—çº§åˆ«çš„çµæ´»è¿ç”¨</span></span><br><span class="line"><span class="comment">## hibernateç›¸å…³</span></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºsqlçš„æ‰§è¡Œæ—¥å¿—ï¼Œå¦‚æœå¼€äº†è¿™ä¸ª,show_sqlå°±å¯ä»¥ä¸ç”¨äº†</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.SQL</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment"># hibernate idçš„ç”Ÿæˆæ—¥å¿—</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.id</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment"># hibernateæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯PreparedStatementï¼ŒæŠŠsqlçš„æ‰§è¡Œå‚æ•°æ˜¾ç¤ºå‡ºæ¥</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.type.descriptor.sql.BasicBinder</span>=<span class="string">TRACE</span></span><br><span class="line"><span class="comment"># sqlæ‰§è¡Œå®Œæå–çš„è¿”å›å€¼</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.type.descriptor.sql</span>=<span class="string">trace</span></span><br><span class="line"><span class="comment"># è¯·æ±‚å‚æ•°</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.type</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment"># ç¼“å­˜ç›¸å…³</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.cache</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment"># ç»Ÿè®¡hibernateçš„æ‰§è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.stat</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰çš„ç¼“å­˜æ“ä½œ</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.event.internal</span>=<span class="string">trace</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.cache</span>=<span class="string">trace</span></span><br><span class="line"><span class="comment"># hibernate çš„ç›‘æ§æŒ‡æ ‡æ—¥å¿—</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.engine.internal.StatisticalLoggingSessionEventListener</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="comment">### è¿æ¥æ± çš„ç›¸å…³æ—¥å¿—</span></span><br><span class="line"><span class="comment">## hikariè¿æ¥æ± çš„çŠ¶æ€æ—¥å¿—ï¼Œä»¥åŠè¿æ¥æ± æ˜¯å¦å®Œå¥½ #è¿æ¥æ± çš„æ—¥å¿—æ•ˆæœï¼šHikariCPPool - Pool stats (total=20, active=0, idle=20, waiting=0)</span></span><br><span class="line"><span class="meta">logging.level.com.zaxxer.hikari</span>=<span class="string">TRACE</span></span><br><span class="line"><span class="comment">#å¼€å¯ debugå¯ä»¥çœ‹åˆ° AvailableSettingsé‡Œé¢çš„é»˜è®¤é…ç½®çš„å€¼éƒ½æœ‰å“ªäº›ï¼Œä¼šè¾“å‡ºç±»ä¼¼ä¸‹é¢çš„æ—¥å¿—æ ¼å¼</span></span><br><span class="line"><span class="comment"># org.hibernate.cfg.Settings               : Statistics: enabled</span></span><br><span class="line"><span class="comment"># org.hibernate.cfg.Settings               : Default batch fetch size: -1</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.cfg</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment">#hikariæ•°æ®çš„é…ç½®é¡¹æ—¥å¿—</span></span><br><span class="line"><span class="meta">logging.level.com.zaxxer.hikari.HikariConfig</span>=<span class="string">TRACE</span></span><br><span class="line"><span class="comment">### æŸ¥çœ‹äº‹åŠ¡ç›¸å…³çš„æ—¥å¿—ï¼Œäº‹åŠ¡è·å–ï¼Œé‡Šæ”¾æ—¥å¿—</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.orm.jpa</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.transaction</span>=<span class="string">TRACE</span></span><br><span class="line"><span class="meta">logging.level.org.hibernate.engine.transaction.internal.TransactionImpl</span>=<span class="string">DEBUG</span></span><br><span class="line"><span class="comment">### åˆ†æconnect ä»¥åŠ ormå’Œ dataçš„å¤„ç†è¿‡ç¨‹æ›´å…¨çš„æ—¥å¿—</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.data</span>=<span class="string">trace</span></span><br><span class="line"><span class="meta">logging.level.org.springframework.orm</span>=<span class="string">trace</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯åœ¨åˆ†æå¤æ‚é—®é¢˜å’ŒåŸç†çš„æ—¶å€™å¸¸ç”¨çš„æ—¥å¿—é…ç½®é¡¹ç›®</p>
<blockquote>
<p>ğŸ¯æŠ€å·§ï¼š</p>
<p>å½“æˆ‘ä»¬åˆ†æä¸€ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œå¦‚æœä¸çŸ¥é“æ—¥å¿—å…·ä½“åœ¨å“ªä¸ªç±»é‡Œé¢ï¼Œé€šè¿‡è®¾ç½® logging.level.root=trace çš„è¯ï¼Œæ—¥å¿—åˆéå¸¸å¤šå‡ ä¹æ²¡æœ‰åŠæ³•çœ‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç¼©å°èŒƒå›´ï¼Œä¸å¦‚è¯´æˆ‘ä»¬åˆ†æçš„æ˜¯ hikari åŒ…é‡Œé¢ç›¸å…³çš„é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠæ•´ä¸ªæ—¥å¿—çº§åˆ« logging.level.root=info è®¾ç½®æˆ infoï¼ŒæŠŠå…¶ä»–æ‰€æœ‰çš„æ—¥å¿—éƒ½å…³é—­ï¼Œå¹¶æŠŠ logging.level.com.zaxxer=trace è®¾ç½®æˆæœ€å¤§çš„ï¼Œä¿æŒæ—¥å¿—ä¸å—å¹²æ‰°ï¼Œç„¶åè§‚å¯Ÿæ—¥å¿—å†é€æ¸å‡å°‘æŸ¥çœ‹èŒƒå›´ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Data Jpa å¦‚ä½•è§£å†³ N+1 SQL é—®é¢˜</title>
    <url>/2021/01/12/SpringDataJpa%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3N+1SQL%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="Spring-Data-Jpa-å¦‚ä½•è§£å†³-N-1-SQL-é—®é¢˜"><a href="#Spring-Data-Jpa-å¦‚ä½•è§£å†³-N-1-SQL-é—®é¢˜" class="headerlink" title="Spring Data Jpa å¦‚ä½•è§£å†³ N+1 SQL é—®é¢˜"></a>Spring Data Jpa å¦‚ä½•è§£å†³ N+1 SQL é—®é¢˜</h1><p>åœ¨ JPA çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒN+1 SQL æ˜¯å¾ˆå¸¸è§çš„é—®é¢˜</p>
<h2 id="ä»€ä¹ˆæ˜¯-N-1-SQL-é—®é¢˜ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-N-1-SQL-é—®é¢˜ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ N+1 SQL é—®é¢˜ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ N+1 SQL é—®é¢˜ï¼Ÿ</h2><blockquote>
<p>æƒ³è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå¿…é¡»è¦çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆã€å¦‚ä½•äº§ç”Ÿçš„ï¼Œè¿™æ ·æ‰èƒ½æœ‰æ–¹æ³•ã€æœ‰é€»è¾‘åœ°å»è§£å†³å®ƒã€‚</p>
</blockquote>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯ N+1 çš„ SQL é—®é¢˜ã€‚</p>
<p>å‡è®¾ä¸€ä¸ª UserInfo å®ä½“å¯¹è±¡å’Œ Address æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//UserInfoå®ä½“å¯¹è±¡å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addressList&quot;)</span><span class="comment">//excludeé˜²æ­¢ toStringæ‰“å°æ—¥å¿—çš„æ—¶å€™æ­»å¾ªç¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="comment">// UserInfoå®ä½“å¯¹è±¡çš„å…³è”å…³ç³»ç”±Addresså¯¹è±¡é‡Œé¢çš„userInfoå­—æ®µç»´æŠ¤ï¼Œé»˜è®¤æ˜¯lazyåŠ è½½æ¨¡å¼</span></span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Addresså¯¹è±¡å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;userInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="comment">//ç»´æŠ¤UserInfoå’ŒAddressçš„å¤–é”®å…³ç³»</span></span><br><span class="line">   <span class="meta">@ManyToOne(fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="meta">@JsonBackReference</span> <span class="comment">//æ­¤æ³¨è§£é˜²æ­¢JSONæ­»å¾ªç¯</span></span><br><span class="line">   <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¬¡ï¼Œå‡è®¾æ•°æ®åº“é‡Œé¢æœ‰ä¸‰æ¡ UserInfo çš„æ•°æ®ï¼ŒID åˆ†åˆ«ä¸º 3ã€6ã€9ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20210112134537.png" alt=""></p>
<p>å…¶ä¸­ï¼Œæ¯ä¸ª UserInfo åˆ†åˆ«æœ‰ä¸¤æ¡ Address æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€å…± 6 æ¡ Address çš„æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://image.leonote.cn/20210112134946.png" alt=""></p>
<p>ç„¶åï¼Œè¯·æ±‚é€šè¿‡ UserInfoRepository æŸ¥è¯¢æ‰€æœ‰çš„ UserInfo ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">userInfoRepository.findAll()</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œæ§åˆ¶å°å°†ä¼šå¾—åˆ°å››ä¸ª SQLï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                    <span class="keyword">as</span> id1_1_,</span><br><span class="line">       userinfo0_.create_time           <span class="keyword">as</span> create_t2_1_,</span><br><span class="line">       userinfo0_.create_user_id        <span class="keyword">as</span> create_u3_1_,</span><br><span class="line">       userinfo0_.last_modified_time    <span class="keyword">as</span> last_mod4_1_,</span><br><span class="line">       userinfo0_.last_modified_user_id <span class="keyword">as</span> last_mod5_1_,</span><br><span class="line">       userinfo0_.version               <span class="keyword">as</span> version6_1_,</span><br><span class="line">       userinfo0_.ages                  <span class="keyword">as</span> ages7_1_,</span><br><span class="line">       userinfo0_.email_address         <span class="keyword">as</span> email_ad8_1_,</span><br><span class="line">       userinfo0_.last_name             <span class="keyword">as</span> last_nam9_1_,</span><br><span class="line">       userinfo0_.name                  <span class="keyword">as</span> name10_1_,</span><br><span class="line">       userinfo0_.telephone             <span class="keyword">as</span> telepho11_1_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_ org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="operator">=</span> ? org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="operator">=</span> ? org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ SQL å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå½“å– UserInfo çš„æ—¶å€™ï¼Œæœ‰å¤šå°‘æ¡ UserInfo æ•°æ®å°±ä¼šè§¦å‘å¤šå°‘æ¡æŸ¥è¯¢ Address çš„ SQLã€‚</p>
<p>é‚£ä¹ˆæ‰€è°“çš„ N+1 çš„ SQLï¼Œæ­¤æ—¶ 1 ä»£è¡¨çš„æ˜¯ä¸€æ¡ SQL æŸ¥è¯¢ UserInfo ä¿¡æ¯ï¼›N æ¡ SQL æŸ¥è¯¢ Address çš„ä¿¡æ¯ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰ 100 æ¡ UserInfo ä¿¡æ¯ï¼Œå¯èƒ½ä¼šè§¦å‘ 100 æ¡æŸ¥è¯¢ Address çš„ SQLï¼Œæ€§èƒ½å¤šå·®å‘€ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ EAGER æ¨¡å¼ï¼Œå½“ä½¿ç”¨ LAZY çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªæ˜¯ç”Ÿæˆ N æ¡ SQL çš„æ—¶æœºæ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<p>ä¸Šé¢æ¼”ç¤ºäº† @OneToMany çš„æƒ…å†µï¼Œé‚£ä¹ˆå†çœ‹ä¸€ä¸‹ @ManyToOne çš„æƒ…å†µã€‚åˆ©ç”¨ AddressRepository æŸ¥è¯¢æ‰€æœ‰çš„ Address ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">addressRepository.findAll();</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°ä¼šäº§ç”Ÿå¦‚ä¸‹ SQLï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> address0_.id                    <span class="keyword">as</span> id1_0_,</span><br><span class="line">       address0_.create_time           <span class="keyword">as</span> create_t2_0_,</span><br><span class="line">       address0_.create_user_id        <span class="keyword">as</span> create_u3_0_,</span><br><span class="line">       address0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_,</span><br><span class="line">       address0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_,</span><br><span class="line">       address0_.version               <span class="keyword">as</span> version6_0_,</span><br><span class="line">       address0_.city                  <span class="keyword">as</span> city7_0_,</span><br><span class="line">       address0_.user_info_id          <span class="keyword">as</span> user_inf8_0_</span><br><span class="line"><span class="keyword">from</span> address address0_ </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="operator">=</span> ? </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="operator">=</span> ? </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡ SQL å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå½“å– Address çš„æ—¶å€™ï¼ŒAddress é‡Œé¢æœ‰å¤šå°‘ä¸ª user_info_idï¼Œå°±ä¼šè§¦å‘å¤šå°‘æ¡æŸ¥è¯¢ UserInfo çš„ SQLã€‚</p>
<p>é‚£ä¹ˆæ‰€è°“çš„ N+1 çš„ SQLï¼Œæ­¤æ—¶ 1 å°±ä»£è¡¨ä¸€æ¡ SQL æŸ¥è¯¢ Address ä¿¡æ¯ï¼›N æ¡ SQL æŸ¥è¯¢ UserInfo çš„ä¿¡æ¯ã€‚åŒæ ·ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰ 100 æ¡ Address ä¿¡æ¯ï¼Œåˆ†åˆ«æœ‰ä¸åŒçš„ user_info_id å¯èƒ½ä¼šè§¦å‘ 100 æ¡æŸ¥è¯¢ UserInfo çš„ SQLï¼Œæ€§èƒ½ä¾ç„¶å¾ˆå·®ã€‚</p>
<p>è¿™åªæ˜¯æ¼”ç¤ºäº† @OneToMany å’Œ @ManyToOne çš„æƒ…å†µï¼Œ@ManyToMany å’Œ @OneToOne ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œéƒ½æ˜¯å½“æˆ‘ä»¬æŸ¥è¯¢ä¸»ä½“ä¿¡æ¯æ—¶å€™ï¼Œ1 æ¡ SQL ä¼šè¡ç”Ÿå‡ºæ¥å…³è”å…³ç³»çš„ N æ¡ SQLã€‚</p>
<p>ç°åœ¨è®¤è¯†äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸‹ä¸€æ­¥è¯¥æ€è€ƒï¼Œæ€ä¹ˆè§£å†³æ‰æ›´åˆç†å‘¢ï¼Ÿæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥å‡å°‘ SQL æ¡æ•°å‘¢ï¼Ÿ</p>
<h2 id="å‡å°‘-N-1-SQL-çš„æ¡æ•°"><a href="#å‡å°‘-N-1-SQL-çš„æ¡æ•°" class="headerlink" title="å‡å°‘ N+1 SQL çš„æ¡æ•°"></a>å‡å°‘ N+1 SQL çš„æ¡æ•°</h2><p>æœ€å®¹æ˜“æƒ³åˆ°ï¼Œå°±æ˜¯æœ‰æ²¡æœ‰ä»€ä¹ˆæœºåˆ¶å¯ä»¥å‡å°‘ N å¯¹åº”çš„ SQL æ¡æ•°å‘¢ï¼Ÿä»åŸç†åˆ†æä¼šçŸ¥é“ï¼Œä¸ç®¡æ˜¯ LAZY è¿˜æ˜¯ EAGER éƒ½æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªåªæ˜¯å†³å®šäº† N æ¡ SQL çš„è§¦å‘æ—¶æœºï¼Œè€Œä¸èƒ½å‡å°‘ SQL çš„æ¡æ•°ã€‚</p>
<h3 id="hibernate-default-batch-fetch-size-é…ç½®"><a href="#hibernate-default-batch-fetch-size-é…ç½®" class="headerlink" title="hibernate.default_batch_fetch_size é…ç½®"></a>hibernate.default_batch_fetch_size é…ç½®</h3><p>hibernate.default_batch_fetch_size é…ç½®åœ¨ AvailableSettings.class é‡Œé¢ï¼ŒæŒ‡çš„æ˜¯æ‰¹é‡è·å–æ•°æ®çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ -1ï¼Œè¡¨ç¤ºé»˜è®¤æ²¡æœ‰åŒ¹é…å–æ•°æ®ã€‚é‚£ä¹ˆæŠŠè¿™ä¸ªå€¼æ”¹æˆ 20 çœ‹ä¸€ä¸‹æ•ˆæœï¼Œåªéœ€è¦åœ¨ application.properties é‡Œé¢å¢åŠ å¦‚ä¸‹é…ç½®å³å¯ã€‚</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ›´æ”¹æ‰¹é‡å–æ•°æ®çš„å¤§å°ä¸º20</span></span><br><span class="line"><span class="meta">spring.jpa.properties.hibernate.default_batch_fetch_size</span>=<span class="string">20</span></span><br></pre></td></tr></table></figure>

<p>åœ¨å®ä½“ç±»ä¸å‘ç”Ÿä»»ä½•æ”¹å˜çš„å‰æä¸‹ï¼Œå†æ‰§è¡Œå¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«çœ‹ä¸€ä¸‹ SQL çš„ç”Ÿæˆæƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">userInfoRepository.findAll();</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯å…ˆæŸ¥è¯¢æ‰€æœ‰çš„ UserInfo ä¿¡æ¯ï¼Œçœ‹ä¸€ä¸‹ SQL çš„æ‰§è¡Œæƒ…å†µï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                    <span class="keyword">as</span> id1_1_,</span><br><span class="line">       userinfo0_.create_time           <span class="keyword">as</span> create_t2_1_,</span><br><span class="line">       userinfo0_.create_user_id        <span class="keyword">as</span> create_u3_1_,</span><br><span class="line">       userinfo0_.last_modified_time    <span class="keyword">as</span> last_mod4_1_,</span><br><span class="line">       userinfo0_.last_modified_user_id <span class="keyword">as</span> last_mod5_1_,</span><br><span class="line">       userinfo0_.version               <span class="keyword">as</span> version6_1_,</span><br><span class="line">       userinfo0_.ages                  <span class="keyword">as</span> ages7_1_,</span><br><span class="line">       userinfo0_.email_address         <span class="keyword">as</span> email_ad8_1_,</span><br><span class="line">       userinfo0_.last_name             <span class="keyword">as</span> last_nam9_1_,</span><br><span class="line">       userinfo0_.name                  <span class="keyword">as</span> name10_1_,</span><br><span class="line">       userinfo0_.telephone             <span class="keyword">as</span> telepho11_1_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_ org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_0_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_0_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_0_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_0_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_0_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_0_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="keyword">in</span> (?, ?, ?)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° SQL ç›´æ¥å‡å°‘åˆ°ä¸¤æ¡äº†ï¼Œå…¶ä¸­æŸ¥è¯¢ Address çš„åœ°æ–¹æŸ¥è¯¢æ¡ä»¶å˜æˆäº† in(?,?,?)ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰ 20 æ¡ UserInfo ä¿¡æ¯ï¼Œé‚£ä¹ˆäº§ç”Ÿçš„ SQL ä¹Ÿæ˜¯ä¸¤æ¡ï¼Œæ­¤æ—¶è¦æ¯” 20+1 æ¡ SQL æ€§èƒ½é«˜å¤ªå¤šäº†ã€‚</p>
<p>æ¥ç€å†æ‰§è¡Œå¦ä¸€ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ @ManyToOne çš„æƒ…å†µï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">addressRepository.findAll()</span><br></pre></td></tr></table></figure>

<p>å…³äºæ‰§è¡Œçš„ SQL æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-11</span><span class="number">-29</span> <span class="number">23</span>:<span class="number">11</span>:<span class="number">27.381</span> DEBUG <span class="number">30870</span> <span class="comment">--- [nio-8087-exec-5] org.hibernate.SQL                        : </span></span><br><span class="line"><span class="keyword">select</span> address0_.id                    <span class="keyword">as</span> id1_0_,</span><br><span class="line">       address0_.create_time           <span class="keyword">as</span> create_t2_0_,</span><br><span class="line">       address0_.create_user_id        <span class="keyword">as</span> create_u3_0_,</span><br><span class="line">       address0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_,</span><br><span class="line">       address0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_,</span><br><span class="line">       address0_.version               <span class="keyword">as</span> version6_0_,</span><br><span class="line">       address0_.city                  <span class="keyword">as</span> city7_0_,</span><br><span class="line">       address0_.user_info_id          <span class="keyword">as</span> user_inf8_0_</span><br><span class="line"><span class="keyword">from</span> address address0_</span><br><span class="line"><span class="number">2020</span><span class="number">-11</span><span class="number">-29</span> <span class="number">23</span>:<span class="number">11</span>:<span class="number">27.383</span> DEBUG <span class="number">30870</span> <span class="comment">--- [nio-8087-exec-5] org.hibernate.SQL                        : </span></span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="keyword">in</span> (?, ?, ?)</span><br></pre></td></tr></table></figure>

<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥è¯¢æ‰€æœ‰çš„ Address ä¿¡æ¯ä¹Ÿåªäº§ç”Ÿäº† 2 æ¡ SQLï¼›è€Œå½“æˆ‘ä»¬æŸ¥è¯¢ UserInfo çš„æ—¶å€™ï¼ŒSQL æœ€åçš„æŸ¥è¯¢æ¡ä»¶ä¹Ÿå˜æˆäº† in (ï¼Ÿï¼Œï¼Ÿï¼Œï¼Ÿ)ï¼ŒåŒæ ·çš„é“ç†è¿™æ ·ä¹Ÿä¼šæå‡ä¸å°‘æ€§èƒ½ã€‚</p>
<p>è€Œ hibernate.default_batch_fetch_size çš„ç»éªŒå‚è€ƒå€¼ï¼Œ<strong>å¯ä»¥è®¾ç½®æˆ 20ã€30ã€50ã€100 ç­‰ï¼Œå¤ªé«˜äº†ä¹Ÿæ²¡æœ‰æ„ä¹‰</strong>ã€‚<strong><em>ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œä¸€æ¬¡ï¼Œäº§ç”Ÿçš„ SQL æ•°é‡ä¸º 3-5 æ¡åŸºæœ¬ä¸Šéƒ½ç®—åˆç†æƒ…å†µ</em></strong>ï¼Œè¿™æ ·é€šè¿‡è®¾ç½® default_batch_fetch_size å°±å¯ä»¥å¾ˆå¥½åœ°é¿å…å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯ä¸‹çš„ N+1 æ¡ SQL çš„æ€§èƒ½é—®é¢˜äº†ã€‚</p>
<p>æ­¤æ—¶è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œä¸€å®šè¦çŸ¥é“ä¸€æ¬¡æ“ä½œä¼šäº§ç”Ÿå¤šå°‘ SQLï¼Œæœ‰æ²¡æœ‰é¢„æœŸä¹‹å¤–çš„ SQL å‚æ•°ï¼Œè¿™æ˜¯éœ€è¦å…³æ³¨çš„é‡ç‚¹ï¼Œè¿™ç§æƒ…å†µå¯ä»¥åˆ©ç”¨å¦‚ä¸‹é…ç½®æ¥å¼€å¯æ‰“å° SQLï¼Œè¯·çœ‹ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">## æ˜¾ç¤ºsqlçš„æ‰§è¡Œæ—¥å¿—ï¼Œå¦‚æœå¼€äº†è¿™ä¸ª,show_sqlå°±å¯ä»¥ä¸ç”¨äº†ï¼Œshow_sqlæ²¡æœ‰ä¸Šä¸‹æ–‡ï¼Œå¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œåˆ†ä¸æ¸…æ¥šæ˜¯è°æ‰“å°çš„ï¼Œæ‰€æœ‰æˆ‘æ¨èå¦‚ä¸‹é…ç½®é¡¹ï¼š</span><br><span class="line">logging.level.org.hibernate.SQL=debug</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ç§é…ç½®ä¹Ÿæœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯åªèƒ½å…¨å±€é…ç½®ï¼Œæ²¡åŠæ³•é’ˆå¯¹ä¸é€šè¿‡çš„å®ä½“ç®¡ç†å…³ç³»é…ç½®ä¸åŒçš„ Fetch Size çš„å€¼ã€‚</p>
<p>è€Œä¸ä¹‹ç±»ä¼¼çš„ Hibernate é‡Œé¢ä¹Ÿæä¾›äº†ä¸€ä¸ªæ³¨è§£ @BatchSize å¯ä»¥è§£å†³æ­¤é—®é¢˜ã€‚</p>
<h3 id="BatchSize-æ³¨è§£"><a href="#BatchSize-æ³¨è§£" class="headerlink" title="@BatchSize æ³¨è§£"></a>@BatchSize æ³¨è§£</h3><p><code>@BatchSize</code> æ³¨è§£æ˜¯ Hibernate æä¾›çš„ç”¨æ¥è§£å†³æŸ¥è¯¢å…³è”å…³ç³»çš„æ‰¹é‡å¤„ç†å¤§å°ï¼Œé»˜è®¤æ— ï¼Œå¯ä»¥é…ç½®åœ¨å®ä½“ä¸Šï¼Œä¹Ÿå¯ä»¥é…ç½®åœ¨å…³è”å…³ç³»ä¸Šé¢ã€‚æ­¤æ³¨è§£é‡Œé¢åªæœ‰ä¸€ä¸ªå±æ€§ sizeï¼Œç”¨æ¥æŒ‡å®šå…³è”å…³ç³» LAZY æˆ–è€…æ˜¯ EAGER ä¸€æ¬¡æ€§å–æ•°æ®çš„å¤§å°ã€‚</p>
<p>è¿˜æ˜¯å°†ä¸Šé¢çš„ä¾‹å­ä¸­çš„ UserInfo å®ä½“åšä¸€ä¸‹æ”¹é€ ï¼Œåœ¨é‡Œé¢å¢åŠ ä¸¤æ¬¡ @BatchSize æ³¨è§£ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addressList&quot;)</span></span><br><span class="line"><span class="meta">@BatchSize(size = 2)</span><span class="comment">//å®ä½“ç±»ä¸ŠåŠ @BatchSizeæ³¨è§£ï¼Œç”¨æ¥è®¾ç½®å½“è¢«å…³è”å…³ç³»çš„æ—¶å€™ä¸€æ¬¡æŸ¥è¯¢çš„å¤§å°ï¼Œè®¾ç½®æˆ2ï¼Œæ–¹ä¾¿æ¼”ç¤ºAddresså…³è”UserInfoçš„æ—¶å€™çš„æ•ˆæœ</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,cascade = CascadeType.PERSIST,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="meta">@BatchSize(size = 20)</span><span class="comment">//å…³è”å…³ç³»çš„å±æ€§ä¸ŠåŠ @BatchSizeæ³¨è§£ï¼Œç”¨æ¥è®¾ç½®å½“é€šè¿‡UserInfoåŠ è½½Addressçš„æ—¶å€™ä¸€æ¬¡å–æ•°æ®çš„å¤§å°</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ”¹é€  UserInfo å®ä½“ï¼Œå¯ä»¥ç›´æ¥æ¼”ç¤º <code>@BatchSize</code> åº”ç”¨åœ¨å®ä½“ç±»å’Œå±æ€§å­—æ®µä¸Šçš„æ•ˆæœï¼Œæ‰€ä»¥ Address å®ä½“å¯ä»¥ä¸åšä»»ä½•æ”¹å˜ï¼Œhibernate.default_batch_fetch_size è¿˜æ”¹æˆé»˜è®¤å€¼ -1ï¼Œå†åˆ†åˆ«æ‰§è¡Œä¸€ä¸‹ä¸¤ä¸ª findAll æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœã€‚</p>
<p>ç¬¬ä¸€ç§ï¼šæŸ¥è¯¢æ‰€æœ‰ UserInfoï¼Œä»£ç å¦‚ä¸‹é¢è¿™è¡Œæ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">userInfoRepository.findAll()</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹æ§åˆ¶å° SQL ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"> org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                    <span class="keyword">as</span> id1_1_,</span><br><span class="line">       userinfo0_.create_time           <span class="keyword">as</span> create_t2_1_,</span><br><span class="line">       userinfo0_.create_user_id        <span class="keyword">as</span> create_u3_1_,</span><br><span class="line">       userinfo0_.last_modified_time    <span class="keyword">as</span> last_mod4_1_,</span><br><span class="line">       userinfo0_.last_modified_user_id <span class="keyword">as</span> last_mod5_1_,</span><br><span class="line">       userinfo0_.version               <span class="keyword">as</span> version6_1_,</span><br><span class="line">       userinfo0_.ages                  <span class="keyword">as</span> ages7_1_,</span><br><span class="line">       userinfo0_.email_address         <span class="keyword">as</span> email_ad8_1_,</span><br><span class="line">       userinfo0_.last_name             <span class="keyword">as</span> last_nam9_1_,</span><br><span class="line">       userinfo0_.name                  <span class="keyword">as</span> name10_1_,</span><br><span class="line">       userinfo0_.telephone             <span class="keyword">as</span> telepho11_1_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_ org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_0_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_0_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_0_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_0_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_0_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_0_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="keyword">in</span> (?, ?, ?)</span><br></pre></td></tr></table></figure>

<p>å’Œåˆšæ‰è®¾ç½® hibernate.default_batch_fetch_size=20 çš„æ•ˆæœä¸€æ¨¡ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨ <code>@BatchSize</code> è¿™ä¸ªæ³¨è§£é’ˆå¯¹ä¸åŒçš„å…³è”å…³ç³»ï¼Œé…ç½®ä¸åŒçš„å¤§å°ï¼Œä»è€Œæå‡ N+1 SQL çš„æ€§èƒ½ã€‚</p>
<p>ç¬¬äºŒç§ï¼šæŸ¥è¯¢ä¸€ä¸‹æ‰€æœ‰ Addressï¼Œå¦‚ä¸‹é¢è¿™è¡Œä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">addressRepository.findAll();</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°çš„ SQL æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> address0_.id                    <span class="keyword">as</span> id1_0_,</span><br><span class="line">       address0_.create_time           <span class="keyword">as</span> create_t2_0_,</span><br><span class="line">       address0_.create_user_id        <span class="keyword">as</span> create_u3_0_,</span><br><span class="line">       address0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_,</span><br><span class="line">       address0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_,</span><br><span class="line">       address0_.version               <span class="keyword">as</span> version6_0_,</span><br><span class="line">       address0_.city                  <span class="keyword">as</span> city7_0_,</span><br><span class="line">       address0_.user_info_id          <span class="keyword">as</span> user_inf8_0_</span><br><span class="line"><span class="keyword">from</span> address address0_ </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="keyword">in</span> (?, ?) </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç”±äºåœ¨ UserInfo çš„å®ä½“ä¸Šè®¾ç½®äº† <code>@BatchSize(size = 2)</code>ï¼Œè¡¨ç¤ºæ‰€æœ‰å…³è”å…³ç³»åˆ° UserInfo çš„æ—¶å€™ä¸€æ¬¡å–ä¸¤æ¡æ•°æ®ï¼Œæ‰€ä»¥å°±ä¼šå‘ç°è¿™æ¬¡æŸ¥è¯¢ Address åŠ è½½ UserInfo çš„æ—¶å€™ï¼Œäº§ç”Ÿäº† 3 æ¡ SQLã€‚</p>
<p>å…¶ä¸­é€šè¿‡å…³è”å…³ç³»æŸ¥è¯¢ UserInfo äº§ç”Ÿäº† 2 æ¡ SQLï¼Œç”±äºæˆ‘ä»¬ UserInfo åœ¨æ•°æ®åº“é‡Œé¢æœ‰ä¸‰æ¡æ•°æ®ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡ UserInfo çš„ SQL å— <code>@BatchSize(size = 2)</code> æ§åˆ¶ï¼Œä»è€Œ in (?,?) åªæ”¯æŒäº†ä¸¤ä¸ªå‚æ•°ï¼ŒåŒæ—¶ä¹Ÿäº§ç”Ÿäº†ç¬¬äºŒæ¡æŸ¥ UserInfo çš„ SQLã€‚</p>
<p>ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ° @BatchSize å’Œ hibernate.default_batch_fetch_size çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯å…¨å±€é…ç½®ã€ä¸€ä¸ªæ˜¯å±€éƒ¨è®¾ç½®ï¼Œè¿™æ˜¯å¯ä»¥å‡å°‘ N+1 SQL æœ€ç›´æ¥ã€æœ€æ–¹ä¾¿çš„ä¸¤ç§æ–¹å¼ã€‚</p>
<blockquote>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<p>@BatchSize çš„ä½¿ç”¨å…·æœ‰å±€é™æ€§ï¼Œä¸èƒ½ä½œç”¨äº @ManyToOne å’Œ @OneToOne çš„å…³è”å…³ç³»ä¸Šï¼Œé‚£æ ·ä»£ç æ˜¯ä¸èµ·ä½œç”¨çš„</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="meta">@ManyToOne(cascade = CascadeType.PERSIST,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="meta">@BatchSize(size = 30)</span> <span class="comment">//ç”±äºæ˜¯@ManyToOneçš„å…³è”å…³ç³»æ‰€æœ‰æ²¡æœ‰ä½œç”¨</span></span><br><span class="line">   <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> @BatchSize åªèƒ½ä½œç”¨åœ¨ @ManyToManyã€@OneToManyã€å®ä½“ç±»è¿™ä¸‰ä¸ªåœ°æ–¹ã€‚</p>
</blockquote>
<p>æ­¤å¤–ï¼ŒHibernate ä¸­è¿˜æä¾›äº†ä¸€ç§ FetchMode çš„ç­–ç•¥ï¼ŒåŒ…å«ä¸‰ç§æ¨¡å¼ï¼Œåˆ†åˆ«ä¸º FetchMode.SELECTã€FetchMode.JOINï¼Œä»¥åŠ FetchMode.SUBSELECTã€‚</p>
<h3 id="Hibernate-ä¸­-Fetch-æ•°æ®çš„ç­–ç•¥"><a href="#Hibernate-ä¸­-Fetch-æ•°æ®çš„ç­–ç•¥" class="headerlink" title="Hibernate ä¸­ @Fetch æ•°æ®çš„ç­–ç•¥"></a>Hibernate ä¸­ @Fetch æ•°æ®çš„ç­–ç•¥</h3><p>Hibernate æä¾›äº†ä¸€ä¸ª <code>@Fetch</code> æ³¨è§£ï¼Œç”¨æ¥æ”¹å˜è·å–æ•°æ®çš„ç­–ç•¥ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fetchæ³¨è§£åªèƒ½ç”¨åœ¨æ–¹æ³•å’Œå­—æ®µä¸Šé¢</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Fetch &#123;</span><br><span class="line">   <span class="comment">//æ³¨è§£é‡Œé¢ï¼Œåªæœ‰ä¸€ä¸ªå±æ€§è·å–æ•°æ®çš„æ¨¡å¼</span></span><br><span class="line">   <span class="function">FetchMode <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å…¶ä¸­FetchModeçš„å€¼æœ‰å¦‚ä¸‹å‡ ç§ï¼š</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">FetchMode</span> </span>&#123;</span><br><span class="line">   <span class="comment">//é»˜è®¤æ¨¡å¼ï¼Œå°±æ˜¯ä¼šæœ‰N+1 sqlçš„é—®é¢˜ï¼›</span></span><br><span class="line">   SELECT,</span><br><span class="line">   <span class="comment">//é€šè¿‡joinçš„æ¨¡å¼ï¼Œç”¨ä¸€ä¸ªsqlæŠŠä¸»ä½“æ•°æ®å’Œå…³è”å…³ç³»æ•°æ®ä¸€å£æ°”æŸ¥å‡ºæ¥</span></span><br><span class="line">   JOIN,</span><br><span class="line">   <span class="comment">//é€šè¿‡å­æŸ¥è¯¢çš„æ¨¡å¼ï¼ŒæŸ¥è¯¢å…³è”å…³ç³»çš„æ•°æ®</span></span><br><span class="line">   SUBSELECT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è¦æŠŠè¿™ä¸ªæ³¨è§£å’Œ JPA åè®®é‡Œé¢çš„ FetchType.EAGERã€FetchType.LAZY ææ··äº†ï¼Œ<strong>JPA åè®®çš„å…³è”å…³ç³»ä¸­çš„ FetchType è§£å†³çš„æ˜¯å–å…³è”å…³ç³»æ•°æ®æ—¶æœºçš„é—®é¢˜</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ EAGER ä»£è¡¨çš„æ˜¯ç«‹å³è·å¾—å…³è”å…³ç³»çš„æ•°æ®ï¼ŒLAZY æ˜¯éœ€è¦çš„æ—¶å€™å†è·å¾—å…³è”å…³ç³»çš„æ•°æ®ã€‚</p>
<p>è¿™å’Œ Hibernate çš„ FetchMode æ˜¯ä¸¤å›äº‹ï¼Œ<strong>FetchMode è§£å†³çš„æ˜¯è·å¾—æ•°æ®ç­–ç•¥çš„é—®é¢˜</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè·å¾—å…³è”å…³ç³»æ•°æ®çš„ç­–ç•¥æœ‰ä¸‰ç§æ¨¡å¼ï¼šSELECTï¼ˆé»˜è®¤ï¼‰ã€JOINã€SUBSELECTã€‚</p>
<h4 id="FetchMode-SELECT"><a href="#FetchMode-SELECT" class="headerlink" title="FetchMode.SELECT"></a>FetchMode.SELECT</h4><p>æ›´æ”¹ä¸€ä¸‹ UserInfo å®ä½“ï¼Œå°† <code>@Fetch(value = FetchMode.SELECT)</code> ä½œä¸ºè·å–æ•°æ®çš„ç­–ç•¥ï¼Œä½¿ç”¨ FetchType.EAGER ä½œä¸ºè·å–æ•°æ®çš„æ—¶æœºï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addressList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,cascade = CascadeType.PERSIST,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="meta">@Fetch(value = FetchMode.SELECT)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿˜æ˜¯æ‰§è¡Œ <code>userInfoRepository.findAll();</code> è¿™ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ‰“å°çš„ SQL æœ‰å“ªäº›ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                    <span class="keyword">as</span> id1_1_,</span><br><span class="line">       userinfo0_.create_time           <span class="keyword">as</span> create_t2_1_,</span><br><span class="line">       userinfo0_.create_user_id        <span class="keyword">as</span> create_u3_1_,</span><br><span class="line">       userinfo0_.last_modified_time    <span class="keyword">as</span> last_mod4_1_,</span><br><span class="line">       userinfo0_.last_modified_user_id <span class="keyword">as</span> last_mod5_1_,</span><br><span class="line">       userinfo0_.version               <span class="keyword">as</span> version6_1_,</span><br><span class="line">       userinfo0_.ages                  <span class="keyword">as</span> ages7_1_,</span><br><span class="line">       userinfo0_.email_address         <span class="keyword">as</span> email_ad8_1_,</span><br><span class="line">       userinfo0_.last_name             <span class="keyword">as</span> last_nam9_1_,</span><br><span class="line">       userinfo0_.name                  <span class="keyword">as</span> name10_1_,</span><br><span class="line">       userinfo0_.telephone             <span class="keyword">as</span> telepho11_1_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_ </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="operator">=</span> ? </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="operator">=</span> ? </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿° SQL ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¾ç„¶æ˜¯ N+1 çš„ SQL é—®é¢˜ï¼ŒFetchMode.Select æ˜¯é»˜è®¤ç­–ç•¥ï¼ŒåŠ ä¸ä¸åŠ æ˜¯åŒæ ·çš„æ•ˆæœï¼Œä»£è¡¨è·å–å…³ç³»çš„æ—¶å€™æ–°å¼€ä¸€ä¸ª SQL è¿›è¡ŒæŸ¥è¯¢ã€‚</p>
<h4 id="FetchMode-JOIN"><a href="#FetchMode-JOIN" class="headerlink" title="FetchMode.JOIN"></a>FetchMode.JOIN</h4><p>FetchMode.JOIN çš„æ„æ€æ˜¯ä¸»è¡¨ä¿¡æ¯å’Œå…³è”å…³ç³»é€šè¿‡ä¸€ä¸ª SQL JOIN çš„æ–¹å¼æŸ¥å‡ºæ¥ï¼Œçœ‹ä¸€ä¸‹ä¾‹å­ã€‚</p>
<p>é¦–å…ˆï¼Œå°† UserInfo é‡Œé¢çš„ FetchMode æ”¹æˆ JOIN æ¨¡å¼ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,cascade = CascadeType.PERSIST,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="meta">@Fetch(value = FetchMode.JOIN)</span> <span class="comment">//å”¯ä¸€å˜åŒ–çš„åœ°æ–¹é‡‡ç”¨JOINæ¨¡å¼</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œè°ƒç”¨ä¸€ä¸‹ <code>userInfoRepository.findAll();</code> è¿™ä¸ªæ–¹æ³•ï¼Œå‘ç°ä¾ç„¶æ˜¯è¿™ä¸‰æ¡ SQLï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="http://image.leonote.cn/20210112143025.png" alt="">è¿™æ˜¯å› ä¸º FetchMode.JOIN åªæ”¯æŒé€šè¿‡ ID æˆ–è€…è”åˆå”¯ä¸€é”®è·å–æ•°æ®æ‰æœ‰æ•ˆï¼Œè¿™æ­£æ˜¯ JOIN ç­–ç•¥æ¨¡å¼çš„å±€é™æ€§æ‰€åœ¨ã€‚</p>
<p>é‚£ä¹ˆå†è°ƒç”¨ä¸€ä¸‹ <code>userInfoRepository.findById(id)</code>ï¼Œçœ‹çœ‹æ§åˆ¶å°çš„ SQL æ‰§è¡Œæƒ…å†µï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_1_0_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_1_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_1_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_1_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_1_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_1_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_1_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_1_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_1_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_1_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_1_0_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_2_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_2_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_2_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_2_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_2_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_2_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_2_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_2_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br><span class="line"><span class="keyword">where</span> userinfo0_.id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶ä¼šå‘ç°ï¼Œå½“æŸ¥è¯¢ UserInfo çš„æ—¶å€™ï¼Œå®ƒä¼šé€šè¿‡ left outer join æŠŠ Address çš„ä¿¡æ¯ä¹ŸæŸ¥è¯¢å‡ºæ¥ï¼Œè™½ç„¶ SQL ä¸Šä¼šæœ‰å†—ä½™ä¿¡æ¯ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°æˆ‘ä»¬ä¹‹å‰çš„ N+1 çš„ SQL ç›´æ¥å˜æˆ 1 æ¡ SQL äº†ã€‚</p>
<p>æ­¤æ—¶ä¿®æ”¹ UserInfo é‡Œé¢çš„ @OneToManyï¼Œè¿™ä¸ª <code>@Fetch(value = FetchMode.JOIN)</code> åŒæ ·é€‚ç”¨äº @ManyToOneï¼›ç„¶åå†æ”¹ä¸€ä¸‹ Address å®ä¾‹ï¼Œç”¨ <code>@Fetch(value = FetchMode.JOIN)</code> æŠŠ Address é‡Œé¢çš„ UserInfo å…³è”å…³ç³»æ”¹æˆ JOIN æ¨¡å¼ï¼›æ¥ç€ç”¨ LAZY è·å–æ•°æ®çš„æ—¶æœºï¼Œä¼šå‘ç°å…¶å¯¹è·å–æ•°æ®çš„ç­–ç•¥æ²¡æœ‰ä»»ä½•å½±å“ã€‚</p>
<p>è¿™é‡Œåªæ˜¯ç»™ä½ æ¼”ç¤ºè·å–æ•°æ®æ—¶æœºçš„ä¸åŒæƒ…å†µï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;userInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="meta">@ManyToOne(cascade = CascadeType.PERSIST,fetch = FetchType.LAZY)</span></span><br><span class="line">   <span class="meta">@JsonBackReference</span></span><br><span class="line">   <span class="meta">@Fetch(value = FetchMode.JOIN)</span></span><br><span class="line">   <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ ·çš„é“ç†ï¼ŒJOIN å¯¹åˆ—è¡¨æ€§çš„æŸ¥è¯¢æ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸‹ <code>addressRepository.findById(id)</code>ï¼Œäº§ç”Ÿçš„ SQL å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        : </span><br><span class="line">select address0_.id                     as id1_0_0_,</span><br><span class="line">       address0_.create_time            as create_t2_0_0_,</span><br><span class="line">       address0_.create_user_id         as create_u3_0_0_,</span><br><span class="line">       address0_.last_modified_time     as last_mod4_0_0_,</span><br><span class="line">       address0_.last_modified_user_id  as last_mod5_0_0_,</span><br><span class="line">       address0_.version                as version6_0_0_,</span><br><span class="line">       address0_.city                   as city7_0_0_,</span><br><span class="line">       address0_.user_info_id           as user_inf8_0_0_,</span><br><span class="line">       userinfo1_.id                    as id1_1_1_,</span><br><span class="line">       userinfo1_.create_time           as create_t2_1_1_,</span><br><span class="line">       userinfo1_.create_user_id        as create_u3_1_1_,</span><br><span class="line">       userinfo1_.last_modified_time    as last_mod4_1_1_,</span><br><span class="line">       userinfo1_.last_modified_user_id as last_mod5_1_1_,</span><br><span class="line">       userinfo1_.version               as version6_1_1_,</span><br><span class="line">       userinfo1_.ages                  as ages7_1_1_,</span><br><span class="line">       userinfo1_.email_address         as email_ad8_1_1_,</span><br><span class="line">       userinfo1_.last_name             as last_nam9_1_1_,</span><br><span class="line">       userinfo1_.name                  as name10_1_1_,</span><br><span class="line">       userinfo1_.telephone             as telepho11_1_1_</span><br><span class="line">from address address0_</span><br><span class="line">         left outer join user_info userinfo1_ on address0_.user_info_id &#x3D; userinfo1_.id</span><br><span class="line">where address0_.id &#x3D; ?</span><br></pre></td></tr></table></figure>

<p>å‘ç°æ­¤æ—¶åªä¼šäº§ç”Ÿä¸€ä¸ª SQLï¼Œå³é€šè¿‡ from address left outer join user_info ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½æŸ¥å‡ºæ¥ï¼Œç„¶å Hibernate å†æ ¹æ®æŸ¥è¯¢å‡ºæ¥çš„ç»“æœç»„åˆåˆ°ä¸åŒçš„å®ä½“é‡Œé¢ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ <strong><em>FetchMode.JOIN å¯¹äºå…³è”å…³ç³»çš„æŸ¥è¯¢ LAZY æ˜¯ä¸èµ·ä½œç”¨çš„</em></strong>ï¼Œå› ä¸º JOIN çš„æ¨¡å¼æ˜¯é€šè¿‡ä¸€æ¡ SQL æŸ¥å‡ºæ¥æ‰€æœ‰ä¿¡æ¯ï¼Œæ‰€ä»¥ <strong><em>FetchMode.JOIN ä¼šå¿½ç•¥ FetchType</em></strong>ã€‚</p>
<h4 id="FetchMode-SUBSELECT"><a href="#FetchMode-SUBSELECT" class="headerlink" title="FetchMode.SUBSELECT"></a>FetchMode.SUBSELECT</h4><p>è¿™ç§æ¨¡å¼å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å…³è”å…³ç³»é€šè¿‡å­æŸ¥è¯¢çš„å½¢å¼æŸ¥è¯¢å‡ºæ¥ï¼Œç»“åˆä¾‹å­æ¥ç†è§£ä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆï¼Œå°† UserInfo é‡Œé¢çš„å…³è”å…³ç³»æ”¹æˆ <code>@Fetch(value = FetchMode.SUBSELECT)</code>ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,cascade = CascadeType.PERSIST,fetch = FetchType.LAZY)</span> <span class="comment">//è¿™é‡Œæµ‹è¯•ä¸€ä¸‹LAZYæƒ…å†µ</span></span><br><span class="line">   <span class="meta">@Fetch(value = FetchMode.SUBSELECT)</span> <span class="comment">//å”¯ä¸€å˜åŒ–ä¹‹å¤„</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œåƒä¸Šé¢çš„åšæ³•ä¸€æ ·ï¼Œæ‰§è¡Œä¸€ä¸‹ <code>userInfoRepository.findAll()ï¼›</code>æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ§åˆ¶å°çš„ SQL æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                    <span class="keyword">as</span> id1_1_,</span><br><span class="line">       userinfo0_.create_time           <span class="keyword">as</span> create_t2_1_,</span><br><span class="line">       userinfo0_.create_user_id        <span class="keyword">as</span> create_u3_1_,</span><br><span class="line">       userinfo0_.last_modified_time    <span class="keyword">as</span> last_mod4_1_,</span><br><span class="line">       userinfo0_.last_modified_user_id <span class="keyword">as</span> last_mod5_1_,</span><br><span class="line">       userinfo0_.version               <span class="keyword">as</span> version6_1_,</span><br><span class="line">       userinfo0_.ages                  <span class="keyword">as</span> ages7_1_,</span><br><span class="line">       userinfo0_.email_address         <span class="keyword">as</span> email_ad8_1_,</span><br><span class="line">       userinfo0_.last_name             <span class="keyword">as</span> last_nam9_1_,</span><br><span class="line">       userinfo0_.name                  <span class="keyword">as</span> name10_1_,</span><br><span class="line">       userinfo0_.telephone             <span class="keyword">as</span> telepho11_1_</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_ </span><br><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       addresslis0_.id                    <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       addresslis0_.create_time           <span class="keyword">as</span> create_t2_0_0_,</span><br><span class="line">       addresslis0_.create_user_id        <span class="keyword">as</span> create_u3_0_0_,</span><br><span class="line">       addresslis0_.last_modified_time    <span class="keyword">as</span> last_mod4_0_0_,</span><br><span class="line">       addresslis0_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_0_,</span><br><span class="line">       addresslis0_.version               <span class="keyword">as</span> version6_0_0_,</span><br><span class="line">       addresslis0_.city                  <span class="keyword">as</span> city7_0_0_,</span><br><span class="line">       addresslis0_.user_info_id          <span class="keyword">as</span> user_inf8_0_0_</span><br><span class="line"><span class="keyword">from</span> address addresslis0_</span><br><span class="line"><span class="keyword">where</span> addresslis0_.user_info_id <span class="keyword">in</span> (<span class="keyword">select</span> userinfo0_.id <span class="keyword">from</span> user_info userinfo0_)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ—¶å€™ä¼šå‘ç°ï¼ŒæŸ¥è¯¢ Address ä¿¡æ¯æ˜¯ç›´æ¥é€šè¿‡ addresslis0_.user_info_id in (select userinfo0_.id from user_info userinfo0_) å­æŸ¥è¯¢çš„æ–¹å¼è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ N+1 SQL å˜æˆäº† 1+1 çš„ SQLï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼æˆ‘ä»¬é…ç½® @BatchSize çš„æ•ˆæœã€‚</p>
<p><strong>FetchMode.SUBSELECT æ”¯æŒ ID æŸ¥è¯¢å’Œå„ç§æ¡ä»¶æŸ¥è¯¢</strong>ï¼Œå”¯ä¸€çš„ç¼ºç‚¹æ˜¯<strong>åªèƒ½é…ç½®åœ¨ @OneToMany å’Œ @ManyToMany çš„å…³è”å…³ç³»ä¸Š</strong>ï¼Œä¸èƒ½é…ç½®åœ¨ @ManyToOne å’Œ @OneToOne çš„å…³è”å…³ç³»ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Address é‡Œé¢å…³è” UserInfo çš„æ—¶å€™å°±æ²¡æœ‰åŠæ³•åšå®éªŒäº†ã€‚</p>
<p>æ€»ä¹‹ï¼Œ<code>@Fetch</code> çš„ä¸åŒæ¨¡å‹ï¼Œéƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼š</p>
<ul>
<li>FetchMode.SELECT é»˜è®¤ï¼Œå’Œä¸é…ç½®çš„æ•ˆæœä¸€æ ·ï¼›</li>
<li>FetchMode.JOIN åªæ”¯æŒç±»ä¼¼ findById(id) çš„æ–¹æ³•ï¼Œåªèƒ½æ ¹æ® ID æŸ¥è¯¢æ‰æœ‰æ•ˆæœï¼›</li>
<li>FetchMode.SUBSELECT è™½ç„¶ä¸é™ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯åªæ”¯æŒ **ToMany çš„å…³è”å…³ç³»ã€‚</li>
</ul>
<p>æ‰€ä»¥åœ¨ä½¿ç”¨ <code>@Fetch</code> çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹å®ƒçš„å±€é™æ€§ï¼Œä¸ªäººæ˜¯æ¯”è¾ƒæ¨è <code>@BatchSize</code> çš„æ–¹å¼ã€‚</p>
<p>é‚£ä¹ˆé™¤äº†ä¸Šé¢çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ä¹‹å‰å†™ Mybatis çš„æ€è·¯æ¥æŸ¥è¯¢å…³è”å…³ç³»ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¯¥å¦‚ä½•è½¬å˜æ€è·¯ã€‚</p>
<h3 id="è½¬åŒ–è§£å†³é—®é¢˜çš„æ€è·¯"><a href="#è½¬åŒ–è§£å†³é—®é¢˜çš„æ€è·¯" class="headerlink" title="è½¬åŒ–è§£å†³é—®é¢˜çš„æ€è·¯"></a>è½¬åŒ–è§£å†³é—®é¢˜çš„æ€è·¯</h3><p>è¿™æ—¶éœ€è¦åœ¨æ€æƒ³ä¸Šè¿›è¡Œè½¬å˜ï¼Œåˆ©ç”¨ JPA çš„ä¼˜åŠ¿ï¼Œæ‘’å¼ƒå®ƒçš„ç¼ºé™·ã€‚æƒ³æƒ³æ²¡æœ‰ç”¨ JPA çš„æ—¶å€™æ˜¯æ€ä¹ˆåšçš„ï¼Ÿéš¾é“ä¸€å®šè¦ç”¨å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»å—ï¼Ÿå¦‚æœç”¨çš„æ˜¯ Mybatisï¼Œä½ åœ¨ç»™å‰ç«¯è¿”å›å…³è”å…³ç³»æ•°æ®çš„æ—¶å€™ä¸€èˆ¬æ€ä¹ˆå†™å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆè‚¯å®šæ˜¯å†™æˆ 1+1 SQL çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡ä¸» SQLã€ä¸€æ¡æŸ¥å…³è”å…³ç³»çš„ SQLã€‚è¿˜ç”¨ UserInfo å’Œ Address å®ä½“æ¥æ¼”ç¤ºï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="meta">@Transient</span> <span class="comment">//åœ¨UserInfoå®ä½“ä¸­ï¼Œä¸åˆ©ç”¨JPAæ¥å…³è”å®ä½“çš„å…³è”å…³ç³»äº†ï¼Œè€Œæ˜¯æŠŠå®ƒè®¾ç½®æˆ@Transisentï¼Œåªç»´æŠ¤javaå¯¹è±¡çš„å…³ç³»ï¼Œä¸ç»´æŠ¤DBä¹‹é—´çš„å…³è”å…³ç³»</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;userInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="keyword">private</span> String userId;</span><br><span class="line">   <span class="meta">@Transient</span> <span class="comment">//åŒæ ·Addressé‡Œé¢ä¹Ÿå¯ä»¥ä¸ç»´æŠ¤UserInfoçš„å…³è”å…³ç³»</span></span><br><span class="line">   <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æŸ¥è¯¢æ‰€æœ‰ UserInfo ä¿¡æ¯çš„æ—¶å€™ï¼Œåˆæƒ³æŠŠæ¯ä¸ª UserInfo çš„ Address ä¿¡æ¯éƒ½å¸¦ä¸Šï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¯·çœ‹å¦‚ä¸‹ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå·±å®ç°ä¸€å¥— Batch fetchçš„é€»è¾‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">getAllUserWithAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//å…ˆæŸ¥å‡ºæ¥æ‰€æœ‰çš„UserInfoä¿¡æ¯</span></span><br><span class="line">   List&lt;UserInfo&gt; userInfos = userInfoRepository.findAll();</span><br><span class="line">   <span class="comment">//å†æŸ¥å‡ºæ¥ä¸Šé¢userInfosé‡Œé¢çš„æ‰€æœ‰userIdåˆ—è¡¨ï¼Œå†æŸ¥è¯¢å‡ºæ¥ä¸Šé¢çš„æŸ¥è¯¢ç»“æœæ‰€å¯¹åº”çš„æ‰€æœ‰Addressä¿¡æ¯</span></span><br><span class="line">   List&lt;Address&gt; addresses = addressRepository.findByUserIdIn(userInfos.stream().map(userInfo -&gt; userInfo.getId()).collect(Collectors.toList()));</span><br><span class="line">   <span class="comment">//æˆ‘ä»¬è‡ªå·±å†å†™ä¸€ä¸ªè½¬åŒ–é€»è¾‘ï¼ŒæŠŠå„è‡ªuser infoçš„addressä¿¡æ¯æ”¾ç½®åˆ°å“åº”çš„UserInfoå®ä¾‹é‡Œé¢ï¼›</span></span><br><span class="line">   Map&lt;Long,List&lt;Address&gt;&gt; addressMaps = addresses</span><br><span class="line">         .stream()</span><br><span class="line">         .collect(Collectors.groupingBy(Address::getUserId));<span class="comment">//é‡Œé¢Mapç»“æ„æ–¹ä¾¿è·å–</span></span><br><span class="line">   <span class="keyword">return</span> userInfos.stream().map(userInfo -&gt; &#123;</span><br><span class="line">       userInfo.setAddressList(addressMaps.get(userInfo.getId()));</span><br><span class="line">       <span class="keyword">return</span> userInfo;</span><br><span class="line">   &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½ ä¼šå‘ç°ï¼Œè¿™è¦æ¯”åŸæ¥çš„æ–¹å¼ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯å¦‚æœåšæ¡†æ¶çš„è¯ï¼Œä¸Šé¢æœ‰äº›é€»è¾‘å¯ä»¥æŠ½åˆ°ä¸€ä¸ª Util ç±»é‡Œé¢å»ã€‚</p>
<p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®é™…å·¥ä½œä¸­è‚¯å®šä¸æ˜¯ findAll()ï¼Œè€Œæ˜¯ä¼šæ ¹æ®ä¸€äº›ä¸šåŠ¡é€»è¾‘æŸ¥è¯¢ä¸€ä¸ª UserInfo çš„ List ä¿¡æ¯ï¼Œç„¶åå†æ ¹æ®æŸ¥è¯¢å‡ºæ¥çš„ userInfo çš„ ID åˆ—è¡¨å»äºŒæ¬¡æŸ¥è¯¢ Address ä¿¡æ¯ï¼Œè¿™æ ·æœ€å¤šåªéœ€è¦ 2 ä¸ª SQL å°±å¯å®Œæˆå®é™…ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>é‚£ä¹ˆåå‘æ€è€ƒï¼Œé€šè¿‡ Address å¯¹è±¡æŸ¥è¯¢ UserInfo ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œå¯ä»¥å…ˆæŸ¥è¯¢å‡º List<Address>ï¼Œå†æŸ¥è¯¢å‡º List<Address>é‡Œé¢åŒ…å«çš„æ‰€æœ‰ UserInfoId åˆ—è¡¨ï¼Œç„¶åå†å»æŸ¥è¯¢ UserInfo ä¿¡æ¯ï¼Œé€šè¿‡ Map ç»„è£…åˆ° Address é‡Œé¢ã€‚</p>
<blockquote>
<p>Tipsï¼šå®ä½“é‡Œé¢å¦‚æœå…³è”å…³ç³»æœ‰éå¸¸å¤šçš„è¯·æ±‚ï¼Œæƒ³ç»´æŠ¤å…³è”å…³ç³»æ˜¯ä¸€ä»¶éå¸¸éš¾çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Mybatis çš„æ€æƒ³ã€JPA çš„å¿«æ·æŸ¥è¯¢è¯­æ³•ï¼Œæ¥ç»„è£…æƒ³è¦çš„ä»»ä½•å…³è”å…³ç³»çš„å¯¹è±¡ã€‚è¿™æ ·çš„ä»£ç è™½ç„¶æ¯”èµ·åŸç”Ÿçš„ JPA è¯­æ³•è¾ƒå¤æ‚ï¼Œä½†æ˜¯æ¯”èµ· Mybatis è¿˜æ˜¯è¦ç®€å•å¾ˆå¤šï¼Œç†è§£èµ·æ¥ä¹Ÿæ›´å®¹æ˜“ï¼Œé—®é¢˜åå€’ä¼šæ›´å°‘ä¸€ç‚¹ã€‚</p>
</blockquote>
<h3 id="EntityGraph-ä½¿ç”¨è¯¦è§£"><a href="#EntityGraph-ä½¿ç”¨è¯¦è§£" class="headerlink" title="@EntityGraph ä½¿ç”¨è¯¦è§£"></a>@EntityGraph ä½¿ç”¨è¯¦è§£</h3><p>JPA åè®®ä¹Ÿæä¾›äº†å¦å¤–ä¸€ç§è§£é¢˜æ€è·¯ï¼šåˆ©ç”¨ <code>@EntityGraph</code> æ³¨è§£æ¥è§£å†³</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå®ä½“ä¸å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»é”™ç»¼å¤æ‚ï¼Œå°±åƒä¸€ä¸ªå¤§ç½‘å›¾ä¸€æ ·ï¼Œç½‘çŠ¶åˆ†å¸ƒäº¤å‰å¼•ç”¨ã€‚è€Œ JPA åè®®åœ¨ 2.1 ç‰ˆæœ¬ä¹‹åä¼å›¾ç”¨ Entity Graph çš„æ–¹å¼ï¼Œæç»˜å‡ºä¸€ä¸ªå®ä½“ä¸å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»ã€‚</p>
<p>æ™®é€šåšæ³•ä¸ºï¼Œé€šè¿‡ @ManyToOne/@OneToMany/@ManyToMany/@OneToOne è¿™äº›å…³è”å…³ç³»æ³¨è§£è¡¨ç¤ºå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ—¶ï¼Œåªèƒ½é…ç½® EAGER æˆ–è€… LAZYï¼Œæ²¡åŠæ³•æ ¹æ®ä¸åŒçš„é…ç½®ã€ä¸åŒçš„å…³è”å…³ç³»åŠ è½½æ—¶æœºã€‚</p>
<p>è€Œ JPA åè®®ä¼å›¾é€šè¿‡ <code>@NamedEntityGraph</code> æ³¨è§£æ¥æè¿°å®ä½“ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå½“è¢« <code>@EntityGraph</code> ä½¿ç”¨çš„æ—¶å€™è¿›è¡Œ EAGER åŠ è½½ï¼Œä»¥å‡å°‘ N+1 çš„ SQLï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“ç”¨æ³•ã€‚</p>
<h4 id="NamedEntityGraph-å’Œ-EntityGraph-ç”¨æ³•"><a href="#NamedEntityGraph-å’Œ-EntityGraph-ç”¨æ³•" class="headerlink" title="@NamedEntityGraph å’Œ @EntityGraph ç”¨æ³•"></a>@NamedEntityGraph å’Œ @EntityGraph ç”¨æ³•</h4><p>è¿˜æ˜¯ç›´æ¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å¯ä»¥è¢«@NamedEntityGraphsæ³¨è§£é‡å¤ä½¿ç”¨ï¼Œåªèƒ½é…ç½®åœ¨ç±»ä¸Šé¢ï¼Œç”¨æ¥å£°æ˜ä¸åŒçš„EntityGraphï¼›</span></span><br><span class="line"><span class="meta">@Repeatable(NamedEntityGraphs.class)</span></span><br><span class="line"><span class="meta">@Target(&#123;TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NamedEntityGraph &#123;</span><br><span class="line">    <span class="comment">//æŒ‡å®šä¸€ä¸ªåå­—</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">    <span class="comment">//å“ªäº›å…³è”å…³ç³»å±æ€§å¯ä»¥è¢«EntityGraphåŒ…å«è¿›å»ï¼Œé»˜è®¤ä¸€ä¸ªæ²¡æœ‰ã€‚å¯ä»¥é…ç½®å¤šä¸ª</span></span><br><span class="line">    NamedAttributeNode[] attributeNodes() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ˜¯å¦æ‰€æœ‰çš„å…³è”å…³ç³»å±æ€§è‡ªåŠ¨åŒ…å«åœ¨å†…ï¼Œé»˜è®¤false;</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">includeAllAttributes</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é…ç½®subgraphsï¼Œå­å®ä½“å›¾(å¯ä»¥ç†è§£ä¸ºå…³è”å…³ç³»å®ä½“å›¾ï¼Œå³å¦‚æœç®—å±‚çº§ï¼Œå¯ä»¥é…ç½®ç¬¬äºŒå±‚çº§)ï¼Œå¯ä»¥è¢«NamedAttributeNodeå¼•ç”¨</span></span><br><span class="line">    NamedSubgraph[] subgraphs() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    <span class="comment">//é…ç½®subclassSubgraphsçš„namedSubgraphæœ‰å“ªäº›ã€‚å³å¦‚æœç®—å±‚çº§ï¼Œå¯ä»¥é…ç½®ç¬¬ä¸‰å±‚çº§</span></span><br><span class="line">    NamedSubgraph[] subclassSubgraphs() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>@NamedEntityGraphs</code> èƒ½å¤Ÿé…ç½®å¤šä¸ª <code>@NamedEntityGraph</code>ã€‚æ¥ç€å¾€ä¸‹çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åªèƒ½ä½¿ç”¨åœ¨å®ä½“ç±»ä¸Šé¢</span></span><br><span class="line"><span class="meta">@Target(&#123;TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NamedEntityGraphs&#123;</span><br><span class="line">    NamedEntityGraph[] value();<span class="comment">//å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªNamedEntityGraph</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼ŒNamedSubgraph ç”¨æ¥æŒ‡å®šå…³è”å…³ç³»çš„ç­–ç•¥ï¼Œä¹Ÿå°±å…³è”å…³ç³»æœ‰ä¸¤å±‚ã€‚</p>
<p>å†çœ‹ä¸€ä¸‹ <code>@NamedEntityGraph</code> é‡Œé¢çš„ NamedAttributeNode å±æ€§æœ‰å“ªäº›å€¼ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥è¿›è¡Œå±æ€§èŠ‚ç‚¹çš„æè¿°</span></span><br><span class="line"><span class="meta">@Target(&#123;&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NamedAttributeNode &#123;</span><br><span class="line">    <span class="comment">//è¦åŒ…å«çš„å…³è”å…³ç³»çš„å±æ€§çš„åå­—ï¼Œå¿…å¡«</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//å¦‚æœæˆ‘ä»¬åœ¨@NamedEntityGraphé‡Œé¢é…ç½®äº†å­å…³è”å…³ç³»ï¼Œè¿™ä¸ªæ˜¯é…ç½®subgraphçš„åå­—</span></span><br><span class="line">    <span class="function">String <span class="title">subgraph</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//å½“å…³è”å…³ç³»æ˜¯è¢«Mapç»“æ„å¼•ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®škeyçš„æ–¹å¼ï¼Œä¸€èˆ¬å¾ˆå°‘ç”¨</span></span><br><span class="line">    <span class="function">String <span class="title">keySubgraph</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢å°±æ˜¯å¯¹ <code>@NamedAttributeNode</code> çš„ä»‹ç»ï¼Œå†çœ‹ä¸€ä¸‹ <code>@EntityGraph</code> é‡Œé¢çš„ <code>@NamedSubgraph</code> çš„ç»“æ„ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NamedSubgraph &#123;</span><br><span class="line">    <span class="comment">//æŒ‡å®šä¸€ä¸ªåå­—</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//å­å…³è”å…³ç³»çš„ç±»çš„class</span></span><br><span class="line">    <span class="function">Class <span class="title">type</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">void</span>.class</span>;</span><br><span class="line">    <span class="comment">//äºŒå±‚å…³è”å…³ç³»çš„è¦åŒ…å«çš„å…³è”å…³ç³»çš„å±æ€§çš„åå­—</span></span><br><span class="line">    NamedAttributeNode[] attributeNodes();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ<code>@NamedEntityGraph</code> çš„æ³¨è§£éƒ½æ˜¯é…ç½®åœ¨å®ä½“æœ¬èº«ä¸Šé¢çš„ï¼Œè€Œ <code>@EntityGraph</code> æ˜¯ç”¨åœ¨ ***Repository æ¥å£é‡Œçš„æ–¹æ³•ä¸­çš„ã€‚</p>
<p>äº†è§£ä¸€ä¸‹ <code>@EntityGraph</code> æ³¨è§£çš„è¯­æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123; ElementType.METHOD, ElementType.ANNOTATION_TYPE &#125;)</span></span><br><span class="line"><span class="comment">//EntityGraph ä½œç”¨åœ¨Repositoryçš„æ¥å£é‡Œé¢çš„æ–¹æ³•ä¸Šé¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EntityGraph &#123;</span><br><span class="line">   <span class="comment">//æŒ‡@EntityGraphæ³¨è§£å¼•ç”¨çš„@NamedEntityGraphé‡Œé¢å®šä¹‰çš„nameï¼Œå¦‚æœæ˜¯ç©ºEntityGraphå°±ä¸ä¼šèµ·ä½œç”¨ï¼Œå¦‚æœä¸ºç©ºç›¸å½“äºæ²¡æœ‰é…ç½®ï¼›</span></span><br><span class="line">   <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">   <span class="comment">//EntityGraphçš„ç±»å‹ï¼Œé»˜è®¤æ˜¯EntityGraphType.FETCHç±»å‹</span></span><br><span class="line">   <span class="function">EntityGraphType <span class="title">type</span><span class="params">()</span> <span class="keyword">default</span> EntityGraphType.FETCH</span>;</span><br><span class="line">    <span class="comment">//å¯ä»¥æŒ‡å®šattributePathsç”¨æ¥è¦†ç›–@NamedEntityGraphé‡Œé¢çš„attributeNodesçš„é…ç½®ï¼Œé»˜è®¤é…ç½®æ˜¯ç©ºï¼Œä»¥@NamedEntityGraphé‡Œé¢çš„ä¸ºå‡†ï¼›</span></span><br><span class="line">   String[] attributePaths() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">   <span class="comment">//JPA 2.1æ”¯æŒçš„EntityGraphTypeå¯¹åº”çš„æšä¸¾å€¼</span></span><br><span class="line">   <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">EntityGraphType</span> </span>&#123;</span><br><span class="line">      <span class="comment">//LOADæ¨¡å¼ï¼Œå½“è¢«æŒ‡å®šäº†è¿™ç§æ¨¡å¼ã€è¢«@EntityGraphç®¡ç†çš„attributesçš„æ—¶å€™ï¼ŒåŸæ¥çš„FetchTypeçš„ç±»å‹ç›´æ¥å¿½ç•¥å˜æˆEageræ¨¡å¼ï¼Œè€Œä¸è¢«@EntityGraphç®¡ç†çš„attributesè¿˜æ˜¯ä¿æŒé»˜è®¤çš„FetchType</span></span><br><span class="line">      LOAD(<span class="string">&quot;javax.persistence.loadgraph&quot;</span>),</span><br><span class="line">      <span class="comment">//FETCHæ¨¡å¼ï¼Œå½“è¢«æŒ‡å®šäº†è¿™ç§æ¨¡å¼ã€è¢«@EntityGraphç®¡ç†çš„attributesçš„æ—¶å€™ï¼ŒåŸæ¥çš„FetchTypeçš„ç±»å‹ç›´æ¥å¿½ç•¥å˜æˆEageræ¨¡å¼ï¼Œè€Œä¸è¢«@EntityGraphç®¡ç†çš„attributeså°†ä¼šå˜æˆLazyæ¨¡å¼ï¼Œå’ŒLOADçš„åŒºåˆ«å°±æ˜¯å¯¹ä¸è¢«@NamedEntityGraphé…ç½®çš„å…³è”å…³ç³»çš„å±æ€§çš„FetchTypeä¸ä¸€æ ·ï¼›</span></span><br><span class="line">      FETCH(<span class="string">&quot;javax.persistence.fetchgraph&quot;</span>);</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">EntityGraphType</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">this</span>.key = value;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> key;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="EntityGraph-ä½¿ç”¨å®ä¾‹"><a href="#EntityGraph-ä½¿ç”¨å®ä¾‹" class="headerlink" title="@EntityGraph ä½¿ç”¨å®ä¾‹"></a>@EntityGraph ä½¿ç”¨å®ä¾‹</h4><p>é€šè¿‡æ”¹é€  Address å’Œ UserInfo å®ä½“ï¼Œæ¥åˆ†åˆ«æµ‹è¯•ä¸€ä¸‹ <code>@NamedEntityGraph</code> å’Œ <code>@EntityGraph</code> çš„ç”¨æ³•ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šåœ¨å®ä½“é‡Œé¢é…ç½® <code>@EntityGraph</code>ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;userInfo&quot;)</span></span><br><span class="line"><span class="comment">//è¿™é‡Œç›´æ¥ä½¿ç”¨@NamedEntityGraphï¼Œå› ä¸ºåªéœ€è¦é…ç½®ä¸€ä¸ª@NamedEntityGraphï¼ŒæŒ‡å®šä¸€ä¸ªåå­—getAllUserInfoï¼ŒæŒ‡å®šè¢«è¿™ä¸ªåå­—çš„å®ä½“è¯•å›¾å…³è”çš„å…³è”å…³ç³»å±æ€§æ˜¯userInfo</span></span><br><span class="line"><span class="meta">@NamedEntityGraph(name = &quot;getAllUserInfo&quot;,attributeNodes = @NamedAttributeNode(value = &quot;userInfo&quot;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String city;</span><br><span class="line">   <span class="meta">@JsonBackReference</span> <span class="comment">//é˜²æ­¢JSONæ­»å¾ªç¯</span></span><br><span class="line">   <span class="meta">@ManyToOne(cascade = CascadeType.PERSIST,fetch = FetchType.LAZY)</span><span class="comment">//é‡‡ç”¨é»˜è®¤çš„lazyæ¨¡å¼</span></span><br><span class="line">   <span class="keyword">private</span> UserInfo userInfo;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@ToString(exclude = &quot;addressList&quot;)</span></span><br><span class="line"><span class="comment">//UserInfoå¯¹åº”çš„å…³è”å…³ç³»ï¼Œåˆ©ç”¨@NamedEntityGraphsé…ç½®äº†ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹Addressçš„å…³è”å…³ç³»ï¼Œä¸€ä¸ªæ˜¯nameå«roomsçš„å®ä½“å›¾åŒ…å«äº†roomså±æ€§ï¼›åœ¨UserInfoé‡Œé¢å¢åŠ äº†ä¸¤ä¸ªå…³è”å…³ç³»ï¼›</span></span><br><span class="line"><span class="meta">@NamedEntityGraphs(value = &#123;@NamedEntityGraph(name = &quot;addressGraph&quot;,attributeNodes = @NamedAttributeNode(value = &quot;addressList&quot;)),@NamedEntityGraph(name = &quot;rooms&quot;,attributeNodes = @NamedAttributeNode(value = &quot;rooms&quot;))&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> String telephone;</span><br><span class="line">   <span class="keyword">private</span> Integer ages;</span><br><span class="line">   <span class="comment">//é»˜è®¤LAZYæ¨¡å¼</span></span><br><span class="line">   <span class="meta">@OneToMany(mappedBy = &quot;userInfo&quot;,cascade = CascadeType.PERSIST,fetch = FetchType.LAZY)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Address&gt; addressList;</span><br><span class="line">   <span class="comment">//é»˜è®¤EAGERæ¨¡å¼</span></span><br><span class="line">   <span class="meta">@OneToMany(cascade = CascadeType.PERSIST,fetch = FetchType.EAGER)</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;Room&gt; rooms;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ­¥ï¼šåœ¨æˆ‘ä»¬éœ€è¦çš„ *Repository çš„æ–¹æ³•ä¸Šé¢ç›´æ¥ä½¿ç”¨ <code>@EntityGraph</code>ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å› ä¸ºè¦ç”¨findAll()åšæµ‹è¯•ï¼Œæ‰€ä»¥å¯ä»¥è¦†ç›–JpaRepositoryé‡Œé¢çš„findAll()æ–¹æ³•ï¼ŒåŠ ä¸Š@EntityGraphæ³¨è§£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">UserInfo</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="comment">//æŒ‡å®šEntityGraphå¼•ç”¨çš„æ˜¯ï¼Œåœ¨UserInfoå®ä¾‹é‡Œé¢é…ç½®çš„name=addressGraphçš„NamedEntityGraphï¼›</span></span><br><span class="line">   <span class="comment">// è¿™é‡Œé‡‡ç”¨çš„æ˜¯LOADçš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¢«addressGraphé…ç½®çš„å®ä½“å›¾å±æ€§addressé‡‡ç”¨çš„fetchä¼šå˜æˆ FetchType.EAGERæ¨¡å¼ï¼Œè€Œæ²¡æœ‰è¢«addressGraphå®ä½“å›¾é…ç½®å…³è”å…³ç³»å±æ€§roomè¿˜æ˜¯é‡‡ç”¨é»˜è®¤çš„EAGERæ¨¡å¼</span></span><br><span class="line"><span class="meta">@EntityGraph(value = &quot;addressGraph&quot;,type = EntityGraph.EntityGraphType.LOAD)</span></span><br><span class="line">   <span class="function">List&lt;UserInfo&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ ·çš„é“ç†ï¼Œå…¶å¯¹äº AddressRepository ä¹Ÿæ˜¯é€‚ç”¨çš„ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AddressRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Address</span>, <span class="title">Long</span>&gt;</span>&#123;</span><br><span class="line"><span class="meta">@Override</span> <span class="comment">//å¯ä»¥è¦†ç›–åŸå§‹æ–¹æ³•ï¼Œæ·»åŠ ä¸Šä¸åŒçš„@EntityGraphç­–ç•¥</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨@EntityGraphæŸ¥è¯¢æ‰€æœ‰Addressçš„æ—¶å€™ï¼ŒæŒ‡å®šname = &quot;getAllUserInfo&quot;çš„@NamedEntityGraphï¼Œé‡‡ç”¨é»˜è®¤çš„EntityGraphType.FETCHï¼Œå¦‚æœAddressé‡Œé¢æœ‰å¤šä¸ªå…³è”å…³ç³»çš„æ—¶å€™ï¼Œåªæœ‰åœ¨name = &quot;getAllUserInfo&quot;çš„å®ä½“å›¾é…ç½®çš„userInfoå±æ€§ä¸Šé‡‡ç”¨Eageræ¨¡å¼ï¼Œå…¶ä»–å…³è”å…³ç³»å±æ€§æ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤é‡‡ç”¨LAZYæ¨¡å¼ï¼›</span></span><br><span class="line"><span class="meta">@EntityGraph(value = &quot;getAllUserInfo&quot;)</span></span><br><span class="line"><span class="function">List&lt;Address&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ­¥ï¼šçœ‹ä¸€ä¸‹ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•æ‰§è¡Œçš„ SQLã€‚</p>
<p>å†æ¬¡æ‰§è¡Œ <code>userInfoRepository.findAll();</code> è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ä¼šå‘ç°ï¼Œè¢«é…ç½® EntityGraph çš„ Address å’Œ user_info é€šè¿‡ left join ä¸€æ¡ SQL å°±æŠŠæ‰€æœ‰çš„ä¿¡æ¯éƒ½æŸ¥å‡ºæ¥äº†ï¼ŒSQL å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> userinfo0_.id                      <span class="keyword">as</span> id1_2_0_,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_1_,</span><br><span class="line">       userinfo0_.create_time             <span class="keyword">as</span> create_t2_2_0_,</span><br><span class="line">       userinfo0_.create_user_id          <span class="keyword">as</span> create_u3_2_0_,</span><br><span class="line">       userinfo0_.last_modified_time      <span class="keyword">as</span> last_mod4_2_0_,</span><br><span class="line">       userinfo0_.last_modified_user_id   <span class="keyword">as</span> last_mod5_2_0_,</span><br><span class="line">       userinfo0_.version                 <span class="keyword">as</span> version6_2_0_,</span><br><span class="line">       userinfo0_.ages                    <span class="keyword">as</span> ages7_2_0_,</span><br><span class="line">       userinfo0_.email_address           <span class="keyword">as</span> email_ad8_2_0_,</span><br><span class="line">       userinfo0_.last_name               <span class="keyword">as</span> last_nam9_2_0_,</span><br><span class="line">       userinfo0_.name                    <span class="keyword">as</span> name10_2_0_,</span><br><span class="line">       userinfo0_.telephone               <span class="keyword">as</span> telepho11_2_0_,</span><br><span class="line">       addresslis1_.create_time           <span class="keyword">as</span> create_t2_0_1_,</span><br><span class="line">       addresslis1_.create_user_id        <span class="keyword">as</span> create_u3_0_1_,</span><br><span class="line">       addresslis1_.last_modified_time    <span class="keyword">as</span> last_mod4_0_1_,</span><br><span class="line">       addresslis1_.last_modified_user_id <span class="keyword">as</span> last_mod5_0_1_,</span><br><span class="line">       addresslis1_.version               <span class="keyword">as</span> version6_0_1_,</span><br><span class="line">       addresslis1_.city                  <span class="keyword">as</span> city7_0_1_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_1_,</span><br><span class="line">       addresslis1_.user_info_id          <span class="keyword">as</span> user_inf8_0_0__,</span><br><span class="line">       addresslis1_.id                    <span class="keyword">as</span> id1_0_0__</span><br><span class="line"><span class="keyword">from</span> user_info userinfo0_</span><br><span class="line">    <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> address addresslis1_ <span class="keyword">on</span> userinfo0_.id <span class="operator">=</span> addresslis1_.user_info_id</span><br></pre></td></tr></table></figure>

<p>è€Œæ²¡æœ‰é…ç½® rooms è¿™ä¸ªå…³è”å…³ç³»çš„å±æ€§æ—¶ï¼Œrooms çš„æŸ¥è¯¢è¿˜æ˜¯ä¼šè§¦å‘ N+1 çš„ SQLã€‚</p>
<p>ä»ä¸­å¯ä»¥çœ‹åˆ° <code>@EntityGraph</code> çš„æ•ˆæœæœ‰ç‚¹ç±»ä¼¼ Hibernate é‡Œé¢æä¾›çš„ FetchModel.JOIN çš„æ¨¡å¼ï¼Œä½†ä¸åŒçš„æ˜¯ <code>@EntityGraph</code> å¯ä»¥æ­é…ä»»ä½•çš„æŸ¥è¯¢æƒ…å†µï¼Œåªéœ€è¦åœ¨æŸ¥è¯¢æ–¹æ³•ä¸Šç›´æ¥åŠ  <code>@EntityGraph</code> æ³¨è§£å³å¯ã€‚</p>
<p>è¿™ç§æ–¹æ³•è¿˜æœ‰ä¸ªä¼˜åŠ¿å°±æ˜¯ <code>@EntityGraph</code> å’Œ <code>@NamedEntityGraph</code> æ˜¯ JPA åè®®è§„å®šçš„ï¼Œè¿™æ ·å¯ä»¥å¯¹ Hibernate æ— æ„Ÿã€‚</p>
<p>é‚£ä¹ˆå†çœ‹ä¸€ä¸‹ <code>@ManyToOne</code> çš„æ¨¡å¼æ˜¯å¦åŒæ ·å¥æ•ˆï¼Œè®¿é—® <code>addressRepository.findAll()</code> è¿™ä¸ªæ–¹æ³•çœ‹ä¸€ä¸‹ SQLï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">org.hibernate.SQL                        :</span><br><span class="line"><span class="keyword">select</span> address0_.id                     <span class="keyword">as</span> id1_0_0_,</span><br><span class="line">       userinfo1_.id                    <span class="keyword">as</span> id1_2_1_,</span><br><span class="line">       address0_.create_time            <span class="keyword">as</span> create_t2_0_0_,</span><br><span class="line">       address0_.create_user_id         <span class="keyword">as</span> create_u3_0_0_,</span><br><span class="line">       address0_.last_modified_time     <span class="keyword">as</span> last_mod4_0_0_,</span><br><span class="line">       address0_.last_modified_user_id  <span class="keyword">as</span> last_mod5_0_0_,</span><br><span class="line">       address0_.version                <span class="keyword">as</span> version6_0_0_,</span><br><span class="line">       address0_.city                   <span class="keyword">as</span> city7_0_0_,</span><br><span class="line">       address0_.user_info_id           <span class="keyword">as</span> user_inf8_0_0_,</span><br><span class="line">       userinfo1_.create_time           <span class="keyword">as</span> create_t2_2_1_,</span><br><span class="line">       userinfo1_.create_user_id        <span class="keyword">as</span> create_u3_2_1_,</span><br><span class="line">       userinfo1_.last_modified_time    <span class="keyword">as</span> last_mod4_2_1_,</span><br><span class="line">       userinfo1_.last_modified_user_id <span class="keyword">as</span> last_mod5_2_1_,</span><br><span class="line">       userinfo1_.version               <span class="keyword">as</span> version6_2_1_,</span><br><span class="line">       userinfo1_.ages                  <span class="keyword">as</span> ages7_2_1_,</span><br><span class="line">       userinfo1_.email_address         <span class="keyword">as</span> email_ad8_2_1_,</span><br><span class="line">       userinfo1_.last_name             <span class="keyword">as</span> last_nam9_2_1_,</span><br><span class="line">       userinfo1_.name                  <span class="keyword">as</span> name10_2_1_,</span><br><span class="line">       userinfo1_.telephone             <span class="keyword">as</span> telepho11_2_1_</span><br><span class="line"><span class="keyword">from</span> address address0_</span><br><span class="line">         <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> user_info userinfo1_ <span class="keyword">on</span> address0_.user_info_id <span class="operator">=</span> userinfo1_.id</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° address left join çš„æ¨¡å¼ä¸­ï¼Œä¸€ä¸ª SQL æŠŠæ‰€æœ‰çš„ address å’Œ user_info éƒ½æŸ¥è¯¢å‡ºæ¥äº†ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>@EntityGraph</code> å¯ä»¥ç”¨åœ¨ä»»ä½• ***Repository çš„æŸ¥è¯¢æ–¹æ³•ä¸Šï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯é…ç½®ä¸åŒçš„å…³è”å…³ç³»ç­–ç•¥ï¼Œå°±å¯ä»¥å‡å°‘ N+1 çš„ SQLï¼Œæˆä¸ºä¸€æ¡ SQLã€‚</p>
]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title>springbootçš„properties</title>
    <url>/2019/09/30/Springboot%E7%9A%84properties/</url>
    <content><![CDATA[<h1 id="SpringbootåŸºæœ¬çš„é…ç½®"><a href="#SpringbootåŸºæœ¬çš„é…ç½®" class="headerlink" title="SpringbootåŸºæœ¬çš„é…ç½®"></a>SpringbootåŸºæœ¬çš„é…ç½®</h1><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ===================================================================</span></span><br><span class="line"><span class="comment"># COMMON SPRING BOOT PROPERTIES</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This sample file is provided as a guideline. Do NOT copy it in its</span></span><br><span class="line"><span class="comment"># entirety to your own application.               ^^^</span></span><br><span class="line"><span class="comment"># ===================================================================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># CORE PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="attr">debug</span>=<span class="string">false # Enable debug logs.</span></span><br><span class="line"><span class="attr">trace</span>=<span class="string">false # Enable trace logs.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LOGGING</span></span><br><span class="line"><span class="meta">logging.config</span>= <span class="string"># Location of the logging configuration file. For instance, `classpath:logback.xml` for Logback.</span></span><br><span class="line"><span class="meta">logging.exception-conversion-word</span>=<span class="string">%wEx # Conversion word used when logging exceptions.</span></span><br><span class="line"><span class="meta">logging.file</span>= <span class="string"># Log file name (for instance, `myapp.log`). Names can be an exact location or relative to the current directory.</span></span><br><span class="line"><span class="meta">logging.file.max-history</span>=<span class="string">0 # Maximum of archive log files to keep. Only supported with the default logback setup.</span></span><br><span class="line"><span class="meta">logging.file.max-size</span>=<span class="string">10MB # Maximum log file size. Only supported with the default logback setup.</span></span><br><span class="line"><span class="meta">logging.group.*</span>= <span class="string"># Log groups to quickly change multiple loggers at the same time. For instance, `logging.level.db=org.hibernate,org.springframework.jdbc`.</span></span><br><span class="line"><span class="meta">logging.level.*</span>= <span class="string"># Log levels severity mapping. For instance, `logging.level.org.springframework=DEBUG`.</span></span><br><span class="line"><span class="meta">logging.path</span>= <span class="string"># Location of the log file. For instance, `/var/log`.</span></span><br><span class="line"><span class="meta">logging.pattern.console</span>= <span class="string"># Appender pattern for output to the console. Supported only with the default Logback setup.</span></span><br><span class="line"><span class="meta">logging.pattern.dateformat</span>=<span class="string">yyyy-MM-dd HH:mm:ss.SSS # Appender pattern for log date format. Supported only with the default Logback setup.</span></span><br><span class="line"><span class="meta">logging.pattern.file</span>= <span class="string"># Appender pattern for output to a file. Supported only with the default Logback setup.</span></span><br><span class="line"><span class="meta">logging.pattern.level</span>=<span class="string">%5p # Appender pattern for log level. Supported only with the default Logback setup.</span></span><br><span class="line"><span class="meta">logging.register-shutdown-hook</span>=<span class="string">false # Register a shutdown hook for the logging system when it is initialized.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AOP</span></span><br><span class="line"><span class="meta">spring.aop.auto</span>=<span class="string">true # Add @EnableAspectJAutoProxy.</span></span><br><span class="line"><span class="meta">spring.aop.proxy-target-class</span>=<span class="string">true # Whether subclass-based (CGLIB) proxies are to be created (true), as opposed to standard Java interface-based proxies (false).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IDENTITY (ContextIdApplicationContextInitializer)</span></span><br><span class="line"><span class="meta">spring.application.name</span>= <span class="string"># Application name.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ADMIN (SpringApplicationAdminJmxAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.application.admin.enabled</span>=<span class="string">false # Whether to enable admin features for the application.</span></span><br><span class="line"><span class="meta">spring.application.admin.jmx-name</span>=<span class="string">org.springframework.boot:type=Admin,name=SpringApplication # JMX name of the application admin MBean.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AUTO-CONFIGURATION</span></span><br><span class="line"><span class="meta">spring.autoconfigure.exclude</span>= <span class="string"># Auto-configuration classes to exclude.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BANNER</span></span><br><span class="line"><span class="meta">spring.banner.charset</span>=<span class="string">UTF-8 # Banner file encoding.</span></span><br><span class="line"><span class="meta">spring.banner.location</span>=<span class="string">classpath:banner.txt # Banner text resource location.</span></span><br><span class="line"><span class="meta">spring.banner.image.location</span>=<span class="string">classpath:banner.gif # Banner image file location (jpg or png can also be used).</span></span><br><span class="line"><span class="meta">spring.banner.image.width</span>=<span class="string">76 # Width of the banner image in chars.</span></span><br><span class="line"><span class="meta">spring.banner.image.height</span>= <span class="string"># Height of the banner image in chars (default based on image height).</span></span><br><span class="line"><span class="meta">spring.banner.image.margin</span>=<span class="string">2 # Left hand image margin in chars.</span></span><br><span class="line"><span class="meta">spring.banner.image.invert</span>=<span class="string">false # Whether images should be inverted for dark terminal themes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING CORE</span></span><br><span class="line"><span class="meta">spring.beaninfo.ignore</span>=<span class="string">true # Whether to skip search of BeanInfo classes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING CACHE (CacheProperties)</span></span><br><span class="line"><span class="meta">spring.cache.cache-names</span>= <span class="string"># Comma-separated list of cache names to create if supported by the underlying cache manager.</span></span><br><span class="line"><span class="meta">spring.cache.caffeine.spec</span>= <span class="string"># The spec to use to create caches. See CaffeineSpec for more details on the spec format.</span></span><br><span class="line"><span class="meta">spring.cache.couchbase.expiration</span>= <span class="string"># Entry expiration. By default the entries never expire. Note that this value is ultimately converted to seconds.</span></span><br><span class="line"><span class="meta">spring.cache.ehcache.config</span>= <span class="string"># The location of the configuration file to use to initialize EhCache.</span></span><br><span class="line"><span class="meta">spring.cache.infinispan.config</span>= <span class="string"># The location of the configuration file to use to initialize Infinispan.</span></span><br><span class="line"><span class="meta">spring.cache.jcache.config</span>= <span class="string"># The location of the configuration file to use to initialize the cache manager.</span></span><br><span class="line"><span class="meta">spring.cache.jcache.provider</span>= <span class="string"># Fully qualified name of the CachingProvider implementation to use to retrieve the JSR-107 compliant cache manager. Needed only if more than one JSR-107 implementation is available on the classpath.</span></span><br><span class="line"><span class="meta">spring.cache.redis.cache-null-values</span>=<span class="string">true # Allow caching null values.</span></span><br><span class="line"><span class="meta">spring.cache.redis.key-prefix</span>= <span class="string"># Key prefix.</span></span><br><span class="line"><span class="meta">spring.cache.redis.time-to-live</span>= <span class="string"># Entry expiration. By default the entries never expire.</span></span><br><span class="line"><span class="meta">spring.cache.redis.use-key-prefix</span>=<span class="string">true # Whether to use the key prefix when writing to Redis.</span></span><br><span class="line"><span class="meta">spring.cache.type</span>= <span class="string"># Cache type. By default, auto-detected according to the environment.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING CONFIG - using environment property only (ConfigFileApplicationListener)</span></span><br><span class="line"><span class="meta">spring.config.additional-location</span>= <span class="string"># Config file locations used in addition to the defaults.</span></span><br><span class="line"><span class="meta">spring.config.location</span>= <span class="string"># Config file locations that replace the defaults.</span></span><br><span class="line"><span class="meta">spring.config.name</span>=<span class="string">application # Config file name.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HAZELCAST (HazelcastProperties)</span></span><br><span class="line"><span class="meta">spring.hazelcast.config</span>= <span class="string"># The location of the configuration file to use to initialize Hazelcast.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PROJECT INFORMATION (ProjectInfoProperties)</span></span><br><span class="line"><span class="meta">spring.info.build.encoding</span>=<span class="string">UTF-8 # File encoding.</span></span><br><span class="line"><span class="meta">spring.info.build.location</span>=<span class="string">classpath:META-INF/build-info.properties # Location of the generated build-info.properties file.</span></span><br><span class="line"><span class="meta">spring.info.git.encoding</span>=<span class="string">UTF-8 # File encoding.</span></span><br><span class="line"><span class="meta">spring.info.git.location</span>=<span class="string">classpath:git.properties # Location of the generated git.properties file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JMX</span></span><br><span class="line"><span class="meta">spring.jmx.default-domain</span>= <span class="string"># JMX domain name.</span></span><br><span class="line"><span class="meta">spring.jmx.enabled</span>=<span class="string">true # Expose management beans to the JMX domain.</span></span><br><span class="line"><span class="meta">spring.jmx.server</span>=<span class="string">mbeanServer # MBeanServer bean name.</span></span><br><span class="line"><span class="meta">spring.jmx.unique-names</span>=<span class="string">false # Whether unique runtime object names should be ensured.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Email (MailProperties)</span></span><br><span class="line"><span class="meta">spring.mail.default-encoding</span>=<span class="string">UTF-8 # Default MimeMessage encoding.</span></span><br><span class="line"><span class="meta">spring.mail.host</span>= <span class="string"># SMTP server host. For instance, `smtp.example.com`.</span></span><br><span class="line"><span class="meta">spring.mail.jndi-name</span>= <span class="string"># Session JNDI name. When set, takes precedence over other Session settings.</span></span><br><span class="line"><span class="meta">spring.mail.password</span>= <span class="string"># Login password of the SMTP server.</span></span><br><span class="line"><span class="meta">spring.mail.port</span>= <span class="string"># SMTP server port.</span></span><br><span class="line"><span class="meta">spring.mail.properties.*</span>= <span class="string"># Additional JavaMail Session properties.</span></span><br><span class="line"><span class="meta">spring.mail.protocol</span>=<span class="string">smtp # Protocol used by the SMTP server.</span></span><br><span class="line"><span class="meta">spring.mail.test-connection</span>=<span class="string">false # Whether to test that the mail server is available on startup.</span></span><br><span class="line"><span class="meta">spring.mail.username</span>= <span class="string"># Login user of the SMTP server.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># APPLICATION SETTINGS (SpringApplication)</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">false # Whether bean definition overriding, by registering a definition with the same name as an existing definition, is allowed.</span></span><br><span class="line"><span class="meta">spring.main.banner-mode</span>=<span class="string">console # Mode used to display the banner when the application runs.</span></span><br><span class="line"><span class="meta">spring.main.sources</span>= <span class="string"># Sources (class names, package names, or XML resource locations) to include in the ApplicationContext.</span></span><br><span class="line"><span class="meta">spring.main.web-application-type</span>= <span class="string"># Flag to explicitly request a specific type of web application. If not set, auto-detected based on the classpath.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FILE ENCODING (FileEncodingApplicationListener)</span></span><br><span class="line"><span class="meta">spring.mandatory-file-encoding</span>= <span class="string"># Expected character encoding the application must use.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># INTERNATIONALIZATION (MessageSourceProperties)</span></span><br><span class="line"><span class="meta">spring.messages.always-use-message-format</span>=<span class="string">false # Whether to always apply the MessageFormat rules, parsing even messages without arguments.</span></span><br><span class="line"><span class="meta">spring.messages.basename</span>=<span class="string">messages # Comma-separated list of basenames (essentially a fully-qualified classpath location), each following the ResourceBundle convention with relaxed support for slash based locations.</span></span><br><span class="line"><span class="meta">spring.messages.cache-duration</span>= <span class="string"># Loaded resource bundle files cache duration. When not set, bundles are cached forever. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.messages.encoding</span>=<span class="string">UTF-8 # Message bundles encoding.</span></span><br><span class="line"><span class="meta">spring.messages.fallback-to-system-locale</span>=<span class="string">true # Whether to fall back to the system Locale if no files for a specific Locale have been found.</span></span><br><span class="line"><span class="meta">spring.messages.use-code-as-default-message</span>=<span class="string">false # Whether to use the message code as the default message instead of throwing a &quot;NoSuchMessageException&quot;. Recommended during development only.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OUTPUT</span></span><br><span class="line"><span class="meta">spring.output.ansi.enabled</span>=<span class="string">detect # Configures the ANSI output.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PID FILE (ApplicationPidFileWriter)</span></span><br><span class="line"><span class="meta">spring.pid.fail-on-write-error</span>= <span class="string"># Fails if ApplicationPidFileWriter is used but it cannot write the PID file.</span></span><br><span class="line"><span class="meta">spring.pid.file</span>= <span class="string"># Location of the PID file to write (if ApplicationPidFileWriter is used).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PROFILES</span></span><br><span class="line"><span class="meta">spring.profiles.active</span>= <span class="string"># Comma-separated list of active profiles. Can be overridden by a command line switch.</span></span><br><span class="line"><span class="meta">spring.profiles.include</span>= <span class="string"># Unconditionally activate the specified comma-separated list of profiles (or list of profiles if using YAML).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># QUARTZ SCHEDULER (QuartzProperties)</span></span><br><span class="line"><span class="meta">spring.quartz.auto-startup</span>=<span class="string">true # Whether to automatically start the scheduler after initialization.</span></span><br><span class="line"><span class="meta">spring.quartz.jdbc.comment-prefix</span>=<span class="string">-- # Prefix for single-line comments in SQL initialization scripts.</span></span><br><span class="line"><span class="meta">spring.quartz.jdbc.initialize-schema</span>=<span class="string">embedded # Database schema initialization mode.</span></span><br><span class="line"><span class="meta">spring.quartz.jdbc.schema</span>=<span class="string">classpath:org/quartz/impl/jdbcjobstore/tables_@@platform@@.sql # Path to the SQL file to use to initialize the database schema.</span></span><br><span class="line"><span class="meta">spring.quartz.job-store-type</span>=<span class="string">memory # Quartz job store type.</span></span><br><span class="line"><span class="meta">spring.quartz.overwrite-existing-jobs</span>=<span class="string">false # Whether configured jobs should overwrite existing job definitions.</span></span><br><span class="line"><span class="meta">spring.quartz.properties.*</span>= <span class="string"># Additional Quartz Scheduler properties.</span></span><br><span class="line"><span class="meta">spring.quartz.scheduler-name</span>=<span class="string">quartzScheduler # Name of the scheduler.</span></span><br><span class="line"><span class="meta">spring.quartz.startup-delay</span>=<span class="string">0s # Delay after which the scheduler is started once initialization completes.</span></span><br><span class="line"><span class="meta">spring.quartz.wait-for-jobs-to-complete-on-shutdown</span>=<span class="string">false # Whether to wait for running jobs to complete on shutdown.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># REACTOR (ReactorCoreProperties)</span></span><br><span class="line"><span class="meta">spring.reactor.stacktrace-mode.enabled</span>=<span class="string">false # Whether Reactor should collect stacktrace information at runtime.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SENDGRID (SendGridAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.sendgrid.api-key</span>= <span class="string"># SendGrid API key.</span></span><br><span class="line"><span class="meta">spring.sendgrid.proxy.host</span>= <span class="string"># SendGrid proxy host.</span></span><br><span class="line"><span class="meta">spring.sendgrid.proxy.port</span>= <span class="string"># SendGrid proxy port.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TASK EXECUTION  (TaskExecutionProperties)</span></span><br><span class="line"><span class="meta">spring.task.execution.pool.allow-core-thread-timeout</span>=<span class="string">true # Whether core threads are allowed to time out. This enables dynamic growing and shrinking of the pool.</span></span><br><span class="line"><span class="meta">spring.task.execution.pool.core-size</span>=<span class="string">8 # Core number of threads.</span></span><br><span class="line"><span class="meta">spring.task.execution.pool.keep-alive</span>=<span class="string">60s # Time limit for which threads may remain idle before being terminated.</span></span><br><span class="line"><span class="meta">spring.task.execution.pool.max-size</span>= <span class="string"># Maximum allowed number of threads. If tasks are filling up the queue, the pool can expand up to that size to accommodate the load. Ignored if the queue is unbounded.</span></span><br><span class="line"><span class="meta">spring.task.execution.pool.queue-capacity</span>= <span class="string"># Queue capacity. An unbounded capacity does not increase the pool and therefore ignores the &quot;max-size&quot; property.</span></span><br><span class="line"><span class="meta">spring.task.execution.thread-name-prefix</span>=<span class="string">task- # Prefix to use for the names of newly created threads.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TASK SCHEDULING  (TaskSchedulingProperties)</span></span><br><span class="line"><span class="meta">spring.task.scheduling.pool.size</span>=<span class="string">1 # Maximum allowed number of threads.</span></span><br><span class="line"><span class="meta">spring.task.scheduling.thread-name-prefix</span>=<span class="string">scheduling- # Prefix to use for the names of newly created threads.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># WEB PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EMBEDDED SERVER CONFIGURATION (ServerProperties)</span></span><br><span class="line"><span class="meta">server.address</span>= <span class="string"># Network address to which the server should bind.</span></span><br><span class="line"><span class="meta">server.compression.enabled</span>=<span class="string">false # Whether response compression is enabled.</span></span><br><span class="line"><span class="meta">server.compression.excluded-user-agents</span>= <span class="string"># Comma-separated list of user agents for which responses should not be compressed.</span></span><br><span class="line"><span class="meta">server.compression.mime-types</span>=<span class="string">text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml # Comma-separated list of MIME types that should be compressed.</span></span><br><span class="line"><span class="meta">server.compression.min-response-size</span>=<span class="string">2KB # Minimum &quot;Content-Length&quot; value that is required for compression to be performed.</span></span><br><span class="line"><span class="meta">server.connection-timeout</span>= <span class="string"># Time that connectors wait for another HTTP request before closing the connection. When not set, the connector&#x27;s container-specific default is used. Use a value of -1 to indicate no (that is, an infinite) timeout.</span></span><br><span class="line"><span class="meta">server.error.include-exception</span>=<span class="string">false # Include the &quot;exception&quot; attribute.</span></span><br><span class="line"><span class="meta">server.error.include-stacktrace</span>=<span class="string">never # When to include a &quot;stacktrace&quot; attribute.</span></span><br><span class="line"><span class="meta">server.error.path</span>=<span class="string">/error # Path of the error controller.</span></span><br><span class="line"><span class="meta">server.error.whitelabel.enabled</span>=<span class="string">true # Whether to enable the default error page displayed in browsers in case of a server error.</span></span><br><span class="line"><span class="meta">server.http2.enabled</span>=<span class="string">false # Whether to enable HTTP/2 support, if the current environment supports it.</span></span><br><span class="line"><span class="meta">server.jetty.acceptors</span>=<span class="string">-1 # Number of acceptor threads to use. When the value is -1, the default, the number of acceptors is derived from the operating environment.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.append</span>=<span class="string">false # Append to log.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.date-format</span>=<span class="string">dd/MMM/yyyy:HH:mm:ss Z # Timestamp format of the request log.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.enabled</span>=<span class="string">false # Enable access log.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.extended-format</span>=<span class="string">false # Enable extended NCSA format.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.file-date-format</span>= <span class="string"># Date format to place in log file name.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.filename</span>= <span class="string"># Log filename. If not specified, logs redirect to &quot;System.err&quot;.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.locale</span>= <span class="string"># Locale of the request log.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.log-cookies</span>=<span class="string">false # Enable logging of the request cookies.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.log-latency</span>=<span class="string">false # Enable logging of request processing time.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.log-server</span>=<span class="string">false # Enable logging of the request hostname.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.retention-period</span>=<span class="string">31 # Number of days before rotated log files are deleted.</span></span><br><span class="line"><span class="meta">server.jetty.accesslog.time-zone</span>=<span class="string">GMT # Timezone of the request log.</span></span><br><span class="line"><span class="meta">server.jetty.max-http-post-size</span>=<span class="string">200000B # Maximum size of the HTTP post or put content.</span></span><br><span class="line"><span class="meta">server.jetty.selectors</span>=<span class="string">-1 # Number of selector threads to use. When the value is -1, the default, the number of selectors is derived from the operating environment.</span></span><br><span class="line"><span class="meta">server.max-http-header-size</span>=<span class="string">8KB # Maximum size of the HTTP message header.</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">8080 # Server HTTP port.</span></span><br><span class="line"><span class="meta">server.server-header</span>= <span class="string"># Value to use for the Server response header (if empty, no header is sent).</span></span><br><span class="line"><span class="meta">server.use-forward-headers</span>= <span class="string"># Whether X-Forwarded-* headers should be applied to the HttpRequest.</span></span><br><span class="line"><span class="meta">server.servlet.context-parameters.*</span>= <span class="string"># Servlet context init parameters.</span></span><br><span class="line"><span class="meta">server.servlet.context-path</span>= <span class="string"># Context path of the application.</span></span><br><span class="line"><span class="meta">server.servlet.application-display-name</span>=<span class="string">application # Display name of the application.</span></span><br><span class="line"><span class="meta">server.servlet.jsp.class-name</span>=<span class="string">org.apache.jasper.servlet.JspServlet # Class name of the servlet to use for JSPs.</span></span><br><span class="line"><span class="meta">server.servlet.jsp.init-parameters.*</span>= <span class="string"># Init parameters used to configure the JSP servlet.</span></span><br><span class="line"><span class="meta">server.servlet.jsp.registered</span>=<span class="string">true # Whether the JSP servlet is registered.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.comment</span>= <span class="string"># Comment for the session cookie.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.domain</span>= <span class="string"># Domain for the session cookie.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.http-only</span>= <span class="string"># Whether to use &quot;HttpOnly&quot; cookies for session cookies.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.max-age</span>= <span class="string"># Maximum age of the session cookie. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.name</span>= <span class="string"># Session cookie name.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.path</span>= <span class="string"># Path of the session cookie.</span></span><br><span class="line"><span class="meta">server.servlet.session.cookie.secure</span>= <span class="string"># Whether to always mark the session cookie as secure.</span></span><br><span class="line"><span class="meta">server.servlet.session.persistent</span>=<span class="string">false # Whether to persist session data between restarts.</span></span><br><span class="line"><span class="meta">server.servlet.session.store-dir</span>= <span class="string"># Directory used to store session data.</span></span><br><span class="line"><span class="meta">server.servlet.session.timeout</span>=<span class="string">30m # Session timeout. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">server.servlet.session.tracking-modes</span>= <span class="string"># Session tracking modes.</span></span><br><span class="line"><span class="meta">server.ssl.ciphers</span>= <span class="string"># Supported SSL ciphers.</span></span><br><span class="line"><span class="meta">server.ssl.client-auth</span>= <span class="string"># Client authentication mode.</span></span><br><span class="line"><span class="meta">server.ssl.enabled</span>=<span class="string">true # Whether to enable SSL support.</span></span><br><span class="line"><span class="meta">server.ssl.enabled-protocols</span>= <span class="string"># Enabled SSL protocols.</span></span><br><span class="line"><span class="meta">server.ssl.key-alias</span>= <span class="string"># Alias that identifies the key in the key store.</span></span><br><span class="line"><span class="meta">server.ssl.key-password</span>= <span class="string"># Password used to access the key in the key store.</span></span><br><span class="line"><span class="meta">server.ssl.key-store</span>= <span class="string"># Path to the key store that holds the SSL certificate (typically a jks file).</span></span><br><span class="line"><span class="meta">server.ssl.key-store-password</span>= <span class="string"># Password used to access the key store.</span></span><br><span class="line"><span class="meta">server.ssl.key-store-provider</span>= <span class="string"># Provider for the key store.</span></span><br><span class="line"><span class="meta">server.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">server.ssl.protocol</span>=<span class="string">TLS # SSL protocol to use.</span></span><br><span class="line"><span class="meta">server.ssl.trust-store</span>= <span class="string"># Trust store that holds SSL certificates.</span></span><br><span class="line"><span class="meta">server.ssl.trust-store-password</span>= <span class="string"># Password used to access the trust store.</span></span><br><span class="line"><span class="meta">server.ssl.trust-store-provider</span>= <span class="string"># Provider for the trust store.</span></span><br><span class="line"><span class="meta">server.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"><span class="meta">server.tomcat.accept-count</span>=<span class="string">100 # Maximum queue length for incoming connection requests when all possible request processing threads are in use.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.buffered</span>=<span class="string">true # Whether to buffer output such that it is flushed only periodically.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.directory</span>=<span class="string">logs # Directory in which log files are created. Can be absolute or relative to the Tomcat base dir.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.enabled</span>=<span class="string">false # Enable access log.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.file-date-format</span>=<span class="string">.yyyy-MM-dd # Date format to place in the log file name.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.pattern</span>=<span class="string">common # Format pattern for access logs.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.prefix</span>=<span class="string">access_log # Log file name prefix.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.rename-on-rotate</span>=<span class="string">false # Whether to defer inclusion of the date stamp in the file name until rotate time.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.request-attributes-enabled</span>=<span class="string">false # Set request attributes for the IP address, Hostname, protocol, and port used for the request.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.rotate</span>=<span class="string">true # Whether to enable access log rotation.</span></span><br><span class="line"><span class="meta">server.tomcat.accesslog.suffix</span>=<span class="string">.log # Log file name suffix.</span></span><br><span class="line"><span class="meta">server.tomcat.additional-tld-skip-patterns</span>= <span class="string"># Comma-separated list of additional patterns that match jars to ignore for TLD scanning.</span></span><br><span class="line"><span class="meta">server.tomcat.background-processor-delay</span>=<span class="string">10s # Delay between the invocation of backgroundProcess methods. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">server.tomcat.basedir</span>= <span class="string"># Tomcat base directory. If not specified, a temporary directory is used.</span></span><br><span class="line"><span class="meta">server.tomcat.internal-proxies</span>=<span class="string">10\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\</span></span><br><span class="line">		<span class="attr">192\\.168\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\</span></span><br><span class="line">		<span class="attr">169\\.254\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\</span></span><br><span class="line">		<span class="attr">127\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\</span></span><br><span class="line">		<span class="attr">172\\.1[6-9]&#123;1&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\</span></span><br><span class="line">		<span class="attr">172\\.2[0-9]&#123;1&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\</span></span><br><span class="line">		<span class="attr">172\\.3[0-1]&#123;1&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\</span></span><br><span class="line">		<span class="attr">0</span>:<span class="string">0:0:0:0:0:0:1\\</span></span><br><span class="line">		::1 # Regular expression that matches proxies that are to be trusted.</span><br><span class="line"><span class="meta">server.tomcat.max-connections</span>=<span class="string">10000 # Maximum number of connections that the server accepts and processes at any given time.</span></span><br><span class="line"><span class="meta">server.tomcat.max-http-post-size</span>=<span class="string">2MB # Maximum size of the HTTP post content.</span></span><br><span class="line"><span class="meta">server.tomcat.max-swallow-size</span>=<span class="string">2MB # Maximum amount of request body to swallow.</span></span><br><span class="line"><span class="meta">server.tomcat.max-threads</span>=<span class="string">200 # Maximum amount of worker threads.</span></span><br><span class="line"><span class="meta">server.tomcat.min-spare-threads</span>=<span class="string">10 # Minimum amount of worker threads.</span></span><br><span class="line"><span class="meta">server.tomcat.port-header</span>=<span class="string">X-Forwarded-Port # Name of the HTTP header used to override the original port value.</span></span><br><span class="line"><span class="meta">server.tomcat.protocol-header</span>= <span class="string"># Header that holds the incoming protocol, usually named &quot;X-Forwarded-Proto&quot;.</span></span><br><span class="line"><span class="meta">server.tomcat.protocol-header-https-value</span>=<span class="string">https # Value of the protocol header indicating whether the incoming request uses SSL.</span></span><br><span class="line"><span class="meta">server.tomcat.redirect-context-root</span>=<span class="string">true # Whether requests to the context root should be redirected by appending a / to the path.</span></span><br><span class="line"><span class="meta">server.tomcat.remote-ip-header</span>= <span class="string"># Name of the HTTP header from which the remote IP is extracted. For instance, `X-FORWARDED-FOR`.</span></span><br><span class="line"><span class="meta">server.tomcat.resource.allow-caching</span>=<span class="string">true # Whether static resource caching is permitted for this web application.</span></span><br><span class="line"><span class="meta">server.tomcat.resource.cache-ttl</span>= <span class="string"># Time-to-live of the static resource cache.</span></span><br><span class="line"><span class="meta">server.tomcat.uri-encoding</span>=<span class="string">UTF-8 # Character encoding to use to decode the URI.</span></span><br><span class="line"><span class="meta">server.tomcat.use-relative-redirects</span>= <span class="string"># Whether HTTP 1.1 and later location headers generated by a call to sendRedirect will use relative or absolute redirects.</span></span><br><span class="line"><span class="meta">server.undertow.accesslog.dir</span>= <span class="string"># Undertow access log directory.</span></span><br><span class="line"><span class="meta">server.undertow.accesslog.enabled</span>=<span class="string">false # Whether to enable the access log.</span></span><br><span class="line"><span class="meta">server.undertow.accesslog.pattern</span>=<span class="string">common # Format pattern for access logs.</span></span><br><span class="line"><span class="meta">server.undertow.accesslog.prefix</span>=<span class="string">access_log. # Log file name prefix.</span></span><br><span class="line"><span class="meta">server.undertow.accesslog.rotate</span>=<span class="string">true # Whether to enable access log rotation.</span></span><br><span class="line"><span class="meta">server.undertow.accesslog.suffix</span>=<span class="string">log # Log file name suffix.</span></span><br><span class="line"><span class="meta">server.undertow.buffer-size</span>= <span class="string"># Size of each buffer.</span></span><br><span class="line"><span class="meta">server.undertow.direct-buffers</span>= <span class="string"># Whether to allocate buffers outside the Java heap. The default is derived from the maximum amount of memory that is available to the JVM.</span></span><br><span class="line"><span class="meta">server.undertow.eager-filter-init</span>=<span class="string">true # Whether servlet filters should be initialized on startup.</span></span><br><span class="line"><span class="meta">server.undertow.io-threads</span>= <span class="string"># Number of I/O threads to create for the worker. The default is derived from the number of available processors.</span></span><br><span class="line"><span class="meta">server.undertow.max-http-post-size</span>=<span class="string">-1B # Maximum size of the HTTP post content. When the value is -1, the default, the size is unlimited.</span></span><br><span class="line"><span class="meta">server.undertow.worker-threads</span>= <span class="string"># Number of worker threads. The default is 8 times the number of I/O threads.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FREEMARKER (FreeMarkerProperties)</span></span><br><span class="line"><span class="meta">spring.freemarker.allow-request-override</span>=<span class="string">false # Whether HttpServletRequest attributes are allowed to override (hide) controller generated model attributes of the same name.</span></span><br><span class="line"><span class="meta">spring.freemarker.allow-session-override</span>=<span class="string">false # Whether HttpSession attributes are allowed to override (hide) controller generated model attributes of the same name.</span></span><br><span class="line"><span class="meta">spring.freemarker.cache</span>=<span class="string">false # Whether to enable template caching.</span></span><br><span class="line"><span class="meta">spring.freemarker.charset</span>=<span class="string">UTF-8 # Template encoding.</span></span><br><span class="line"><span class="meta">spring.freemarker.check-template-location</span>=<span class="string">true # Whether to check that the templates location exists.</span></span><br><span class="line"><span class="meta">spring.freemarker.content-type</span>=<span class="string">text/html # Content-Type value.</span></span><br><span class="line"><span class="meta">spring.freemarker.enabled</span>=<span class="string">true # Whether to enable MVC view resolution for this technology.</span></span><br><span class="line"><span class="meta">spring.freemarker.expose-request-attributes</span>=<span class="string">false # Whether all request attributes should be added to the model prior to merging with the template.</span></span><br><span class="line"><span class="meta">spring.freemarker.expose-session-attributes</span>=<span class="string">false # Whether all HttpSession attributes should be added to the model prior to merging with the template.</span></span><br><span class="line"><span class="meta">spring.freemarker.expose-spring-macro-helpers</span>=<span class="string">true # Whether to expose a RequestContext for use by Spring&#x27;s macro library, under the name &quot;springMacroRequestContext&quot;.</span></span><br><span class="line"><span class="meta">spring.freemarker.prefer-file-system-access</span>=<span class="string">true # Whether to prefer file system access for template loading. File system access enables hot detection of template changes.</span></span><br><span class="line"><span class="meta">spring.freemarker.prefix</span>= <span class="string"># Prefix that gets prepended to view names when building a URL.</span></span><br><span class="line"><span class="meta">spring.freemarker.request-context-attribute</span>= <span class="string"># Name of the RequestContext attribute for all views.</span></span><br><span class="line"><span class="meta">spring.freemarker.settings.*</span>= <span class="string"># Well-known FreeMarker keys which are passed to FreeMarker&#x27;s Configuration.</span></span><br><span class="line"><span class="meta">spring.freemarker.suffix</span>=<span class="string">.ftl # Suffix that gets appended to view names when building a URL.</span></span><br><span class="line"><span class="meta">spring.freemarker.template-loader-path</span>=<span class="string">classpath:/templates/ # Comma-separated list of template paths.</span></span><br><span class="line"><span class="meta">spring.freemarker.view-names</span>= <span class="string"># White list of view names that can be resolved.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GROOVY TEMPLATES (GroovyTemplateProperties)</span></span><br><span class="line"><span class="meta">spring.groovy.template.allow-request-override</span>=<span class="string">false # Whether HttpServletRequest attributes are allowed to override (hide) controller generated model attributes of the same name.</span></span><br><span class="line"><span class="meta">spring.groovy.template.allow-session-override</span>=<span class="string">false # Whether HttpSession attributes are allowed to override (hide) controller generated model attributes of the same name.</span></span><br><span class="line"><span class="meta">spring.groovy.template.cache</span>=<span class="string">false # Whether to enable template caching.</span></span><br><span class="line"><span class="meta">spring.groovy.template.charset</span>=<span class="string">UTF-8 # Template encoding.</span></span><br><span class="line"><span class="meta">spring.groovy.template.check-template-location</span>=<span class="string">true # Whether to check that the templates location exists.</span></span><br><span class="line"><span class="meta">spring.groovy.template.configuration.*</span>= <span class="string"># See GroovyMarkupConfigurer</span></span><br><span class="line"><span class="meta">spring.groovy.template.content-type</span>=<span class="string">text/html # Content-Type value.</span></span><br><span class="line"><span class="meta">spring.groovy.template.enabled</span>=<span class="string">true # Whether to enable MVC view resolution for this technology.</span></span><br><span class="line"><span class="meta">spring.groovy.template.expose-request-attributes</span>=<span class="string">false # Whether all request attributes should be added to the model prior to merging with the template.</span></span><br><span class="line"><span class="meta">spring.groovy.template.expose-session-attributes</span>=<span class="string">false # Whether all HttpSession attributes should be added to the model prior to merging with the template.</span></span><br><span class="line"><span class="meta">spring.groovy.template.expose-spring-macro-helpers</span>=<span class="string">true # Whether to expose a RequestContext for use by Spring&#x27;s macro library, under the name &quot;springMacroRequestContext&quot;.</span></span><br><span class="line"><span class="meta">spring.groovy.template.prefix</span>= <span class="string"># Prefix that gets prepended to view names when building a URL.</span></span><br><span class="line"><span class="meta">spring.groovy.template.request-context-attribute</span>= <span class="string"># Name of the RequestContext attribute for all views.</span></span><br><span class="line"><span class="meta">spring.groovy.template.resource-loader-path</span>=<span class="string">classpath:/templates/ # Template path.</span></span><br><span class="line"><span class="meta">spring.groovy.template.suffix</span>=<span class="string">.tpl # Suffix that gets appended to view names when building a URL.</span></span><br><span class="line"><span class="meta">spring.groovy.template.view-names</span>= <span class="string"># White list of view names that can be resolved.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING HATEOAS (HateoasProperties)</span></span><br><span class="line"><span class="meta">spring.hateoas.use-hal-as-default-json-media-type</span>=<span class="string">true # Whether application/hal+json responses should be sent to requests that accept application/json.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP (HttpProperties)</span></span><br><span class="line"><span class="meta">spring.http.converters.preferred-json-mapper</span>= <span class="string"># Preferred JSON mapper to use for HTTP message conversion. By default, auto-detected according to the environment.</span></span><br><span class="line"><span class="meta">spring.http.encoding.charset</span>=<span class="string">UTF-8 # Charset of HTTP requests and responses. Added to the &quot;Content-Type&quot; header if not set explicitly.</span></span><br><span class="line"><span class="meta">spring.http.encoding.enabled</span>=<span class="string">true # Whether to enable http encoding support.</span></span><br><span class="line"><span class="meta">spring.http.encoding.force</span>= <span class="string"># Whether to force the encoding to the configured charset on HTTP requests and responses.</span></span><br><span class="line"><span class="meta">spring.http.encoding.force-request</span>= <span class="string"># Whether to force the encoding to the configured charset on HTTP requests. Defaults to true when &quot;force&quot; has not been specified.</span></span><br><span class="line"><span class="meta">spring.http.encoding.force-response</span>= <span class="string"># Whether to force the encoding to the configured charset on HTTP responses.</span></span><br><span class="line"><span class="meta">spring.http.encoding.mapping</span>= <span class="string"># Locale in which to encode mapping.</span></span><br><span class="line"><span class="meta">spring.http.log-request-details</span>=<span class="string">false # Whether logging of (potentially sensitive) request details at DEBUG and TRACE level is allowed.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MULTIPART (MultipartProperties)</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.enabled</span>=<span class="string">true # Whether to enable support of multipart uploads.</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.file-size-threshold</span>=<span class="string">0B # Threshold after which files are written to disk.</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.location</span>= <span class="string"># Intermediate location of uploaded files.</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.max-file-size</span>=<span class="string">1MB # Max file size.</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.max-request-size</span>=<span class="string">10MB # Max request size.</span></span><br><span class="line"><span class="meta">spring.servlet.multipart.resolve-lazily</span>=<span class="string">false # Whether to resolve the multipart request lazily at the time of file or parameter access.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JACKSON (JacksonProperties)</span></span><br><span class="line"><span class="meta">spring.jackson.date-format</span>= <span class="string"># Date format string or a fully-qualified date format class name. For instance, `yyyy-MM-dd HH:mm:ss`.</span></span><br><span class="line"><span class="meta">spring.jackson.default-property-inclusion</span>= <span class="string"># Controls the inclusion of properties during serialization. Configured with one of the values in Jackson&#x27;s JsonInclude.Include enumeration.</span></span><br><span class="line"><span class="meta">spring.jackson.deserialization.*</span>= <span class="string"># Jackson on/off features that affect the way Java objects are deserialized.</span></span><br><span class="line"><span class="meta">spring.jackson.generator.*</span>= <span class="string"># Jackson on/off features for generators.</span></span><br><span class="line"><span class="meta">spring.jackson.joda-date-time-format</span>= <span class="string"># Joda date time format string. If not configured, &quot;date-format&quot; is used as a fallback if it is configured with a format string.</span></span><br><span class="line"><span class="meta">spring.jackson.locale</span>= <span class="string"># Locale used for formatting.</span></span><br><span class="line"><span class="meta">spring.jackson.mapper.*</span>= <span class="string"># Jackson general purpose on/off features.</span></span><br><span class="line"><span class="meta">spring.jackson.parser.*</span>= <span class="string"># Jackson on/off features for parsers.</span></span><br><span class="line"><span class="meta">spring.jackson.property-naming-strategy</span>= <span class="string"># One of the constants on Jackson&#x27;s PropertyNamingStrategy. Can also be a fully-qualified class name of a PropertyNamingStrategy subclass.</span></span><br><span class="line"><span class="meta">spring.jackson.serialization.*</span>= <span class="string"># Jackson on/off features that affect the way Java objects are serialized.</span></span><br><span class="line"><span class="meta">spring.jackson.time-zone</span>= <span class="string">#  Time zone used when formatting dates. For instance, &quot;America/Los_Angeles&quot; or &quot;GMT+10&quot;.</span></span><br><span class="line"><span class="meta">spring.jackson.visibility.*</span>= <span class="string"># Jackson visibility thresholds that can be used to limit which methods (and fields) are auto-detected.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GSON (GsonProperties)</span></span><br><span class="line"><span class="meta">spring.gson.date-format</span>= <span class="string"># Format to use when serializing Date objects.</span></span><br><span class="line"><span class="meta">spring.gson.disable-html-escaping</span>= <span class="string"># Whether to disable the escaping of HTML characters such as &#x27;&lt;&#x27;, &#x27;&gt;&#x27;, etc.</span></span><br><span class="line"><span class="meta">spring.gson.disable-inner-class-serialization</span>= <span class="string"># Whether to exclude inner classes during serialization.</span></span><br><span class="line"><span class="meta">spring.gson.enable-complex-map-key-serialization</span>= <span class="string"># Whether to enable serialization of complex map keys (i.e. non-primitives).</span></span><br><span class="line"><span class="meta">spring.gson.exclude-fields-without-expose-annotation</span>= <span class="string"># Whether to exclude all fields from consideration for serialization or deserialization that do not have the &quot;Expose&quot; annotation.</span></span><br><span class="line"><span class="meta">spring.gson.field-naming-policy</span>= <span class="string"># Naming policy that should be applied to an object&#x27;s field during serialization and deserialization.</span></span><br><span class="line"><span class="meta">spring.gson.generate-non-executable-json</span>= <span class="string"># Whether to generate non executable JSON by prefixing the output with some special text.</span></span><br><span class="line"><span class="meta">spring.gson.lenient</span>= <span class="string"># Whether to be lenient about parsing JSON that doesn&#x27;t conform to RFC 4627.</span></span><br><span class="line"><span class="meta">spring.gson.long-serialization-policy</span>= <span class="string"># Serialization policy for Long and long types.</span></span><br><span class="line"><span class="meta">spring.gson.pretty-printing</span>= <span class="string"># Whether to output serialized JSON that fits in a page for pretty printing.</span></span><br><span class="line"><span class="meta">spring.gson.serialize-nulls</span>= <span class="string"># Whether to serialize null fields.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JERSEY (JerseyProperties)</span></span><br><span class="line"><span class="meta">spring.jersey.application-path</span>= <span class="string"># Path that serves as the base URI for the application. If specified, overrides the value of &quot;@ApplicationPath&quot;.</span></span><br><span class="line"><span class="meta">spring.jersey.filter.order</span>=<span class="string">0 # Jersey filter chain order.</span></span><br><span class="line"><span class="meta">spring.jersey.init.*</span>= <span class="string"># Init parameters to pass to Jersey through the servlet or filter.</span></span><br><span class="line"><span class="meta">spring.jersey.servlet.load-on-startup</span>=<span class="string">-1 # Load on startup priority of the Jersey servlet.</span></span><br><span class="line"><span class="meta">spring.jersey.type</span>=<span class="string">servlet # Jersey integration type.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING LDAP (LdapProperties)</span></span><br><span class="line"><span class="meta">spring.ldap.anonymous-read-only</span>=<span class="string">false # Whether read-only operations should use an anonymous environment.</span></span><br><span class="line"><span class="meta">spring.ldap.base</span>= <span class="string"># Base suffix from which all operations should originate.</span></span><br><span class="line"><span class="meta">spring.ldap.base-environment.*</span>= <span class="string"># LDAP specification settings.</span></span><br><span class="line"><span class="meta">spring.ldap.password</span>= <span class="string"># Login password of the server.</span></span><br><span class="line"><span class="meta">spring.ldap.urls</span>= <span class="string"># LDAP URLs of the server.</span></span><br><span class="line"><span class="meta">spring.ldap.username</span>= <span class="string"># Login username of the server.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EMBEDDED LDAP (EmbeddedLdapProperties)</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.base-dn</span>= <span class="string"># List of base DNs.</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.credential.username</span>= <span class="string"># Embedded LDAP username.</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.credential.password</span>= <span class="string"># Embedded LDAP password.</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.ldif</span>=<span class="string">classpath:schema.ldif # Schema (LDIF) script resource reference.</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.port</span>=<span class="string">0 # Embedded LDAP port.</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.validation.enabled</span>=<span class="string">true # Whether to enable LDAP schema validation.</span></span><br><span class="line"><span class="meta">spring.ldap.embedded.validation.schema</span>= <span class="string"># Path to the custom schema.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MUSTACHE TEMPLATES (MustacheAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.mustache.allow-request-override</span>=<span class="string">false # Whether HttpServletRequest attributes are allowed to override (hide) controller generated model attributes of the same name.</span></span><br><span class="line"><span class="meta">spring.mustache.allow-session-override</span>=<span class="string">false # Whether HttpSession attributes are allowed to override (hide) controller generated model attributes of the same name.</span></span><br><span class="line"><span class="meta">spring.mustache.cache</span>=<span class="string">false # Whether to enable template caching.</span></span><br><span class="line"><span class="meta">spring.mustache.charset</span>=<span class="string">UTF-8 # Template encoding.</span></span><br><span class="line"><span class="meta">spring.mustache.check-template-location</span>=<span class="string">true # Whether to check that the templates location exists.</span></span><br><span class="line"><span class="meta">spring.mustache.content-type</span>=<span class="string">text/html # Content-Type value.</span></span><br><span class="line"><span class="meta">spring.mustache.enabled</span>=<span class="string">true # Whether to enable MVC view resolution for this technology.</span></span><br><span class="line"><span class="meta">spring.mustache.expose-request-attributes</span>=<span class="string">false # Whether all request attributes should be added to the model prior to merging with the template.</span></span><br><span class="line"><span class="meta">spring.mustache.expose-session-attributes</span>=<span class="string">false # Whether all HttpSession attributes should be added to the model prior to merging with the template.</span></span><br><span class="line"><span class="meta">spring.mustache.expose-spring-macro-helpers</span>=<span class="string">true # Whether to expose a RequestContext for use by Spring&#x27;s macro library, under the name &quot;springMacroRequestContext&quot;.</span></span><br><span class="line"><span class="meta">spring.mustache.prefix</span>=<span class="string">classpath:/templates/ # Prefix to apply to template names.</span></span><br><span class="line"><span class="meta">spring.mustache.request-context-attribute</span>= <span class="string"># Name of the RequestContext attribute for all views.</span></span><br><span class="line"><span class="meta">spring.mustache.suffix</span>=<span class="string">.mustache # Suffix to apply to template names.</span></span><br><span class="line"><span class="meta">spring.mustache.view-names</span>= <span class="string"># White list of view names that can be resolved.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING MVC (WebMvcProperties)</span></span><br><span class="line"><span class="meta">spring.mvc.async.request-timeout</span>= <span class="string"># Amount of time before asynchronous request handling times out.</span></span><br><span class="line"><span class="meta">spring.mvc.contentnegotiation.favor-parameter</span>=<span class="string">false # Whether a request parameter (&quot;format&quot; by default) should be used to determine the requested media type.</span></span><br><span class="line"><span class="meta">spring.mvc.contentnegotiation.favor-path-extension</span>=<span class="string">false # Whether the path extension in the URL path should be used to determine the requested media type.</span></span><br><span class="line"><span class="meta">spring.mvc.contentnegotiation.media-types.*</span>= <span class="string"># Map file extensions to media types for content negotiation. For instance, yml to text/yaml.</span></span><br><span class="line"><span class="meta">spring.mvc.contentnegotiation.parameter-name</span>= <span class="string"># Query parameter name to use when &quot;favor-parameter&quot; is enabled.</span></span><br><span class="line"><span class="meta">spring.mvc.date-format</span>= <span class="string"># Date format to use. For instance, `dd/MM/yyyy`.</span></span><br><span class="line"><span class="meta">spring.mvc.dispatch-trace-request</span>=<span class="string">false # Whether to dispatch TRACE requests to the FrameworkServlet doService method.</span></span><br><span class="line"><span class="meta">spring.mvc.dispatch-options-request</span>=<span class="string">true # Whether to dispatch OPTIONS requests to the FrameworkServlet doService method.</span></span><br><span class="line"><span class="meta">spring.mvc.favicon.enabled</span>=<span class="string">true # Whether to enable resolution of favicon.ico.</span></span><br><span class="line"><span class="meta">spring.mvc.formcontent.filter.enabled</span>=<span class="string">true # Whether to enable Spring&#x27;s FormContentFilter.</span></span><br><span class="line"><span class="meta">spring.mvc.hiddenmethod.filter.enabled</span>=<span class="string">true # Whether to enable Spring&#x27;s HiddenHttpMethodFilter.</span></span><br><span class="line"><span class="meta">spring.mvc.ignore-default-model-on-redirect</span>=<span class="string">true # Whether the content of the &quot;default&quot; model should be ignored during redirect scenarios.</span></span><br><span class="line"><span class="meta">spring.mvc.locale</span>= <span class="string"># Locale to use. By default, this locale is overridden by the &quot;Accept-Language&quot; header.</span></span><br><span class="line"><span class="meta">spring.mvc.locale-resolver</span>=<span class="string">accept-header # Define how the locale should be resolved.</span></span><br><span class="line"><span class="meta">spring.mvc.log-resolved-exception</span>=<span class="string">false # Whether to enable warn logging of exceptions resolved by a &quot;HandlerExceptionResolver&quot;, except for &quot;DefaultHandlerExceptionResolver&quot;.</span></span><br><span class="line"><span class="meta">spring.mvc.message-codes-resolver-format</span>= <span class="string"># Formatting strategy for message codes. For instance, `PREFIX_ERROR_CODE`.</span></span><br><span class="line"><span class="meta">spring.mvc.pathmatch.use-registered-suffix-pattern</span>=<span class="string">false # Whether suffix pattern matching should work only against extensions registered with &quot;spring.mvc.contentnegotiation.media-types.*&quot;.</span></span><br><span class="line"><span class="meta">spring.mvc.pathmatch.use-suffix-pattern</span>=<span class="string">false # Whether to use suffix pattern match (&quot;.*&quot;) when matching patterns to requests.</span></span><br><span class="line"><span class="meta">spring.mvc.servlet.load-on-startup</span>=<span class="string">-1 # Load on startup priority of the dispatcher servlet.</span></span><br><span class="line"><span class="meta">spring.mvc.servlet.path</span>=<span class="string">/ # Path of the dispatcher servlet.</span></span><br><span class="line"><span class="meta">spring.mvc.static-path-pattern</span>=<span class="string">/** # Path pattern used for static resources.</span></span><br><span class="line"><span class="meta">spring.mvc.throw-exception-if-no-handler-found</span>=<span class="string">false # Whether a &quot;NoHandlerFoundException&quot; should be thrown if no Handler was found to process a request.</span></span><br><span class="line"><span class="meta">spring.mvc.view.prefix</span>= <span class="string"># Spring MVC view prefix.</span></span><br><span class="line"><span class="meta">spring.mvc.view.suffix</span>= <span class="string"># Spring MVC view suffix.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING RESOURCES HANDLING (ResourceProperties)</span></span><br><span class="line"><span class="meta">spring.resources.add-mappings</span>=<span class="string">true # Whether to enable default resource handling.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.cache-private</span>= <span class="string"># Indicate that the response message is intended for a single user and must not be stored by a shared cache.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.cache-public</span>= <span class="string"># Indicate that any cache may store the response.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.max-age</span>= <span class="string"># Maximum time the response should be cached, in seconds if no duration suffix is not specified.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.must-revalidate</span>= <span class="string"># Indicate that once it has become stale, a cache must not use the response without re-validating it with the server.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.no-cache</span>= <span class="string"># Indicate that the cached response can be reused only if re-validated with the server.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.no-store</span>= <span class="string"># Indicate to not cache the response in any case.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.no-transform</span>= <span class="string"># Indicate intermediaries (caches and others) that they should not transform the response content.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.proxy-revalidate</span>= <span class="string"># Same meaning as the &quot;must-revalidate&quot; directive, except that it does not apply to private caches.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.s-max-age</span>= <span class="string"># Maximum time the response should be cached by shared caches, in seconds if no duration suffix is not specified.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.stale-if-error</span>= <span class="string"># Maximum time the response may be used when errors are encountered, in seconds if no duration suffix is not specified.</span></span><br><span class="line"><span class="meta">spring.resources.cache.cachecontrol.stale-while-revalidate</span>= <span class="string"># Maximum time the response can be served after it becomes stale, in seconds if no duration suffix is not specified.</span></span><br><span class="line"><span class="meta">spring.resources.cache.period</span>= <span class="string"># Cache period for the resources served by the resource handler. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.resources.chain.cache</span>=<span class="string">true # Whether to enable caching in the Resource chain.</span></span><br><span class="line"><span class="meta">spring.resources.chain.compressed</span>=<span class="string">false # Whether to enable resolution of already compressed resources (gzip, brotli).</span></span><br><span class="line"><span class="meta">spring.resources.chain.enabled</span>= <span class="string"># Whether to enable the Spring Resource Handling chain. By default, disabled unless at least one strategy has been enabled.</span></span><br><span class="line"><span class="meta">spring.resources.chain.html-application-cache</span>=<span class="string">false # Whether to enable HTML5 application cache manifest rewriting.</span></span><br><span class="line"><span class="meta">spring.resources.chain.strategy.content.enabled</span>=<span class="string">false # Whether to enable the content Version Strategy.</span></span><br><span class="line"><span class="meta">spring.resources.chain.strategy.content.paths</span>=<span class="string">/** # Comma-separated list of patterns to apply to the content Version Strategy.</span></span><br><span class="line"><span class="meta">spring.resources.chain.strategy.fixed.enabled</span>=<span class="string">false # Whether to enable the fixed Version Strategy.</span></span><br><span class="line"><span class="meta">spring.resources.chain.strategy.fixed.paths</span>=<span class="string">/** # Comma-separated list of patterns to apply to the fixed Version Strategy.</span></span><br><span class="line"><span class="meta">spring.resources.chain.strategy.fixed.version</span>= <span class="string"># Version string to use for the fixed Version Strategy.</span></span><br><span class="line"><span class="meta">spring.resources.static-locations</span>=<span class="string">classpath:/META-INF/resources/,classpath:/resources/,classpath:/static/,classpath:/public/ # Locations of static resources.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING SESSION (SessionProperties)</span></span><br><span class="line"><span class="meta">spring.session.store-type</span>= <span class="string"># Session store type.</span></span><br><span class="line"><span class="meta">spring.session.timeout</span>= <span class="string"># Session timeout. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.session.servlet.filter-order</span>=<span class="string">-2147483598 # Session repository filter order.</span></span><br><span class="line"><span class="meta">spring.session.servlet.filter-dispatcher-types</span>=<span class="string">async,error,request # Session repository filter dispatcher types.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING SESSION HAZELCAST (HazelcastSessionProperties)</span></span><br><span class="line"><span class="meta">spring.session.hazelcast.flush-mode</span>=<span class="string">on-save # Sessions flush mode.</span></span><br><span class="line"><span class="meta">spring.session.hazelcast.map-name</span>=<span class="string">spring:session:sessions # Name of the map used to store sessions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING SESSION JDBC (JdbcSessionProperties)</span></span><br><span class="line"><span class="meta">spring.session.jdbc.cleanup-cron</span>=<span class="string">0 * * * * * # Cron expression for expired session cleanup job.</span></span><br><span class="line"><span class="meta">spring.session.jdbc.initialize-schema</span>=<span class="string">embedded # Database schema initialization mode.</span></span><br><span class="line"><span class="meta">spring.session.jdbc.schema</span>=<span class="string">classpath:org/springframework/session/jdbc/schema-@@platform@@.sql # Path to the SQL file to use to initialize the database schema.</span></span><br><span class="line"><span class="meta">spring.session.jdbc.table-name</span>=<span class="string">SPRING_SESSION # Name of the database table used to store sessions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING SESSION MONGODB (MongoSessionProperties)</span></span><br><span class="line"><span class="meta">spring.session.mongodb.collection-name</span>=<span class="string">sessions # Collection name used to store sessions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING SESSION REDIS (RedisSessionProperties)</span></span><br><span class="line"><span class="meta">spring.session.redis.cleanup-cron</span>=<span class="string">0 * * * * * # Cron expression for expired session cleanup job.</span></span><br><span class="line"><span class="meta">spring.session.redis.flush-mode</span>=<span class="string">on-save # Sessions flush mode.</span></span><br><span class="line"><span class="meta">spring.session.redis.namespace</span>=<span class="string">spring:session # Namespace for keys used to store sessions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># THYMELEAF (ThymeleafAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.thymeleaf.cache</span>=<span class="string">true # Whether to enable template caching.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.check-template</span>=<span class="string">true # Whether to check that the template exists before rendering it.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.check-template-location</span>=<span class="string">true # Whether to check that the templates location exists.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.enabled</span>=<span class="string">true # Whether to enable Thymeleaf view resolution for Web frameworks.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.enable-spring-el-compiler</span>=<span class="string">false # Enable the SpringEL compiler in SpringEL expressions.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.encoding</span>=<span class="string">UTF-8 # Template files encoding.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.excluded-view-names</span>= <span class="string"># Comma-separated list of view names (patterns allowed) that should be excluded from resolution.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.mode</span>=<span class="string">HTML # Template mode to be applied to templates. See also Thymeleaf&#x27;s TemplateMode enum.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.prefix</span>=<span class="string">classpath:/templates/ # Prefix that gets prepended to view names when building a URL.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.reactive.chunked-mode-view-names</span>= <span class="string"># Comma-separated list of view names (patterns allowed) that should be the only ones executed in CHUNKED mode when a max chunk size is set.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.reactive.full-mode-view-names</span>= <span class="string"># Comma-separated list of view names (patterns allowed) that should be executed in FULL mode even if a max chunk size is set.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.reactive.max-chunk-size</span>=<span class="string">0B # Maximum size of data buffers used for writing to the response.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.reactive.media-types</span>= <span class="string"># Media types supported by the view technology.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.render-hidden-markers-before-checkboxes</span>=<span class="string">false # Whether hidden form inputs acting as markers for checkboxes should be rendered before the checkbox element itself.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.servlet.content-type</span>=<span class="string">text/html # Content-Type value written to HTTP responses.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.servlet.produce-partial-output-while-processing</span>=<span class="string">true # Whether Thymeleaf should start writing partial output as soon as possible or buffer until template processing is finished.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.suffix</span>=<span class="string">.html # Suffix that gets appended to view names when building a URL.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.template-resolver-order</span>= <span class="string"># Order of the template resolver in the chain.</span></span><br><span class="line"><span class="meta">spring.thymeleaf.view-names</span>= <span class="string"># Comma-separated list of view names (patterns allowed) that can be resolved.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING WEBFLUX (WebFluxProperties)</span></span><br><span class="line"><span class="meta">spring.webflux.date-format</span>= <span class="string"># Date format to use. For instance, `dd/MM/yyyy`.</span></span><br><span class="line"><span class="meta">spring.webflux.hiddenmethod.filter.enabled</span>=<span class="string">true # Whether to enable Spring&#x27;s HiddenHttpMethodFilter.</span></span><br><span class="line"><span class="meta">spring.webflux.static-path-pattern</span>=<span class="string">/** # Path pattern used for static resources.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING WEB SERVICES (WebServicesProperties)</span></span><br><span class="line"><span class="meta">spring.webservices.path</span>=<span class="string">/services # Path that serves as the base URI for the services.</span></span><br><span class="line"><span class="meta">spring.webservices.servlet.init</span>= <span class="string"># Servlet init parameters to pass to Spring Web Services.</span></span><br><span class="line"><span class="meta">spring.webservices.servlet.load-on-startup</span>=<span class="string">-1 # Load on startup priority of the Spring Web Services servlet.</span></span><br><span class="line"><span class="meta">spring.webservices.wsdl-locations</span>= <span class="string"># Comma-separated list of locations of WSDLs and accompanying XSDs to be exposed as beans.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># SECURITY PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># SECURITY (SecurityProperties)</span></span><br><span class="line"><span class="meta">spring.security.filter.order</span>=<span class="string">-100 # Security filter chain order.</span></span><br><span class="line"><span class="meta">spring.security.filter.dispatcher-types</span>=<span class="string">async,error,request # Security filter chain dispatcher types.</span></span><br><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">user # Default user name.</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>= <span class="string"># Password for the default user name.</span></span><br><span class="line"><span class="meta">spring.security.user.roles</span>= <span class="string"># Granted roles for the default user name.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SECURITY OAUTH2 CLIENT (OAuth2ClientProperties)</span></span><br><span class="line"><span class="meta">spring.security.oauth2.client.provider.*</span>= <span class="string"># OAuth provider details.</span></span><br><span class="line"><span class="meta">spring.security.oauth2.client.registration.*</span>= <span class="string"># OAuth client registrations.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SECURITY OAUTH2 RESOURCE SERVER (OAuth2ResourceServerProperties)</span></span><br><span class="line"><span class="meta">spring.security.oauth2.resourceserver.jwt.jwk-set-uri</span>= <span class="string"># JSON Web Key URI to use to verify the JWT token.</span></span><br><span class="line"><span class="meta">spring.security.oauth2.resourceserver.jwt.issuer-uri</span>= <span class="string"># URI that an OpenID Connect Provider asserts as its Issuer Identifier.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># DATA PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FLYWAY (FlywayProperties)</span></span><br><span class="line"><span class="meta">spring.flyway.baseline-description</span>=<span class="string">&lt;&lt; Flyway Baseline &gt;&gt; # Description to tag an existing schema with when applying a baseline.</span></span><br><span class="line"><span class="meta">spring.flyway.baseline-on-migrate</span>=<span class="string">false # Whether to automatically call baseline when migrating a non-empty schema.</span></span><br><span class="line"><span class="meta">spring.flyway.baseline-version</span>=<span class="string">1 # Version to tag an existing schema with when executing baseline.</span></span><br><span class="line"><span class="meta">spring.flyway.check-location</span>=<span class="string">true # Whether to check that migration scripts location exists.</span></span><br><span class="line"><span class="meta">spring.flyway.clean-disabled</span>=<span class="string">false # Whether to disable cleaning of the database.</span></span><br><span class="line"><span class="meta">spring.flyway.clean-on-validation-error</span>=<span class="string">false # Whether to automatically call clean when a validation error occurs.</span></span><br><span class="line"><span class="meta">spring.flyway.connect-retries</span>=<span class="string">0 # Maximum number of retries when attempting to connect to the database.</span></span><br><span class="line"><span class="meta">spring.flyway.enabled</span>=<span class="string">true # Whether to enable flyway.</span></span><br><span class="line"><span class="meta">spring.flyway.encoding</span>=<span class="string">UTF-8 # Encoding of SQL migrations.</span></span><br><span class="line"><span class="meta">spring.flyway.group</span>=<span class="string">false # Whether to group all pending migrations together in the same transaction when applying them.</span></span><br><span class="line"><span class="meta">spring.flyway.ignore-future-migrations</span>=<span class="string">true # Whether to ignore future migrations when reading the schema history table.</span></span><br><span class="line"><span class="meta">spring.flyway.ignore-ignored-migrations</span>=<span class="string">false # Whether to ignore ignored migrations when reading the schema history table.</span></span><br><span class="line"><span class="meta">spring.flyway.ignore-missing-migrations</span>=<span class="string">false # Whether to ignore missing migrations when reading the schema history table.</span></span><br><span class="line"><span class="meta">spring.flyway.ignore-pending-migrations</span>=<span class="string">false # Whether to ignore pending migrations when reading the schema history table.</span></span><br><span class="line"><span class="meta">spring.flyway.init-sqls</span>= <span class="string"># SQL statements to execute to initialize a connection immediately after obtaining it.</span></span><br><span class="line"><span class="meta">spring.flyway.installed-by</span>= <span class="string"># Username recorded in the schema history table as having applied the migration.</span></span><br><span class="line"><span class="meta">spring.flyway.locations</span>=<span class="string">classpath:db/migration # Locations of migrations scripts. Can contain the special &quot;&#123;vendor&#125;&quot; placeholder to use vendor-specific locations.</span></span><br><span class="line"><span class="meta">spring.flyway.mixed</span>=<span class="string">false # Whether to allow mixing transactional and non-transactional statements within the same migration.</span></span><br><span class="line"><span class="meta">spring.flyway.out-of-order</span>=<span class="string">false # Whether to allow migrations to be run out of order.</span></span><br><span class="line"><span class="meta">spring.flyway.password</span>= <span class="string"># Login password of the database to migrate.</span></span><br><span class="line"><span class="meta">spring.flyway.placeholder-prefix</span>=<span class="string">$&#123; # Prefix of placeholders in migration scripts.</span></span><br><span class="line"><span class="meta">spring.flyway.placeholder-replacement</span>=<span class="string">true # Perform placeholder replacement in migration scripts.</span></span><br><span class="line"><span class="meta">spring.flyway.placeholder-suffix</span>=<span class="string">&#125; # Suffix of placeholders in migration scripts.</span></span><br><span class="line"><span class="meta">spring.flyway.placeholders</span>= <span class="string"># Placeholders and their replacements to apply to sql migration scripts.</span></span><br><span class="line"><span class="meta">spring.flyway.repeatable-sql-migration-prefix</span>=<span class="string">R # File name prefix for repeatable SQL migrations.</span></span><br><span class="line"><span class="meta">spring.flyway.schemas</span>= <span class="string"># Scheme names managed by Flyway (case-sensitive).</span></span><br><span class="line"><span class="meta">spring.flyway.skip-default-callbacks</span>=<span class="string">false # Whether to skip default callbacks. If true, only custom callbacks are used.</span></span><br><span class="line"><span class="meta">spring.flyway.skip-default-resolvers</span>=<span class="string">false # Whether to skip default resolvers. If true, only custom resolvers are used.</span></span><br><span class="line"><span class="meta">spring.flyway.sql-migration-prefix</span>=<span class="string">V # File name prefix for SQL migrations.</span></span><br><span class="line"><span class="meta">spring.flyway.sql-migration-separator</span>=<span class="string">__ # File name separator for SQL migrations.</span></span><br><span class="line"><span class="meta">spring.flyway.sql-migration-suffixes</span>=<span class="string">.sql # File name suffix for SQL migrations.</span></span><br><span class="line"><span class="meta">spring.flyway.table</span>=<span class="string">flyway_schema_history # Name of the schema schema history table that will be used by Flyway.</span></span><br><span class="line"><span class="meta">spring.flyway.target</span>= <span class="string"># Target version up to which migrations should be considered.</span></span><br><span class="line"><span class="meta">spring.flyway.url</span>= <span class="string"># JDBC url of the database to migrate. If not set, the primary configured data source is used.</span></span><br><span class="line"><span class="meta">spring.flyway.user</span>= <span class="string"># Login user of the database to migrate.</span></span><br><span class="line"><span class="meta">spring.flyway.validate-on-migrate</span>=<span class="string">true # Whether to automatically call validate when performing a migration.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LIQUIBASE (LiquibaseProperties)</span></span><br><span class="line"><span class="meta">spring.liquibase.change-log</span>=<span class="string">classpath:/db/changelog/db.changelog-master.yaml # Change log configuration path.</span></span><br><span class="line"><span class="meta">spring.liquibase.contexts</span>= <span class="string"># Comma-separated list of runtime contexts to use.</span></span><br><span class="line"><span class="meta">spring.liquibase.database-change-log-lock-table</span>=<span class="string">DATABASECHANGELOGLOCK # Name of table to use for tracking concurrent Liquibase usage.</span></span><br><span class="line"><span class="meta">spring.liquibase.database-change-log-table</span>=<span class="string">DATABASECHANGELOG # Name of table to use for tracking change history.</span></span><br><span class="line"><span class="meta">spring.liquibase.default-schema</span>= <span class="string"># Default database schema.</span></span><br><span class="line"><span class="meta">spring.liquibase.drop-first</span>=<span class="string">false # Whether to first drop the database schema.</span></span><br><span class="line"><span class="meta">spring.liquibase.enabled</span>=<span class="string">true # Whether to enable Liquibase support.</span></span><br><span class="line"><span class="meta">spring.liquibase.labels</span>= <span class="string"># Comma-separated list of runtime labels to use.</span></span><br><span class="line"><span class="meta">spring.liquibase.liquibase-schema</span>= <span class="string"># Schema to use for Liquibase objects.</span></span><br><span class="line"><span class="meta">spring.liquibase.liquibase-tablespace</span>= <span class="string"># Tablespace to use for Liquibase objects.</span></span><br><span class="line"><span class="meta">spring.liquibase.parameters.*</span>= <span class="string"># Change log parameters.</span></span><br><span class="line"><span class="meta">spring.liquibase.password</span>= <span class="string"># Login password of the database to migrate.</span></span><br><span class="line"><span class="meta">spring.liquibase.rollback-file</span>= <span class="string"># File to which rollback SQL is written when an update is performed.</span></span><br><span class="line"><span class="meta">spring.liquibase.test-rollback-on-update</span>=<span class="string">false # Whether rollback should be tested before update is performed.</span></span><br><span class="line"><span class="meta">spring.liquibase.url</span>= <span class="string"># JDBC URL of the database to migrate. If not set, the primary configured data source is used.</span></span><br><span class="line"><span class="meta">spring.liquibase.user</span>= <span class="string"># Login user of the database to migrate.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># COUCHBASE (CouchbaseProperties)</span></span><br><span class="line"><span class="meta">spring.couchbase.bootstrap-hosts</span>= <span class="string"># Couchbase nodes (host or IP address) to bootstrap from.</span></span><br><span class="line"><span class="meta">spring.couchbase.bucket.name</span>=<span class="string">default # Name of the bucket to connect to.</span></span><br><span class="line"><span class="meta">spring.couchbase.bucket.password</span>=  <span class="string"># Password of the bucket.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.endpoints.key-value</span>=<span class="string">1 # Number of sockets per node against the key/value service.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.endpoints.queryservice.min-endpoints</span>=<span class="string">1 # Minimum number of sockets per node.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.endpoints.queryservice.max-endpoints</span>=<span class="string">1 # Maximum number of sockets per node.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.endpoints.viewservice.min-endpoints</span>=<span class="string">1 # Minimum number of sockets per node.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.endpoints.viewservice.max-endpoints</span>=<span class="string">1 # Maximum number of sockets per node.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.ssl.enabled</span>= <span class="string"># Whether to enable SSL support. Enabled automatically if a &quot;keyStore&quot; is provided unless specified otherwise.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.ssl.key-store</span>= <span class="string"># Path to the JVM key store that holds the certificates.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.ssl.key-store-password</span>= <span class="string"># Password used to access the key store.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.timeouts.connect</span>=<span class="string">5000ms # Bucket connections timeouts.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.timeouts.key-value</span>=<span class="string">2500ms # Blocking operations performed on a specific key timeout.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.timeouts.query</span>=<span class="string">7500ms # N1QL query operations timeout.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.timeouts.socket-connect</span>=<span class="string">1000ms # Socket connect connections timeout.</span></span><br><span class="line"><span class="meta">spring.couchbase.env.timeouts.view</span>=<span class="string">7500ms # Regular and geospatial view operations timeout.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DAO (PersistenceExceptionTranslationAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.dao.exceptiontranslation.enabled</span>=<span class="string">true # Whether to enable the PersistenceExceptionTranslationPostProcessor.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CASSANDRA (CassandraProperties)</span></span><br><span class="line"><span class="meta">spring.data.cassandra.cluster-name</span>= <span class="string"># Name of the Cassandra cluster.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.compression</span>=<span class="string">none # Compression supported by the Cassandra binary protocol.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.connect-timeout</span>= <span class="string"># Socket option: connection time out.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.consistency-level</span>= <span class="string"># Queries consistency level.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.contact-points</span>=<span class="string">localhost # Cluster node addresses.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.fetch-size</span>= <span class="string"># Queries default fetch size.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.jmx-enabled</span>=<span class="string">false # Whether to enable JMX reporting.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.keyspace-name</span>= <span class="string"># Keyspace name to use.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.port</span>= <span class="string"># Port of the Cassandra server.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.password</span>= <span class="string"># Login password of the server.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.pool.heartbeat-interval</span>=<span class="string">30s # Heartbeat interval after which a message is sent on an idle connection to make sure it&#x27;s still alive. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.pool.idle-timeout</span>=<span class="string">120s # Idle timeout before an idle connection is removed. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.pool.max-queue-size</span>=<span class="string">256 # Maximum number of requests that get queued if no connection is available.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.pool.pool-timeout</span>=<span class="string">5000ms # Pool timeout when trying to acquire a connection from a host&#x27;s pool.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.read-timeout</span>= <span class="string"># Socket option: read time out.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.repositories.type</span>=<span class="string">auto # Type of Cassandra repositories to enable.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.serial-consistency-level</span>= <span class="string"># Queries serial consistency level.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.schema-action</span>=<span class="string">none # Schema action to take at startup.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.ssl</span>=<span class="string">false # Enable SSL support.</span></span><br><span class="line"><span class="meta">spring.data.cassandra.username</span>= <span class="string"># Login user of the server.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATA COUCHBASE (CouchbaseDataProperties)</span></span><br><span class="line"><span class="meta">spring.data.couchbase.auto-index</span>=<span class="string">false # Automatically create views and indexes.</span></span><br><span class="line"><span class="meta">spring.data.couchbase.consistency</span>=<span class="string">read-your-own-writes # Consistency to apply by default on generated queries.</span></span><br><span class="line"><span class="meta">spring.data.couchbase.repositories.type</span>=<span class="string">auto # Type of Couchbase repositories to enable.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ELASTICSEARCH (ElasticsearchProperties)</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-name</span>=<span class="string">elasticsearch # Elasticsearch cluster name.</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-nodes</span>= <span class="string"># Comma-separated list of cluster node addresses.</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.properties.*</span>= <span class="string"># Additional properties used to configure the client.</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.repositories.enabled</span>=<span class="string">true # Whether to enable Elasticsearch repositories.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATA JDBC</span></span><br><span class="line"><span class="meta">spring.data.jdbc.repositories.enabled</span>=<span class="string">true # Whether to enable JDBC repositories.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATA LDAP</span></span><br><span class="line"><span class="meta">spring.data.ldap.repositories.enabled</span>=<span class="string">true # Whether to enable LDAP repositories.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MONGODB (MongoProperties)</span></span><br><span class="line"><span class="meta">spring.data.mongodb.authentication-database</span>= <span class="string"># Authentication database name.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.database</span>= <span class="string"># Database name.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.field-naming-strategy</span>= <span class="string"># Fully qualified name of the FieldNamingStrategy to use.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.grid-fs-database</span>= <span class="string"># GridFS database name.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.host</span>= <span class="string"># Mongo server host. Cannot be set with URI.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.password</span>= <span class="string"># Login password of the mongo server. Cannot be set with URI.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.port</span>= <span class="string"># Mongo server port. Cannot be set with URI.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.repositories.type</span>=<span class="string">auto # Type of Mongo repositories to enable.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.uri</span>=<span class="string">mongodb://localhost/test # Mongo database URI. Cannot be set with host, port and credentials.</span></span><br><span class="line"><span class="meta">spring.data.mongodb.username</span>= <span class="string"># Login user of the mongo server. Cannot be set with URI.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATA REDIS</span></span><br><span class="line"><span class="meta">spring.data.redis.repositories.enabled</span>=<span class="string">true # Whether to enable Redis repositories.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NEO4J (Neo4jProperties)</span></span><br><span class="line"><span class="meta">spring.data.neo4j.auto-index</span>=<span class="string">none # Auto index mode.</span></span><br><span class="line"><span class="meta">spring.data.neo4j.embedded.enabled</span>=<span class="string">true # Whether to enable embedded mode if the embedded driver is available.</span></span><br><span class="line"><span class="meta">spring.data.neo4j.open-in-view</span>=<span class="string">true # Register OpenSessionInViewInterceptor. Binds a Neo4j Session to the thread for the entire processing of the request.</span></span><br><span class="line"><span class="meta">spring.data.neo4j.password</span>= <span class="string"># Login password of the server.</span></span><br><span class="line"><span class="meta">spring.data.neo4j.repositories.enabled</span>=<span class="string">true # Whether to enable Neo4j repositories.</span></span><br><span class="line"><span class="meta">spring.data.neo4j.uri</span>= <span class="string"># URI used by the driver. Auto-detected by default.</span></span><br><span class="line"><span class="meta">spring.data.neo4j.username</span>= <span class="string"># Login user of the server.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATA REST (RepositoryRestProperties)</span></span><br><span class="line"><span class="meta">spring.data.rest.base-path</span>= <span class="string"># Base path to be used by Spring Data REST to expose repository resources.</span></span><br><span class="line"><span class="meta">spring.data.rest.default-media-type</span>= <span class="string"># Content type to use as a default when none is specified.</span></span><br><span class="line"><span class="meta">spring.data.rest.default-page-size</span>= <span class="string"># Default size of pages.</span></span><br><span class="line"><span class="meta">spring.data.rest.detection-strategy</span>=<span class="string">default # Strategy to use to determine which repositories get exposed.</span></span><br><span class="line"><span class="meta">spring.data.rest.enable-enum-translation</span>= <span class="string"># Whether to enable enum value translation through the Spring Data REST default resource bundle.</span></span><br><span class="line"><span class="meta">spring.data.rest.limit-param-name</span>= <span class="string"># Name of the URL query string parameter that indicates how many results to return at once.</span></span><br><span class="line"><span class="meta">spring.data.rest.max-page-size</span>= <span class="string"># Maximum size of pages.</span></span><br><span class="line"><span class="meta">spring.data.rest.page-param-name</span>= <span class="string"># Name of the URL query string parameter that indicates what page to return.</span></span><br><span class="line"><span class="meta">spring.data.rest.return-body-on-create</span>= <span class="string"># Whether to return a response body after creating an entity.</span></span><br><span class="line"><span class="meta">spring.data.rest.return-body-on-update</span>= <span class="string"># Whether to return a response body after updating an entity.</span></span><br><span class="line"><span class="meta">spring.data.rest.sort-param-name</span>= <span class="string"># Name of the URL query string parameter that indicates what direction to sort results.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SOLR (SolrProperties)</span></span><br><span class="line"><span class="meta">spring.data.solr.host</span>=<span class="string">http://127.0.0.1:8983/solr # Solr host. Ignored if &quot;zk-host&quot; is set.</span></span><br><span class="line"><span class="meta">spring.data.solr.repositories.enabled</span>=<span class="string">true # Whether to enable Solr repositories.</span></span><br><span class="line"><span class="meta">spring.data.solr.zk-host</span>= <span class="string"># ZooKeeper host address in the form HOST:PORT.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATA WEB (SpringDataWebProperties)</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.default-page-size</span>=<span class="string">20 # Default page size.</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.max-page-size</span>=<span class="string">2000 # Maximum page size to be accepted.</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.one-indexed-parameters</span>=<span class="string">false # Whether to expose and assume 1-based page number indexes.</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.page-parameter</span>=<span class="string">page # Page index parameter name.</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.prefix</span>= <span class="string"># General prefix to be prepended to the page number and page size parameters.</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.qualifier-delimiter</span>=<span class="string">_ # Delimiter to be used between the qualifier and the actual page number and size properties.</span></span><br><span class="line"><span class="meta">spring.data.web.pageable.size-parameter</span>=<span class="string">size # Page size parameter name.</span></span><br><span class="line"><span class="meta">spring.data.web.sort.sort-parameter</span>=<span class="string">sort # Sort parameter name.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DATASOURCE (DataSourceAutoConfiguration &amp; DataSourceProperties)</span></span><br><span class="line"><span class="meta">spring.datasource.continue-on-error</span>=<span class="string">false # Whether to stop if an error occurs while initializing the database.</span></span><br><span class="line"><span class="meta">spring.datasource.data</span>= <span class="string"># Data (DML) script resource references.</span></span><br><span class="line"><span class="meta">spring.datasource.data-username</span>= <span class="string"># Username of the database to execute DML scripts (if different).</span></span><br><span class="line"><span class="meta">spring.datasource.data-password</span>= <span class="string"># Password of the database to execute DML scripts (if different).</span></span><br><span class="line"><span class="meta">spring.datasource.dbcp2.*</span>= <span class="string"># Commons DBCP2 specific settings</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>= <span class="string"># Fully qualified name of the JDBC driver. Auto-detected based on the URL by default.</span></span><br><span class="line"><span class="meta">spring.datasource.generate-unique-name</span>=<span class="string">false # Whether to generate a random datasource name.</span></span><br><span class="line"><span class="meta">spring.datasource.hikari.*</span>= <span class="string"># Hikari specific settings</span></span><br><span class="line"><span class="meta">spring.datasource.initialization-mode</span>=<span class="string">embedded # Initialize the datasource with available DDL and DML scripts.</span></span><br><span class="line"><span class="meta">spring.datasource.jmx-enabled</span>=<span class="string">false # Whether to enable JMX support (if provided by the underlying pool).</span></span><br><span class="line"><span class="meta">spring.datasource.jndi-name</span>= <span class="string"># JNDI location of the datasource. Class, url, username &amp; password are ignored when set.</span></span><br><span class="line"><span class="meta">spring.datasource.name</span>= <span class="string"># Name of the datasource. Default to &quot;testdb&quot; when using an embedded database.</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>= <span class="string"># Login password of the database.</span></span><br><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">all # Platform to use in the DDL or DML scripts (such as schema-$&#123;platform&#125;.sql or data-$&#123;platform&#125;.sql).</span></span><br><span class="line"><span class="meta">spring.datasource.schema</span>= <span class="string"># Schema (DDL) script resource references.</span></span><br><span class="line"><span class="meta">spring.datasource.schema-username</span>= <span class="string"># Username of the database to execute DDL scripts (if different).</span></span><br><span class="line"><span class="meta">spring.datasource.schema-password</span>= <span class="string"># Password of the database to execute DDL scripts (if different).</span></span><br><span class="line"><span class="meta">spring.datasource.separator</span>=<span class="string">; # Statement separator in SQL initialization scripts.</span></span><br><span class="line"><span class="meta">spring.datasource.sql-script-encoding</span>= <span class="string"># SQL scripts encoding.</span></span><br><span class="line"><span class="meta">spring.datasource.tomcat.*</span>= <span class="string"># Tomcat datasource specific settings</span></span><br><span class="line"><span class="meta">spring.datasource.type</span>= <span class="string"># Fully qualified name of the connection pool implementation to use. By default, it is auto-detected from the classpath.</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>= <span class="string"># JDBC URL of the database.</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>= <span class="string"># Login username of the database.</span></span><br><span class="line"><span class="meta">spring.datasource.xa.data-source-class-name</span>= <span class="string"># XA datasource fully qualified name.</span></span><br><span class="line"><span class="meta">spring.datasource.xa.properties</span>= <span class="string"># Properties to pass to the XA data source.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JEST (Elasticsearch HTTP client) (JestProperties)</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.connection-timeout</span>=<span class="string">3s # Connection timeout.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.multi-threaded</span>=<span class="string">true # Whether to enable connection requests from multiple execution threads.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.password</span>= <span class="string"># Login password.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.proxy.host</span>= <span class="string"># Proxy host the HTTP client should use.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.proxy.port</span>= <span class="string"># Proxy port the HTTP client should use.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.read-timeout</span>=<span class="string">3s # Read timeout.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.uris</span>=<span class="string">http://localhost:9200 # Comma-separated list of the Elasticsearch instances to use.</span></span><br><span class="line"><span class="meta">spring.elasticsearch.jest.username</span>= <span class="string"># Login username.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Elasticsearch REST clients (RestClientProperties)</span></span><br><span class="line"><span class="meta">spring.elasticsearch.rest.password</span>= <span class="string"># Credentials password.</span></span><br><span class="line">   <span class="meta">spring.elasticsearch.rest.uris</span>=<span class="string">http://localhost:9200 # Comma-separated list of the Elasticsearch instances to use.</span></span><br><span class="line">   <span class="meta">spring.elasticsearch.rest.username</span>= <span class="string"># Credentials username.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># H2 Web Console (H2ConsoleProperties)</span></span><br><span class="line"><span class="meta">spring.h2.console.enabled</span>=<span class="string">false # Whether to enable the console.</span></span><br><span class="line"><span class="meta">spring.h2.console.path</span>=<span class="string">/h2-console # Path at which the console is available.</span></span><br><span class="line"><span class="meta">spring.h2.console.settings.trace</span>=<span class="string">false # Whether to enable trace output.</span></span><br><span class="line"><span class="meta">spring.h2.console.settings.web-allow-others</span>=<span class="string">false # Whether to enable remote access.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># InfluxDB (InfluxDbProperties)</span></span><br><span class="line"><span class="meta">spring.influx.password</span>= <span class="string"># Login password.</span></span><br><span class="line"><span class="meta">spring.influx.url</span>= <span class="string"># URL of the InfluxDB instance to which to connect.</span></span><br><span class="line"><span class="meta">spring.influx.user</span>= <span class="string"># Login user.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JOOQ (JooqProperties)</span></span><br><span class="line"><span class="meta">spring.jooq.sql-dialect</span>= <span class="string"># SQL dialect to use. Auto-detected by default.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JDBC (JdbcProperties)</span></span><br><span class="line"><span class="meta">spring.jdbc.template.fetch-size</span>=<span class="string">-1 # Number of rows that should be fetched from the database when more rows are needed.</span></span><br><span class="line"><span class="meta">spring.jdbc.template.max-rows</span>=<span class="string">-1 # Maximum number of rows.</span></span><br><span class="line"><span class="meta">spring.jdbc.template.query-timeout</span>= <span class="string"># Query timeout. Default is to use the JDBC driver&#x27;s default configuration. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JPA (JpaBaseConfiguration, HibernateJpaAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.data.jpa.repositories.bootstrap-mode</span>=<span class="string">default # Bootstrap mode for JPA repositories.</span></span><br><span class="line"><span class="meta">spring.data.jpa.repositories.enabled</span>=<span class="string">true # Whether to enable JPA repositories.</span></span><br><span class="line"><span class="meta">spring.jpa.database</span>= <span class="string"># Target database to operate on, auto-detected by default. Can be alternatively set using the &quot;databasePlatform&quot; property.</span></span><br><span class="line"><span class="meta">spring.jpa.database-platform</span>= <span class="string"># Name of the target database to operate on, auto-detected by default. Can be alternatively set using the &quot;Database&quot; enum.</span></span><br><span class="line"><span class="meta">spring.jpa.generate-ddl</span>=<span class="string">false # Whether to initialize the schema on startup.</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.ddl-auto</span>= <span class="string"># DDL mode. This is actually a shortcut for the &quot;hibernate.hbm2ddl.auto&quot; property. Defaults to &quot;create-drop&quot; when using an embedded database and no schema manager was detected. Otherwise, defaults to &quot;none&quot;.</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.naming.implicit-strategy</span>= <span class="string"># Fully qualified name of the implicit naming strategy.</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.naming.physical-strategy</span>= <span class="string"># Fully qualified name of the physical naming strategy.</span></span><br><span class="line"><span class="meta">spring.jpa.hibernate.use-new-id-generator-mappings</span>= <span class="string"># Whether to use Hibernate&#x27;s newer IdentifierGenerator for AUTO, TABLE and SEQUENCE.</span></span><br><span class="line"><span class="meta">spring.jpa.mapping-resources</span>= <span class="string"># Mapping resources (equivalent to &quot;mapping-file&quot; entries in persistence.xml).</span></span><br><span class="line"><span class="meta">spring.jpa.open-in-view</span>=<span class="string">true # Register OpenEntityManagerInViewInterceptor. Binds a JPA EntityManager to the thread for the entire processing of the request.</span></span><br><span class="line"><span class="meta">spring.jpa.properties.*</span>= <span class="string"># Additional native properties to set on the JPA provider.</span></span><br><span class="line"><span class="meta">spring.jpa.show-sql</span>=<span class="string">false # Whether to enable logging of SQL statements.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JTA (JtaAutoConfiguration)</span></span><br><span class="line"><span class="meta">spring.jta.enabled</span>=<span class="string">true # Whether to enable JTA support.</span></span><br><span class="line"><span class="meta">spring.jta.log-dir</span>= <span class="string"># Transaction logs directory.</span></span><br><span class="line"><span class="meta">spring.jta.transaction-manager-id</span>= <span class="string"># Transaction manager unique identifier.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ATOMIKOS (AtomikosProperties)</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.borrow-connection-timeout</span>=<span class="string">30 # Timeout, in seconds, for borrowing connections from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.ignore-session-transacted-flag</span>=<span class="string">true # Whether to ignore the transacted flag when creating session.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.local-transaction-mode</span>=<span class="string">false # Whether local transactions are desired.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.maintenance-interval</span>=<span class="string">60 # Time, in seconds, between runs of the pool&#x27;s maintenance thread.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.max-idle-time</span>=<span class="string">60 # Time, in seconds, after which connections are cleaned up from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.max-lifetime</span>=<span class="string">0 # Time, in seconds, that a connection can be pooled for before being destroyed. 0 denotes no limit.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.max-pool-size</span>=<span class="string">1 # Maximum size of the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.min-pool-size</span>=<span class="string">1 # Minimum size of the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.reap-timeout</span>=<span class="string">0 # Reap timeout, in seconds, for borrowed connections. 0 denotes no limit.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.unique-resource-name</span>=<span class="string">jmsConnectionFactory # Unique name used to identify the resource during recovery.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.xa-connection-factory-class-name</span>= <span class="string"># Vendor-specific implementation of XAConnectionFactory.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.connectionfactory.xa-properties</span>= <span class="string"># Vendor-specific XA properties.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.borrow-connection-timeout</span>=<span class="string">30 # Timeout, in seconds, for borrowing connections from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.concurrent-connection-validation</span>=<span class="string">true # Whether to use concurrent connection validation.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.default-isolation-level</span>= <span class="string"># Default isolation level of connections provided by the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.login-timeout</span>=<span class="string">0 # Timeout, in seconds, for establishing a database connection.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.maintenance-interval</span>=<span class="string">60 # Time, in seconds, between runs of the pool&#x27;s maintenance thread.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.max-idle-time</span>=<span class="string">60 # Time, in seconds, after which connections are cleaned up from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.max-lifetime</span>=<span class="string">0 # Time, in seconds, that a connection can be pooled for before being destroyed. 0 denotes no limit.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.max-pool-size</span>=<span class="string">1 # Maximum size of the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.min-pool-size</span>=<span class="string">1 # Minimum size of the pool.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.reap-timeout</span>=<span class="string">0 # Reap timeout, in seconds, for borrowed connections. 0 denotes no limit.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.test-query</span>= <span class="string"># SQL query or statement used to validate a connection before returning it.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.unique-resource-name</span>=<span class="string">dataSource # Unique name used to identify the resource during recovery.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.xa-data-source-class-name</span>= <span class="string"># Vendor-specific implementation of XAConnectionFactory.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.datasource.xa-properties</span>= <span class="string"># Vendor-specific XA properties.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.allow-sub-transactions</span>=<span class="string">true # Specify whether sub-transactions are allowed.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.checkpoint-interval</span>=<span class="string">500 # Interval between checkpoints, expressed as the number of log writes between two checkpoints.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.default-jta-timeout</span>=<span class="string">10000ms # Default timeout for JTA transactions.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.default-max-wait-time-on-shutdown</span>=<span class="string">9223372036854775807 # How long should normal shutdown (no-force) wait for transactions to complete.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.enable-logging</span>=<span class="string">true # Whether to enable disk logging.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.force-shutdown-on-vm-exit</span>=<span class="string">false # Whether a VM shutdown should trigger forced shutdown of the transaction core.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.log-base-dir</span>= <span class="string"># Directory in which the log files should be stored.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.log-base-name</span>=<span class="string">tmlog # Transactions log file base name.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.max-actives</span>=<span class="string">50 # Maximum number of active transactions.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.max-timeout</span>=<span class="string">300000ms # Maximum timeout that can be allowed for transactions.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.recovery.delay</span>=<span class="string">10000ms # Delay between two recovery scans.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.recovery.forget-orphaned-log-entries-delay</span>=<span class="string">86400000ms # Delay after which recovery can cleanup pending (&#x27;orphaned&#x27;) log entries.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.recovery.max-retries</span>=<span class="string">5 # Number of retry attempts to commit the transaction before throwing an exception.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.recovery.retry-interval</span>=<span class="string">10000ms # Delay between retry attempts.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.serial-jta-transactions</span>=<span class="string">true # Whether sub-transactions should be joined when possible.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.service</span>= <span class="string"># Transaction manager implementation that should be started.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.threaded-two-phase-commit</span>=<span class="string">false # Whether to use different (and concurrent) threads for two-phase commit on the participating resources.</span></span><br><span class="line"><span class="meta">spring.jta.atomikos.properties.transaction-manager-unique-name</span>= <span class="string"># The transaction manager&#x27;s unique name.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BITRONIX</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.acquire-increment</span>=<span class="string">1 # Number of connections to create when growing the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.acquisition-interval</span>=<span class="string">1 # Time, in seconds, to wait before trying to acquire a connection again after an invalid connection was acquired.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.acquisition-timeout</span>=<span class="string">30 # Timeout, in seconds, for acquiring connections from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.allow-local-transactions</span>=<span class="string">false # Whether the transaction manager should allow mixing XA and non-XA transactions.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.apply-transaction-timeout</span>=<span class="string">false # Whether the transaction timeout should be set on the XAResource when it is enlisted.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.automatic-enlisting-enabled</span>=<span class="string">true # Whether resources should be enlisted and delisted automatically.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.cache-producers-consumers</span>=<span class="string">true # Whether producers and consumers should be cached.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.class-name</span>= <span class="string"># Underlying implementation class name of the XA resource.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.defer-connection-release</span>=<span class="string">true # Whether the provider can run many transactions on the same connection and supports transaction interleaving.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.disabled</span>=<span class="string">false # Whether this resource is disabled, meaning it&#x27;s temporarily forbidden to acquire a connection from its pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.driver-properties</span>= <span class="string"># Properties that should be set on the underlying implementation.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.ignore-recovery-failures</span>=<span class="string">false # Whether recovery failures should be ignored.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.max-idle-time</span>=<span class="string">60 # Time, in seconds, after which connections are cleaned up from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.max-pool-size</span>=<span class="string">0 # Maximum size of the pool. 0 denotes no limit.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.min-pool-size</span>=<span class="string">0 # Minimum size of the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.password</span>= <span class="string"># Password to use to connect to the JMS provider.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.share-transaction-connections</span>=<span class="string">false #  Whether connections in the ACCESSIBLE state can be shared within the context of a transaction.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.test-connections</span>=<span class="string">false # Whether connections should be tested when acquired from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.two-pc-ordering-position</span>=<span class="string">1 # Position that this resource should take during two-phase commit (always first is Integer.MIN_VALUE, always last is Integer.MAX_VALUE).</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.unique-name</span>=<span class="string">jmsConnectionFactory # Unique name used to identify the resource during recovery.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.use-tm-join</span>=<span class="string">true # Whether TMJOIN should be used when starting XAResources.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.connectionfactory.user</span>= <span class="string"># User to use to connect to the JMS provider.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.acquire-increment</span>=<span class="string">1 # Number of connections to create when growing the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.acquisition-interval</span>=<span class="string">1 # Time, in seconds, to wait before trying to acquire a connection again after an invalid connection was acquired.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.acquisition-timeout</span>=<span class="string">30 # Timeout, in seconds, for acquiring connections from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.allow-local-transactions</span>=<span class="string">false # Whether the transaction manager should allow mixing XA and non-XA transactions.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.apply-transaction-timeout</span>=<span class="string">false # Whether the transaction timeout should be set on the XAResource when it is enlisted.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.automatic-enlisting-enabled</span>=<span class="string">true # Whether resources should be enlisted and delisted automatically.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.class-name</span>= <span class="string"># Underlying implementation class name of the XA resource.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.cursor-holdability</span>= <span class="string"># Default cursor holdability for connections.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.defer-connection-release</span>=<span class="string">true # Whether the database can run many transactions on the same connection and supports transaction interleaving.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.disabled</span>=<span class="string">false # Whether this resource is disabled, meaning it&#x27;s temporarily forbidden to acquire a connection from its pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.driver-properties</span>= <span class="string"># Properties that should be set on the underlying implementation.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.enable-jdbc4-connection-test</span>=<span class="string">false # Whether Connection.isValid() is called when acquiring a connection from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.ignore-recovery-failures</span>=<span class="string">false # Whether recovery failures should be ignored.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.isolation-level</span>= <span class="string"># Default isolation level for connections.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.local-auto-commit</span>= <span class="string"># Default auto-commit mode for local transactions.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.login-timeout</span>= <span class="string"># Timeout, in seconds, for establishing a database connection.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.max-idle-time</span>=<span class="string">60 # Time, in seconds, after which connections are cleaned up from the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.max-pool-size</span>=<span class="string">0 # Maximum size of the pool. 0 denotes no limit.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.min-pool-size</span>=<span class="string">0 # Minimum size of the pool.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.prepared-statement-cache-size</span>=<span class="string">0 # Target size of the prepared statement cache. 0 disables the cache.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.share-transaction-connections</span>=<span class="string">false #  Whether connections in the ACCESSIBLE state can be shared within the context of a transaction.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.test-query</span>= <span class="string"># SQL query or statement used to validate a connection before returning it.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.two-pc-ordering-position</span>=<span class="string">1 # Position that this resource should take during two-phase commit (always first is Integer.MIN_VALUE, and always last is Integer.MAX_VALUE).</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.unique-name</span>=<span class="string">dataSource # Unique name used to identify the resource during recovery.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.datasource.use-tm-join</span>=<span class="string">true # Whether TMJOIN should be used when starting XAResources.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.allow-multiple-lrc</span>=<span class="string">false # Whether to allow multiple LRC resources to be enlisted into the same transaction.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.asynchronous2-pc</span>=<span class="string">false # Whether to enable asynchronously execution of two phase commit.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.background-recovery-interval-seconds</span>=<span class="string">60 # Interval in seconds at which to run the recovery process in the background.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.current-node-only-recovery</span>=<span class="string">true # Whether to recover only the current node.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.debug-zero-resource-transaction</span>=<span class="string">false # Whether to log the creation and commit call stacks of transactions executed without a single enlisted resource.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.default-transaction-timeout</span>=<span class="string">60 # Default transaction timeout, in seconds.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.disable-jmx</span>=<span class="string">false # Whether to enable JMX support.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.exception-analyzer</span>= <span class="string"># Set the fully qualified name of the exception analyzer implementation to use.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.filter-log-status</span>=<span class="string">false # Whether to enable filtering of logs so that only mandatory logs are written.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.force-batching-enabled</span>=<span class="string">true #  Whether disk forces are batched.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.forced-write-enabled</span>=<span class="string">true # Whether logs are forced to disk.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.graceful-shutdown-interval</span>=<span class="string">60 # Maximum amount of seconds the TM waits for transactions to get done before aborting them at shutdown time.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.jndi-transaction-synchronization-registry-name</span>= <span class="string"># JNDI name of the TransactionSynchronizationRegistry.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.jndi-user-transaction-name</span>= <span class="string"># JNDI name of the UserTransaction.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.journal</span>=<span class="string">disk # Name of the journal. Can be &#x27;disk&#x27;, &#x27;null&#x27;, or a class name.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.log-part1-filename</span>=<span class="string">btm1.tlog # Name of the first fragment of the journal.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.log-part2-filename</span>=<span class="string">btm2.tlog # Name of the second fragment of the journal.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.max-log-size-in-mb</span>=<span class="string">2 # Maximum size in megabytes of the journal fragments.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.resource-configuration-filename</span>= <span class="string"># ResourceLoader configuration file name.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.server-id</span>= <span class="string"># ASCII ID that must uniquely identify this TM instance. Defaults to the machine&#x27;s IP address.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.skip-corrupted-logs</span>=<span class="string">false # Skip corrupted transactions log entries.</span></span><br><span class="line"><span class="meta">spring.jta.bitronix.properties.warn-about-zero-resource-transaction</span>=<span class="string">true # Whether to log a warning for transactions executed without a single enlisted resource.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EMBEDDED MONGODB (EmbeddedMongoProperties)</span></span><br><span class="line"><span class="meta">spring.mongodb.embedded.features</span>=<span class="string">sync_delay # Comma-separated list of features to enable.</span></span><br><span class="line"><span class="meta">spring.mongodb.embedded.storage.database-dir</span>= <span class="string"># Directory used for data storage.</span></span><br><span class="line"><span class="meta">spring.mongodb.embedded.storage.oplog-size</span>= <span class="string"># Maximum size of the oplog.</span></span><br><span class="line"><span class="meta">spring.mongodb.embedded.storage.repl-set-name</span>= <span class="string"># Name of the replica set.</span></span><br><span class="line"><span class="meta">spring.mongodb.embedded.version</span>=<span class="string">3.5.5 # Version of Mongo to use.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># REDIS (RedisProperties)</span></span><br><span class="line"><span class="meta">spring.redis.cluster.max-redirects</span>= <span class="string"># Maximum number of redirects to follow when executing commands across the cluster.</span></span><br><span class="line"><span class="meta">spring.redis.cluster.nodes</span>= <span class="string"># Comma-separated list of &quot;host:port&quot; pairs to bootstrap from.</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0 # Database index used by the connection factory.</span></span><br><span class="line"><span class="meta">spring.redis.url</span>= <span class="string"># Connection URL. Overrides host, port, and password. User is ignored. Example: redis://user:password@example.com:6379</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">localhost # Redis server host.</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-active</span>=<span class="string">8 # Maximum number of connections that can be allocated by the pool at a given time. Use a negative value for no limit.</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-idle</span>=<span class="string">8 # Maximum number of &quot;idle&quot; connections in the pool. Use a negative value to indicate an unlimited number of idle connections.</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.max-wait</span>=<span class="string">-1ms # Maximum amount of time a connection allocation should block before throwing an exception when the pool is exhausted. Use a negative value to block indefinitely.</span></span><br><span class="line"><span class="meta">spring.redis.jedis.pool.min-idle</span>=<span class="string">0 # Target for the minimum number of idle connections to maintain in the pool. This setting only has an effect if it is positive.</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-active</span>=<span class="string">8 # Maximum number of connections that can be allocated by the pool at a given time. Use a negative value for no limit.</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-idle</span>=<span class="string">8 # Maximum number of &quot;idle&quot; connections in the pool. Use a negative value to indicate an unlimited number of idle connections.</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1ms # Maximum amount of time a connection allocation should block before throwing an exception when the pool is exhausted. Use a negative value to block indefinitely.</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0 # Target for the minimum number of idle connections to maintain in the pool. This setting only has an effect if it is positive.</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.shutdown-timeout</span>=<span class="string">100ms # Shutdown timeout.</span></span><br><span class="line"><span class="meta">spring.redis.password</span>= <span class="string"># Login password of the redis server.</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379 # Redis server port.</span></span><br><span class="line"><span class="meta">spring.redis.sentinel.master</span>= <span class="string"># Name of the Redis server.</span></span><br><span class="line"><span class="meta">spring.redis.sentinel.nodes</span>= <span class="string"># Comma-separated list of &quot;host:port&quot; pairs.</span></span><br><span class="line"><span class="meta">spring.redis.ssl</span>=<span class="string">false # Whether to enable SSL support.</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>= <span class="string"># Connection timeout.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TRANSACTION (TransactionProperties)</span></span><br><span class="line"><span class="meta">spring.transaction.default-timeout</span>= <span class="string"># Default transaction timeout. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.transaction.rollback-on-commit-failure</span>= <span class="string"># Whether to roll back on commit failures.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># INTEGRATION PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ACTIVEMQ (ActiveMQProperties)</span></span><br><span class="line"><span class="meta">spring.activemq.broker-url</span>= <span class="string"># URL of the ActiveMQ broker. Auto-generated by default.</span></span><br><span class="line"><span class="meta">spring.activemq.close-timeout</span>=<span class="string">15s # Time to wait before considering a close complete.</span></span><br><span class="line"><span class="meta">spring.activemq.in-memory</span>=<span class="string">true # Whether the default broker URL should be in memory. Ignored if an explicit broker has been specified.</span></span><br><span class="line"><span class="meta">spring.activemq.non-blocking-redelivery</span>=<span class="string">false # Whether to stop message delivery before re-delivering messages from a rolled back transaction. This implies that message order is not preserved when this is enabled.</span></span><br><span class="line"><span class="meta">spring.activemq.password</span>= <span class="string"># Login password of the broker.</span></span><br><span class="line"><span class="meta">spring.activemq.send-timeout</span>=<span class="string">0ms # Time to wait on message sends for a response. Set it to 0 to wait forever.</span></span><br><span class="line"><span class="meta">spring.activemq.user</span>= <span class="string"># Login user of the broker.</span></span><br><span class="line"><span class="meta">spring.activemq.packages.trust-all</span>= <span class="string"># Whether to trust all packages.</span></span><br><span class="line"><span class="meta">spring.activemq.packages.trusted</span>= <span class="string"># Comma-separated list of specific packages to trust (when not trusting all packages).</span></span><br><span class="line"><span class="meta">spring.activemq.pool.block-if-full</span>=<span class="string">true # Whether to block when a connection is requested and the pool is full. Set it to false to throw a &quot;JMSException&quot; instead.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.block-if-full-timeout</span>=<span class="string">-1ms # Blocking period before throwing an exception if the pool is still full.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.enabled</span>=<span class="string">false # Whether a JmsPoolConnectionFactory should be created, instead of a regular ConnectionFactory.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.idle-timeout</span>=<span class="string">30s # Connection idle timeout.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.max-connections</span>=<span class="string">1 # Maximum number of pooled connections.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.max-sessions-per-connection</span>=<span class="string">500 # Maximum number of pooled sessions per connection in the pool.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.time-between-expiration-check</span>=<span class="string">-1ms # Time to sleep between runs of the idle connection eviction thread. When negative, no idle connection eviction thread runs.</span></span><br><span class="line"><span class="meta">spring.activemq.pool.use-anonymous-producers</span>=<span class="string">true # Whether to use only one anonymous &quot;MessageProducer&quot; instance. Set it to false to create one &quot;MessageProducer&quot; every time one is required.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ARTEMIS (ArtemisProperties)</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.cluster-password</span>= <span class="string"># Cluster password. Randomly generated on startup by default.</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.data-directory</span>= <span class="string"># Journal file directory. Not necessary if persistence is turned off.</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.enabled</span>=<span class="string">true # Whether to enable embedded mode if the Artemis server APIs are available.</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.persistent</span>=<span class="string">false # Whether to enable persistent store.</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.queues</span>= <span class="string"># Comma-separated list of queues to create on startup.</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.server-id</span>= <span class="string"># Server ID. By default, an auto-incremented counter is used.</span></span><br><span class="line"><span class="meta">spring.artemis.embedded.topics</span>= <span class="string"># Comma-separated list of topics to create on startup.</span></span><br><span class="line"><span class="meta">spring.artemis.host</span>=<span class="string">localhost # Artemis broker host.</span></span><br><span class="line"><span class="meta">spring.artemis.mode</span>= <span class="string"># Artemis deployment mode, auto-detected by default.</span></span><br><span class="line"><span class="meta">spring.artemis.password</span>= <span class="string"># Login password of the broker.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.block-if-full</span>=<span class="string">true # Whether to block when a connection is requested and the pool is full. Set it to false to throw a &quot;JMSException&quot; instead.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.block-if-full-timeout</span>=<span class="string">-1ms # Blocking period before throwing an exception if the pool is still full.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.enabled</span>=<span class="string">false # Whether a JmsPoolConnectionFactory should be created, instead of a regular ConnectionFactory.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.idle-timeout</span>=<span class="string">30s # Connection idle timeout.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.max-connections</span>=<span class="string">1 # Maximum number of pooled connections.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.max-sessions-per-connection</span>=<span class="string">500 # Maximum number of pooled sessions per connection in the pool.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.time-between-expiration-check</span>=<span class="string">-1ms # Time to sleep between runs of the idle connection eviction thread. When negative, no idle connection eviction thread runs.</span></span><br><span class="line"><span class="meta">spring.artemis.pool.use-anonymous-producers</span>=<span class="string">true # Whether to use only one anonymous &quot;MessageProducer&quot; instance. Set it to false to create one &quot;MessageProducer&quot; every time one is required.</span></span><br><span class="line"><span class="meta">spring.artemis.port</span>=<span class="string">61616 # Artemis broker port.</span></span><br><span class="line"><span class="meta">spring.artemis.user</span>= <span class="string"># Login user of the broker.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING BATCH (BatchProperties)</span></span><br><span class="line"><span class="meta">spring.batch.initialize-schema</span>=<span class="string">embedded # Database schema initialization mode.</span></span><br><span class="line"><span class="meta">spring.batch.job.enabled</span>=<span class="string">true # Execute all Spring Batch jobs in the context on startup.</span></span><br><span class="line"><span class="meta">spring.batch.job.names</span>= <span class="string"># Comma-separated list of job names to execute on startup (for instance, `job1,job2`). By default, all Jobs found in the context are executed.</span></span><br><span class="line"><span class="meta">spring.batch.schema</span>=<span class="string">classpath:org/springframework/batch/core/schema-@@platform@@.sql # Path to the SQL file to use to initialize the database schema.</span></span><br><span class="line"><span class="meta">spring.batch.table-prefix</span>= <span class="string"># Table prefix for all the batch meta-data tables.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SPRING INTEGRATION (IntegrationProperties)</span></span><br><span class="line"><span class="meta">spring.integration.jdbc.initialize-schema</span>=<span class="string">embedded # Database schema initialization mode.</span></span><br><span class="line"><span class="meta">spring.integration.jdbc.schema</span>=<span class="string">classpath:org/springframework/integration/jdbc/schema-@@platform@@.sql # Path to the SQL file to use to initialize the database schema.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JMS (JmsProperties)</span></span><br><span class="line"><span class="meta">spring.jms.cache.consumers</span>=<span class="string">false # Whether to cache message consumers.</span></span><br><span class="line"><span class="meta">spring.jms.cache.enabled</span>=<span class="string">true # Whether to cache sessions.</span></span><br><span class="line"><span class="meta">spring.jms.cache.producers</span>=<span class="string">true # Whether to cache message producers.</span></span><br><span class="line"><span class="meta">spring.jms.cache.session-cache-size</span>=<span class="string">1 # Size of the session cache (per JMS Session type).</span></span><br><span class="line"><span class="meta">spring.jms.jndi-name</span>= <span class="string"># Connection factory JNDI name. When set, takes precedence to others connection factory auto-configurations.</span></span><br><span class="line"><span class="meta">spring.jms.listener.acknowledge-mode</span>= <span class="string"># Acknowledge mode of the container. By default, the listener is transacted with automatic acknowledgment.</span></span><br><span class="line"><span class="meta">spring.jms.listener.auto-startup</span>=<span class="string">true # Start the container automatically on startup.</span></span><br><span class="line"><span class="meta">spring.jms.listener.concurrency</span>= <span class="string"># Minimum number of concurrent consumers.</span></span><br><span class="line"><span class="meta">spring.jms.listener.max-concurrency</span>= <span class="string"># Maximum number of concurrent consumers.</span></span><br><span class="line"><span class="meta">spring.jms.pub-sub-domain</span>=<span class="string">false # Whether the default destination type is topic.</span></span><br><span class="line"><span class="meta">spring.jms.template.default-destination</span>= <span class="string"># Default destination to use on send and receive operations that do not have a destination parameter.</span></span><br><span class="line"><span class="meta">spring.jms.template.delivery-delay</span>= <span class="string"># Delivery delay to use for send calls.</span></span><br><span class="line"><span class="meta">spring.jms.template.delivery-mode</span>= <span class="string"># Delivery mode. Enables QoS (Quality of Service) when set.</span></span><br><span class="line"><span class="meta">spring.jms.template.priority</span>= <span class="string"># Priority of a message when sending. Enables QoS (Quality of Service) when set.</span></span><br><span class="line"><span class="meta">spring.jms.template.qos-enabled</span>= <span class="string"># Whether to enable explicit QoS (Quality of Service) when sending a message.</span></span><br><span class="line"><span class="meta">spring.jms.template.receive-timeout</span>= <span class="string"># Timeout to use for receive calls.</span></span><br><span class="line"><span class="meta">spring.jms.template.time-to-live</span>= <span class="string"># Time-to-live of a message when sending. Enables QoS (Quality of Service) when set.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># APACHE KAFKA (KafkaProperties)</span></span><br><span class="line"><span class="meta">spring.kafka.admin.client-id</span>= <span class="string"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.fail-fast</span>=<span class="string">false # Whether to fail fast if the broker is not available on startup.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.properties.*</span>= <span class="string"># Additional admin-specific properties used to configure the client.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.key-password</span>= <span class="string"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.key-store-location</span>= <span class="string"># Location of the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.key-store-password</span>= <span class="string"># Store password for the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.protocol</span>= <span class="string"># SSL protocol to use.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.trust-store-location</span>= <span class="string"># Location of the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.trust-store-password</span>= <span class="string"># Store password for the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.admin.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"><span class="meta">spring.kafka.bootstrap-servers</span>= <span class="string"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Applies to all components unless overridden.</span></span><br><span class="line"><span class="meta">spring.kafka.client-id</span>= <span class="string"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.auto-commit-interval</span>= <span class="string"># Frequency with which the consumer offsets are auto-committed to Kafka if &#x27;enable.auto.commit&#x27; is set to true.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.auto-offset-reset</span>= <span class="string"># What to do when there is no initial offset in Kafka or if the current offset no longer exists on the server.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.bootstrap-servers</span>= <span class="string"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for consumers.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.client-id</span>= <span class="string"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.enable-auto-commit</span>= <span class="string"># Whether the consumer&#x27;s offset is periodically committed in the background.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.fetch-max-wait</span>= <span class="string"># Maximum amount of time the server blocks before answering the fetch request if there isn&#x27;t sufficient data to immediately satisfy the requirement given by &quot;fetch-min-size&quot;.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.fetch-min-size</span>= <span class="string"># Minimum amount of data the server should return for a fetch request.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.group-id</span>= <span class="string"># Unique string that identifies the consumer group to which this consumer belongs.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.heartbeat-interval</span>= <span class="string"># Expected time between heartbeats to the consumer coordinator.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.key-deserializer</span>= <span class="string"># Deserializer class for keys.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.max-poll-records</span>= <span class="string"># Maximum number of records returned in a single call to poll().</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.properties.*</span>= <span class="string"># Additional consumer-specific properties used to configure the client.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.key-password</span>= <span class="string"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.key-store-location</span>= <span class="string"># Location of the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.key-store-password</span>= <span class="string"># Store password for the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.protocol</span>= <span class="string"># SSL protocol to use.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.trust-store-location</span>= <span class="string"># Location of the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.trust-store-password</span>= <span class="string"># Store password for the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"><span class="meta">spring.kafka.consumer.value-deserializer</span>= <span class="string"># Deserializer class for values.</span></span><br><span class="line"><span class="meta">spring.kafka.jaas.control-flag</span>=<span class="string">required # Control flag for login configuration.</span></span><br><span class="line"><span class="meta">spring.kafka.jaas.enabled</span>=<span class="string">false # Whether to enable JAAS configuration.</span></span><br><span class="line"><span class="meta">spring.kafka.jaas.login-module</span>=<span class="string">com.sun.security.auth.module.Krb5LoginModule # Login module.</span></span><br><span class="line"><span class="meta">spring.kafka.jaas.options</span>= <span class="string"># Additional JAAS options.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.ack-count</span>= <span class="string"># Number of records between offset commits when ackMode is &quot;COUNT&quot; or &quot;COUNT_TIME&quot;.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.ack-mode</span>= <span class="string"># Listener AckMode. See the spring-kafka documentation.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.ack-time</span>= <span class="string"># Time between offset commits when ackMode is &quot;TIME&quot; or &quot;COUNT_TIME&quot;.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.client-id</span>= <span class="string"># Prefix for the listener&#x27;s consumer client.id property.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.concurrency</span>= <span class="string"># Number of threads to run in the listener containers.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.idle-event-interval</span>= <span class="string"># Time between publishing idle consumer events (no data received).</span></span><br><span class="line"><span class="meta">spring.kafka.listener.log-container-config</span>= <span class="string"># Whether to log the container configuration during initialization (INFO level).</span></span><br><span class="line"><span class="meta">spring.kafka.listener.monitor-interval</span>= <span class="string"># Time between checks for non-responsive consumers. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.no-poll-threshold</span>= <span class="string"># Multiplier applied to &quot;pollTimeout&quot; to determine if a consumer is non-responsive.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.poll-timeout</span>= <span class="string"># Timeout to use when polling the consumer.</span></span><br><span class="line"><span class="meta">spring.kafka.listener.type</span>=<span class="string">single # Listener type.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.acks</span>= <span class="string"># Number of acknowledgments the producer requires the leader to have received before considering a request complete.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.batch-size</span>= <span class="string"># Default batch size.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.bootstrap-servers</span>= <span class="string"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for producers.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.buffer-memory</span>= <span class="string"># Total memory size the producer can use to buffer records waiting to be sent to the server.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.client-id</span>= <span class="string"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.compression-type</span>= <span class="string"># Compression type for all data generated by the producer.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.key-serializer</span>= <span class="string"># Serializer class for keys.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.properties.*</span>= <span class="string"># Additional producer-specific properties used to configure the client.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.retries</span>= <span class="string"># When greater than zero, enables retrying of failed sends.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.key-password</span>= <span class="string"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.key-store-location</span>= <span class="string"># Location of the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.key-store-password</span>= <span class="string"># Store password for the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.protocol</span>= <span class="string"># SSL protocol to use.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.trust-store-location</span>= <span class="string"># Location of the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.trust-store-password</span>= <span class="string"># Store password for the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.transaction-id-prefix</span>= <span class="string"># When non empty, enables transaction support for producer.</span></span><br><span class="line"><span class="meta">spring.kafka.producer.value-serializer</span>= <span class="string"># Serializer class for values.</span></span><br><span class="line"><span class="meta">spring.kafka.properties.*</span>= <span class="string"># Additional properties, common to producers and consumers, used to configure the client.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.key-password</span>= <span class="string"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.key-store-location</span>= <span class="string"># Location of the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.key-store-password</span>= <span class="string"># Store password for the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.protocol</span>= <span class="string"># SSL protocol to use.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.trust-store-location</span>= <span class="string"># Location of the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.trust-store-password</span>= <span class="string"># Store password for the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.application-id</span>= <span class="string"># Kafka streams application.id property; default spring.application.name.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.auto-startup</span>=<span class="string">true # Whether or not to auto-start the streams factory bean.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.bootstrap-servers</span>= <span class="string"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for streams.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.cache-max-size-buffering</span>= <span class="string"># Maximum memory size to be used for buffering across all threads.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.client-id</span>= <span class="string"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.properties.*</span>= <span class="string"># Additional Kafka properties used to configure the streams.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.replication-factor</span>= <span class="string"># The replication factor for change log topics and repartition topics created by the stream processing application.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.key-password</span>= <span class="string"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.key-store-location</span>= <span class="string"># Location of the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.key-store-password</span>= <span class="string"># Store password for the key store file.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.protocol</span>= <span class="string"># SSL protocol to use.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.trust-store-location</span>= <span class="string"># Location of the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.trust-store-password</span>= <span class="string"># Store password for the trust store file.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"><span class="meta">spring.kafka.streams.state-dir</span>= <span class="string"># Directory location for the state store.</span></span><br><span class="line"><span class="meta">spring.kafka.template.default-topic</span>= <span class="string"># Default topic to which messages are sent.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># RABBIT (RabbitProperties)</span></span><br><span class="line"><span class="meta">spring.rabbitmq.addresses</span>= <span class="string"># Comma-separated list of addresses to which the client should connect.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.cache.channel.checkout-timeout</span>= <span class="string"># Duration to wait to obtain a channel if the cache size has been reached.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.cache.channel.size</span>= <span class="string"># Number of channels to retain in the cache.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.cache.connection.mode</span>=<span class="string">channel # Connection factory cache mode.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.cache.connection.size</span>= <span class="string"># Number of connections to cache.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.connection-timeout</span>= <span class="string"># Connection timeout. Set it to zero to wait forever.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.dynamic</span>=<span class="string">true # Whether to create an AmqpAdmin bean.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">localhost # RabbitMQ host.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.acknowledge-mode</span>= <span class="string"># Acknowledge mode of container.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.auto-startup</span>=<span class="string">true # Whether to start the container automatically on startup.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.consumers-per-queue</span>= <span class="string"># Number of consumers per queue.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.default-requeue-rejected</span>= <span class="string"># Whether rejected deliveries are re-queued by default.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.idle-event-interval</span>= <span class="string"># How often idle container events should be published.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.missing-queues-fatal</span>=<span class="string">false # Whether to fail if the queues declared by the container are not available on the broker.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.prefetch</span>= <span class="string"># Maximum number of unacknowledged messages that can be outstanding at each consumer.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.retry.enabled</span>=<span class="string">false # Whether publishing retries are enabled.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.retry.initial-interval</span>=<span class="string">1000ms # Duration between the first and second attempt to deliver a message.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.retry.max-attempts</span>=<span class="string">3 # Maximum number of attempts to deliver a message.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.retry.max-interval</span>=<span class="string">10000ms # Maximum duration between attempts.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.retry.multiplier</span>=<span class="string">1 # Multiplier to apply to the previous retry interval.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.direct.retry.stateless</span>=<span class="string">true # Whether retries are stateless or stateful.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.acknowledge-mode</span>= <span class="string"># Acknowledge mode of container.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.auto-startup</span>=<span class="string">true # Whether to start the container automatically on startup.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.concurrency</span>= <span class="string"># Minimum number of listener invoker threads.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.default-requeue-rejected</span>= <span class="string"># Whether rejected deliveries are re-queued by default.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.idle-event-interval</span>= <span class="string"># How often idle container events should be published.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.max-concurrency</span>= <span class="string"># Maximum number of listener invoker threads.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.missing-queues-fatal</span>=<span class="string">true # Whether to fail if the queues declared by the container are not available on the broker and/or whether to stop the container if one or more queues are deleted at runtime.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.prefetch</span>= <span class="string"># Maximum number of unacknowledged messages that can be outstanding at each consumer.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.enabled</span>=<span class="string">false # Whether publishing retries are enabled.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.initial-interval</span>=<span class="string">1000ms # Duration between the first and second attempt to deliver a message.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.max-attempts</span>=<span class="string">3 # Maximum number of attempts to deliver a message.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.max-interval</span>=<span class="string">10000ms # Maximum duration between attempts.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.multiplier</span>=<span class="string">1 # Multiplier to apply to the previous retry interval.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.retry.stateless</span>=<span class="string">true # Whether retries are stateless or stateful.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.transaction-size</span>= <span class="string"># Number of messages to be processed between acks when the acknowledge mode is AUTO. If larger than prefetch, prefetch will be increased to this value.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.type</span>=<span class="string">simple # Listener container type.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">guest # Login to authenticate against the broker.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672 # RabbitMQ port.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.publisher-confirms</span>=<span class="string">false # Whether to enable publisher confirms.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.publisher-returns</span>=<span class="string">false # Whether to enable publisher returns.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.requested-heartbeat</span>= <span class="string"># Requested heartbeat timeout; zero for none. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.algorithm</span>= <span class="string"># SSL algorithm to use. By default, configured by the Rabbit client library.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.enabled</span>=<span class="string">false # Whether to enable SSL support.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.key-store</span>= <span class="string"># Path to the key store that holds the SSL certificate.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.key-store-password</span>= <span class="string"># Password used to access the key store.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.key-store-type</span>=<span class="string">PKCS12 # Key store type.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.trust-store</span>= <span class="string"># Trust store that holds SSL certificates.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.trust-store-password</span>= <span class="string"># Password used to access the trust store.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.trust-store-type</span>=<span class="string">JKS # Trust store type.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.validate-server-certificate</span>=<span class="string">true # Whether to enable server side certificate validation.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.ssl.verify-hostname</span>=<span class="string">true # Whether to enable hostname verification.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.default-receive-queue</span>= <span class="string"># Name of the default queue to receive messages from when none is specified explicitly.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.exchange</span>= <span class="string"># Name of the default exchange to use for send operations.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.mandatory</span>= <span class="string"># Whether to enable mandatory messages.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.receive-timeout</span>= <span class="string"># Timeout for `receive()` operations.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.reply-timeout</span>= <span class="string"># Timeout for `sendAndReceive()` operations.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.retry.enabled</span>=<span class="string">false # Whether publishing retries are enabled.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.retry.initial-interval</span>=<span class="string">1000ms # Duration between the first and second attempt to deliver a message.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.retry.max-attempts</span>=<span class="string">3 # Maximum number of attempts to deliver a message.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.retry.max-interval</span>=<span class="string">10000ms # Maximum duration between attempts.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.retry.multiplier</span>=<span class="string">1 # Multiplier to apply to the previous retry interval.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.template.routing-key</span>= <span class="string"># Value of a default routing key to use for send operations.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">guest # Login user to authenticate to the broker.</span></span><br><span class="line"><span class="meta">spring.rabbitmq.virtual-host</span>= <span class="string"># Virtual host to use when connecting to the broker.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># ACTUATOR PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MANAGEMENT HTTP SERVER (ManagementServerProperties)</span></span><br><span class="line"><span class="meta">management.server.add-application-context-header</span>=<span class="string">false # Add the &quot;X-Application-Context&quot; HTTP header in each response.</span></span><br><span class="line"><span class="meta">management.server.address</span>= <span class="string"># Network address to which the management endpoints should bind. Requires a custom management.server.port.</span></span><br><span class="line"><span class="meta">management.server.port</span>= <span class="string"># Management endpoint HTTP port (uses the same port as the application by default). Configure a different port to use management-specific SSL.</span></span><br><span class="line"><span class="meta">management.server.servlet.context-path</span>= <span class="string"># Management endpoint context-path (for instance, `/management`). Requires a custom management.server.port.</span></span><br><span class="line"><span class="meta">management.server.ssl.ciphers</span>= <span class="string"># Supported SSL ciphers.</span></span><br><span class="line"><span class="meta">management.server.ssl.client-auth</span>= <span class="string"># Client authentication mode.</span></span><br><span class="line"><span class="meta">management.server.ssl.enabled</span>=<span class="string">true # Whether to enable SSL support.</span></span><br><span class="line"><span class="meta">management.server.ssl.enabled-protocols</span>= <span class="string"># Enabled SSL protocols.</span></span><br><span class="line"><span class="meta">management.server.ssl.key-alias</span>= <span class="string"># Alias that identifies the key in the key store.</span></span><br><span class="line"><span class="meta">management.server.ssl.key-password</span>= <span class="string"># Password used to access the key in the key store.</span></span><br><span class="line"><span class="meta">management.server.ssl.key-store</span>= <span class="string"># Path to the key store that holds the SSL certificate (typically a jks file).</span></span><br><span class="line"><span class="meta">management.server.ssl.key-store-password</span>= <span class="string"># Password used to access the key store.</span></span><br><span class="line"><span class="meta">management.server.ssl.key-store-provider</span>= <span class="string"># Provider for the key store.</span></span><br><span class="line"><span class="meta">management.server.ssl.key-store-type</span>= <span class="string"># Type of the key store.</span></span><br><span class="line"><span class="meta">management.server.ssl.protocol</span>=<span class="string">TLS # SSL protocol to use.</span></span><br><span class="line"><span class="meta">management.server.ssl.trust-store</span>= <span class="string"># Trust store that holds SSL certificates.</span></span><br><span class="line"><span class="meta">management.server.ssl.trust-store-password</span>= <span class="string"># Password used to access the trust store.</span></span><br><span class="line"><span class="meta">management.server.ssl.trust-store-provider</span>= <span class="string"># Provider for the trust store.</span></span><br><span class="line"><span class="meta">management.server.ssl.trust-store-type</span>= <span class="string"># Type of the trust store.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CLOUDFOUNDRY</span></span><br><span class="line"><span class="meta">management.cloudfoundry.enabled</span>=<span class="string">true # Whether to enable extended Cloud Foundry actuator endpoints.</span></span><br><span class="line"><span class="meta">management.cloudfoundry.skip-ssl-validation</span>=<span class="string">false # Whether to skip SSL verification for Cloud Foundry actuator endpoint security calls.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENDPOINTS GENERAL CONFIGURATION</span></span><br><span class="line"><span class="meta">management.endpoints.enabled-by-default</span>= <span class="string"># Whether to enable or disable all endpoints by default.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENDPOINTS JMX CONFIGURATION (JmxEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoints.jmx.domain</span>=<span class="string">org.springframework.boot # Endpoints JMX domain name. Fallback to &#x27;spring.jmx.default-domain&#x27; if set.</span></span><br><span class="line"><span class="meta">management.endpoints.jmx.exposure.include</span>=<span class="string">* # Endpoint IDs that should be included or &#x27;*&#x27; for all.</span></span><br><span class="line"><span class="meta">management.endpoints.jmx.exposure.exclude</span>= <span class="string"># Endpoint IDs that should be excluded or &#x27;*&#x27; for all.</span></span><br><span class="line"><span class="meta">management.endpoints.jmx.static-names</span>= <span class="string"># Additional static properties to append to all ObjectNames of MBeans representing Endpoints.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENDPOINTS WEB CONFIGURATION (WebEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">health,info # Endpoint IDs that should be included or &#x27;*&#x27; for all.</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.exclude</span>= <span class="string"># Endpoint IDs that should be excluded or &#x27;*&#x27; for all.</span></span><br><span class="line"><span class="meta">management.endpoints.web.base-path</span>=<span class="string">/actuator # Base path for Web endpoints. Relative to server.servlet.context-path or management.server.servlet.context-path if management.server.port is configured.</span></span><br><span class="line"><span class="meta">management.endpoints.web.path-mapping</span>= <span class="string"># Mapping between endpoint IDs and the path that should expose them.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENDPOINTS CORS CONFIGURATION (CorsEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoints.web.cors.allow-credentials</span>= <span class="string"># Whether credentials are supported. When not set, credentials are not supported.</span></span><br><span class="line"><span class="meta">management.endpoints.web.cors.allowed-headers</span>= <span class="string"># Comma-separated list of headers to allow in a request. &#x27;*&#x27; allows all headers.</span></span><br><span class="line"><span class="meta">management.endpoints.web.cors.allowed-methods</span>= <span class="string"># Comma-separated list of methods to allow. &#x27;*&#x27; allows all methods. When not set, defaults to GET.</span></span><br><span class="line"><span class="meta">management.endpoints.web.cors.allowed-origins</span>= <span class="string"># Comma-separated list of origins to allow. &#x27;*&#x27; allows all origins. When not set, CORS support is disabled.</span></span><br><span class="line"><span class="meta">management.endpoints.web.cors.exposed-headers</span>= <span class="string"># Comma-separated list of headers to include in a response.</span></span><br><span class="line"><span class="meta">management.endpoints.web.cors.max-age</span>=<span class="string">1800s # How long the response from a pre-flight request can be cached by clients. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AUDIT EVENTS ENDPOINT (AuditEventsEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.auditevents.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.auditevents.enabled</span>=<span class="string">true # Whether to enable the auditevents endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BEANS ENDPOINT (BeansEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.beans.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.beans.enabled</span>=<span class="string">true # Whether to enable the beans endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CACHES ENDPOINT (CachesEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.caches.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.caches.enabled</span>=<span class="string">true # Whether to enable the caches endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CONDITIONS REPORT ENDPOINT (ConditionsReportEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.conditions.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.conditions.enabled</span>=<span class="string">true # Whether to enable the conditions endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CONFIGURATION PROPERTIES REPORT ENDPOINT (ConfigurationPropertiesReportEndpoint, ConfigurationPropertiesReportEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoint.configprops.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.configprops.enabled</span>=<span class="string">true # Whether to enable the configprops endpoint.</span></span><br><span class="line"><span class="meta">management.endpoint.configprops.keys-to-sanitize</span>=<span class="string">password,secret,key,token,.*credentials.*,vcap_services,sun.java.command # Keys that should be sanitized. Keys can be simple strings that the property ends with or regular expressions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENVIRONMENT ENDPOINT (EnvironmentEndpoint, EnvironmentEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoint.env.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.env.enabled</span>=<span class="string">true # Whether to enable the env endpoint.</span></span><br><span class="line"><span class="meta">management.endpoint.env.keys-to-sanitize</span>=<span class="string">password,secret,key,token,.*credentials.*,vcap_services,sun.java.command # Keys that should be sanitized. Keys can be simple strings that the property ends with or regular expressions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FLYWAY ENDPOINT (FlywayEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.flyway.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.flyway.enabled</span>=<span class="string">true # Whether to enable the flyway endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HEALTH ENDPOINT (HealthEndpoint, HealthEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoint.health.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.health.enabled</span>=<span class="string">true # Whether to enable the health endpoint.</span></span><br><span class="line"><span class="meta">management.endpoint.health.roles</span>= <span class="string"># Roles used to determine whether or not a user is authorized to be shown details. When empty, all authenticated users are authorized.</span></span><br><span class="line"><span class="meta">management.endpoint.health.show-details</span>=<span class="string">never # When to show full health details.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HEAP DUMP ENDPOINT (HeapDumpWebEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.heapdump.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.heapdump.enabled</span>=<span class="string">true # Whether to enable the heapdump endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP TRACE ENDPOINT (HttpTraceEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.httptrace.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.httptrace.enabled</span>=<span class="string">true # Whether to enable the httptrace endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># INFO ENDPOINT (InfoEndpoint)</span></span><br><span class="line"><span class="attr">info</span>= <span class="string"># Arbitrary properties to add to the info endpoint.</span></span><br><span class="line"><span class="meta">management.endpoint.info.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.info.enabled</span>=<span class="string">true # Whether to enable the info endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># INTEGRATION GRAPH ENDPOINT (IntegrationGraphEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.integrationgraph.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.integrationgraph.enabled</span>=<span class="string">true # Whether to enable the integrationgraph endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JOLOKIA ENDPOINT (JolokiaProperties)</span></span><br><span class="line"><span class="meta">management.endpoint.jolokia.config.*</span>= <span class="string"># Jolokia settings. Refer to the documentation of Jolokia for more details.</span></span><br><span class="line"><span class="meta">management.endpoint.jolokia.enabled</span>=<span class="string">true # Whether to enable the jolokia endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LIQUIBASE ENDPOINT (LiquibaseEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.liquibase.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.liquibase.enabled</span>=<span class="string">true # Whether to enable the liquibase endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LOG FILE ENDPOINT (LogFileWebEndpoint, LogFileWebEndpointProperties)</span></span><br><span class="line"><span class="meta">management.endpoint.logfile.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.logfile.enabled</span>=<span class="string">true # Whether to enable the logfile endpoint.</span></span><br><span class="line"><span class="meta">management.endpoint.logfile.external-file</span>= <span class="string"># External Logfile to be accessed. Can be used if the logfile is written by output redirect and not by the logging system itself.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LOGGERS ENDPOINT (LoggersEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.loggers.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.loggers.enabled</span>=<span class="string">true # Whether to enable the loggers endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># REQUEST MAPPING ENDPOINT  (MappingsEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.mappings.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.mappings.enabled</span>=<span class="string">true # Whether to enable the mappings endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># METRICS ENDPOINT (MetricsEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.metrics.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.metrics.enabled</span>=<span class="string">true # Whether to enable the metrics endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PROMETHEUS ENDPOINT (PrometheusScrapeEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.prometheus.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.prometheus.enabled</span>=<span class="string">true # Whether to enable the prometheus endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SCHEDULED TASKS ENDPOINT (ScheduledTasksEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.scheduledtasks.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.scheduledtasks.enabled</span>=<span class="string">true # Whether to enable the scheduledtasks endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SESSIONS ENDPOINT (SessionsEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.sessions.enabled</span>=<span class="string">true # Whether to enable the sessions endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SHUTDOWN ENDPOINT (ShutdownEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.shutdown.enabled</span>=<span class="string">false # Whether to enable the shutdown endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># THREAD DUMP ENDPOINT (ThreadDumpEndpoint)</span></span><br><span class="line"><span class="meta">management.endpoint.threaddump.cache.time-to-live</span>=<span class="string">0ms # Maximum time that a response can be cached.</span></span><br><span class="line"><span class="meta">management.endpoint.threaddump.enabled</span>=<span class="string">true # Whether to enable the threaddump endpoint.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HEALTH INDICATORS</span></span><br><span class="line"><span class="meta">management.health.db.enabled</span>=<span class="string">true # Whether to enable database health check.</span></span><br><span class="line"><span class="meta">management.health.cassandra.enabled</span>=<span class="string">true # Whether to enable Cassandra health check.</span></span><br><span class="line"><span class="meta">management.health.couchbase.enabled</span>=<span class="string">true # Whether to enable Couchbase health check.</span></span><br><span class="line"><span class="meta">management.health.defaults.enabled</span>=<span class="string">true # Whether to enable default health indicators.</span></span><br><span class="line"><span class="meta">management.health.diskspace.enabled</span>=<span class="string">true # Whether to enable disk space health check.</span></span><br><span class="line"><span class="meta">management.health.diskspace.path</span>= <span class="string"># Path used to compute the available disk space.</span></span><br><span class="line"><span class="meta">management.health.diskspace.threshold</span>=<span class="string">10MB # Minimum disk space that should be available.</span></span><br><span class="line"><span class="meta">management.health.elasticsearch.enabled</span>=<span class="string">true # Whether to enable Elasticsearch health check.</span></span><br><span class="line"><span class="meta">management.health.elasticsearch.indices</span>= <span class="string"># Comma-separated index names.</span></span><br><span class="line"><span class="meta">management.health.elasticsearch.response-timeout</span>=<span class="string">100ms # Time to wait for a response from the cluster.</span></span><br><span class="line"><span class="meta">management.health.influxdb.enabled</span>=<span class="string">true # Whether to enable InfluxDB health check.</span></span><br><span class="line"><span class="meta">management.health.jms.enabled</span>=<span class="string">true # Whether to enable JMS health check.</span></span><br><span class="line"><span class="meta">management.health.ldap.enabled</span>=<span class="string">true # Whether to enable LDAP health check.</span></span><br><span class="line"><span class="meta">management.health.mail.enabled</span>=<span class="string">true # Whether to enable Mail health check.</span></span><br><span class="line"><span class="meta">management.health.mongo.enabled</span>=<span class="string">true # Whether to enable MongoDB health check.</span></span><br><span class="line"><span class="meta">management.health.neo4j.enabled</span>=<span class="string">true # Whether to enable Neo4j health check.</span></span><br><span class="line"><span class="meta">management.health.rabbit.enabled</span>=<span class="string">true # Whether to enable RabbitMQ health check.</span></span><br><span class="line"><span class="meta">management.health.redis.enabled</span>=<span class="string">true # Whether to enable Redis health check.</span></span><br><span class="line"><span class="meta">management.health.solr.enabled</span>=<span class="string">true # Whether to enable Solr health check.</span></span><br><span class="line"><span class="meta">management.health.status.http-mapping</span>= <span class="string"># Mapping of health statuses to HTTP status codes. By default, registered health statuses map to sensible defaults (for example, UP maps to 200).</span></span><br><span class="line"><span class="meta">management.health.status.order</span>=<span class="string">DOWN,OUT_OF_SERVICE,UP,UNKNOWN # Comma-separated list of health statuses in order of severity.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP TRACING (HttpTraceProperties)</span></span><br><span class="line"><span class="meta">management.trace.http.enabled</span>=<span class="string">true # Whether to enable HTTP request-response tracing.</span></span><br><span class="line"><span class="meta">management.trace.http.include</span>=<span class="string">request-headers,response-headers,cookies,errors # Items to be included in the trace.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># INFO CONTRIBUTORS (InfoContributorProperties)</span></span><br><span class="line"><span class="meta">management.info.build.enabled</span>=<span class="string">true # Whether to enable build info.</span></span><br><span class="line"><span class="meta">management.info.defaults.enabled</span>=<span class="string">true # Whether to enable default info contributors.</span></span><br><span class="line"><span class="meta">management.info.env.enabled</span>=<span class="string">true # Whether to enable environment info.</span></span><br><span class="line"><span class="meta">management.info.git.enabled</span>=<span class="string">true # Whether to enable git info.</span></span><br><span class="line"><span class="meta">management.info.git.mode</span>=<span class="string">simple # Mode to use to expose git information.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># METRICS</span></span><br><span class="line"><span class="meta">management.metrics.distribution.maximum-expected-value.*</span>= <span class="string"># Maximum value that meter IDs starting-with the specified name are expected to observe.</span></span><br><span class="line"><span class="meta">management.metrics.distribution.minimum-expected-value.*</span>= <span class="string"># Minimum value that meter IDs starting-with the specified name are expected to observe.</span></span><br><span class="line"><span class="meta">management.metrics.distribution.percentiles.*</span>= <span class="string"># Specific computed non-aggregable percentiles to ship to the backend for meter IDs starting-with the specified name.</span></span><br><span class="line"><span class="meta">management.metrics.distribution.percentiles-histogram.*</span>= <span class="string"># Whether meter IDs starting with the specified name should publish percentile histograms.</span></span><br><span class="line"><span class="meta">management.metrics.distribution.sla.*</span>= <span class="string"># Specific SLA boundaries for meter IDs starting-with the specified name. The longest match wins.</span></span><br><span class="line"><span class="meta">management.metrics.enable.*</span>= <span class="string"># Whether meter IDs starting-with the specified name should be enabled. The longest match wins, the key `all` can also be used to configure all meters.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.api-token</span>= <span class="string"># AppOptics API token.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.batch-size</span>=<span class="string">500 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.connect-timeout</span>=<span class="string">5s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.host-tag</span>=<span class="string">instance # Tag that will be mapped to &quot;@host&quot; when shipping metrics to AppOptics.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.appoptics.uri</span>=<span class="string">https://api.appoptics.com/v1/measurements # URI to ship metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.config-refresh-frequency</span>=<span class="string">10s # Frequency for refreshing config settings from the LWC service.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.config-time-to-live</span>=<span class="string">150s # Time to live for subscriptions from the LWC service.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.config-uri</span>=<span class="string">http://localhost:7101/lwc/api/v1/expressions/local-dev # URI for the Atlas LWC endpoint to retrieve current subscriptions.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.eval-uri</span>=<span class="string">http://localhost:7101/lwc/api/v1/evaluate # URI for the Atlas LWC endpoint to evaluate the data for a subscription.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.lwc-enabled</span>=<span class="string">false # Whether to enable streaming to Atlas LWC.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.meter-time-to-live</span>=<span class="string">15m # Time to live for meters that do not have any activity. After this period the meter will be considered expired and will not get reported.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.atlas.uri</span>=<span class="string">http://localhost:7101/api/v1/publish # URI of the Atlas server.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.api-key</span>= <span class="string"># Datadog API key.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.application-key</span>= <span class="string"># Datadog application key. Not strictly required, but improves the Datadog experience by sending meter descriptions, types, and base units to Datadog.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.descriptions</span>=<span class="string">true # Whether to publish descriptions metadata to Datadog. Turn this off to minimize the amount of metadata sent.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.host-tag</span>=<span class="string">instance # Tag that will be mapped to &quot;host&quot; when shipping metrics to Datadog.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.datadog.uri</span>=<span class="string">https://app.datadoghq.com # URI to ship metrics to. If you need to publish metrics to an internal proxy en-route to Datadog, you can define the location of the proxy with this.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.api-token</span>= <span class="string"># Dynatrace authentication token.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.device-id</span>= <span class="string"># ID of the custom device that is exporting metrics to Dynatrace.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.technology-type</span>=<span class="string">java # Technology type for exported metrics. Used to group metrics under a logical technology name in the Dynatrace UI.</span></span><br><span class="line"><span class="meta">management.metrics.export.dynatrace.uri</span>= <span class="string"># URI to ship metrics to. Should be used for SaaS, self managed instances or to en-route through an internal proxy.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.auto-create-index</span>=<span class="string">true # Whether to create the index automatically if it does not exist.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.host</span>=<span class="string">http://localhost:9200 # Host to export metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.index</span>=<span class="string">metrics # Index to export metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.index-date-format</span>=<span class="string">yyyy-MM # Index date format used for rolling indices. Appended to the index name, preceded by a &#x27;-&#x27;.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.password</span>= <span class="string"># Login password of the Elastic server.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.timestamp-field-name</span>=<span class="string">@timestamp # Name of the timestamp field.</span></span><br><span class="line"><span class="meta">management.metrics.export.elastic.user-name</span>= <span class="string"># Login user of the Elastic server.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.addressing-mode</span>=<span class="string">multicast # UDP addressing mode, either unicast or multicast.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.duration-units</span>=<span class="string">milliseconds # Base time unit used to report durations.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.enabled</span>=<span class="string">true # Whether exporting of metrics to Ganglia is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.host</span>=<span class="string">localhost # Host of the Ganglia server to receive exported metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.port</span>=<span class="string">8649 # Port of the Ganglia server to receive exported metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.protocol-version</span>=<span class="string">3.1 # Ganglia protocol version. Must be either 3.1 or 3.0.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.rate-units</span>=<span class="string">seconds # Base time unit used to report rates.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.ganglia.time-to-live</span>=<span class="string">1 # Time to live for metrics on Ganglia. Set the multi-cast Time-To-Live to be one greater than the number of hops (routers) between the hosts.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.duration-units</span>=<span class="string">milliseconds # Base time unit used to report durations.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.enabled</span>=<span class="string">true # Whether exporting of metrics to Graphite is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.host</span>=<span class="string">localhost # Host of the Graphite server to receive exported metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.port</span>=<span class="string">2004 # Port of the Graphite server to receive exported metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.protocol</span>=<span class="string">pickled # Protocol to use while shipping data to Graphite.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.rate-units</span>=<span class="string">seconds # Base time unit used to report rates.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.graphite.tags-as-prefix</span>= <span class="string"># For the default naming convention, turn the specified tag keys into part of the metric prefix.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.api-token</span>= <span class="string"># Humio API token.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.connect-timeout</span>=<span class="string">5s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.repository</span>=<span class="string">sandbox # Name of the repository to publish metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.tags.*</span>= <span class="string"># Humio tags describing the data source in which metrics will be stored. Humio tags are a distinct concept from Micrometer&#x27;s tags. Micrometer&#x27;s tags are used to divide metrics along dimensional boundaries.</span></span><br><span class="line"><span class="meta">management.metrics.export.humio.uri</span>=<span class="string">https://cloud.humio.com # URI to ship metrics to. If you need to publish metrics to an internal proxy en-route to Humio, you can define the location of the proxy with this.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.auto-create-db</span>=<span class="string">true # Whether to create the Influx database if it does not exist before attempting to publish metrics to it.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.compressed</span>=<span class="string">true # Whether to enable GZIP compression of metrics batches published to Influx.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.consistency</span>=<span class="string">one # Write consistency for each point.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.db</span>=<span class="string">mydb # Tag that will be mapped to &quot;host&quot; when shipping metrics to Influx.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.password</span>= <span class="string"># Login password of the Influx server.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.retention-duration</span>= <span class="string"># Time period for which Influx should retain data in the current database.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.retention-shard-duration</span>= <span class="string"># Time range covered by a shard group.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.retention-policy</span>= <span class="string"># Retention policy to use (Influx writes to the DEFAULT retention policy if one is not specified).</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.retention-replication-factor</span>= <span class="string"># How many copies of the data are stored in the cluster.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.uri</span>=<span class="string">http://localhost:8086 # URI of the Influx server.</span></span><br><span class="line"><span class="meta">management.metrics.export.influx.user-name</span>= <span class="string"># Login user of the Influx server.</span></span><br><span class="line"><span class="meta">management.metrics.export.jmx.domain</span>=<span class="string">metrics # Metrics JMX domain name.</span></span><br><span class="line"><span class="meta">management.metrics.export.jmx.enabled</span>=<span class="string">true # Whether exporting of metrics to JMX is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.jmx.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.password</span>= <span class="string"># Login password of the KairosDB server.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.uri</span>= <span class="string">localhost:8080/api/v1/datapoints # URI of the KairosDB server.</span></span><br><span class="line"><span class="meta">management.metrics.export.kairos.user-name</span>= <span class="string"># Login user of the KairosDB server.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.account-id</span>= <span class="string"># New Relic account ID.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.api-key</span>= <span class="string"># New Relic API key.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.newrelic.uri</span>=<span class="string">https://insights-collector.newrelic.com # URI to ship metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.descriptions</span>=<span class="string">true # Whether to enable publishing descriptions as part of the scrape payload to Prometheus. Turn this off to minimize the amount of data sent on each scrape.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.enabled</span>=<span class="string">true # Whether exporting of metrics to Prometheus is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.pushgateway.base-url</span>=<span class="string">localhost:9091 # Base URL for the Pushgateway.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.pushgateway.enabled</span>=<span class="string">false # Enable publishing via a Prometheus Pushgateway.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.pushgateway.grouping-key</span>= <span class="string"># Grouping key for the pushed metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.pushgateway.job</span>= <span class="string"># Job identifier for this application instance.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.pushgateway.push-rate</span>=<span class="string">1m # Frequency with which to push metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.prometheus.pushgateway.shutdown-operation</span>= <span class="string"># Operation that should be performed on shutdown.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.access-token</span>= <span class="string"># SignalFX access token.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.source</span>= <span class="string"># Uniquely identifies the app instance that is publishing metrics to SignalFx. Defaults to the local host name.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.step</span>=<span class="string">10s # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.signalfx.uri</span>=<span class="string">https://ingest.signalfx.com # URI to ship metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.export.simple.enabled</span>=<span class="string">true # Whether, in the absence of any other exporter, exporting of metrics to an in-memory backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.simple.mode</span>=<span class="string">cumulative # Counting mode.</span></span><br><span class="line"><span class="meta">management.metrics.export.simple.step</span>=<span class="string">1m # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.enabled</span>=<span class="string">true # Whether exporting of metrics to StatsD is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.flavor</span>=<span class="string">datadog # StatsD line protocol to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.host</span>=<span class="string">localhost # Host of the StatsD server to receive exported metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.max-packet-length</span>=<span class="string">1400 # Total length of a single payload should be kept within your network&#x27;s MTU.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.polling-frequency</span>=<span class="string">10s # How often gauges will be polled. When a gauge is polled, its value is recalculated and if the value has changed (or publishUnchangedMeters is true), it is sent to the StatsD server.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.port</span>=<span class="string">8125 # Port of the StatsD server to receive exported metrics.</span></span><br><span class="line"><span class="meta">management.metrics.export.statsd.publish-unchanged-meters</span>=<span class="string">true # Whether to send unchanged meters to the StatsD server.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.api-token</span>= <span class="string"># API token used when publishing metrics directly to the Wavefront API host.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.batch-size</span>=<span class="string">10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.connect-timeout</span>=<span class="string">1s # Connection timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.enabled</span>=<span class="string">true # Whether exporting of metrics to this backend is enabled.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.global-prefix</span>= <span class="string"># Global prefix to separate metrics originating from this app&#x27;s white box instrumentation from those originating from other Wavefront integrations when viewed in the Wavefront UI.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.num-threads</span>=<span class="string">2 # Number of threads to use with the metrics publishing scheduler.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.read-timeout</span>=<span class="string">10s # Read timeout for requests to this backend.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.source</span>= <span class="string"># Unique identifier for the app instance that is the source of metrics being published to Wavefront. Defaults to the local host name.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.step</span>=<span class="string">10s # Step size (i.e. reporting frequency) to use.</span></span><br><span class="line"><span class="meta">management.metrics.export.wavefront.uri</span>=<span class="string">https://longboard.wavefront.com # URI to ship metrics to.</span></span><br><span class="line"><span class="meta">management.metrics.use-global-registry</span>=<span class="string">true # Whether auto-configured MeterRegistry implementations should be bound to the global static registry on Metrics.</span></span><br><span class="line"><span class="meta">management.metrics.tags.*</span>= <span class="string"># Common tags that are applied to every meter.</span></span><br><span class="line"><span class="meta">management.metrics.web.client.max-uri-tags</span>=<span class="string">100 # Maximum number of unique URI tag values allowed. After the max number of tag values is reached, metrics with additional tag values are denied by filter.</span></span><br><span class="line"><span class="meta">management.metrics.web.client.requests-metric-name</span>=<span class="string">http.client.requests # Name of the metric for sent requests.</span></span><br><span class="line"><span class="meta">management.metrics.web.server.auto-time-requests</span>=<span class="string">true # Whether requests handled by Spring MVC, WebFlux or Jersey should be automatically timed.</span></span><br><span class="line"><span class="meta">management.metrics.web.server.max-uri-tags</span>=<span class="string">100 # Maximum number of unique URI tag values allowed. After the max number of tag values is reached, metrics with additional tag values are denied by filter.</span></span><br><span class="line"><span class="meta">management.metrics.web.server.requests-metric-name</span>=<span class="string">http.server.requests # Name of the metric for received requests.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># DEVTOOLS PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DEVTOOLS (DevToolsProperties)</span></span><br><span class="line"><span class="meta">spring.devtools.add-properties</span>=<span class="string">true # Whether to enable development property defaults.</span></span><br><span class="line"><span class="meta">spring.devtools.livereload.enabled</span>=<span class="string">true # Whether to enable a livereload.com-compatible server.</span></span><br><span class="line"><span class="meta">spring.devtools.livereload.port</span>=<span class="string">35729 # Server port.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.additional-exclude</span>= <span class="string"># Additional patterns that should be excluded from triggering a full restart.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.additional-paths</span>= <span class="string"># Additional paths to watch for changes.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.enabled</span>=<span class="string">true # Whether to enable automatic restart.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.exclude</span>=<span class="string">META-INF/maven/**,META-INF/resources/**,resources/**,static/**,public/**,templates/**,**/*Test.class,**/*Tests.class,git.properties,META-INF/build-info.properties # Patterns that should be excluded from triggering a full restart.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.log-condition-evaluation-delta</span>=<span class="string">true # Whether to log the condition evaluation delta upon restart.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.poll-interval</span>=<span class="string">1s # Amount of time to wait between polling for classpath changes.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.quiet-period</span>=<span class="string">400ms # Amount of quiet time required without any classpath changes before a restart is triggered.</span></span><br><span class="line"><span class="meta">spring.devtools.restart.trigger-file</span>= <span class="string"># Name of a specific file that, when changed, triggers the restart check. If not specified, any classpath file change triggers the restart.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># REMOTE DEVTOOLS (RemoteDevToolsProperties)</span></span><br><span class="line"><span class="meta">spring.devtools.remote.context-path</span>=<span class="string">/.~~spring-boot!~ # Context path used to handle the remote connection.</span></span><br><span class="line"><span class="meta">spring.devtools.remote.proxy.host</span>= <span class="string"># The host of the proxy to use to connect to the remote application.</span></span><br><span class="line"><span class="meta">spring.devtools.remote.proxy.port</span>= <span class="string"># The port of the proxy to use to connect to the remote application.</span></span><br><span class="line"><span class="meta">spring.devtools.remote.restart.enabled</span>=<span class="string">true # Whether to enable remote restart.</span></span><br><span class="line"><span class="meta">spring.devtools.remote.secret</span>= <span class="string"># A shared secret required to establish a connection (required to enable remote support).</span></span><br><span class="line"><span class="meta">spring.devtools.remote.secret-header-name</span>=<span class="string">X-AUTH-TOKEN # HTTP header used to transfer the shared secret.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"><span class="comment"># TESTING PROPERTIES</span></span><br><span class="line"><span class="comment"># ----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">spring.test.database.replace</span>=<span class="string">any # Type of existing DataSource to replace.</span></span><br><span class="line"><span class="meta">spring.test.mockmvc.print</span>=<span class="string">default # MVC Print option.</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>Springboot</tag>
        <tag>Properties</tag>
      </tags>
  </entry>
</search>
