<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Spring Data ElasticSearch]]></title>
    <url>%2F2021%2F01%2F31%2FSpringDataElasticSearch%2F</url>
    <content type="text"><![CDATA[Spring Data ElasticSearchSpring Data ElasticSearch å…¥é—¨æ¡ˆä¾‹Spring Data å’Œ Elasticsearch ç»“åˆçš„æ—¶å€™ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§é—®é¢˜ï¼ŒElasticsearch å’Œ Spring Boot æ˜¯åŒæ—¶å‘å‰å‘å±•çš„ï¼Œè€Œ Elasticsearch çš„å¤§ç‰ˆæœ¬ä¹‹é—´è¿˜å­˜åœ¨ä¸€å®šçš„ API å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥å¿…é¡»è¦çŸ¥é“è¿™äº›ç‰ˆæœ¬ä¹‹é—´çš„å…³ç³»ï¼Œè¡¨æ ¼å¦‚ä¸‹ï¼š Spring Data Release Train Spring Data Elasticsearch Elasticsearch Spring Boot 2020.0.0[1] 4.1.x[1] 7.9.3 2.4.x[1] Neumann 4.0.x 7.6.2 2.3.x Moore 3.2.x 6.8.12 2.2.x Lovelace 3.1.x 6.2.2 2.1.x Kay[2] 3.0.x[2] 5.5.0 2.0.x[2] Ingalls[2] 2.1.x[2] 2.4.0 1.5.x[2] ç”±äºŽç‰ˆæœ¬è¶Šæ–°è¶Šä¾¿åˆ©ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ç›´æŽ¥é‡‡ç”¨æœ€æ–°çš„ç‰ˆæœ¬ã€‚ ç¬¬ä¸€æ­¥ï¼šåˆ©ç”¨ Helm Chart å®‰è£…ä¸€ä¸ª Elasticsearch é›†ç¾¤ 7.9.3 ç‰ˆæœ¬ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ã€‚ 121. helm2 repo add elastic https://helm.elastic.co2. helm2 install --name myelasticsearch elastic/elasticsearch --set imageTag=7.9.3 å®‰è£…å®Œä¹‹åŽï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ã€‚ è¿™ä»£è¡¨å®‰è£…æˆåŠŸã€‚ ç”±äºŽ ElasticSearch æ˜¯å‘å±•å˜åŒ–çš„ï¼Œæ‰€ä»¥å®ƒçš„å®‰è£…æ–¹å¼å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ ç„¶åŽåˆ©ç”¨ k8s é›†ç¾¤ç«¯å£æ˜ å°„åˆ°æœ¬åœ°ï¼Œå°±å¯ä»¥å¼€å§‹æµ‹è¯•äº†ã€‚ 123~ â¯â¯â¯ kubectl port-forward svc/elasticsearch-master 9200:9200 -n my-namespaceForwarding from 127.0.0.1:9200 -&gt; 9200Forwarding from [::1]:9200 -&gt; 9200 ç¬¬äºŒæ­¥ï¼šåœ¨ gradle.build é‡Œé¢é…ç½® Spring Data ElasticSearch ä¾èµ–çš„ Jar åŒ…ã€‚ ä¾èµ– Spring Boot 2.4.1 ç‰ˆæœ¬ï¼Œå®Œæ•´çš„ gradle.build æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920212223242526272829plugins &#123; id 'org.springframework.boot' version '2.4.1' id 'io.spring.dependency-management' version '1.0.10.RELEASE' id 'java'&#125;group = 'com.example.data.es'version = '0.0.1-SNAPSHOT'sourceCompatibility = '1.8'configurations &#123; compileOnly &#123; extendsFrom annotationProcessor &#125;&#125;repositories &#123; mavenCentral()&#125;dependencies &#123; implementation 'org.springframework.boot:spring-boot-starter-actuator' implementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch' implementation 'org.springframework.boot:spring-boot-starter-web' compileOnly 'org.projectlombok:lombok' developmentOnly 'org.springframework.boot:spring-boot-devtools' runtimeOnly 'io.micrometer:micrometer-registry-prometheus' annotationProcessor 'org.projectlombok:lombok' testImplementation 'org.springframework.boot:spring-boot-starter-test'&#125;test &#123; useJUnitPlatform()&#125; ç¬¬ä¸‰æ­¥ï¼šæ–°å»ºä¸€ä¸ªç›®å½•ï¼Œç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•ã€‚ ç¬¬å››æ­¥ï¼šåœ¨ application.properties é‡Œé¢æ–°å¢ž es çš„è¿žæŽ¥åœ°å€ï¼Œè¿žæŽ¥æœ¬åœ°çš„ Elasticsearchã€‚ 1spring.data.elasticsearch.client.reactive.endpoints=127.0.0.1:9200 ç¬¬äº”æ­¥ï¼šæ–°å¢žä¸€ä¸ª ElasticSearchConfiguration çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ˜¯ä¸ºäº†å¼€å¯æ‰«æçš„åŒ…ã€‚ 12345678package com.example.data.es.demo.es;import org.springframework.context.annotation.Configuration;import org.springframework.data.elasticsearch.repository.config.EnableElasticsearchRepositories;//åˆ©ç”¨@EnableElasticsearchRepositoriesæ³¨è§£æŒ‡å®šElasticsearchç›¸å…³çš„Repositoryçš„åŒ…è·¯å¾„åœ¨å“ªé‡Œ@EnableElasticsearchRepositories(basePackages = "com.example.data.es.demo.es")@Configurationpublic class ElasticSearchConfiguration &#123;&#125; ç¬¬å…­æ­¥ï¼šæ–°å¢žä¸€ä¸ª Topic çš„ Documentï¼Œå®ƒç±»ä¼¼ JPA é‡Œé¢çš„å®žä½“ï¼Œç”¨æ¥ä¿å­˜å’Œè¯»å– Topic çš„æ•°æ®ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122232425262728293031package com.example.data.es.demo.es;import lombok.Builder;import lombok.Data;import lombok.ToString;import org.springframework.data.annotation.Id;import org.springframework.data.elasticsearch.annotations.Document;import org.springframework.data.elasticsearch.annotations.Field;import org.springframework.data.elasticsearch.annotations.FieldType;import java.util.List;@Data@Builder@Document(indexName = "topic")@ToString(callSuper = true)//è®ºå›ä¸»é¢˜ä¿¡æ¯public class Topic &#123; @Id private Long id; private String title; @Field(type = FieldType.Nested, includeInParent = true) private List&lt;Author&gt; authors;&#125;package com.example.data.es.demo.es;import lombok.Builder;import lombok.Data;@Data@Builder//ä½œè€…ä¿¡æ¯public class Author &#123; private String name;&#125; ç¬¬ä¸ƒæ­¥ï¼šæ–°å»ºä¸€ä¸ª Elasticsearch çš„ Repositoryï¼Œç”¨æ¥å¯¹ Elasticsearch ç´¢å¼•çš„å¢žåˆ æ”¹æŸ¥ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567package com.example.data.es.demo.es;import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;import java.util.List;//ç±»ä¼¼JPAä¸€æ ·ç›´æŽ¥æ“ä½œTopicç±»åž‹çš„ç´¢å¼•public interface TopicRepository extends ElasticsearchRepository&lt;Topic,Long&gt; &#123; List&lt;Topic&gt; findByTitle(String title);&#125; ç¬¬å…«æ­¥: æ–°å»ºä¸€ä¸ª Controllerï¼Œå¯¹ Topic ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢å’Œæ·»åŠ ã€‚ 1234567891011121314151617@RestControllerpublic class TopicController &#123; @Autowired private TopicRepository topicRepository; //æŸ¥è¯¢topicçš„æ‰€æœ‰ç´¢å¼• @GetMapping("topics") public List&lt;Topic&gt; query(@Param("title") String title) &#123; return topicRepository.findByTitle(title); &#125; //ä¿å­˜ topicç´¢å¼• @PostMapping("topics") public Topic create(@RequestBody Topic topic) &#123; return topicRepository.save(topic); &#125;&#125; ç¬¬ä¹æ­¥ï¼šå‘é€ä¸€ä¸ªæ·»åŠ å’ŒæŸ¥è¯¢çš„è¯·æ±‚æµ‹è¯•ä¸€ä¸‹ã€‚ å‘é€ä¸‰ä¸ª POST è¯·æ±‚ï¼Œæ·»åŠ ä¸‰æ¡ç´¢å¼•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415POST /topics HTTP/1.1Host: 127.0.0.1:8080Content-Type: application/jsonCache-Control: no-cachePostman-Token: d9cc1f6c-24dd-17ff-f2e8-3063fa6b86fc&#123; "title":"jack", "id":2, "authors":[&#123; "name":"jk1" &#125;,&#123; "name":"jk2" &#125;]&#125; ç„¶åŽå‘é€ä¸€ä¸ª get è¯·æ±‚ï¼ŒèŽ·å¾—æ ‡é¢˜æ˜¯ jack çš„ç´¢å¼•ï¼Œå¦‚ä¸‹é¢è¿™è¡Œä»£ç æ‰€ç¤ºã€‚ 1GET http://127.0.0.1:8080/topics?title=jack å¾—åˆ°å¦‚ä¸‹ç»“æžœã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950GET http://127.0.0.1:8080/topics?title=jackHTTP/1.1 200 Content-Type: application/jsonTransfer-Encoding: chunkedDate: Wed, 30 Dec 2020 15:12:16 GMTKeep-Alive: timeout=60Connection: keep-alive[ &#123; "id": 1, "title": "jack", "authors": [ &#123; "name": "jk1" &#125;, &#123; "name": "jk2" &#125; ] &#125;, &#123; "id": 3, "title": "jack", "authors": [ &#123; "name": "jk1" &#125;, &#123; "name": "jk2" &#125; ] &#125;, &#123; "id": 2, "title": "jack", "authors": [ &#123; "name": "jk1" &#125;, &#123; "name": "jk2" &#125; ] &#125;]Response code: 200; Time: 348ms; Content length: 199 bytesCannot preserve cookies, cookie storage file is included in ignored list:&gt; /Users/jack/Company/git_hub/spring-data-jpa-guide/2.3/elasticsearch-data/.idea/httpRequests/http-client.cookies ä½¿ç”¨ Spring Data Elasticsearch æ¥æ“ä½œ ES ç›¸å…³çš„ API çš„è¯ï¼Œæ¯”ç›´æŽ¥å†™ Http çš„ client è¦ç®€å•å¾ˆå¤šï¼Œå› ä¸ºè¿™é‡Œé¢å°è£…äº†å¾ˆå¤šåŸºç¡€é€»è¾‘ï¼ŒçœåŽ»äº†å¾ˆå¤šé‡å¤é€ è½®å­çš„è¿‡ç¨‹ã€‚ ç¬¬åæ­¥ï¼šElasticsearch Repository çš„æµ‹è¯•ç”¨ä¾‹å†™æ³•ï¼Œå¦‚ä¸‹é¢çš„ä»£ç å’Œæ³¨é‡Šæ‰€ç¤ºã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960package com.example.data.es.demo;import com.example.data.es.demo.es.Author;import com.example.data.es.demo.es.Topic;import com.example.data.es.demo.es.TopicRepository;import org.assertj.core.util.Lists;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.TestPropertySource;import java.util.List;@SpringBootTest@TestPropertySource(properties = &#123;"logging.level.org.springframework.data.elasticsearch.core=TRACE", "logging.level.org.springframework.data.elasticsearch.client=trace", "logging.level.org.elasticsearch.client=TRACE", "logging.level.org.apache.http=TRACE"&#125;)//æ–°å¢žä¸€äº›é…ç½®ï¼Œ å¼€å¯spring data elastic searchçš„httpçš„è°ƒç”¨è¿‡ç¨‹ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹æ—¥å¿—public class ElasticSearchRepositoryTest &#123; @Autowired private TopicRepository topicRepository; @BeforeEach public void init() &#123;// topicRepository.deleteAll(); //å¯ä»¥ç›´æŽ¥åˆ é™¤æ‰€æœ‰ç´¢å¼• Topic topic = Topic.builder().id(11L) .title("jacktest") .authors(Lists.newArrayList(Author.builder() .name("jk1") .build())) .build(); topicRepository.save(topic);//é›†æˆæµ‹è¯•ä¿å­˜ç´¢å¼• Topic topic1 = Topic.builder().id(14L) .title("jacktest") .authors(Lists.newArrayList(Author.builder() .name("jk1") .build())) .build(); topicRepository.save(topic1); Topic topic2 = Topic.builder().id(15L) .title("jacktest") .authors(Lists.newArrayList(Author.builder() .name("jk1") .build())) .build(); topicRepository.save(topic2);//ä¿å­˜ç´¢å¼• &#125; @Test public void testTopic() &#123; Iterable&lt;Topic&gt; topics = topicRepository.findAll(); topics.forEach(topic1 -&gt; &#123; System.out.println(topic1); &#125;); List&lt;Topic&gt; topicList = topicRepository.findByTitle("jacktest"); topicList.forEach(t -&gt; &#123; System.out.println(t);//èŽ·å¾—ç´¢å¼•çš„æŸ¥è¯¢ç»“æžœ &#125;); List&lt;Topic&gt; topicList2 = topicRepository.findByTitle("xxx"); topicList2.forEach(t -&gt; &#123; System.out.println(t);//ä¹Ÿå¯ä»¥ç”¨æ–­è¨€æµ‹è¯• &#125;); &#125;&#125; æŽ¥ç€çœ‹ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹çš„è°ƒç”¨æ—¥å¿—ï¼Œä»Žæ—¥å¿—å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨çš„æ—¶å€™å‘ç”Ÿçš„ Http çš„ PUT è¯·æ±‚ï¼Œæ˜¯ç”¨æ¥åˆ›å»ºå’Œä¿®æ”¹ä¸€ä¸ªç´¢å¼•çš„æ–‡æ¡£çš„ã€‚è¯·çœ‹ä¸‹é¢çš„å›¾ç‰‡ã€‚ ä»Žä¸­ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œè½¬åŒ–æˆ es çš„ api æŸ¥è¯¢è¯­æ³•ä¹‹åŽï¼Œå‘é€çš„ post è¯·æ±‚åˆå˜æˆä¸‹å›¾æ˜¾ç¤ºçš„æ ·å­ã€‚ Spring Data ElasticSearch å…³é”®çš„ç±»é€šè¿‡ä¸Šé¢çš„æ¡ˆä¾‹å¯ä»¥çŸ¥é“ï¼ŒSpring Data ElasticSearch çš„ç”¨æ³•å…¶å®žéžå¸¸ç®€å•ï¼Œå¹¶ä¸”é€šè¿‡æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåº•å±‚å®žçŽ°æ˜¯åŸºäºŽ http è¯·æ±‚ï¼Œæ¥æ“ä½œ Elasticsearch çš„ server ä¸­çš„ api è¿›è¡Œçš„ã€‚ é‚£ä¹ˆç®€å•çœ‹ä¸€ä¸‹è¿™ä¸€æ¡†æž¶è¿˜æä¾›äº†å“ªäº› ElasticSearch çš„æ“ä½œæ–¹æ³•ã€‚çœ‹ä¸€ä¸‹ Repository çš„æ‰€æœ‰å­ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä»Žå›¾ä¸­å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼ŒElasticsearchRepository æ˜¯é»˜è®¤çš„ Repository çš„å®žçŽ°ç±»ï¼Œå¦‚æžœç»§ç»­å¾€ä¸‹é¢çœ‹æºç çš„è¯ï¼Œå°±å¯ä»¥çœ‹åˆ°é‡Œé¢è¿›è¡Œäº†å¾ˆå¤š ES çš„ Http Client æ“ä½œã€‚ åŒæ—¶å†çœ‹ä¸€ä¸‹ Structure è§†å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ ä»Žè¿™å¼ å›¾å¯ä»¥çŸ¥é“ï¼ŒElasticsearchRepository é»˜è®¤æä¾›äº† search å’Œ index ç›¸å…³çš„ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œå¹¶ä¸” Spring Data Common é‡Œé¢çš„ä¸€äº›å…¬å…±æ–¹æ³•åŒæ ·é€‚ç”¨ï¼Œè¿™å’Œåˆšæ‰æ¼”ç¤ºçš„ Defining Method Query çš„ JPA è¯­æ³•åŒæ ·é€‚ç”¨ï¼Œå¯ä»¥å¤§å¤§å‡è½»æ“ä½œ ES çš„éš¾åº¦ï¼Œæé«˜äº†å¼€å‘çš„æ•ˆçŽ‡ï¼Œç”šè‡³åƒåˆ†é¡µã€æŽ’åºã€limit ç­‰åŒæ ·é€‚ç”¨ã€‚ å’Œ Spring Data JPA ç”¨ç›¸åŒçš„æ€è·¯ï¼Œå°±å¯ä»¥å¾ˆå¿«æŽŒæ¡ Spring Data Elasticsearch çš„åŸºæœ¬ç”¨æ³•ï¼ŒåŠå…¶å¤§æ¦‚çš„å®žçŽ°æ€è·¯ã€‚ ESRepository å’Œ JPARepository åŒæ—¶å­˜åœ¨å‡è®¾åˆšæ‰æµ‹è¯•çš„æ ·ä¾‹é‡Œé¢ï¼ŒåŒæ—¶æœ‰å…³äºŽ User ä¿¡æ¯çš„ DB æ“ä½œï¼Œé‚£ä¹ˆé¡¹ç›®åº”è¯¥æ€Žä¹ˆå†™ã€‚ ç¬¬ä¸€æ­¥ï¼šå°†å¯¹ Elasticsearch çš„å®žä½“ã€Repository å’Œå¯¹ JPA æ“ä½œçš„å®žä½“ã€Repository æ”¾åˆ°ä¸åŒçš„æ–‡ä»¶é‡Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ç¬¬äºŒæ­¥ï¼šæ–°å¢ž JpaConfigurationï¼Œç”¨æ¥æŒ‡å®š Jpa ç›¸å…³çš„ Repository ç›®å½•ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ã€‚ 1234567package com.example.data.es.demo.jpa;import org.springframework.context.annotation.Configuration;import org.springframework.data.jpa.repository.config.EnableJpaRepositories;//åˆ©ç”¨ @EnableJpaRepositories æŒ‡å®šJPAçš„ç›®å½•æ˜¯ "com.example.data.es.demo.jpa"@EnableJpaRepositories(basePackages = "com.example.data.es.demo.jpa")@Configurationpublic class JpaConfiguration &#123;&#125; ç¬¬ä¸‰æ­¥ï¼šæ–°å¢ž User å®žä½“ï¼Œç”¨æ¥æ“ä½œç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€‚ 1234567891011121314@Data@Builder@Entity@Table@NoArgsConstructor@AllArgsConstructor@ToStringpublic class User &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email;&#125; ç¬¬å››æ­¥ï¼šæ–°å¢ž UserRepositoryï¼Œç”¨æ¥è¿›è¡Œ DB æ“ä½œã€‚ 12345package com.example.data.es.demo.jpa;import org.springframework.data.jpa.repository.JpaRepository;//å¯¹Userçš„DBæ“ä½œï¼Œç›´æŽ¥ç»§æ‰¿JpaRepositorypublic interface UserRepository extends JpaRepository&lt;User,Long&gt; &#123;&#125; ç¬¬äº”æ­¥ï¼šå†™æµ‹è¯•ç”¨ä¾‹è¿›è¡Œæµ‹è¯•ã€‚ 123456789101112131415161718192021222324252627package com.example.data.es.demo;import com.example.data.es.demo.jpa.User;import com.example.data.es.demo.jpa.UserRepository;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;import java.util.List;//åˆ©ç”¨@DataJpaTestå®Œæˆé›†æˆæµ‹è¯•@DataJpaTestpublic class UserRepositoryTest &#123; @Autowired private UserRepository userRepository; @Test public void testJpa() &#123; //å¾€æ•°æ®åº“é‡Œé¢ä¿å­˜ä¸€æ¡æ•°æ®ï¼Œå¹¶ä¸”æ‰“å°ä¸€ä¸‹ userRepository.save(User.builder().id(1L) .name("jkdb") .email("jack@email.com") .build()); List&lt;User&gt; users = userRepository.findAll(); users.forEach(user -&gt; &#123; System.out.println(user); &#125;); &#125;&#125; è¿™ä¸ªæ—¶å€™ï¼Œæµ‹è¯•ç”¨ä¾‹å°±å˜æˆäº†å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç»“æž„ã€‚ JPA å’Œ Elasticsearch åŒæ—¶å­˜åœ¨ï¼Œå’Œå¯åŠ¨é¡¹ç›®æ˜¯ä¸€æ ·çš„æ•ˆæžœï¼Œè¿™é‡Œå°±ä¸å†™ Controller äº†ã€‚ å†æ•´ä½“è¿è¡Œä¸€ä¸‹è¿™ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¿›è¡Œå®Œæ•´çš„æµ‹è¯•ï¼Œå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æžœã€‚ ElasticSearchRepositoryTest æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°è¿™æ˜¯å¯¹ ES è¿›è¡Œçš„æ“ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ UserRepositoryTest æ‰§è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹å‡ºæ¥è¿™æ˜¯å¯¹ DB è¿›è¡Œçš„æ“ä½œï¼Œæ‰€ä»¥è°ä¹Ÿä¸å½±å“è°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Spring Data å¯¹ JPA ç­‰ SQL åž‹çš„ä¼ ç»Ÿæ•°æ®åº“çš„æ”¯æŒæ˜¯éžå¸¸å¥½çš„ï¼ŒåŒæ—¶å¯¹ NoSQL åž‹çš„éžå…³ç³»ç±»æ•°æ®åº“çš„æ”¯æŒä¹Ÿæ¯”è¾ƒå‹å¥½ï¼Œå¤§å¤§é™ä½Žäº†æ“ä½œä¸åŒæ•°æ®æºçš„éš¾åº¦ï¼Œå¯ä»¥æœ‰æ•ˆæå‡å¼€å‘æ•ˆçŽ‡ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data ElasticSearch</category>
      </categories>
      <tags>
        <tag>Spring Data ElasticSearch</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•]]></title>
    <url>%2F2021%2F01%2F31%2FSpringDataJpa%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%92%8C%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95%2F</url>
    <content type="text"><![CDATA[å¦‚ä½•åˆ©ç”¨å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•è®©ä½ å¼€å‘æ•ˆçŽ‡ç¿»å€ï¼ŸSpring boot 2.1ï¼Œé‡Œé¢é»˜è®¤é›†æˆäº† junit5ï¼Œå…ˆä»Žæ•°æ®åº“å±‚å¼€å§‹ Spring Data JPA å•å…ƒæµ‹è¯•çš„æœ€ä½³å®žè·µSpring Data JPA Repository çš„æµ‹è¯•ç”¨ä¾‹ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ test çš„ä¾èµ–ï¼Œgradle çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚ 12testImplementation 'com.h2database:h2'testImplementation 'org.springframework.boot:spring-boot-starter-test' ç¬¬äºŒæ­¥ï¼šåˆ©ç”¨é¡¹ç›®é‡Œé¢çš„å®žä½“å’Œ Repositoryï¼Œå‡è®¾é¡¹ç›®é‡Œé¢æœ‰ Address å’Œ AddressRepositoryï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructorpublic class Address extends BaseEntity &#123; private String city; private String address;&#125;//Repositoryçš„DAOå±‚public interface AddressRepository extends JpaRepository&lt;Address, Long&gt;&#123; &#125; ç¬¬ä¸‰æ­¥ï¼šæ–°å»º RepsitoryTestï¼Œ@DataJpaTest å³å¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213@DataJpaTestpublic class AddressRepositoryTest &#123; @Autowired private AddressRepository addressRepository; //æµ‹è¯•ä¸€ä¸‹ä¿å­˜å’ŒæŸ¥è¯¢ @Test public void testSave() &#123; Address address = Address.builder().city("shanghai").build(); addressRepository.save(address); List&lt;Address&gt; address1 = addressRepository.findAll(); address1.stream().forEach(address2 -&gt; System.out.println(address2)); &#125;&#125; é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹å¯ä»¥çœ‹åˆ°ï¼Œç›´æŽ¥æ·»åŠ äº† @DataJpaTest æ³¨è§£ï¼Œç„¶åŽåˆ©ç”¨ Spring çš„æ³¨è§£ @Autowiredï¼Œå¼•å…¥äº† spring context é‡Œé¢ç®¡ç†çš„ AddressRepository å®žä¾‹ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨è¿™é‡Œé¢ä½¿ç”¨äº†é›†æˆæµ‹è¯•ï¼Œå³ç›´æŽ¥è¿žæŽ¥çš„æ•°æ®åº“æ¥å®Œæˆæ“ä½œã€‚ ç¬¬å››æ­¥ï¼šç›´æŽ¥è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç»“æžœã€‚ é€šè¿‡æµ‹è¯•ç»“æžœå¯ä»¥å‘çŽ°ï¼š æµ‹è¯•æ–¹æ³•é»˜è®¤éƒ½ä¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œæµ‹è¯•å®Œäº†ä¹‹åŽå°±ä¼šè¿›è¡Œå›žæ»šï¼› é‡Œé¢æ‰§è¡Œäº† insert å’Œ select ä¸¤ç§æ“ä½œï¼› å¦‚æžœå¼€å¯äº† Session Metrics çš„æ—¥å¿—çš„è¯ï¼Œä¹Ÿå¯ä»¥è§‚å¯Ÿå‡ºæ¥å…¶å‘ç”Ÿäº†ä¸€æ¬¡ connectionã€‚ é€šè¿‡è¿™ä¸ªæ¡ˆä¾‹ï¼Œå¯ä»¥çŸ¥é“ Repository çš„æµ‹è¯•ç”¨ä¾‹å†™èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå…¶ä¸­ä¸»è¦åˆ©ç”¨äº† @DataJpaTest çš„æ³¨è§£ã€‚ä¸‹é¢æ‰“å¼€ @DataJpaTest çš„æºç ï¼Œçœ‹ä¸€ä¸‹ã€‚ 12345678910111213141516171819@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Inherited@BootstrapWith(DataJpaTestContextBootstrapper.class) //æµ‹è¯•çŽ¯å¢ƒçš„å¯åŠ¨æ–¹å¼@ExtendWith(SpringExtension.class)//åŠ è½½äº†Springæµ‹è¯•çŽ¯å¢ƒ@OverrideAutoConfiguration(enabled = false)@TypeExcludeFilters(DataJpaTypeExcludeFilter.class)@Transactional@AutoConfigureCache@AutoConfigureDataJpa//åŠ è½½äº†ä¾èµ–Spring Data JPAçš„åŽŸæœ‰é…ç½®@AutoConfigureTestDatabase //åŠ è½½é»˜è®¤çš„æµ‹è¯•æ•°æ®åº“ï¼Œè¿™é‡Œé¢é‡‡ç”¨é»˜è®¤çš„H2@AutoConfigureTestEntityManager//åŠ è½½æµ‹è¯•æ‰€éœ€è¦çš„EntityManagerï¼Œä¸»è¦æ˜¯äº‹åŠ¡å¤„ç†æœºåˆ¶ä¸ä¸€æ ·@ImportAutoConfigurationpublic @interface DataJpaTest &#123; //é»˜è®¤æ‰“å¼€sqlçš„æŽ§åˆ¶å°è¾“å‡º @PropertyMapping("spring.jpa.show-sql") boolean showSql() default true;......&#125; Repository çš„æµ‹è¯•åœºæ™¯å¯èƒ½åœ¨å·¥ä½œä¸­ï¼Œæœ‰çš„åŒäº‹ä¼šè¯´æ²¡æœ‰å¿…è¦å†™ Repository çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå› ä¸ºå¥½å¤šæ–¹æ³•éƒ½æ˜¯æ¡†æž¶é‡Œé¢æä¾›çš„ï¼Œå†µä¸”è¿™ä¸ªä¸œè¥¿æ²¡æœ‰ä»€ä¹ˆé€»è¾‘ï¼Œå†™çš„æ—¶å€™æœ‰ç‚¹æµªè´¹æ—¶é—´ã€‚ å…¶å®žä¸ç„¶ï¼Œå¦‚æžœèƒ½æŠŠ Repository çš„æµ‹è¯•ç”¨å†™å¥½çš„è¯ï¼Œè¿™å¯¹æˆ‘ä»¬çš„å¼€å‘æ•ˆçŽ‡ç»å¯¹æ˜¯æœ‰æé«˜çš„ã€‚å¦åˆ™å½“ç»™ä½ ä¸€ä¸ªé¡¹ç›®ï¼Œè®©ä½ ç›´æŽ¥æ”¹é‡Œé¢çš„ä»£ç ï¼Œä½ å¯èƒ½å°±ä¼šæ¯”è¾ƒæ…Œï¼Œä¸æ•¢æ”¹ã€‚æ‰€æœ‰ä½ å°±è¦çŸ¥é“éƒ½æœ‰å“ªäº›åœºæ™¯æ˜¯å¿…é¡»è¦å†™ Repository çš„æµ‹è¯•ç”¨ä¾‹ã€‚ åœºæ™¯ä¸€ï¼šå½“æ–°å¢žä¸€ä¸ª Entity å’Œå®žä½“å¯¹åº”çš„ Repository çš„æ—¶å€™ï¼Œéœ€è¦å†™ä¸ªç®€å•çš„ save å’ŒæŸ¥è¯¢æµ‹è¯•ç”¨ä¾‹ï¼Œä¸»è¦ç›®çš„æ˜¯æ£€æŸ¥å®žä½“é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œå¦åˆ™å½“ä½ å†™äº†ä¸€å¤§å † Repository å’Œ Entity çš„æ—¶å€™ï¼Œå¯åŠ¨æŠ¥é”™ï¼Œä¸çŸ¥é“å“ªé‡Œé…ç½®å¾—æœ‰é—®é¢˜ï¼Œè¿™æ ·åè€Œä¼šé™ä½Žå¼€å‘æ•ˆçŽ‡ï¼› åœºæ™¯äºŒï¼šå½“å®žä½“é‡Œé¢æœ‰ä¸€äº› POJO çš„é€»è¾‘ï¼Œæˆ–è€…æŸäº›å­—æ®µå¿…é¡»è¦æœ‰çš„æ—¶å€™ï¼Œå°±éœ€è¦å†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹ï¼Œå‡è®¾ Address å®žä½“é‡Œé¢ä¸éœ€è¦æœ‰ address å±žæ€§å­—æ®µï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª @Transient çš„å­—æ®µå’Œè®¡ç®—é€»è¾‘ï¼Œè¿™æ—¶å°±éœ€è¦å†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹åŽ»éªŒè¯ä¸€ä¸‹äº†ã€‚ã€‚ 12345678910public class Address extends BaseEntity &#123; @JsonProperty("myCity") private String city; private String address; //å¿…è¦å­—æ®µ @Transient //éžæ•°æ®åº“å­—æ®µï¼Œæœ‰ä¸€äº›ç®€å•è¿ç®— private String addressAndCity; public String getAddressAndCity() &#123; return address+"ä¸€äº›ç®€å•é€»è¾‘"+city; &#125;&#125; åœºæ™¯ä¸‰ï¼šå½“æœ‰è‡ªå®šä¹‰çš„æ–¹æ³•çš„æ—¶å€™ï¼Œå°±å¯èƒ½éœ€è¦æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿”å›žç»“æžœæ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123public interface AddressRepository extends JpaRepository&lt;Address, Long&gt;&#123; Page&lt;Address&gt; findByAddress(@Param("address") String address, Pageable pageable);&#125; åœºæ™¯å››ï¼šå½“åˆ©ç”¨ @Query æ³¨è§£ï¼Œå†™äº†ä¸€äº› JPQL æˆ–è€… SQL çš„æ—¶å€™ï¼Œå°±éœ€è¦å†™ä¸€æ¬¡æµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä¸€ä¸‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345public interface AddressRepository extends JpaRepository&lt;Address, Long&gt;&#123; //é€šè¿‡@Queryæ³¨è§£è‡ªå®šçš„JPQLæˆ–Navicat SQL @Query(value = "FROM Address where deleted=false ") Page&lt;Address&gt; findAll(Pageable pageable);&#125; é‚£ä¹ˆå¯¹åº”çš„å¤æ‚ä¸€ç‚¹çš„æµ‹è¯•ç”¨ä¾‹å°±è¦å˜æˆå¦‚ä¸‹é¢è¿™æ®µä»£ç æ‰€ç¤ºçš„æ ·å­ã€‚ 1234567891011121314151617181920@TestInstance(TestInstance.Lifecycle.PER_CLASS)@DataJpaTestpublic class AddressRepositoryTest &#123; @Autowired private AddressRepository addressRepository; @BeforeAll //åˆ©ç”¨ @BeforeAllå‡†å¤‡ä¸€äº›Repositroyéœ€è¦çš„æµ‹æ•°æ® @Rollback(false)// ç”±äºŽæ¯ä¸ªæ–¹æ³•éƒ½æ˜¯æœ‰äº‹åŠ¡å›žæ»šæœºåˆ¶çš„ï¼Œä¸ºäº†æµ‹è¯• Repository å¯èƒ½éœ€è¦æ¨¡æ‹Ÿä¸€äº›æ•°æ®ï¼Œæ‰€ä»¥æ”¹å˜å›žæ»šæœºåˆ¶ @Transactional public void init() &#123; Address address = Address.builder().city("shanghaiDeleted").deleted(true).build(); addressRepository.save(address); &#125; //æµ‹è¯•æ²¡æœ‰åŒ…å«åˆ é™¤çš„è®°å½• @Test public void testFindAllNoDeleted() &#123; List&lt;Address&gt; address1 = addressRepository.findAll(); int deleteSize = address1.stream().filter(d-&gt;d.equals("shanghaiDeleted")).collect(Collectors.toList()).size(); Assertions.assertTrue(deleteSize==0); //æµ‹è¯•ä¸€ä¸‹ä¸åŒ…å«åˆ é™¤çš„æ¡æ•° &#125;&#125; åœºæ™¯äº”ï¼šå½“æµ‹è¯•ä¸€äº› JPA æˆ–è€… Hibernate çš„åº•å±‚ç‰¹æ€§çš„æ—¶å€™ï¼Œæµ‹è¯•ç”¨ä¾‹å¯ä»¥å¾ˆå¥½åœ°å¸®åŠ©æˆ‘ä»¬ã€‚å› ä¸ºå¦‚æžœä¾èµ–é¡¹ç›®å¯åŠ¨æ¥åšæµ‹è¯•ï¼Œæ•ˆçŽ‡å¤ªä½Žäº†ï¼Œä¾‹å¦‚ä¹‹å‰è®²çš„ä¸€äº› @PersistenceContext ç‰¹æ€§ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ç±»ä¼¼å¦‚ä¸‹çš„æµ‹è¯•ç”¨ä¾‹å®Œæˆæµ‹è¯•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142@TestInstance(TestInstance.Lifecycle.PER_CLASS)@DataJpaTest@Import(TestConfiguration.class)public class UserInfoRepositoryTest &#123; @Autowired private UserInfoRepository userInfoRepository; //æµ‹è¯•ä¸€äº›æ‰‹åŠ¨flushçš„æœºåˆ¶ @PersistenceContext (properties = &#123;@PersistenceProperty( name = "org.hibernate.flushMode", value = "MANUAL"//æ‰‹åŠ¨flush )&#125;) private EntityManager entityManager; @BeforeAll @Rollback(false) @Transactional public void init() &#123; //æå‰å‡†å¤‡ä¸€äº›æ•°æ®æ–¹ä¾¿æµ‹è¯• UserInfo u1 = UserInfo.builder().id(1L).lastName("jack").version(1).build(); userInfoRepository.save(u1); &#125; @Test @Transactional public void testLife() &#123; UserInfo userInfo = UserInfo.builder().name("new name").build(); //æ–°å¢žä¸€ä¸ªå¯¹è±¡userInfoäº¤ç»™PersistenceContextç®¡ç†ï¼Œå³ä¸€çº§ç¼“å­˜ entityManager.persist(userInfo); //æ­¤æ—¶æ²¡æœ‰detachå’Œclearä¹‹å‰ï¼Œflushçš„æ—¶å€™è¿˜ä¼šäº§ç”Ÿæ›´æ–°SQL userInfo.setName("old name"); entityManager.flush(); entityManager.clear();// entityManager.detach(userInfo);// entityManagerå·²ç»clearï¼Œæ­¤æ—¶å·²ç»ä¸ä¼šå¯¹UserInfoè¿›è¡Œæ›´æ–°äº† userInfo.setName("new name 11"); entityManager.flush(); //ç”±äºŽæœ‰cacheæœºåˆ¶ï¼Œç›¸åŒçš„å¯¹è±¡æŸ¥è¯¢åªä¼šè§¦å‘ä¸€æ¬¡æŸ¥è¯¢SQL UserInfo u1 = userInfoRepository.findById(1L).get(); //to do some thing UserInfo u2 = userInfoRepository.findById(1L).get(); &#125;&#125; é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯•çš„åŒºåˆ«ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•é€šä¿—æ¥è®²ï¼Œå°±æ˜¯ä¸ä¾èµ–æœ¬ç±»ä¹‹å¤–çš„ä»»ä½•æ–¹æ³•å®Œæˆæœ¬ç±»é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•çš„æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ä¾èµ–æœ¬ç±»ä¹‹å¤–çš„ï¼Œéƒ½é€šè¿‡ Mock çš„æ–¹å¼è¿›è¡Œã€‚ã€‚ Service å±‚å•å…ƒæµ‹è¯• é¦–å…ˆï¼Œæ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡ä¸­çš„ Service æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213@Componentpublic class UserInfoServiceImpl implements UserInfoService &#123; @Autowired private UserInfoRepository userInfoRepository; //å‡è®¾æœ‰ä¸ª findByUserId çš„æ–¹æ³•ç»è¿‡ä¸€äº›ä¸šåŠ¡é€»è¾‘è®¡ç®—è¿”å›žäº†ä¸€ä¸ªä¸šåŠ¡å¯¹è±¡ UserInfoDto @Override public UserInfoDto findByUserId(Long userId) &#123; UserInfo userInfo = userInfoRepository.findById(userId).orElse(new UserInfo()); //æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡è®¡ç®—æ”¹å˜ä¸€ä¸‹nameçš„å€¼è¿”å›ž UserInfoDto userInfoDto = UserInfoDto.builder().name(userInfo.getName()+"_HELLO").id(userInfo.getId()).build(); return userInfoDto; &#125;&#125; å…¶æ¬¡ï¼Œservice é€šè¿‡ Spring çš„ @Component æ³¨è§£è¿›è¡ŒåŠ è½½ï¼ŒUserInfoRepository é€šè¿‡ spring çš„ @Autowired æ³¨å…¥è¿›æ¥ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ findByUserId è¿™ä¸ªä¸šåŠ¡ service æ–¹æ³•ï¼Œå•å…ƒæµ‹è¯•å†™æ³•å¦‚ä¸‹ã€‚ 123456789101112131415161718@ExtendWith(SpringExtension.class)//é€šè¿‡è¿™ä¸ªæ³¨è§£åˆ©ç”¨Springçš„å®¹å™¨@Import(UserInfoServiceImpl.class)//å¯¼å…¥è¦æµ‹è¯•çš„UserInfoServiceImplpublic class UserInfoServiceTest &#123; @Autowired //åˆ©ç”¨springçš„å®¹å™¨ï¼Œå¯¼å…¥è¦æµ‹è¯•çš„UserInfoService private UserInfoService userInfoService; @MockBean //é‡Œé¢@MockBeanæ¨¡æ‹Ÿserviceä¸­ç”¨åˆ°çš„userInfoRepositoryï¼Œè¿™æ ·é¿å…çœŸå®žè¯·æ±‚æ•°æ®åº“ private UserInfoRepository userInfoRepository; // åˆ©ç”¨å•å…ƒæµ‹è¯•çš„æ€æƒ³ï¼Œmock userInfoService é‡Œé¢çš„ UserInfoRepositoryï¼Œè¿™æ ·Serviceå±‚å°±ä¸ç”¨è¿žæŽ¥æ•°æ®åº“ï¼Œå°±å¯ä»¥æµ‹è¯•è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘äº† @Test public void testGetUserInfoDto() &#123; //åˆ©ç”¨ Mockito æ¨¡æ‹Ÿå½“è°ƒç”¨ findById(1) çš„æ—¶å€™ï¼Œè¿”å›žæ¨¡æ‹Ÿæ•°æ® Mockito.when(userInfoRepository.findById(1L)) .thenReturn(java.util.Optional.ofNullable(UserInfo.builder().name("jack").id(1L).build())); UserInfoDto userInfoDto = userInfoService.findByUserId(1L); //ç»è¿‡ä¸€äº›serviceé‡Œé¢çš„é€»è¾‘è®¡ç®—ï¼ŒéªŒè¯ä¸€ä¸‹è¿”å›žç»“æžœæ˜¯å¦æ­£ç¡® Assertions.assertEquals("jack",userInfoDto.getName()); &#125;&#125; è¿™æ ·å°±å¯ä»¥å®Œæˆ Service å±‚çš„æµ‹è¯•äº†ã€‚ å…¶ä¸­ @ExtendWith(SpringExtension.class) æ˜¯ spring boot ä¸Ž Junit 5 ç»“åˆä½¿ç”¨çš„æ—¶å€™ï¼Œå½“åˆ©ç”¨ Spring çš„ TestContext è¿›è¡Œ mock æµ‹è¯•æ—¶è¦ä½¿ç”¨çš„ã€‚æœ‰çš„æ—¶å€™å¦‚æžœåšä¸€äº›ç®€å• Util çš„æµ‹è¯•ï¼Œå°±ä¸ä¸€å®šä¼šç”¨åˆ° SpringExtension.classã€‚ åœ¨ service çš„å•å…ƒæµ‹è¯•ä¸­ï¼Œä¸»è¦ç”¨åˆ°çš„çŸ¥è¯†ç‚¹æœ‰å››ä¸ªã€‚ é€šè¿‡ @ExtendWith(SpringExtension.class) åŠ è½½ Spring çš„æµ‹è¯•æ¡†æž¶åŠå…¶ TestContextï¼› é€šè¿‡ @Import(UserInfoServiceImpl.class) å¯¼å…¥å…·ä½“è¦æµ‹è¯•çš„ç±»ï¼Œè¿™æ · SpringTestContext å°±ä¸ç”¨åŠ è½½é¡¹ç›®é‡Œé¢çš„æ‰€æœ‰ç±»ï¼Œåªéœ€è¦åŠ è½½ UserInfoServiceImpl.class å°±å¯ä»¥äº†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œé€Ÿåº¦ï¼› é€šè¿‡ @MockBean æ¨¡æ‹Ÿ UserInfoServiceImpl ä¾èµ–çš„ userInfoRepositoryï¼Œå¹¶ä¸”è‡ªåŠ¨æ³¨å…¥ Spring test context é‡Œé¢ï¼Œè¿™æ · Service é‡Œé¢å°±è‡ªåŠ¨æœ‰ä¾èµ–äº†ï¼› åˆ©ç”¨ Mockito.when().thenReturn() çš„æœºåˆ¶ï¼Œæ¨¡æ‹Ÿæµ‹è¯•æ–¹æ³•ã€‚ è¿™æ ·å°±å¯ä»¥é€šè¿‡ Assertions é‡Œé¢çš„æ–­è¨€æ¥æµ‹è¯• service æ–¹æ³•é‡Œé¢çš„é€»è¾‘æ˜¯å¦ç¬¦åˆé¢„æœŸäº†ã€‚ Controller å±‚å•å…ƒæµ‹è¯• æ–°å¢žä¸€ä¸ª UserInfoController è·Ÿè¿› Id èŽ·å¾— UserInfoDto çš„ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910@RestControllerpublic class UserInfoController &#123; @Autowired private UserInfoService userInfoService; //è·Ÿè¿›UserIdå–ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ @GetMapping("/user/&#123;userId&#125;") public UserInfoDto findByUserId(@PathVariable Long userId) &#123; return userInfoService.findByUserId(userId); &#125;&#125; Controller é‡Œé¢å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142package com.example.jpa.demo;import com.example.jpa.demo.service.UserInfoService;import com.example.jpa.demo.service.dto.UserInfoDto;import com.example.jpa.demo.web.UserInfoController;import org.junit.jupiter.api.Test;import org.mockito.Mockito;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;import org.springframework.boot.test.mock.mockito.MockBean;import org.springframework.http.MediaType;import org.springframework.mock.web.MockHttpServletResponse;import org.springframework.test.web.servlet.MockMvc;import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;import org.springframework.test.web.servlet.result.MockMvcResultMatchers;import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;@WebMvcTest(UserInfoController.class)public class UserInfoControllerTest &#123; @Autowired private MockMvc mvc; @MockBean private UserInfoService userInfoService; //å•å…ƒæµ‹è¯•mvcçš„controllerçš„æ–¹æ³• @Test public void testGetUserDto() throws Exception &#123; //åˆ©ç”¨ @MockBeanï¼Œå½“è°ƒç”¨ userInfoServiceçš„findByUserId(1)çš„æ—¶å€™è¿”å›žä¸€ä¸ªæ¨¡æ‹Ÿçš„UserInfoDtoæ•°æ® Mockito.when(userInfoService.findByUserId(1L)) .thenReturn(UserInfoDto.builder().name("jack").id(1L).build()); //åˆ©ç”¨mvcéªŒè¯ä¸€ä¸‹Controlleré‡Œé¢çš„è§£å†³æ˜¯å¦OK MockHttpServletResponse response = mvc .perform(MockMvcRequestBuilders .get("/user/1/")//è¯·æ±‚çš„path .accept(MediaType.APPLICATION_JSON)//è¯·æ±‚çš„mediaTypeï¼Œè¿™é‡Œé¢å¯ä»¥åŠ ä¸Šå„ç§éœ€è¦çš„Header ) .andDo(print())//æ‰“å°ä¸€ä¸‹ .andExpect(status().isOk()) .andExpect(MockMvcResultMatchers.jsonPath("$.name").value("jack")) .andReturn().getResponse(); System.out.println(response); &#125;&#125; å…¶ä¸­ä¸»è¦åˆ©ç”¨äº† @WebMvcTest æ³¨è§£ï¼Œæ¥å¼•å…¥è¦æµ‹è¯•çš„ Controllerã€‚æ‰“å¼€ @WebMvcTest å¯ä»¥çœ‹åˆ°å…³é”®æºç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ @WebMvcTest åŠ è½½äº† @ExtendWith(SpringExtension.class)ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–æŒ‡å®šï¼Œå°±æ‹¥æœ‰äº† Spring çš„ test contextï¼Œå¹¶ä¸”ä¹Ÿè‡ªåŠ¨åŠ è½½äº† mvc æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ WebMvctestContextbootstrapperã€‚ æœ‰çš„æ—¶å€™å¯èƒ½æœ‰ä¸€äº›å…¨å±€çš„ Filterï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ­¤æ³¨è§£é‡Œé¢çš„ includeFilters å’Œ excluedeFilters åŠ è½½å’ŒæŽ’é™¤éœ€è¦çš„ WebMvcFilter è¿›è¡Œæµ‹è¯•ã€‚ å½“é€šè¿‡ @WebMvcTest(UserInfoController.class) å¯¼å…¥éœ€è¦æµ‹è¯•çš„ Controller ä¹‹åŽï¼Œå°±å¯ä»¥å†é€šè¿‡ MockMvc è¯·æ±‚åˆ°åŠ è½½çš„ Controller é‡Œé¢çš„ path äº†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ MockMvc æä¾›çš„ä¸€äº›æ–¹æ³•å‘é€è¯·æ±‚ï¼ŒéªŒè¯ Controller çš„å“åº”ç»“æžœã€‚ ä¸‹é¢æ¦‚æ‹¬ä¸€ä¸‹ Controller å±‚å•å…ƒæµ‹è¯•ä¸»è¦ç”¨åˆ°çš„ä¸‰ä¸ªçŸ¥è¯†ç‚¹ã€‚ åˆ©ç”¨ @WebMvcTest æ³¨è§£ï¼ŒåŠ è½½è¦æµ‹è¯•çš„ Controllerï¼ŒåŒæ—¶ç”Ÿæˆ mvc æ‰€éœ€è¦çš„ Test Contextï¼› åˆ©ç”¨ @MockBean é»˜è®¤ Controller é‡Œé¢çš„ä¾èµ–ï¼Œå¦‚ Serviceï¼Œå¹¶é€šè¿‡ Mockito.when().thenReturn()ï¼›çš„è¯­æ³• mock ä¾èµ–çš„æµ‹è¯•æ•°æ®ï¼› åˆ©ç”¨ MockMvc ä¸­æä¾›çš„æ–¹æ³•ï¼Œå‘é€ Controller çš„ Rest é£Žæ ¼çš„è¯·æ±‚ï¼Œå¹¶éªŒè¯è¿”å›žç»“æžœå’ŒçŠ¶æ€ç ã€‚ ä»€ä¹ˆæ˜¯é›†æˆæµ‹è¯•é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æŒ‡å¤šä¸ªæ¨¡å—æ”¾åœ¨ä¸€èµ·æµ‹è¯•ï¼Œå’Œå•å…ƒæµ‹è¯•æ­£å¥½ç›¸åï¼Œå¹¶éžé‡‡ç”¨ mock çš„æ–¹å¼æµ‹è¯•ï¼Œè€Œæ˜¯é€šè¿‡ç›´æŽ¥è°ƒç”¨çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ã€‚ä¹Ÿå°±æ˜¯è¯´ä¾èµ– spring å®¹å™¨è¿›è¡Œå¼€å‘ï¼Œæ‰€æœ‰çš„ç±»ä¹‹é—´ç›´æŽ¥è°ƒç”¨ï¼Œæ¨¡æ‹Ÿåº”ç”¨çœŸå®žå¯åŠ¨æ—¶å€™çš„çŠ¶æ€ã€‚ Service å±‚çš„åŸºå±‚æµ‹è¯•ç”¨ä¾‹å†™æ³• è¿˜ç”¨åˆšæ‰çš„ä¾‹å­ï¼Œçœ‹ä¸€ä¸‹ UserInfoService é‡Œé¢çš„ findByUserId é€šè¿‡é›†æˆæµ‹è¯•å¦‚ä½•è¿›è¡Œã€‚æµ‹è¯•ç”¨ä¾‹çš„å†™æ³•å¦‚ä¸‹ã€‚ 1234567891011121314151617@DataJpaTest@ComponentScan(basePackageClasses= UserInfoServiceImpl.class)public class UserInfoServiceIntegrationTest &#123; @Autowired private UserInfoService userInfoService; @Autowired private UserInfoRepository userInfoRepository; @Test @Rollback(false)//å¦‚æžœäº‹åŠ¡å›žæ»šè®¾ç½®æˆfalseçš„è¯ï¼Œæ•°æ®åº“å¯ä»¥çœŸå®žçœ‹åˆ°è¿™æ¡æ•°æ® public void testIntegtation() &#123; UserInfo u1 = UserInfo.builder().name("jack-db").ages(20).id(1L).telephone("1233456").build(); //æ•°æ®åº“çœŸå®žåŠ ä¸€æ¡æ•°æ® userInfoRepository.save(u1);//æ•°æ®åº“é‡Œé¢çœŸå®žä¿å­˜ä¸€æ¡æ•°æ® UserInfoDto userInfoDto = userInfoService.findByUserId(1L); userInfoDto.getName(); Assertions.assertEquals(userInfoDto.getName(),u1.getName()+"_HELLO"); &#125;&#125; æ‰§è¡Œä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œç»“æžœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ è¿™æ—¶ä¼šå‘çŽ°æ•°æ®å·²ç»ä¸å†å›žæ»šï¼Œä¹Ÿä¼šæ­£å¸¸åœ°æ‰§è¡Œ SQLï¼Œè€Œä¸æ˜¯é€šè¿‡ Mock çš„æ–¹å¼æµ‹è¯•ã€‚ Controller å±‚çš„é›†æˆæµ‹è¯•ç”¨ä¾‹çš„å†™æ³• ç”¨é›†æˆæµ‹è¯•æŠŠåˆšæ‰ UserInfoCotroller å†™çš„ user/1/ æŽ¥å£æµ‹è¯•ä¸€ä¸‹ï¼Œå°†é›†æˆæµ‹è¯•çš„ä»£ç åšå¦‚ä¸‹æ”¹åŠ¨ã€‚ 1234567891011121314@SpringBootTest(classes = DemoApplication.class, webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) //åŠ è½½ DemoApplicationï¼ŒæŒ‡å®šä¸€ä¸ªéšæœºç«¯å£public class UserInfoControllerIntegrationTest &#123; @LocalServerPort //èŽ·å¾—æ¨¡æ‹Ÿçš„éšæœºç«¯å£ private int port; @Autowired //åˆ©ç”¨ RestTemplateï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚ private TestRestTemplate restTemplate; @Test public void testAllUserDtoIntegration() &#123; UserInfoDto userInfoDto = this.restTemplate .getForObject("http://localhost:" + port + "/user/1", UserInfoDto.class);//çœŸå®žè¯·æ±‚æœ‰ä¸€ä¸ªåŽå°çš„API Assertions.assertNotNull(userInfoDto); &#125;&#125; å†çœ‹æ—¥å¿—çš„è¯ï¼Œä¼šå‘çŽ°æ­¤æ¬¡çš„æµ‹è¯•ç”¨ä¾‹ä¼šåœ¨å†…éƒ¨å¯åŠ¨ä¸€ä¸ª tomcat å®¹å™¨ï¼Œç„¶åŽå†åˆ©ç”¨ TestResTemplate è¿›è¡ŒçœŸå®žè¯·æ±‚ï¼Œè¿”å›žæµ‹è¯•ç»“æžœè¿›è¡Œæµ‹è¯•ã€‚ è€Œå…¶ä¸­ä¼šæ¶‰åŠä¸€ä¸ªæ³¨è§£ @SpringBootTestï¼Œå®ƒç”¨æ¥æŒ‡å®š Spring åº”ç”¨çš„ç±»æ˜¯å“ªä¸ªï¼Œä¹Ÿå°±æ˜¯çœŸå®žé¡¹ç›®çš„ Application å¯åŠ¨ç±»ï¼›ç„¶åŽä¼šæŒ‡å®šä¸€ä¸ªç«¯å£ï¼Œæ­¤å¤„å¿…é¡»ä½¿ç”¨éšæœºç«¯å£ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å†²çªï¼ˆå¦‚æžœå¯åŠ¨çš„é›†æˆæµ‹è¯•æœ‰ç‚¹å¤šçš„æƒ…å†µï¼‰ã€‚æ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¦‚æžœçœ‹ @SprintBootTest æºç çš„è¯ï¼Œä¼šå‘çŽ°è¿™ä¸ªæ³¨è§£ä¹Ÿæ˜¯åŠ è½½äº† Spring çš„æµ‹è¯•çŽ¯å¢ƒ SpringExtension.classï¼Œå¹¶ä¸”é‡Œé¢æœ‰å¾ˆå¤šå±žæ€§å¯ä»¥è®¾ç½®ï¼Œæµ‹è¯•çš„æ—¶å€™çš„é…ç½®æ–‡ä»¶ properties å’Œä¸€äº›å¯åŠ¨çš„çŽ¯å¢ƒå˜é‡ WebEnvï¼›ç„¶åŽåˆåˆ©ç”¨äº† Spring Boot Test æä¾›çš„ @LocalServerPort èŽ·å¾—å¯åŠ¨æ—¶å€™çš„ç«¯å£ã€‚æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ é›†æˆæµ‹è¯•çš„ä¸€äº›æ€è€ƒ æ‰€æœ‰çš„æ–¹æ³•éƒ½éœ€è¦é›†æˆæµ‹è¯•å—ï¼Ÿ è¿™æ˜¯å†™é›†æˆæµ‹è¯•ç”¨çš„æ—¶å€™éœ€è¦æ€è€ƒçš„ï¼Œå› ä¸ºé›†æˆæµ‹è¯•ç”¨ä¾‹éœ€è¦å†…éƒ¨å¯åŠ¨ Tomcat å®¹å™¨ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¯åŠ¨å¾—æ…¢ä¸€ç‚¹ã€‚å¦‚æžœé¡¹ç›®åŠ è½½çš„é…ç½®æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼ŒåŠ¿å¿…ä¼šå¯¼è‡´æµ‹è¯•ä¹Ÿä¼šå˜æ…¢ã€‚å‡è®¾æµ‹è¯•ä¸€ä¸ªç®€å•çš„é€»è¾‘å°±éœ€è¦å¯åŠ¨æ•´ä¸ª Applicationï¼Œé‚£ä¹ˆæ˜¾ç„¶æ˜¯ä¸å¦¥çš„ã€‚ é‚£ä¹ˆæ•´ä¸ª Application ä¸éœ€è¦é›†æˆæµ‹è¯•å—ï¼Ÿä¹Ÿæ˜¾ç„¶ä¸æ˜¯çš„ï¼Œå› ä¸ºæœ‰äº›æ—¶å€™åªæœ‰é›†æˆåœ¨ä¸€èµ·æ‰ä¼šå‘ç”Ÿé—®é¢˜ï¼Œæœ€ç®€å•çš„ä¸€ä¸ªé›†æˆæµ‹è¯•æ˜¯éœ€è¦æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥ä¸€ä¸ªé¡¹ç›®é‡Œé¢ä¼šæœ‰ä¸ª ApplicationTests æ¥æµ‹è¯•é¡¹ç›®æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567@SpringBootTestclass DemoApplicationTests &#123; // æµ‹è¯•é¡¹ç›®æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ @Test void contextLoads() &#123; &#125;&#125; ä¸€å®šæ˜¯éžé›†æˆæµ‹è¯•å°±æ˜¯å•å…ƒæµ‹è¯•å—ï¼Ÿ å®žé™…å·¥ä½œä¸­å¹¶æ²¡æœ‰åˆ’åˆ†é‚£ä¹ˆæ¸…æ¥šï¼Œæœ‰çš„æ—¶å€™é›†æˆäº† N ä¸ªç»„ä»¶ä¸€èµ·æµ‹è¯•ï¼Œå¯èƒ½å°±æ˜¯ä¸è¿žæ•°æ®åº“ã€‚æ¯”å¦‚å¯èƒ½ä¼šä½¿ç”¨ Feign-Client æ ¹æ®ç¬¬ä¸‰æ–¹çš„æŽ¥å£èŽ·å–ä¸€äº›æ•°æ®ï¼Œé‚£ä¹ˆæ­£å¸¸çš„åšæ³•å°±æ˜¯æ–°å»ºä¸€ä¸ª Serviceï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678/** * æµ‹è¯•æ™®é€šJSONè¿”å›žç»“æžœï¼Œæ ¹æ®ç¬¬ä¸‰æ–¹æŽ¥å£å–ä¸€ä¸ªæ•°æ® */@FeignClient(name = "aocFeignTest", url = "http://room-api.staging.jack.net")interface AppSettingService &#123; @GetMapping("/api/v1/app/globalSettings") HashMap&lt;String,Object&gt; getAppSettings();&#125; é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¦‚æžœè¦æµ‹è¯•ï¼Œæ˜¾ç„¶ä¸éœ€è¦å¯åŠ¨æ•´ä¸ª Application æ¥å®Œæˆï¼Œä½†æ˜¯éœ€è¦æŒ‰éœ€åŠ è½½ä¸€äº› Configuration æ‰èƒ½æµ‹è¯•ï¼Œé‚£ä¹ˆæµ‹è¯•ç”¨ä¾‹ä¼šå˜æˆå¦‚ä¸‹æƒ…å†µã€‚ 123456789101112131415@ExtendWith(SpringExtension.class)//åˆ©ç”¨Springä¸Šä¸‹æ–‡@Import(&#123;FeignSimpleConfiguration.class, FeignAutoConfiguration.class, HttpMessageConvertersAutoConfiguration.class, JacksonAutoConfiguration.class&#125;)//å¯¼å…¥æ­¤å¤„Fegin-Clientæµ‹è¯•æ‰€éœ€è¦çš„é…ç½®æ–‡ä»¶@EnableFeignClients(clients = AppSettingService.class)//é€šè¿‡FeignClientçš„æ³¨è§£åŠ è½½AppSettingServiceå®¢æˆ·ç«¯ã€‚/** * ä¾èµ–HTTPMessageConverterçš„ä½¿ç”¨æ–¹æ³•(import FeignSimpleConfiguration junit) */public class FeignJsonTest &#123; @Autowired // åˆ©ç”¨Springçš„ä¸Šä¸‹æ–‡æ³¨å…¥appSettingService private AppSettingService appSettingService; @Test public void testJsonFeignClient() &#123; HashMap&lt;String,Object&gt; r = .getAppSettings(); Assert.assertNotNull(r.get("data"));//æµ‹è¯•ä¸€ä¸‹æŽ¥å£è¿”å›žçš„ç»“æžœ &#125;&#125; è¿™ä¸ªæ—¶å€™å…¶å®žå¹¶æ²¡æœ‰å¯åŠ¨è¿™ä¸ª Applicationï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿé›†æˆäº† Fegin-Client æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ Configurationï¼Œä»Žè€Œåˆ©ç”¨ SpringExtension åŠ è½½æ‰€éœ€è¦ä¾èµ–çš„ç±»ï¼Œå®Œæˆä¸€æ¬¡æµ‹è¯•ã€‚ æ‰€ä»¥ä¸€å®šè¦æ ¹æ®è‡ªå·±çš„å®žé™…éœ€è¦é€‰æ‹©æ€§åœ°åŠ è½½ä¸€äº›ç±»æ¥å®Œæˆæµ‹è¯•ç”¨ä¾‹ï¼Œè€Œä¸æ˜¯æ¯æ¬¡æµ‹è¯•çš„æ—¶å€™éƒ½éœ€è¦æŠŠæ‰€æœ‰ç±»éƒ½åŠ è½½ä¸€éï¼Œè¿™æ ·è¿”å›žä¼šä½¿æµ‹è¯•ç”¨ä¾‹çš„æ—¶é—´å˜é•¿ï¼Œä»Žè€Œé™ä½Žå·¥ä½œæ•ˆçŽ‡ã€‚ Junit 4 å’Œ Junit 5 åœ¨ Spring Boot ä¸­çš„åŒºåˆ«ç¬¬ä¸€ï¼ŒSpring Boot 2.2+ ä»¥ä¸Šçš„ç‰ˆæœ¬é»˜è®¤å¯¼å…¥çš„æ˜¯ Junit 5 çš„ jar åŒ…ä¾èµ–ï¼Œä»¥ä¸‹çš„ç‰ˆæœ¬é»˜è®¤å¯¼å…¥çš„æ˜¯ Junit 4 çš„ jar åŒ…ä¾èµ–çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ Spring Boot çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹ä¾èµ–çš„ jar åŒ…æ˜¯å¦é½å…¨ã€‚ ç¬¬äºŒï¼Œorg.junit.junit.Test å˜æˆäº† org.junit.jupiter.api.Testã€‚ ç¬¬ä¸‰ï¼Œä¸€äº›æ³¨è§£å‘ç”Ÿäº†å˜åŒ–ï¼š @Before å˜æˆäº† @BeforeEach @After å˜æˆäº† @AfterEach @BeforeClass å˜æˆäº† @BeforeAll @AfterClass å˜æˆäº† @AfterAll @Ignore å˜æˆäº† @Disabled @Category å˜æˆäº† @Tag @Rule å’Œ @ClassRule æ²¡æœ‰äº†ï¼Œç”¨ @ExtendWith å’Œ @RegisterExtension ä»£æ›¿ ç¬¬å››ï¼Œå¼•ç”¨ Spring çš„ä¸Šä¸‹æ–‡ @RunWith(SpringRunner.class) å˜æˆäº† @ExtendWith(SpringExtension.class)ã€‚ ç¬¬äº”ï¼Œorg.junit.Assert ä¸‹é¢çš„æ–­è¨€éƒ½ç§»åˆ°äº†org.junit.jupiter.api.Assertions ä¸‹é¢ï¼Œæ‰€ä»¥ä¸€äº›æ–­è¨€çš„å†™æ³•ä¼šå‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š 123456//junit4æ–­è¨€çš„å†™æ³•Assert.assertEquals(200, result.getStatusCodeValue());Assert.assertEquals(true, result.getBody().contains("employeeList"));//junit5æ–­è¨€çš„å†™æ³•Assertions.assertEquals(400, ex.getRawStatusCode());Assertions.assertEquals(true, ex.getResponseBodyAsString().contains("Missing request header")); ç¬¬å…­ï¼ŒJunit 5 æä¾› @DisplayName(&quot;Test MyClass&quot;) ç”¨æ¥æ ‡è¯†æ­¤æ¬¡å•å…ƒæµ‹è¯•çš„åå­—ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678@DisplayName("Test MyClass")class MyClassTest &#123; @Test @DisplayName("Verify MyClass.myMethod returns true") void testMyMethod() throws Exception &#123; // ... &#125;&#125;]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa ä»€ä¹ˆæ˜¯ Spring Data Rest]]></title>
    <url>%2F2021%2F01%2F30%2FSpringDataJpa%E4%B9%8BSpringDataRest%2F</url>
    <content type="text"><![CDATA[Spring Data Rest æ˜¯ä»€ä¹ˆ å’Œ JPA æ˜¯ä»€ä¹ˆå…³ç³»?Spring Data Rest Demoé€šè¿‡ä»¥ä¸‹å››ä¸ªæ­¥éª¤æ¼”ç¤ºä¸€ä¸‹ Spring Data Rest çš„æ•ˆæžœã€‚ ç¬¬ä¸€æ­¥ï¼šé€šè¿‡ gradle å¼•å…¥ç›¸å…³çš„ jar ä¾èµ–ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567implementation 'org.springframework.boot:spring-boot-starter-data-jpa'// spring data restçš„ä¾èµ–ï¼Œç”±äºŽä½¿ç”¨çš„æ˜¯spring bootï¼Œæ‰€ä»¥åªéœ€è¦æ·»åŠ starterå³å¯implementation("org.springframework.boot:spring-boot-starter-data-rest")//æ·»åŠ swaggeræ–¹ä¾¿çœ‹å¾—å‡ºæ¥ï¼Œç”Ÿæˆäº†å“ªäº›apiæŽ¥å£implementation 'io.springfox:springfox-boot-starter:3.0.0'// swagger å¯¹spring data restæ”¯æŒéœ€è¦æ·»åŠ  springfox-data-restimplementation 'io.springfox:springfox-data-rest:3.0.0' æ·»åŠ å®Œä¾èµ–ä¹‹åŽï¼Œå¯ä»¥é€šè¿‡ gradle çš„ä¾èµ–è§†å›¾çœ‹ä¸€ä¸‹éƒ½ç”¨äº†å“ªäº› jar åŒ…ã€‚ é€šè¿‡ä¸Šå›¾å¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ° spring-data-rest çš„ jar åŒ…å¼•å…¥æƒ…å†µï¼Œä»¥åŠä¾èµ–çš„ spring-data-jpa å’Œ Swaggerã€‚ ç¬¬äºŒæ­¥ï¼šåœ¨é¡¹ç›®é‡Œé¢æ·»åŠ  SpringFoxConfiguration å¼€å¯ Swaggerï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º 123@Configuration@EnableSwagger2public class SpringFoxConfiguration &#123;&#125; ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ application.properties æŒ‡å®šä¸€ä¸ª base-pathï¼Œä»¥æ–¹ä¾¿å’Œè‡ªå·±çš„ api è¿›è¡ŒåŒºåˆ†ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12# å¯ä»¥é€šè¿‡spring data resté‡Œé¢æä¾›çš„é…ç½®é¡¹ï¼ŒæŒ‡å®šbast-pathspring.data.rest.base-path=api/rest/v2 è¿™æ—¶æ‰“å¼€ Swagger çœ‹ä¸€ä¸‹ï¼šhttp://127.0.0.1:8087/swagger-ui/ ç”±äºŽ Demo çš„é¡¹ç›®ç»“æž„æ˜¯ä¸‹å›¾æ‰€ç¤ºè¿™æ ·çš„ã€‚ ä½ ä¼šå‘çŽ°æœ‰å‡ ä¸ª Repository ä¼šç”Ÿæˆå‡ ä¸ªå¯¹åº”çš„ Rest åè®®çš„ APIï¼Œé™¤äº†åŸºæœ¬çš„ CRUDï¼Œä¾‹å¦‚ UserInfoRespository è‡ªå®šä¹‰çš„æ–¹æ³•å®ƒä»¬ä¹Ÿä¼šå¸®æˆ‘ä»¬å±•ç¤ºå‡ºæ¥ã€‚è€Œ Room å®žä½“å› ä¸ºæ²¡æœ‰å¯¹åº”çš„ Repositoryï¼Œæ‰€ä»¥ä¸ä¼šæœ‰å¯¹åº”çš„ Rest é£Žæ ¼ API ç”Ÿæˆã€‚ é€šè¿‡è¿™ä¸ª Demo å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœè¦åšä¸€ä¸ª Rest é£Žæ ¼çš„ Server API é¡¹ç›®ï¼Œåªéœ€è¦æŠŠå¯¹åº”çš„ Entity å’Œ Repository å»ºå¥½ï¼Œå°±å¯ä»¥ç›´æŽ¥æ‹¥æœ‰äº†æ‰€æœ‰çš„ CRUD çš„ API äº†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆçŽ‡ã€‚ Spring Data Rest åŸºæœ¬ç”¨æ³•é€šè¿‡ Demo å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼ŒSpring Data Rest çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯æŠŠ Spring Data Resositories é‡Œå¯¹å¤–æš´éœ²çš„æ–¹æ³•ç”Ÿæˆå¯¹åº”çš„ APIï¼Œå¦‚ä¸Šé¢çš„ AddressRepositoryï¼Œé‡Œé¢å¯¹åº”çš„å®žä½“æ˜¯ Addressï¼Œä»£ç å¦‚ä¸‹ã€‚ 1public interface AddressRepository extends JpaRepository&lt;Address, Long&gt;&#123;&#125; å®ƒå¸®æˆ‘ä»¬ç”Ÿæˆçš„ API æœ‰ä¸‹å›¾æ‰€ç¤ºçš„è¿™äº›ã€‚ ä»Ž swagger å¯ä»¥çœ‹åˆ° Spring Data Rest çš„å‡ ç‚¹ç”¨æ³•ã€‚ è¯­ä¹‰åŒ–çš„æ–¹æ³•æŠŠå®žä½“è½¬åŒ–æˆå¤æ•°çš„å½¢å¼ï¼Œç”ŸæˆåŸºæœ¬çš„ PATCHã€GETã€PUTã€POSTã€DELETE å¸¦æœ‰è¯­ä¹‰çš„ Rest ç›¸åº”çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬çš„å­èµ„æºæœ‰å¦‚ä¸‹å‡ ä¸ªã€‚ GETï¼šè¿”å›žå•ä¸ªå®žä½“ PUTï¼šæ›´æ–°èµ„æº PATCHï¼šä¸Ž PUT ç±»ä¼¼ï¼Œä½†éƒ¨åˆ†æ˜¯æ›´æ–°èµ„æºçŠ¶æ€ DELETEï¼šåˆ é™¤æš´éœ²çš„èµ„æº POSTï¼šä»Žç»™å®šçš„è¯·æ±‚æ­£æ–‡åˆ›å»ºä¸€ä¸ªæ–°çš„å®žä½“ é»˜è®¤çš„çŠ¶æ€ç çš„æ”¯æŒ 200 OKï¼šé€‚ç”¨äºŽçº¯ç²¹çš„ GET è¯·æ±‚ 201 Createdï¼šé’ˆå¯¹åˆ›å»ºæ–°èµ„æºçš„ POST å’Œ PUT è¯·æ±‚ 204 No Contentï¼šå¯¹äºŽ PUTã€PATCH å’Œ DELETE è¯·æ±‚ 401 æ²¡æœ‰è®¤è¯ 403 æ²¡æœ‰æƒé™ï¼Œæ‹’ç»è®¿é—® 404 æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„èµ„æº åˆ†é¡µæ”¯æŒé€šè¿‡ Swaggerï¼Œå¯ä»¥çœ‹åˆ°å…¶å®Œå…¨å¯¹åˆ†é¡µå’ŒæŽ’åºè¿›è¡Œæ”¯æŒï¼Œå®Œå…¨å…¼å®¹ Spring Data JPA çš„åˆ†é¡µå’ŒæŽ’åºçš„å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ é€šè¿‡ @RepositoryRestResource æ”¹å˜èµ„æºçš„ metaDataä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678@RepositoryRestResource( exported = true, //èµ„æºæ˜¯å¦æš´éœ²ï¼Œé»˜è®¤true path = "users",//èµ„æºæš´éœ²çš„pathè®¿é—®è·¯å¾„ï¼Œé»˜è®¤å®žä½“åå­—+s collectionResourceRel = "userInfo",//èµ„æºåå­—ï¼Œé»˜è®¤å®žä½“åå­— collectionResourceDescription = @Description("ç”¨æˆ·åŸºæœ¬ä¿¡æ¯èµ„æº"),//èµ„æºæè¿° itemResourceRel = "userDetail",//å–èµ„æºè¯¦æƒ…çš„Itemåå­— itemResourceDescription = @Description("ç”¨æˆ·è¯¦æƒ…")) å°†å…¶æ”¾ç½®åœ¨ UserInfoRepository ä¸Šé¢æµ‹è¯•ä¸€ä¸‹ï¼Œä»£ç å˜æ›´å¦‚ä¸‹ã€‚ 123456789@RepositoryRestResource( exported = true, path = "users", collectionResourceRel = "userInfo", collectionResourceDescription = @Description("ç”¨æˆ·èµ„æº"), itemResourceRel = "userDetail", itemResourceDescription = @Description("ç”¨æˆ·è¯¦æƒ…"))public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt; &#123;&#125; è¿™æ—¶é€šè¿‡ Swagger å¯ä»¥çœ‹åˆ°ï¼Œurl çš„ path ä¸Šé¢å˜æˆäº† usersï¼Œè€Œ body é‡Œé¢çš„èµ„æºåå­—å˜æˆäº† userInfoï¼Œå– itemResource çš„ URL æè¿°å˜æˆäº† userDetailï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ @RepositoryRestResource æ˜¯ä½¿ç”¨åœ¨ Repository ç±»ä¸Šé¢çš„å…¨å±€è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹å…·ä½“çš„ Repsitory é‡Œé¢çš„æ¯ä¸ªæ–¹æ³•è¿›è¡Œå•ç‹¬è®¾ç½®ï¼Œè¿™å°±æ˜¯å¦å¤–ä¸€ä¸ªæ³¨è§£ï¼š@RestResourceã€‚ 12345@RestResource( exported = true,//æ˜¯å¦æš´éœ²ç»™Search path = "findCities",//SearchåŽé¢çš„pathè·¯å¾„ rel = "cities"//èµ„æºåå­—) å¯ä»¥å°†å…¶ç”¨äºŽ ***Repository çš„æ–¹æ³•ä¸­å’Œ @Entity çš„å®žä½“å…³ç³»ä¸Šï¼Œé‚£ä¹ˆåœ¨ address çš„ findByAddress æ–¹æ³•ä¸Šé¢åšä¸€ä¸ªæµ‹è¯•ï¼Œçœ‹çœ‹ä¼šå˜æˆä»€ä¹ˆæ ·ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678public interface AddressRepository extends JpaRepository&lt;Address, Long&gt;&#123; @RestResource( exported = true,//æ˜¯å¦æš´éœ²ç»™Search path = "findCities",//SearchåŽé¢çš„pathè·¯å¾„ rel = "cities"//èµ„æºåå­— ) Page&lt;Address&gt; findByAddress(@Param("address") String address, Pageable pageable);&#125; æ‰“å¼€ Swagger çœ‹ä¸€ä¸‹ç»“æžœï¼Œä¼šå‘çŽ° search åŽé¢çš„ path è·¯å¾„è¢«è‡ªå®šä¹‰äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ åŒæ—¶è¿™ä¸ªæ³¨è§£ä¹Ÿå¯ä»¥é…ç½®åœ¨å…³è”å…³ç³»ä¸Šï¼Œå¦‚ @OneToMany ç­‰ã€‚å¦‚æžœä¸æƒ³æŸäº›æ–¹æ³•æš´éœ²æˆ RestAPIï¼Œå°±ç›´æŽ¥æ·»åŠ  @RestResource(exported = false) è¿™ä¸€æ³¨è§£å³å¯ï¼Œä¾‹å¦‚ä¸€äº›åˆ é™¤æ–¹æ³•ç­‰ã€‚ spring data rest çš„é…ç½®é¡¹æ”¯æŒè¿™ä¸ªå¯ä»¥ç›´æŽ¥åœ¨ application.properties é‡Œé¢é…ç½®ï¼Œåœ¨ IDEA é‡Œé¢è¾“å…¥å‰ç¼€çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰å¦‚ä¸‹æç¤ºã€‚ å¯¹åº”çš„æè¿°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚ è¿”å›žç»“æžœå¯¹ Jackson çš„æ”¯æŒé€šè¿‡ jackson çš„æ³¨è§£ï¼Œå¯ä»¥æ”¹å˜ rest api çš„å±žæ€§çš„åå­—ï¼Œæˆ–è€…å¿½ç•¥å…·ä½“çš„æŸä¸ªå±žæ€§ã€‚åœ¨ address çš„å®žä½“é‡Œé¢ï¼Œæ”¹å˜ä¸€ä¸‹å±žæ€§ city çš„åå­—ï¼ŒåŒæ—¶å¿½ç•¥ address å±žæ€§ï¼Œä»£ç ä¼šå˜æˆå¦‚ä¸‹æ‰€ç¤ºçš„æ ·å­ã€‚ 12345678910111213@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "userInfo")public class Address extends BaseEntity &#123; @JsonProperty("myCity") //æ”¹å˜JSONå“åº”çš„å±žæ€§åå­— private String city; @JsonIgnore //JSONè§£æžçš„æ—¶å€™å¿½ç•¥æŸä¸ªå±žæ€§ private String address;&#125; é€šè¿‡ Swagger é‡Œé¢çš„ Description å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰çš„èµ„æºçš„æè¿°å‘ç”Ÿäº†å˜åŒ–ï¼Œå­—æ®µåå˜æˆäº† myCityï¼Œaddress å±žæ€§æ²¡æœ‰äº†ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Spring Data Rest è¿”å›ž ResponseBody çš„åŽŸç†å’ŒæŽ¥æ”¶ RequestBody çš„åŽŸç†éƒ½æ˜¯åŸºäºŽ JSON æ ¼å¼çš„ Spring Data Rest å’Œ Spring Data JPA çš„å…³ç³» Spring Data JPA åŸºäºŽ JPA åè®®æä¾›äº†ä¸€å¥—æ ‡å‡†çš„ Repository çš„æ“ä½œç»Ÿä¸€æŽ¥å£ï¼Œæ–¹æ³•åå’Œ @Query éƒ½æ˜¯æœ‰å›ºå®šè¯­æ³•å’Œçº¦å®šçš„è§„åˆ™çš„ã€‚ Spring Data Rest åˆ©ç”¨ JPA çš„çº¦å®šå’Œè¯­æ³•ï¼Œåˆ©ç”¨ Java åå°„ã€åŠ¨æ€ä»£ç†ç­‰æœºåˆ¶ï¼Œå¾ˆå®¹æ˜“å¯ä»¥ç”Ÿæˆä¸€å¥—æ ‡å‡†çš„ rest é£Žæ ¼çš„ API åè®®æ“ä½œã€‚ ä¹Ÿå°±æ˜¯è¯´ JPA åˆ¶å®šåè®®å’Œæ ‡å‡†ï¼ŒSpring Data Rest åŸºäºŽè¿™å¥—åè®®ç”Ÿæˆ rest é£Žæ ¼çš„ Controllerã€‚ ðŸŽ¯JPA çš„åº”ç”¨é¢†åŸŸå…¶å®žæœ‰å¾ˆå¤šï¼Œåœ¨å†™ä¸€äº›åŸºäºŽå®žä½“çš„æ¡†æž¶æ—¶å°±å¯ä»¥å‚è€ƒ Spring Data Rest çš„åšæ³•ã€‚ä¾‹å¦‚ yahoo å›¢é˜Ÿè®¾è®¡çš„ JSONAPI åè®®ï¼Œä»¥åŠ Elide çš„å®žçŽ°ï¼Œä¹Ÿæ˜¯åŸºäºŽ JPA çš„å®žä½“æ³¨è§£æ¥å®žçŽ°çš„ã€‚ ç”šè‡³ Spring åœ¨ç ”ç©¶çš„ graph QLï¼Œä¹Ÿå¯ä»¥åŸºäºŽçº¦å®šçš„å®žä½“æ¥åšå¾ˆå¤šäº‹æƒ…ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa äºŒçº§ç¼“å­˜çš„æ€è€ƒ]]></title>
    <url>%2F2021%2F01%2F30%2FSpringDataJpa%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98%E7%9A%84%E6%80%9D%E8%80%83-%E7%BB%93%E5%90%88Redis%2F</url>
    <content type="text"><![CDATA[äºŒçº§ç¼“å­˜çš„æ€è€ƒï¼šJPAç»“åˆRedisäºŒçº§ç¼“å­˜çš„æ¦‚å¿µä¸€çº§ç¼“å­˜çš„å®žä½“çš„ç”Ÿå‘½å‘¨æœŸå’Œ PersistenceContext æ˜¯ç›¸åŒçš„ï¼Œå³è½½ä½“ä¸ºåŒä¸€ä¸ª Session æ‰æœ‰æ•ˆï¼›è€Œ Hibernate æå‡ºäº†äºŒçº§ç¼“å­˜çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨ä¸åŒçš„ Session ä¹‹é—´å…±äº«å®žä½“å®žä¾‹ï¼Œè¯´ç™½äº†å°±æ˜¯åœ¨å•ä¸ªåº”ç”¨å†…çš„æ•´ä¸ª application ç”Ÿå‘½å‘¨æœŸä¹‹å†…å…±äº«å®žä½“ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢ã€‚ ç”±äºŽ JPA åè®®æœ¬èº«å¹¶æ²¡æœ‰è§„å®šäºŒçº§ç¼“å­˜çš„æ¦‚å¿µï¼Œæ‰€ä»¥è¿™æ˜¯ Hibernate ç‹¬æœ‰çš„ç‰¹æ€§ã€‚åœ¨ Hibernate ä¸­ï¼Œä»Žæ•°æ®åº“é‡Œé¢æŸ¥è¯¢å®žä½“çš„è¿‡ç¨‹å°±å˜æˆäº†ï¼šç¬¬ä¸€æ­¥å…ˆçœ‹çœ‹ä¸€çº§ç¼“å­˜é‡Œé¢æœ‰æ²¡æœ‰å®žä½“ï¼Œå¦‚æžœæ²¡æœ‰å†çœ‹çœ‹äºŒçº§ç¼“å­˜é‡Œé¢æœ‰æ²¡æœ‰ï¼Œå¦‚æžœè¿˜æ˜¯æ²¡æœ‰å†ä»Žæ•°æ®åº“é‡Œé¢æŸ¥è¯¢ã€‚ Hibernate ä¸­äºŒçº§ç¼“å­˜çš„é…ç½®æ–¹æ³•Hibernate ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹äºŒçº§ç¼“å­˜æ˜¯å…³é—­çš„ï¼Œå¦‚æžœæƒ³å¼€å¯äºŒçº§ç¼“å­˜éœ€è¦é€šè¿‡å¦‚ä¸‹ä¸‰ä¸ªæ­¥éª¤ã€‚ ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ç¬¬ä¸‰æ–¹äºŒçº§ç¼“å­˜çš„å®žçŽ°çš„ jarã€‚ å› ä¸º Hibernate æœ¬èº«å¹¶æ²¡æœ‰å®žçŽ°ç¼“å­˜çš„åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸»è¦ä¾èµ–ç¬¬ä¸‰æ–¹ï¼Œå¦‚ Ehcacheã€jcacheã€redis ç­‰ç¬¬ä¸‰æ–¹åº“ã€‚ä¸‹é¢ä»¥ EhCache ä¸ºä¾‹ï¼Œåˆ©ç”¨ gradle å¼•å…¥ hibernate-ehcache çš„ä¾èµ–ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1implementation 'org.hibernate:hibernate-ehcache:5.2.2.Final' å¦‚æžœæƒ³ç”¨ jcacheï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ã€‚ 1compile 'org.hibernate:hibernate-jcache:5.2.2.Final' ç¬¬äºŒæ­¥ï¼šåœ¨é…ç½®æ–‡ä»¶é‡Œé¢å¼€å¯äºŒçº§ç¼“å­˜ã€‚ äºŒçº§ç¼“å­˜é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨å¦‚ä¸‹æ–¹å¼å¼€å¯äºŒçº§ç¼“å­˜ï¼Œå¹¶ä¸”é…ç½® cache.region.factory_class ä¸ºä¸åŒçš„ç¼“å­˜å®žçŽ°ç±»ã€‚ 12hibernate.cache.use_second_level_cache=truehibernate.cache.region.factory_class=org.hibernate.cache.ehcache.EhCacheRegionFactory ç¬¬ä¸‰æ­¥ï¼šåœ¨ç”¨åˆ°äºŒçº§ç¼“å­˜çš„åœ°æ–¹é…ç½® @Cacheable å’Œ @Cache çš„ç­–ç•¥ã€‚ 123456import javax.persistence.Cacheable;import javax.persistence.Entity;@Entity@Cacheable@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)public class UserInfo extends BaseEntity &#123;......&#125; äºŒçº§ç¼“å­˜çš„æ€è€ƒäºŒçº§ç¼“å­˜ä¸»è¦è§£å†³çš„æ˜¯å•åº”ç”¨åœºæ™¯ä¸‹è·¨ Session ç”Ÿå‘½å‘¨æœŸçš„å®žä½“å…±äº«é—®é¢˜ï¼Œå¯æ˜¯ä¸€å®šè¦é€šè¿‡ Hibernate æ¥åšå—ï¼Ÿç­”æ¡ˆå¹¶ä¸æ˜¯ï¼Œå…¶å®žå¯ä»¥é€šè¿‡å„ç§ Cache çš„æ‰‹æ®µæ¥åšï¼Œå› ä¸º Hibernate é‡Œé¢ä¸€çº§ç¼“å­˜çš„å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ï¼Œå¹¶ä¸”ä½¿ç”¨çš„è¯å®žä½“çš„ç”Ÿå‘½å‘¨æœŸä¼šæœ‰å˜åŒ–ï¼ŒæŸ¥è¯¢é—®é¢˜çš„è¿‡ç¨‹è¾ƒä¸ºéº»çƒ¦ã€‚ åŒæ—¶ï¼Œéšç€çŽ°åœ¨é€æ¸å¾®æœåŠ¡åŒ–ã€åˆ†å¸ƒå¼åŒ–ï¼Œå¦‚ä»Šçš„åº”ç”¨éƒ½ä¸æ˜¯å•æœºåº”ç”¨ï¼Œé‚£ä¹ˆç¼“å­˜ä¹‹é—´å¦‚ä½•å…±äº«å‘¢ï¼Ÿåˆ†å¸ƒå¼ç¼“å­˜åˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿæ¯”å¦‚ä¸€ä¸ªæœºå™¨å˜äº†ï¼Œå¦ä¸€ä¸ªæœºå™¨æ²¡å˜ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿä¼¼ä¹Ž Hibernate å¹¶æ²¡æœ‰è€ƒè™‘åˆ°è¿™äº›é—®é¢˜ã€‚ æ­¤å¤–ï¼Œè¿˜æœ‰ä»€ä¹ˆæ—¶é—´æ•°æ®ä¼šå˜æ›´ã€å˜åŒ–äº†ä¹‹åŽå¦‚ä½•æ¸…é™¤ç¼“å­˜ï¼Œç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯è¦æ€è€ƒçš„ï¼Œæ‰€ä»¥ Hibernate çš„äºŒçº§ç¼“å­˜å¬èµ·æ¥â€œé«˜å¤§ä¸Šâ€ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ç»å¯¹æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚ é‚£ä¹ˆç»è¿‡è¿™ä¸€è¿žä¸²çš„ç–‘é—®ï¼Œå¦‚æžœä¸ç”¨ Hibernate çš„äºŒçº§ç¼“å­˜ï¼Œè¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿ åˆ©ç”¨ Redis è¿›è¡Œç¼“å­˜åœ¨å®žé™…å·¥ä½œä¸­ç»å¸¸éœ€è¦ cache çš„å°±æ˜¯ Redisï¼Œé‚£ä¹ˆé€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œæ¥çœ‹ä¸‹ Spring Cache ç»“åˆ Redis æ˜¯æ€Žä¹ˆä½¿ç”¨çš„ã€‚ Spring Cache å’Œ Redis ç»“åˆç¬¬ä¸€æ­¥ï¼šåœ¨ gradle ä¸­å¼•å…¥ cache å’Œ redis çš„ä¾èµ–ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345//åŽŸæ¥åªç”¨åˆ°äº†JPAimplementation 'org.springframework.boot:spring-boot-starter-data-jpa'//ä¸ºäº†å¼•å…¥cacheå’Œredisæœºåˆ¶éœ€è¦å¼•å…¥å¦‚ä¸‹ä¸¤ä¸ªjaråŒ…implementation 'org.springframework.boot:spring-boot-starter-data-redis' //redisçš„ä¾èµ–implementation 'org.springframework.boot:spring-boot-starter-cache' //cache çš„ä¾èµ– ç¬¬äºŒæ­¥ï¼šåœ¨ application.properties é‡Œé¢å¢žåŠ  redis çš„ç›¸å…³é…ç½®ï¼Œä»£ç å¦‚ä¸‹ã€‚ 12345678spring.redis.host=127.0.0.1spring.redis.port=6379spring.redis.password=sySj6vmYkespring.redis.timeout=6000spring.redis.pool.max-active=8spring.redis.pool.max-idle=8spring.redis.pool.max-wait=-1spring.redis.pool.min-idle=0 ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ @EnableCaching å¼€å¯ç¼“å­˜ï¼Œå¢žåŠ  configuration é…ç½®ç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123@EnableCaching@Configurationpublic class CacheConfiguration &#123;&#125; ç¬¬å››æ­¥ï¼šåœ¨éœ€è¦ç¼“å­˜çš„åœ°æ–¹æ·»åŠ  @Cacheable æ³¨è§£å³å¯ã€‚ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼ŒæŠŠ @Cacheable æ³¨è§£é…ç½®åœ¨äº† controller æ–¹æ³•ä¸Šï¼Œä»£ç å¦‚ä¸‹ã€‚ 123456@GetMapping("/user/info/&#123;id&#125;")@Cacheable(value = "userInfo", key = "&#123;#root.methodName, #id&#125;", unless = "#result == null") //åˆ©ç”¨é»˜è®¤keyå€¼ç”Ÿæˆè§„åˆ™valueåŠ keyç”Ÿæˆä¸€ä¸ªredisçš„keyå€¼ï¼Œresult==nullçš„æ—¶å€™ä¸è¿›è¡Œç¼“å­˜public UserInfo getUserInfo(@PathVariable("id") Long id) &#123; //ç¬¬äºŒæ¬¡å°±ä¸ä¼šå†æ‰§è¡Œè¿™é‡Œäº† return userInfoRepository.findById(id).get();&#125; ç¬¬äº”æ­¥ï¼šå¯åŠ¨é¡¹ç›®ï¼Œè¯·æ±‚ä¸€ä¸‹è¿™ä¸ª API ä¼šå‘çŽ°ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚è¿‡åŽï¼Œredis é‡Œé¢å°±æœ‰ä¸€æ¡è®°å½•äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ä¹‹åŽï¼Œå–æ•°æ®å°±ä¸ä¼šå†è¯·æ±‚æ•°æ®åº“äº†ã€‚é‚£ä¹ˆ redis å·²ç»ç†Ÿæ‚‰äº†ï¼Œé‚£ä¹ˆæ¥çœ‹ä¸€ä¸‹ Spring Cache éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚ Spring Cache ä»‹ç»Spring 3.1 ä¹‹åŽå¼•å…¥äº†åŸºäºŽæ³¨é‡Šï¼ˆannotationï¼‰çš„ç¼“å­˜ï¼ˆcacheï¼‰æŠ€æœ¯ï¼Œå®ƒæœ¬è´¨ä¸Šä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç¼“å­˜å®žçŽ°æ–¹æ¡ˆï¼ˆä¾‹å¦‚ EHCache æˆ–è€… Redisï¼‰ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯¹ç¼“å­˜ä½¿ç”¨çš„æŠ½è±¡æ¦‚å¿µï¼Œé€šè¿‡åœ¨æ—¢æœ‰ä»£ç ä¸­æ·»åŠ å°‘é‡å®ƒå®šä¹‰çš„å„ç§ annotationï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°ç¼“å­˜æ–¹æ³•çš„è¿”å›žå¯¹è±¡çš„æ•ˆæžœã€‚ Spring çš„ç¼“å­˜æŠ€æœ¯è¿˜å…·å¤‡ç›¸å½“çš„çµæ´»æ€§ï¼Œä¸ä»…èƒ½å¤Ÿä½¿ç”¨ SpELï¼ˆSpring Expression Languageï¼‰æ¥å®šä¹‰ç¼“å­˜çš„ key å’Œå„ç§ conditionï¼Œè¿˜æä¾›å¼€ç®±å³ç”¨çš„ç¼“å­˜ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆï¼Œä¹Ÿæ”¯æŒä¸»æµçš„ä¸“ä¸šç¼“å­˜ï¼Œä¾‹å¦‚ Redisï¼ŒEHCache é›†æˆã€‚è€Œ Spring Cache å±žäºŽ Spring framework çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ä¸‹é¢å›¾ç‰‡æ‰€ç¤ºçš„è¿™ä¸ªåŒ…é‡Œé¢ã€‚ Spring cache é‡Œé¢çš„ä¸»è¦çš„æ³¨è§£ @Cacheable åº”ç”¨åˆ°è¯»å–æ•°æ®çš„æ–¹æ³•ä¸Šï¼Œå°±æ˜¯å¯ä»¥ç¼“å­˜çš„æ–¹æ³•ï¼Œå¦‚æŸ¥æ‰¾æ–¹æ³•ï¼šå…ˆä»Žç¼“å­˜ä¸­è¯»å–ï¼Œå¦‚æžœæ²¡æœ‰å†è°ƒç”¨æ–¹æ³•èŽ·å–æ•°æ®ï¼Œç„¶åŽæŠŠæ•°æ®æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚ 123456789101112131415161718192021public @interface Cacheable &#123; @AliasFor("cacheNames") String[] value() default &#123;&#125;;//cacheçš„åå­—ã€‚å¯ä»¥æ ¹æ®åå­—è®¾ç½®ä¸åŒcacheå¤„ç†ç±»ã€‚redisé‡Œé¢å¯ä»¥æ ¹æ®cacheåå­—è®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ã€‚ @AliasFor("value") String[] cacheNames() default &#123;&#125;;//ç¼“å­˜çš„keyçš„åå­—ï¼Œæ”¯æŒ SPEL String key() default "";//keyçš„ç”Ÿæˆç­–ç•¥ï¼Œä¸æŒ‡å®šå¯ä»¥ç”¨å…¨å±€çš„é»˜è®¤çš„ã€‚ String keyGenerator() default ""; //å®¢æˆ·é€‰æ‹©ä¸åŒçš„CacheManager String cacheManager() default ""; //é…ç½®ä¸åŒçš„cache resolver String cacheResolver() default ""; //æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶æ‰èƒ½è¢«ç¼“å­˜ï¼Œæ”¯æŒSpELï¼Œå¯ä»¥åŽ»æŽ‰æ–¹æ³•åã€å‚æ•° String condition() default "";//æŽ’é™¤å“ªäº›è¿”å›žç»“æžœä¸åŠ å…¥ç¼“å­˜é‡Œé¢åŽ»ï¼Œæ”¯æŒSpELï¼Œå®žé™…å·¥ä½œä¸­å¸¸è§çš„æ˜¯result ==nullç­‰ String unless() default ""; //æ˜¯å¦åŒæ­¥è¯»å–ç¼“å­˜ã€æ›´æ–°ç¼“å­˜ boolean sync() default false;&#125; ä¸‹é¢æ˜¯@Cacheable ç›¸å…³çš„ä¾‹å­ã€‚ 12@Cacheable(cacheNames="book", condition="#name.length() &lt; 32", unless="#result.notNeedCache")//åˆ©ç”¨SPELè¡¨è¾¾å¼åªæœ‰å½“nameå‚æ•°é•¿åº¦å°äºŽ32çš„æ—¶å€™å†è¿›è¡Œç¼“å­˜ï¼ŒæŽ’é™¤notNeedCacheçš„å¯¹è±¡public Book findBook(String name) @CachePut è°ƒç”¨æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨æŠŠç›¸åº”çš„æ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œå®ƒä¸Ž @Cacheable ä¸åŒçš„æ˜¯æ‰€æœ‰æ³¨è§£çš„æ–¹æ³•æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œï¼Œä¸€èˆ¬é…ç½®åœ¨ Update å’Œ insert æ–¹æ³•ä¸Šã€‚å…¶æºç é‡Œé¢çš„å­—æ®µå’Œç”¨æ³•åŸºæœ¬ä¸Ž @Cacheable ç›¸åŒï¼Œåªæ˜¯ä½¿ç”¨åœºæ™¯ä¸ä¸€æ ·ã€‚ @CacheEvict åˆ é™¤ç¼“å­˜ï¼Œä¸€èˆ¬é…ç½®åœ¨åˆ é™¤æ–¹æ³•ä¸Šé¢ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314public @interface CacheEvict &#123;//ä¸Ž@Cacheableç›¸åŒçš„éƒ¨åˆ†å°±ä¸é‡å¤å™è¿°äº†ã€‚...... //æ˜¯å¦åˆ é™¤æ‰€æœ‰çš„å®žä½“å¯¹è±¡ boolean allEntries() default false; //æ˜¯å¦æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œã€‚é»˜è®¤åœ¨æ–¹æ³•è°ƒç”¨æˆåŠŸä¹‹åŽåˆ é™¤ boolean beforeInvocation() default false;&#125; @Caching æ‰€æœ‰Cacheæ³¨è§£çš„ç»„åˆé…ç½®æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š public @interface Caching &#123; Cacheable[] cacheable() default &#123;&#125;; CachePut[] put() default &#123;&#125;; CacheEvict[] evict() default &#123;&#125;;&#125; æ­¤å¤–ï¼Œè¿˜æœ‰ @CacheConfig è¡¨ç¤ºå…¨å±€ Cache é…ç½®ï¼›@EnableCachingï¼Œè¡¨ç¤ºæ˜¯å¦å¼€å¯ SpringCache çš„é…ç½®ã€‚ Spring Cache Redis é‡Œé¢ä¸»è¦çš„ç±» org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration cache çš„è‡ªåŠ¨è£…é…ç±»ï¼Œæ­¤ç±»è¢«åŠ è½½çš„æ–¹å¼æ˜¯åœ¨ spring bootçš„spring.factories æ–‡ä»¶é‡Œé¢ï¼Œå…¶å…³é”®æºç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415161718192021222324@Configuration(proxyBeanMethods = false)@ConditionalOnClass(CacheManager.class)@ConditionalOnBean(CacheAspectSupport.class)@ConditionalOnMissingBean(value = CacheManager.class, name = "cacheResolver")@EnableConfigurationProperties(CacheProperties.class)@AutoConfigureAfter(&#123; CouchbaseDataAutoConfiguration.class, HazelcastAutoConfiguration.class, HibernateJpaAutoConfiguration.class, RedisAutoConfiguration.class &#125;)@Import(&#123; CacheConfigurationImportSelector.class, CacheManagerEntityManagerFactoryDependsOnPostProcessor.class &#125;)public class CacheAutoConfiguration &#123; /** * &#123;@link ImportSelector&#125; to add &#123;@link CacheType&#125; configuration classes. */ static class CacheConfigurationImportSelector implements ImportSelector &#123; @Override public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123; CacheType[] types = CacheType.values(); String[] imports = new String[types.length]; for (int i = 0; i &lt; types.length; i++) &#123; imports[i] = CacheConfigurations.getConfigurationClass(types[i]); &#125; return imports; &#125; &#125;&#125; é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œæ­¤ç±»çš„å…³é”®ä½œç”¨æ˜¯åŠ è½½ Cache çš„ä¾èµ–é…ç½®ï¼Œä»¥åŠåŠ è½½æ‰€æœ‰ CacheType çš„é…ç½®æ–‡ä»¶ï¼Œè€Œ CacheConfigurations é‡Œé¢å®šä¹‰äº†ä¸åŒçš„ Cache å®žçŽ°æ–¹å¼çš„é…ç½®ï¼Œé‡Œé¢åŒ…å«äº† Ehcacheã€Redisã€Jcache çš„å„ç§å®žçŽ°æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ org.springframework.cache.annotation.CachingConfigurerSupport é€šè¿‡æ­¤ç±»å¯ä»¥è‡ªå®šä¹‰ Cache é‡Œé¢çš„ CacheManagerã€CacheResolverã€KeyGeneratorã€CacheErrorHandlerï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920212223242526public class CachingConfigurerSupport implements CachingConfigurer &#123; // cacheçš„managerï¼Œä¸»è¦æ˜¯ç®¡ç†ä¸åŒçš„cacheçš„å®žçŽ°æ–¹å¼ï¼Œå¦‚redisè¿˜æ˜¯ehcacheç­‰ @Override @Nullable public CacheManager cacheManager() &#123; return null; &#125; // cacheçš„ä¸åŒå®žçŽ°è€…çš„æ“ä½œæ–¹æ³•ï¼ŒCacheResolverè§£æžå™¨ï¼Œç”¨äºŽæ ¹æ®å®žé™…æƒ…å†µæ¥åŠ¨æ€è§£æžä½¿ç”¨å“ªä¸ªCache @Override @Nullable public CacheResolver cacheResolver() &#123; return null; &#125; //cacheçš„keyçš„ç”Ÿæˆè§„åˆ™ @Override @Nullable public KeyGenerator keyGenerator() &#123; return null; &#125; //cacheå‘ç”Ÿå¼‚å¸¸çš„å›žè°ƒå¤„ç†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä¼šæ‰“å°ä¸ªwarnæ—¥å¿—ï¼Œæ–¹ä¾¿çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ… @Override @Nullable public CacheErrorHandler errorHandler() &#123; return null; &#125;&#125; å…¶ä¸­ï¼Œæ‰€æœ‰ CacheManager æ˜¯ Spring æä¾›çš„å„ç§ç¼“å­˜æŠ€æœ¯æŠ½è±¡æŽ¥å£ï¼Œé€šè¿‡å®ƒæ¥ç®¡ç†ï¼ŒSpring framework é‡Œé¢é»˜è®¤å®žçŽ°çš„ CacheManager æœ‰ä¸åŒçš„å®žçŽ°ç±»ï¼Œredis é»˜è®¤åŠ è½½çš„æ˜¯ RedisCacheManagerï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration å®ƒæ˜¯åŠ è½½ Cache çš„å®žçŽ°è€…ï¼Œä¹Ÿæ˜¯ redis çš„å®žçŽ°ç±»ï¼Œå…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå®ƒä¾èµ–æœ¬èº«çš„ Redis çš„è¿žæŽ¥ï¼Œå¹¶ä¸”åŠ è½½äº† RedisCacheManagerï¼›åŒæ—¶å¯ä»¥çœ‹åˆ°å…³äºŽ Cache å’Œ Redis çš„é…ç½®æœ‰å“ªäº›ã€‚ é€šè¿‡ CacheProperties é‡Œé¢ redis çš„é…ç½®ï¼Œå¯ä»¥è®¾ç½®â€œkey çš„ç»Ÿä¸€å‰ç¼€ã€é»˜è®¤è¿‡æœŸæ—¶é—´ã€æ˜¯å¦ç¼“å­˜ null å€¼ã€æ˜¯å¦ä½¿ç”¨å‰ç¼€â€è¿™å››ä¸ªé…ç½®ã€‚ Spring Cache ç»“åˆ Redis ä½¿ç”¨çš„æœ€ä½³å®žè·µä¸åŒ cache çš„ name åœ¨ redis é‡Œé¢é…ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ é»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰ redis çš„ cache è¿‡æœŸæ—¶é—´æ˜¯ä¸€æ ·çš„ï¼Œå®žé™…å·¥ä½œä¸­ä¸€èˆ¬éœ€è¦è‡ªå®šä¹‰ä¸åŒ cache çš„ name çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™é‡Œ cache çš„ name å°±æ˜¯æŒ‡ @Cacheable é‡Œé¢ value å±žæ€§å¯¹åº”çš„å€¼ã€‚ä¸»è¦æ­¥éª¤å¦‚ä¸‹ã€‚ ç¬¬ä¸€æ­¥ï¼šè‡ªå®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç”¨æ¥æŒ‡å®šä¸åŒçš„ cacheName å¯¹åº”çš„è¿‡æœŸæ—¶é—´ä¸ä¸€æ ·ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789@Getter@Setter@ConfigurationProperties(prefix = "spring.cache.redis")/** * æ”¹å–„ä¸€ä¸‹cacheNameçš„æœ€ä½³å®žè·µæ–¹æ³•ï¼Œç›®å‰ä¸»è¦ç”¨ä¸åŒçš„cache nameä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥æ‰©å±• */public class MyCacheProperties &#123; private HashMap&lt;String, Duration&gt; cacheNameConfig;&#125; ç¬¬äºŒæ­¥ï¼šé€šè¿‡è‡ªå®šä¹‰ç±» MyRedisCacheManagerBuilderCustomizer å®žçŽ° RedisCacheManagerBuilderCustomizer é‡Œé¢çš„ customize æ–¹æ³•ï¼Œç”¨æ¥æŒ‡å®šä¸åŒçš„ name é‡‡ç”¨ä¸åŒçš„ RedisCacheConfigurationï¼Œä»Žè€Œè¾¾åˆ°è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´çš„æ•ˆæžœã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920212223242526272829303132/** * è¿™ä¸ªä¾èµ–spring boot 2.2 ä»¥ä¸Šç‰ˆæœ¬æ‰æœ‰æ•ˆ */public class MyRedisCacheManagerBuilderCustomizer implements RedisCacheManagerBuilderCustomizer &#123; private MyCacheProperties myCacheProperties; private RedisCacheConfiguration redisCacheConfiguration; public MyRedisCacheManagerBuilderCustomizer(MyCacheProperties myCacheProperties, RedisCacheConfiguration redisCacheConfiguration) &#123; this.myCacheProperties = myCacheProperties; this.redisCacheConfiguration = redisCacheConfiguration; &#125; /** * åˆ©ç”¨é»˜è®¤é…ç½®çš„åªéœ€è¦åœ¨è¿™é‡ŒåŠ å°±å¯ä»¥äº† * spring.cache.cache-names=abc,def,userlist2,user3 * ä¸‹é¢æ˜¯ä¸åŒçš„cache-nameå¯ä»¥é…ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œyamlä¹Ÿæ”¯æŒï¼Œå¦‚æžœä»¥åŽè¿˜æœ‰å…¶ä»–å±žæ€§æ‰©å±•å¯ä»¥æ”¹è¿™é‡Œ * spring.cache.redis.cache-name-config.user2=2h * spring.cache.redis.cache-name-config.def=2m * @param builder */ @Override public void customize(RedisCacheManager.RedisCacheManagerBuilder builder) &#123; if (ObjectUtils.isEmpty(myCacheProperties.getCacheNameConfig())) &#123; return; &#125; Map&lt;String, RedisCacheConfiguration&gt; cacheConfigurations = myCacheProperties.getCacheNameConfig().entrySet().stream() .collect(Collectors .toMap(e-&gt;e.getKey(),v-&gt;builder .getCacheConfigurationFor(v.getKey()) .orElse(RedisCacheConfiguration.defaultCacheConfig().serializeValuesWith(redisCacheConfiguration.getValueSerializationPair())) .entryTtl(v.getValue()))); builder.withInitialCacheConfigurations(cacheConfigurations); &#125;&#125; ç¬¬ä¸‰æ­¥ï¼šåœ¨ CacheConfiguration é‡Œé¢æŠŠè‡ªå®šä¹‰çš„ CacheManagerCustomize åŠ è½½è¿›åŽ»å³å¯ï¼Œä»£ç å¦‚ä¸‹ã€‚ 12345678910111213141516171819@EnableCaching@Configuration@EnableConfigurationProperties(value = &#123;MyCacheProperties.class,CacheProperties.class&#125;)@AutoConfigureAfter(&#123;CacheAutoConfiguration.class&#125;)public class CacheConfiguration &#123; /** * æ”¯æŒä¸åŒçš„cache nameæœ‰ä¸åŒçš„ç¼“å­˜æ—¶é—´çš„é…ç½® * * @param myCacheProperties * @param redisCacheConfiguration * @return */ @Bean @ConditionalOnMissingBean(name = "myRedisCacheManagerBuilderCustomizer") @ConditionalOnClass(RedisCacheManagerBuilderCustomizer.class) public MyRedisCacheManagerBuilderCustomizer myRedisCacheManagerBuilderCustomizer(MyCacheProperties myCacheProperties, RedisCacheConfiguration redisCacheConfiguration) &#123; return new MyRedisCacheManagerBuilderCustomizer(myCacheProperties,redisCacheConfiguration); &#125;&#125; ç¬¬å››æ­¥ï¼šä½¿ç”¨çš„æ—¶å€™éžå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ application.properties é‡Œé¢åšå¦‚ä¸‹é…ç½®å³å¯ã€‚ 123456# è®¾ç½®é»˜è®¤çš„è¿‡æœŸæ—¶é—´æ˜¯20åˆ†é’Ÿspring.cache.redis.time-to-live=20m# è®¾ç½®åˆšæ‰çš„ä¾‹å­ @Cacheable(value=&quot;userInfo&quot;)5åˆ†é’Ÿè¿‡æœŸspring.cache.redis.cache-name-config.userInfo=5m# è®¾ç½® roomçš„cache1å°æ—¶è¿‡æœŸspring.cache.redis.cache-name-config.room=1h è‡ªå®šä¹‰ KeyGenerator å®žçŽ°ï¼Œredis çš„ key è‡ªå®šä¹‰æ‹¼æŽ¥è§„åˆ™ å‡å¦‚ä¸å–œæ¬¢é»˜è®¤çš„ cache ç”Ÿæˆçš„ key çš„ string è§„åˆ™ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå®šä¹‰ã€‚åˆ›å»º MyRedisCachingConfigurerSupport é›†æˆ CachingConfigurerSupport å³å¯ï¼Œä»£ç å¦‚ä¸‹ã€‚ 12345678910111213141516171819202122@Component@Log4j2public class MyRedisCachingConfigurerSupport extends CachingConfigurerSupport &#123; @Override public KeyGenerator keyGenerator() &#123; return getKeyGenerator(); &#125; /** * è¦†ç›–é»˜è®¤çš„redis keyçš„ç”Ÿæˆè§„åˆ™ï¼Œå˜æˆ"æ–¹æ³•å:å‚æ•°:å‚æ•°" * @return */ public static KeyGenerator getKeyGenerator() &#123; return (target, method, params) -&gt; &#123; StringBuilder key = new StringBuilder(); key.append(ClassUtils.getQualifiedMethodName(method)); for (Object obc : params) &#123; key.append(":").append(obc); &#125; return key.toString(); &#125;; &#125;&#125; å½“å‘ç”Ÿ cache å’Œ redis çš„æ“ä½œå¼‚å¸¸æ—¶ï¼Œä¸å¸Œæœ›é˜»ç¢ä¸»æµç¨‹ï¼Œæ‰“å°ä¸€ä¸ªå…³é”®æ—¥å¿—å³å¯ åªéœ€è¦åœ¨ MyRedisCachingConfigurerSupport é‡Œé¢å†å®žçŽ°çˆ¶ç±»çš„ errorHandler å³å¯ï¼Œä»£ç å˜æˆäº†å¦‚ä¸‹æ¨¡æ ·ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Log4j2public class MyRedisCachingConfigurerSupport extends CachingConfigurerSupport &#123; @Override public KeyGenerator keyGenerator() &#123; return getKeyGenerator(); &#125; /** * è¦†ç›–é»˜è®¤çš„redis keyçš„ç”Ÿæˆè§„åˆ™ï¼Œå˜æˆ"æ–¹æ³•å:å‚æ•°:å‚æ•°" * @return */ public static KeyGenerator getKeyGenerator() &#123; return (target, method, params) -&gt; &#123; StringBuilder key = new StringBuilder(); key.append(ClassUtils.getQualifiedMethodName(method)); for (Object obc : params) &#123; key.append(":").append(obc); &#125; return key.toString(); &#125;; &#125; /** * è¦†ç›–é»˜è®¤å¼‚å¸¸å¤„ç†æ–¹æ³•ï¼Œä¸æŠ›å¼‚å¸¸ï¼Œæ”¹æ‰“å°erroræ—¥å¿— * * @return */ @Override public CacheErrorHandler errorHandler() &#123; return new CacheErrorHandler() &#123; @Override public void handleCacheGetError(RuntimeException exception, Cache cache, Object key) &#123; log.error(String.format("Spring cache GET error:cache=%s,key=%s", cache, key), exception); &#125; @Override public void handleCachePutError(RuntimeException exception, Cache cache, Object key, Object value) &#123; log.error(String.format("Spring cache PUT error:cache=%s,key=%s", cache, key), exception); &#125; @Override public void handleCacheEvictError(RuntimeException exception, Cache cache, Object key) &#123; log.error(String.format("Spring cache EVICT error:cache=%s,key=%s", cache, key), exception); &#125; @Override public void handleCacheClearError(RuntimeException exception, Cache cache) &#123; log.error(String.format("Spring cache CLEAR error:cache=%s", cache), exception); &#125; &#125;; &#125;&#125; æ”¹å˜é»˜è®¤çš„ cache é‡Œé¢ redis çš„ value åºåˆ—åŒ–æ–¹å¼ é»˜è®¤æœ‰å¯èƒ½æ˜¯ JDK åºåˆ—åŒ–æ–¹å¼ï¼Œæ‰€ä»¥ä¸€èˆ¬çœ‹ä¸æ‡‚ redis é‡Œé¢çš„å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠåºåˆ—åŒ–æ–¹å¼æ”¹æˆ JSON æ ¼å¼ï¼Œåªéœ€è¦åœ¨ CacheConfiguration é‡Œé¢å¢žåŠ é»˜è®¤çš„ RedisCacheConfiguration é…ç½®å³å¯ï¼Œå®Œæ•´çš„ CacheConfiguration å˜æˆå¦‚ä¸‹ä»£ç æ‰€ç¤ºçš„æ ·å­ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071@EnableCaching@Configuration@EnableConfigurationProperties(value = &#123;MyCacheProperties.class,CacheProperties.class&#125;)@AutoConfigureAfter(&#123;CacheAutoConfiguration.class&#125;)public class CacheConfiguration &#123; /** * æ”¯æŒä¸åŒçš„cache nameæœ‰ä¸åŒçš„ç¼“å­˜æ—¶é—´çš„é…ç½® * * @param myCacheProperties * @param redisCacheConfiguration * @return */ @Bean @ConditionalOnMissingBean(name = "myRedisCacheManagerBuilderCustomizer") @ConditionalOnClass(RedisCacheManagerBuilderCustomizer.class) public MyRedisCacheManagerBuilderCustomizer myRedisCacheManagerBuilderCustomizer(MyCacheProperties myCacheProperties, RedisCacheConfiguration redisCacheConfiguration) &#123; return new MyRedisCacheManagerBuilderCustomizer(myCacheProperties,redisCacheConfiguration); &#125; /** * cacheå¼‚å¸¸ä¸æŠ›å¼‚å¸¸ï¼Œåªæ‰“å°erroræ—¥å¿— * * @return */ @Bean @ConditionalOnMissingBean(name = "myRedisCachingConfigurerSupport") public MyRedisCachingConfigurerSupport myRedisCachingConfigurerSupport() &#123; return new MyRedisCachingConfigurerSupport(); &#125; /** * ä¾èµ–é»˜è®¤çš„ObjectMapperï¼Œå®žçŽ°æ™®é€šçš„jsonåºåˆ—åŒ– * @param defaultObjectMapper * @return */ @Bean(name = "genericJackson2JsonRedisSerializer") @ConditionalOnMissingBean(name = "genericJackson2JsonRedisSerializer") public GenericJackson2JsonRedisSerializer genericJackson2JsonRedisSerializer(ObjectMapper defaultObjectMapper) &#123; ObjectMapper objectMapper = defaultObjectMapper.copy(); objectMapper.registerModule(new Hibernate5Module().enable(REPLACE_PERSISTENT_COLLECTIONS)); //æ”¯æŒJPAçš„å®žä½“çš„jsonçš„åºåˆ—åŒ– objectMapper.configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true); objectMapper.deactivateDefaultTyping(); //å…³é—­ defaultTypeï¼Œä¸éœ€è¦å…³å¿ƒredisé‡Œé¢æ˜¯å¦ä¸ºå¯¹è±¡çš„ç±»åž‹ return new GenericJackson2JsonRedisSerializer(objectMapper); &#125; /** * è¦†ç›– RedisCacheConfigurationï¼Œåªæ˜¯ä¿®æ”¹serializeValues with jackson * * @param cacheProperties * @return */ @Bean @ConditionalOnMissingBean(name = "jacksonRedisCacheConfiguration") public RedisCacheConfiguration jacksonRedisCacheConfiguration(CacheProperties cacheProperties, GenericJackson2JsonRedisSerializer genericJackson2JsonRedisSerializer) &#123; CacheProperties.Redis redisProperties = cacheProperties.getRedis(); RedisCacheConfiguration config = RedisCacheConfiguration .defaultCacheConfig(); config = config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(genericJackson2JsonRedisSerializer));//ä¿®æ”¹çš„å…³é”®æ‰€åœ¨ï¼ŒæŒ‡å®šJackson2JsonRedisSerializerçš„æ–¹å¼ if (redisProperties.getTimeToLive() != null) &#123; config = config.entryTtl(redisProperties.getTimeToLive()); &#125; if (redisProperties.getKeyPrefix() != null) &#123; config = config.prefixCacheNameWith(redisProperties.getKeyPrefix()); &#125; if (!redisProperties.isCacheNullValues()) &#123; config = config.disableCachingNullValues(); &#125; if (!redisProperties.isUseKeyPrefix()) &#123; config = config.disableKeyPrefix(); &#125; return config; &#125;&#125;]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa Hibernate ä¸€çº§ç¼“å­˜]]></title>
    <url>%2F2021%2F01%2F26%2FSpringDataJpa%E7%9A%84Hibernate%E7%9A%84%E4%B8%80%E7%BA%A7%E7%BC%93%E5%AD%98%2F</url>
    <content type="text"><![CDATA[Hibernate ä¸€çº§ç¼“å­˜ä¸€çº§ç¼“å­˜ä»€ä¹ˆæ˜¯ä¸€çº§ç¼“å­˜æŒ‰ç…§ Hibernate å’Œ JPA åè®®é‡Œé¢çš„è§£é‡Šï¼Œç»å¸¸è¯´çš„ First Level Cacheï¼ˆä¸€çº§ç¼“å­˜ï¼‰ä¹Ÿå°±æ˜¯ PersistenceContextï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€ä¸€çº§ç¼“å­˜çš„è½½ä½“æ˜¯ Session æˆ–è€… EntityManagerï¼›è€Œä¸€çº§ç¼“å­˜çš„å®žä½“ä¹Ÿå°±æ˜¯æ•°æ®åº“é‡Œé¢å¯¹åº”çš„å®žä½“ã€‚ åœ¨ SessionImpl çš„å®žçŽ°è¿‡ç¨‹ä¸­ï¼Œä¼šå‘çŽ° PersistenceContext çš„å®žçŽ°ç±» StatefulPersistenceContext æ˜¯é€šè¿‡ HashMap æ¥å­˜å‚¨å®žä½“ä¿¡æ¯çš„ã€‚ å…¶å…³é”®æºç å¦‚ä¸‹æ‰€ç¤ºï¼š 1234567891011121314151617public class StatefulPersistenceContext implements PersistenceContext &#123; //æ ¹æ®EntityUniqueKeyä½œä¸ºkeyæ¥å‚¨å­˜Entity private HashMap&lt;EntityUniqueKey, Object&gt; entitiesByUniqueKey; //æ ¹æ®EntityUniqueKeyä½œä¸ºkeyå–å½“å‰å®žä½“ @Override public Object getEntity(EntityUniqueKey euk) &#123; return entitiesByUniqueKey == null ? null : entitiesByUniqueKey.get( euk ); &#125; //å‚¨å­˜å®žä½“ï¼Œå¦‚æžœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆåˆ›å»ºHashMap&lt;&gt; @Override public void addEntity(EntityUniqueKey euk, Object entity) &#123; if ( entitiesByUniqueKey == null ) &#123; entitiesByUniqueKey = new HashMap&lt;&gt;( INIT_COLL_SIZE ); &#125; entitiesByUniqueKey.put( euk, entity ); &#125;......&#125; å…¶ä¸­ EntityUniqueKey çš„æ ¸å¿ƒæºç å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516public class EntityUniqueKey implements Serializable &#123; private final String uniqueKeyName; private final String entityName; private final Object key; private final Type keyType; private final EntityMode entityMode; private final int hashCode; @Override public boolean equals(Object other) &#123; EntityUniqueKey that = (EntityUniqueKey) other; return that != null &amp;&amp; that.entityName.equals( entityName ) &amp;&amp; that.uniqueKeyName.equals( uniqueKeyName ) &amp;&amp; keyType.isEqual( that.key, key ); &#125;...&#125; é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œç”¨ PersistenceContext æ¥åˆ¤æ–­å®žä½“æ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯ä»¥ç›´æŽ¥æ ¹æ®å®žä½“é‡Œé¢çš„ä¸»é”®è¿›è¡Œã€‚ ä¸€çº§ç¼“å­˜çš„ä½œç”¨ç”±äºŽä¸€çº§ç¼“å­˜å°±æ˜¯ PersistenceContextï¼Œé‚£ä¹ˆä¸€çº§ç¼“å­˜çš„æœ€å¤§ä½œç”¨å°±æ˜¯ç®¡ç† Entity çš„ç”Ÿå‘½å‘¨æœŸã€‚ Newï¼ˆTransientï¼‰çŠ¶æ€çš„ï¼Œä¸åœ¨ä¸€çº§ç¼“å­˜ç®¡ç†ä¹‹åˆ—ï¼Œè¿™æ˜¯æ–°åˆ›å»ºçš„ï¼› Detached æ¸¸ç¦»çŠ¶æ€çš„ï¼Œä¸åœ¨ä¸€çº§ç¼“å­˜é‡Œé¢ï¼Œå’Œ New çš„å”¯ä¸€åŒºåˆ«æ˜¯å®ƒå¸¦æœ‰ä¸»é”®å’Œ Version ä¿¡æ¯ï¼› Managerã€Removed çŠ¶æ€çš„å®žä½“åœ¨ä¸€çº§ç¼“å­˜ç®¡ç†ä¹‹åˆ—ï¼Œæ‰€æœ‰å¯¹è¿™ä¸¤ç§çŠ¶æ€çš„å®žä½“è¿›è¡Œçš„æ›´æ–°æ“ä½œï¼Œéƒ½ä¸ä¼šç«‹å³æ›´æ–°åˆ°æ•°æ®åº“é‡Œé¢ï¼Œåªæœ‰æ‰§è¡Œäº† flush ä¹‹åŽæ‰ä¼šåŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚ ç”¨ä¸€å¼ å›¾(æ³¨ï¼šå›¾ç‰‡æ¥æºäºŽç½‘ç»œ)æ¥è¡¨ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ å¯¹äºŽå®žä½“ 1 æ¥è¯´ï¼Œæ–°å¢žå’Œæ›´æ–°æ“ä½œéƒ½æ˜¯å…ˆè¿›è¡Œä¸€çº§ç¼“å­˜ï¼Œåªæœ‰ flush çš„æ—¶å€™æ‰ä¼šåŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚è€Œå½“æˆ‘ä»¬æ‰§è¡Œäº† entityManager.clean() æˆ–è€…æ˜¯ entityManager.detach(entity1)ï¼Œé‚£ä¹ˆå®žä½“ 1 å°±ä¼šå˜æˆæ¸¸ç¦»çŠ¶æ€ï¼Œè¿™æ—¶å†å¯¹å®žä½“ 1 è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æžœå†æ‰§è¡Œ flush çš„è¯ï¼Œå°±ä¸ä¼šåŒæ­¥åˆ° DB é‡Œé¢äº†ã€‚ç”¨ä»£ç æ¥è¯´æ˜Žä¸€ä¸‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122232425262728public class UserInfoRepositoryTest &#123; @Autowired private UserInfoRepository userInfoRepository; @PersistenceContext(properties = &#123;@PersistenceProperty( name = "org.hibernate.flushMode", value = "MANUAL"//æ‰‹åŠ¨flush )&#125;) private EntityManager entityManager; @Test @Transactional public void testLife() &#123; UserInfo userInfo = UserInfo.builder().name("new name").build(); //æ–°å¢žä¸€ä¸ªå¯¹è±¡userInfoäº¤ç»™PersistenceContextç®¡ç†ï¼Œå³ä¸€çº§ç¼“å­˜ entityManager.persist(userInfo); //æ­¤æ—¶æ²¡æœ‰detachå’Œclearä¹‹å‰ï¼Œflushçš„æ—¶å€™è¿˜ä¼šäº§ç”Ÿæ›´æ–°SQL userInfo.setName("old name"); entityManager.flush(); entityManager.clear();// entityManager.detach(userInfo); // entityManagerå·²ç»clearï¼Œæ­¤æ—¶å·²ç»ä¸ä¼šå¯¹UserInfoè¿›è¡Œæ›´æ–°äº† userInfo.setName("new name 11"); entityManager.flush(); //ç”±äºŽæœ‰cacheæœºåˆ¶ï¼Œç›¸åŒçš„å¯¹è±¡æŸ¥è¯¢åªä¼šè§¦å‘ä¸€æ¬¡æŸ¥è¯¢SQL UserInfo u1 = userInfoRepository.findById(1L).get(); //to do some thing UserInfo u2 = userInfoRepository.findById(1L).get(); &#125;&#125; æŠŠ SQL æ‰“å°ä¸€ä¸‹ï¼Œè¾“å‡ºåˆ°æŽ§åˆ¶å°çš„ SQL å¦‚ä¸‹æ‰€ç¤ºã€‚ 123Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)Hibernate: update user_info set create_time=?, create_user_id=?, last_modified_time=?, last_modified_user_id=?, version=?, ages=?, email_address=?, last_name=?, name=?, telephone=? where id=? and version=?Hibernate: select userinfo0_.id as id1_2_0_, userinfo0_.create_time as create_t2_2_0_, userinfo0_.create_user_id as create_u3_2_0_, userinfo0_.last_modified_time as last_mod4_2_0_, userinfo0_.last_modified_user_id as last_mod5_2_0_, userinfo0_.version as version6_2_0_, userinfo0_.ages as ages7_2_0_, userinfo0_.email_address as email_ad8_2_0_, userinfo0_.last_name as last_nam9_2_0_, userinfo0_.name as name10_2_0_, userinfo0_.telephone as telepho11_2_0_, rooms1_.user_info_id as user_inf1_3_1_, room2_.id as rooms_id2_3_1_, room2_.id as id1_1_2_, room2_.create_time as create_t2_1_2_, room2_.create_user_id as create_u3_1_2_, room2_.last_modified_time as last_mod4_1_2_, room2_.last_modified_user_id as last_mod5_1_2_, room2_.version as version6_1_2_, room2_.title as title7_1_2_ from user_info userinfo0_ left outer join user_info_rooms rooms1_ on userinfo0_.id=rooms1_.user_info_id left outer join room room2_ on rooms1_.rooms_id=room2_.id where userinfo0_.id=? é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°æ²¡æœ‰ç¬¬äºŒæ¬¡æ›´æ–°ã€‚ ä¸èƒ½è®¾ç½®ä¸€çº§ç¼“å­˜çš„å¤§å° ä»Žåº•å±‚åŽŸç†å¯ä»¥åˆ†æžå‡ºï¼šä¸€çº§ç¼“å­˜ä¾èµ– Java å†…å­˜å †çš„å¤§å°ï¼Œæ‰€ä»¥å—åˆ°æœ€å¤§å †å’Œæœ€å°å †çš„é™åˆ¶ï¼Œå³æ¸…é™¤ä¸€çº§ç¼“å­˜çš„æœºåˆ¶å°±æ˜¯åˆ©ç”¨ JVM çš„ GC æœºåˆ¶ï¼Œæ¸…ç†æŽ‰ GC å°±ä¼šæ¸…ç†æŽ‰ä¸€çº§ç¼“å­˜ã€‚ æ‰€ä»¥å½“è¯·æ±‚å¹¶å‘é‡å¤§çš„æ—¶å€™ï¼ŒSession çš„å¯¹è±¡å°±ä¼šå˜å¾—å¾ˆå¤šï¼Œæ­¤æ—¶å°±ä¼šéœ€è¦æ›´å¤šå†…å­˜ã€‚å½“è¯·æ±‚ç»“æŸä¹‹åŽï¼Œéšç€ GC çš„å›žæ”¶ï¼Œé‡Œé¢å°±ä¼šæ¸…é™¤ä¸€çº§ç¼“å­˜ç•™ä¸‹æ¥çš„å¯¹è±¡ã€‚ ä¸èƒ½å…³é—­ä¸€çº§ç¼“å­˜ é™¤éžä¸ç”¨ Hibernate æˆ– JPAï¼Œæ”¹ç”¨ Mybatisï¼Œå› ä¸ºä¸€çº§ç¼“å­˜æ˜¯ JPA çš„æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€ã€‚ Query Plan CacheJPA é‡Œé¢å¤§éƒ¨åˆ†çš„æŸ¥è¯¢éƒ½æ˜¯åŸºäºŽ JPQL æŸ¥è¯¢è¯­æ³•ï¼Œä»Žè€Œä¼šæœ‰ä¸€ä¸ªè¿‡ç¨‹æŠŠ JPQL è½¬åŒ–æˆçœŸæ­£çš„ SQLï¼Œè€ŒåŽåˆ°æ•°æ®åº“é‡Œæ‰§è¡Œã€‚è€Œ JPQL è½¬åŒ–æˆåŽŸå§‹çš„ SQL æ—¶ï¼Œå°±ä¼šæ¶ˆè€—ä¸€å®šçš„æ€§èƒ½ï¼Œæ‰€ä»¥ Hibernate è®¾è®¡äº†ä¸€ä¸ª Query Plan Cache çš„æœºåˆ¶ï¼Œç”¨æ¥å­˜å‚¨ JPQL æˆ–è€… Criteria Query åˆ° Native SQL ä¸­è½¬åŒ–çš„ç»“æžœï¼Œä¹Ÿå°±æ˜¯è¯´ Query Plan Cache é‡Œé¢å­˜å‚¨äº†æœ€ç»ˆè¦æ‰§è¡Œçš„ SQLï¼Œä»¥åŠå‚æ•°å’Œè¿”å›žç»“æžœçš„ç±»åž‹ã€‚ QueryPlanCache æ˜¯ä»€ä¹ˆåœ¨ Hibernate ä¸­ï¼ŒQueryPlanCache å°±æ˜¯æŒ‡å…·ä½“çš„æŸä¸€ä¸ªç±»ã€‚æ ¸å¿ƒæºç å¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package org.hibernate.engine.query.spi;//å­˜å‚¨query plan å’Œ query parameter metdatapublic class QueryPlanCache implements Serializable &#123; //queryPlanCacheçš„å­˜å‚¨ç»“æž„ä¸ºè‡ªå®šä¹‰çš„HashMapç»“æž„ï¼Œç”¨æ¥å­˜å‚¨JPQLåˆ°SQLçš„è½¬åŒ–è¿‡ç¨‹åŠå…¶SQLçš„æ‰§è¡Œè¯­å¥å’Œå‚æ•°ï¼Œè¿”å›žç»“æžœçš„metadata; private final BoundedConcurrentHashMap queryPlanCache; //è¿™ä¸ªç”¨æ¥å­˜å‚¨@Queryçš„nativeQuery = trueçš„query planï¼Œå³åŽŸå§‹SQLçš„meta,åŒ…å«å‚æ•°å’Œreturn typeçš„ meta; private final BoundedConcurrentHashMap&lt;ParameterMetadataKey,ParameterMetadataImpl&gt; parameterMetadataCache; //QueryPlanCacheçš„æž„é€ æ–¹æ³• public QueryPlanCache(final SessionFactoryImplementor factory, QueryPlanCreator queryPlanCreator) &#123; this.factory = factory; this.queryPlanCreator = queryPlanCreator; //maxParameterMetadataçš„ä¸ªæ•°ï¼Œè®¡ç®—é€»è¾‘ï¼Œå¯ä»¥è‡ªå®šä¹‰é…ç½®ï¼Œæˆ–è€…é‡‡ç”¨é»˜è®¤å€¼ Integer maxParameterMetadataCount = ConfigurationHelper.getInteger( Environment.QUERY_PLAN_CACHE_PARAMETER_METADATA_MAX_SIZE, factory.getProperties() ); if ( maxParameterMetadataCount == null ) &#123; maxParameterMetadataCount = ConfigurationHelper.getInt( Environment.QUERY_PLAN_CACHE_MAX_STRONG_REFERENCES, factory.getProperties(), DEFAULT_PARAMETER_METADATA_MAX_COUNT ); &#125; //maxQueryPlançš„ä¸ªæ•°ï¼Œè®¡ç®—é€»è¾‘ï¼Œå¯ä»¥è‡ªå®šä¹‰é…ç½®å¤§å°ï¼Œæˆ–è€…é‡‡ç”¨é»˜è®¤å€¼ Integer maxQueryPlanCount = ConfigurationHelper.getInteger( Environment.QUERY_PLAN_CACHE_MAX_SIZE, factory.getProperties() ); if ( maxQueryPlanCount == null ) &#123; maxQueryPlanCount = ConfigurationHelper.getInt( Environment.QUERY_PLAN_CACHE_MAX_SOFT_REFERENCES, factory.getProperties(), DEFAULT_QUERY_PLAN_MAX_COUNT ); &#125; //æ–°å»ºä¸€ä¸ª BoundedConcurrentHashMapçš„queryPlanCacheï¼Œç”¨æ¥å­˜å‚¨JPQLå’ŒCriteria Queryåˆ°SQLçš„è½¬åŒ–è¿‡ç¨‹ queryPlanCache = new BoundedConcurrentHashMap( maxQueryPlanCount, 20, BoundedConcurrentHashMap.Eviction.LIRS ); //æ–°å»ºä¸€ä¸ª BoundedConcurrentHashMapçš„parameterMetadataCacheï¼Œç”¨æ¥å­˜å‚¨Native SQLçš„è½¬åŒ–è¿‡ç¨‹ parameterMetadataCache = new BoundedConcurrentHashMap&lt;&gt;( maxParameterMetadataCount, 20, BoundedConcurrentHashMap.Eviction.LIRS ); nativeQueryInterpreter = factory.getServiceRegistry().getService( NativeQueryInterpreter.class ); &#125; // é»˜è®¤çš„parameterMetadataCacheçš„HashMapçš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œé»˜è®¤128æ¡ public static final int DEFAULT_PARAMETER_METADATA_MAX_COUNT = 128; //é»˜è®¤çš„queryPlanCacheçš„HashMapå­˜å‚¨ç©ºé—´å¤§å°ï¼Œé»˜è®¤2048æ¡ public static final int DEFAULT_QUERY_PLAN_MAX_COUNT = 2048;......ä¸é‡è¦çš„ä»£ç å…ˆçœç•¥&#125; QueryPlanCache å­˜å‚¨çš„å†…å®¹æ–°å»ºä¸€ä¸ª UserInfoRepositoryï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ã€‚ 123456789101112131415public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt; &#123; //æ²¡æœ‰ç”¨@Queryï¼Œç›´æŽ¥ä½¿ç”¨method name defining query List&lt;UserInfo&gt; findByNameAndCreateTimeBetween(String name, Instant begin, Instant endTime); //æ¼”ç¤ºSpELæ ¹æ®æ•°ç»„ä¸‹æ ‡å–å‚æ•°ï¼Œå’Œæ ¹æ®æ™®é€šçš„Parmaçš„åå­—:nameå–å‚æ•° @Query("select u from UserInfo u where u.lastName like %:#&#123;[0]&#125; and u.name like %:name%") List&lt;UserInfo&gt; findContainingEscaped(@Param("name") String name); //SpELå–Parmaçš„åå­—customeré‡Œé¢çš„å±žæ€§ @Query("select u from UserInfo u where u.name = :#&#123;#customer.name&#125;") List&lt;UserInfo&gt; findUsersByCustomersFirstname(@Param("customer") UserInfo customer); //åˆ©ç”¨SpELæ ¹æ®ä¸€ä¸ªå†™æ­»çš„'jack'å­—ç¬¦ä¸²ä½œä¸ºå‚æ•° @Query("select u from UserInfo u where u.name = ?#&#123;'jack'&#125;") List&lt;UserInfo&gt; findOliverBySpELExpressionWithoutArgumentsWithQuestionmark(); @Query(value = "select * from user_info where name=:name",nativeQuery = true) List&lt;UserInfo&gt; findByName(@Param(value = "name") String name);&#125; é€šè¿‡ @Query å®šä¹‰çš„ nativeQuery=false çš„ JPQLï¼Œä¼šåœ¨å¯åŠ¨æˆåŠŸä¹‹åŽé¢„å…ˆæ”¾åœ¨ QueryPlanCache é‡Œé¢ï¼Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š å‘çŽ°é‡Œé¢ parameterMetadataCache æ˜¯ç©ºçš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ”¾ç½® nativeQuery=true çš„ Query SQLï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•é‡Œé¢å®šä¹‰çš„å…¶ä»–ä¸‰ä¸ª @Query çš„ JPQL è§£æžè¿‡ç¨‹ã€‚æ‰“å¼€ç¬¬ä¸€ä¸ªè¯¦ç»†çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ QueryPlanCache è¿˜æ˜¯èƒ½å­˜æŒºå¤šä¸œè¥¿çš„ï¼šnavtive sqlã€å‚æ•°ã€return ç­‰å„ç§ metadataã€‚ä¹Ÿå¯ä»¥çœ‹å‡ºä¸€ä¸ªç®€å•çš„ JPQL æŸ¥è¯¢ä¼šæœ‰äº›å ç”¨å †å†…å­˜ï¼Œæ‰€ä»¥å¦‚æžœæ˜¯å¤æ‚ç‚¹çš„é¡¹ç›®ï¼Œå„ç§æŸ¥è¯¢çš„ JPQL å¤šä¸€ç‚¹çš„è¯ï¼Œå¯åŠ¨æ‰€éœ€è¦çš„æœ€å°å †å†…å­˜ä¼šå ç”¨ 300Mã€400M çš„ç©ºé—´ï¼Œè¿™æ˜¯æ­£å¸¸çŽ°è±¡ã€‚ åœ¨ UserInfoRepository çš„äº”ä¸ªæ–¹æ³•ä¸­ï¼Œå‰©ä¸‹çš„ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ name defining query å’Œ nativeQuery=trueã€‚è¿™ä¸¤ç§æƒ…å†µæ˜¯ï¼Œå½“è°ƒç”¨çš„æ—¶å€™å‘çŽ° QueryPlanCache é‡Œé¢æ²¡æœ‰å®ƒä»¬ï¼ŒäºŽæ˜¯å°±ä¼šè¢«å¢žåŠ è¿›åŽ»ï¼Œä¸‹æ¬¡å°±å¯ä»¥ç›´æŽ¥ä»Ž QueryPlanCache é‡Œé¢å–äº†ã€‚é‚£ä¹ˆåœ¨ Controller é‡Œé¢æ‰§è¡Œè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 12userInfoRepository.findByNameAndCreateTimeBetween("JK", Instant.now(),Instant.now());userInfoRepository.findByName("jack"); ç„¶åŽé€šè¿‡æ–­ç‚¹å°±ä¼šå‘çŽ° QueryPlanCache é‡Œé¢å¤šäº†ä¸¤ä¸ª Cacheï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ åŒæ—¶ï¼ŒparameterMetadataCache é‡Œé¢å°±ä¼šå¤šä¸€æ¡ key/value çš„ nativeQuery=true çš„è§£æžè®°å½•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æ€»ç»“èµ·æ¥å°±æ˜¯ï¼ŒQueryPlanCache ç”¨æ¥å­˜å‚¨çš„ JQPL æˆ–è€… SQL çš„ Metadata ä¿¡æ¯ï¼Œä»Žè€Œæå‡äº† Hibernate æ‰§è¡Œ JPQL çš„æ€§èƒ½ï¼Œå› ä¸ºåªæœ‰ç¬¬ä¸€æ¬¡éœ€è¦æŠŠ JPQL è½¬åŒ–æˆ SQLï¼ŒåŽé¢çš„æ¯æ¬¡æ“ä½œå°±å¯ä»¥ç›´æŽ¥ä»Ž HashMap ä¸­æ‰¾åˆ°å¯¹åº”çš„ SQLï¼Œç›´æŽ¥æ‰§è¡Œå°±å¯ä»¥äº†ã€‚ QueryPlanCache å’Œ Session æ˜¯ä»€ä¹ˆå…³ç³»åœ¨ SessionFactoryImpl çš„æž„é€ æ–¹æ³•é‡Œé¢ä¼š new QueryPlanCache(...)ï¼Œå…³é”®æºç å¦‚ä¸‹ã€‚ è¯´æ˜Žè¿™ä¸ª application åªéœ€è¦åˆ›å»ºä¸€æ¬¡ QueryPlanCacheï¼Œæ•´ä¸ªé¡¹ç›®å‘¨æœŸæ˜¯å•ä¾‹çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¢«ä¸åŒçš„ Session å…±äº«ï¼Œé‚£ä¹ˆå¯ä»¥æŸ¥çœ‹ Session çš„å…³é”®æºç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ä¸ª SessionImpl çš„å®žä¾‹åœ¨èŽ·å¾— query plan ä¹‹å‰ï¼Œéƒ½ä¼šåŽ»åŒä¸€ä¸ª QueryPlanCache é‡Œé¢æŸ¥è¯¢ä¸€ä¸‹ JPQL å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ã€‚æ‰€ä»¥å¯ä»¥çœ‹å¾—å‡ºæ¥ QueryPlanCache å’Œ Session çš„å…³ç³»æœ‰å¦‚ä¸‹å‡ ç‚¹ã€‚ QueryPlanCache åœ¨æ•´ä¸ª Spring Application å‘¨æœŸå†…å°±æ˜¯ä¸€ä¸ªå®žä¾‹ ä¸åŒçš„ Session ä½œç”¨åŸŸï¼Œå¯ä»¥ä»£è¡¨ä¸åŒçš„ SessionImpl å®žä¾‹å…±äº« QueryPlanCache QueryPlanCache å’Œä¸€çº§ç¼“å­˜å®Œå…¨ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µ QueryPlanCache ä¸­ In æŸ¥è¯¢å¼•å‘çš„å†…å­˜æ³„æ¼é—®é¢˜åœ¨å®žé™…çš„å·¥ä½œä¸­ä½¿ç”¨ JPA çš„æ—¶å€™ï¼Œä¼šå‘çŽ°å…¶å†…å­˜è¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸ä¼šè¢«åžƒåœ¾å›žæ”¶æœºåˆ¶ç»™å›žæ”¶æŽ‰ï¼ŒçŽ°è±¡å°±æ˜¯å †å†…å­˜éšç€æ—¶é—´çš„æŽ¨ç§»ä½¿ç”¨é‡è¶Šæ¥è¶Šå¤§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¾ˆæ˜Žæ˜¾æ˜¯å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ è€ŒæŠŠå †æ ˆæ‹¿å‡ºæ¥åˆ†æžçš„è¯ä¼šå‘çŽ°ï¼Œå…¶å®žæ˜¯ Hibernate çš„ QueryPlanCache å ç”¨äº†å¤§é‡çš„å†…å­˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ In æŸ¥è¯¢æ¡ä»¶å¼•å‘å†…å­˜æ³„æ¼çš„åŽŸå› åœ¨ UserInfoRepository é‡Œé¢æ–°å¢žä¸€ä¸ª In æ¡ä»¶çš„æŸ¥è¯¢æ–¹æ³•ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹å®žé™…å·¥ä½œä¸­çš„ In æŸ¥è¯¢æ¡ä»¶çš„åœºæ™¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 1234public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt; &#123;//æµ‹è¯•InæŸ¥è¯¢æ¡ä»¶çš„æƒ…å†µList&lt;UserInfo&gt; findByNameAndUrlIn(String name, Collection&lt;String&gt; urls);&#125; å‡è®¾æœ‰ä¸ªéœ€æ±‚ï¼ŒæŸ¥è¯¢æ‹¥æœ‰ä¸ªäººåšå®¢åœ°å€çš„ç”¨æˆ·æœ‰å“ªäº›ï¼Ÿ Controller é‡Œé¢æœ‰å¦‚ä¸‹æ–¹æ³•ã€‚ 12345@GetMapping("/users")public List&lt;UserInfo&gt; getUserInfos(List&lt;String&gt; urls) &#123; //æ ¹æ®urlsæ‰¹é‡æŸ¥è¯¢ï¼Œæ¨¡æ‹Ÿå®žé™…å·¥ä½œä¸­çš„æ‰¹é‡æŸ¥è¯¢æƒ…å†µï¼Œå®žé™…å·¥ä½œä¸­å¯èƒ½ä¼šæœ‰å¤§é‡çš„æ ¹æ®ä¸åŒçš„IDSæ‰¹é‡æŸ¥è¯¢çš„åœºæ™¯ï¼› return userInfoRepository.findByNameAndUrlIn("jack",urls);&#125; debug çœ‹ä¸€ä¸‹ QueryPlanCache é‡Œé¢çš„æƒ…å†µï¼Œä¼šå‘çŽ°éšç€ In æŸ¥è¯¢æ¡ä»¶çš„ä¸ªæ•°å¢žåŠ ï¼Œä¼šç”Ÿæˆä¸åŒçš„ QueryPlanCacheï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†åˆ«æ˜¯ 1 ä¸ªå‚æ•°ã€3 ä¸ªå‚æ•°ã€6ä¸ªå‚æ•°çš„æƒ…å†µã€‚ ä»Žå›¾ä¸­å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœä¸šåŠ¡ä»£ç ä¸­æœ‰å„ç§ In çš„æŸ¥è¯¢æ“ä½œï¼Œä¸åŒçš„æŸ¥è¯¢æ¡ä»¶çš„ä¸ªæ•°è‚¯å®šåœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸­ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œç”šè‡³æœ‰äº›åœºæ™¯èƒ½ä¸€ä¸‹æŸ¥è¯¢åˆ°å‡ ç™¾ä¸ª ID å¯¹åº”çš„æ•°æ®ï¼Œå¯æƒ³è€ŒçŸ¥ï¼Œé‚£å¾—ç”Ÿæˆå¤šå°‘ä¸ª In ç›¸å…³çš„ QueryPlanCache å‘€ã€‚ è€Œä¾æ® QueryPlanCache çš„åŽŸç†ï¼Œæ•´ä¸ªå·¥ç¨‹éƒ½æ˜¯å•ä¾‹çš„ï¼Œæ”¾è¿›åŽ»ä¹‹åŽè‚¯å®šä¸ä¼šè¿›è¡Œå†…å­˜åžƒåœ¾å›žæ”¶ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œæ—¶é—´ä¹…äº†ä¹‹åŽå°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç”šè‡³ä¸€æ®µæ—¶é—´ä¹‹åŽè¿˜ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºçš„çŽ°è±¡å‘ç”Ÿã€‚é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³æ­¤ç±»é—®é¢˜å‘¢ï¼Ÿ è§£å†³ In æŸ¥è¯¢æ¡ä»¶å†…å­˜æ³„æ¼çš„æ–¹æ³•ç¬¬ä¸€ç§æ–¹æ³•ï¼šä¿®æ”¹ç¼“å­˜çš„æœ€å¤§æ¡æ•°é™åˆ¶æ­£å¦‚ä¸Šé¢ä»‹ç»çš„ï¼Œé»˜è®¤ DEFAULT_QUERY_PLAN_MAX_COUNT = 2048ï¼Œä¹Ÿå°±æ˜¯ query plan çš„æœ€å¤§æ¡æ•°é™åˆ¶æ˜¯ 2048ã€‚è¿™æ ·é»˜è®¤å€¼å¯èƒ½æœ‰ç‚¹å¤§äº†ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ä¿®æ”¹é»˜è®¤å€¼ï¼Œè¯·çœ‹ä»£ç ã€‚ 1234#ä¿®æ”¹ é»˜è®¤çš„plan_cache_max_sizeï¼Œå¤ªå°ä¼šå½±å“JPQLçš„æ‰§è¡Œæ€§èƒ½ï¼Œæ‰€ä»¥æ ¹æ®å®žé™…æƒ…å†µå¯ä»¥è‡ªç”±è°ƒæ•´ï¼Œä¸å®œå¤ªå°ï¼Œä¹Ÿä¸å®œå¤ªå¤§ï¼Œå¤ªå¤§å¯èƒ½ä¼šå¼•å‘å†…å­˜æº¢å‡ºspring.jpa.properties.hibernate.query.plan_cache_max_size=512#ä¿®æ”¹ é»˜è®¤çš„native queryçš„cacheå¤§å°spring.jpa.properties.hibernate.query.plan_parameter_metadata_max_size=128 ç¬¬äºŒç§æ–¹æ³•ï¼šæ ¹æ® max plan count é€‚å½“å¢žåŠ å †å†…å­˜å¤§å°å› ä¸º QueryPlanMaxCount æ˜¯æœ‰é™åˆ¶çš„ï¼Œé‚£ä¹ˆè‚¯å®šæœ€å¤§å †å†…å­˜çš„ä½¿ç”¨ä¹Ÿæ˜¯æœ‰å°é¡¶é™åˆ¶çš„ï¼Œæ‰¾åˆ°ä¸´ç•Œå€¼ä¿®æ”¹æœ€å°ã€æœ€å¤§å †å†…å­˜å³å¯ã€‚ ç¬¬ä¸‰ç§æ–¹æ³•ï¼šå‡å°‘ In çš„æŸ¥è¯¢ SQL ç”Ÿæˆæ¡æ•°12### é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åŒçš„inæŸ¥è¯¢æ¡ä»¶çš„ä¸ªæ•°ä¼šç”Ÿæˆä¸åŒçš„plan query cacheï¼Œæˆ‘ä»¬å¼€å¯äº†in_clause_parameter_paddingä¹‹åŽä¼šå‡å°‘inç”Ÿæˆcacheçš„ä¸ªæ•°ï¼Œä¼šæ ¹æ®å‚æ•°çš„æ ¼å¼è¿ç”¨å‡ ä½•çš„ç®—æ³•ç”ŸæˆQueryCacheï¼›spring.jpa.properties.hibernate.query.in_clause_parameter_padding=true å½“ In çš„æ—¶å€™ï¼Œå‚æ•°ä¸ªæ•°ä¼šå¯¹åº”å½’å¹¶ QueryPlanCache å˜æˆ 1ã€2ã€4ã€8ã€16ã€32ã€64ã€128 ä¸ªå‚æ•°çš„ QueryPlanCacheã€‚é‚£ä¹ˆå†çœ‹ä¸€ä¸‹åˆšæ‰å‚æ•°ä¸ªæ•°åˆ†åˆ«åœ¨ 1ã€3ã€4ã€5ã€6ã€7ã€8 ä¸ªçš„æ—¶å€™ç”Ÿæˆ QueryPlanCache çš„æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä¼šå‘çŽ°ï¼ŒIn äº§ç”Ÿä¸ªæ•°æ˜¯ 1 ä¸ªçš„æ—¶å€™ï¼Œå®ƒä¼šå…±äº«å‚æ•°ä¸º 1 ä¸ªçš„ QueryPlanCacheï¼›è€Œå½“å‚æ•°æ˜¯ 3ã€4 ä¸ª In å‚æ•°çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šä½¿ç”¨ 4 ä¸ªå‚æ•°çš„ QueryPlanCacheï¼›ä»¥æ­¤ç±»æŽ¨ï¼Œå½“å‚æ•°æ˜¯ 5ã€6ã€7ã€8 ä¸ªçš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ 8 ä¸ªå‚æ•°çš„ QueryPlanCacheâ€¦â€¦è¿™ç§ç®—æ³•å¯ä»¥å¤§å¤§åœ°å‡å°‘ In çš„ä¸åŒæŸ¥è¯¢å‚æ•°ç”Ÿæˆçš„ QueryPlanCache ä¸ªæ•°ï¼Œå ç”¨çš„å†…å­˜è‡ªç„¶ä¼šå‡å°‘å¾ˆå¤šã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa ä½¿ç”¨ SPEL]]></title>
    <url>%2F2021%2F01%2F25%2FSpringDataJpa%E4%BD%BF%E7%94%A8SPEL%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa ä½¿ç”¨ SPELSpEL åŸºç¡€è¯­æ³•SpEL å¤§çº²SpEL çš„å…¨ç§°ä¸º Spring Expression Languageï¼Œå³ Spring è¡¨è¾¾å¼è¯­è¨€ï¼Œæ˜¯ Spring framework é‡Œé¢çš„æ ¸å¿ƒé¡¹ç›®ã€‚spring-expression çš„ jar åŒ…çš„å¼•ç”¨å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä»Žæ ¸å¿ƒå¼•ç”¨æ¥çœ‹ï¼ŒSpEL è´¯ç©¿æ‰€æœ‰ Spring çš„æ ¸å¿ƒåŠŸèƒ½ã€‚å½“ç„¶äº†ï¼ŒSpEL å¯ä»¥è„±ç¦» Spring å·¥ç¨‹ç‹¬ç«‹ä½¿ç”¨ï¼Œå…¶é¡¹ç›®é‡Œæœ‰ä¸‰ä¸ªé‡è¦çš„æŽ¥å£ï¼šExpressionParserã€Expressionã€EvaluationContextï¼Œæˆ‘ä»Žå®˜æ–¹æ–‡æ¡£ä¸­æ‰¾äº†ä¸€å¼ å›¾æ¥è¯´æ˜Žå®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚ ExpressionParserå®ƒæ˜¯ SpEL çš„å¤„ç†æŽ¥å£ï¼Œé»˜è®¤å®žçŽ°ç±»æ˜¯ SpelExpressionParserï¼Œå¯¹å¤–æä¾›çš„åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºã€‚ 123456public interface ExpressionParser &#123; // æ ¹æ®ä¼ å…¥çš„è¡¨è¾¾å¼ç”ŸæˆExpression Expression parseExpression(String expressionString) throws ParseException; // æ ¹æ®ä¼ å…¥çš„è¡¨è¾¾å¼å’ŒParserContextç”ŸæˆExpressionå¯¹è±¡ Expression parseExpression(String expressionString, ParserContext context) throws ParseException;&#125; è¿™ä¸¤ä¸ªæ–¹æ³•çš„ç›®çš„éƒ½æ˜¯ç”Ÿæˆ Expressionã€‚ Expressionå®ƒé»˜è®¤çš„å®žçŽ°æ˜¯ SpELExpressionï¼Œä¸»è¦å¯¹å¤–æä¾›çš„æŽ¥å£å°±æ˜¯æ ¹æ®è¡¨è¾¾å¼èŽ·å¾—è¡¨è¾¾å¼å“åº”çš„ç»“æžœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ è€Œå®ƒçš„è¿™äº›æ–¹æ³•ä¸­ï¼Œæœ€é‡çš„ä¸€ä¸ªå‚æ•°å°±æ˜¯ EvaluationContextã€‚ EvaluationContextè¡¨ç¤ºè§£æž String è¡¨è¾¾å¼æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚å¯»æ‰¾ ROOT æ˜¯è°ï¼Œåå°„è§£æžçš„ Methodã€Fieldã€Constructor çš„è§£æžå™¨å’Œå–å€¼æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ã€‚çœ‹ä¸€ä¸‹å…¶æŽ¥å£æä¾›çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ SpEL çš„åŸºæœ¬ç”¨æ³•123456789//ExpressionParseræ˜¯æ“ä½œSpELçš„æ€»å…¥å£ï¼Œåˆ›å»ºä¸€ä¸ªæŽ¥å£ExpressionParserå¯¹åº”çš„å®žä¾‹SpelExpressionParserExpressionParser parser = new SpelExpressionParser();//é€šè¿‡ä¸Šé¢çš„parser.parseExpressionæ–¹æ³•èŽ·å¾—ä¸€ä¸ªExpressionçš„å®žä¾‹ï¼Œé‡Œé¢å®žçŽ°çš„å°±æ˜¯newä¸€ä¸ªSpelExpressionå¯¹è±¡ï¼›è€ŒparseExpressionçš„å‚æ•°å°±æ˜¯SpELçš„ä½¿ç”¨é‡ç‚¹ï¼Œå„ç§è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²//1.ç®€å•çš„stringç±»åž‹ç”¨'' å¼•ç”¨Expression exp = parser.parseExpression("'Hello World'");//2.SpELæ”¯æŒå¾ˆå¤šåŠŸèƒ½ç‰¹æ€§ï¼Œå¦‚è°ƒç”¨æ–¹æ³•ã€è®¿é—®å±žæ€§ã€è°ƒç”¨æž„é€ å‡½æ•°ï¼Œå¯ä»¥ç›´æŽ¥è°ƒç”¨Stringå¯¹è±¡é‡Œé¢çš„concatæ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æŽ¥Expression exp = parser.parseExpression("'Hello World'.concat('!')");//é€šè¿‡getValueæ–¹æ³•å¯ä»¥å¾—åˆ°ç»è¿‡Expresionè®¡ç®—parseExpressionæ–¹æ³•çš„å­—ç¬¦ä¸²å‚æ•°(ç¬¦åˆSpELè¯­æ³•çš„è¡¨è¾¾å¼)çš„ç»“æžœString message = (String) exp.getValue(); è€Œè®¿é—®å±žæ€§å€¼å¦‚ä¸‹æ‰€ç¤ºã€‚ 123//3.invokes getBytes()æ–¹æ³•Expression exp = parser.parseExpression("'Hello World'.bytes");byte[] bytes = (byte[]) exp.getValue(); //å¾—åˆ° byte[]ç±»åž‹çš„ç»“æžœ SpEL å­—ç¬¦ä¸²è¡¨è¾¾å¼è¿˜æ”¯æŒä½¿ç”¨â€œ.â€è¿›è¡ŒåµŒå¥—å±žæ€§ prop1.prop2.prop3 è®¿é—®ï¼Œä»£ç å¦‚ä¸‹ã€‚ 123// invokes getBytes().lengthExpression exp = parser.parseExpression(&quot;&apos;Hello World&apos;.bytes.length&quot;);int length = (Integer) exp.getValue(); è®¿é—®æž„é€ æ–¹æ³•ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²çš„æž„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 12Expression exp = parser.parseExpression("new String('hello world').toUpperCase()");String message = exp.getValue(String.class); ä¹Ÿå¯ä»¥é€šè¿‡ EvaluationContext æ¥é…ç½®ä¸€äº›æ ¹å…ƒç´ ï¼Œä»£ç å¦‚ä¸‹ã€‚ 1234567891011//é€šè¿‡ä¸€ä¸ªExpressionè¡¨è¾¾å¼æƒ³å–nameå±žæ€§å¯¹åº”çš„å€¼ExpressionParser parser = new SpelExpressionParser();Expression exp = parser.parseExpression("name");//é€šè¿‡EvaluationContextè®¾ç½®rootObjectç­‰äºŽnewçš„UserInfoå¯¹è±¡UserInfo rootUserInfo = UserInfo.builder().name("jack").build();EvaluationContext context = new StandardEvaluationContext(rootUserInfo);//getValueæ ¹æ®è®¾ç½®çš„contextå–å€¼ï¼Œå¯ä»¥å¾—åˆ°jackå­—ç¬¦ä¸²String name = (String) exp.getValue(context);//ä¹Ÿå¯ä»¥åˆ©ç”¨SpELçš„è¡¨è¾¾å¼è¿›è¡Œè¿ç®—ï¼Œåˆ¤æ–­åå­—æ˜¯å¦ç­‰äºŽå­—ç¬¦ä¸²NikolaExpression exp2 = parser.parseExpression("name == 'Nikola'");boolean result2 = exp2.getValue(context, Boolean.class); // æ ¹æ®UserInfoçš„rootObjectå¾—åˆ°false SpelExpressionParser çš„æž„é€ æ–¹æ³•è¿˜æ”¯æŒä¸€äº›é…ç½®ï¼Œä¾‹å¦‚ç»å¸¸é‡åˆ°ç©ºæŒ‡é’ˆå¼‚å¸¸å’Œä¸‹æ ‡è¶Šç•Œçš„é—®é¢˜ï¼Œå°±å¯ä»¥é€šè¿‡ SpelParserConfiguration é…ç½®ï¼šå½“ Null çš„æ—¶å€™è‡ªåŠ¨åˆå§‹åŒ–ï¼Œå½“ Collection è¶Šç•Œçš„æ—¶å€™è‡ªåŠ¨æ‰©å®¹å¢žåŠ ã€‚ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213//æž„é€ ä¸€ä¸ªClassï¼Œæ–¹ä¾¿æµ‹è¯•class MyUser &#123; public List&lt;String&gt; address;&#125;//å¼€å¯è‡ªåŠ¨åˆå§‹åŒ–nullå’Œè‡ªåŠ¨æ‰©å®¹collectionSpelParserConfiguration config = new SpelParserConfiguration(true,true);//åˆ©ç”¨configç”ŸæˆExpressionParserçš„å®žä¾‹ExpressionParser parser = new SpelExpressionParser(config);//é€šè¿‡è¡¨è¾¾å¼å–è¿™ä¸ªç”¨æˆ·çš„ç¬¬ä¸‰ä¸ªåœ°å€Expression expression = parser.parseExpression("address[3]");MyUser demo = new MyUser(); //newä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯æ²¡æœ‰åˆå§‹åŒ–MyUseré‡Œé¢çš„addressï¼Œç”±äºŽé…ç½®äº†è‡ªåŠ¨åˆå§‹åŒ–å’Œæ‰©å®¹ï¼Œæ‰€ä»¥é€šè¿‡ä¸‹é¢çš„è®¡ç®—ï¼Œæ²¡æœ‰å¾—åˆ°å¼‚å¸¸ï¼Œoå¯ä»¥å¾—åˆ°ä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²Object o = expression.getValue(demo);// ç©ºå­—ç¬¦ä¸² SpEL åœ¨ Spring ä¸­å¸¸è§çš„ä½¿ç”¨åœºæ™¯SpEL åœ¨ @Value é‡Œé¢çš„ç”¨æ³•æœ€å¸¸è§ @Value çš„åº”ç”¨åœºæ™¯æ–°å»ºä¸€ä¸ª DemoProperties å¯¹è±¡ï¼Œç”¨ Spring è£…è½½ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸¤ä¸ªè¯­æ³•ç‚¹ï¼šè¿ç®—ç¬¦å’Œ Mapã€Listã€‚ ç¬¬ä¸€ä¸ªè¯­æ³•ï¼šé€šè¿‡ @Value å±•ç¤º SpEL é‡Œé¢æ”¯æŒçš„å„ç§è¿ç®—ç¬¦çš„å†™æ³•ã€‚å¦‚ä¸‹é¢çš„è¡¨æ ¼æ‰€ç¤ºã€‚ ç±»åž‹ æ“ä½œç¬¦ é€»è¾‘è¿ç®— +, -, *, /, %, ^, div, mod é€»è¾‘æ¯”è¾ƒç¬¦å· &lt;, &gt;, ==, !=, &lt;=, &gt;=, lt, gt, eq, ne, le, ge é€»è¾‘å…³ç³» and, or, not, &amp;&amp;, ||, ! ä¸‰å…ƒè¡¨è¾¾å¼ ?: æ­£åˆ™è¡¨è¾¾å¼ matches å±•ç¤ºä¸€ä¸‹ SpEL é‡Œé¢æ”¯æŒçš„å„ç§è¿ç®—ç¬¦ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106@Data@ToString@Component //é€šè¿‡@Valueä½¿ç”¨SpELçš„åœ°æ–¹ï¼Œä¸€å®šè¦å°†æ­¤å¯¹è±¡äº¤ç”±Springè¿›è¡Œç®¡ç†public class DemoProperties &#123; // ç¬¬ä¸€éƒ¨åˆ†ï¼šé€»è¾‘è¿ç®—æ“ä½œ @Value("#&#123;19 + 1&#125;") // 20 private double add; @Value("#&#123;'String1 ' + 'string2'&#125;") // "String1 string2" private String addString; @Value("#&#123;20 - 1&#125;") // 19 private double subtract; @Value("#&#123;10 * 2&#125;") // 20 private double multiply; @Value("#&#123;36 / 2&#125;") // 19 private double divide; @Value("#&#123;36 div 2&#125;") // 18, the same as for / operator private double divideAlphabetic; @Value("#&#123;37 % 10&#125;") // 7 private double modulo; @Value("#&#123;37 mod 10&#125;") // 7, the same as for % operator private double moduloAlphabetic; // ç¬¬äºŒéƒ¨åˆ†ï¼šé€»è¾‘æ¯”è¾ƒç¬¦å· @Value("#&#123;1 == 1&#125;") // true private boolean equal; @Value("#&#123;1 eq 1&#125;") // true private boolean equalAlphabetic; @Value("#&#123;1 != 1&#125;") // false private boolean notEqual; @Value("#&#123;1 ne 1&#125;") // false private boolean notEqualAlphabetic; @Value("#&#123;1 &lt; 1&#125;") // false private boolean lessThan; @Value("#&#123;1 lt 1&#125;") // false private boolean lessThanAlphabetic; @Value("#&#123;1 &lt;= 1&#125;") // true private boolean lessThanOrEqual; @Value("#&#123;1 le 1&#125;") // true private boolean lessThanOrEqualAlphabetic; @Value("#&#123;1 &gt; 1&#125;") // false private boolean greaterThan; @Value("#&#123;1 gt 1&#125;") // false private boolean greaterThanAlphabetic; @Value("#&#123;1 &gt;= 1&#125;") // true private boolean greaterThanOrEqual; @Value("#&#123;1 ge 1&#125;") // true private boolean greaterThanOrEqualAlphabetic; // ç¬¬ä¸‰éƒ¨åˆ†ï¼šé€»è¾‘å…³ç³»è¿ç®—ç¬¦ @Value("#&#123;250 &gt; 200 &amp;&amp; 200 &lt; 4000&#125;") // true private boolean and; @Value("#&#123;250 &gt; 200 and 200 &lt; 4000&#125;") // true private boolean andAlphabetic; @Value("#&#123;400 &gt; 300 || 150 &lt; 100&#125;") // true private boolean or; @Value("#&#123;400 &gt; 300 or 150 &lt; 100&#125;") // true private boolean orAlphabetic; @Value("#&#123;!true&#125;") // false private boolean not; @Value("#&#123;not true&#125;") // false private boolean notAlphabetic; // ç¬¬å››éƒ¨åˆ†ï¼šä¸‰å…ƒè¡¨è¾¾å¼ &amp; Elvisè¿ç®—ç¬¦ @Value("#&#123;2 &gt; 1 ? 'a' : 'b'&#125;") // "b" private String ternary; //demoProperties å°±æ˜¯é€šè¿‡springåŠ è½½çš„å½“å‰å¯¹è±¡ï¼Œ //å–springå®¹å™¨é‡Œé¢çš„æŸä¸ªbeançš„å±žæ€§ï¼Œ //è¿™é‡Œå–çš„æ˜¯demoPropertieså¯¹è±¡é‡Œé¢çš„somePropertyå±žæ€§ï¼Œ //å¦‚æžœä¸ä¸ºnullå°±ç›´æŽ¥ç”¨ï¼Œå¦‚æžœä¸ºnullè¿”å›ž'default'å­—ç¬¦ä¸² @Value("#&#123;demoProperties.someProperty != null ? demoProperties.someProperty : 'default'&#125;") private String ternaryProperty; /** * Elvisè¿ç®—ç¬¦æ˜¯ä¸‰å…ƒè¡¨è¾¾å¼ç®€å†™çš„æ–¹å¼ï¼Œå’Œä¸Šé¢ä¸€æ ·çš„ç»“æžœã€‚å¦‚æžœsomePropertyä¸ºnullåˆ™è¿”å›ždefaultå€¼ã€‚ */ @Value("#&#123;demoProperties.someProperty ?: 'default'&#125;") private String elvis; /** * å–ç³»ç»ŸçŽ¯å¢ƒçš„å±žæ€§ï¼Œå¦‚æžœç³»ç»Ÿå±žæ€§pop3.portå·²å®šä¹‰ä¼šç›´æŽ¥æ³¨å…¥ï¼Œå¦‚æžœæœªå®šä¹‰ï¼Œåˆ™è¿”å›žé»˜è®¤å€¼25ã€‚systemPropertiesæ˜¯springå®¹å™¨é‡Œé¢çš„systemPropertieså®žä½“ï¼› */ @Value("#&#123;systemProperties['pop3.port'] ?: 25&#125;") private Integer port; /** * è¿˜å¯ä»¥ç”¨äºŽå®‰å…¨å¼•ç”¨è¿ç®—ç¬¦ä¸»è¦ä¸ºäº†é¿å…ç©ºæŒ‡é’ˆï¼ŒæºäºŽGroovyè¯­è¨€ã€‚ * å¾ˆå¤šæ—¶å€™ä½ å¼•ç”¨ä¸€ä¸ªå¯¹è±¡çš„æ–¹æ³•æˆ–è€…å±žæ€§æ—¶éƒ½éœ€è¦åšéžç©ºæ ¡éªŒã€‚ * ä¸ºäº†é¿å…æ­¤ç±»é—®é¢˜ï¼Œä½¿ç”¨å®‰å…¨å¼•ç”¨è¿ç®—ç¬¦åªä¼šè¿”å›žnullè€Œä¸æ˜¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ */ //@Value("#&#123;demoPropertiesx?:someProperty&#125;") // å¦‚æžœdemoPropertiesxä¸ä¸ºnullï¼Œåˆ™è¿”å›žsomePropertyå€¼ private String someProperty; // ç¬¬äº”éƒ¨åˆ†ï¼šæ­£åˆ™è¡¨è¾¾å¼çš„æ”¯æŒ @Value("#&#123;'100' matches '\\d+' &#125;") // true private boolean validNumericStringResult; @Value("#&#123;'100fghdjf' matches '\\d+' &#125;") // false private boolean invalidNumericStringResult; // åˆ©ç”¨matchesåŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿”å›žtrue @Value("#&#123;'valid alphabetic string' matches '[a-zA-Z\\s]+' &#125;") private boolean validAlphabeticStringResult; @Value("#&#123;'invalid alphabetic string #$1' matches '[a-zA-Z\\s]+' &#125;") // false private boolean invalidAlphabeticStringResult; //å¦‚æžœsomeValueåªæœ‰æ•°å­— @Value("#&#123;demoProperties.someValue matches '\\d+'&#125;") // true private boolean validNumericValue; //æ–°å¢žä¸€ä¸ªç©ºçš„someValueå±žæ€§æ–¹ä¾¿æµ‹è¯• private String someValue="";&#125; å¯ä»¥é€šè¿‡ @Value æµ‹è¯•å„ç§ SpEL çš„è¡¨è¾¾å¼ï¼Œè¿™å’Œæ”¾åœ¨ parser.parseExpression(&quot;SpEL çš„è¡¨è¾¾å¼å­—ç¬¦ä¸²&quot;); é‡Œé¢çš„æ•ˆæžœæ˜¯ä¸€æ ·çš„ã€‚ æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819@ExtendWith(SpringExtension.class)@Import(TestConfiguration.class)@ComponentScan(value = "com.example.jpa.demo.config.DemoProperties")public class DemoPropertiesTest &#123; @Autowired(required = false) private DemoProperties demoProperties; @Test public void testSpel() &#123; //æµ‹è¯•@Valueé‡Œé¢ä¸åŒè¡¨è¾¾å¼çš„å€¼äº† System.out.println(demoProperties.toString()); &#125; @TestConfiguration static class TestConfig &#123; @Bean public DemoProperties demoProperties () &#123; return new DemoProperties(); &#125; &#125;&#125; æˆ–è€…å¯ä»¥å¯åŠ¨é¡¹ç›®ï¼Œä¹Ÿèƒ½çœ‹åˆ°ç»“æžœã€‚ @Value çš„è§£æžåŽŸç†Spring é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ä¼šæ ¹æ® @Value çš„æ³¨è§£ï¼ŒåŽ»åŠ è½½ SpelExpressionResolver åŠç®—å‡ºæ¥éœ€è¦çš„ StandardEvaluationContextï¼Œç„¶åŽå†è°ƒç”¨ Expression æ–¹æ³•è¿›è¡Œ getValue æ“ä½œï¼Œå…¶ä¸­è®¡ç®— StandardEvaluationContext çš„å…³é”®æºç å¦‚ä¸‹é¢ä¸¤å¼ å›¾æ‰€ç¤ºã€‚ ç¬¬äºŒä¸ªè¯­æ³•ï¼š@Value å±•ç¤ºäº† SpEL å¯ä»¥ç›´æŽ¥è¯»å– Map å’Œ List é‡Œé¢çš„å€¼ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415161718192021222324252627282930//é€šè¿‡@ComponentåŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç»™å…¶ä¸­çš„Listå’ŒMapé™„ä¸Šå€¼@Component("workersHolder")public class WorkersHolder &#123; private List&lt;String&gt; workers = new LinkedList&lt;&gt;(); private Map&lt;String, Integer&gt; salaryByWorkers = new HashMap&lt;&gt;(); public WorkersHolder() &#123; workers.add("John"); workers.add("Susie"); workers.add("Alex"); workers.add("George"); salaryByWorkers.put("John", 35000); salaryByWorkers.put("Susie", 47000); salaryByWorkers.put("Alex", 12000); salaryByWorkers.put("George", 14000); &#125; //Getters and setters ...&#125;//SpELç›´æŽ¥è¯»å–Mapå’ŒListé‡Œé¢çš„å€¼@Value("#&#123;workersHolder.salaryByWorkers['John']&#125;") // 35000private Integer johnSalary;@Value("#&#123;workersHolder.salaryByWorkers['George']&#125;") // 14000private Integer georgeSalary;@Value("#&#123;workersHolder.salaryByWorkers['Susie']&#125;") // 47000private Integer susieSalary;@Value("#&#123;workersHolder.workers[0]&#125;") // Johnprivate String firstWorker;@Value("#&#123;workersHolder.workers[3]&#125;") // Georgeprivate String lastWorker;@Value("#&#123;workersHolder.workers.size()&#125;") // 4private Integer numberOfWorkers; @Value ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ # ä¸Ž $ çš„åŒºåˆ«SpEL è¡¨è¾¾å¼é»˜è®¤ä»¥ # å¼€å§‹ï¼Œä»¥å¤§æ‹¬å·è¿›è¡ŒåŒ…ä½ï¼Œå¦‚ #{expression}ã€‚é»˜è®¤è§„åˆ™åœ¨ ParserContext é‡Œé¢è®¾ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æ˜¯ä¸€èˆ¬å»ºè®®ä¸è¦åŠ¨ã€‚ è¿™é‡Œæ³¨æ„è¦ä¸Ž Spring ä¸­çš„ Properties è¿›è¡ŒåŒºåˆ«ï¼ŒProperties ç›¸å…³çš„è¡¨è¾¾å¼æ˜¯ä»¥ $ å¼€å§‹çš„å¤§æ‹¬å·è¿›è¡ŒåŒ…ä½çš„ï¼Œå¦‚ ${property.name}ã€‚ ä¹Ÿå°±æ˜¯è¯´ @Value çš„å€¼æœ‰ä¸¤ç±»ï¼š ${ property**:**default_value } #{ obj.property**? :**default_value } ç¬¬ä¸€ä¸ªæ³¨å…¥çš„æ˜¯å¤–éƒ¨å‚æ•°å¯¹åº”çš„ Propertyï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯ SpEL è¡¨è¾¾å¼å¯¹åº”çš„å†…å®¹ã€‚ è€Œ Property placeholders ä¸èƒ½åŒ…å« SpEL è¡¨è¾¾å¼ï¼Œä½†æ˜¯ SpEL è¡¨è¾¾å¼å¯ä»¥åŒ…å« Property çš„å¼•ç”¨ã€‚å¦‚ #{${someProperty} + 2}ï¼Œå¦‚æžœ someProperty=1ï¼Œé‚£ä¹ˆæ•ˆæžœå°†æ˜¯ #{ 1 + 2}ï¼Œæœ€ç»ˆçš„ç»“æžœå°†æ˜¯ 3ã€‚ JPA ä¸­ @Query çš„åº”ç”¨åœºæ™¯SpEL é™¤äº†èƒ½åœ¨ @Value é‡Œé¢ä½¿ç”¨å¤–ï¼Œä¹Ÿèƒ½åœ¨ @Query é‡Œä½¿ç”¨ï¼Œè€Œåœ¨ @Query é‡Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹ï¼Œå°±æ˜¯å®ƒå¯ä»¥ç”¨æ¥å–æ–¹æ³•çš„å‚æ•°ã€‚ é€šè¿‡ SpEL å–è¢« @Query æ³¨è§£çš„æ–¹æ³•å‚æ•°åœ¨ @Query æ³¨è§£ä¸­ä½¿ç”¨ SpEL çš„ä¸»è¦ç›®çš„æ˜¯å–æ–¹æ³•çš„å‚æ•°ï¼Œä¸»è¦æœ‰ä¸‰ç§ç”¨æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789//ç”¨æ³•ä¸€ï¼šæ ¹æ®ä¸‹æ ‡å–æ–¹æ³•é‡Œé¢çš„å‚æ•°@Query("select u from User u where u.age = ?#&#123;[0]&#125;") List&lt;User&gt; findUsersByAge(int age);//ç”¨æ³•äºŒï¼š#customerå–@Param("customer")é‡Œé¢çš„å‚æ•°@Query("select u from User u where u.firstname = :#&#123;#customer.firstname&#125;")List&lt;User&gt; findUsersByCustomersFirstname(@Param("customer") Customer customer);//ç”¨æ³•ä¸‰ï¼šç”¨JPAçº¦å®šçš„å˜é‡entityNameå–å¾—å½“å‰å®žä½“çš„å®žä½“åå­—@Query("from #&#123;#entityName&#125;")List&lt;UserInfo&gt; findAllByEntityName(); å…¶ä¸­ï¼Œ æ–¹æ³•ä¸€å¯ä»¥é€šè¿‡ [0] çš„æ–¹å¼ï¼Œæ ¹æ®ä¸‹æ ‡å–åˆ°æ–¹æ³•çš„å‚æ•°ï¼› æ–¹æ³•äºŒé€šè¿‡ #customer å¯ä»¥æ ¹æ® @Param æ³¨è§£çš„å‚æ•°çš„åå­—å–åˆ°å‚æ•°ï¼Œå¿…é¡»é€šè¿‡ ?#{} å’Œ :#{} æ¥è§¦å‘ SpEL çš„è¡¨è¾¾å¼è¯­æ³•ï¼› æ–¹æ³•ä¸‰é€šè¿‡ä¸‹è¿°è¯­æ³•ï¼Œå–çº¦å®šçš„å®žä½“çš„åå­—ã€‚ 1#&#123;#entityName&#125; å†æ¥çœ‹ä¸€ä¸ªæ›´å¤æ‚ä¸€ç‚¹çš„ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt; &#123; // JPAçº¦å®šçš„å˜é‡entityNameå–å¾—å½“å‰å®žä½“çš„å®žä½“åå­— @Query("from #&#123;#entityName&#125;") List&lt;UserInfo&gt; findAllByEntityName(); //ä¸€ä¸ªæŸ¥è¯¢ä¸­æ—¢å¯ä»¥æ”¯æŒSpELä¹Ÿå¯ä»¥æ”¯æŒæ™®é€šçš„:ParamNameçš„æ–¹å¼ @Modifying @Query("update #&#123;#entityName&#125; u set u.name = :name where u.id =:id") void updateUserActiveState(@Param("name") String name, @Param("id") Long id); //æ¼”ç¤ºSpELæ ¹æ®æ•°ç»„ä¸‹æ ‡å–å‚æ•°ï¼Œå’Œæ ¹æ®æ™®é€šçš„Parmaçš„åå­—:nameå–å‚æ•° @Query("select u from UserInfo u where u.lastName like %:#&#123;[0]&#125; and u.name like %:name%") List&lt;UserInfo&gt; findContainingEscaped(@Param("name") String name); //SpELå–Parmaçš„åå­—customeré‡Œé¢çš„å±žæ€§ @Query("select u from UserInfo u where u.name = :#&#123;#customer.name&#125;") List&lt;UserInfo&gt; findUsersByCustomersFirstname(@Param("customer") UserInfo customer); //åˆ©ç”¨SpELæ ¹æ®ä¸€ä¸ªå†™æ­»çš„'jack'å­—ç¬¦ä¸²ä½œä¸ºå‚æ•° @Query("select u from UserInfo u where u.name = ?#&#123;'jack'&#125;") List&lt;UserInfo&gt; findOliverBySpELExpressionWithoutArgumentsWithQuestionmark(); //åŒæ—¶SpELæ”¯æŒç‰¹æ®Šå‡½æ•°escapeå’ŒescapeCharacter @Query("select u from UserInfo u where u.lastName like %?#&#123;escape([0])&#125;% escape ?#&#123;escapeCharacter()&#125;") List&lt;UserInfo&gt; findByNameWithSpelExpression(String name); // #entityNameå’Œ#[]åŒæ—¶ä½¿ç”¨ @Query("select u from #&#123;#entityName&#125; u where u.name = ?#&#123;[0]&#125; and u.lastName = ?#&#123;[1]&#125;") List&lt;UserInfo&gt; findUsersByFirstnameForSpELExpressionWithParameterIndexOnlyWithEntityExpression(String name, String lastName); //å¯¹äºŽ native SQLåŒæ ·é€‚ç”¨ï¼Œå¹¶ä¸”åŒæ ·æ”¯æŒå–pageableåˆ†é¡µé‡Œé¢çš„å±žæ€§å€¼ @Query(value = "select * from (" // + "select u.*, rownum() as RN from (" // + "select * from user_info ORDER BY ucase(firstname)" // + ") u" // + ") where RN between ?#&#123; #pageable.offset +1 &#125; and ?#&#123;#pageable.offset + #pageable.pageSize&#125;", // countQuery = "select count(u.id) from user_info u", // nativeQuery = true) Page&lt;UserInfo&gt; findUsersInNativeQueryWithPagination(Pageable pageable);&#125; ä¸ªäººæ¯”è¾ƒæŽ¨èä½¿ç”¨ @Param çš„æ–¹å¼ï¼Œè¿™æ ·è¯­ä¹‰æ¸…æ™°ï¼Œå‚æ•°æ¢ä½ç½®äº†ä¹Ÿä¸å½±å“æ‰§è¡Œç»“æžœã€‚ å…³äºŽæºç çš„å®žçŽ°ï¼Œå¯ä»¥åˆ° ExpressionBasedStringQuery.class é‡Œé¢ç»§ç»­ç ”ç©¶ï¼Œå…³é”®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ spring-security-data åœ¨ @Query ä¸­çš„ç”¨æ³•åœ¨å®žé™…å·¥ä½œä¸­ï¼Œæœ‰æ—¶ä¼šç”¨ spring-security åšé‰´æƒï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ å½“æˆ‘ä»¬ç”¨ Spring Security çš„æ—¶å€™ï¼Œå…¶å®žå¯ä»¥é¢å¤–å¼•å…¥ jai åŒ… spring-security-dataã€‚å¦‚æžœä½¿ç”¨äº† JPA å’Œ Spring Security çš„è¯ï¼Œbuild.gradle æœ€ç»ˆä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼Œè¯·çœ‹ä»£ç ã€‚ 123456//å¼•å…¥spring data jpaimplementation &apos;org.springframework.boot:spring-boot-starter-data-jpa&apos;//é›†æˆspring securityimplementation &apos;org.springframework.boot:spring-boot-starter-security&apos;// é›†æˆspring security dataå¯¹JPAçš„æ”¯æŒimplementation &apos;org.springframework.security:spring-security-data&apos; å‡è®¾ç»§æ‰¿ Spring Security ä¹‹åŽï¼ŒSecurityContextHolder é‡Œé¢æ”¾ç½®çš„ Authentication æ˜¯ UserInfoï¼Œä»£ç å¦‚ä¸‹ã€‚ 12//åº”ç”¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤æ—¶Authenticationç±»åž‹ä¸ºUserInfoSecurityContextHolder.getContext().setAuthentication(authentication); è¿™æ · JPA é‡Œé¢çš„ @Query å°±å¯ä»¥å–åˆ°å½“å‰çš„ SecurityContext ä¿¡æ¯ï¼Œå…¶ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567// æ ¹æ®å½“å‰ç”¨æˆ·emailå–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯@Query("select u from UserInfo u where u.emailAddress = ?#&#123;principal.email&#125;")List&lt;UserInfo&gt; findCurrentUserWithCustomQuery();//å¦‚æžœå½“å‰ç”¨æˆ·æ˜¯adminï¼Œå°±è¿”å›žæŸä¸šåŠ¡çš„æ‰€æœ‰å¯¹è±¡ï¼›å¦‚æžœä¸æ˜¯adminè§’è‰²ï¼Œå°±åªç»™å½“å‰ç”¨æˆ·çš„æŸä¸šåŠ¡æ•°æ®@Query("select o from BusinessObject o where o.owner.emailAddress like "+ "?#&#123;hasRole('ROLE_ADMIN') ? '%' : principal.emailAddress&#125;")List&lt;BusinessObject&gt; findBusinessObjectsForCurrentUser(); é€šè¿‡çœ‹æºç ä¼šå‘çŽ°ï¼Œspring-security-data å°±å¸®æˆ‘ä»¬åšäº†ä¸€ä»¶äº‹æƒ…ï¼šå®žçŽ° EvaluationContextExtensionï¼Œè®¾ç½®äº† SpEL æ‰€éœ€è¦çš„ rootObject ä¸º SecurityExpressionRootã€‚å…³é”®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ç”±äºŽ SecurityExpressionRoot æ˜¯ rootObjectï¼Œæ ¹æ®ä¸Šé¢ä»‹ç»çš„ SpEL çš„åŸºæœ¬ç”¨æ³•ï¼ŒSecurityExpressionRoot é‡Œé¢çš„å„ç§å±žæ€§å’Œæ–¹æ³•éƒ½å¯ä»¥åœ¨ SpEL ä¸­ä½¿ç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ è¿™å…¶å®žä¹Ÿç»™äº†ä¸€äº›å¯å‘ï¼šå½“éœ€è¦è‡ªåŠ¨ rootObject ç»™ @Query ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œè¿™æ · @Query çš„çµæ´»æ€§ä¼šå¢žå¼ºå¾ˆå¤šã€‚ SpEL åœ¨ @Cacheable ä¸­çš„åº”ç”¨åœºæ™¯åœ¨å®žé™…å·¥ä½œä¸­è¿˜æœ‰ä¸€ä¸ªç»å¸¸ç”¨åˆ° SpEL çš„åœºæ™¯ï¼Œå°±æ˜¯åœ¨ Cache çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ Spring Cache çš„ç›¸å…³æ³¨è§£é‡Œé¢ï¼Œå¦‚ @Cacheableã€@CachePutã€@CacheEvict ç­‰ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314//ç¼“å­˜keyå–å½“å‰æ–¹æ³•åï¼Œåˆ¤æ–­ä¸€ä¸‹åªæœ‰è¿”å›žç»“æžœä¸ä¸ºnullæˆ–è€…éžemptyæ‰è¿›è¡Œç¼“å­˜@Cacheable(value = "APP", key = "#root.methodName", cacheManager = "redis.cache", unless = "#result == null || #result.isEmpty()")@Overridepublic Map&lt;String, Map&lt;String, String&gt;&gt; getAppGlobalSettings() &#123;&#125;//evictç­–ç•¥çš„keyæ˜¯å½“å‰å‚æ•°customeré‡Œé¢çš„nameå±žæ€§@Caching(evict = &#123;@CacheEvict(value="directory", key="#customer.name") &#125;)public String getAddress(Customer customer) &#123;...&#125;//åœ¨conditioné‡Œé¢ä½¿ç”¨ï¼Œå½“å‚æ•°é‡Œé¢customerçš„nameå±žæ€§çš„å€¼ç­‰äºŽå­—ç¬¦ä¸²Tomæ‰æ”¾åˆ°ç¼“å­˜é‡Œé¢@CachePut(value="addresses", condition="#customer.name=='Tom'")public String getAddress(Customer customer) &#123;...&#125;//ç”¨åœ¨unlessé‡Œé¢ï¼Œåˆ©ç”¨SpELçš„æ¡ä»¶è¡¨è¾¾å¼åˆ¤æ–­ï¼ŒæŽ’é™¤è¿”å›žçš„ç»“æžœåœ°å€é•¿åº¦å°äºŽ64çš„è¯·æ±‚@CachePut(value="addresses", unless="#result.length()&lt;64")public String getAddress(Customer customer) &#123;...&#125; Spring Cache ä¸­ SpEL æ”¯æŒçš„ä¸Šä¸‹æ–‡è¯­æ³•Spring Cache æä¾›äº†ä¸€äº›å¯ä½¿ç”¨çš„ SpEL ä¸Šä¸‹æ–‡æ•°æ®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼ˆæ‘˜è‡ª Spring å®˜æ–¹æ–‡æ¡£ï¼‰ã€‚ æ”¯æŒçš„å±žæ€§ ä½œç”¨åŸŸ åŠŸèƒ½æè¿° ä½¿ç”¨æ–¹æ³• methodName root å¯¹è±¡ å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•å #root.methodName method root å¯¹è±¡ å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³• #root.method.name target root å¯¹è±¡ å½“å‰è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡ #root.target targetClass root å¯¹è±¡ å½“å‰è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡ç±» #root.targetClass args root å¯¹è±¡ å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ #root.args[0] caches root å¯¹è±¡ å½“å‰æ–¹æ³•è°ƒç”¨ä½¿ç”¨çš„ç¼“å­˜åˆ—è¡¨ï¼ˆå¦‚@Cacheable(value={â€œcache1â€, â€œcache2â€})ï¼‰ï¼Œåˆ™æœ‰ä¸¤ä¸ª cache #root.caches[0].name argument name æ‰§è¡Œä¸Šä¸‹æ–‡ å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°ï¼Œå¦‚ findById(Long id)ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ #id æ‹¿åˆ°å‚æ•° #user.id è¡¨ç¤ºå‚æ•° user é‡Œé¢çš„ id result æ‰§è¡Œä¸Šä¸‹æ–‡ æ–¹æ³•æ‰§è¡ŒåŽçš„è¿”å›žå€¼ï¼ˆä»…å½“æ–¹æ³•æ‰§è¡Œä¹‹åŽçš„åˆ¤æ–­æœ‰æ•ˆï¼Œå¦‚â€˜unlessâ€™ï¼Œâ€™cache evictâ€™çš„ beforeInvocation=falseï¼‰ #result ä¹Ÿå¯ä»¥çœ‹ä¸€ä¸‹ Spring Cache ä¸­ SpEL çš„ EvaluationContext åŠ è½½æ–¹å¼ï¼Œå…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa å¦‚ä½•è§£å†³ N+1 SQL é—®é¢˜]]></title>
    <url>%2F2021%2F01%2F12%2FSpringDataJpa%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3N%2B1SQL%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa å¦‚ä½•è§£å†³ N+1 SQL é—®é¢˜åœ¨ JPA çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒN+1 SQL æ˜¯å¾ˆå¸¸è§çš„é—®é¢˜ ä»€ä¹ˆæ˜¯ N+1 SQL é—®é¢˜ï¼Ÿ æƒ³è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå¿…é¡»è¦çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆã€å¦‚ä½•äº§ç”Ÿçš„ï¼Œè¿™æ ·æ‰èƒ½æœ‰æ–¹æ³•ã€æœ‰é€»è¾‘åœ°åŽ»è§£å†³å®ƒã€‚ ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯ N+1 çš„ SQL é—®é¢˜ã€‚ å‡è®¾ä¸€ä¸ª UserInfo å®žä½“å¯¹è±¡å’Œ Address æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930//UserInfoå®žä½“å¯¹è±¡å¦‚ä¸‹ï¼š@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@Table@ToString(exclude = "addressList")//excludeé˜²æ­¢ toStringæ‰“å°æ—¥å¿—çš„æ—¶å€™æ­»å¾ªçŽ¯public class UserInfo extends BaseEntity &#123; private String name; private String telephone; // UserInfoå®žä½“å¯¹è±¡çš„å…³è”å…³ç³»ç”±Addresså¯¹è±¡é‡Œé¢çš„userInfoå­—æ®µç»´æŠ¤ï¼Œé»˜è®¤æ˜¯lazyåŠ è½½æ¨¡å¼ @OneToMany(mappedBy = "userInfo",fetch = FetchType.EAGER) private List&lt;Address&gt; addressList;&#125;//Addresså¯¹è±¡å¦‚ä¸‹ï¼š@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "userInfo")public class Address extends BaseEntity &#123; private String city; //ç»´æŠ¤UserInfoå’ŒAddressçš„å¤–é”®å…³ç³» @ManyToOne(fetch = FetchType.EAGER) @JsonBackReference //æ­¤æ³¨è§£é˜²æ­¢JSONæ­»å¾ªçŽ¯ private UserInfo userInfo;&#125; å…¶æ¬¡ï¼Œå‡è®¾æ•°æ®åº“é‡Œé¢æœ‰ä¸‰æ¡ UserInfo çš„æ•°æ®ï¼ŒID åˆ†åˆ«ä¸º 3ã€6ã€9ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶ä¸­ï¼Œæ¯ä¸ª UserInfo åˆ†åˆ«æœ‰ä¸¤æ¡ Address æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€å…± 6 æ¡ Address çš„æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç„¶åŽï¼Œè¯·æ±‚é€šè¿‡ UserInfoRepository æŸ¥è¯¢æ‰€æœ‰çš„ UserInfo ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 1userInfoRepository.findAll() çŽ°åœ¨ï¼ŒæŽ§åˆ¶å°å°†ä¼šå¾—åˆ°å››ä¸ª SQLï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849org.hibernate.SQL :select userinfo0_.id as id1_1_, userinfo0_.create_time as create_t2_1_, userinfo0_.create_user_id as create_u3_1_, userinfo0_.last_modified_time as last_mod4_1_, userinfo0_.last_modified_user_id as last_mod5_1_, userinfo0_.version as version6_1_, userinfo0_.ages as ages7_1_, userinfo0_.email_address as email_ad8_1_, userinfo0_.last_name as last_nam9_1_, userinfo0_.name as name10_1_, userinfo0_.telephone as telepho11_1_from user_info userinfo0_ org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_0_, addresslis0_.id as id1_0_0_, addresslis0_.id as id1_0_1_, addresslis0_.create_time as create_t2_0_1_, addresslis0_.create_user_id as create_u3_0_1_, addresslis0_.last_modified_time as last_mod4_0_1_, addresslis0_.last_modified_user_id as last_mod5_0_1_, addresslis0_.version as version6_0_1_, addresslis0_.city as city7_0_1_, addresslis0_.user_info_id as user_inf8_0_1_from address addresslis0_where addresslis0_.user_info_id = ? org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_0_, addresslis0_.id as id1_0_0_, addresslis0_.id as id1_0_1_, addresslis0_.create_time as create_t2_0_1_, addresslis0_.create_user_id as create_u3_0_1_, addresslis0_.last_modified_time as last_mod4_0_1_, addresslis0_.last_modified_user_id as last_mod5_0_1_, addresslis0_.version as version6_0_1_, addresslis0_.city as city7_0_1_, addresslis0_.user_info_id as user_inf8_0_1_from address addresslis0_where addresslis0_.user_info_id = ? org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_0_, addresslis0_.id as id1_0_0_, addresslis0_.id as id1_0_1_, addresslis0_.create_time as create_t2_0_1_, addresslis0_.create_user_id as create_u3_0_1_, addresslis0_.last_modified_time as last_mod4_0_1_, addresslis0_.last_modified_user_id as last_mod5_0_1_, addresslis0_.version as version6_0_1_, addresslis0_.city as city7_0_1_, addresslis0_.user_info_id as user_inf8_0_1_from address addresslis0_where addresslis0_.user_info_id = ? é€šè¿‡ SQL å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå½“å– UserInfo çš„æ—¶å€™ï¼Œæœ‰å¤šå°‘æ¡ UserInfo æ•°æ®å°±ä¼šè§¦å‘å¤šå°‘æ¡æŸ¥è¯¢ Address çš„ SQLã€‚ é‚£ä¹ˆæ‰€è°“çš„ N+1 çš„ SQLï¼Œæ­¤æ—¶ 1 ä»£è¡¨çš„æ˜¯ä¸€æ¡ SQL æŸ¥è¯¢ UserInfo ä¿¡æ¯ï¼›N æ¡ SQL æŸ¥è¯¢ Address çš„ä¿¡æ¯ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœæœ‰ 100 æ¡ UserInfo ä¿¡æ¯ï¼Œå¯èƒ½ä¼šè§¦å‘ 100 æ¡æŸ¥è¯¢ Address çš„ SQLï¼Œæ€§èƒ½å¤šå·®å‘€ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ EAGER æ¨¡å¼ï¼Œå½“ä½¿ç”¨ LAZY çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œåªæ˜¯ç”Ÿæˆ N æ¡ SQL çš„æ—¶æœºæ˜¯ä¸ä¸€æ ·çš„ã€‚ ä¸Šé¢æ¼”ç¤ºäº† @OneToMany çš„æƒ…å†µï¼Œé‚£ä¹ˆå†çœ‹ä¸€ä¸‹ @ManyToOne çš„æƒ…å†µã€‚åˆ©ç”¨ AddressRepository æŸ¥è¯¢æ‰€æœ‰çš„ Address ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 1addressRepository.findAll(); æŽ§åˆ¶å°ä¼šäº§ç”Ÿå¦‚ä¸‹ SQLï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485org.hibernate.SQL :select address0_.id as id1_0_, address0_.create_time as create_t2_0_, address0_.create_user_id as create_u3_0_, address0_.last_modified_time as last_mod4_0_, address0_.last_modified_user_id as last_mod5_0_, address0_.version as version6_0_, address0_.city as city7_0_, address0_.user_info_id as user_inf8_0_from address address0_ org.hibernate.SQL :select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id = ? org.hibernate.SQL :select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id = ? org.hibernate.SQL :select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id = ? è¿™é‡Œé€šè¿‡ SQL å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå½“å– Address çš„æ—¶å€™ï¼ŒAddress é‡Œé¢æœ‰å¤šå°‘ä¸ª user_info_idï¼Œå°±ä¼šè§¦å‘å¤šå°‘æ¡æŸ¥è¯¢ UserInfo çš„ SQLã€‚ é‚£ä¹ˆæ‰€è°“çš„ N+1 çš„ SQLï¼Œæ­¤æ—¶ 1 å°±ä»£è¡¨ä¸€æ¡ SQL æŸ¥è¯¢ Address ä¿¡æ¯ï¼›N æ¡ SQL æŸ¥è¯¢ UserInfo çš„ä¿¡æ¯ã€‚åŒæ ·ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœæœ‰ 100 æ¡ Address ä¿¡æ¯ï¼Œåˆ†åˆ«æœ‰ä¸åŒçš„ user_info_id å¯èƒ½ä¼šè§¦å‘ 100 æ¡æŸ¥è¯¢ UserInfo çš„ SQLï¼Œæ€§èƒ½ä¾ç„¶å¾ˆå·®ã€‚ è¿™åªæ˜¯æ¼”ç¤ºäº† @OneToMany å’Œ @ManyToOne çš„æƒ…å†µï¼Œ@ManyToMany å’Œ @OneToOne ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œéƒ½æ˜¯å½“æˆ‘ä»¬æŸ¥è¯¢ä¸»ä½“ä¿¡æ¯æ—¶å€™ï¼Œ1 æ¡ SQL ä¼šè¡ç”Ÿå‡ºæ¥å…³è”å…³ç³»çš„ N æ¡ SQLã€‚ çŽ°åœ¨è®¤è¯†äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸‹ä¸€æ­¥è¯¥æ€è€ƒï¼Œæ€Žä¹ˆè§£å†³æ‰æ›´åˆç†å‘¢ï¼Ÿæœ‰æ²¡æœ‰ä»€ä¹ˆåŠžæ³•å¯ä»¥å‡å°‘ SQL æ¡æ•°å‘¢ï¼Ÿ å‡å°‘ N+1 SQL çš„æ¡æ•°æœ€å®¹æ˜“æƒ³åˆ°ï¼Œå°±æ˜¯æœ‰æ²¡æœ‰ä»€ä¹ˆæœºåˆ¶å¯ä»¥å‡å°‘ N å¯¹åº”çš„ SQL æ¡æ•°å‘¢ï¼Ÿä»ŽåŽŸç†åˆ†æžä¼šçŸ¥é“ï¼Œä¸ç®¡æ˜¯ LAZY è¿˜æ˜¯ EAGER éƒ½æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªåªæ˜¯å†³å®šäº† N æ¡ SQL çš„è§¦å‘æ—¶æœºï¼Œè€Œä¸èƒ½å‡å°‘ SQL çš„æ¡æ•°ã€‚ hibernate.default_batch_fetch_size é…ç½®hibernate.default_batch_fetch_size é…ç½®åœ¨ AvailableSettings.class é‡Œé¢ï¼ŒæŒ‡çš„æ˜¯æ‰¹é‡èŽ·å–æ•°æ®çš„å¤§å°ï¼Œé»˜è®¤æ˜¯ -1ï¼Œè¡¨ç¤ºé»˜è®¤æ²¡æœ‰åŒ¹é…å–æ•°æ®ã€‚é‚£ä¹ˆæŠŠè¿™ä¸ªå€¼æ”¹æˆ 20 çœ‹ä¸€ä¸‹æ•ˆæžœï¼Œåªéœ€è¦åœ¨ application.properties é‡Œé¢å¢žåŠ å¦‚ä¸‹é…ç½®å³å¯ã€‚ 12# æ›´æ”¹æ‰¹é‡å–æ•°æ®çš„å¤§å°ä¸º20spring.jpa.properties.hibernate.default_batch_fetch_size=20 åœ¨å®žä½“ç±»ä¸å‘ç”Ÿä»»ä½•æ”¹å˜çš„å‰æä¸‹ï¼Œå†æ‰§è¡Œå¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«çœ‹ä¸€ä¸‹ SQL çš„ç”Ÿæˆæƒ…å†µã€‚ 1userInfoRepository.findAll(); è¿˜æ˜¯å…ˆæŸ¥è¯¢æ‰€æœ‰çš„ UserInfo ä¿¡æ¯ï¼Œçœ‹ä¸€ä¸‹ SQL çš„æ‰§è¡Œæƒ…å†µï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122232425org.hibernate.SQL :select userinfo0_.id as id1_1_, userinfo0_.create_time as create_t2_1_, userinfo0_.create_user_id as create_u3_1_, userinfo0_.last_modified_time as last_mod4_1_, userinfo0_.last_modified_user_id as last_mod5_1_, userinfo0_.version as version6_1_, userinfo0_.ages as ages7_1_, userinfo0_.email_address as email_ad8_1_, userinfo0_.last_name as last_nam9_1_, userinfo0_.name as name10_1_, userinfo0_.telephone as telepho11_1_from user_info userinfo0_ org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_1_, addresslis0_.id as id1_0_1_, addresslis0_.id as id1_0_0_, addresslis0_.create_time as create_t2_0_0_, addresslis0_.create_user_id as create_u3_0_0_, addresslis0_.last_modified_time as last_mod4_0_0_, addresslis0_.last_modified_user_id as last_mod5_0_0_, addresslis0_.version as version6_0_0_, addresslis0_.city as city7_0_0_, addresslis0_.user_info_id as user_inf8_0_0_from address addresslis0_where addresslis0_.user_info_id in (?, ?, ?) å¯ä»¥çœ‹åˆ° SQL ç›´æŽ¥å‡å°‘åˆ°ä¸¤æ¡äº†ï¼Œå…¶ä¸­æŸ¥è¯¢ Address çš„åœ°æ–¹æŸ¥è¯¢æ¡ä»¶å˜æˆäº† in(?,?,?)ã€‚ æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æžœæœ‰ 20 æ¡ UserInfo ä¿¡æ¯ï¼Œé‚£ä¹ˆäº§ç”Ÿçš„ SQL ä¹Ÿæ˜¯ä¸¤æ¡ï¼Œæ­¤æ—¶è¦æ¯” 20+1 æ¡ SQL æ€§èƒ½é«˜å¤ªå¤šäº†ã€‚ æŽ¥ç€å†æ‰§è¡Œå¦ä¸€ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ @ManyToOne çš„æƒ…å†µï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1addressRepository.findAll() å…³äºŽæ‰§è¡Œçš„ SQL æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122232425262728293031323334352020-11-29 23:11:27.381 DEBUG 30870 --- [nio-8087-exec-5] org.hibernate.SQL : select address0_.id as id1_0_, address0_.create_time as create_t2_0_, address0_.create_user_id as create_u3_0_, address0_.last_modified_time as last_mod4_0_, address0_.last_modified_user_id as last_mod5_0_, address0_.version as version6_0_, address0_.city as city7_0_, address0_.user_info_id as user_inf8_0_from address address0_2020-11-29 23:11:27.383 DEBUG 30870 --- [nio-8087-exec-5] org.hibernate.SQL : select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id in (?, ?, ?) ä»Žä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥è¯¢æ‰€æœ‰çš„ Address ä¿¡æ¯ä¹Ÿåªäº§ç”Ÿäº† 2 æ¡ SQLï¼›è€Œå½“æˆ‘ä»¬æŸ¥è¯¢ UserInfo çš„æ—¶å€™ï¼ŒSQL æœ€åŽçš„æŸ¥è¯¢æ¡ä»¶ä¹Ÿå˜æˆäº† in (ï¼Ÿï¼Œï¼Ÿï¼Œï¼Ÿ)ï¼ŒåŒæ ·çš„é“ç†è¿™æ ·ä¹Ÿä¼šæå‡ä¸å°‘æ€§èƒ½ã€‚ è€Œ hibernate.default_batch_fetch_size çš„ç»éªŒå‚è€ƒå€¼ï¼Œå¯ä»¥è®¾ç½®æˆ 20ã€30ã€50ã€100 ç­‰ï¼Œå¤ªé«˜äº†ä¹Ÿæ²¡æœ‰æ„ä¹‰ã€‚ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œä¸€æ¬¡ï¼Œäº§ç”Ÿçš„ SQL æ•°é‡ä¸º 3-5 æ¡åŸºæœ¬ä¸Šéƒ½ç®—åˆç†æƒ…å†µï¼Œè¿™æ ·é€šè¿‡è®¾ç½® default_batch_fetch_size å°±å¯ä»¥å¾ˆå¥½åœ°é¿å…å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯ä¸‹çš„ N+1 æ¡ SQL çš„æ€§èƒ½é—®é¢˜äº†ã€‚ æ­¤æ—¶è¿˜éœ€è¦æ³¨æ„ä¸€ç‚¹å°±æ˜¯ï¼Œåœ¨å®žé™…å·¥ä½œä¸­ï¼Œä¸€å®šè¦çŸ¥é“ä¸€æ¬¡æ“ä½œä¼šäº§ç”Ÿå¤šå°‘ SQLï¼Œæœ‰æ²¡æœ‰é¢„æœŸä¹‹å¤–çš„ SQL å‚æ•°ï¼Œè¿™æ˜¯éœ€è¦å…³æ³¨çš„é‡ç‚¹ï¼Œè¿™ç§æƒ…å†µå¯ä»¥åˆ©ç”¨å¦‚ä¸‹é…ç½®æ¥å¼€å¯æ‰“å° SQLï¼Œè¯·çœ‹ä»£ç ã€‚ 12## æ˜¾ç¤ºsqlçš„æ‰§è¡Œæ—¥å¿—ï¼Œå¦‚æžœå¼€äº†è¿™ä¸ª,show_sqlå°±å¯ä»¥ä¸ç”¨äº†ï¼Œshow_sqlæ²¡æœ‰ä¸Šä¸‹æ–‡ï¼Œå¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œåˆ†ä¸æ¸…æ¥šæ˜¯è°æ‰“å°çš„ï¼Œæ‰€æœ‰æˆ‘æŽ¨èå¦‚ä¸‹é…ç½®é¡¹ï¼šlogging.level.org.hibernate.SQL=debug ä½†æ˜¯è¿™ç§é…ç½®ä¹Ÿæœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯åªèƒ½å…¨å±€é…ç½®ï¼Œæ²¡åŠžæ³•é’ˆå¯¹ä¸é€šè¿‡çš„å®žä½“ç®¡ç†å…³ç³»é…ç½®ä¸åŒçš„ Fetch Size çš„å€¼ã€‚ è€Œä¸Žä¹‹ç±»ä¼¼çš„ Hibernate é‡Œé¢ä¹Ÿæä¾›äº†ä¸€ä¸ªæ³¨è§£ @BatchSize å¯ä»¥è§£å†³æ­¤é—®é¢˜ã€‚ @BatchSize æ³¨è§£@BatchSize æ³¨è§£æ˜¯ Hibernate æä¾›çš„ç”¨æ¥è§£å†³æŸ¥è¯¢å…³è”å…³ç³»çš„æ‰¹é‡å¤„ç†å¤§å°ï¼Œé»˜è®¤æ— ï¼Œå¯ä»¥é…ç½®åœ¨å®žä½“ä¸Šï¼Œä¹Ÿå¯ä»¥é…ç½®åœ¨å…³è”å…³ç³»ä¸Šé¢ã€‚æ­¤æ³¨è§£é‡Œé¢åªæœ‰ä¸€ä¸ªå±žæ€§ sizeï¼Œç”¨æ¥æŒ‡å®šå…³è”å…³ç³» LAZY æˆ–è€…æ˜¯ EAGER ä¸€æ¬¡æ€§å–æ•°æ®çš„å¤§å°ã€‚ è¿˜æ˜¯å°†ä¸Šé¢çš„ä¾‹å­ä¸­çš„ UserInfo å®žä½“åšä¸€ä¸‹æ”¹é€ ï¼Œåœ¨é‡Œé¢å¢žåŠ ä¸¤æ¬¡ @BatchSize æ³¨è§£ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@Table@ToString(exclude = "addressList")@BatchSize(size = 2)//å®žä½“ç±»ä¸ŠåŠ @BatchSizeæ³¨è§£ï¼Œç”¨æ¥è®¾ç½®å½“è¢«å…³è”å…³ç³»çš„æ—¶å€™ä¸€æ¬¡æŸ¥è¯¢çš„å¤§å°ï¼Œè®¾ç½®æˆ2ï¼Œæ–¹ä¾¿æ¼”ç¤ºAddresså…³è”UserInfoçš„æ—¶å€™çš„æ•ˆæžœpublic class UserInfo extends BaseEntity &#123; private String name; private String telephone; @OneToMany(mappedBy = "userInfo",cascade = CascadeType.PERSIST,fetch = FetchType.EAGER) @BatchSize(size = 20)//å…³è”å…³ç³»çš„å±žæ€§ä¸ŠåŠ @BatchSizeæ³¨è§£ï¼Œç”¨æ¥è®¾ç½®å½“é€šè¿‡UserInfoåŠ è½½Addressçš„æ—¶å€™ä¸€æ¬¡å–æ•°æ®çš„å¤§å° private List&lt;Address&gt; addressList;&#125; é€šè¿‡æ”¹é€  UserInfo å®žä½“ï¼Œå¯ä»¥ç›´æŽ¥æ¼”ç¤º @BatchSize åº”ç”¨åœ¨å®žä½“ç±»å’Œå±žæ€§å­—æ®µä¸Šçš„æ•ˆæžœï¼Œæ‰€ä»¥ Address å®žä½“å¯ä»¥ä¸åšä»»ä½•æ”¹å˜ï¼Œhibernate.default_batch_fetch_size è¿˜æ”¹æˆé»˜è®¤å€¼ -1ï¼Œå†åˆ†åˆ«æ‰§è¡Œä¸€ä¸‹ä¸¤ä¸ª findAll æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ•ˆæžœã€‚ ç¬¬ä¸€ç§ï¼šæŸ¥è¯¢æ‰€æœ‰ UserInfoï¼Œä»£ç å¦‚ä¸‹é¢è¿™è¡Œæ‰€ç¤ºã€‚ 1userInfoRepository.findAll() çœ‹ä¸€ä¸‹æŽ§åˆ¶å° SQL ã€‚ 12345678910111213141516171819202122232425 org.hibernate.SQL :select userinfo0_.id as id1_1_, userinfo0_.create_time as create_t2_1_, userinfo0_.create_user_id as create_u3_1_, userinfo0_.last_modified_time as last_mod4_1_, userinfo0_.last_modified_user_id as last_mod5_1_, userinfo0_.version as version6_1_, userinfo0_.ages as ages7_1_, userinfo0_.email_address as email_ad8_1_, userinfo0_.last_name as last_nam9_1_, userinfo0_.name as name10_1_, userinfo0_.telephone as telepho11_1_from user_info userinfo0_ org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_1_, addresslis0_.id as id1_0_1_, addresslis0_.id as id1_0_0_, addresslis0_.create_time as create_t2_0_0_, addresslis0_.create_user_id as create_u3_0_0_, addresslis0_.last_modified_time as last_mod4_0_0_, addresslis0_.last_modified_user_id as last_mod5_0_0_, addresslis0_.version as version6_0_0_, addresslis0_.city as city7_0_0_, addresslis0_.user_info_id as user_inf8_0_0_from address addresslis0_where addresslis0_.user_info_id in (?, ?, ?) å’Œåˆšæ‰è®¾ç½® hibernate.default_batch_fetch_size=20 çš„æ•ˆæžœä¸€æ¨¡ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨ @BatchSize è¿™ä¸ªæ³¨è§£é’ˆå¯¹ä¸åŒçš„å…³è”å…³ç³»ï¼Œé…ç½®ä¸åŒçš„å¤§å°ï¼Œä»Žè€Œæå‡ N+1 SQL çš„æ€§èƒ½ã€‚ ç¬¬äºŒç§ï¼šæŸ¥è¯¢ä¸€ä¸‹æ‰€æœ‰ Addressï¼Œå¦‚ä¸‹é¢è¿™è¡Œä»£ç æ‰€ç¤ºã€‚ 1addressRepository.findAll(); æŽ§åˆ¶å°çš„ SQL æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960org.hibernate.SQL :select address0_.id as id1_0_, address0_.create_time as create_t2_0_, address0_.create_user_id as create_u3_0_, address0_.last_modified_time as last_mod4_0_, address0_.last_modified_user_id as last_mod5_0_, address0_.version as version6_0_, address0_.city as city7_0_, address0_.user_info_id as user_inf8_0_from address address0_ org.hibernate.SQL :select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id in (?, ?) org.hibernate.SQL :select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id = ? è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œç”±äºŽåœ¨ UserInfo çš„å®žä½“ä¸Šè®¾ç½®äº† @BatchSize(size = 2)ï¼Œè¡¨ç¤ºæ‰€æœ‰å…³è”å…³ç³»åˆ° UserInfo çš„æ—¶å€™ä¸€æ¬¡å–ä¸¤æ¡æ•°æ®ï¼Œæ‰€ä»¥å°±ä¼šå‘çŽ°è¿™æ¬¡æŸ¥è¯¢ Address åŠ è½½ UserInfo çš„æ—¶å€™ï¼Œäº§ç”Ÿäº† 3 æ¡ SQLã€‚ å…¶ä¸­é€šè¿‡å…³è”å…³ç³»æŸ¥è¯¢ UserInfo äº§ç”Ÿäº† 2 æ¡ SQLï¼Œç”±äºŽæˆ‘ä»¬ UserInfo åœ¨æ•°æ®åº“é‡Œé¢æœ‰ä¸‰æ¡æ•°æ®ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡ UserInfo çš„ SQL å— @BatchSize(size = 2) æŽ§åˆ¶ï¼Œä»Žè€Œ in (?,?) åªæ”¯æŒäº†ä¸¤ä¸ªå‚æ•°ï¼ŒåŒæ—¶ä¹Ÿäº§ç”Ÿäº†ç¬¬äºŒæ¡æŸ¥ UserInfo çš„ SQLã€‚ ä»Žä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ° @BatchSize å’Œ hibernate.default_batch_fetch_size çš„æ•ˆæžœæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯å…¨å±€é…ç½®ã€ä¸€ä¸ªæ˜¯å±€éƒ¨è®¾ç½®ï¼Œè¿™æ˜¯å¯ä»¥å‡å°‘ N+1 SQL æœ€ç›´æŽ¥ã€æœ€æ–¹ä¾¿çš„ä¸¤ç§æ–¹å¼ã€‚ æ³¨æ„äº‹é¡¹ï¼š @BatchSize çš„ä½¿ç”¨å…·æœ‰å±€é™æ€§ï¼Œä¸èƒ½ä½œç”¨äºŽ @ManyToOne å’Œ @OneToOne çš„å…³è”å…³ç³»ä¸Šï¼Œé‚£æ ·ä»£ç æ˜¯ä¸èµ·ä½œç”¨çš„ 123456public class Address extends BaseEntity &#123; private String city; @ManyToOne(cascade = CascadeType.PERSIST,fetch = FetchType.EAGER) @BatchSize(size = 30) //ç”±äºŽæ˜¯@ManyToOneçš„å…³è”å…³ç³»æ‰€æœ‰æ²¡æœ‰ä½œç”¨ private UserInfo userInfo;&#125; @BatchSize åªèƒ½ä½œç”¨åœ¨ @ManyToManyã€@OneToManyã€å®žä½“ç±»è¿™ä¸‰ä¸ªåœ°æ–¹ã€‚ æ­¤å¤–ï¼ŒHibernate ä¸­è¿˜æä¾›äº†ä¸€ç§ FetchMode çš„ç­–ç•¥ï¼ŒåŒ…å«ä¸‰ç§æ¨¡å¼ï¼Œåˆ†åˆ«ä¸º FetchMode.SELECTã€FetchMode.JOINï¼Œä»¥åŠ FetchMode.SUBSELECTã€‚ Hibernate ä¸­ @Fetch æ•°æ®çš„ç­–ç•¥Hibernate æä¾›äº†ä¸€ä¸ª @Fetch æ³¨è§£ï¼Œç”¨æ¥æ”¹å˜èŽ·å–æ•°æ®çš„ç­–ç•¥ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516// fetchæ³¨è§£åªèƒ½ç”¨åœ¨æ–¹æ³•å’Œå­—æ®µä¸Šé¢@Target(&#123;ElementType.METHOD, ElementType.FIELD&#125;)@Retention(RetentionPolicy.RUNTIME)public @interface Fetch &#123; //æ³¨è§£é‡Œé¢ï¼Œåªæœ‰ä¸€ä¸ªå±žæ€§èŽ·å–æ•°æ®çš„æ¨¡å¼ FetchMode value();&#125;//å…¶ä¸­FetchModeçš„å€¼æœ‰å¦‚ä¸‹å‡ ç§ï¼špublic enum FetchMode &#123; //é»˜è®¤æ¨¡å¼ï¼Œå°±æ˜¯ä¼šæœ‰N+1 sqlçš„é—®é¢˜ï¼› SELECT, //é€šè¿‡joinçš„æ¨¡å¼ï¼Œç”¨ä¸€ä¸ªsqlæŠŠä¸»ä½“æ•°æ®å’Œå…³è”å…³ç³»æ•°æ®ä¸€å£æ°”æŸ¥å‡ºæ¥ JOIN, //é€šè¿‡å­æŸ¥è¯¢çš„æ¨¡å¼ï¼ŒæŸ¥è¯¢å…³è”å…³ç³»çš„æ•°æ® SUBSELECT&#125; éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è¦æŠŠè¿™ä¸ªæ³¨è§£å’Œ JPA åè®®é‡Œé¢çš„ FetchType.EAGERã€FetchType.LAZY æžæ··äº†ï¼ŒJPA åè®®çš„å…³è”å…³ç³»ä¸­çš„ FetchType è§£å†³çš„æ˜¯å–å…³è”å…³ç³»æ•°æ®æ—¶æœºçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ EAGER ä»£è¡¨çš„æ˜¯ç«‹å³èŽ·å¾—å…³è”å…³ç³»çš„æ•°æ®ï¼ŒLAZY æ˜¯éœ€è¦çš„æ—¶å€™å†èŽ·å¾—å…³è”å…³ç³»çš„æ•°æ®ã€‚ è¿™å’Œ Hibernate çš„ FetchMode æ˜¯ä¸¤å›žäº‹ï¼ŒFetchMode è§£å†³çš„æ˜¯èŽ·å¾—æ•°æ®ç­–ç•¥çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒèŽ·å¾—å…³è”å…³ç³»æ•°æ®çš„ç­–ç•¥æœ‰ä¸‰ç§æ¨¡å¼ï¼šSELECTï¼ˆé»˜è®¤ï¼‰ã€JOINã€SUBSELECTã€‚ FetchMode.SELECTæ›´æ”¹ä¸€ä¸‹ UserInfo å®žä½“ï¼Œå°† @Fetch(value = FetchMode.SELECT) ä½œä¸ºèŽ·å–æ•°æ®çš„ç­–ç•¥ï¼Œä½¿ç”¨ FetchType.EAGER ä½œä¸ºèŽ·å–æ•°æ®çš„æ—¶æœºï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@Table@ToString(exclude = "addressList")public class UserInfo extends BaseEntity &#123; private String name; private String telephone; @OneToMany(mappedBy = "userInfo",cascade = CascadeType.PERSIST,fetch = FetchType.EAGER) @Fetch(value = FetchMode.SELECT) private List&lt;Address&gt; addressList;&#125; ç„¶åŽè¿˜æ˜¯æ‰§è¡Œ userInfoRepository.findAll(); è¿™ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æ‰“å°çš„ SQL æœ‰å“ªäº›ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152org.hibernate.SQL :select userinfo0_.id as id1_1_, userinfo0_.create_time as create_t2_1_, userinfo0_.create_user_id as create_u3_1_, userinfo0_.last_modified_time as last_mod4_1_, userinfo0_.last_modified_user_id as last_mod5_1_, userinfo0_.version as version6_1_, userinfo0_.ages as ages7_1_, userinfo0_.email_address as email_ad8_1_, userinfo0_.last_name as last_nam9_1_, userinfo0_.name as name10_1_, userinfo0_.telephone as telepho11_1_from user_info userinfo0_ org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_0_, addresslis0_.id as id1_0_0_, addresslis0_.id as id1_0_1_, addresslis0_.create_time as create_t2_0_1_, addresslis0_.create_user_id as create_u3_0_1_, addresslis0_.last_modified_time as last_mod4_0_1_, addresslis0_.last_modified_user_id as last_mod5_0_1_, addresslis0_.version as version6_0_1_, addresslis0_.city as city7_0_1_, addresslis0_.user_info_id as user_inf8_0_1_from address addresslis0_where addresslis0_.user_info_id = ? org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_0_, addresslis0_.id as id1_0_0_, addresslis0_.id as id1_0_1_, addresslis0_.create_time as create_t2_0_1_, addresslis0_.create_user_id as create_u3_0_1_, addresslis0_.last_modified_time as last_mod4_0_1_, addresslis0_.last_modified_user_id as last_mod5_0_1_, addresslis0_.version as version6_0_1_, addresslis0_.city as city7_0_1_, addresslis0_.user_info_id as user_inf8_0_1_from address addresslis0_where addresslis0_.user_info_id = ? org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_0_, addresslis0_.id as id1_0_0_, addresslis0_.id as id1_0_1_, addresslis0_.create_time as create_t2_0_1_, addresslis0_.create_user_id as create_u3_0_1_, addresslis0_.last_modified_time as last_mod4_0_1_, addresslis0_.last_modified_user_id as last_mod5_0_1_, addresslis0_.version as version6_0_1_, addresslis0_.city as city7_0_1_, addresslis0_.user_info_id as user_inf8_0_1_from address addresslis0_where addresslis0_.user_info_id = ? ä»Žä¸Šè¿° SQL ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¾ç„¶æ˜¯ N+1 çš„ SQL é—®é¢˜ï¼ŒFetchMode.Select æ˜¯é»˜è®¤ç­–ç•¥ï¼ŒåŠ ä¸Žä¸åŠ æ˜¯åŒæ ·çš„æ•ˆæžœï¼Œä»£è¡¨èŽ·å–å…³ç³»çš„æ—¶å€™æ–°å¼€ä¸€ä¸ª SQL è¿›è¡ŒæŸ¥è¯¢ã€‚ FetchMode.JOINFetchMode.JOIN çš„æ„æ€æ˜¯ä¸»è¡¨ä¿¡æ¯å’Œå…³è”å…³ç³»é€šè¿‡ä¸€ä¸ª SQL JOIN çš„æ–¹å¼æŸ¥å‡ºæ¥ï¼Œçœ‹ä¸€ä¸‹ä¾‹å­ã€‚ é¦–å…ˆï¼Œå°† UserInfo é‡Œé¢çš„ FetchMode æ”¹æˆ JOIN æ¨¡å¼ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚ 1234567public class UserInfo extends BaseEntity &#123; private String name; private String telephone; @OneToMany(mappedBy = "userInfo",cascade = CascadeType.PERSIST,fetch = FetchType.EAGER) @Fetch(value = FetchMode.JOIN) //å”¯ä¸€å˜åŒ–çš„åœ°æ–¹é‡‡ç”¨JOINæ¨¡å¼ private List&lt;Address&gt; addressList;&#125; ç„¶åŽï¼Œè°ƒç”¨ä¸€ä¸‹ userInfoRepository.findAll(); è¿™ä¸ªæ–¹æ³•ï¼Œå‘çŽ°ä¾ç„¶æ˜¯è¿™ä¸‰æ¡ SQLï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ è¿™æ˜¯å› ä¸º FetchMode.JOIN åªæ”¯æŒé€šè¿‡ ID æˆ–è€…è”åˆå”¯ä¸€é”®èŽ·å–æ•°æ®æ‰æœ‰æ•ˆï¼Œè¿™æ­£æ˜¯ JOIN ç­–ç•¥æ¨¡å¼çš„å±€é™æ€§æ‰€åœ¨ã€‚ é‚£ä¹ˆå†è°ƒç”¨ä¸€ä¸‹ userInfoRepository.findById(id)ï¼Œçœ‹çœ‹æŽ§åˆ¶å°çš„ SQL æ‰§è¡Œæƒ…å†µï¼Œä»£ç å¦‚ä¸‹ã€‚ 123456789101112131415161718192021222324select userinfo0_.id as id1_1_0_, userinfo0_.create_time as create_t2_1_0_, userinfo0_.create_user_id as create_u3_1_0_, userinfo0_.last_modified_time as last_mod4_1_0_, userinfo0_.last_modified_user_id as last_mod5_1_0_, userinfo0_.version as version6_1_0_, userinfo0_.ages as ages7_1_0_, userinfo0_.email_address as email_ad8_1_0_, userinfo0_.last_name as last_nam9_1_0_, userinfo0_.name as name10_1_0_, userinfo0_.telephone as telepho11_1_0_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.id as id1_0_1_, addresslis1_.id as id1_0_2_, addresslis1_.create_time as create_t2_0_2_, addresslis1_.create_user_id as create_u3_0_2_, addresslis1_.last_modified_time as last_mod4_0_2_, addresslis1_.last_modified_user_id as last_mod5_0_2_, addresslis1_.version as version6_0_2_, addresslis1_.city as city7_0_2_, addresslis1_.user_info_id as user_inf8_0_2_from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_idwhere userinfo0_.id = ? è¿™æ—¶ä¼šå‘çŽ°ï¼Œå½“æŸ¥è¯¢ UserInfo çš„æ—¶å€™ï¼Œå®ƒä¼šé€šè¿‡ left outer join æŠŠ Address çš„ä¿¡æ¯ä¹ŸæŸ¥è¯¢å‡ºæ¥ï¼Œè™½ç„¶ SQL ä¸Šä¼šæœ‰å†—ä½™ä¿¡æ¯ï¼Œä½†æ˜¯ä½ ä¼šå‘çŽ°æˆ‘ä»¬ä¹‹å‰çš„ N+1 çš„ SQL ç›´æŽ¥å˜æˆ 1 æ¡ SQL äº†ã€‚ æ­¤æ—¶ä¿®æ”¹ UserInfo é‡Œé¢çš„ @OneToManyï¼Œè¿™ä¸ª @Fetch(value = FetchMode.JOIN) åŒæ ·é€‚ç”¨äºŽ @ManyToOneï¼›ç„¶åŽå†æ”¹ä¸€ä¸‹ Address å®žä¾‹ï¼Œç”¨ @Fetch(value = FetchMode.JOIN) æŠŠ Address é‡Œé¢çš„ UserInfo å…³è”å…³ç³»æ”¹æˆ JOIN æ¨¡å¼ï¼›æŽ¥ç€ç”¨ LAZY èŽ·å–æ•°æ®çš„æ—¶æœºï¼Œä¼šå‘çŽ°å…¶å¯¹èŽ·å–æ•°æ®çš„ç­–ç•¥æ²¡æœ‰ä»»ä½•å½±å“ã€‚ è¿™é‡Œåªæ˜¯ç»™ä½ æ¼”ç¤ºèŽ·å–æ•°æ®æ—¶æœºçš„ä¸åŒæƒ…å†µï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚ 1234567891011121314@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "userInfo")public class Address extends BaseEntity &#123; private String city; @ManyToOne(cascade = CascadeType.PERSIST,fetch = FetchType.LAZY) @JsonBackReference @Fetch(value = FetchMode.JOIN) private UserInfo userInfo;&#125; åŒæ ·çš„é“ç†ï¼ŒJOIN å¯¹åˆ—è¡¨æ€§çš„æŸ¥è¯¢æ˜¯æ²¡æœ‰æ•ˆæžœçš„ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸‹ addressRepository.findById(id)ï¼Œäº§ç”Ÿçš„ SQL å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920212223org.hibernate.SQL : select address0_.id as id1_0_0_, address0_.create_time as create_t2_0_0_, address0_.create_user_id as create_u3_0_0_, address0_.last_modified_time as last_mod4_0_0_, address0_.last_modified_user_id as last_mod5_0_0_, address0_.version as version6_0_0_, address0_.city as city7_0_0_, address0_.user_info_id as user_inf8_0_0_, userinfo1_.id as id1_1_1_, userinfo1_.create_time as create_t2_1_1_, userinfo1_.create_user_id as create_u3_1_1_, userinfo1_.last_modified_time as last_mod4_1_1_, userinfo1_.last_modified_user_id as last_mod5_1_1_, userinfo1_.version as version6_1_1_, userinfo1_.ages as ages7_1_1_, userinfo1_.email_address as email_ad8_1_1_, userinfo1_.last_name as last_nam9_1_1_, userinfo1_.name as name10_1_1_, userinfo1_.telephone as telepho11_1_1_from address address0_ left outer join user_info userinfo1_ on address0_.user_info_id = userinfo1_.idwhere address0_.id = ? å‘çŽ°æ­¤æ—¶åªä¼šäº§ç”Ÿä¸€ä¸ª SQLï¼Œå³é€šè¿‡ from address left outer join user_info ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½æŸ¥å‡ºæ¥ï¼Œç„¶åŽ Hibernate å†æ ¹æ®æŸ¥è¯¢å‡ºæ¥çš„ç»“æžœç»„åˆåˆ°ä¸åŒçš„å®žä½“é‡Œé¢ã€‚ ä¹Ÿå°±æ˜¯è¯´ FetchMode.JOIN å¯¹äºŽå…³è”å…³ç³»çš„æŸ¥è¯¢ LAZY æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œå› ä¸º JOIN çš„æ¨¡å¼æ˜¯é€šè¿‡ä¸€æ¡ SQL æŸ¥å‡ºæ¥æ‰€æœ‰ä¿¡æ¯ï¼Œæ‰€ä»¥ FetchMode.JOIN ä¼šå¿½ç•¥ FetchTypeã€‚ FetchMode.SUBSELECTè¿™ç§æ¨¡å¼å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å…³è”å…³ç³»é€šè¿‡å­æŸ¥è¯¢çš„å½¢å¼æŸ¥è¯¢å‡ºæ¥ï¼Œç»“åˆä¾‹å­æ¥ç†è§£ä¸€ä¸‹ã€‚ é¦–å…ˆï¼Œå°† UserInfo é‡Œé¢çš„å…³è”å…³ç³»æ”¹æˆ @Fetch(value = FetchMode.SUBSELECT)ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚ 12345public class UserInfo extends BaseEntity &#123; @OneToMany(mappedBy = "userInfo",cascade = CascadeType.PERSIST,fetch = FetchType.LAZY) //è¿™é‡Œæµ‹è¯•ä¸€ä¸‹LAZYæƒ…å†µ @Fetch(value = FetchMode.SUBSELECT) //å”¯ä¸€å˜åŒ–ä¹‹å¤„ private List&lt;Address&gt; addressList;&#125; æŽ¥ç€ï¼Œåƒä¸Šé¢çš„åšæ³•ä¸€æ ·ï¼Œæ‰§è¡Œä¸€ä¸‹ userInfoRepository.findAll()ï¼›æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹æŽ§åˆ¶å°çš„ SQL æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920212223242526org.hibernate.SQL :select userinfo0_.id as id1_1_, userinfo0_.create_time as create_t2_1_, userinfo0_.create_user_id as create_u3_1_, userinfo0_.last_modified_time as last_mod4_1_, userinfo0_.last_modified_user_id as last_mod5_1_, userinfo0_.version as version6_1_, userinfo0_.ages as ages7_1_, userinfo0_.email_address as email_ad8_1_, userinfo0_.last_name as last_nam9_1_, userinfo0_.name as name10_1_, userinfo0_.telephone as telepho11_1_from user_info userinfo0_ org.hibernate.SQL :select addresslis0_.user_info_id as user_inf8_0_1_, addresslis0_.id as id1_0_1_, addresslis0_.id as id1_0_0_, addresslis0_.create_time as create_t2_0_0_, addresslis0_.create_user_id as create_u3_0_0_, addresslis0_.last_modified_time as last_mod4_0_0_, addresslis0_.last_modified_user_id as last_mod5_0_0_, addresslis0_.version as version6_0_0_, addresslis0_.city as city7_0_0_, addresslis0_.user_info_id as user_inf8_0_0_from address addresslis0_where addresslis0_.user_info_id in (select userinfo0_.id from user_info userinfo0_) è¿™ä¸ªæ—¶å€™ä¼šå‘çŽ°ï¼ŒæŸ¥è¯¢ Address ä¿¡æ¯æ˜¯ç›´æŽ¥é€šè¿‡ addresslis0_.user_info_id in (select userinfo0_.id from user_info userinfo0_) å­æŸ¥è¯¢çš„æ–¹å¼è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ N+1 SQL å˜æˆäº† 1+1 çš„ SQLï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼æˆ‘ä»¬é…ç½® @BatchSize çš„æ•ˆæžœã€‚ FetchMode.SUBSELECT æ”¯æŒ ID æŸ¥è¯¢å’Œå„ç§æ¡ä»¶æŸ¥è¯¢ï¼Œå”¯ä¸€çš„ç¼ºç‚¹æ˜¯åªèƒ½é…ç½®åœ¨ @OneToMany å’Œ @ManyToMany çš„å…³è”å…³ç³»ä¸Šï¼Œä¸èƒ½é…ç½®åœ¨ @ManyToOne å’Œ @OneToOne çš„å…³è”å…³ç³»ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Address é‡Œé¢å…³è” UserInfo çš„æ—¶å€™å°±æ²¡æœ‰åŠžæ³•åšå®žéªŒäº†ã€‚ æ€»ä¹‹ï¼Œ@Fetch çš„ä¸åŒæ¨¡åž‹ï¼Œéƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼š FetchMode.SELECT é»˜è®¤ï¼Œå’Œä¸é…ç½®çš„æ•ˆæžœä¸€æ ·ï¼› FetchMode.JOIN åªæ”¯æŒç±»ä¼¼ findById(id) çš„æ–¹æ³•ï¼Œåªèƒ½æ ¹æ® ID æŸ¥è¯¢æ‰æœ‰æ•ˆæžœï¼› FetchMode.SUBSELECT è™½ç„¶ä¸é™ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯åªæ”¯æŒ **ToMany çš„å…³è”å…³ç³»ã€‚ æ‰€ä»¥åœ¨ä½¿ç”¨ @Fetch çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹å®ƒçš„å±€é™æ€§ï¼Œä¸ªäººæ˜¯æ¯”è¾ƒæŽ¨è @BatchSize çš„æ–¹å¼ã€‚ é‚£ä¹ˆé™¤äº†ä¸Šé¢çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ä¹‹å‰å†™ Mybatis çš„æ€è·¯æ¥æŸ¥è¯¢å…³è”å…³ç³»ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¯¥å¦‚ä½•è½¬å˜æ€è·¯ã€‚ è½¬åŒ–è§£å†³é—®é¢˜çš„æ€è·¯è¿™æ—¶éœ€è¦åœ¨æ€æƒ³ä¸Šè¿›è¡Œè½¬å˜ï¼Œåˆ©ç”¨ JPA çš„ä¼˜åŠ¿ï¼Œæ‘’å¼ƒå®ƒçš„ç¼ºé™·ã€‚æƒ³æƒ³æ²¡æœ‰ç”¨ JPA çš„æ—¶å€™æ˜¯æ€Žä¹ˆåšçš„ï¼Ÿéš¾é“ä¸€å®šè¦ç”¨å®žä½“ä¹‹é—´çš„å…³è”å…³ç³»å—ï¼Ÿå¦‚æžœç”¨çš„æ˜¯ Mybatisï¼Œä½ åœ¨ç»™å‰ç«¯è¿”å›žå…³è”å…³ç³»æ•°æ®çš„æ—¶å€™ä¸€èˆ¬æ€Žä¹ˆå†™å‘¢ï¼Ÿ ç­”æ¡ˆè‚¯å®šæ˜¯å†™æˆ 1+1 SQL çš„å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡ä¸» SQLã€ä¸€æ¡æŸ¥å…³è”å…³ç³»çš„ SQLã€‚è¿˜ç”¨ UserInfo å’Œ Address å®žä½“æ¥æ¼”ç¤ºï¼Œä»£ç å¦‚ä¸‹ã€‚ 12345678910111213141516171819202122232425@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@Tablepublic class UserInfo extends BaseEntity &#123; private String name; private String telephone; @Transient //åœ¨UserInfoå®žä½“ä¸­ï¼Œä¸åˆ©ç”¨JPAæ¥å…³è”å®žä½“çš„å…³è”å…³ç³»äº†ï¼Œè€Œæ˜¯æŠŠå®ƒè®¾ç½®æˆ@Transisentï¼Œåªç»´æŠ¤javaå¯¹è±¡çš„å…³ç³»ï¼Œä¸ç»´æŠ¤DBä¹‹é—´çš„å…³è”å…³ç³» private List&lt;Address&gt; addressList;&#125;@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "userInfo")public class Address extends BaseEntity &#123; private String city; private String userId; @Transient //åŒæ ·Addressé‡Œé¢ä¹Ÿå¯ä»¥ä¸ç»´æŠ¤UserInfoçš„å…³è”å…³ç³» private UserInfo userInfo;&#125; å½“æŸ¥è¯¢æ‰€æœ‰ UserInfo ä¿¡æ¯çš„æ—¶å€™ï¼Œåˆæƒ³æŠŠæ¯ä¸ª UserInfo çš„ Address ä¿¡æ¯éƒ½å¸¦ä¸Šï¼Œåº”è¯¥æ€Žä¹ˆåšå‘¢ï¼Ÿè¯·çœ‹å¦‚ä¸‹ä»£ç ã€‚ 123456789101112131415161718/** * è‡ªå·±å®žçŽ°ä¸€å¥— Batch fetchçš„é€»è¾‘ */@Transactionalpublic List&lt;UserInfo&gt; getAllUserWithAddress() &#123; //å…ˆæŸ¥å‡ºæ¥æ‰€æœ‰çš„UserInfoä¿¡æ¯ List&lt;UserInfo&gt; userInfos = userInfoRepository.findAll(); //å†æŸ¥å‡ºæ¥ä¸Šé¢userInfosé‡Œé¢çš„æ‰€æœ‰userIdåˆ—è¡¨ï¼Œå†æŸ¥è¯¢å‡ºæ¥ä¸Šé¢çš„æŸ¥è¯¢ç»“æžœæ‰€å¯¹åº”çš„æ‰€æœ‰Addressä¿¡æ¯ List&lt;Address&gt; addresses = addressRepository.findByUserIdIn(userInfos.stream().map(userInfo -&gt; userInfo.getId()).collect(Collectors.toList())); //æˆ‘ä»¬è‡ªå·±å†å†™ä¸€ä¸ªè½¬åŒ–é€»è¾‘ï¼ŒæŠŠå„è‡ªuser infoçš„addressä¿¡æ¯æ”¾ç½®åˆ°å“åº”çš„UserInfoå®žä¾‹é‡Œé¢ï¼› Map&lt;Long,List&lt;Address&gt;&gt; addressMaps = addresses .stream() .collect(Collectors.groupingBy(Address::getUserId));//é‡Œé¢Mapç»“æž„æ–¹ä¾¿èŽ·å– return userInfos.stream().map(userInfo -&gt; &#123; userInfo.setAddressList(addressMaps.get(userInfo.getId())); return userInfo; &#125;).collect(Collectors.toList());&#125; ä½ ä¼šå‘çŽ°ï¼Œè¿™è¦æ¯”åŽŸæ¥çš„æ–¹å¼ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯å¦‚æžœåšæ¡†æž¶çš„è¯ï¼Œä¸Šé¢æœ‰äº›é€»è¾‘å¯ä»¥æŠ½åˆ°ä¸€ä¸ª Util ç±»é‡Œé¢åŽ»ã€‚ ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®žé™…å·¥ä½œä¸­è‚¯å®šä¸æ˜¯ findAll()ï¼Œè€Œæ˜¯ä¼šæ ¹æ®ä¸€äº›ä¸šåŠ¡é€»è¾‘æŸ¥è¯¢ä¸€ä¸ª UserInfo çš„ List ä¿¡æ¯ï¼Œç„¶åŽå†æ ¹æ®æŸ¥è¯¢å‡ºæ¥çš„ userInfo çš„ ID åˆ—è¡¨åŽ»äºŒæ¬¡æŸ¥è¯¢ Address ä¿¡æ¯ï¼Œè¿™æ ·æœ€å¤šåªéœ€è¦ 2 ä¸ª SQL å°±å¯å®Œæˆå®žé™…ä¸šåŠ¡é€»è¾‘ã€‚ é‚£ä¹ˆåå‘æ€è€ƒï¼Œé€šè¿‡ Address å¯¹è±¡æŸ¥è¯¢ UserInfo ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œå¯ä»¥å…ˆæŸ¥è¯¢å‡º Listï¼Œå†æŸ¥è¯¢å‡º Listé‡Œé¢åŒ…å«çš„æ‰€æœ‰ UserInfoId åˆ—è¡¨ï¼Œç„¶åŽå†åŽ»æŸ¥è¯¢ UserInfo ä¿¡æ¯ï¼Œé€šè¿‡ Map ç»„è£…åˆ° Address é‡Œé¢ã€‚ Tipsï¼šå®žä½“é‡Œé¢å¦‚æžœå…³è”å…³ç³»æœ‰éžå¸¸å¤šçš„è¯·æ±‚ï¼Œæƒ³ç»´æŠ¤å…³è”å…³ç³»æ˜¯ä¸€ä»¶éžå¸¸éš¾çš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Mybatis çš„æ€æƒ³ã€JPA çš„å¿«æ·æŸ¥è¯¢è¯­æ³•ï¼Œæ¥ç»„è£…æƒ³è¦çš„ä»»ä½•å…³è”å…³ç³»çš„å¯¹è±¡ã€‚è¿™æ ·çš„ä»£ç è™½ç„¶æ¯”èµ·åŽŸç”Ÿçš„ JPA è¯­æ³•è¾ƒå¤æ‚ï¼Œä½†æ˜¯æ¯”èµ· Mybatis è¿˜æ˜¯è¦ç®€å•å¾ˆå¤šï¼Œç†è§£èµ·æ¥ä¹Ÿæ›´å®¹æ˜“ï¼Œé—®é¢˜åå€’ä¼šæ›´å°‘ä¸€ç‚¹ã€‚ @EntityGraph ä½¿ç”¨è¯¦è§£JPA åè®®ä¹Ÿæä¾›äº†å¦å¤–ä¸€ç§è§£é¢˜æ€è·¯ï¼šåˆ©ç”¨ @EntityGraph æ³¨è§£æ¥è§£å†³ ä¼—æ‰€å‘¨çŸ¥ï¼Œå®žä½“ä¸Žå®žä½“ä¹‹é—´çš„å…³è”å…³ç³»é”™ç»¼å¤æ‚ï¼Œå°±åƒä¸€ä¸ªå¤§ç½‘å›¾ä¸€æ ·ï¼Œç½‘çŠ¶åˆ†å¸ƒäº¤å‰å¼•ç”¨ã€‚è€Œ JPA åè®®åœ¨ 2.1 ç‰ˆæœ¬ä¹‹åŽä¼å›¾ç”¨ Entity Graph çš„æ–¹å¼ï¼Œæç»˜å‡ºä¸€ä¸ªå®žä½“ä¸Žå®žä½“ä¹‹é—´çš„å…³è”å…³ç³»ã€‚ æ™®é€šåšæ³•ä¸ºï¼Œé€šè¿‡ @ManyToOne/@OneToMany/@ManyToMany/@OneToOne è¿™äº›å…³è”å…³ç³»æ³¨è§£è¡¨ç¤ºå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ—¶ï¼Œåªèƒ½é…ç½® EAGER æˆ–è€… LAZYï¼Œæ²¡åŠžæ³•æ ¹æ®ä¸åŒçš„é…ç½®ã€ä¸åŒçš„å…³è”å…³ç³»åŠ è½½æ—¶æœºã€‚ è€Œ JPA åè®®ä¼å›¾é€šè¿‡ @NamedEntityGraph æ³¨è§£æ¥æè¿°å®žä½“ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå½“è¢« @EntityGraph ä½¿ç”¨çš„æ—¶å€™è¿›è¡Œ EAGER åŠ è½½ï¼Œä»¥å‡å°‘ N+1 çš„ SQLï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“ç”¨æ³•ã€‚ @NamedEntityGraph å’Œ @EntityGraph ç”¨æ³•è¿˜æ˜¯ç›´æŽ¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜Žï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ã€‚ 123456789101112131415161718//å¯ä»¥è¢«@NamedEntityGraphsæ³¨è§£é‡å¤ä½¿ç”¨ï¼Œåªèƒ½é…ç½®åœ¨ç±»ä¸Šé¢ï¼Œç”¨æ¥å£°æ˜Žä¸åŒçš„EntityGraphï¼›@Repeatable(NamedEntityGraphs.class)@Target(&#123;TYPE&#125;)@Retention(RUNTIME)public @interface NamedEntityGraph &#123; //æŒ‡å®šä¸€ä¸ªåå­— String name() default ""; //å“ªäº›å…³è”å…³ç³»å±žæ€§å¯ä»¥è¢«EntityGraphåŒ…å«è¿›åŽ»ï¼Œé»˜è®¤ä¸€ä¸ªæ²¡æœ‰ã€‚å¯ä»¥é…ç½®å¤šä¸ª NamedAttributeNode[] attributeNodes() default &#123;&#125;; //æ˜¯å¦æ‰€æœ‰çš„å…³è”å…³ç³»å±žæ€§è‡ªåŠ¨åŒ…å«åœ¨å†…ï¼Œé»˜è®¤false; boolean includeAllAttributes() default false; //é…ç½®subgraphsï¼Œå­å®žä½“å›¾(å¯ä»¥ç†è§£ä¸ºå…³è”å…³ç³»å®žä½“å›¾ï¼Œå³å¦‚æžœç®—å±‚çº§ï¼Œå¯ä»¥é…ç½®ç¬¬äºŒå±‚çº§)ï¼Œå¯ä»¥è¢«NamedAttributeNodeå¼•ç”¨ NamedSubgraph[] subgraphs() default &#123;&#125;; //é…ç½®subclassSubgraphsçš„namedSubgraphæœ‰å“ªäº›ã€‚å³å¦‚æžœç®—å±‚çº§ï¼Œå¯ä»¥é…ç½®ç¬¬ä¸‰å±‚çº§ NamedSubgraph[] subclassSubgraphs() default &#123;&#125;;&#125; ä¸Šè¿°ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ° @NamedEntityGraphs èƒ½å¤Ÿé…ç½®å¤šä¸ª @NamedEntityGraphã€‚æŽ¥ç€å¾€ä¸‹çœ‹ã€‚ 123456//åªèƒ½ä½¿ç”¨åœ¨å®žä½“ç±»ä¸Šé¢@Target(&#123;TYPE&#125;)@Retention(RUNTIME)public @interface NamedEntityGraphs&#123; NamedEntityGraph[] value();//å¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªNamedEntityGraph&#125; ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼ŒNamedSubgraph ç”¨æ¥æŒ‡å®šå…³è”å…³ç³»çš„ç­–ç•¥ï¼Œä¹Ÿå°±å…³è”å…³ç³»æœ‰ä¸¤å±‚ã€‚ å†çœ‹ä¸€ä¸‹ @NamedEntityGraph é‡Œé¢çš„ NamedAttributeNode å±žæ€§æœ‰å“ªäº›å€¼ï¼Œä»£ç å¦‚ä¸‹ã€‚ 1234567891011// ç”¨æ¥è¿›è¡Œå±žæ€§èŠ‚ç‚¹çš„æè¿°@Target(&#123;&#125;)@Retention(RUNTIME)public @interface NamedAttributeNode &#123; //è¦åŒ…å«çš„å…³è”å…³ç³»çš„å±žæ€§çš„åå­—ï¼Œå¿…å¡« String value(); //å¦‚æžœæˆ‘ä»¬åœ¨@NamedEntityGraphé‡Œé¢é…ç½®äº†å­å…³è”å…³ç³»ï¼Œè¿™ä¸ªæ˜¯é…ç½®subgraphçš„åå­— String subgraph() default ""; //å½“å…³è”å…³ç³»æ˜¯è¢«Mapç»“æž„å¼•ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®škeyçš„æ–¹å¼ï¼Œä¸€èˆ¬å¾ˆå°‘ç”¨ String keySubgraph() default "";&#125; ä¸Šé¢å°±æ˜¯å¯¹ @NamedAttributeNode çš„ä»‹ç»ï¼Œå†çœ‹ä¸€ä¸‹ @EntityGraph é‡Œé¢çš„ @NamedSubgraph çš„ç»“æž„ï¼Œä»£ç å¦‚ä¸‹ã€‚ 12345678910@Target(&#123;&#125;)@Retention(RUNTIME)public @interface NamedSubgraph &#123; //æŒ‡å®šä¸€ä¸ªåå­— String name(); //å­å…³è”å…³ç³»çš„ç±»çš„class Class type() default void.class; //äºŒå±‚å…³è”å…³ç³»çš„è¦åŒ…å«çš„å…³è”å…³ç³»çš„å±žæ€§çš„åå­— NamedAttributeNode[] attributeNodes();&#125; å…¶ä¸­ï¼Œ@NamedEntityGraph çš„æ³¨è§£éƒ½æ˜¯é…ç½®åœ¨å®žä½“æœ¬èº«ä¸Šé¢çš„ï¼Œè€Œ @EntityGraph æ˜¯ç”¨åœ¨ ***Repository æŽ¥å£é‡Œçš„æ–¹æ³•ä¸­çš„ã€‚ äº†è§£ä¸€ä¸‹ @EntityGraph æ³¨è§£çš„è¯­æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122232425@Retention(RetentionPolicy.RUNTIME)@Target(&#123; ElementType.METHOD, ElementType.ANNOTATION_TYPE &#125;)//EntityGraph ä½œç”¨åœ¨Repositoryçš„æŽ¥å£é‡Œé¢çš„æ–¹æ³•ä¸Šé¢public @interface EntityGraph &#123; //æŒ‡@EntityGraphæ³¨è§£å¼•ç”¨çš„@NamedEntityGraphé‡Œé¢å®šä¹‰çš„nameï¼Œå¦‚æžœæ˜¯ç©ºEntityGraphå°±ä¸ä¼šèµ·ä½œç”¨ï¼Œå¦‚æžœä¸ºç©ºç›¸å½“äºŽæ²¡æœ‰é…ç½®ï¼› String value() default ""; //EntityGraphçš„ç±»åž‹ï¼Œé»˜è®¤æ˜¯EntityGraphType.FETCHç±»åž‹ EntityGraphType type() default EntityGraphType.FETCH; //å¯ä»¥æŒ‡å®šattributePathsç”¨æ¥è¦†ç›–@NamedEntityGraphé‡Œé¢çš„attributeNodesçš„é…ç½®ï¼Œé»˜è®¤é…ç½®æ˜¯ç©ºï¼Œä»¥@NamedEntityGraphé‡Œé¢çš„ä¸ºå‡†ï¼› String[] attributePaths() default &#123;&#125;; //JPA 2.1æ”¯æŒçš„EntityGraphTypeå¯¹åº”çš„æžšä¸¾å€¼ public enum EntityGraphType &#123; //LOADæ¨¡å¼ï¼Œå½“è¢«æŒ‡å®šäº†è¿™ç§æ¨¡å¼ã€è¢«@EntityGraphç®¡ç†çš„attributesçš„æ—¶å€™ï¼ŒåŽŸæ¥çš„FetchTypeçš„ç±»åž‹ç›´æŽ¥å¿½ç•¥å˜æˆEageræ¨¡å¼ï¼Œè€Œä¸è¢«@EntityGraphç®¡ç†çš„attributesè¿˜æ˜¯ä¿æŒé»˜è®¤çš„FetchType LOAD("javax.persistence.loadgraph"), //FETCHæ¨¡å¼ï¼Œå½“è¢«æŒ‡å®šäº†è¿™ç§æ¨¡å¼ã€è¢«@EntityGraphç®¡ç†çš„attributesçš„æ—¶å€™ï¼ŒåŽŸæ¥çš„FetchTypeçš„ç±»åž‹ç›´æŽ¥å¿½ç•¥å˜æˆEageræ¨¡å¼ï¼Œè€Œä¸è¢«@EntityGraphç®¡ç†çš„attributeså°†ä¼šå˜æˆLazyæ¨¡å¼ï¼Œå’ŒLOADçš„åŒºåˆ«å°±æ˜¯å¯¹ä¸è¢«@NamedEntityGraphé…ç½®çš„å…³è”å…³ç³»çš„å±žæ€§çš„FetchTypeä¸ä¸€æ ·ï¼› FETCH("javax.persistence.fetchgraph"); private final String key; private EntityGraphType(String value) &#123; this.key = value; &#125; public String getKey() &#123; return key; &#125; &#125;&#125; @EntityGraph ä½¿ç”¨å®žä¾‹é€šè¿‡æ”¹é€  Address å’Œ UserInfo å®žä½“ï¼Œæ¥åˆ†åˆ«æµ‹è¯•ä¸€ä¸‹ @NamedEntityGraph å’Œ @EntityGraph çš„ç”¨æ³•ã€‚ ç¬¬ä¸€æ­¥ï¼šåœ¨å®žä½“é‡Œé¢é…ç½® @EntityGraphï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "userInfo")//è¿™é‡Œç›´æŽ¥ä½¿ç”¨@NamedEntityGraphï¼Œå› ä¸ºåªéœ€è¦é…ç½®ä¸€ä¸ª@NamedEntityGraphï¼ŒæŒ‡å®šä¸€ä¸ªåå­—getAllUserInfoï¼ŒæŒ‡å®šè¢«è¿™ä¸ªåå­—çš„å®žä½“è¯•å›¾å…³è”çš„å…³è”å…³ç³»å±žæ€§æ˜¯userInfo@NamedEntityGraph(name = "getAllUserInfo",attributeNodes = @NamedAttributeNode(value = "userInfo"))public class Address extends BaseEntity &#123; private String city; @JsonBackReference //é˜²æ­¢JSONæ­»å¾ªçŽ¯ @ManyToOne(cascade = CascadeType.PERSIST,fetch = FetchType.LAZY)//é‡‡ç”¨é»˜è®¤çš„lazyæ¨¡å¼ private UserInfo userInfo;&#125;@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@Table@ToString(exclude = "addressList")//UserInfoå¯¹åº”çš„å…³è”å…³ç³»ï¼Œåˆ©ç”¨@NamedEntityGraphsé…ç½®äº†ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹Addressçš„å…³è”å…³ç³»ï¼Œä¸€ä¸ªæ˜¯nameå«roomsçš„å®žä½“å›¾åŒ…å«äº†roomså±žæ€§ï¼›åœ¨UserInfoé‡Œé¢å¢žåŠ äº†ä¸¤ä¸ªå…³è”å…³ç³»ï¼›@NamedEntityGraphs(value = &#123;@NamedEntityGraph(name = "addressGraph",attributeNodes = @NamedAttributeNode(value = "addressList")),@NamedEntityGraph(name = "rooms",attributeNodes = @NamedAttributeNode(value = "rooms"))&#125;)public class UserInfo extends BaseEntity &#123; private String name; private String telephone; private Integer ages; //é»˜è®¤LAZYæ¨¡å¼ @OneToMany(mappedBy = "userInfo",cascade = CascadeType.PERSIST,fetch = FetchType.LAZY) private List&lt;Address&gt; addressList; //é»˜è®¤EAGERæ¨¡å¼ @OneToMany(cascade = CascadeType.PERSIST,fetch = FetchType.EAGER) private List&lt;Room&gt; rooms;&#125; ç¬¬äºŒæ­¥ï¼šåœ¨æˆ‘ä»¬éœ€è¦çš„ *Repository çš„æ–¹æ³•ä¸Šé¢ç›´æŽ¥ä½¿ç”¨ @EntityGraphï¼Œå…³é”®ä»£ç å¦‚ä¸‹ã€‚ 12345678//å› ä¸ºè¦ç”¨findAll()åšæµ‹è¯•ï¼Œæ‰€ä»¥å¯ä»¥è¦†ç›–JpaRepositoryé‡Œé¢çš„findAll()æ–¹æ³•ï¼ŒåŠ ä¸Š@EntityGraphæ³¨è§£public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt;&#123; @Override //æŒ‡å®šEntityGraphå¼•ç”¨çš„æ˜¯ï¼Œåœ¨UserInfoå®žä¾‹é‡Œé¢é…ç½®çš„name=addressGraphçš„NamedEntityGraphï¼› // è¿™é‡Œé‡‡ç”¨çš„æ˜¯LOADçš„ç±»åž‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¢«addressGraphé…ç½®çš„å®žä½“å›¾å±žæ€§addressé‡‡ç”¨çš„fetchä¼šå˜æˆ FetchType.EAGERæ¨¡å¼ï¼Œè€Œæ²¡æœ‰è¢«addressGraphå®žä½“å›¾é…ç½®å…³è”å…³ç³»å±žæ€§roomè¿˜æ˜¯é‡‡ç”¨é»˜è®¤çš„EAGERæ¨¡å¼@EntityGraph(value = "addressGraph",type = EntityGraph.EntityGraphType.LOAD) List&lt;UserInfo&gt; findAll();&#125; åŒæ ·çš„é“ç†ï¼Œå…¶å¯¹äºŽ AddressRepository ä¹Ÿæ˜¯é€‚ç”¨çš„ï¼Œä»£ç å¦‚ä¸‹ã€‚ 123456public interface AddressRepository extends JpaRepository&lt;Address, Long&gt;&#123;@Override //å¯ä»¥è¦†ç›–åŽŸå§‹æ–¹æ³•ï¼Œæ·»åŠ ä¸Šä¸åŒçš„@EntityGraphç­–ç•¥//ä½¿ç”¨@EntityGraphæŸ¥è¯¢æ‰€æœ‰Addressçš„æ—¶å€™ï¼ŒæŒ‡å®šname = "getAllUserInfo"çš„@NamedEntityGraphï¼Œé‡‡ç”¨é»˜è®¤çš„EntityGraphType.FETCHï¼Œå¦‚æžœAddressé‡Œé¢æœ‰å¤šä¸ªå…³è”å…³ç³»çš„æ—¶å€™ï¼Œåªæœ‰åœ¨name = "getAllUserInfo"çš„å®žä½“å›¾é…ç½®çš„userInfoå±žæ€§ä¸Šé‡‡ç”¨Eageræ¨¡å¼ï¼Œå…¶ä»–å…³è”å…³ç³»å±žæ€§æ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤é‡‡ç”¨LAZYæ¨¡å¼ï¼›@EntityGraph(value = "getAllUserInfo")List&lt;Address&gt; findAll();&#125; ç¬¬ä¸‰æ­¥ï¼šçœ‹ä¸€ä¸‹ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•æ‰§è¡Œçš„ SQLã€‚ å†æ¬¡æ‰§è¡Œ userInfoRepository.findAll(); è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ä¼šå‘çŽ°ï¼Œè¢«é…ç½® EntityGraph çš„ Address å’Œ user_info é€šè¿‡ left join ä¸€æ¡ SQL å°±æŠŠæ‰€æœ‰çš„ä¿¡æ¯éƒ½æŸ¥å‡ºæ¥äº†ï¼ŒSQL å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456789101112131415161718192021222324org.hibernate.SQL :select userinfo0_.id as id1_2_0_, addresslis1_.id as id1_0_1_, userinfo0_.create_time as create_t2_2_0_, userinfo0_.create_user_id as create_u3_2_0_, userinfo0_.last_modified_time as last_mod4_2_0_, userinfo0_.last_modified_user_id as last_mod5_2_0_, userinfo0_.version as version6_2_0_, userinfo0_.ages as ages7_2_0_, userinfo0_.email_address as email_ad8_2_0_, userinfo0_.last_name as last_nam9_2_0_, userinfo0_.name as name10_2_0_, userinfo0_.telephone as telepho11_2_0_, addresslis1_.create_time as create_t2_0_1_, addresslis1_.create_user_id as create_u3_0_1_, addresslis1_.last_modified_time as last_mod4_0_1_, addresslis1_.last_modified_user_id as last_mod5_0_1_, addresslis1_.version as version6_0_1_, addresslis1_.city as city7_0_1_, addresslis1_.user_info_id as user_inf8_0_1_, addresslis1_.user_info_id as user_inf8_0_0__, addresslis1_.id as id1_0_0__from user_info userinfo0_ left outer join address addresslis1_ on userinfo0_.id = addresslis1_.user_info_id è€Œæ²¡æœ‰é…ç½® rooms è¿™ä¸ªå…³è”å…³ç³»çš„å±žæ€§æ—¶ï¼Œrooms çš„æŸ¥è¯¢è¿˜æ˜¯ä¼šè§¦å‘ N+1 çš„ SQLã€‚ ä»Žä¸­å¯ä»¥çœ‹åˆ° @EntityGraph çš„æ•ˆæžœæœ‰ç‚¹ç±»ä¼¼ Hibernate é‡Œé¢æä¾›çš„ FetchModel.JOIN çš„æ¨¡å¼ï¼Œä½†ä¸åŒçš„æ˜¯ @EntityGraph å¯ä»¥æ­é…ä»»ä½•çš„æŸ¥è¯¢æƒ…å†µï¼Œåªéœ€è¦åœ¨æŸ¥è¯¢æ–¹æ³•ä¸Šç›´æŽ¥åŠ  @EntityGraph æ³¨è§£å³å¯ã€‚ è¿™ç§æ–¹æ³•è¿˜æœ‰ä¸ªä¼˜åŠ¿å°±æ˜¯ @EntityGraph å’Œ @NamedEntityGraph æ˜¯ JPA åè®®è§„å®šçš„ï¼Œè¿™æ ·å¯ä»¥å¯¹ Hibernate æ— æ„Ÿã€‚ é‚£ä¹ˆå†çœ‹ä¸€ä¸‹ @ManyToOne çš„æ¨¡å¼æ˜¯å¦åŒæ ·å¥æ•ˆï¼Œè®¿é—® addressRepository.findAll() è¿™ä¸ªæ–¹æ³•çœ‹ä¸€ä¸‹ SQLï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122org.hibernate.SQL :select address0_.id as id1_0_0_, userinfo1_.id as id1_2_1_, address0_.create_time as create_t2_0_0_, address0_.create_user_id as create_u3_0_0_, address0_.last_modified_time as last_mod4_0_0_, address0_.last_modified_user_id as last_mod5_0_0_, address0_.version as version6_0_0_, address0_.city as city7_0_0_, address0_.user_info_id as user_inf8_0_0_, userinfo1_.create_time as create_t2_2_1_, userinfo1_.create_user_id as create_u3_2_1_, userinfo1_.last_modified_time as last_mod4_2_1_, userinfo1_.last_modified_user_id as last_mod5_2_1_, userinfo1_.version as version6_2_1_, userinfo1_.ages as ages7_2_1_, userinfo1_.email_address as email_ad8_2_1_, userinfo1_.last_name as last_nam9_2_1_, userinfo1_.name as name10_2_1_, userinfo1_.telephone as telepho11_2_1_from address address0_ left outer join user_info userinfo1_ on address0_.user_info_id = userinfo1_.id å¯ä»¥çœ‹åˆ° address left join çš„æ¨¡å¼ä¸­ï¼Œä¸€ä¸ª SQL æŠŠæ‰€æœ‰çš„ address å’Œ user_info éƒ½æŸ¥è¯¢å‡ºæ¥äº†ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œ@EntityGraph å¯ä»¥ç”¨åœ¨ä»»ä½• ***Repository çš„æŸ¥è¯¢æ–¹æ³•ä¸Šï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯é…ç½®ä¸åŒçš„å…³è”å…³ç³»ç­–ç•¥ï¼Œå°±å¯ä»¥å‡å°‘ N+1 çš„ SQLï¼Œæˆä¸ºä¸€æ¡ SQLã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa Lazy Exception è§£å†³æ–¹æ³•]]></title>
    <url>%2F2021%2F01%2F12%2FSpringDataJpa%E7%9A%84LazyException%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa Lazy Exception è§£å†³æ–¹æ³•ä»€ä¹ˆæ˜¯ LazyInitializationException å¼‚å¸¸é€šè¿‡ 4 ä¸ªæ­¥éª¤çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯ Lazy å¼‚å¸¸ ç¬¬ä¸€æ­¥ï¼šä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼ŒæŠŠ spring.jpa.open-in-view è®¾ç½®æˆ falseï¼Œä»£ç å¦‚ä¸‹ï¼š 1spring.jpa.open-in-view=false ç¬¬äºŒæ­¥ï¼šæ–°å»ºä¸€ä¸ªä¸€å¯¹å¤šçš„å…³è”å®žä½“ï¼šUserInfo ç”¨æˆ·ä¿¡æ¯ï¼Œä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªåœ°å€ Addressã€‚ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@Tablepublic class UserInfo extends BaseEntity &#123; private String name; private Integer ages; private String lastName; private String emailAddress; private String telephone; //å‡è®¾ä¸€ä¸ªç”¨æˆ·æœ‰å¤šä¸ªåœ°å€ï¼Œå–æ•°æ®çš„æ–¹å¼ç”¨ lazy çš„æ¨¡å¼(é»˜è®¤ä¹Ÿæ˜¯ lazy çš„)ï¼›é‡‡ç”¨ CascadeType.PERSIST æ–¹ä¾¿æ’å…¥æ¼”ç¤ºæ•°æ®ï¼› @OneToMany(mappedBy = "userInfo", cascade = CascadeType.PERSIST, fetch = FetchType.LAZY) private List&lt;Address&gt; addressList;&#125;@Entity@Table@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructorpublic class Address extends BaseEntity &#123; private String city; //ç»´æŠ¤å…³è”å…³ç³»çš„ä¸€æ–¹ï¼Œé»˜è®¤éƒ½æ˜¯ lazy æ¨¡å¼ @ManyToOne private UserInfo userInfo;&#125; ç¬¬ä¸‰æ­¥ï¼šå†æ–°å»ºä¸€ä¸ª Controllerï¼Œå–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¹¶ä¸”æŸ¥çœ‹ä¸€ä¸‹ Address çš„åœ°å€ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567@GetMapping("/user/info/&#123;id&#125;")public UserInfo getUserInfoFromPath(@PathVariable("id") Long id) &#123; UserInfo u1 = userInfoRepository.findById(id).get(); //è§¦å‘ lazy åŠ è½½ï¼Œå– userInfo é‡Œé¢çš„åœ°å€ä¿¡æ¯ System.out.println(u1.getAddressList().get(0).getCity()); return u1;&#125; ç¬¬å››æ­¥ï¼šå¯åŠ¨é¡¹ç›®ï¼Œç›´æŽ¥å‘èµ·å¦‚ä¸‹è¯·æ±‚ï¼š 12345### get user infoçš„æŽ¥å£GET /user/info/1 HTTP/1.1Host: 127.0.0.1:8087Content-Type: application/jsonCache-Control: no-cache ç„¶åŽå°±å¯ä»¥å¦‚æœŸå¾—åˆ° Lazy å¼‚å¸¸ï¼Œå¦‚ä¸‹æ‰€ç¤º: 1234567org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList, could not initialize proxy - no Session at org.hibernate.collection.internal.AbstractPersistentCollection.throwLazyInitializationException(AbstractPersistentCollection.java:606) ~[hibernate-core-5.4.20.Final.jar:5.4.20.Final] at org.hibernate.collection.internal.AbstractPersistentCollection.withTemporarySessionIfNeeded(AbstractPersistentCollection.java:218) ~[hibernate-core-5.4.20.Final.jar:5.4.20.Final] at org.hibernate.collection.internal.AbstractPersistentCollection.initialize(AbstractPersistentCollection.java:585) ~[hibernate-core-5.4.20.Final.jar:5.4.20.Final] at org.hibernate.collection.internal.AbstractPersistentCollection.read(AbstractPersistentCollection.java:149) ~[hibernate-core-5.4.20.Final.jar:5.4.20.Final] at org.hibernate.collection.internal.PersistentBag.get(PersistentBag.java:561) ~[hibernate-core-5.4.20.Final.jar:5.4.20.Final] at com.example.jpa.demo.web.UserInfoController.getUserInfoFromPath(UserInfoController.java:29) ~[main/:na] é€šè¿‡ä¸Šé¢çš„å¼‚å¸¸ä¿¡æ¯åŸºæœ¬å¯ä»¥çœ‹åˆ°ï¼Œ UserInfo å®žä½“å¯¹è±¡åŠ è½½ Address çš„æ—¶å€™ï¼Œäº§ç”Ÿäº† Lazy å¼‚å¸¸ï¼Œæ˜¯å› ä¸º no sessionã€‚é‚£ä¹ˆå‘ç”Ÿå¼‚å¸¸çš„æ ¹æœ¬åŽŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒçš„åŠ è½½åŽŸç†æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ Lazy åŠ è½½æœºåˆ¶çš„åŽŸç†åˆ†æžJPA é‡Œæœ‰ Lazy çš„æœºåˆ¶ï¼Œæ‰€è°“çš„ Lazy å°±æ˜¯æŒ‡ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å…³è”å…³ç³»çš„æ—¶å€™ï¼Œåªæœ‰ç”¨åˆ°è¢«å…³è”å…³ç³»çš„ä¸€æ–¹æ‰ä¼šè¯·æ±‚æ•°æ®åº“åŽ»åŠ è½½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å…³è”å…³ç³»çš„çœŸå®žæ•°æ®ä¸æ˜¯ç«‹é©¬åŠ è½½çš„ï¼Œåªæœ‰ç”¨åˆ°çš„æ—¶å€™æ‰ä¼šåŠ è½½ã€‚ è€Œ Hibernate çš„å®žçŽ°æœºåˆ¶ä¸­æä¾›äº† PersistentCollection çš„æœºåˆ¶ï¼Œåˆ©ç”¨ä»£ç†æœºåˆ¶æ”¹å˜äº†å…³è”å…³ç³»çš„é›†åˆç±»åž‹ï¼Œä»Žè€Œå®žçŽ°äº†æ‡’åŠ è½½æœºåˆ¶ã€‚ PersistentCollection é›†åˆç±»PersistentCollection æ˜¯ä¸€ä¸ªé›†åˆç±»çš„æŽ¥å£ï¼Œå®žçŽ°ç±»åŒ…æ‹¬å¦‚ä¸‹å‡ ç§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ä¹Ÿå°±æ˜¯è¯´ Hibernate é€šè¿‡ PersistentCollection çš„å®žçŽ°ç±» AbstractPersistentCollection çš„æ‰€æœ‰å­ç±»ï¼Œå¯¹ JDK é‡Œé¢æä¾›çš„ Listã€Mapã€SortMapã€Arrayã€Setã€SortedSet è¿›è¡Œäº†æ‰©å±•ï¼Œä»Žè€Œå®žçŽ°äº†å…·æœ‰æ‡’åŠ è½½çš„ç‰¹æ€§ã€‚æ‰€ä»¥åœ¨ Hibernate é‡Œé¢æ”¯æŒçš„å…³è”å…³ç³»çš„ç±»åž‹åªæœ‰ä¸‹é¢äº”ç§ã€‚ java.util.List java.util.Set java.util.Map java.util.SortedSet java.util.SortedMap å…³äºŽè¿™å‡ ç§ç±»åž‹ï¼ŒHibernate å®˜æ–¹ä¹Ÿæä¾›äº†æ‰©å±• AbstractPersistentCollection çš„æ–¹æ³•ã€‚ PersistentBag ä¸ºä¾‹è¯¦è§£åŽŸç†é€šè¿‡ PersistentBag çš„å…³é”®æºç ï¼Œæ¥çœ‹ä¸€ä¸‹é›†åˆç±» List æ˜¯æ€Žä¹ˆå®žçŽ°çš„ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051//PersistentBag ç»§æ‰¿ AbstractPersistentCollectionï¼Œä»Žè€Œç»§æ‰¿äº† PersistenceCollection çš„ä¸€äº›å…¬å…±åŠŸèƒ½ã€sessionçš„æŒæœ‰ã€lazyçš„ç‰¹æ€§ã€entityçš„çŠ¶æ€è½¬åŒ–ç­‰åŠŸèƒ½ï¼›åŒæ—¶ PersistentBag ä¹Ÿå®žçŽ°äº† java.util.List çš„æ‰€æœ‰æ–¹æ³•ï¼Œå³å¯¹ List è¿›è¡Œè¯»å†™çš„æ—¶å€™åŒ…è£… lazy é€»è¾‘public class PersistentBag extends AbstractPersistentCollection implements List &#123; //PersistentBagæž„é€ æ–¹æ³•ï¼Œå½“åˆå§‹åŒ–å®žä½“å¯¹è±¡å¯¹é›†åˆåˆå§‹åŒ–çš„æ—¶å€™ï¼ŒæŠŠå½“å‰çš„Sessionä¿æŒä½ public PersistentBag(SessionImplementor session) &#123; this( (SharedSessionContractImplementor) session ); &#125; // ä»Žè¿™ä¸ªæ–¹æ³•å¯ä»¥çœ‹å‡ºæ¥å…¶å¯¹Listå’ŒArrayListçš„æ”¯æŒ @SuppressWarnings("unchecked") public PersistentBag(SharedSessionContractImplementor session, Collection coll) &#123; super( session ); providedCollection = coll; if ( coll instanceof List ) &#123; bag = (List) coll; &#125; else &#123; bag = new ArrayList( coll ); &#125; setInitialized(); setDirectlyAccessible( true ); &#125; //ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®çš„ List çš„å®žçŽ°æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨åŽŸæœ‰çš„ List åŠŸèƒ½çš„åŸºç¡€ä¸Šå¢žåŠ è°ƒç”¨çˆ¶ç±» AbstractPersistentCollection é‡Œé¢çš„ read() å’Œ write() æ–¹æ³• @Override @SuppressWarnings("unchecked") public Object remove(int i) &#123; write(); return bag.remove( i ); &#125; @Override @SuppressWarnings("unchecked") public Object set(int i, Object o) &#123; write(); return bag.set( i, o ); &#125; @Override @SuppressWarnings("unchecked") public List subList(int start, int end) &#123; read(); return new ListProxy( bag.subList( start, end ) ); &#125; @Override public boolean entryExists(Object entry, int i) &#123; return entry != null; &#125; // toStringè¢«è°ƒç”¨çš„æ—¶å€™ä¼šè§¦å‘read() @Override public String toString() &#123; read(); return bag.toString(); &#125; .....//å…¶ä»–æ–¹æ³•ç±»ä¼¼ï¼Œå°±ä¸ä¸€ä¸€ä¸¾ä¾‹äº†&#125; é‚£ä¹ˆå†çœ‹ä¸€ä¸‹ AbstractPersistentCollection çš„å…³é”®å®žçŽ°ï¼Œåœ¨ AbstractPersistentCollection ä¸­ä¼šæœ‰å¤§é‡é€šè¿‡ Session æ¥åˆå§‹åŒ–å…³è”å…³ç³»çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åŸºæœ¬æ˜¯åˆ©ç”¨å½“å‰ Session å’Œå½“å‰ Session ä¸­æŒæœ‰çš„ Connection æ¥é‡æ–°æ“ä½œ DBï¼Œä»Žè€Œå–åˆ°æ•°æ®åº“é‡Œé¢çš„æ•°æ®ã€‚ æ‰€ä»¥ LazyInitializationExcetion åŸºæœ¬éƒ½æ˜¯ä»Žè¿™ä¸ªç±»é‡Œé¢æŠ›å‡ºæ¥çš„ï¼Œä»Žæºç é‡Œé¢å¯ä»¥çœ‹åˆ°å…¶ä¸¥é‡ä¾èµ–å½“å‰çš„ Sessionï¼Œå…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æ‰€ä»¥åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œå¦‚æžœæŠŠ Session å…³é—­äº†ï¼Œæƒ³åˆ©ç”¨ Lazy çš„æœºåˆ¶åŠ è½½ç®¡ç†å…³ç³»ï¼Œå°±ä¼šå‘ç”Ÿå¼‚å¸¸äº†ã€‚é€šè¿‡å®žä¾‹çœ‹ä¸€ä¸‹ï¼Œåœ¨ä¸Šé¢ä¾‹å­çš„ Controller ä¸ŠåŠ ä¸€ä¸ª debug æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ˜¾ç¤ºçš„å†…å®¹ï¼šæˆ‘ä»¬çš„ Address æŒ‡å‘äº† PersistentBag ä»£ç†å®žä¾‹ç±»ã€‚ åŒæ—¶å†è®¾ç½®æ–­ç‚¹çš„è¯ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒPersistentBag è¢«åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šä¼ è¿›æ¥ Session çš„ä¸Šä¸‹æ–‡ï¼Œå³åŒ…å« Datasource å’Œéœ€è¦æ‰§è¡Œ Lazy çš„ sqlã€‚ è€Œéœ€è¦æ‰§è¡Œ Lazy çš„ sqlï¼Œé€šè¿‡ debug çš„æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°å…¶ä¸­æœ‰ä¸ª instantiateï¼Œå…³é”®æ–­ç‚¹ä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å†ç»§ç»­ debug çš„è¯ï¼Œä¹Ÿä¼šçœ‹åˆ°è°ƒç”¨ AbstractPersistentCollection çš„åˆå§‹åŒ– Lazy çš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ é€šè¿‡æºç åˆ†æžå’Œå®žä¾‹è®²è§£ï¼Œå·²ç»åŸºæœ¬ä¸ŠçŸ¥é“äº† Lazy çš„åŽŸç†ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ Lazy çš„å…³è”å…³ç³»ä¼šåˆå§‹åŒ–æˆ PersistentCollectionï¼Œå¹¶ä¸”ä¾èµ–æŒæœ‰çš„ Sessionã€‚è€Œå½“æ“ä½œ Listã€Map ç­‰é›†åˆç±»çš„ä¸€äº›åŸºæœ¬æ–¹æ³•çš„æ—¶å€™ä¼šè§¦å‘ read()ï¼Œå¹¶åˆ©ç”¨å½“å‰çš„ Session è¿›è¡Œæ‡’åŠ è½½ã€‚ Lazy å¼‚å¸¸çš„å¸¸è§åœºæ™¯ä¸Žè§£å†³æ–¹æ³•åœºæ™¯ä¸€ï¼šè·¨äº‹åŠ¡ï¼Œäº‹åŠ¡ä¹‹å¤–çš„åœºæ™¯ å½“ spring.jpa.open-in-view=false çš„æ—¶å€™ï¼Œæ¯ä¸ªäº‹åŠ¡å°±ä¼šç‹¬ç«‹æŒæœ‰ Sessionï¼›é‚£ä¹ˆåœ¨äº‹åŠ¡ä¹‹å¤–æ“ä½œ lazy çš„å…³è”å…³ç³»çš„æ—¶å€™ï¼Œå°±å®¹æ˜“å‘ç”Ÿ Lazy å¼‚å¸¸ã€‚ æ­£å¦‚ä¸Šé¢åˆ—ä¸¾çš„ Demo ä¸€æ ·ï¼Œä¸€å¼€å§‹å°±å°† open-in-view è®¾ç½®æˆäº† falseï¼Œè€Œ userInfoRepository.findById(id) åˆæ˜¯ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼Œæ–¹æ³•æ“ä½œç»“æŸä¹‹åŽäº‹åŠ¡ç»“æŸï¼Œäº‹åŠ¡ç»“æŸä¹‹åŽ session closeã€‚æ‰€ä»¥å†æ“ä½œ UserInfo ä¸­ Address å¯¹è±¡çš„æ—¶å€™ï¼Œå°±å‘ç”Ÿäº† Lazy å¼‚å¸¸ã€‚ å®žé™…å·¥ä½œä¸­è¿™ç§æƒ…å†µæ¯”è¾ƒå¤šè§ï¼Œåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ ç¬¬ä¸€ç§æ–¹å¼ï¼šç®€å•ç²—æš´åœ°è®¾ç½®ä¸º spring.jpa.open-in-view=true é€šè¿‡ä¸Šé¢çš„åˆ†æžï¼Œå¯ä»¥çŸ¥é“æ— éžå°±æ˜¯ Session çš„å…³é—­å¯¼è‡´äº† Lazy å¼‚å¸¸ï¼Œæ‰€ä»¥ç®€å•ç²—æš´çš„åŠžæ³•å°±æ˜¯åŠ å¤§ Session çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°† Session çš„ç”Ÿå‘½å‘¨æœŸå’Œè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸè®¾ç½®æˆä¸€æ ·ã€‚ä½†æ˜¯ open-in-view å¯èƒ½ä¼šå¸¦æ¥çš„å‰¯ä½œç”¨å¿…é¡»è¦ç‰¢è®°äºŽå¿ƒï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹ã€‚ å®ƒå¯¹ Connection çš„å½±å“æ˜¯ä»€ä¹ˆï¼Ÿè¿žæŽ¥æ± æœ‰æ²¡æœ‰å¾ˆå¥½åœ°ç›‘æŽ§ï¼Ÿåˆ©ç”¨çŽ‡æ˜¯æ€Žä¹ˆæ ·çš„ï¼Ÿ å®žä½“çš„çŠ¶æ€åœ¨æ•´ä¸ª Session çš„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„å˜æ›´éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œæ•°æ®çš„æ›´æ–°æ˜¯ä¸æ˜¯é¢„æœŸçš„ï¼Œä½ è¦å¿ƒé‡Œæœ‰æ•°ã€‚ N+1 çš„ SQL æ˜¯ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ï¼Ÿï¼ˆè¿™ä¸ªä¸‹ä¸€è®²æˆ‘ä¼šè¯¦ç»†ä»‹ç»ï¼‰æ€§èƒ½æœ‰æ²¡æœ‰å½±å“ï¼Ÿç­‰ç­‰ã€‚ ç¬¬äºŒç§æ–¹å¼ï¼šä¹Ÿæ˜¯ç®€å•ç²—æš´æ”¹æˆ Eager æ¨¡å¼ ç›´æŽ¥é‡‡ç”¨ Eager çš„æ¨¡å¼ï¼Œè¿™æ ·ä¹Ÿä¸ä¼šæœ‰ Lazy å¼‚å¸¸çš„é—®é¢˜ã€‚å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºã€‚ 12345public class UserInfo extends BaseEntity &#123; private String name; //ç›´æŽ¥é‡‡ç”¨eageræ¨¡å¼ @OneToMany(mappedBy = "userInfo",cascade = CascadeType.PERSIST,fetch = FetchType.EAGER) private List&lt;Address&gt; addressList; ä½†æ˜¯è¿™ç§åšæ³•ä¸æŽ¨èä½¿ç”¨ï¼Œå› ä¸ºæœ¬æ¥ä¸æƒ³æŸ¥ Address ä¿¡æ¯ï¼Œè¿™æ ·ä¼šç™½ç™½åœ°è§¦å‘å¯¹ Address çš„æŸ¥è¯¢ï¼Œå¯¼è‡´æ€§èƒ½æœ‰ç‚¹æµªè´¹ã€‚ ç¬¬ä¸‰ç§æ–¹å¼ï¼šå°†å¯èƒ½å‘ç”Ÿ Lazy çš„æ“ä½œå’Œå–æ•°æ®æ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢ æ”¹é€ ä¸€ä¸‹ä¸Šé¢ Demo çš„ Controller çš„å†™æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112@RestController@Log4j2public class UserInfoController &#123; @Autowired private UserInfoService userInfoService; @GetMapping("/user/info/&#123;id&#125;") public UserInfo getUserInfoFromPath(@PathVariable("id") Long id) &#123; //controller é‡Œé¢æ”¹è°ƒç”¨ service æ–¹æ³•ï¼Œè¿™ä¸ª service æ˜Žç¡®åœ°è¿”å›žäº† UserInfo å’Œ Address ä¿¡æ¯ UserInfo u1 = userInfoService.getUserInfoAndAddress(id); System.out.println(u1.getAddressList().get(0).getCity()); return u1; &#125; Service çš„å®žçŽ°å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨é‡Œé¢ç”¨äº‹åŠ¡åŒ…è£…ï¼Œåˆ©ç”¨äº‹åŠ¡ï¼Œè®©å¯èƒ½è§¦å‘ Lazy çš„æ“ä½œæå‰åœ¨äº‹åŠ¡é‡Œé¢å‘ç”Ÿã€‚ 1234567891011/** * æŠŠé€»è¾‘å°è£…åœ¨serviceæ–¹æ³•é‡Œé¢ï¼Œæ–¹æ³•åå­—è¯­ä¹‰è¦æ¸…æ™°ï¼Œå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ³•ä¼šå–UserInfoçš„ä¿¡æ¯å’ŒAddressçš„ä¿¡æ¯ * @param id */@Override@Transactionalpublic UserInfo getUserInfoAndAddress(Long id) &#123; UserInfo u1 = userInfoRepository.findById(id).get(); u1.getAddressList().size();//åœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢è§¦å‘lazyï¼›ä¸éœ€è¦æŸ¥è¯¢addressçš„åœ°æ–¹å°±ä¸éœ€è¦è§¦å‘äº† return u1;&#125; è¿™ä¸ªæ—¶å€™å°±è¦æ±‚å¯¹æ–¹æ³•åçš„è¯­ä¹‰å’Œæ³¨é‡Šæ¯”è¾ƒæ¸…æ™°äº†ï¼Œè¿™ä¸ªæ–¹æ³•è¿˜æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ Service è¿”å›žçš„ä¾ç„¶è¿˜æ˜¯ UserInfo çš„å®žä½“ï¼Œå¦‚æžœåœ¨å…³è”å…³ç³»å¤šçš„æƒ…å†µä¸‹ï¼Œä¾ç„¶æœ‰çŠ¯é”™çš„å¯èƒ½æ€§å‘ç”Ÿã€‚ ç¬¬å››ç§æ–¹å¼ï¼šService å±‚ä¹‹å¤–éƒ½ç”¨ DTO æˆ–è€…å…¶ä»– POJOï¼Œè€Œä¸æ˜¯ Entity è¿™ç§æ˜¯æœ€å¤æ‚çš„ï¼Œä½†å´æ˜¯æœ€æœ‰æ•ˆçš„ã€ä¸ä¼šå‡ºé—®é¢˜çš„æ–¹å¼ï¼Œåœ¨ Service å±‚è¿”å›ž DTOï¼Œæ”¹é€ ä¸€ä¸‹ Service æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 123456@Transactionalpublic UserInfoDto getUserInfoAndAddress(Long id) &#123; UserInfo u1 = userInfoRepository.findById(id).get(); //æŒ‰ç…§ä¸šåŠ¡è¦æ±‚ï¼Œéœ€è¦ä»€ä¹ˆè¿”å›žä»€ä¹ˆå°±å¯ä»¥äº†ï¼Œè®©å®žä½“åœ¨serviceå±‚ä¹‹å¤–æ˜¯ä¸å¯è§çš„ return UserInfoDto.builder().name(u1.getName()).addressList(u1.getAddressList()).build();/&#125; è€Œ UserInfoDto ä¹Ÿå°±æ˜¯æ ¹æ®ä¸šåŠ¡éœ€è¦åˆ›å»ºä¸åŒçš„ DTO å³å¯ã€‚ä¾‹å¦‚ï¼Œåªéœ€è¦ name å’Œ address çš„æ—¶å€™ï¼Œä»£ç å¦‚ä¸‹ã€‚ 123456@Data@Builderpublic class UserInfoDto &#123; private String name; private List&lt;Address&gt; addressList;&#125; é™¤äº† DTO è¿˜å¯ä»¥é‡‡ç”¨ä»»ä½•è¯­ä¹‰çš„ POJOï¼Œå®—æ—¨å°±æ˜¯ Entity å¯¹ Service å±‚ä¹‹å¤–æ˜¯ä¸å¯è§çš„ã€‚ä¹Ÿå¯ä»¥é‡‡ç”¨ Projection çš„æ–¹å¼ï¼Œè¿”å›žæŽ¥å£ç±»åž‹çš„ POJOï¼Œè¿™æ ·æŽ§åˆ¶çš„ç²’åº¦æ›´ç»†ï¼Œè¯»å†™éƒ½å¯ä»¥åˆ†å¼€ã€‚å°† Entity æŽ§åˆ¶åœ¨ Service å±‚è¿˜æœ‰ä¸ªå¥½å¤„å°±æ˜¯ï¼Œæœ‰çš„æ—¶å€™ä¼šä½¿ç”¨å„ç§ RPC æ¡†æž¶è¿›è¡Œè¿œç¨‹æ–¹æ³•è°ƒåº¦ï¼Œå¯ä»¥ç›´æŽ¥è°ƒç”¨ Service æ–¹æ³•é€šè¿‡ TCP åè®®ï¼Œä¾‹å¦‚ Dubboï¼Œè¿™æ ·ä¹Ÿå°±å¤©ç„¶æ”¯æŒäº†ã€‚ åœºæ™¯äºŒï¼šå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™æ—¢ç„¶è·¨äº‹åŠ¡å®¹æ˜“å‘ç”Ÿé—®é¢˜ï¼Œé‚£ä¹ˆå¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™æ›´å®¹æ˜“å‘ç”Ÿ Lazy å¼‚å¸¸ å¼‚æ­¥çº¿ç¨‹çš„æ—¶å€™ï¼Œå†å¥—ç”¨ä¸Šé¢çš„å››ç§æ–¹å¼ï¼Œä¼šå‘çŽ°ç¬¬ä¸€ç§æ–¹å¼å°±ä¸é€‚ç”¨äº†ï¼Œå› ä¸ºå¼‚æ­¥å¼€å¯çš„äº‹åŠ¡å’Œ DB æ“ä½œé»˜è®¤æ˜¯ä¸å— open-in-view æŽ§åˆ¶çš„ã€‚æ‰€ä»¥å¯ä»¥æ˜Žç¡®åœ°çŸ¥é“ï¼Œå¼€å¯çš„å¼‚æ­¥æ–¹æ³•ä¼šç”¨åˆ°å®žä½“å‚æ•°çš„å“ªäº›å…³è”å…³ç³»ï¼Œæ˜¯å¦éœ€è¦æŒ‰ç…§ä¸Šé¢çš„ç¬¬ä¸‰ç§å’Œç¬¬å››ç§æ–¹å¼è¿›è¡Œæå‰å¤„ç†å‘¢ï¼Ÿè¿™äº›éƒ½æ˜¯éœ€è¦å¿ƒä¸­æœ‰æ•°çš„ï¼Œè€Œä¸æ˜¯ç®€å•åœ°æŠŠå¼‚æ­¥å¼€å¯å°±å®Œäº‹äº†ã€‚ åœºæ™¯ä¸‰ï¼šController ç›´æŽ¥è¿”å›žå®žä½“ä¹Ÿä¼šäº§ç”Ÿ Lazy Exceptionå·¥ä½œä¸­ç»å¸¸ä¸ºäº†çœäº‹ï¼Œç›´æŽ¥åœ¨ Contoller é‡Œé¢è¿”å›ž Entityï¼Œè¿™ä¸ªæ—¶å€™å¾ˆå®¹æ˜“å‘ç”Ÿ Lazy å¼‚å¸¸ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªåœºæ™¯ã€‚ 1234@GetMapping("/user/info/&#123;id&#125;")public UserInfo getUserInfoFromPath(@PathVariable("id") Long id) &#123; return userInfoRepository.findById(id).get();//controller å±‚ç›´æŽ¥å°† UserInfo è¿”å›žç»™ view å±‚äº†ï¼›&#125; ç›´æŽ¥å°† UserInfo å®žä½“å¯¹è±¡å½“æˆ VO å¯¹è±¡ï¼Œä¸”ç›´æŽ¥å½“æˆè¿”å›žç»“æžœäº†ï¼Œå½“è¯·æ±‚ä¸Šé¢çš„ API çš„æ—¶å€™ä¹Ÿä¼šå‘ç”Ÿ Lazy å¼‚å¸¸ï¼Œçœ‹ä¸‹ä»£ç ã€‚ 12o.hibernate.LazyInitializationException : failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList, could not initialize proxy - no Session org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList, could not initialize proxy - no Session æ­¤ VO å‘ç”Ÿçš„å¼‚å¸¸ä¸Žå…¶ä»– Lazy å¼‚å¸¸ä¸åŒçš„æ—¶å€™ï¼Œä»”ç»†è§‚å¯Ÿï¼Œä¼šå‘çŽ°å¦‚ä¸‹ä¿¡æ¯ã€‚ 1 Resolved [org.springframework.http.converter.HttpMessageNotWritableException: Could not write JSON: failed to lazily initialize a collection of role: com.example.jpa.demo.db.UserInfo.addressList é€šè¿‡æ—¥å¿—å¯ä»¥çŸ¥é“ï¼Œæ­¤æ—¶å‘ç”Ÿ Lazy å¼‚å¸¸çš„ä¸»è¦åŽŸå› æ˜¯ JSON ç³»åˆ—åŒ–çš„æ—¶å€™ä¼šè§¦å‘ Lazy åŠ è½½ã€‚è¿™ä¸ªæ—¶å€™å°±æœ‰äº†ç¬¬äº”ç§è§£å†³ Lazy å¼‚å¸¸çš„æ–¹å¼ï¼Œå°±æ˜¯åˆ©ç”¨ @JsonIgnoreProperties(â€œaddressListâ€) æŽ’é™¤æˆ‘ä»¬ä¸æƒ³åºåˆ—åŒ–çš„å±žæ€§å³å¯ã€‚ ä½†æ˜¯è¿™ç§æ–¹å¼çš„å¼Šç«¯æ˜¯ç”¨è¿™ä¸ªé›†åˆçš„åªèƒ½å…¨å±€é…ç½®ï¼Œæ²¡åŠžæ³•æœ‰ç‰¹ä¾‹é…ç½®ã€‚å› æ­¤æœ€ä½³å®žè·µè¿˜æ˜¯é‡‡ç”¨ä¸Šé¢æ‰€è¯´çš„ç¬¬ä¸€ç§æ–¹å¼å’Œç¬¬å››ç§æ–¹å¼ã€‚ åœºæ™¯å››ï¼šè‡ªå®šä¹‰çš„æ‹¦æˆªå™¨å’Œ filter ä¸­æ— æ„çš„ toString æ“ä½œç¬¬å››ä¸ª Lazy å¼‚å¸¸çš„åœºæ™¯å°±æ˜¯æ‰“å°ä¸€äº›æ—¥å¿—ï¼Œæˆ–è€…æ— æ„é—´è§¦å‘ toString çš„æ“ä½œä¹Ÿä¼šå‘ç”Ÿ Lazy å¼‚å¸¸ï¼Œè¿™ç§å¤„ç†æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ˆç¬¬å…­ç§å¤„ç† Lazy å¼‚å¸¸çš„æ–¹å¼ï¼‰ï¼štoString é‡Œé¢æŽ’é™¤æŽ‰ä¸éœ€è¦ Lazy åŠ è½½çš„å…³è”å…³ç³»å³å¯ã€‚å¦‚æžœæˆ‘ä»¬ç”¨ lombok çš„è¯ï¼Œç›´æŽ¥ @ToString(exclude = â€œaddressListâ€) æŽ’é™¤æŽ‰å°±å¥½äº†ï¼Œå®Œæ•´ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234@ToString(exclude = "addressList")@JsonIgnoreProperties("addressList")public class UserInfo extends BaseEntity &#123;......&#125; ä»¥ä¸Šä»‹ç»çš„å››ä¸ª Lazy å¼‚å¸¸çš„åœºæ™¯å’Œå…­ç§å¤„ç†æ–¹å¼ï¼Œåœ¨å®žé™…å·¥ä½œä¸­å¯ä»¥çµæ´»è¿ç”¨ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯è¦çŸ¥é“èƒŒåŽçš„åŽŸç†å’Œè§¦å‘ Lazy äº§ç”Ÿçš„æ€§èƒ½å½±å“æ˜¯ä»€ä¹ˆï¼ˆæ„å¤–çš„ SQL æ‰§è¡Œï¼‰ã€‚ Hibernate å®˜æ–¹è¿˜æä¾›äº†ç¬¬ä¸ƒç§å¤„ç† Lazy å¼‚å¸¸çš„æ–¹å¼ï¼šåˆ©ç”¨ Hibernate çš„é…ç½® hibernate.enable_lazy_load_no_trans é…ç½® Hibernate å®˜æ–¹æä¾›äº† hibernate.enable_lazy_load_no_trans é…ç½®ï¼Œæ˜¯å¦å…è®¸åœ¨å…³é—­ä¹‹åŽä¾ç„¶æ”¯æŒ Lazy åŠ è½½ï¼Œæ­¤éž JPA æ ‡å‡†ï¼Œæ‰€ä»¥åœ¨ç”¨çš„æ—¶å€™éœ€è¦å…³æ³¨ç‰ˆæœ¬å˜åŒ–ã€‚ å…¶ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æŽ¥åœ¨ application.properties é‡Œé¢å¢žåŠ å¦‚ä¸‹é…ç½®å³å¯ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š 12## è¿è¡Œåœ¨sessionå…³é—­ä¹‹åŽï¼Œé‡æ–°lazyæ“ä½œspring.jpa.properties.hibernate.enable_lazy_load_no_trans=true æ­¤æ—¶ä¸éœ€è¦åšä»»ä½•å…¶ä»–ä¿®æ”¹ï¼Œå½“åœ¨äº‹åŠ¡ä¹‹å¤–ï¼Œç”šè‡³æ˜¯ Session ä¹‹å¤–ï¼Œè§¦å‘ Lazy æ“ä½œçš„æ—¶å€™ä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œä¹Ÿä¼šæ­£å¸¸åœ°è¿›è¡Œå–æ•°æ®ã€‚ ä½†æ˜¯å»ºè®®ä¸è¦ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºä¸€æ—¦å¼€å¯äº†è¿™ä¸ªå¯¹ Lazy çš„æ“ä½œå°±ä¸å¯æŽ§äº†ï¼Œä¼šå‘ç”Ÿé¢„æœŸä¹‹å¤–çš„ Lazy å¼‚å¸¸ï¼Œç„¶åŽåªèƒ½é€šè¿‡ä¸Šé¢æ‰€è¯´çš„å¤„ç† Lazy å¼‚å¸¸çš„ç¬¬ä¸‰ç§å’Œç¬¬å››ç§æ–¹å¼è§£å†³æˆé¢„æœŸä¹‹å†…çš„ï¼Œå¦åˆ™çš„è¯ï¼Œè¿˜ä¼šå¸¦æ¥å¾ˆå¤šé¢„æœŸä¹‹å¤–çš„ SQL æ‰§è¡Œã€‚è¿™å°±ä¼šé€ æˆä¸€ç§è¯¯è§£ï¼Œå³ä½¿ç”¨ Hibernate æˆ–è€… JPA ä¼šå¯¼è‡´æ€§èƒ½å˜å·®ï¼Œå…¶å®žæœ¬è´¨åŽŸå› æ˜¯ä¸äº†è§£åŽŸç†ï¼Œæ²¡èƒ½æ­£ç¡®ä½¿ç”¨ã€‚ æ‰€ä»¥åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSpring Data JPA ä¸­ï¼Œhibernate.enable_lazy_load_no_trans é»˜è®¤æ˜¯ falseï¼Œè¿™å’Œ spring.jpa.open-in-view é»˜è®¤æ˜¯ true æ˜¯ç›¸åŒçš„é“ç†ã€‚æ‰€ä»¥å¦‚æžœéƒ½é‡‡ç”¨ Spring Boot çš„é»˜è®¤é…ç½®ï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼›è€Œæœ‰çš„æ—¶å€™ä¸ºäº†æ›´ä¼˜çš„é…ç½®ï¼Œéœ€è¦çŸ¥é“åº•å±‚çš„åŽŸç†ï¼Œè¿™æ ·æ‰èƒ½åˆ¤æ–­å‡ºæ¥ä¸šåŠ¡åœºæ™¯çš„æœ€ä½³å®žè·µæ˜¯ä»€ä¹ˆã€‚ Javax.persistence.PersistenceException å¼‚å¸¸ç±»åž‹é¡ºè—¤æ‘¸ç“œï¼Œå¯ä»¥çœ‹åˆ° LazyInitializationException æ˜¯ HibernateException é‡Œé¢çš„ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ° HibernateException çš„çˆ¶ç±» Javax.persistence.PersistenceException ä¸‹é¢æœ‰å¾ˆå¤šç»†åˆ†çš„å¼‚å¸¸ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å½“æˆ‘ä»¬é‡åˆ°å¼‚å¸¸çš„æ—¶å€™ä¸è¦æ…Œå¼ ï¼Œä»”ç»†çœ‹æ—¥å¿—åŸºæœ¬å°±èƒ½çŸ¥é“æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼Œä¸åŒçš„å¼‚å¸¸æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚ OptimisticLockException å°±éœ€è¦è¿›è¡Œé‡è¯•ï¼›è€Œé’ˆå¯¹ NoSuchBeanException çš„å¼‚å¸¸ï¼Œå°±è¦æ£€æŸ¥å®žä½“é…ç½®æ˜¯å¦å¦¥å½“ï¼Œé‡åˆ°å®žé™…æƒ…å†µå†å®žé™…åˆ†æžå³å¯ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa åœ¨CompletableFutureå¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPA]]></title>
    <url>%2F2021%2F01%2F09%2FSpringDataJpa%E5%9C%A8CompletableFuture%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E4%B8%AD%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8JPA%2F</url>
    <content type="text"><![CDATA[åœ¨ CompletableFuture å¼‚æ­¥çº¿ç¨‹ä¸­æ­£ç¡®ä½¿ç”¨JPACompletableFuture çš„ä½¿ç”¨å®žé™…æ¡ˆä¾‹åœ¨å®žé™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéš¾å…ä¼šç”¨åˆ°å¼‚æ­¥æ–¹æ³•ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•çš„ä¾‹å­ï¼Œç»å…¸åœ°è¿˜åŽŸä¸€äº›åœ¨å¼‚æ­¥æ–¹æ³•é‡Œé¢ç»å¸¸ä¼šçŠ¯çš„é”™è¯¯ã€‚ æ¨¡æ‹Ÿä¸€ä¸ª Service æ–¹æ³•ï¼Œé€šè¿‡å¼‚æ­¥æ“ä½œï¼Œæ›´æ–° UserInfo ä¿¡æ¯ï¼Œå¹¶ä¸”å¯èƒ½ä¸€ä¸ªæ–¹æ³•é‡Œé¢æœ‰ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œä¼šå¤šæ¬¡æ›´æ–° UserInfo ä¿¡æ¯ï¼Œæ¨¡æ‹Ÿçš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839@RestControllerpublic class UserInfoController &#123; //å¼‚æ­¥æ“ä½œå¿…é¡»è¦å»ºç«‹çº¿ç¨‹æ±  @Autowired private Executor executor; /** * æ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡serviceæ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œä¸€äº›ä¸šåŠ¡æ–¹æ³•é‡Œé¢å¯èƒ½ä¿®æ”¹äº†ä¸¤æ¬¡ç”¨æˆ·ä¿¡æ¯ * @param name * @return */ @PostMapping("test/async/user") @Transactional // æ¨¡æ‹Ÿä¸€ä¸ª service æ–¹æ³•ï¼ŒæœŸå¾…æ˜¯ä¸€ä¸ªäº‹åŠ¡ public String testSaveUser(String name) &#123; CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123; UserInfo user = userInfoRepository.findById(1L).get(); //..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ”¹å˜ UserInfo é‡Œé¢çš„å€¼ï¼› try &#123; Thread.sleep(200L);// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 200 æ¯«ç§’ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; user.setName(RandomUtils.nextInt(1,100000)+ "_first"+name); //æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼ userInfoRepository.save(user); //..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬äºŒæ¬¡æ”¹å˜ UserInfo é‡Œé¢çš„å€¼ï¼› try &#123; Thread.sleep(300L);// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 300 æ¯«ç§’ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; user.setName(RandomUtils.nextInt(1,100000)+ "_second"+name);//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼ userInfoRepository.save(user); &#125;, executor).exceptionally(throwable -&gt; &#123; throwable.printStackTrace(); return null; &#125;); //... å®žé™…ä¸šåŠ¡ä¸­ï¼Œå¯èƒ½è¿˜æœ‰ä¼šå…¶ä»–å¼‚æ­¥æ–¹æ³• cf.isDone(); return "Success";&#125;&#125; åœ¨ testSaveUser æ–¹æ³•é‡Œé¢å¼€äº†ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ï¼Œå¼‚æ­¥çº¿ç¨‹é‡‡ç”¨ CompletableFuture æ–¹æ³•ï¼Œåœ¨é‡Œé¢æ‰§è¡Œäº†ä¸¤æ¬¡ UserInfo çš„ Save æ“ä½œ é‚£ä¹ˆä¸Šé¢çš„ä»£ç é—®é¢˜çš„è¡¨è±¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ è¡¨çŽ°å‡ºæ¥çš„é—®é¢˜çŽ°çŠ¶æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿé‚£ä¹ˆå®žé™…å·¥ä½œä¸­ï¼Œå¦‚æžœå†™å‡ºæ¥ç±»ä¼¼çš„ä»£ç ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæ ·çš„é—®é¢˜å‘¢ï¼Ÿ æ•´ä¸ªè¯·æ±‚éžå¸¸æ­£å¸¸ï¼Œæ°¸è¿œéƒ½æ˜¯ 200ï¼›ä¹Ÿæ²¡æœ‰ä»»ä½•æŠ¥é”™ä¿¡æ¯ï¼Œä½†æ˜¯å‘çŽ°æ•°æ®åº“é‡Œé¢ç¬¬äºŒæ¬¡çš„ save(user) æ°¸è¿œä¸ç”Ÿæ•ˆï¼Œæ°¸è¿œä¸ä¼šå‡ºçŽ° name åŒ…å« â€œ_secondâ€ çš„è®°å½•ï¼Œè¿™ä¸ªæ˜¯å¿…çŽ°çš„ï¼› æ•´ä¸ªè¯·æ±‚éžå¸¸æ­£å¸¸ï¼Œæ°¸è¿œéƒ½æ˜¯ 200ï¼›ä¹Ÿæ²¡æœ‰ä»»ä½•æŠ¥é”™ä¿¡æ¯ï¼Œæœ‰çš„æ—¶å€™ä¼šå‘çŽ°æ•°æ®åº“é‡Œé¢æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œç”šè‡³ç¬¬ä¸€æ¬¡ save(user) éƒ½æ²¡æœ‰ç”Ÿæ•ˆï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯å¶å‘çš„ã€‚ æ­¥éª¤æ‹†è§£CompletableFuture ä½¿ç”¨æœ€ä½³å®žè·µCompletableFuture ä¸»è¦çš„åŠŸèƒ½æ˜¯å®žçŽ°äº† Future å’Œ CompletionStage çš„æŽ¥å£ï¼Œä¸»è¦çš„æ–¹æ³•å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤º: 123456789101112//é€šè¿‡ç»™å®šçš„çº¿ç¨‹æ± ï¼Œå¼‚æ­¥æ‰§è¡Œ Runnable æ–¹æ³•ï¼Œä¸å¸¦è¿”å›žç»“æžœpublic static CompletableFuture&lt;Void&gt; runAsync(Runnable runnable, Executor executor)//é€šè¿‡ç»™å®šçš„çº¿ç¨‹æ± ï¼Œå¼‚æ­¥æ‰§è¡Œ Runnable æ–¹æ³•ï¼Œå¸¦è¿”å›žç»“æžœpublic static &lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier, Executor executor)//å½“ä¸Šé¢çš„å¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œä¹‹åŽéœ€è¦æ‰§è¡Œçš„å›žè°ƒæ–¹æ³•public CompletableFuture&lt;Void&gt; thenAccept(Consumer&lt;? super T&gt; action)//é˜»å¡žç­‰å¾… future æ‰§è¡Œå®Œç»“æžœboolean isDone();//é˜»å¡žèŽ·å–ç»“æžœV get();//å½“å¼‚æ­¥æ“ä½œå‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰§è¡Œçš„æ–¹æ³•public CompletionStage&lt;T&gt; exceptionally(Function&lt;Throwable, ? extends T&gt; fn); CompletableFuture è¿˜æœ‰æ›´å¤šçš„æ–¹æ³•ï¼Œå…¶åŠŸèƒ½ä¹Ÿéžå¸¸å¼ºå¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬å¼€å‘è¿‡ç¨‹ä¸­ç”¨æ­¤ç±»çš„åœºæ™¯è¿˜éžå¸¸å¤šã€‚ å…¶å®žä¸Šé¢çš„ Demo åªæ˜¯åˆ©ç”¨ runAsync åšäº†å¼‚æ­¥æ“ä½œï¼Œå¹¶åˆ©ç”¨ isDone åšäº†é˜»å¡žç­‰å¾…çš„åŠ¨ä½œï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ Exceptionally å¤„ç†å¼‚å¸¸ä¿¡æ¯ã€‚ æ‰€ä»¥å¦‚æžœæƒ³æ‰“å°å¼‚å¸¸ä¿¡æ¯ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åˆ©ç”¨ Exceptionallyã€‚æ”¹è¿›ä¸€ä¸‹ Demo ä»£ç ï¼ŒæŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯å¦å‘ç”Ÿäº†å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤º: 123456CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123; ......è¿™é‡Œçš„ä»£ç ä¸å˜&#125;, executor).exceptionally(e -&gt; &#123; log.error(e);//æŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°å‡ºæ¥ return null;&#125;); å†è¯·æ±‚ä¸Šé¢çš„ Controller æ–¹æ³•çš„æ—¶å€™ï¼Œå‘çŽ°æŽ§åˆ¶å°å°±ä¼šæ‰“å°å‡ºå¦‚ä¸‹æ‰€ç¤ºçš„ Error ä¿¡æ¯: 1234567891011121314151617java.util.concurrent.CompletionException: org.springframework.orm.ObjectOptimisticLockingFailureException: Object of class [com.example.jpa.demo.db.UserInfo] with identifier [1]: optimistic locking failed; nested exception is org.hibernate.StaleObjectStateException: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect) : [com.example.jpa.demo.db.UserInfo#1] at java.base/java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:314) at java.base/java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:319) at java.base/java.util.concurrent.CompletableFuture$AsyncRun.run$$$capture(CompletableFuture.java:1739) at java.base/java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641) at java.base/java.lang.Thread.run(Thread.java:844)Caused by: org.springframework.orm.ObjectOptimisticLockingFailureException: Object of class [com.example.jpa.demo.db.UserInfo] with identifier [1]: optimistic locking failed; nested exception is org.hibernate.StaleObjectStateException: Row was updated or deleted by another transaction (or unsaved-value mapping was incorrect) : [com.example.jpa.demo.db.UserInfo#1] at org.springframework.orm.jpa.vendor.HibernateJpaDialect.convertHibernateAccessException(HibernateJpaDialect.java:337) at org.springframework.orm.jpa.vendor.HibernateJpaDialect.translateExceptionIfPossible(HibernateJpaDialect.java:255) at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186) at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:212) at com.sun.proxy.$Proxy116.save(Unknown Source) at com.example.jpa.demo.web.UserInfoController.lambda$testSaveUser$0(UserInfoController.java:57) at java.base/java.util.concurrent.CompletableFuture$AsyncRun.run$$$capture(CompletableFuture.java:1736) ... 4 more é€šè¿‡æŠ¥é”™ä¿¡æ¯ï¼Œå¯ä»¥å‘çŽ°å…¶å®žå°±æ˜¯å‘ç”Ÿäº†ä¹è§‚é”å¼‚å¸¸ï¼Œå¯¼è‡´ä¸Šé¢å®žä¾‹ä¸­çš„ç¬¬äºŒæ¬¡ save(user) å¿…ç„¶å¤±è´¥ï¼›è€Œç¬¬ä¸€æ¬¡ save(user) çš„å¤±è´¥ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨å¹¶å‘çš„æƒ…å†µä¸‹æœ‰å…¶ä»–è¯·æ±‚çº¿ç¨‹æ”¹å˜äº† UserInfo çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ”¹å˜äº† Versionã€‚ æ¥çœ‹ä¸€ä¸‹å®Œæ•´çš„ UserInfo å¯¹è±¡å®žä½“ã€‚ 12345678910111213141516171819202122232425262728@Entity@Data@SuperBuilder@AllArgsConstructor@NoArgsConstructor@ToString(callSuper = true)@Table@EntityListeners(&#123;AuditingEntityListener.class&#125;)public class UserInfo&#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; @Version private Integer version; @CreatedBy private Integer createUserId; @CreatedDate private Instant createTime; @LastModifiedBy private Integer lastModifiedUserId; @LastModifiedDate private Instant lastModifiedTime; private String name; private Integer ages; private String lastName; private String emailAddress; private String telephone;&#125; é€šè¿‡ @Version ä¹å…³é”æœºåˆ¶å°±æ˜¯é˜²æ­¢æ•°æ®è¢«è¦†ç›–ï¼›è€Œå®žé™…ç”Ÿäº§è¿‡ç¨‹ä¸­å…¶å®žå¾ˆéš¾å‘çŽ°ç±»ä¼¼é—®é¢˜ã€‚ æ‰€ä»¥å½“ä½¿ç”¨ä»»ä½•çš„å¼‚æ­¥çº¿ç¨‹å¤„ç†æ¡†æž¶çš„æ—¶å€™ï¼Œä¸€å®šè¦æƒ³å¥½å¼‚å¸¸æƒ…å†µä¸‹æ€Žä¹ˆæ‰“å°æ—¥å¿—ï¼Œå¦åˆ™å°±åƒé»‘æ´žä¸€æ ·ï¼Œå®Œå…¨ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆã€‚ é‚£ä¹ˆæ—¢ç„¶çŸ¥é“å‘ç”Ÿäº†ä¹è§‚é”å¼‚å¸¸ï¼Œè¿™é‡Œå°±æœ‰ä¸ªç–‘é—®äº†ï¼šåœ¨ UserInfoController çš„ testSaveUser æ–¹æ³•ä¸Šé¢åŠ äº† @Transaction çš„æ³¨è§£ï¼Œä¸ºä»€ä¹ˆäº‹åŠ¡æ²¡æœ‰å›žæ»šï¼Ÿ é€šè¿‡æ—¥å¿—æŸ¥çœ‹äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹çœ‹çœ‹å¼‚æ­¥è¯·æ±‚çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡åº”è¯¥æ€Žä¹ˆåšå‘¢ï¼Ÿå…ˆæ‰“å¼€äº‹åŠ¡çš„æ—¥å¿—ï¼Œçœ‹çœ‹ä¸Šé¢æ–¹æ³•çš„äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ 1234567## åœ¨ db çš„è¿žæŽ¥ä¸­å¼€å¯ logger=Slf4JLogger&amp;profileSQL=true çœ‹ä¸€ä¸‹æ¯ä¸ªäº‹åŠ¡é‡Œæ‰§è¡Œçš„ sql æœ‰å“ªäº›spring.datasource.url=jdbc:mysql://localhost:3306/test?logger=Slf4JLogger&amp;profileSQL=true## æ‰“å¼€ä¸‹é¢è¿™äº›ç±»çš„æ—¥å¿—çº§åˆ«ï¼Œè§‚å¯Ÿä¸€ä¸‹äº‹åŠ¡çš„å¼€å¯å’Œå…³é—­æ—¶æœºlogging.level.org.springframework.orm.jpa=DEBUGlogging.level.org.springframework.transaction=DEBUGlogging.level.org.springframework.orm.jpa.JpaTransactionManager=tracelogging.level.org.hibernate.engine.transaction.internal.TransactionImpl=DEBUG å†è¯·æ±‚ä¸€ä¸‹åˆšæ‰çš„æµ‹è¯•æŽ¥å£ï¼šPOST http://localhost:8087/test/async/user?name=jack å°±ä¼šäº§ç”Ÿä¸‹å›¾æ‰€ç¤ºçš„æ—¥å¿—ã€‚ å…ˆçœ‹ä¸€ä¸‹ä¸ŠåŠéƒ¨åˆ†ï¼Œé€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™å¼€å¯äº†ä¸¤ä¸ªäº‹åŠ¡ï¼Œåˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šã€‚ çº¿ç¨‹ 1ï¼š[nio-8087-exec-1] å¼€å¯äº† UserInfoController.testSaveUser æ–¹æ³•ä¸Šé¢çš„äº‹åŠ¡ï¼Œä¹Ÿå°±æ˜¯ http çš„è¯·æ±‚çº¿ç¨‹ï¼Œå¼€å¯äº†ä¸€ä¸ª Controller è¯·æ±‚äº‹åŠ¡ã€‚è¿™æ˜¯å› ä¸ºåœ¨ testSaveUser çš„æ–¹æ³•ä¸Šé¢åŠ äº† @Transaction çš„æ³¨è§£ï¼Œæ‰€ä»¥å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ã€‚ è€Œé€šè¿‡æ—¥å¿—å¯ä»¥å‘çŽ°ï¼Œäº‹åŠ¡ 1 é‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼ŒéšåŽå°±è¿›è¡Œäº† Commit æ“ä½œï¼Œæ‰€ä»¥çœ‹å¾—å‡ºæ¥ï¼Œé»˜è®¤ä¸åšä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡æ˜¯ä¸èƒ½è·¨çº¿ç¨‹çš„ã€‚æ¯ä¸ªçº¿ç¨‹é‡Œé¢çš„äº‹åŠ¡ç›¸äº’éš”ç¦»ã€äº’ä¸å½±å“ã€‚ çº¿ç¨‹ 2ï¼š[ task-1]ï¼Œé€šè¿‡å¼‚æ­¥çº¿ç¨‹æ± å¼€å¯äº† SimpleJpaRepository.findById æ–¹æ³•ä¸Šé¢çš„åªè¯»äº‹åŠ¡ã€‚è¿™æ˜¯å› ä¸ºé»˜è®¤çš„ SimpleJpaRepository ç±»ä¸Šé¢åŠ äº† @Transaction(readOnly=true) äº§ç”Ÿçš„ç»“æžœã€‚é€šè¿‡ MySQL çš„æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œæ­¤æ¬¡äº‹åŠ¡é‡Œé¢åªåšäº†å’Œä»£ç ç›¸å…³çš„ select user_info çš„æ“ä½œã€‚ å†çœ‹ä¸€ä¸‹åŽåŠéƒ¨åˆ†çš„æ—¥å¿—ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ é€šè¿‡åŽåŠéƒ¨åˆ†æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤æ¬¡ save(user) æ–¹æ³•ï¼Œä¹Ÿåˆ†åˆ«å¼€å¯äº†å„è‡ªçš„äº‹åŠ¡ï¼Œè¿™æ˜¯å› ä¸º SimpleJpaRepository.save æ–¹æ³•ä¸Šé¢æœ‰ @Transaction æ³¨è§£èµ·äº†ä½œç”¨ï¼Œè€Œç¬¬äºŒæ¬¡äº‹åŠ¡å› ä¸º JPA çš„å®žçŽ°æ–¹æ³•åˆ¤æ–­äº†æ•°æ®åº“è¿™æ¡æ•°æ®çš„ Version å’Œ UserInfo çš„å¯¹è±¡ä¸­çš„ Version ä¸ä¸€è‡´ï¼Œä»Žè€Œç¬¬äºŒæ¬¡è¿›è¡Œäº†å›žæ»šæ“ä½œã€‚ ä¸¤æ¬¡ save(user) çš„æ“ä½œé‡Œé¢åˆ†åˆ«æœ‰ä¸€æ¬¡ Select å’Œ Update è¯­ä¹‰ã€‚ä¸¤æ¬¡äº‹åŠ¡ï¼Œåˆ†åˆ«å¼€å¯äº†ä¸¤ä¸ª Sessionï¼Œæ‰€ä»¥å¯¹è±¡å¯¹äºŽè¿™ä¸¤æ¬¡ Session æ¥è¯´åˆ†åˆ«æ˜¯ä»Žæ¸¸ç¦»æ€ï¼ˆDetachedï¼‰è½¬æˆæŒä¹…æ€ï¼ˆPersistentï¼‰çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸¤ä¸ªç‹¬ç«‹çš„äº‹åŠ¡é‡Œé¢ï¼Œä¸€æ¬¡ Selectï¼Œä¸€æ¬¡ Updateã€‚ é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢ä¸€ä¸ªç®€å•çš„æ–¹æ³•ä¸­ä¸€å…±å‘ç”Ÿäº†å››æ¬¡äº‹åŠ¡ï¼Œéƒ½æ˜¯é‡‡ç”¨çš„é»˜è®¤éš”ç¦»çº§åˆ«å’Œä¼ æ’­æœºåˆ¶ã€‚é‚£ä¹ˆå¦‚æžœæƒ³è®©å¼‚æ­¥æ–¹æ³•é‡Œé¢åªæœ‰ä¸€ä¸ªäº‹åŠ¡åº”è¯¥æ€Žä¹ˆåŠžå‘¢ï¼Ÿ å¼‚æ­¥äº‹åŠ¡çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•å¼‚æ­¥æ–¹æ³•é‡Œé¢çš„äº‹åŠ¡æ˜¯ç‹¬ç«‹çš„ï¼Œé‚£ä¹ˆç›´æŽ¥æŠŠå¼‚æ­¥çš„ä»£ç å—ç”¨ç‹¬ç«‹çš„äº‹åŠ¡åŒ…è£…èµ·æ¥å³å¯ï¼Œåšæ³•æœ‰å¦‚ä¸‹å‡ ç§ï¼š ç¬¬ä¸€ç§å¤„ç†æ–¹æ³•ï¼šæŠŠå…¶ä¸­çš„å¼‚æ­¥ä»£ç å—ï¼Œç§»åˆ°ä¸€ä¸ªå¤–éƒ¨ç±»é‡Œé¢ã€‚è¿™é‡Œæ”¾åˆ° UserInfoService ä¸­ï¼ŒåŒæ—¶æ–¹æ³•ä¸­åŠ ä¸Š @Transaction æ³¨è§£ç”¨æ¥å¼€å¯äº‹åŠ¡ï¼ŒåŠ ä¸Š @Retryable æ³¨è§£è¿›è¡Œä¹è§‚é”é‡è¯•ï¼Œä»£ç å¦‚ä¸‹ã€‚ 1234567891011121314151617181920212223//åŠ ä¸Šäº‹åŠ¡ï¼Œè¿™æ ·å¯ä»¥åšåˆ°åŽŸå­æ€§ï¼Œè§£å†³äº‹åŠ¡åŠ åˆ°å¼‚å¸¸æ–¹æ³•ä¹‹å¤–æ²¡æœ‰ä»»ä½•ä½œç”¨çš„é—®é¢˜@Transactional//åŠ ä¸Šé‡è¯•æœºåˆ¶ï¼Œè¿™æ ·å½“å‘ç”Ÿä¹è§‚é”å¼‚å¸¸çš„æ—¶å€™ï¼Œé‡æ–°å°è¯•ä¸‹é¢çš„é€»è¾‘ï¼Œå‡å°‘è¯·æ±‚çš„å¤±è´¥æ¬¡æ•°@Retryable(value = ObjectOptimisticLockingFailureException.class,backoff = @Backoff(multiplier = 1.5,random = true))public void businessUserMethod(String name) &#123; UserInfo user = userInfoRepository.findById(1L).get(); //..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ”¹å˜UserInfoé‡Œé¢çš„å€¼ï¼› try &#123; Thread.sleep(200L);// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 200 æ¯«ç§’ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; user.setName(RandomUtils.nextInt(1,100000)+ "_first"+name); //æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼ userInfoRepository.save(user); //..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬äºŒæ¬¡æ”¹å˜ UserInfo é‡Œé¢çš„å€¼ï¼› try &#123; Thread.sleep(300L);// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶ 300 æ¯«ç§’ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; user.setName(RandomUtils.nextInt(1,100000)+ "_second"+name);//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº† UserInfo é‡Œé¢çš„å€¼ userInfoRepository.save(user);&#125; é‚£ä¹ˆ Controller é‡Œé¢åªéœ€è¦å˜æˆå¦‚ä¸‹å†™æ³•å³å¯ã€‚ 1234567891011121314151617/** * æ¨¡æ‹Ÿä¸€ä¸ªä¸šåŠ¡serviceæ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€äº›å¼‚æ­¥æ“ä½œï¼Œä¸€äº›ä¸šåŠ¡æ–¹æ³•é‡Œé¢å¯èƒ½ä¿®æ”¹äº†ä¸¤æ¬¡ç”¨æˆ·ä¿¡æ¯ * @param name * @return */@PostMapping("test/async/user")public String testSaveUser(String name) &#123; CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123; userInfoService.businessUserMethod(name); &#125;, executor).exceptionally(e -&gt; &#123; log.error(e);//æŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°å‡ºæ¥ return null; &#125;); //... å®žé™…ä¸šåŠ¡ä¸­ï¼Œå¯èƒ½è¿˜æœ‰ä¼šå…¶ä»–å¼‚æ­¥æ–¹æ³• cf.isDone(); return "Success";&#125; å†æ¬¡å‘èµ·ä¸€ä¸‹è¯·æ±‚ï¼Œçœ‹ä¸€ä¸‹æ—¥å¿—ã€‚ é€šè¿‡ä¸Šå›¾çš„æ—¥å¿—ï¼Œå¯ä»¥çŸ¥é“ä¸¤ä¸ªé‡è¦ä¿¡æ¯ï¼š è¿™ä¸ªæ—¶å€™åªæœ‰ UserInfoServiceImpl.businessUserMethod å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œè¿™æ˜¯å› ä¸º findById å’Œ Save æ–¹æ³•ä¸­ï¼Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶éƒ½æ˜¯â€œå¦‚æžœå­˜åœ¨äº‹åŠ¡å°±åˆ©ç”¨å½“å‰äº‹åŠ¡â€çš„åŽŸç†ï¼Œæ‰€ä»¥å°±ä¸ä¼šåƒä¸Šé¢ä¸€æ ·åˆ›å»ºå››æ¬¡äº‹åŠ¡äº†ï¼› è€Œæ­¤æ—¶ä¸¤æ¬¡ save(user) åªäº§ç”Ÿäº†ä¸€ä¸ª update çš„ sql è¯­å¥ï¼Œå¹¶ä¸”ä¹Ÿå¾ˆéš¾å‡ºçŽ°ä¹è§‚é”å¼‚å¸¸äº†ï¼Œå› ä¸ºè¿™æ˜¯ Session çš„æœºåˆ¶ï¼Œå°†ä¸¤æ¬¡å¯¹ UserInfo å®žä½“çš„æ“ä½œè¿›è¡Œäº†åˆå¹¶ï¼›æ‰€ä»¥ä½¿ç”¨ JPA çš„æ—¶å€™æŸç§ç¨‹åº¦ä¸Šä¹Ÿä¼šé™ä½Ž db çš„åŽ‹åŠ›ï¼Œå¢žåŠ ä»£ç çš„æ‰§è¡Œæ€§èƒ½ã€‚ è€Œå¦å¤–ä¸€ä¸ªä¾§è®ºï¼Œå°±æ˜¯å½“äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¶Šå¿«çš„æ—¶å€™ï¼Œå‘ç”Ÿå¼‚å¸¸çš„æ¦‚çŽ‡å°±ä¼šè¶Šä½Žï¼Œå› ä¸ºå¯ä»¥å‡å°‘å¹¶å‘å¤„ç†çš„æœºä¼šã€‚ ç¬¬äºŒç§å¤„ç†æ–¹æ³•ï¼šTransactionTemplate æ–¹æ³•å¼€å¯äº‹åŠ¡ ç¬¬ä¸‰ç§å¤„ç†æ–¹æ³•ï¼šå¯ä»¥å»ºä¸€ä¸ªè‡ªå·±çš„ TransactionHelperï¼Œå¹¶å¸¦ä¸Šé‡è¯•æœºåˆ¶ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567891011121314/** * åˆ©ç”¨springè¿›è¡Œç®¡ç† */@Componentpublic class TransactionHelper &#123; /** * åˆ©ç”¨ spring æœºåˆ¶å’Œ jdk8 çš„ Consumer æœºåˆ¶å®žçŽ°åªæ¶ˆè´¹çš„äº‹åŠ¡ */ @Transactional(rollbackFor = Exception.class) //å¯ä»¥æ ¹æ®å®žé™…ä¸šåŠ¡æƒ…å†µï¼ŒæŒ‡å®šæ˜Žç¡®çš„å›žæ»šå¼‚å¸¸ @Retryable(value = ObjectOptimisticLockingFailureException.class,backoff = @Backoff(multiplier = 1.5,random = true)) public void transactional(Consumer consumer,Object o) &#123; consumer.accept(o); &#125;&#125; Controller é‡Œé¢çš„å†™æ³•å¯ä»¥å˜æˆå¦‚ä¸‹æ–¹å¼ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·æ•ˆæžœã€‚ 123456789101112131415161718192021222324252627282930@PostMapping("test/async/user")public String testSaveUser(String name) &#123; CompletableFuture&lt;Void&gt; cf = CompletableFuture.runAsync(() -&gt; &#123; transactionHelper.transactional((param)-&gt;&#123; // é€šè¿‡lambdaå®žçŽ°äº‹åŠ¡ç®¡ç† UserInfo user = userInfoRepository.findById(1L).get(); //..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬ä¸€æ¬¡æ”¹å˜UserInfoé‡Œé¢çš„å€¼ï¼› try &#123; Thread.sleep(200L);// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶200æ¯«ç§’ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; user.setName(RandomUtils.nextInt(1,100000)+ "_first"+name); //æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼ userInfoRepository.save(user); //..... æ­¤å¤„æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œç¬¬äºŒæ¬¡æ”¹å˜UserInfoé‡Œé¢çš„å€¼ï¼› try &#123; Thread.sleep(300L);// åŠ ä¸Šå¤æ‚ä¸šåŠ¡è€—æ—¶300æ¯«ç§’ &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; user.setName(RandomUtils.nextInt(1,100000)+ "_second"+name);//æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼ userInfoRepository.save(user); &#125;,name); &#125;, executor).exceptionally(e -&gt; &#123; log.error(e);//æŠŠå¼‚å¸¸ä¿¡æ¯æ‰“å°å‡ºæ¥ return null; &#125;); //... å®žé™…ä¸šåŠ¡ä¸­ï¼Œå¯èƒ½è¿˜æœ‰ä¼šå…¶ä»–å¼‚æ­¥æ–¹æ³• cf.isDone(); return "Success";&#125; è¿™ç§æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡ Lambda è¡¨è¾¾å¼è§£å†³äº‹åŠ¡é—®é¢˜ã€‚ æ€»ä¹‹ï¼Œä¸ç®¡æ˜¯ä»¥ä¸Šå“ªç§æ–¹æ³•ï¼Œéƒ½å¯ä»¥è§£å†³æ‰€è¯´çš„å¼‚æ­¥äº‹åŠ¡çš„é—®é¢˜ã€‚æ‰€ä»¥æžæ¸…æ¥šäº‹åŠ¡çš„èƒŒåŽå®žçŽ°é€»è¾‘ï¼Œå°±å¾ˆå®¹æ˜“è§£å†³ç±»ä¼¼é—®é¢˜äº†ã€‚ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¸ºä»€ä¹ˆå½“å¼‚æ­¥æ–¹æ³•ä¸­æ˜¯åŒä¸€ä¸ªäº‹åŠ¡çš„æ—¶å€™ï¼Œç¬¬äºŒæ¬¡ save(user) å°±æˆåŠŸäº†ï¼Ÿè€Œå¼‚æ­¥ä»£ç å—é‡Œé¢çš„ä¸¤ä¸ª save(user) åˆ†åˆ«åœ¨ä¸¤ä¸ªäº‹åŠ¡é‡Œé¢ï¼Œç¬¬äºŒæ¬¡å°±ä¸æˆåŠŸäº†å‘¢ï¼Ÿ Session çš„æœºåˆ¶ä¸Ž Repository.save(entity) æ˜¯ä»€ä¹ˆå…³ç³»ï¼ŸEntity æœ‰ä¸åŒçš„çŠ¶æ€ã€‚ åœ¨ä¸€ä¸ª Session é‡Œé¢ï¼Œå¦‚æžœé€šè¿‡ findById(id) å¾—åˆ°ä¸€ä¸ª Entityï¼Œå®ƒå°±ä¼šå˜æˆ Managerï¼ˆpersistï¼‰ æŒä¹…æ€ã€‚é‚£ä¹ˆåŒä¸€ä¸ª Session é‡Œé¢ï¼ŒåŒä¸€ä¸ª Entity å¤šæ¬¡æ“ä½œ Hibernate å°±ä¼šè¿›è¡Œ Merge æ“ä½œã€‚ æ‰€ä»¥ä¸Šé¢çš„å®žä¾‹ä¸­ï¼Œå½“åœ¨ businessUserMethod æ–¹æ³•ä¸Šé¢åŠ  @Transaction çš„æ—¶å€™ï¼Œä¼šé€ æˆå¼‚æ­¥ä»£ç çš„æ•´å—é€»è¾‘å¤„äºŽåŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢ï¼Œ åŒä¸€ä¸ªäº‹åŠ¡å°±ä¼šå…±äº«åŒä¸€ä¸ª Sessionï¼Œæ‰€ä»¥åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢çš„ findByIdã€saveã€save çš„å¤šæ¬¡æ“ä½œéƒ½æ˜¯åŒä¸€ä¸ªå®žä¾‹ã€‚ ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¯ä»¥é€šè¿‡è®¾ç½® Debug æ–­ç‚¹ï¼ŒæŸ¥çœ‹ä¸€ä¸‹å¯¹è±¡çš„å†…å­˜å¯¹è±¡åœ°å€æ˜¯å¦ä¸€æ ·ï¼Œå°±å¯ä»¥çœ‹å¾—å‡ºæ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒfindById ä¹‹åŽå’Œä¸¤æ¬¡ save ä¹‹åŽéƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ è€Œå¦‚æžœè·¨ Session ä¼ é€’å®žä½“å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ª Session é‡Œé¢æŒä¹…æ€çš„å¯¹è±¡ï¼Œå¯¹äºŽå¦å¤–ä¸€ä¸ª Session æ¥è¯´å°±æ˜¯ä¸€ä¸ªDetachedï¼ˆæ¸¸ç¦»æ€ï¼‰çš„å¯¹è±¡ã€‚ è€Œæ ¹æ® Session é‡Œé¢çš„ Persistent Context çš„åŽŸç†ï¼Œä¸€æ—¦è¿™ä¸ªæ¸¸ç¦»æ€çš„å¯¹è±¡è¿›è¡Œ db æ“ä½œï¼ŒSession ä¼š Copy ä¸€ä¸ªæ–°çš„å®žä½“å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ä¸åœ¨å¼‚æ­¥ä»£ç ä¸­åŠ äº‹åŠ¡çš„æ—¶å€™ï¼Œå³åŽ»æŽ‰å¼‚æ­¥ä»£ç å— businessUserMethod æ–¹æ³•ä¸­çš„ @Transaction æ³¨è§£ï¼ŒfindById ä¹‹åŽå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€æ–°çš„ Sessionï¼Œé‚£ä¹ˆè¿”å›žçš„å°±æ˜¯å¯¹è±¡ 1ï¼›ç¬¬ä¸€æ¬¡ Save ä¹‹åŽï¼Œç”±äºŽåˆæ˜¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€æ–°çš„ Sessionï¼Œé‚£ä¹ˆè¿”å›žçš„å®žä½“ u2 å°±æ˜¯å¯¹è±¡ 2ã€‚ çŸ¥é“è¿™ä¸ªåŽŸç†ä¹‹åŽï¼Œå¯¹ä»£ç åšå¦‚ä¸‹æ”¹åŠ¨ã€‚ 12345678// @Transactional åŽ»æŽ‰äº‹åŠ¡ public void businessUserMethod(String name) &#123; UserInfo user = userInfoRepository.findById(1L).get(); user.setName(RandomUtils.nextInt(1,100000)+ "_first"+name); //æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼ UserInfo u2 = userInfoRepository.save(user); user.setName(RandomUtils.nextInt(1,100000)+ "_second"+name); //æ¨¡æ‹Ÿä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæ”¹å˜äº†UserInfoé‡Œé¢çš„å€¼ UserInfo u3 = userInfoRepository.save(u2);// ç¬¬äºŒæ¬¡saveé‡‡ç”¨ç¬¬ä¸€æ¬¡saveçš„è¿”å›žç»“æžœï¼Œè¿™æ ·é‡Œé¢å¸¦æœ‰äº†æœ€æ–°çš„versionçš„å€¼ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¼šä¿å­˜æˆåŠŸ&#125; å¼‚æ­¥é‡Œé¢è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºä¹è§‚é”çš„åŽŸç†æ˜¯ Version å˜äº†ï¼Œæˆ‘ä»¬ç”¨æœ€æ–°çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æœ€æ–°çš„ Version å°±å¯ä»¥äº†ã€‚ è®¾ç½®ä¸€ä¸ªæ–­ç‚¹çœ‹ä¸€ä¸‹ userã€u2ã€u3 åœ¨ä¸åŒçš„ Session ä½œç”¨åŸŸä¹‹åŽï¼Œå°±å˜æˆä¸åŒçš„å®žä¾‹äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ æ€è€ƒ åœ¨ä¸Šé¢ Demo ä¸­çš„å¼‚æ­¥åœºæ™¯ä¸‹è®¾ç½® open-in-view ç­‰äºŽ true / falseï¼Œä¼šå¯¹ä¸Šé¢çš„æµ‹è¯•ç»“æžœæœ‰å½±å“å—ï¼Ÿ ç­”æ¡ˆæ˜¯ è‚¯å®šæ²¡æœ‰å½±å“çš„ï¼Œspring.jpa.open-in-view çš„æœ¬è´¨è¿˜æ˜¯å¼€å¯ Sessionï¼Œè€Œä¿æŒä½ Session çš„æœ¬è´¨è¿˜æ˜¯åˆ©ç”¨ ThreadLocalï¼Œä¹Ÿå°±æ˜¯å¿…é¡»ä¸ºåŒä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹æ‰é€‚ç”¨ã€‚æ‰€ä»¥å¼‚æ­¥åœºæ™¯ä¸å— spring.jpa.open-in-view æŽ§åˆ¶ã€‚ å¦‚æžœæ˜¯å¤§é‡çš„å¼‚æ­¥æ“ä½œ db connection çš„æŒæœ‰æ¨¡å¼ï¼Œåº”è¯¥é…ç½®æˆå“ªä¸€ç§æ¯”è¾ƒåˆé€‚ï¼Ÿ ç­”æ¡ˆæ˜¯ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTIONï¼Œå› ä¸ºè¿™æ ·å¯ä»¥åšåˆ°å¯¹ db è¿žæŽ¥æœ€å¤§çš„åˆ©ç”¨çŽ‡ã€‚ç”¨çš„æ—¶å€™å°±èŽ·å–ï¼Œäº‹åŠ¡æäº¤å®Œå°±é‡Šæ”¾ï¼Œè¿™æ ·å°±ä¸ç”¨å…³å¿ƒä¸šåŠ¡é€»è¾‘æ‰§è¡Œå¤šé•¿æ—¶é—´äº†ã€‚ æ€»ç»“åœ¨å¼€å‘ä¸šåŠ¡ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦æ€è€ƒä¸€ä¸‹å‡ ä¸ªé—®é¢˜ ä¸€ä¸ªè¯·æ±‚ï¼Œå¼€å¯äº†å‡ æ¬¡äº‹åŠ¡ï¼Ÿå‡ æ¬¡ Sessionï¼Ÿåœ¨ä»€ä¹ˆæ—¶æœºå¼€å¯çš„ï¼Ÿ äº‹åŠ¡å’Œ Session åˆ†åˆ«ä¼šå¯¹å®žä½“çš„çŠ¶æ€æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ ä¸€ä¸ªè¯·æ±‚ï¼Œå¯¹ db è¿žæŽ¥æ± é‡Œé¢çš„è¿žæŽ¥æŒæœ‰æ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ ä¸€ä¸ªè¯·æ±‚ï¼Œæ€§èƒ½æŒ‡æ ‡éƒ½æœ‰å“ªäº›å†³å®šå› ç´ ï¼Ÿ]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa Session çš„ OpenInView å¯¹äº‹åŠ¡çš„å½±å“]]></title>
    <url>%2F2021%2F01%2F08%2FSpringDataJpa%E7%9A%84Session%E7%9A%84OpenInView%E5%AF%B9%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%BD%B1%E5%93%8D%2F</url>
    <content type="text"><![CDATA[Session çš„ OpenInView å¯¹äº‹åŠ¡çš„å½±å“Spring æ–°å¢žäº†ä¸€ä¸ª spring.jpa.open-in-view çš„é…ç½®ï¼Œä½†æ˜¯ Hibernate æœ¬èº«å´æ²¡æœ‰è¿™ä¸ªé…ç½®ï¼Œä¸è¿‡å…¶åˆæ˜¯å’Œ Hibernate ä¸­çš„ Session ç›¸å…³çš„ Session æ˜¯ä»€ä¹ˆ å…¶ä¸­ï¼ŒSessionImpl æ˜¯ Hibernate å®žçŽ° JPA åè®®çš„ EntityManager çš„ä¸€ç§å®žçŽ°æ–¹å¼ï¼Œå³å®žçŽ°ç±»ï¼›è€Œ Session æ˜¯ Hibernate ä¸­çš„æ¦‚å¿µï¼Œå®Œå…¨ç¬¦åˆ EntityManager çš„æŽ¥å£åè®®ï¼ŒåŒæ—¶åˆå®Œæˆäº† Hibernate çš„ç‰¹æ®Šå®žçŽ°ã€‚ åœ¨ Spring Data JPA çš„æ¡†æž¶ä¸­ï¼Œå¯ä»¥ç‹­éš˜åœ°æŠŠ Session ç†è§£ä¸º EntityManagerï¼Œå› ä¸ºå…¶å¯¹äºŽ JPA çš„ä»»ä½•æ“ä½œéƒ½æ˜¯é€šè¿‡ EntityManager çš„æŽ¥å£è¿›è¡Œçš„ï¼Œå¯ä»¥æŠŠ Session é‡Œé¢çš„å¤æ‚é€»è¾‘å½“æˆä¸€ä¸ªé»‘ç›’å­ã€‚å³ä½¿ SessionImpl èƒ½å¤Ÿå®žçŽ° Hibernate çš„ Session æŽ¥å£ï¼Œä½†å¦‚æžœä½¿ç”¨çš„æ˜¯ Spring Data JPAï¼Œé‚£ä¹ˆå®žçŽ°å†å¤šçš„æŽ¥å£ä¹Ÿå’Œ Spring Data JPA æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ é™¤éžä¸ç”¨ JPA çš„æŽ¥å£ï¼Œç›´æŽ¥ç”¨ Hibernate çš„ Native æ¥å®žçŽ°ï¼Œä½†æ˜¯ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºè¿‡ç¨‹å¤ªå¤æ‚äº†ã€‚ SessionImpl è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿé€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ï¼Œè¯·çœ‹ä¸‹é¢è¿™å¼ å›¾ã€‚ é€šè¿‡ SessionImpl çš„æºç å’Œ Structure çš„è§†å›¾ï¼Œå¯ä»¥â€œç®€å•ç²—æš´â€åœ°å¾—å‡ºå¦‚ä¸‹ç»“è®ºã€‚ SessionImpl æ˜¯ EntityManager çš„å®žçŽ°ç±»ï¼Œå…¶å®žçŽ°äº† JPA åè®®è§„å®šçš„ EntityManager çš„æ‰€æœ‰åŠŸèƒ½ï¼›å¦‚ï¼šEntityManager æš´éœ²çš„ flushModel çš„è®¾ç½®ï¼›EntityManager å¯¹ Transaction åšäº†â€œæ˜¯å¦å¼€å¯æ–°äº‹åŠ¡â€â€œæ˜¯å¦å…³é—­å½“å‰äº‹åŠ¡â€çš„é€»è¾‘ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒSessionImpl å®žçŽ°äº† PersistenceContext å¯¹è±¡å®žä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œä½¿å¾— PersistenceContext ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ Session çš„ç”Ÿå‘½å‘¨æœŸã€‚æ‰€ä»¥å¯ä»¥æŠ½è±¡åœ°ç†è§£ä¸ºï¼ŒSession æ˜¯å¯¹ä¸€äº›æ•°æ®åº“çš„æ“ä½œï¼Œéœ€è¦æ”¾åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡çš„é›†åˆä¸­ï¼Œå°±æ˜¯å¸¸è¯´çš„ä¸€çº§ç¼“å­˜ã€‚ Session çš„ open å’Œ close æ“ä½œï¼š open çš„æ—¶å€™åšäº†â€œæ˜¯å¦å¼€å¯äº‹åŠ¡â€â€œæ˜¯å¦èŽ·å–è¿žæŽ¥â€ç­‰é€»è¾‘ï¼› close çš„æ—¶å€™åšäº†â€œæ˜¯å¦å…³é—­äº‹åŠ¡â€â€œé‡Šæ”¾è¿žæŽ¥â€ç­‰åŠ¨ä½œï¼› Session çš„ä»»ä½•æ“ä½œéƒ½ç¦»ä¸å¼€äº‹åŠ¡å’Œè¿žæŽ¥ï¼Œé‚£ä¹ˆè‚¯å®šç”¨å½“å‰çº¿ç¨‹ä¿å­˜äº†è¿™äº›èµ„æºã€‚ JPA é‡Œé¢çš„ open-in-view æ˜¯åšä»€ä¹ˆçš„ï¼Ÿopen-in-view æ˜¯ Spring Boot è‡ªåŠ¨åŠ è½½ Spring Data JPA æä¾›çš„ä¸€ä¸ªé…ç½®ï¼Œå…¨ç§°ä¸º spring.jpa.open-in-view=trueï¼Œå®ƒåªæœ‰ true å’Œ false ä¸¤ä¸ªå€¼ï¼Œé»˜è®¤æ˜¯ trueã€‚ open-in-view çš„ä½œç”¨åœ¨ JpaBaseConfiguration ä¸­æ‰¾åˆ°å…³é”®æºç ï¼Œé€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ open-in-view éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516171819202122232425262728293031323334353637public abstract class JpaBaseConfiguration implements BeanFactoryAware &#123;@Configuration(proxyBeanMethods = false)@ConditionalOnWebApplication(type = Type.SERVLET)@ConditionalOnClass(WebMvcConfigurer.class)//è¿™ä¸ªæä¾›äº†ä¸€ç§è‡ªå®šä¹‰æ³¨å†Œ OpenEntityManagerInViewInterceptor æˆ–è€… OpenEntityManagerInViewFilter çš„å¯èƒ½ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ Web çš„ MVC å±‚æ‰“å¼€ session çš„ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ Interceptorï¼Œå¦å¤–ä¸€ç§æ˜¯ Filterï¼›è¿™ä¸¤ä¸ªç±»ä»»é€‰å…¶ä¸€å³å¯ï¼Œé»˜è®¤ç”¨çš„æ˜¯ OpenEntityManagerInViewInterceptor.class;@ConditionalOnMissingBean(&#123; OpenEntityManagerInViewInterceptor.class, OpenEntityManagerInViewFilter.class &#125;)@ConditionalOnMissingFilterBean(OpenEntityManagerInViewFilter.class)//è¿™é‡Œä½¿ç”¨äº† spring.jpa.open-in-view çš„é…ç½®ï¼Œåªæœ‰ä¸º true çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œè¿™ä¸ªé…ç½®ç±»ï¼Œå½“ä»€ä¹ˆéƒ½æ²¡é…ç½®çš„æ—¶å€™ï¼Œé»˜è®¤å°±æ˜¯ trueï¼Œä¹Ÿå°±æ˜¯é»˜è®¤æ­¤é…ç½®æ–‡ä»¶å°±ä¼šè‡ªåŠ¨åŠ è½½ï¼›æˆ‘ä»¬å¯ä»¥è®¾ç½®æˆ falseï¼Œå…³é—­åŠ è½½ï¼›@ConditionalOnProperty(prefix = "spring.jpa", name = "open-in-view", havingValue = "true", matchIfMissing = true)protected static class JpaWebConfiguration &#123; private static final Log logger = LogFactory.getLog(JpaWebConfiguration.class); private final JpaProperties jpaProperties; protected JpaWebConfiguration(JpaProperties jpaProperties) &#123; this.jpaProperties = jpaProperties; &#125;//å…³é”®é€»è¾‘åœ¨ OpenEntityManagerInViewInterceptor ç±»é‡Œé¢ï¼›åŠ è½½ OpenEntityManagerInViewInterceptor ç”¨æ¥åœ¨MVCçš„æ‹¦æˆªå™¨é‡Œé¢æ‰“å¼€ EntityManagerï¼Œè€Œå½“æˆ‘ä»¬æ²¡æœ‰é…ç½® spring.jpa.open-in-view çš„æ—¶å€™ï¼Œçœ‹ä¸‹é¢ä»£ç  spring å®¹å™¨ä¼šæ‰“å° warn æ—¥å¿—è­¦å‘Šæˆ‘ä»¬ï¼Œé»˜è®¤å¼€å¯äº† open-in-viewï¼Œæé†’æˆ‘ä»¬éœ€è¦æ³¨æ„å½±å“é¢ã€‚ @Bean public OpenEntityManagerInViewInterceptor openEntityManagerInViewInterceptor() &#123; if (this.jpaProperties.getOpenInView() == null) &#123; logger.warn("spring.jpa.open-in-view is enabled by default. " + "Therefore, database queries may be performed during view " + "rendering. Explicitly configure spring.jpa.open-in-view to disable this warning"); &#125; return new OpenEntityManagerInViewInterceptor(); &#125; //åˆ©ç”¨ WebMvcConfigurer åŠ è½½ä¸Šé¢çš„ OpenEntityManagerInViewInterceptor æ‹¦æˆªå™¨è¿›å…¥åˆ°MVCé‡Œé¢ï¼› @Bean public WebMvcConfigurer openEntityManagerInViewInterceptorConfigurer( OpenEntityManagerInViewInterceptor interceptor) &#123; return new WebMvcConfigurer() &#123; @Override public void addInterceptors(InterceptorRegistry registry) &#123; registry.addWebRequestInterceptor(interceptor); &#125; &#125;; &#125;&#125;.....//å…¶ä»–ä¸é‡è¦çš„ä»£ç çœç•¥ é€šè¿‡ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œspring.jpa.open-in-view çš„ä¸»è¦ä½œç”¨å°±æ˜¯å¸®æˆ‘ä»¬åŠ è½½ OpenEntityManagerInViewInterceptor è¿™ä¸ªç±» OpenEntityManagerInViewInterceptor æºç åˆ†æžæ‰“å¼€è¿™ä¸€æºç åŽï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾æ‰€ç¤ºçš„ç•Œé¢ã€‚ å¯ä»¥å‘çŽ°ï¼ŒOpenEntityManagerInViewInterceptor å®žçŽ°äº† WebRequestInterceptor çš„æŽ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼š public void preHandle(WebRequest request) ï¼šé‡Œé¢å®žçŽ°äº†åœ¨æ¯æ¬¡çš„ Web MVC è¯·æ±‚ä¹‹å‰ï¼Œé€šè¿‡ createEntityManager æ–¹æ³•åˆ›å»º EntityManager å’Œ EntityManagerHolder çš„é€»è¾‘ï¼› public void afterCompletion(WebRequest request, @Nullable Exception ex) ï¼šé‡Œé¢å®žçŽ°äº†åœ¨æ¯æ¬¡ Web MVC çš„è¯·æ±‚ç»“æŸä¹‹åŽï¼Œå…³é—­ EntityManager çš„é€»è¾‘ã€‚ ç»§ç»­çœ‹ createEntityManager æ–¹æ³•çš„å®žçŽ°ï¼Œæ‰¾åˆ°å¦‚ä¸‹å…³é”®ä»£ç ï¼š ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ SessionFactoryImpl ä¸­çš„ createEntityManager() æ–¹æ³•ï¼Œ åˆ›å»ºäº†ä¸€ä¸ª EntityManager çš„å®žçŽ° Sessionï¼› é€šè¿‡æ‹¦æˆªå™¨åˆ›å»ºäº† EntityManager äº‹åŠ¡å¤„ç†é€»è¾‘ï¼Œé»˜è®¤æ˜¯ Join ç±»åž‹ï¼ˆå³æœ‰äº‹åŠ¡å­˜åœ¨ä¼šåŠ å…¥ï¼‰ï¼› builder.openSession() é€»è¾‘å°±æ˜¯ new SessionImpl(sessionFactory, this)ã€‚ æ‰€ä»¥ï¼šé€šè¿‡ open-in-view é…ç½®çš„æ‹¦æˆªå™¨ï¼Œä¼šå¸®æˆ‘ä»¬çš„æ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºä¸€ä¸ª SessionImpl å®žä¾‹ï¼›è€Œ SessionImpl é‡Œé¢å­˜å‚¨äº†æ•´ä¸ª PersistenceContext å’Œå„ç§äº‹åŠ¡è¿žæŽ¥çŠ¶æ€ï¼Œå¯ä»¥åˆ¤æ–­å‡ºæ¥ Session çš„å®žä¾‹å¯¹è±¡æ¯”è¾ƒå¤§ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ‰“å¼€ spring.jap.open-in-view=true ä¼šå‘çŽ°ï¼Œå¦‚æžœä¸€ä¸ªè¯·æ±‚å¤„ç†çš„é€»è¾‘æ¯”è¾ƒè€—æ—¶ï¼Œç‰µæ¶‰åˆ°çš„å¯¹è±¡æ¯”è¾ƒå¤šï¼Œè¿™ä¸ªæ—¶å€™å°±æ¯”è¾ƒè€ƒéªŒæˆ‘ä»¬å¯¹ jvm çš„å†…å­˜é…ç½®ç­–ç•¥äº†ï¼Œå¦‚æžœé…ç½®ä¸å¥½å°±ä¼šç»å¸¸å‡ºçŽ°å†…å­˜æº¢å‡ºçš„çŽ°è±¡ã€‚å› æ­¤å½“å¤„ç†æ¯”è¾ƒè€—æ—¶çš„è¯·æ±‚å’Œæ‰¹é‡å¤„ç†è¯·æ±‚çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚ EntityManager(Session) çš„æ‰“å¼€æ—¶æœºåŠæ‰©å±•åœºæ™¯é€šè¿‡ IDEA ï¼Œç›´æŽ¥ç‚¹å‡»å³é”®æŸ¥ public Session createEntityManager() æ­¤æ–¹æ³•è¢«ä½¿ç”¨åˆ°çš„åœ°æ–¹å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶ä¸­ï¼ŒEntityManagerFactoryAccessor æ˜¯ OpenEntityManagerInViewInterceptor çš„çˆ¶ç±»ï¼Œä»Žå›¾ä¸Šå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼ŒSession çš„åˆ›å»ºï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯ EntityManager çš„åˆ›å»ºï¼‰å¯¹æˆ‘ä»¬æœ‰ç”¨çš„æ—¶æœºï¼Œç›®å‰å°±æœ‰ä¸‰ç§ã€‚ ç¬¬ä¸€ç§ï¼šWeb View Interceptorï¼Œé€šè¿‡ spring.jpa.open-in-view æŽ§åˆ¶ã€‚ ç¬¬äºŒç§ï¼šWeb Filterï¼Œè¿™ç§æ–¹å¼æ˜¯ Spring ç»™æˆ‘ä»¬æä¾›çš„å¦å¤–ä¸€ç§åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚æœ‰äº›è€—æ—¶çš„ã€æ‰¹é‡å¤„ç†çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä¸æƒ³åœ¨è¯·æ±‚çš„æ—¶å€™å¼€å¯ Sessionï¼Œè€Œæ˜¯æƒ³åœ¨å¤„ç†ç®€å•é€»è¾‘åŽï¼Œéœ€è¦ç”¨åˆ°å»¶è¿ŸåŠ è½½æœºåˆ¶çš„è¯·æ±‚æ—¶ Open Sessionã€‚å› ä¸ºå¼€å¯ Session åŽï¼Œæˆ‘ä»¬å†™æ¡†æž¶ä»£ç çš„æ—¶å€™å¯ä»¥åˆ©ç”¨ lazy æœºåˆ¶ã€‚è€Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ OpenEntityManagerInViewFilterï¼Œé…ç½®è¯·æ±‚ filter çš„è¿‡æ»¤æœºåˆ¶ï¼Œå®žçŽ°ä¸åŒçš„è¯·æ±‚ä»¥åŠä¸åŒ Open Session çš„é€»è¾‘äº†ã€‚ ç¬¬ä¸‰ç§ï¼šJPA Transactionï¼Œè¿™ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨ JpaTransactionManagerï¼Œå®žçŽ°åœ¨äº‹åŠ¡å¼€å¯çš„æ—¶å€™æ‰“å¼€ Sessionï¼Œåœ¨äº‹åŠ¡ç»“æŸçš„æ—¶å€™å…³é—­ Sessionã€‚ é»˜è®¤æƒ…å†µä¸‹ Session çš„å¼€å¯æ—¶æœºæœ‰ä¸¤ä¸ªï¼š æ¯ä¸ªè¯·æ±‚ä¹‹å‰ æ–°çš„äº‹åŠ¡å¼€å¯ä¹‹å‰ Session çš„å…³é—­æ—¶æœºæ˜¯ä¸¤ä¸ªï¼š æ¯ä¸ªè¯·æ±‚ç»“æŸä¹‹åŽ äº‹åŠ¡å…³é—­ä¹‹åŽ æ­¤å¤–ï¼ŒEntityManager(Session) æ‰“å¼€ä¹‹åŽï¼Œèµ„æºå­˜å‚¨åœ¨å½“å‰çº¿ç¨‹é‡Œé¢ ï¼ˆThreadLocalï¼‰ï¼Œæ‰€ä»¥ä¸€ä¸ª Session ä¸­å³ä½¿å¼€å¯äº†å¤šä¸ªäº‹åŠ¡ï¼Œä¹Ÿä¸ä¼šåˆ›å»ºå¤šä¸ª EntityManager æˆ–è€… Sessionã€‚ è€Œäº‹åŠ¡åœ¨å…³é—­ä¹‹å‰ï¼Œä¹Ÿä¼šæ£€æŸ¥ä¸€ä¸‹æ­¤ EntityManager / Session æ˜¯ä¸æ˜¯æˆ‘è¿™ä¸ªäº‹åŠ¡åˆ›å»ºçš„ï¼Œå¦‚æžœæ˜¯å°±å…³é—­ï¼Œå¦‚æžœä¸æ˜¯å°±ä¸å…³é—­ï¼Œä¸è¿‡å…¶ä¸ä¼šå…³é—­åœ¨äº‹åŠ¡èŒƒå›´ä¹‹å¤–åˆ›å»ºçš„ EntityManager / Sessionã€‚ è¿™ä¸ªæœºåˆ¶å…¶å®žè¿˜ç»™æˆ‘ä»¬ä¸€äº›é¢å¤–æ€è€ƒï¼šæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è‡ªç”±é€‰æ‹©å¼€å¯ / å…³é—­ Session å‘¢ï¼Ÿä¸ä¸€å®šæ˜¯ view / filter / äº‹åŠ¡ï¼Œä»»ä½•å¤šäº‹åŠ¡ç»„åˆçš„ä»£ç æ¨¡å—éƒ½å¯ä»¥ã€‚åªè¦æˆ‘ä»¬çŸ¥é“ä»€ä¹ˆæ—¶é—´å¼€å¯ï¼Œä¿è¯ä¸€å®šèƒ½ close å°±æ²¡æœ‰é—®é¢˜ã€‚ ä¸‹é¢é€šè¿‡æ—¥å¿—æ¥çœ‹ä¸€ä¸‹ä¸¤ç§æ‰“å¼€ã€å…³é—­ EntityManager çš„æ—¶æœºã€‚ éªŒè¯ EntityManager çš„åˆ›å»ºå’Œé‡Šæ”¾çš„æ—¥å¿—ç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ª UserController çš„æ–¹æ³•ï¼Œç”¨æ¥æ¨¡æ‹Ÿè¯·æ±‚ä¸¤æ®µäº‹åŠ¡çš„æƒ…å†µï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º: 1234567891011@PostMapping("/user/info")public UserInfo saveUserInfo(@RequestBody UserInfo userInfo) &#123; UserInfo u2 = userInfoRepository.findById(1L).orElse(null); if (u2!=null) &#123; u2.setLastName("jack"+userInfo.getLastModifiedTime()); //æ›´æ–°u2ï¼Œæ–°å¼€å¯ä¸€ä¸ªäº‹åŠ¡ userInfoRepository.save(u2); &#125; //æ›´æ–°userInfoï¼Œæ–°å¼€å¯ä¸€ä¸ªäº‹åŠ¡ return userInfoRepository.save(userInfo);&#125; å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢è°ƒç”¨äº†ä¸¤ä¸ª save æ“ä½œï¼Œæ²¡æœ‰æŒ‡å®šäº‹åŠ¡ã€‚å› ä¸º userInfoRepository çš„å®žçŽ°ç±» SimpleJpaRepository çš„ save æ–¹æ³•ä¸Šé¢æœ‰ @Transactional æ³¨è§£ï¼Œæ‰€ä»¥æ¯ä¸ª userInfoRepository.save() æ–¹æ³•å°±ä¼šå¼€å¯æ–°çš„äº‹åŠ¡ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæœºåˆ¶åœ¨ä¸Šé¢çš„ Controller é‡Œé¢æ¨¡æ‹Ÿäº†ä¸¤ä¸ªäº‹åŠ¡ã€‚ ç¬¬äºŒæ­¥ï¼šæ‰“å¼€ open-in-viewï¼ŒåŒæ—¶ä¿®æ”¹ä¸€äº›æ—¥å¿—çº§åˆ«ï¼Œæ–¹ä¾¿è§‚å¯Ÿï¼Œé…ç½®å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼š 123456## æ‰“å¼€open-in-viewspring.jpa.open-in-view=true## ä¿®æ”¹æ—¥å¿—çº§åˆ«logging.level.org.springframework.orm.jpa.JpaTransactionManager=tracelogging.level.org.hibernate.internal=tracelogging.level.org.hibernate.engine.transaction.internal=trace ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨é¡¹ç›®ï¼Œå‘é€å¦‚ä¸‹è¯·æ±‚ã€‚ 123456#### updatePOST /user/info HTTP/1.1Host: 127.0.0.1:8087Content-Type: application/jsonCache-Control: no-cache&#123;"ages":10,"id":3,"version":0&#125; ç„¶åŽæŸ¥çœ‹ä¸€ä¸‹æ—¥å¿—ï¼Œå…³é”®æ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¯·æ±‚äº† user/info ä¹‹åŽå°±å¼€å¯äº† Sessionï¼Œç„¶åŽåœ¨ Controller æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å¼€å¯äº†ä¸¤æ®µäº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡ç»“æŸä¹‹åŽéƒ½æ²¡æœ‰å…³é—­ Sessionï¼Œè€Œæ˜¯ç­‰ä¸¤ä¸ªäº‹åŠ¡éƒ½ç»“æŸä¹‹åŽï¼Œå¹¶ä¸” Controller æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åŽï¼Œæ‰ Closing Session çš„ã€‚ä¸­é—´è¿‡ç¨‹åªåˆ›å»ºäº†ä¸€æ¬¡ Sessionã€‚ ç¬¬å››æ­¥ï¼šå…¶ä»–éƒ½ä¸å˜çš„å‰æä¸‹ï¼Œæˆ‘ä»¬æŠŠ open-in-view æ”¹æˆ falseï¼Œå¦‚ä¸‹é¢è¿™è¡Œä»£ç æ‰€ç¤ºã€‚ 1spring.jpa.open-in-view=false æˆ‘ä»¬å†æ‰§è¡Œåˆšæ‰çš„è¯·æ±‚ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹æ—¥å¿—ã€‚ é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­å¼€å¯äº†ä¸¤æ¬¡äº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡åˆ›å»ºä¹‹åŽéƒ½ä¼šåˆ›å»ºä¸€ä¸ª Sessionï¼Œå³å¼€å¯äº†ä¸¤ä¸ª Sessionï¼Œæ¯ä¸ª Session çš„ ID æ˜¯ä¸ä¸€æ ·çš„ï¼›åœ¨æ¯ä¸ªäº‹åŠ¡ç»“æŸä¹‹åŽå…³é—­äº† Sessionï¼Œå…³é—­äº† EntityManagerã€‚ é€šè¿‡ä¸Šé¢çš„äº‹ä¾‹å’Œæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° spring.jpa.open-in-view å¯¹ session å’Œäº‹åŠ¡çš„å½±å“ï¼Œé‚£ä¹ˆå®ƒå¯¹æ•°æ®åº“çš„è¿žæŽ¥æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿ hibernate.connection.handling_mode è¯¦è§£AvailableSettings ç±»ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä¸‰ä¸ªå…³é”®é…ç½®ï¼š 123456// æŒ‡å®šèŽ·å¾— db è¿žæŽ¥çš„æ–¹å¼ï¼Œhibernate5.2 ä¹‹åŽå·²ç»ä¸æŽ¨èä½¿ç”¨ï¼Œæ”¹ç”¨ hibernate.connection.handling_mode é…ç½®å½¢å¼String ACQUIRE_CONNECTIONS = "hibernate.connection.acquisition_mode";// é‡Šæ”¾è¿žæŽ¥çš„æ¨¡å¼æœ‰å“ªäº›ï¼Ÿhibernate5.2 ä¹‹åŽä¹Ÿä¸æŽ¨èä½¿ç”¨ï¼Œæ”¹ç”¨ hibernate.connection.handling_mode é…ç½®å½¢å¼String RELEASE_CONNECTIONS = "hibernate.connection.release_mode";//æŒ‡å®šèŽ·å–è¿žæŽ¥å’Œé‡Šæ”¾è¿žæŽ¥çš„æ¨¡å¼ï¼Œhibernate5.2 ä¹‹åŽæ–°å¢žçš„é…ç½®é¡¹ï¼Œä»£æ›¿ä¸Šé¢ä¸¤ä¸ªæ—§çš„é…ç½®String CONNECTION_HANDLING = "hibernate.connection.handling_mode"; é‚£ä¹ˆ hibernate.connection.handling_mode å¯¹åº”çš„é…ç½®æœ‰å“ªäº›å‘¢ï¼ŸHibernate 5 æä¾›äº†äº”ç§æ¨¡å¼ã€‚ PhysicalConnectionHandlingMode çš„äº”ç§æ¨¡å¼åœ¨ Hibernate 5.2 é‡Œé¢ï¼Œhibernate.connection.handling_mode è¿™ä¸ª Key å¯¹åº”çš„å€¼åœ¨ PhysicalConnectionHandlingMode æžšä¸¾ç±»é‡Œé¢æœ‰å®šä¹‰ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚ 12345678910111213141516public enum PhysicalConnectionHandlingMode &#123; IMMEDIATE_ACQUISITION_AND_HOLD( IMMEDIATELY, ON_CLOSE ), DELAYED_ACQUISITION_AND_HOLD( AS_NEEDED, ON_CLOSE ), DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT( AS_NEEDED, AFTER_STATEMENT ), DELAYED_ACQUISITION_AND_RELEASE_BEFORE_TRANSACTION_COMPLETION( AS_NEEDED, BEFORE_TRANSACTION_COMPLETION ), DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION( AS_NEEDED, AFTER_TRANSACTION ) ; private final ConnectionAcquisitionMode acquisitionMode; private final ConnectionReleaseMode releaseMode; PhysicalConnectionHandlingMode( ConnectionAcquisitionMode acquisitionMode, ConnectionReleaseMode releaseMode) &#123; this.acquisitionMode = acquisitionMode; this.releaseMode = releaseMode; &#125;......//ä¸é‡è¦ä»£ç å…ˆçœç•¥&#125; å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰äº”ç»„å€¼ï¼Œä¹Ÿå°±æ˜¯æŠŠåŽŸæ¥çš„ ConnectionAcquisitionMode å’Œ ConnectionReleaseMode åˆ†å¼€é…ç½®çš„æ¨¡å¼è¿›è¡Œäº†ç»„åˆé…ç½®ç®¡ç† IMMEDIATE_ACQUISITION_AND_HOLDï¼šç«‹å³èŽ·å–ï¼Œä¸€ç›´ä¿æŒè¿žæŽ¥åˆ° Session å…³é—­ã€‚ å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š Session ä¸€æ—¦æ‰“å¼€å°±ä¼šèŽ·å–è¿žæŽ¥ï¼› Session å…³é—­çš„æ—¶å€™é‡Šæ”¾è¿žæŽ¥ï¼› å¦‚æžœ open-in-view=true çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬çš„è¯·æ±‚é‡Œé¢æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œæˆ–è€…æœ‰ä¸€äº›è€—æ—¶æ“ä½œï¼Œä¼šå¯¼è‡´æ•°æ®åº“çš„è¿žæŽ¥é‡Šæ”¾ä¸åŠæ—¶ï¼Œä»Žè€Œå¯¼è‡´ DB è¿žæŽ¥ä¸å¤Ÿç”¨ï¼Œå¦‚æžœè¯·æ±‚é¢‘ç¹çš„è¯ï¼Œä¼šäº§ç”Ÿä¸å¿…è¦çš„ DB è¿žæŽ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæµªè´¹ CPU æ€§èƒ½ï¼› å®¹æ˜“äº§ç”Ÿ DB è¿žæŽ¥èŽ·å–æ—¶é—´è¿‡é•¿çš„çŽ°è±¡ï¼Œä»Žè€Œå¯¼è‡´è¯·æ±‚å“åº”æ—¶é—´å˜é•¿ã€‚ DELAYED_ACQUISITION_AND_HOLDï¼šå»¶è¿ŸèŽ·å–ï¼Œä¸€ç›´ä¿æŒè¿žæŽ¥åˆ° Session å…³é—­ã€‚ å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š è¡¨ç¤ºéœ€è¦çš„æ—¶å€™å†èŽ·å–è¿žæŽ¥ï¼Œéœ€è¦çš„æ—¶å€™æ˜¯æŒ‡è¿›è¡Œ DB æ“ä½œçš„æ—¶å€™ï¼Œè¿™é‡Œä¸»è¦æ˜¯æŒ‡äº‹åŠ¡æ‰“å¼€çš„æ—¶å€™ï¼Œå°±éœ€è¦èŽ·å–è¿žæŽ¥äº†ï¼ˆå› ä¸ºå¼€å¯äº‹åŠ¡çš„æ—¶å€™è¦æ‰§è¡Œâ€œAUTOCOMMIT=0â€çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œçš„æŒ‰éœ€å°±æ˜¯æŒ‡å¼€å¯äº‹åŠ¡ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥å…³é—­äº‹åŠ¡å¼€å¯çš„æ—¶å€™æ”¹å˜ AUTOCOMMIT çš„è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™çš„æŒ‰éœ€å°±æ˜¯æŒ‡æ‰§è¡Œ DB æ“ä½œçš„æ—¶å€™ï¼Œä¸ä¸€å®šå¼€å¯äº‹åŠ¡å°±ä¼šèŽ·å¾— DB çš„è¿žæŽ¥ï¼‰ï¼› å…³é—­è¿žæŽ¥çš„æ—¶æœºæ˜¯ Session Close çš„æ—¶å€™ï¼› ä¸€ä¸ª Session é‡Œé¢åªæœ‰ä¸€ä¸ªè¿žæŽ¥ï¼Œè€Œä¸€ä¸ªè¿žæŽ¥é‡Œé¢å¯ä»¥æœ‰å¤šæ®µäº‹åŠ¡ï¼›æ¯”è¾ƒé€‚åˆä¸€ä¸ªè¯·æ±‚æœ‰å¤šæ®µäº‹åŠ¡çš„åœºæ™¯ï¼› è¿™ä¸ªé…ç½®è§£å†³äº†ï¼Œå½“æ²¡æœ‰ DB æ“ä½œçš„æ—¶å€™ï¼Œå³æ²¡æœ‰äº‹åŠ¡çš„æ—¶å€™ä¸ä¼šèŽ·å–æ•°æ®åº“è¿žæŽ¥çš„é—®é¢˜ï¼›ä»Žè€Œå¯ä»¥å‡å°‘ä¸å¿…è¦çš„ DB è¿žæŽ¥åˆ‡æ¢ï¼› ä½†æ˜¯ä¸€æ—¦ä¸€ä¸ª Session åœ¨è¿›è¡Œäº† DB æ“ä½œä¹‹åŽï¼Œåˆåšäº†ä¸€äº›è€—æ—¶çš„æ“ä½œæ‰å…³é—­ï¼Œé‚£ä¹ˆä¹Ÿä¼šå¯¼è‡´ DB è¿žæŽ¥é‡Šæ”¾ä¸åŠæ—¶ï¼Œä»Žè€Œå¯¼è‡´ DB è¿žæŽ¥çš„åˆ©ç”¨çŽ‡ä½Žã€é«˜å¹¶å‘çš„æ—¶å€™è¯·æ±‚æ€§èƒ½ä¸‹é™ã€‚ DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENTï¼šå»¶è¿ŸèŽ·å–ï¼ŒStatement æ‰§è¡Œå®Œé‡Šæ”¾ã€‚ å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š è¡¨ç¤ºç­‰éœ€è¦çš„æ—¶å€™å†èŽ·å–è¿žæŽ¥ï¼Œä¸æ˜¯ Session ä¸€æ‰“å¼€å°±ä¼šèŽ·å–è¿žæŽ¥ï¼› åœ¨æ¯ä¸ª Statement çš„ SQL æ‰§è¡Œå®Œå°±é‡Šæ”¾è¿žæŽ¥ï¼Œä¸€æ—¦æœ‰äº‹åŠ¡æ¯ä¸ª SQL æ‰§è¡Œå®Œé‡Šæ”¾æ»¡è¶³ä¸äº†ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„äº‹åŠ¡æ¨¡å¼å°±ä¸ç”Ÿæ•ˆäº†ï¼› è¿™ç§æ–¹å¼é€‚åˆæ²¡æœ‰äº‹åŠ¡çš„æƒ…æ™¯ï¼Œå·¥ä½œä¸­ä¸å¸¸è§ï¼Œå¯èƒ½åˆ†å¸ƒå¼äº‹åŠ¡ä¸­æœ‰åœºæ™¯éœ€è¦ã€‚ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTIONï¼šå»¶è¿ŸèŽ·å–ï¼Œäº‹åŠ¡æ‰§è¡Œä¹‹åŽé‡Šæ”¾ã€‚ å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š è¡¨ç¤ºç­‰éœ€è¦çš„æ—¶å€™å†èŽ·å–è¿žæŽ¥ï¼Œä¸æ˜¯ Session ä¸€æ‰“å¼€å°±ä¼šèŽ·å–è¿žæŽ¥ï¼› åœ¨äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åŽé‡Šæ”¾è¿žæŽ¥ï¼ŒåŒä¸€ä¸ªäº‹åŠ¡å…±äº«ä¸€ä¸ªè¿žæŽ¥ï¼› è¿™ç§æƒ…å†µä¸‹ open-in-view çš„æ¨¡å¼å¯¹ DB è¿žæŽ¥çš„æŒæœ‰å’Œäº‹åŠ¡ä¸€æ ·äº†ï¼Œæ¯”è¾ƒé€‚åˆä¸€ä¸ªè¯·æ±‚é‡Œé¢äº‹åŠ¡æ¨¡å—ä¸å¤šè¯·æ±‚çš„æƒ…å†µï¼› å¦‚æžœäº‹åŠ¡éƒ½æŽ§åˆ¶åœ¨ Service å±‚ï¼Œè¿™ä¸ªé…ç½®å°±éžå¸¸å¥½ç”¨ï¼Œå…¶å¯¹ Connection çš„åˆ©ç”¨çŽ‡æ¯”è¾ƒé«˜ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥åšåˆ°ä¸æµªè´¹ï¼› è¿™ä¸ªé…ç½®ä¸é€‚åˆä¸€ä¸ª Session ç”Ÿå‘½å‘¨æœŸé‡Œé¢æœ‰å¾ˆå¤šç‹¬ç«‹äº‹åŠ¡çš„ä¸šåŠ¡æ¨¡å—ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šä½¿ä¸€ä¸ªè¯·æ±‚é‡Œé¢äº§ç”Ÿå¤§é‡æ²¡å¿…è¦çš„èŽ·å–è¿žæŽ¥ã€é‡Šæ”¾è¿žæŽ¥çš„è¿‡ç¨‹ã€‚ DELAYED_ACQUISITION_AND_RELEASE_BEFORE_TRANSACTION_COMPLETIONï¼šå»¶è¿ŸèŽ·å–ï¼Œäº‹åŠ¡æ‰§è¡Œä¹‹å‰é‡Šæ”¾ã€‚ å…¶å¯ä»¥ä»£è¡¨å¦‚ä¸‹å‡ å±‚å«ä¹‰ï¼š è¡¨ç¤ºç­‰éœ€è¦çš„æ—¶å€™å†èŽ·å–è¿žæŽ¥ï¼Œä¸æ˜¯ Session ä¸€æ‰“å¼€å°±ä¼šèŽ·å–è¿žæŽ¥ï¼› åœ¨äº‹åŠ¡æ‰§è¡Œå®Œä¹‹å‰é‡Šæ”¾è¿žæŽ¥ï¼Œè¿™ç§ä¸ä¿é™©ï¼Œä¹Ÿæ¯”è¾ƒå°‘ç”¨ã€‚ é»˜è®¤çš„æ¨¡å¼æ˜¯å“ªä¸ªï¼Ÿå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼ï¼Ÿæ‰“å¼€æºç  HibernateJpaVendorAdapter ç±»é‡Œé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹åŠ è½½æ–¹å¼ã€‚ Hibernate 5.2 ä»¥ä¸Šä½¿ç”¨çš„æ˜¯ DELAYED_ACQUISITION_AND_HOLD æ¨¡å¼ï¼Œå³æŒ‰éœ€èŽ·å–ã€Session å…³é—­é‡Šæ”¾ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ã€‚ 1jpaProperties.put("hibernate.connection.handling_mode", "DELAYED_ACQUISITION_AND_HOLD"); è€Œ Hibernate 5.1 ä»¥å‰æ˜¯é€šè¿‡è®¾ç½® release_mode ç­‰äºŽ ON_CLOSE çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯ Session å…³é—­é‡Šæ”¾ï¼Œå¦‚ä¸‹é¢è¿™æ®µä»£ç ã€‚ 1jpaProperties.put("hibernate.connection.release_mode", "ON_CLOSE"); é‚£ä¹ˆï¼Œå¦‚ä½•ä¿®æ”¹é»˜è®¤å€¼å‘¢ï¼Ÿç›´æŽ¥åœ¨ application.properties æ–‡ä»¶é‡Œé¢åšå¦‚ä¸‹ä¿®æ”¹å³å¯ã€‚ 12## æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æˆæŒ‰éœ€èŽ·å–è¿žæŽ¥ï¼Œäº‹åŠ¡æ‰§è¡Œå®Œä¹‹åŽé‡Šæ”¾è¿žæŽ¥spring.jpa.properties.hibernate.connection.handling_mode=DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION handling_mode çš„é…ç½®å¯¹è¿žæŽ¥çš„å½±å“ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä¸€ä¸‹ DELAYED_ACQUISITION_AND_HOLDï¼Œå³é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿žæŽ¥æ± çš„æƒ…å†µæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ æˆ‘ä»¬å¯¹é…ç½®æ–‡ä»¶åšå¦‚ä¸‹é…ç½®ã€‚ 123456## åœ¨æ‹¦æˆªMVCå±‚å¼€å¯ Sessionï¼Œæ¨¡æ‹Ÿé»˜è®¤æƒ…å†µï¼Œè¿™æ¡å¯ä»¥ä¸éœ€è¦é…ç½®spring.jpa.open-in-view=true## é‡‡ç”¨é»˜è®¤æƒ…å†µ DELAYED_ACQUISITION_AND_HOLDï¼Œè¿™æ¡ä¹Ÿä¸éœ€è¦é…ç½®spring.jpa.properties.hibernate.connection.handling_mode=DELAYED_ACQUISITION_AND_HOLD## å¼€å¯ hikari çš„æ•°æ®åº“è¿žæŽ¥æ± çš„ç›‘æŽ§ï¼šlogging.level.com.zaxxer.hikari=TRACE åœ¨ UserInfoController çš„å¦‚ä¸‹æ–¹æ³•é‡Œé¢ï¼Œé€šè¿‡ Thread.sleepï¼ˆ2 åˆ†é’Ÿï¼‰æ¨¡æ‹Ÿè€—æ—¶æ“ä½œï¼Œä»£ç å¦‚ä¸‹ã€‚ 123456789101112@PostMapping("/user/info")public UserInfo saveUserInfo(@RequestBody UserInfo userInfo) throws InterruptedException &#123; UserInfo u2 = userInfoRepository.findById(1L).orElse(null); if (u2!=null) &#123; u2.setLastName("jack"+userInfo.getLastModifiedTime()); userInfoRepository.save(u2); System.out.println("æ¨¡æ‹Ÿäº‹åŠ¡æ‰§è¡Œå®Œä¹‹åŽè€—æ—¶æ“ä½œ........"); Thread.sleep(1000*60*2L); System.out.println("è€—æ—¶æ“ä½œæ‰§è¡Œå®Œæ¯•......."); &#125; return userInfoRepository.save(userInfo);&#125; é¡¹ç›®å¯åŠ¨ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹è¯·æ±‚ã€‚ 123456#### updatePOST /user/info HTTP/1.1Host: 127.0.0.1:8087Content-Type: application/jsonCache-Control: no-cache&#123;"ages":10,"id":3,"version":0&#125; è¿™ä¸ªæ—¶å€™æ‰“å¼€æ—¥å¿—æŽ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ—¥å¿—ã€‚ åœ¨ save ä¹‹åŽï¼Œå³äº‹åŠ¡æäº¤ä¹‹åŽï¼ŒHikariPool é‡Œé¢çš„æ•°æ®åº“è¿žæŽ¥ä¸€ç›´æ²¡æœ‰å½’è¿˜ï¼Œè€Œå¦‚æžœæˆ‘ä»¬ç»§ç»­ç­‰å¾…çš„è¯ï¼Œåœ¨æ•´ä¸ª Session å…³é—­ä¹‹åŽï¼Œæ•°æ®åº“è¿žæŽ¥æ‰ä¼šå½’è¿˜åˆ°è¿žæŽ¥æ± é‡Œé¢ã€‚ è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æžœæˆ‘ä»¬å®žé™…å·¥ä½œä¸­æœ‰è¿™æ ·çš„è€—æ—¶æ“ä½œï¼Œæ˜¯ä¸æ˜¯ç”¨ä¸äº†å‡ ä¸ªè¿™æ ·çš„è¯·æ±‚ï¼Œè¿žæŽ¥æ± å°±ä¸å¤Ÿç”¨äº†ï¼Ÿä½†å…¶å®žæ•°æ®åº“è¿žæŽ¥æ²¡åšä»»ä½• DB ç›¸å…³çš„æ“ä½œï¼Œç™½ç™½è¢«æµªè´¹äº†ã€‚ ç¬¬äºŒæ­¥ï¼šéªŒè¯ä¸€ä¸‹ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION æ¨¡å¼ã€‚ åªéœ€è¦å¯¹é…ç½®æ–‡ä»¶åšå¦‚ä¸‹ä¿®æ”¹ã€‚ 1spring.jpa.properties.hibernate.connection.handling_mode=DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION å…¶ä»–ä»£ç éƒ½ä¸å˜ï¼Œæˆ‘ä»¬å†è¯·æ±‚åˆšæ‰çš„ API è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å¾—åˆ°å¦‚ä¸‹æ—¥å¿—ã€‚ ä»Žæ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“æ‰§è¡Œå®Œ save(u2)ï¼Œäº‹åŠ¡æäº¤ä¹‹åŽï¼Œåšä¸€äº›è€—æ—¶æ“ä½œçš„æ—¶å€™ï¼Œå‘çŽ°æ­¤æ—¶æ•´ä¸ª Session ç”Ÿå‘½å‘¨æœŸæ˜¯æ²¡æœ‰æŒæœ‰æ•°æ®åº“è¿žæŽ¥çš„ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ç»“æŸä¹‹åŽå°±è¿›è¡Œäº†é‡Šæ”¾ï¼Œè¿™æ ·å¤§å¤§æé«˜äº†æ•°æ®åº“è¿žæŽ¥çš„åˆ©ç”¨çŽ‡ï¼Œå³ä½¿å¤§é‡è¯·æ±‚ä¹Ÿä¸ä¼šé€ æˆæ•°æ®åº“è¿žæŽ¥ä¸å¤Ÿç”¨ã€‚ ä¸‹é¢æ˜¯ä¸€äº› Hikari æ•°æ®æºè¿žæŽ¥æ± ä¸‹ï¼Œ DB è¿žæŽ¥èŽ·å¾—çš„æ—¶é—´å‚è€ƒå€¼ã€‚ å…¶ä¸­ï¼Œå¯¹è¿žæŽ¥çš„æ± çš„æŒæœ‰æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œå‡ ä¹Žç›‘æŽ§ä¸åˆ° DB è¿žæŽ¥ä¸å¤Ÿç”¨çš„æƒ…å†µã€‚ å¯¹ DB è¿žæŽ¥åˆ©ç”¨çŽ‡çš„ç›‘æŽ§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿žæŽ¥çš„ Creationã€Acquire åŸºæœ¬ä¸Šæ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯è¿žæŽ¥çš„ Usage &gt; 500ms å°±æœ‰äº›ä¸æ­£å¸¸äº†ï¼Œè¯´æ˜Žé‡Œé¢æœ‰ä¸€äº›è€—æ—¶æ“ä½œã€‚ ðŸŽ¯æ‰€ä»¥ï¼Œä¸€èˆ¬åœ¨å®žé™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨ DELAYED_ACQUISITION_AND_HOLD å’Œ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION ä¹‹é—´åšé€‰æ‹©ï¼›é€šè¿‡æ—¥å¿—å’Œç›‘æŽ§ï¼Œä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ DELAYED_ACQUISITION_AND_HOLD æ¯”è¾ƒé€‚åˆä¸€ä¸ª Session é‡Œé¢æœ‰å¤§é‡äº‹åŠ¡çš„ä¸šåŠ¡åœºæ™¯ï¼Œè¿™æ ·ä¸ç”¨é¢‘ç¹åˆ‡æ¢æ•°æ®åº“è¿žæŽ¥ã€‚ è€Œ DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION æ¯”è¾ƒé€‚åˆæ—¥å¸¸çš„ API ä¸šåŠ¡è¯·æ±‚ï¼Œæ²¡æœ‰å¤§é‡çš„äº‹åŠ¡ï¼Œäº‹åŠ¡ç»“æŸå°±é‡Šæ”¾è¿žæŽ¥çš„åœºæ™¯ã€‚ æ€»ç»“Connection å’Œ Transaction çš„å…³ç³» äº‹åŠ¡æ˜¯å»ºç«‹åœ¨ Connection ä¹‹ä¸Šçš„ï¼Œæ²¡æœ‰è¿žæŽ¥å°±æ²¡æœ‰äº‹åŠ¡ã€‚ ä»¥ MySQL InnoDB ä¸ºä¾‹ï¼Œæ–°å¼€ä¸€ä¸ªè¿žæŽ¥é»˜è®¤å¼€å¯äº‹åŠ¡ï¼Œé»˜è®¤æ¯ä¸ª SQL æ‰§è¡Œå®Œä¹‹åŽè‡ªåŠ¨æäº¤äº‹åŠ¡ã€‚ ä¸€ä¸ªè¿žæŽ¥é‡Œé¢å¯ä»¥æœ‰å¤šæ¬¡ä¸²è¡Œçš„äº‹åŠ¡æ®µï¼›ä¸€ä¸ªäº‹åŠ¡åªèƒ½å±žäºŽä¸€ä¸ª Connectionã€‚ äº‹åŠ¡ä¸Žäº‹åŠ¡ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œé‚£ä¹ˆè‡ªç„¶ä¸åŒè¿žæŽ¥çš„ä¸åŒäº‹åŠ¡ä¹Ÿæ˜¯éš”ç¦»çš„ã€‚ EntityManagerã€Connection å’Œ Transaction çš„å…³ç³» EntityManager é‡Œé¢æœ‰ DataSourceï¼Œå½“ EntityManager é‡Œé¢å¼€å¯äº‹åŠ¡çš„æ—¶å€™ï¼Œå…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹é‡Œé¢æ˜¯å¦æœ‰æ•°æ®åº“è¿žæŽ¥ï¼Œå¦‚æžœæœ‰ç›´æŽ¥ç”¨ã€‚ å¼€å¯äº‹åŠ¡ä¹‹å‰å…ˆå¼€å¯è¿žæŽ¥ï¼›å…³é—­äº‹åŠ¡ï¼Œä¸ä¸€å®šå…³é—­è¿žæŽ¥ã€‚ å¼€å¯ EntityManagerï¼Œä¸ä¸€å®šç«‹é©¬èŽ·å¾—è¿žæŽ¥ï¼›èŽ·å¾—è¿žæŽ¥ï¼Œä¸ä¸€å®šç«‹é©¬å¼€å¯äº‹åŠ¡ã€‚ å…³é—­ EntityManagerï¼Œä¸€å®šå…³é—­äº‹åŠ¡ï¼Œé‡Šæ”¾è¿žæŽ¥ï¼›åä¹‹ä¸ç„¶ã€‚ Sessionã€EntityManagerã€Connection å’Œ Transaction çš„å…³ç³» Session æ˜¯ EntityManager çš„å­ç±»ï¼ŒSessionImpl æ˜¯ Session å’Œ EntityManager çš„å®žçŽ°ç±»ã€‚é‚£ä¹ˆè‡ªç„¶ EntityManager å’Œ Connectionã€Transaction çš„å…³ç³»åŒæ ·é€‚ç”¨ Sessionã€EntityManagerã€Connection å’Œ Transaction çš„å…³ç³»ã€‚ Session çš„ç”Ÿå‘½å‘¨æœŸå†³å®šäº† EntityManager çš„ç”Ÿå‘½å‘¨æœŸã€‚ Session å’Œ Transaction çš„å…³ç³» åœ¨ Hibernate çš„ JPA å®žçŽ°é‡Œé¢ï¼Œå¼€å¯ Transaction ä¹‹å‰ï¼Œå¿…é¡»è¦å…ˆå¼€å¯ Sessionã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒSession çš„ç”Ÿå‘½å‘¨æœŸç”± open-in-view å†³å®šæ˜¯è¯·æ±‚ä¹‹å‰å¼€å¯ï¼Œè¿˜æ˜¯äº‹åŠ¡ä¹‹å‰å¼€å¯ã€‚ äº‹åŠ¡å…³é—­äº†ï¼ŒSession ä¸ä¸€å®šå…³é—­ã€‚ Session å…³é—­äº†ï¼Œäº‹åŠ¡ä¸€å®šå…³é—­ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Springbootå¼€å¯GizpåŽ‹ç¼©]]></title>
    <url>%2F2021%2F01%2F02%2FSpringboot%E5%BC%80%E5%90%AFGizp%E5%8E%8B%E7%BC%A9%2F</url>
    <content type="text"><![CDATA[Springbootå¼€å¯GizpåŽ‹ç¼©èƒŒæ™¯ åœ¨ä¼˜åŒ–æŽ¥å£æ—¶é—´çš„è¿‡ç¨‹ä¸­ï¼Œå‘çŽ°å¾ˆå¤šæŽ¥å£çš„Content Downloadæ—¶é—´è¾ƒé•¿ï¼Œé™¤äº†ç½‘ç»œé—®é¢˜ï¼Œå°±æ˜¯æŽ¥å£è¯·æ±‚çš„æ•°æ®å¤ªå¤§äº†ï¼Œæœ‰çš„è¾¾åˆ°äº†å‡ ç™¾kbã€‚æŽ§åˆ¶è¿”å›žå‚æ•°æ”¶æ•ˆç”šå¾®ï¼Œè¿™æ—¶å¼€å¯ Gzip å°±éžå¸¸æœ‰ç”¨äº†ï¼Œå¯ä»¥åŽ‹ç¼©æŽ¥å£è¯·æ±‚çš„æ•°æ®ï¼Œä¸€èˆ¬çš„jsonæ–‡æœ¬åŽ‹ç¼©æ¯”çŽ‡å¾ˆå¤§ï¼Œå¼€å¯ä¹‹åŽæŽ¥å£æ—¶é—´å¤§å¹…ä¸‹é™ï¼ å¯ç”¨æ­¥éª¤Spring boot é¡¹ç›®é…ç½®æ¯”è¾ƒç®€å•ï¼š 123server: compression: enabled: true é»˜è®¤åªåŽ‹ç¼© Http body **è¶…è¿‡2KB**çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹é…ç½®ä¿®æ”¹é»˜è®¤å±žæ€§ 123server: compression: min-response-size: 1KB é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨å“åº”å†…å®¹ç±»åž‹ä¸ºä»¥ä¸‹å†…å®¹æ—¶æ‰ä¼šåŽ‹ç¼©å“åº” text/html text/xml text/plain text/css æŽ¥å£è¿”å›žçš„æ˜¯ json æ•°æ®ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸‹é¢çš„é…ç½®ï¼š 1234server: compression: enabled: true mime-types: application/json å¦‚ä½•æŸ¥çœ‹ Gzip æ˜¯å¦å¼€å¯æˆåŠŸGoogle æµè§ˆå™¨æ‰“å¼€F12ï¼Œåˆ‡æ¢åˆ° NetWork ä¸‹ï¼Œå³é”®è¡¨å¤´é€‰æ‹© Response Headers ä¸‹çš„Content-Encodingï¼Œå¦‚æžœå¼€å¯äº†Gzipï¼Œå¯¹åº”æŽ¥å£ä¸­çš„Content-Encodingä¸­ä¼šæœ‰æ˜¾ç¤ºã€‚ æ³¨æ„ï¼š åœ¨åŒæ—¶å¼€å¯ https å’Œ http çš„å·¥ç¨‹ä¸­ï¼ŒGzip é…ç½®åªå¯¹ä¸»ç«¯å£ç”Ÿæ•ˆï¼ å¯ç”¨åŽçš„æ•ˆæžœå¼€å¯å‰ï¼šæ•°æ® Size ä¸º 511KBï¼Œå³ä¾§æ—¶é—´è“è‰²éƒ¨åˆ†ï¼ˆContent Downloadï¼‰è¾ƒé•¿ å¼€å¯å‰ï¼šæ•°æ® Size ä¸º 21.3KBï¼ŒContent-Encoding ä¸­æ˜¾ç¤º Gzipï¼Œå³ä¾§æ—¶é—´è“è‰²éƒ¨åˆ†æ¶ˆå¤± å¯¹æ¯”æ•ˆæžœéžå¸¸æ˜Žæ˜¾ï¼ŒæŽ¥å£æ—¶é—´ç”±1.03sé™åˆ°164msï¼Œå®Œç¾Žï¼]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>Springboot</tag>
        <tag>Annotation</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[7å¤§ç¼“å­˜ç»å…¸é—®é¢˜]]></title>
    <url>%2F2020%2F11%2F23%2F%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-7%E5%A4%A7%E7%BC%93%E5%AD%98%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[7å¤§ç¼“å­˜ç»å…¸é—®é¢˜ ç¬¬ä¸€ä¸ªç»å…¸é—®é¢˜-ç¼“å­˜å¤±æ•ˆé—®é¢˜æè¿° æœåŠ¡ç³»ç»ŸæŸ¥æ•°æ®ï¼Œé¦–å…ˆä¼šæŸ¥ç¼“å­˜ï¼Œå¦‚æžœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå°±è¿›ä¸€æ­¥æŸ¥ DBï¼Œæœ€åŽæŸ¥åˆ°æ•°æ®åŽå›žç§åˆ°ç¼“å­˜å¹¶è¿”å›žã€‚ ç¼“å­˜çš„æ€§èƒ½æ¯” DB é«˜ 50~100 å€ä»¥ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æ•°æ®æŸ¥è¯¢å°½å¯èƒ½å‘½ä¸­ç¼“å­˜ï¼Œè¿™æ ·ç³»ç»Ÿè´Ÿè·æœ€å°ï¼Œæ€§èƒ½æœ€ä½³ã€‚ ç¼“å­˜é‡Œçš„æ•°æ®å­˜å‚¨åŸºæœ¬ä¸Šéƒ½æ˜¯ä»¥ key ä¸ºç´¢å¼•è¿›è¡Œå­˜å‚¨å’ŒèŽ·å–çš„ã€‚ä¸šåŠ¡è®¿é—®æ—¶ï¼Œå¦‚æžœå¤§é‡çš„ key åŒæ—¶è¿‡æœŸï¼Œå¾ˆå¤šç¼“å­˜æ•°æ®è®¿é—®éƒ½ä¼š missï¼Œè¿›è€Œç©¿é€åˆ° DBï¼ŒDB çš„åŽ‹åŠ›å°±ä¼šæ˜Žæ˜¾ä¸Šå‡ï¼Œç”±äºŽ DB çš„æ€§èƒ½è¾ƒå·®ï¼Œåªåœ¨ç¼“å­˜çš„ 1%~2% ä»¥ä¸‹ï¼Œè¿™æ ·è¯·æ±‚çš„æ…¢æŸ¥çŽ‡ä¼šæ˜Žæ˜¾ä¸Šå‡ã€‚è¿™å°±æ˜¯ç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ã€‚ åŽŸå› åˆ†æž å¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼Œç‰¹åˆ«æ˜¯å¾ˆå¤š key ä¸€èµ·å¤±æ•ˆçš„åŽŸå› ï¼Œè·Ÿæˆ‘ä»¬æ—¥å¸¸å†™ç¼“å­˜çš„è¿‡æœŸæ—¶é—´æ¯æ¯ç›¸å…³ã€‚ åœ¨å†™ç¼“å­˜æ—¶ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæ ¹æ®ä¸šåŠ¡çš„è®¿é—®ç‰¹ç‚¹ï¼Œç»™æ¯ç§ä¸šåŠ¡æ•°æ®é¢„ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œåœ¨å†™ç¼“å­˜æ—¶æŠŠè¿™ä¸ªè¿‡æœŸæ—¶é—´å¸¦ä¸Šï¼Œè®©ç¼“å­˜æ•°æ®åœ¨è¿™ä¸ªå›ºå®šçš„è¿‡æœŸæ—¶é—´åŽè¢«æ·˜æ±°ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå› ä¸ºç¼“å­˜æ•°æ®æ˜¯é€æ­¥å†™å…¥çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é€æ­¥è¿‡æœŸè¢«æ·˜æ±°çš„ã€‚ ä½†åœ¨æŸäº›åœºæ™¯ï¼Œä¸€å¤§æ‰¹æ•°æ®ä¼šè¢«ç³»ç»Ÿä¸»åŠ¨æˆ–è¢«åŠ¨ä»Ž DB æ‰¹é‡åŠ è½½ï¼Œç„¶åŽå†™å…¥ç¼“å­˜ã€‚è¿™äº›æ•°æ®å†™å…¥ç¼“å­˜æ—¶ï¼Œç”±äºŽä½¿ç”¨ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨ç»åŽ†è¿™ä¸ªè¿‡æœŸæ—¶é—´ä¹‹åŽï¼Œè¿™æ‰¹æ•°æ®å°±ä¼šä¸€èµ·åˆ°æœŸï¼Œä»Žè€Œè¢«ç¼“å­˜æ·˜æ±°ã€‚æ­¤æ—¶ï¼Œå¯¹è¿™æ‰¹æ•°æ®çš„æ‰€æœ‰è¯·æ±‚ï¼Œéƒ½ä¼šå‡ºçŽ°ç¼“å­˜å¤±æ•ˆï¼Œä»Žè€Œéƒ½ç©¿é€åˆ° DBï¼ŒDB ç”±äºŽæŸ¥è¯¢é‡å¤ªå¤§ï¼Œå°±å¾ˆå®¹æ˜“åŽ‹åŠ›å¤§å¢žï¼Œè¯·æ±‚å˜æ…¢ã€‚ ä¸šåŠ¡åœºæ™¯ å¾ˆå¤šä¸šåŠ¡åœºæ™¯ï¼Œç¨ä¸æ³¨æ„ï¼Œå°±å‡ºçŽ°å¤§é‡çš„ç¼“å­˜å¤±æ•ˆï¼Œè¿›è€Œå¯¼è‡´ç³»ç»Ÿ DB åŽ‹åŠ›å¤§ã€è¯·æ±‚å˜æ…¢çš„æƒ…å†µã€‚æ¯”å¦‚åŒä¸€æ‰¹ç«è½¦ç¥¨ã€é£žæœºç¥¨ï¼Œå½“å¯ä»¥å”®å–æ—¶ï¼Œç³»ç»Ÿä¼šä¸€æ¬¡æ€§åŠ è½½åˆ°ç¼“å­˜ï¼Œå¦‚æžœç¼“å­˜å†™å…¥æ—¶ï¼Œè¿‡æœŸæ—¶é—´æŒ‰ç…§é¢„å…ˆè®¾ç½®çš„è¿‡æœŸå€¼ï¼Œé‚£è¿‡æœŸæ—¶é—´åˆ°æœŸåŽï¼Œç³»ç»Ÿå°±ä¼šå› ç¼“å­˜å¤±æ•ˆå‡ºçŽ°å˜æ…¢çš„é—®é¢˜ã€‚ç±»ä¼¼çš„ä¸šåŠ¡åœºæ™¯è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¾®åšä¸šåŠ¡ï¼Œä¼šæœ‰åŽå°ç¦»çº¿ç³»ç»Ÿï¼ŒæŒç»­è®¡ç®—çƒ­é—¨å¾®åšï¼Œæ¯å½“è®¡ç®—ç»“æŸï¼Œä¼šå°†è¿™æ‰¹çƒ­é—¨å¾®åšæ‰¹é‡å†™å…¥å¯¹åº”çš„ç¼“å­˜ã€‚è¿˜æ¯”å¦‚ï¼Œå¾ˆå¤šä¸šåŠ¡ï¼Œåœ¨éƒ¨ç½²æ–° IDC æˆ–æ–°ä¸šåŠ¡ä¸Šçº¿æ—¶ï¼Œä¼šè¿›è¡Œç¼“å­˜é¢„çƒ­ï¼Œä¹Ÿä¼šä¸€æ¬¡æ€§åŠ è½½å¤§æ‰¹çƒ­æ•°æ®ã€‚ è§£å†³æ–¹æ¡ˆå¯¹äºŽæ‰¹é‡ key ç¼“å­˜å¤±æ•ˆçš„é—®é¢˜ï¼ŒåŽŸå› æ—¢ç„¶æ˜¯é¢„ç½®çš„å›ºå®šè¿‡æœŸæ—¶é—´ï¼Œé‚£è§£å†³æ–¹æ¡ˆä¹Ÿä»Žè¿™é‡Œå…¥æ‰‹ã€‚è®¾è®¡ç¼“å­˜çš„è¿‡æœŸæ—¶é—´æ—¶ï¼Œä½¿ç”¨å…¬å¼ï¼šè¿‡æœŸæ—¶é—´=baes æ—¶é—´+éšæœºæ—¶é—´ã€‚å³ç›¸åŒä¸šåŠ¡æ•°æ®å†™ç¼“å­˜æ—¶ï¼Œåœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¹‹ä¸Šï¼Œå†åŠ ä¸€ä¸ªéšæœºçš„è¿‡æœŸæ—¶é—´ï¼Œè®©æ•°æ®åœ¨æœªæ¥ä¸€æ®µæ—¶é—´å†…æ…¢æ…¢è¿‡æœŸï¼Œé¿å…çž¬æ—¶å…¨éƒ¨è¿‡æœŸï¼Œå¯¹ DB é€ æˆè¿‡å¤§åŽ‹åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa HibernateåŠ è½½è¿‡ç¨‹ä¸Žé…ç½®é¡¹]]></title>
    <url>%2F2020%2F11%2F20%2FSpringDataJpa%E7%9A%84Hibernate%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E4%B8%8E%E9%85%8D%E7%BD%AE%E9%A1%B9%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa HibernateåŠ è½½è¿‡ç¨‹ä¸Žé…ç½®é¡¹Hibernate æž¶æž„åˆ†æžé¦–å…ˆçœ‹ä¸€ä¸‹ Hibernate å®˜æ–¹æä¾›çš„æž¶æž„å›¾ ä»Žæž¶æž„å›¾ä¸Šå¯ä»¥çŸ¥é“ Hibernate å®žçŽ°çš„ ORM çš„æŽ¥å£æœ‰ä¸¤ç§ï¼š Hibernate è‡ªå·±çš„ API æŽ¥å£ Java Persistence API çš„æŽ¥å£ Hibernate æ¯” Java Persistence API æ—©å‡ å¹´å‘å±•çš„ï¼ŒåŽæ¥æ‰æœ‰äº† Java çš„æŒä¹…åŒ–åè®®ï¼ŒHibernate æ˜¯ Spring Data JPA æŒä¹…åŒ–æ“ä½œçš„æ ¸å¿ƒã€‚ å†ä»Žç±»ä¸Šé¢å…·ä½“çœ‹ä¸€ä¸‹ï¼Œå…³é”®ç±»çš„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š ç»“åˆç±»çš„å…³ç³»å›¾æ¥çœ‹ï¼ŒSession æŽ¥å£å’Œ SessionFactory æŽ¥å£éƒ½æ˜¯ Hibernate çš„æ¦‚å¿µï¼Œè€Œ EntityManger å’Œ EntityManagerFactory éƒ½æ˜¯ Java Persistence API åè®®è§„å®šçš„æŽ¥å£ã€‚ ä¸è¿‡ HibernateEntityManger ä»Ž Hibernate 5.2 ä¹‹åŽå°±å¼€å§‹ä¸æŽ¨èä½¿ç”¨äº†ï¼Œè€Œæ˜¯å»ºè®®ç›´æŽ¥ä½¿ç”¨ EntityManager æŽ¥å£å³å¯ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹çœ‹ Hibernate åœ¨ Spring BOOT é‡Œé¢æ˜¯å¦‚ä½•è¢«åŠ è½½è¿›åŽ»çš„ã€‚ Hibernate 5 åœ¨ Spring Boot 2 é‡Œé¢çš„åŠ è½½è¿‡ç¨‹ä¸åŒçš„ Spring Boot ç‰ˆæœ¬ï¼Œå¯èƒ½åŠ è½½ç±»çš„å®žçŽ°é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯åˆ†æžè¿‡ç¨‹éƒ½æ˜¯ç›¸åŒçš„ã€‚ å…ˆæ‰“å¼€ spring.factories æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­å¯ä»¥è‡ªåŠ¨åŠ è½½ Hibernate çš„åªæœ‰ä¸€ä¸ªç±»ï¼Œé‚£å°±æ˜¯ HibernateJpaAutoConfigurationã€‚ HibernateJpaAutoConfiguration å°±æ˜¯ Spring Boot åŠ è½½ Hibernate çš„ä¸»è¦å…¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æŽ¥æ‰“å¼€è¿™ä¸ªç±»çœ‹ä¸€ä¸‹ã€‚ 1234567@Configuration(proxyBeanMethods = false)@ConditionalOnClass(&#123; LocalContainerEntityManagerFactoryBean.class, EntityManager.class, SessionImplementor.class &#125;)@EnableConfigurationProperties(JpaProperties.class)//JPAPropertiesçš„é…ç½®@AutoConfigureAfter(&#123; DataSourceAutoConfiguration.class &#125;)@Import(HibernateJpaConfiguration.class) //hibernateåŠ è½½çš„å…³é”®ç±»public class HibernateJpaAutoConfiguration &#123;&#125; å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªéœ€è¦å…³æ³¨çš„å°±æ˜¯ JpaProperties ç±»ï¼Œå› ä¸ºé€šè¿‡è¿™ä¸ªç±»å¯ä»¥é—´æŽ¥çŸ¥é“ï¼Œapplication.properties é‡Œé¢å¯ä»¥é…ç½®çš„ spring.jpa çš„å±žæ€§æœ‰å“ªäº›ã€‚ JpaProperties å±žæ€§æ‰“å¼€ JpaProperties ç±»çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ é€šè¿‡è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ application.properties é‡Œé¢å¾—åˆ°å¦‚ä¸‹é…ç½®é¡¹ã€‚ 12345678910111213141516171819# å¯ä»¥é…ç½®JPAçš„å®žçŽ°è€…çš„åŽŸå§‹å±žæ€§çš„é…ç½®ï¼Œå¦‚ï¼šè¿™é‡Œç”¨çš„JPAçš„å®žçŽ°è€…æ˜¯hibernate# é‚£ä¹ˆhibernateé‡Œé¢çš„ä¸€äº›å±žæ€§è®¾ç½®å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®žçŽ°spring.jpa.properties.hibernate.hbm2ddl.auto=none#hibernateçš„persistence.xmlæ–‡ä»¶æœ‰å“ªäº›ï¼Œç›®å‰å·²ç»ä¸æŽ¨èä½¿ç”¨#spring.jpa.mapping-resources=# æŒ‡å®šæ•°æ®æºçš„ç±»åž‹ï¼Œå¦‚æžœä¸æŒ‡å®šï¼ŒSpring BootåŠ è½½Datasourceçš„æ—¶å€™ä¼šæ ¹æ®URLçš„åè®®è‡ªå·±åˆ¤æ–­# å¦‚ï¼šspring.datasource.url=jdbc:mysql://localhost:3306/test ä¸Šé¢å¯ä»¥æ˜Žç¡®çŸ¥é“æ˜¯mysqlæ•°æ®æºï¼Œæ‰€ä»¥è¿™ä¸ªå¯ä»¥ä¸éœ€è¦æŒ‡å®šï¼›# åº”ç”¨åœºæ™¯ï¼Œå½“æˆ‘ä»¬é€šè¿‡ä»£ç†çš„æ–¹å¼ï¼Œå¯èƒ½é€šè¿‡datasource.urlæ²¡åŠžæ³•åˆ¤æ–­æ•°æ®æºç±»åž‹çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æŒ‡å®šï¼Œå¯é€‰çš„å€¼æœ‰ï¼šDB2,H2,HSQL,INFORMIX,MYSQL,ORACLE,POSTGRESQL,SQL_SERVER,SYBASE)spring.jpa.database=mysql# æ˜¯å¦åœ¨å¯åŠ¨é˜¶æ®µæ ¹æ®å®žä½“åˆå§‹åŒ–æ•°æ®åº“çš„schemaï¼Œé»˜è®¤falseï¼Œå½“æˆ‘ä»¬ç”¨å†…å­˜æ•°æ®åº“åšæµ‹è¯•çš„æ—¶å€™å¯ä»¥æ‰“å¼€ï¼Œå¾ˆæœ‰ç”¨spring.jpa.generate-ddl=false# å’Œspring.jpa.databaseç”¨æ³•å·®ä¸å¤šï¼ŒæŒ‡å®šæ•°æ®åº“çš„å¹³å°ï¼Œé»˜è®¤ä¼šè‡ªå·±å‘çŽ°ï¼›ä¸€èˆ¬ä¸éœ€è¦æŒ‡å®šï¼Œdatabase-platformæŒ‡å®šçš„å¿…é¡»æ˜¯org.hibernate.dialect.Dialectçš„å­ç±»ï¼Œå¦‚mysqlé»˜è®¤æ˜¯ç”¨ä¸‹é¢çš„platformspring.jpa.database-platform=org.hibernate.dialect.MySQLInnoDBDialect# æ˜¯å¦åœ¨viewå±‚æ‰“å¼€sessionï¼Œé»˜è®¤æ˜¯trueï¼Œå…¶å®žå¤§éƒ¨åˆ†åœºæ™¯ä¸éœ€è¦æ‰“å¼€ï¼Œå¯ä»¥è®¾ç½®æˆfalseï¼Œspring.jpa.open-in-view=false# æ˜¯å¦æ˜¾ç¤ºsqlï¼Œå½“æ‰§è¡ŒJPAçš„æ•°æ®åº“æ“ä½œçš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯falseï¼Œåœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæ‰“å¼€ï¼Œæœ‰åŠ©äºŽåˆ†æžsqlæ˜¯ä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„# åœ¨ç”Ÿäº§çŽ¯å¢ƒçš„æ—¶å€™å»ºè®®ç»™è¿™ä¸ªè®¾ç½®æˆfalseï¼Œæ”¹ç”±logging.level.org.hibernate.SQL=DEBUGä»£æ›¿ï¼Œè¿™æ ·çš„è¯æ—¥å¿—é»˜è®¤æ˜¯åŸºäºŽlogbackè¾“å‡ºçš„# è€Œä¸æ˜¯ç›´æŽ¥æ‰“å°åˆ°æŽ§åˆ¶å°çš„ï¼Œæœ‰åˆ©äºŽå¢žåŠ traceIdå’Œçº¿ç¨‹IDç­‰ä¿¡æ¯ï¼Œä¾¿äºŽåˆ†æžspring.jpa.show-sql=true å…¶ä¸­ï¼Œspring.jpa.show-sql=true è¾“å‡ºçš„ sql æ•ˆæžœå¦‚ä¸‹æ‰€ç¤ºã€‚ 1Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) ä¸Šé¢æ˜¯å•çº¿ç¨‹çš„ System.out.println çš„æ•ˆæžœï¼Œå¦‚æžœæ˜¯åœ¨çº¿ä¸ŠçŽ¯å¢ƒï¼Œå¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å°±ä¸çŸ¥é“æ˜¯å“ªä¸ªçº¿ç¨‹è¾“å‡ºæ¥çš„ï¼Œè€Œ logging.level.org.hibernate.SQL=DEBUG è¾“å‡ºçš„ sql æ•ˆæžœå¦‚ä¸‹æ‰€ç¤ºã€‚ 12020-11-08 16:54:22.275 DEBUG 6589 --- [nio-8087-exec-1] org.hibernate.SQL è¿™æ ·å¯ä»¥è½»æ˜“çŸ¥é“çº¿ç¨‹ ID å’Œæ‰§è¡Œæ—¶é—´ï¼Œç”šè‡³å¯ä»¥æœ‰ tranceID å’Œ spanID è¿›è¡Œæ—¥å¿—è·Ÿè¸ªï¼Œæ–¹ä¾¿åˆ†æžæ˜¯å“ªä¸ªçº¿ç¨‹æ‰“å°çš„ã€‚ HibernateJpaConfiguration åˆ†æžå®ƒæ˜¯é€šè¿‡ HibernateJpaAutoConfiguration é‡Œé¢çš„ @Import(HibernateJpaConfiguration.class) å¯¼å…¥è¿›æ¥åŠ è½½çš„ã€‚ 123456@Configuration(proxyBeanMethods = false)@EnableConfigurationProperties(HibernateProperties.class)@ConditionalOnSingleCandidate(DataSource.class)class HibernateJpaConfiguration extends JpaBaseConfiguration &#123;...... &#125; é€šè¿‡æºç å¯ä»¥å¾—åˆ° Hibernate åœ¨ JPA ä¸­é…ç½®çš„ä¸‰ä¸ªé‡è¦çº¿ç´¢ ç¬¬ä¸€ä¸ªçº¿ç´¢ï¼šHibernateProperties è¿™ä¸ªé…ç½®ç±»å¯¹åº”çš„æ˜¯ spring.jpa.hibernate çš„é…ç½® @EnableConfigurationProperties(HibernateProperties.class) å¯ç”¨äº† HibernateProperties çš„é…ç½®ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å…¶ä¸­å¯ä»¥çœ‹åˆ° application.properties çš„é…ç½®é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678# naming çš„ç‰©ç†ç­–ç•¥å€¼æœ‰ï¼šorg.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy(é»˜è®¤)å’Œorg.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImplspring.jpa.hibernate.naming.physical-strategy=# ddlçš„ç”Ÿæˆç­–ç•¥ï¼Œé»˜è®¤noneï¼›å¦‚æžœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šä»»ä½•æ•°æ®æºçš„urlï¼Œé‡‡ç”¨çš„æ˜¯springçš„é›†æˆæ•°æ®æºï¼Œä¹Ÿå°±æ˜¯å†…å­˜æ•°æ®æºH2çš„æ—¶å€™ï¼Œé»˜è®¤å€¼æ˜¯create-drop;# æ‰€ä»¥å½“æˆ‘ä»¬æ¯æ¬¡ç”¨H2çš„æ—¶å€™ä»€ä¹ˆéƒ½æ²¡åšï¼Œå®ƒå°±ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºè¡¨ç­‰ï¼Œå†…å­˜æ•°æ®åº“å’Œå†™æµ‹è¯•ç”¨çš„æ—¶å€™ï¼Œcreate-dropå°±éžå¸¸æ–¹ä¾¿äº†ï¼›ä¸è¿‡ï¼Œç”Ÿäº§æ•°æ®åº“ä¸€å®šè¦è®¾ç½®æˆnone;spring.jpa.hibernate.ddl-auto=none# å½“ @Id é…ç½®æˆ @GeneratedValue(strategy= GenerationType.AUTO) çš„æ—¶å€™# æ˜¯å¦é‡‡ç”¨ hibernate çš„ Id-generator-mappings(å³ä¼šé»˜è®¤å¸®æˆ‘ä»¬åˆ›å»ºä¸€å¼ è¡¨hibernate_sequenceæ¥å­˜å‚¨å’Œç”ŸæˆID)ï¼Œé»˜è®¤æ˜¯truespring.jpa.hibernate.use-new-id-generator-mappings=true ç¬¬äºŒä¸ªçº¿ç´¢ï¼šHibernateJpaConfiguration çš„çˆ¶ç±» JpaBaseConfiguration ä¹Ÿä¼šä¼˜å…ˆåŠ è½½ï¼Œæ­¤ç±»å°±æ˜¯ Spring Boot åŠ è½½ JPA çš„æ ¸å¿ƒé€»è¾‘ æ‰“å¼€ JpaBaseConfiguration ç±»çœ‹ä¸€ä¸‹æºç ã€‚ 123456789101112131415161718192021222324252627282930@Configuration(proxyBeanMethods = false)@EnableConfigurationProperties(JpaProperties.class)// DataSourceInitializedPublisher ç”¨æ¥è¿›è¡Œæ•°æ®æºçš„åˆå§‹åŒ–æ“ä½œ@Import(DataSourceInitializedPublisher.Registrar.class)public abstract class JpaBaseConfiguration implements BeanFactoryAware &#123;protected JpaBaseConfiguration(DataSource dataSource, JpaProperties properties, ObjectProvider&lt;JtaTransactionManager&gt; jtaTransactionManager) &#123; this.dataSource = dataSource; this.properties = properties; //jtaTransactionManager èµ‹å€¼ï¼Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬ç”¨ä¸åˆ°ï¼Œä¸€èˆ¬ç”¨æ¥è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯æ‰ä¼šç”¨åˆ°ã€‚ this.jtaTransactionManager = jtaTransactionManager.getIfAvailable(); &#125;//åŠ è½½ JPA çš„å®žçŽ°æ–¹å¼@Bean@ConditionalOnMissingBeanpublic JpaVendorAdapter jpaVendorAdapter() &#123; //createJpaVendorAdapter æ˜¯ç”±å­ç±» HibernateJpaConfiguration å®žçŽ°çš„ï¼Œåˆ›å»ºJPAçš„å®žçŽ°ç±» AbstractJpaVendorAdapter adapter = createJpaVendorAdapter(); adapter.setShowSql(this.properties.isShowSql()); if (this.properties.getDatabase() != null) &#123; adapter.setDatabase(this.properties.getDatabase()); &#125; if (this.properties.getDatabasePlatform() != null) &#123; adapter.setDatabasePlatform(this.properties.getDatabasePlatform()); &#125; adapter.setGenerateDdl(this.properties.isGenerateDdl()); return adapter;&#125;......&#125; @Import(DataSourceInitializedPublisher.Registrar.class) æ˜¯ç”¨æ¥åˆå§‹åŒ–æ•°æ®çš„ï¼›ä»Žæž„é€ å‡½æ•°ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°å…¶æ˜¯å¦æœ‰ç”¨åˆ° jtaTransactionManagerï¼ˆè¿™ä¸ªæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡æ‰ä¼šç”¨åˆ°ï¼‰ï¼›è€Œ createJpaVendorAdapter() æ˜¯åœ¨ HibernateJpaConfiguration é‡Œé¢å®žçŽ°çš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 12345678class HibernateJpaConfiguration extends JpaBaseConfiguration &#123;//è¿™é‡Œæ˜¯hibernateå’ŒJpaçš„ç»“åˆï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„HibernateJpaVendorAdapterä½œä¸ºJPAçš„å®žçŽ°è€…ï¼Œå¯ä»¥æ‰“å¼€HibernateJpaVendorAdapteré‡Œé¢è®¾ç½®ä¸€äº›æ–­ç‚¹ï¼Œå°±ä¼šçŸ¥é“Spring bootæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥åŠ è½½Hibernateçš„äº†ï¼›@Overrideprotected AbstractJpaVendorAdapter createJpaVendorAdapter() &#123; return new HibernateJpaVendorAdapter();&#125;......&#125; çŽ°åœ¨å·²ç»çŸ¥é“äº† HibernateJpaVendorAdapter çš„åŠ è½½é€»è¾‘ï¼Œè€Œ HibernateJpaVendorAdapter é‡Œé¢å®žçŽ°äº† Hibernate çš„åˆå§‹åŒ–é€»è¾‘ ç¬¬ä¸‰ä¸ªçº¿ç´¢ï¼šspring.jpa.properties é…ç½®é¡¹æœ‰å“ªäº› å¦‚æžœæŽ¥ç€åœ¨ HibernateJpaConfiguration ç±»é‡Œé¢ debug æŸ¥çœ‹å…³é”®ä»£ç çš„è¯ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š ä¸Šå›¾ä¸­çš„ä»£ç æ˜¾ç¤ºï¼ŒJpaProperties ç±»é‡Œé¢çš„ properties å±žæ€§ï¼Œä¹Ÿå°±æ˜¯ spring.jpa.properties çš„é…ç½®åŠ è½½åˆ°äº† vendorProperties é‡Œé¢ã€‚è€Œ properties é‡Œé¢æ˜¯ HashMap ç»“æž„ï¼Œé‚£ä¹ˆå®ƒéƒ½å¯ä»¥æ”¯æŒå“ªäº›é…ç½®å‘¢ï¼Ÿ æ‰“å¼€ org.hibernate.cfg.AvailableSettings å¯ä»¥çœ‹åˆ° Hibernate æ”¯æŒçš„é…ç½®é¡¹å¤§æ¦‚æœ‰ 100 å¤šä¸ªé…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225String JPA_PERSISTENCE_PROVIDER = &quot;javax.persistence.provider&quot;;String JPA_TRANSACTION_TYPE = &quot;javax.persistence.transactionType&quot;;String JPA_JTA_DATASOURCE = &quot;javax.persistence.jtaDataSource&quot;;String JPA_NON_JTA_DATASOURCE = &quot;javax.persistence.nonJtaDataSource&quot;;String JPA_JDBC_DRIVER = &quot;javax.persistence.jdbc.driver&quot;;String JPA_JDBC_URL = &quot;javax.persistence.jdbc.url&quot;;String JPA_JDBC_USER = &quot;javax.persistence.jdbc.user&quot;;String JPA_JDBC_PASSWORD = &quot;javax.persistence.jdbc.password&quot;;String JPA_SHARED_CACHE_MODE = &quot;javax.persistence.sharedCache.mode&quot;;String JPA_SHARED_CACHE_RETRIEVE_MODE =&quot;javax.persistence.cache.retrieveMode&quot;;String JPA_SHARED_CACHE_STORE_MODE =&quot;javax.persistence.cache.storeMode&quot;;String JPA_VALIDATION_MODE = &quot;javax.persistence.validation.mode&quot;;String JPA_VALIDATION_FACTORY = &quot;javax.persistence.validation.factory&quot;;String JPA_PERSIST_VALIDATION_GROUP = &quot;javax.persistence.validation.group.pre-persist&quot;;String JPA_UPDATE_VALIDATION_GROUP = &quot;javax.persistence.validation.group.pre-update&quot;;String JPA_REMOVE_VALIDATION_GROUP = &quot;javax.persistence.validation.group.pre-remove&quot;;String JPA_LOCK_SCOPE = &quot;javax.persistence.lock.scope&quot;;String JPA_LOCK_TIMEOUT = &quot;javax.persistence.lock.timeout&quot;;String CDI_BEAN_MANAGER = &quot;javax.persistence.bean.manager&quot;;String CLASSLOADERS = &quot;hibernate.classLoaders&quot;;String TC_CLASSLOADER = &quot;hibernate.classLoader.tccl_lookup_precedence&quot;;String APP_CLASSLOADER = &quot;hibernate.classLoader.application&quot;;String RESOURCES_CLASSLOADER = &quot;hibernate.classLoader.resources&quot;;String HIBERNATE_CLASSLOADER = &quot;hibernate.classLoader.hibernate&quot;;String ENVIRONMENT_CLASSLOADER = &quot;hibernate.classLoader.environment&quot;;String JPA_METAMODEL_GENERATION = &quot;hibernate.ejb.metamodel.generation&quot;;String JPA_METAMODEL_POPULATION = &quot;hibernate.ejb.metamodel.population&quot;;String STATIC_METAMODEL_POPULATION = &quot;hibernate.jpa.static_metamodel.population&quot;;String CONNECTION_PROVIDER =&quot;hibernate.connection.provider_class&quot;;String DRIVER =&quot;hibernate.connection.driver_class&quot;;String URL =&quot;hibernate.connection.url&quot;;String USER =&quot;hibernate.connection.username&quot;;String PASS =&quot;hibernate.connection.password&quot;;String ISOLATION =&quot;hibernate.connection.isolation&quot;;String AUTOCOMMIT = &quot;hibernate.connection.autocommit&quot;;String POOL_SIZE =&quot;hibernate.connection.pool_size&quot;;String DATASOURCE =&quot;hibernate.connection.datasource&quot;;String CONNECTION_PROVIDER_DISABLES_AUTOCOMMIT= &quot;hibernate.connection.provider_disables_autocommit&quot;;String CONNECTION_PREFIX = &quot;hibernate.connection&quot;;String JNDI_CLASS =&quot;hibernate.jndi.class&quot;;String JNDI_URL =&quot;hibernate.jndi.url&quot;;String JNDI_PREFIX = &quot;hibernate.jndi&quot;;String DIALECT =&quot;hibernate.dialect&quot;;String DIALECT_RESOLVERS = &quot;hibernate.dialect_resolvers&quot;;String STORAGE_ENGINE = &quot;hibernate.dialect.storage_engine&quot;;String SCHEMA_MANAGEMENT_TOOL = &quot;hibernate.schema_management_tool&quot;;String TRANSACTION_COORDINATOR_STRATEGY = &quot;hibernate.transaction.coordinator_class&quot;;String JTA_PLATFORM = &quot;hibernate.transaction.jta.platform&quot;;String PREFER_USER_TRANSACTION = &quot;hibernate.jta.prefer_user_transaction&quot;;String JTA_PLATFORM_RESOLVER = &quot;hibernate.transaction.jta.platform_resolver&quot;;String JTA_CACHE_TM = &quot;hibernate.jta.cacheTransactionManager&quot;;String JTA_CACHE_UT = &quot;hibernate.jta.cacheUserTransaction&quot;;String JDBC_TYLE_PARAMS_ZERO_BASE = &quot;hibernate.query.sql.jdbc_style_params_base&quot;;String DEFAULT_CATALOG = &quot;hibernate.default_catalog&quot;;String DEFAULT_SCHEMA = &quot;hibernate.default_schema&quot;;String DEFAULT_CACHE_CONCURRENCY_STRATEGY = &quot;hibernate.cache.default_cache_concurrency_strategy&quot;;String USE_NEW_ID_GENERATOR_MAPPINGS = &quot;hibernate.id.new_generator_mappings&quot;;String FORCE_DISCRIMINATOR_IN_SELECTS_BY_DEFAULT = &quot;hibernate.discriminator.force_in_select&quot;;String IMPLICIT_DISCRIMINATOR_COLUMNS_FOR_JOINED_SUBCLASS = &quot;hibernate.discriminator.implicit_for_joined&quot;;String IGNORE_EXPLICIT_DISCRIMINATOR_COLUMNS_FOR_JOINED_SUBCLASS = &quot;hibernate.discriminator.ignore_explicit_for_joined&quot;;String USE_NATIONALIZED_CHARACTER_DATA = &quot;hibernate.use_nationalized_character_data&quot;;String SCANNER_DEPRECATED = &quot;hibernate.ejb.resource_scanner&quot;;String SCANNER = &quot;hibernate.archive.scanner&quot;;String SCANNER_ARCHIVE_INTERPRETER = &quot;hibernate.archive.interpreter&quot;;String SCANNER_DISCOVERY = &quot;hibernate.archive.autodetection&quot;;String IMPLICIT_NAMING_STRATEGY = &quot;hibernate.implicit_naming_strategy&quot;;String PHYSICAL_NAMING_STRATEGY = &quot;hibernate.physical_naming_strategy&quot;;String ARTIFACT_PROCESSING_ORDER = &quot;hibernate.mapping.precedence&quot;;String KEYWORD_AUTO_QUOTING_ENABLED = &quot;hibernate.auto_quote_keyword&quot;;String XML_MAPPING_ENABLED = &quot;hibernate.xml_mapping_enabled&quot;;String SESSION_FACTORY_NAME = &quot;hibernate.session_factory_name&quot;;String SESSION_FACTORY_NAME_IS_JNDI = &quot;hibernate.session_factory_name_is_jndi&quot;;String SHOW_SQL =&quot;hibernate.show_sql&quot;;String FORMAT_SQL =&quot;hibernate.format_sql&quot;;String USE_SQL_COMMENTS =&quot;hibernate.use_sql_comments&quot;;String MAX_FETCH_DEPTH = &quot;hibernate.max_fetch_depth&quot;;String DEFAULT_BATCH_FETCH_SIZE = &quot;hibernate.default_batch_fetch_size&quot;;String USE_STREAMS_FOR_BINARY = &quot;hibernate.jdbc.use_streams_for_binary&quot;;String USE_SCROLLABLE_RESULTSET = &quot;hibernate.jdbc.use_scrollable_resultset&quot;;String USE_GET_GENERATED_KEYS = &quot;hibernate.jdbc.use_get_generated_keys&quot;;String STATEMENT_FETCH_SIZE = &quot;hibernate.jdbc.fetch_size&quot;;String STATEMENT_BATCH_SIZE = &quot;hibernate.jdbc.batch_size&quot;;String BATCH_STRATEGY = &quot;hibernate.jdbc.factory_class&quot;;String BATCH_VERSIONED_DATA = &quot;hibernate.jdbc.batch_versioned_data&quot;;String JDBC_TIME_ZONE = &quot;hibernate.jdbc.time_zone&quot;;String AUTO_CLOSE_SESSION = &quot;hibernate.transaction.auto_close_session&quot;;String FLUSH_BEFORE_COMPLETION = &quot;hibernate.transaction.flush_before_completion&quot;;String ACQUIRE_CONNECTIONS = &quot;hibernate.connection.acquisition_mode&quot;;String RELEASE_CONNECTIONS = &quot;hibernate.connection.release_mode&quot;;String CONNECTION_HANDLING = &quot;hibernate.connection.handling_mode&quot;;String CURRENT_SESSION_CONTEXT_CLASS = &quot;hibernate.current_session_context_class&quot;;String USE_IDENTIFIER_ROLLBACK = &quot;hibernate.use_identifier_rollback&quot;;String USE_REFLECTION_OPTIMIZER = &quot;hibernate.bytecode.use_reflection_optimizer&quot;;String ENFORCE_LEGACY_PROXY_CLASSNAMES = &quot;hibernate.bytecode.enforce_legacy_proxy_classnames&quot;;String ALLOW_ENHANCEMENT_AS_PROXY = &quot;hibernate.bytecode.allow_enhancement_as_proxy&quot;;String QUERY_TRANSLATOR = &quot;hibernate.query.factory_class&quot;;String QUERY_SUBSTITUTIONS = &quot;hibernate.query.substitutions&quot;;String QUERY_STARTUP_CHECKING = &quot;hibernate.query.startup_check&quot;;String CONVENTIONAL_JAVA_CONSTANTS = &quot;hibernate.query.conventional_java_constants&quot;;String SQL_EXCEPTION_CONVERTER = &quot;hibernate.jdbc.sql_exception_converter&quot;;String WRAP_RESULT_SETS = &quot;hibernate.jdbc.wrap_result_sets&quot;;String NATIVE_EXCEPTION_HANDLING_51_COMPLIANCE = &quot;hibernate.native_exception_handling_51_compliance&quot;;String ORDER_UPDATES = &quot;hibernate.order_updates&quot;;String ORDER_INSERTS = &quot;hibernate.order_inserts&quot;;String JPA_CALLBACKS_ENABLED = &quot;hibernate.jpa_callbacks.enabled&quot;;String DEFAULT_NULL_ORDERING = &quot;hibernate.order_by.default_null_ordering&quot;;String LOG_JDBC_WARNINGS = &quot;hibernate.jdbc.log.warnings&quot;;String BEAN_CONTAINER = &quot;hibernate.resource.beans.container&quot;;String C3P0_CONFIG_PREFIX = &quot;hibernate.c3p0&quot;;String C3P0_MAX_SIZE = &quot;hibernate.c3p0.max_size&quot;;String C3P0_MIN_SIZE = &quot;hibernate.c3p0.min_size&quot;;String C3P0_TIMEOUT = &quot;hibernate.c3p0.timeout&quot;;String C3P0_MAX_STATEMENTS = &quot;hibernate.c3p0.max_statements&quot;;String C3P0_ACQUIRE_INCREMENT = &quot;hibernate.c3p0.acquire_increment&quot;;String C3P0_IDLE_TEST_PERIOD = &quot;hibernate.c3p0.idle_test_period&quot;;String PROXOOL_CONFIG_PREFIX = &quot;hibernate.proxool&quot;;String PROXOOL_PREFIX = PROXOOL_CONFIG_PREFIX;String PROXOOL_XML = &quot;hibernate.proxool.xml&quot;;String PROXOOL_PROPERTIES = &quot;hibernate.proxool.properties&quot;;String PROXOOL_EXISTING_POOL = &quot;hibernate.proxool.existing_pool&quot;;String PROXOOL_POOL_ALIAS = &quot;hibernate.proxool.pool_alias&quot;;String CACHE_REGION_FACTORY = &quot;hibernate.cache.region.factory_class&quot;;String CACHE_KEYS_FACTORY = &quot;hibernate.cache.keys_factory&quot;;String CACHE_PROVIDER_CONFIG = &quot;hibernate.cache.provider_configuration_file_resource_path&quot;;String USE_SECOND_LEVEL_CACHE = &quot;hibernate.cache.use_second_level_cache&quot;;String USE_QUERY_CACHE = &quot;hibernate.cache.use_query_cache&quot;;String QUERY_CACHE_FACTORY = &quot;hibernate.cache.query_cache_factory&quot;;String CACHE_REGION_PREFIX = &quot;hibernate.cache.region_prefix&quot;;String USE_MINIMAL_PUTS = &quot;hibernate.cache.use_minimal_puts&quot;;String USE_STRUCTURED_CACHE = &quot;hibernate.cache.use_structured_entries&quot;;String AUTO_EVICT_COLLECTION_CACHE = &quot;hibernate.cache.auto_evict_collection_cache&quot;;String USE_DIRECT_REFERENCE_CACHE_ENTRIES = &quot;hibernate.cache.use_reference_entries&quot;;String DEFAULT_ENTITY_MODE = &quot;hibernate.default_entity_mode&quot;;String GLOBALLY_QUOTED_IDENTIFIERS = &quot;hibernate.globally_quoted_identifiers&quot;;String GLOBALLY_QUOTED_IDENTIFIERS_SKIP_COLUMN_DEFINITIONS = &quot;hibernate.globally_quoted_identifiers_skip_column_definitions&quot;;String CHECK_NULLABILITY = &quot;hibernate.check_nullability&quot;;String BYTECODE_PROVIDER = &quot;hibernate.bytecode.provider&quot;;String JPAQL_STRICT_COMPLIANCE= &quot;hibernate.query.jpaql_strict_compliance&quot;;String PREFER_POOLED_VALUES_LO = &quot;hibernate.id.optimizer.pooled.prefer_lo&quot;;String PREFERRED_POOLED_OPTIMIZER = &quot;hibernate.id.optimizer.pooled.preferred&quot;;String QUERY_PLAN_CACHE_MAX_STRONG_REFERENCES = &quot;hibernate.query.plan_cache_max_strong_references&quot;;String QUERY_PLAN_CACHE_MAX_SOFT_REFERENCES = &quot;hibernate.query.plan_cache_max_soft_references&quot;;String QUERY_PLAN_CACHE_MAX_SIZE = &quot;hibernate.query.plan_cache_max_size&quot;;String QUERY_PLAN_CACHE_PARAMETER_METADATA_MAX_SIZE = &quot;hibernate.query.plan_parameter_metadata_max_size&quot;;String NON_CONTEXTUAL_LOB_CREATION = &quot;hibernate.jdbc.lob.non_contextual_creation&quot;;String HBM2DDL_AUTO = &quot;hibernate.hbm2ddl.auto&quot;;String HBM2DDL_DATABASE_ACTION = &quot;javax.persistence.schema-generation.database.action&quot;;String HBM2DDL_SCRIPTS_ACTION = &quot;javax.persistence.schema-generation.scripts.action&quot;;String HBM2DDL_CONNECTION = &quot;javax.persistence.schema-generation-connection&quot;;String HBM2DDL_DB_NAME = &quot;javax.persistence.database-product-name&quot;;String HBM2DDL_DB_MAJOR_VERSION = &quot;javax.persistence.database-major-version&quot;;String HBM2DDL_DB_MINOR_VERSION = &quot;javax.persistence.database-minor-version&quot;;String HBM2DDL_CREATE_SOURCE = &quot;javax.persistence.schema-generation.create-source&quot;;String HBM2DDL_DROP_SOURCE = &quot;javax.persistence.schema-generation.drop-source&quot;;String HBM2DDL_CREATE_SCRIPT_SOURCE = &quot;javax.persistence.schema-generation.create-script-source&quot;;String HBM2DDL_DROP_SCRIPT_SOURCE = &quot;javax.persistence.schema-generation.drop-script-source&quot;;String HBM2DDL_SCRIPTS_CREATE_TARGET = &quot;javax.persistence.schema-generation.scripts.create-target&quot;;String HBM2DDL_SCRIPTS_DROP_TARGET = &quot;javax.persistence.schema-generation.scripts.drop-target&quot;;String HBM2DDL_IMPORT_FILES = &quot;hibernate.hbm2ddl.import_files&quot;;String HBM2DDL_LOAD_SCRIPT_SOURCE = &quot;javax.persistence.sql-load-script-source&quot;;String HBM2DDL_IMPORT_FILES_SQL_EXTRACTOR = &quot;hibernate.hbm2ddl.import_files_sql_extractor&quot;;String HBM2DDL_CREATE_NAMESPACES = &quot;hibernate.hbm2ddl.create_namespaces&quot;;String HBM2DLL_CREATE_NAMESPACES = &quot;hibernate.hbm2dll.create_namespaces&quot;;String HBM2DDL_CREATE_SCHEMAS = &quot;javax.persistence.create-database-schemas&quot;;String HBM2DLL_CREATE_SCHEMAS = HBM2DDL_CREATE_SCHEMAS;String HBM2DDL_FILTER_PROVIDER = &quot;hibernate.hbm2ddl.schema_filter_provider&quot;;String HBM2DDL_JDBC_METADATA_EXTRACTOR_STRATEGY = &quot;hibernate.hbm2ddl.jdbc_metadata_extraction_strategy&quot;;String HBM2DDL_DELIMITER = &quot;hibernate.hbm2ddl.delimiter&quot;;String HBM2DDL_CHARSET_NAME = &quot;hibernate.hbm2ddl.charset_name&quot;;String HBM2DDL_HALT_ON_ERROR = &quot;hibernate.hbm2ddl.halt_on_error&quot;;String JMX_ENABLED = &quot;hibernate.jmx.enabled&quot;;String JMX_PLATFORM_SERVER = &quot;hibernate.jmx.usePlatformServer&quot;;String JMX_AGENT_ID = &quot;hibernate.jmx.agentId&quot;;String JMX_DOMAIN_NAME = &quot;hibernate.jmx.defaultDomain&quot;;String JMX_SF_NAME = &quot;hibernate.jmx.sessionFactoryName&quot;;String JMX_DEFAULT_OBJ_NAME_DOMAIN = &quot;org.hibernate.core&quot;;String CUSTOM_ENTITY_DIRTINESS_STRATEGY = &quot;hibernate.entity_dirtiness_strategy&quot;;String USE_ENTITY_WHERE_CLAUSE_FOR_COLLECTIONS = &quot;hibernate.use_entity_where_clause_for_collections&quot;;String MULTI_TENANT = &quot;hibernate.multiTenancy&quot;;String MULTI_TENANT_CONNECTION_PROVIDER = &quot;hibernate.multi_tenant_connection_provider&quot;;String MULTI_TENANT_IDENTIFIER_RESOLVER = &quot;hibernate.tenant_identifier_resolver&quot;;String INTERCEPTOR = &quot;hibernate.session_factory.interceptor&quot;;String SESSION_SCOPED_INTERCEPTOR = &quot;hibernate.session_factory.session_scoped_interceptor&quot;;String STATEMENT_INSPECTOR = &quot;hibernate.session_factory.statement_inspector&quot;;String ENABLE_LAZY_LOAD_NO_TRANS = &quot;hibernate.enable_lazy_load_no_trans&quot;;String HQL_BULK_ID_STRATEGY = &quot;hibernate.hql.bulk_id_strategy&quot;;String BATCH_FETCH_STYLE = &quot;hibernate.batch_fetch_style&quot;;String DELAY_ENTITY_LOADER_CREATIONS = &quot;hibernate.loader.delay_entity_loader_creations&quot;;String JTA_TRACK_BY_THREAD = &quot;hibernate.jta.track_by_thread&quot;;String JACC_CONTEXT_ID = &quot;hibernate.jacc_context_id&quot;;String JACC_PREFIX = &quot;hibernate.jacc&quot;;String JACC_ENABLED = &quot;hibernate.jacc.enabled&quot;;String ENABLE_SYNONYMS = &quot;hibernate.synonyms&quot;;String EXTRA_PHYSICAL_TABLE_TYPES = &quot;hibernate.hbm2ddl.extra_physical_table_types&quot;;String DEPRECATED_EXTRA_PHYSICAL_TABLE_TYPES = &quot;hibernate.hbm2dll.extra_physical_table_types&quot;;String UNIQUE_CONSTRAINT_SCHEMA_UPDATE_STRATEGY = &quot;hibernate.schema_update.unique_constraint_strategy&quot;;String GENERATE_STATISTICS = &quot;hibernate.generate_statistics&quot;;String LOG_SESSION_METRICS = &quot;hibernate.session.events.log&quot;;String LOG_SLOW_QUERY = &quot;hibernate.session.events.log.LOG_QUERIES_SLOWER_THAN_MS&quot;;String AUTO_SESSION_EVENTS_LISTENER = &quot;hibernate.session.events.auto&quot;;String PROCEDURE_NULL_PARAM_PASSING = &quot;hibernate.proc.param_null_passing&quot;;String CREATE_EMPTY_COMPOSITES_ENABLED = &quot;hibernate.create_empty_composites.enabled&quot;;String ALLOW_JTA_TRANSACTION_ACCESS = &quot;hibernate.jta.allowTransactionAccess&quot;;String ALLOW_UPDATE_OUTSIDE_TRANSACTION = &quot;hibernate.allow_update_outside_transaction&quot;;String COLLECTION_JOIN_SUBQUERY = &quot;hibernate.collection_join_subquery&quot;;String ALLOW_REFRESH_DETACHED_ENTITY = &quot;hibernate.allow_refresh_detached_entity&quot;;String MERGE_ENTITY_COPY_OBSERVER = &quot;hibernate.event.merge.entity_copy_observer&quot;;String USE_LEGACY_LIMIT_HANDLERS = &quot;hibernate.legacy_limit_handler&quot;;String VALIDATE_QUERY_PARAMETERS = &quot;hibernate.query.validate_parameters&quot;;String CRITERIA_LITERAL_HANDLING_MODE = &quot;hibernate.criteria.literal_handling_mode&quot;;String PREFER_GENERATOR_NAME_AS_DEFAULT_SEQUENCE_NAME = &quot;hibernate.model.generator_name_as_sequence_name&quot;;String JPA_TRANSACTION_COMPLIANCE = &quot;hibernate.jpa.compliance.transaction&quot;;String JPA_QUERY_COMPLIANCE = &quot;hibernate.jpa.compliance.query&quot;;String JPA_LIST_COMPLIANCE = &quot;hibernate.jpa.compliance.list&quot;;String JPA_CLOSED_COMPLIANCE = &quot;hibernate.jpa.compliance.closed&quot;;String JPA_PROXY_COMPLIANCE = &quot;hibernate.jpa.compliance.proxy&quot;;String JPA_CACHING_COMPLIANCE = &quot;hibernate.jpa.compliance.caching&quot;;String JPA_ID_GENERATOR_GLOBAL_SCOPE_COMPLIANCE = &quot;hibernate.jpa.compliance.global_id_generators&quot;;String TABLE_GENERATOR_STORE_LAST_USED = &quot;hibernate.id.generator.stored_last_used&quot;;String FAIL_ON_PAGINATION_OVER_COLLECTION_FETCH = &quot;hibernate.query.fail_on_pagination_over_collection_fetch&quot;;String IMMUTABLE_ENTITY_UPDATE_QUERY_HANDLING_MODE = &quot;hibernate.query.immutable_entity_update_query_handling_mode&quot;;String IN_CLAUSE_PARAMETER_PADDING = &quot;hibernate.query.in_clause_parameter_padding&quot;;String QUERY_STATISTICS_MAX_SIZE = &quot;hibernate.statistics.query_max_size&quot;;String SEQUENCE_INCREMENT_SIZE_MISMATCH_STRATEGY = &quot;hibernate.id.sequence.increment_size_mismatch_strategy&quot;;String OMIT_JOIN_OF_SUPERCLASS_TABLES = &quot;hibernate.query.omit_join_of_superclass_tables&quot;; AvailableSettings é‡Œé¢çš„é…ç½®é¡¹çš„ç”¨æ³•åªéœ€è¦å°† AvailableSettings å˜é‡çš„å€¼æ”¾åˆ° spring.jpa.properties é‡Œé¢å³å¯ï¼Œå¦‚ä¸‹è¿™äº›æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ã€‚ 123456789101112131415161718192021##å¼€å¯hibernate statisticsçš„ä¿¡æ¯ï¼Œå¦‚sessionã€è¿žæŽ¥ç­‰æ—¥å¿—ï¼šspring.jpa.properties.hibernate.generate_statistics=true# æ ¼å¼åŒ– SQLspring.jpa.properties.hibernate.format_sql: true# æ˜¾ç¤º SQLspring.jpa.properties.hibernate.show_sql: true# æ·»åŠ  HQL ç›¸å…³çš„æ³¨é‡Šä¿¡æ¯spring.jpa.properties.hibernate.use_sql_comments: true# hbm2ddlçš„ç­–ç•¥ validate, update, create, create-drop, noneï¼Œå»ºè®®é…ç½®æˆvalidateï¼Œ# è¿™æ ·åœ¨æˆ‘ä»¬å¯åŠ¨é¡¹ç›®çš„æ—¶å€™å°±çŸ¥é“ç”Ÿäº§æ•°æ®åº“çš„è¡¨ç»“æž„æ˜¯å¦æ­£ç¡®çš„äº†ï¼Œè€Œä¸ç”¨ç­‰åˆ°è¿è¡ŒæœŸé—´æ‰å‘çŽ°é—®é¢˜ã€‚spring.jpa.properties.hibernate.hbm2ddl.auto=validate# å…³è”å…³ç³»çš„æ—¶å€™å–æ•°æ®çš„æ·±åº¦ï¼Œé»˜è®¤æ˜¯3å±‚ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æˆ2çº§ï¼Œé˜²æ­¢å…¶ä»–å¼€å‘ä¹±ç”¨ï¼Œæé«˜sqlæ€§èƒ½spring.jpa.properties.hibernate.max_fetch_depth=2# æ‰¹é‡fetchå¤§å°é»˜è®¤ -1spring.jpa.properties.hibernate.default_batch_fetch_size= 100# äº‹åŠ¡å®Œæˆä¹‹å‰æ˜¯å¦è¿›è¡Œflushæ“ä½œï¼Œå³åŒæ­¥åˆ°dbé‡Œé¢åŽ»ï¼Œé»˜è®¤æ˜¯truespring.jpa.properties.hibernate.transaction.flush_before_completion=true# äº‹åŠ¡ç»“æŸä¹‹åŽæ˜¯å¦å…³é—­sessionï¼Œé»˜è®¤falsespring.jpa.properties.hibernate.transaction.auto_close_session=false# æœ‰çš„æ—¶å€™ä¸åªè¦æ‰¹é‡æŸ¥è¯¢ï¼Œä¹Ÿä¼šæ‰¹é‡æ›´æ–°ï¼Œé»˜è®¤batch sizeæ˜¯15ï¼Œå¯ä»¥æ ¹æ®å®žé™…æƒ…å†µè‡ªç”±è°ƒæ•´ï¼Œå¯ä»¥æé«˜æ‰¹é‡æ›´æ–°çš„æ•ˆçŽ‡ï¼›spring.jpa.properties.hibernate.jdbc.batch_size=100 è‡ªåŠ¨åŠ è½½è¿‡ç¨‹ç±»ä¹‹é—´çš„å…³ç³»å›¾ ä»Žä¸Šå›¾ä¸­ï¼Œå¯ä»¥çœ‹å‡ºä»¥ä¸‹å‡ ç‚¹å†…å®¹ã€‚ JpaBaseConfiguration æ˜¯ Jpa å’Œ Hibernate è¢«åŠ è½½çš„åŸºçŸ³ï¼Œé‡Œé¢é€šè¿‡ BeanFactoryAware çš„æŽ¥å£çš„ bean åŠ è½½ç”Ÿå‘½å‘¨æœŸä¹Ÿå®žçŽ°äº†ä¸€äº›é€»è¾‘ã€‚ HibernateJpaConfiguration æ˜¯ JpaBaseConfiguration çš„å­ç±»ï¼Œè¦†ç›–äº†ä¸€äº›çˆ¶ç±»é‡Œé¢çš„é…ç½®ç›¸å…³çš„ç‰¹æ®Šé€»è¾‘ï¼Œå¹¶ä¸”é‡Œé¢å¼•ç”¨äº† JpaPropeties å’Œ HibernateProperties çš„é…ç½®é¡¹ã€‚ HibernateJpaAutoConfiguration æ˜¯ Spring Boot è‡ªåŠ¨åŠ è½½ HibernateJpaConfiguration çš„æ¡¥æ¢ï¼Œèµ·åˆ°äº†å¯¼å…¥å’ŒåŠ è½½ HibernateJpaConfiguration çš„ä½œç”¨ã€‚ JpaRepositoriesAutoConfiguration å’Œ HibernateJpaAutoConfigurationã€DataSourceAutoConfiguration åˆ†åˆ«åŠ è½½ JpaRepositories çš„é€»è¾‘å’Œ Hibernate/JPAã€æ•°æ®æºï¼Œéƒ½æ˜¯è¢« spring.factories è‡ªåŠ¨è£…é…è¿›å…¥åˆ° Spring Boot é‡Œé¢çš„ï¼Œè€Œä¸‰è€…ä¹‹é—´æœ‰åŠ è½½çš„å…ˆåŽé¡ºåºã€‚ ä¸Šå›¾çš„ UML è¿˜å±•ç¤ºäº†å‡ ä¸ª Configuration ç±»çš„åŠ è½½é¡ºåºå’Œä¾èµ–å…³ç³»ï¼Œé¡ºåºæ˜¯ä»Žä¸Šåˆ°ä¸‹è¿›è¡ŒåŠ è½½çš„ DataSourceAutoConfiguration æœ€å…ˆåŠ è½½ HibernateJpaAutoConfiguration ç¬¬äºŒé¡ºåºåŠ è½½ JpaRepositoriesAutoConfiguration æœ€åŽåŠ è½½ Spring Data JPA Repositories Bootstrap Modeäº†è§£å®Œäº† Hibernate åœ¨ Spring Boot é‡Œé¢çš„åŠ è½½è¿‡ç¨‹ï¼Œé‚£ä¹ˆæ¥çœ‹ä¸‹ JpaRepositoriesAutoConfiguration çš„ä¸»è¦ä½œç”¨æœ‰å“ªäº›ï¼Ÿ é€šè¿‡ä¸Šé¢åˆ†äº«çš„æ•´ä¸ªåŠ è½½è¿‡ç¨‹å¯ä»¥å‘çŽ°ï¼š DataSourceAutoConfiguration å®Œæˆäº†æ•°æ®æºçš„åŠ è½½ HibernateJpaAutoConfiguration å®Œæˆäº† Hibernate çš„åŠ è½½è¿‡ç¨‹ JpaRepositoriesAutoConfiguration å®Œæˆäº†å„ç§ JpaRepositories çš„åŠ è½½è¿‡ç¨‹ï¼Œè¿™æ˜¯ Spring Data JPA çš„ä¸»è¦å®žçŽ°é€»è¾‘ï¼Œå’Œ Hibernateã€æ•°æ®æºæ²¡ä»€ä¹ˆå…³ç³»ã€‚ å¯ä»¥é€šè¿‡ JpaRepositoriesAutoConfiguration çš„æºç å‘çŽ°å…¶ä¸»è¦èŒè´£å’Œå®žçŽ°æ–¹å¼ï¼Œåˆ©ç”¨å¼‚æ­¥çº¿ç¨‹æ± åˆå§‹åŒ– repositoriesï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š è€Œå…¶ä¸­åŠ è½½ repositories æœ‰ä¸‰ç§æ–¹å¼ï¼Œå³ spring.data.jpa.repositories.bootstrap-mode çš„ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«ä¸º deferredã€ lazyã€ default deferredï¼šæ˜¯é»˜è®¤å€¼ï¼Œè¡¨ç¤ºåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šè¿›è¡Œæ•°æ®åº“å­—æ®µçš„æ£€æŸ¥ï¼Œè€Œ repositories ç›¸å…³çš„å®žä¾‹çš„åˆå§‹åŒ–æ˜¯ lazy æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨åˆ° repositories å®žä¾‹çš„æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™ä¸ªæ¯”è¾ƒé€‚åˆç”¨åœ¨æµ‹è¯•çŽ¯å¢ƒå’Œç”Ÿäº§çŽ¯å¢ƒä¸­ï¼Œå› ä¸ºæµ‹è¯•ä¸å¯èƒ½è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œä¸‡ä¸€è°å¤šåŠ ä¸ªå­—æ®µæˆ–è€…å°‘ä¸€ä¸ªå­—æ®µï¼Œè¿™æ ·åœ¨å¯åŠ¨çš„é˜¶æ®µå°±å¯ä»¥åŠæ—¶å‘çŽ°é—®é¢˜ï¼Œä¸èƒ½ç­‰è¿›è¡Œåˆ°ç”Ÿäº§çŽ¯å¢ƒæ‰æš´éœ²ã€‚ lazyï¼šè¡¨ç¤ºå¯åŠ¨é˜¶æ®µä¸ä¼šè¿›è¡Œæ•°æ®åº“å­—æ®µçš„æ£€æŸ¥ï¼Œä¹Ÿä¸ä¼šåˆå§‹åŒ– repositories ç›¸å…³çš„å®žä¾‹ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡ç”¨åˆ° repositories å®žä¾‹çš„æ—¶å€™å†è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™ä¸ªæ¯”è¾ƒé€‚åˆç”¨åœ¨å¼€å‘çš„é˜¶æ®µï¼Œå¯ä»¥åŠ å¿«åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ã€‚å¦‚æžœç”Ÿäº§çŽ¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†æé«˜ä¸šåŠ¡é«˜å³°æœŸé—´æ°´å¹³æ¥æ‰©å±•åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚ defaultï¼šé»˜è®¤åŠ è½½æ–¹å¼ï¼Œä½†ä»Ž Spring Boot 2.0 ä¹‹åŽå°±ä¸æ˜¯é»˜è®¤å€¼äº†ï¼Œè¡¨ç¤ºç«‹å³éªŒè¯ã€ç«‹å³åˆå§‹åŒ– repositories å®žä¾‹ï¼Œè¿™ç§æ–¹å¼å¯åŠ¨çš„é€Ÿåº¦æœ€æ…¢ï¼Œä½†æ˜¯æœ€ä¿é™©ï¼Œè¿è¡ŒæœŸé—´çš„è¯·æ±‚æœ€å¿«ï¼Œå› ä¸ºé¿å…äº†ç¬¬ä¸€æ¬¡è¯·æ±‚åˆå§‹åŒ– repositories å®žä¾‹çš„è¿‡ç¨‹ã€‚ æˆ‘ä»¬é€šè¿‡åœ¨ application.properties é‡Œé¢ä¿®æ”¹è¿™ä¸€è¡Œä»£ç ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹ lazy çš„åŠ è½½æ–¹å¼ã€‚ 1spring.data.jpa.repositories.bootstrap-mode=lazy ç„¶åŽå¯åŠ¨é¡¹ç›®ï¼Œå°±ä¼šå‘çŽ°åœ¨ tomcat å®¹å™¨åŠ è½½å®Œä¹‹åŽï¼Œæ²¡æœ‰ç”¨åˆ° UserInfoRepository ä¹‹å‰ï¼Œè¿™ä¸ª UserInfoRepository æ˜¯ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–çš„ã€‚è€Œå½“æˆ‘ä»¬å‘ä¸€ä¸ªè¯·æ±‚ç”¨åˆ°äº† UserInfoRepositoryï¼Œå°±è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ é€šè¿‡æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå¯åŠ¨çš„çº¿ç¨‹å’Œåˆå§‹åŒ–çš„çº¿ç¨‹æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œåˆå§‹åŒ–çš„çº¿ç¨‹æ˜¯ NIO çº¿ç¨‹çš„åå­—ï¼Œè¡¨ç¤º request çš„ http çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Debug æ—¶å€™ï¼Œæ—¥å¿—çš„é…ç½®12345678910111213141516171819202122232425262728293031323334353637### æ—¥å¿—çº§åˆ«çš„çµæ´»è¿ç”¨## hibernateç›¸å…³# æ˜¾ç¤ºsqlçš„æ‰§è¡Œæ—¥å¿—ï¼Œå¦‚æžœå¼€äº†è¿™ä¸ª,show_sqlå°±å¯ä»¥ä¸ç”¨äº†logging.level.org.hibernate.SQL=debug# hibernate idçš„ç”Ÿæˆæ—¥å¿—logging.level.org.hibernate.id=debug# hibernateæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯PreparedStatementï¼ŒæŠŠsqlçš„æ‰§è¡Œå‚æ•°æ˜¾ç¤ºå‡ºæ¥logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE# sqlæ‰§è¡Œå®Œæå–çš„è¿”å›žå€¼logging.level.org.hibernate.type.descriptor.sql=trace# è¯·æ±‚å‚æ•°logging.level.org.hibernate.type=debug# ç¼“å­˜ç›¸å…³logging.level.org.hibernate.cache=debug# ç»Ÿè®¡hibernateçš„æ‰§è¡ŒçŠ¶æ€logging.level.org.hibernate.stat=debug# æŸ¥çœ‹æ‰€æœ‰çš„ç¼“å­˜æ“ä½œlogging.level.org.hibernate.event.internal=tracelogging.level.org.springframework.cache=trace# hibernate çš„ç›‘æŽ§æŒ‡æ ‡æ—¥å¿—logging.level.org.hibernate.engine.internal.StatisticalLoggingSessionEventListener=DEBUG### è¿žæŽ¥æ± çš„ç›¸å…³æ—¥å¿—## hikariè¿žæŽ¥æ± çš„çŠ¶æ€æ—¥å¿—ï¼Œä»¥åŠè¿žæŽ¥æ± æ˜¯å¦å®Œå¥½ #è¿žæŽ¥æ± çš„æ—¥å¿—æ•ˆæžœï¼šHikariCPPool - Pool stats (total=20, active=0, idle=20, waiting=0)logging.level.com.zaxxer.hikari=TRACE#å¼€å¯ debugå¯ä»¥çœ‹åˆ° AvailableSettingsé‡Œé¢çš„é»˜è®¤é…ç½®çš„å€¼éƒ½æœ‰å“ªäº›ï¼Œä¼šè¾“å‡ºç±»ä¼¼ä¸‹é¢çš„æ—¥å¿—æ ¼å¼# org.hibernate.cfg.Settings : Statistics: enabled# org.hibernate.cfg.Settings : Default batch fetch size: -1logging.level.org.hibernate.cfg=debug#hikariæ•°æ®çš„é…ç½®é¡¹æ—¥å¿—logging.level.com.zaxxer.hikari.HikariConfig=TRACE### æŸ¥çœ‹äº‹åŠ¡ç›¸å…³çš„æ—¥å¿—ï¼Œäº‹åŠ¡èŽ·å–ï¼Œé‡Šæ”¾æ—¥å¿—logging.level.org.springframework.orm.jpa=DEBUGlogging.level.org.springframework.transaction=TRACElogging.level.org.hibernate.engine.transaction.internal.TransactionImpl=DEBUG### åˆ†æžconnect ä»¥åŠ ormå’Œ dataçš„å¤„ç†è¿‡ç¨‹æ›´å…¨çš„æ—¥å¿—logging.level.org.springframework.data=tracelogging.level.org.springframework.orm=trace ä¸Šé¢æ˜¯åœ¨åˆ†æžå¤æ‚é—®é¢˜å’ŒåŽŸç†çš„æ—¶å€™å¸¸ç”¨çš„æ—¥å¿—é…ç½®é¡¹ç›® ðŸŽ¯æŠ€å·§ï¼š å½“æˆ‘ä»¬åˆ†æžä¸€ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œå¦‚æžœä¸çŸ¥é“æ—¥å¿—å…·ä½“åœ¨å“ªä¸ªç±»é‡Œé¢ï¼Œé€šè¿‡è®¾ç½® logging.level.root=trace çš„è¯ï¼Œæ—¥å¿—åˆéžå¸¸å¤šå‡ ä¹Žæ²¡æœ‰åŠžæ³•çœ‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç¼©å°èŒƒå›´ï¼Œä¸å¦‚è¯´æˆ‘ä»¬åˆ†æžçš„æ˜¯ hikari åŒ…é‡Œé¢ç›¸å…³çš„é—®é¢˜ã€‚ æˆ‘ä»¬å¯ä»¥æŠŠæ•´ä¸ªæ—¥å¿—çº§åˆ« logging.level.root=info è®¾ç½®æˆ infoï¼ŒæŠŠå…¶ä»–æ‰€æœ‰çš„æ—¥å¿—éƒ½å…³é—­ï¼Œå¹¶æŠŠ logging.level.com.zaxxer=trace è®¾ç½®æˆæœ€å¤§çš„ï¼Œä¿æŒæ—¥å¿—ä¸å—å¹²æ‰°ï¼Œç„¶åŽè§‚å¯Ÿæ—¥å¿—å†é€æ¸å‡å°‘æŸ¥çœ‹èŒƒå›´ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa äº‹åŠ¡ä¸Žè¿žæŽ¥æ± ]]></title>
    <url>%2F2020%2F11%2F18%2FSpringDataJpa%E4%BA%8B%E5%8A%A1%E4%B8%8E%E8%BF%9E%E6%8E%A5%E6%B1%A0%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa äº‹åŠ¡ä¸Žè¿žæŽ¥æ± äº‹åŠ¡çš„åŸºæœ¬åŽŸç†ä»¥ MySQL 5.7 ä¸ºä¾‹ï¼š å½“ MySQL ä½¿ç”¨ InnoDB æ•°æ®åº“å¼•æ“Žçš„æ—¶å€™ï¼Œæ•°æ®åº“æ˜¯å¯¹äº‹åŠ¡æœ‰æ”¯æŒçš„ã€‚è€Œäº‹åŠ¡æœ€ä¸»è¦çš„ä½œç”¨æ˜¯ä¿è¯æ•°æ® ACID çš„ç‰¹æ€§ï¼Œå³åŽŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚åˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šï¼š åŽŸå­æ€§ï¼š æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ï¼ˆTransactionï¼‰ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨å›žæ»šï¼Œè€Œä¸ä¼šæœ‰ä¸­é—´æŸä¸ªæ•°æ®å•ç‹¬æ›´æ–°çš„æ“ä½œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸€æ—¦å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›žæ»šï¼ˆRollbackï¼‰åˆ°æ­¤æ¬¡äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»Žæ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚ ä¸€è‡´æ€§ï¼š æ˜¯æŒ‡äº‹åŠ¡æ“ä½œå¼€å§‹ä¹‹å‰ï¼Œå’Œæ“ä½œå¼‚å¸¸å›žæ»šä»¥åŽï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚æ•°æ®åº“äº‹åŠ¡ commit ä¹‹åŽï¼Œæ•°æ®ä¹Ÿæ˜¯æŒ‰ç…§æˆ‘ä»¬é¢„æœŸæ­£ç¡®æ‰§è¡Œçš„ã€‚å³è¦é€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚ æŒä¹…æ€§ï¼š æ˜¯æŒ‡äº‹åŠ¡å¤„ç†ç»“æŸåŽï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹è¿›è¡Œäº†æŒä¹…åŒ–çš„æ°¸ä¹…ä¿å­˜ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œå…¶å®žå°±æ˜¯ä¿å­˜åˆ°ç¡¬ç›˜ã€‚ éš”ç¦»æ€§ï¼š æ˜¯æŒ‡æ•°æ®åº“å…è®¸å¤šä¸ªè¿žæŽ¥ï¼ŒåŒæ—¶å¹¶å‘å¤šä¸ªäº‹åŠ¡ï¼Œåˆå¯¹åŒä¸€ä¸ªæ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œéš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œç”±äºŽäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„çŽ°è±¡ã€‚è€Œ MySQL é‡Œé¢å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„äº‹åŠ¡çš„å››ç§éš”ç¦»çº§åˆ«ï¼Œå³è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚ MySQL äº‹åŠ¡çš„éš”ç¦»çº§åˆ« Read Uncommittedï¼ˆè¯»å–æœªæäº¤å†…å®¹ï¼‰ï¼šæ­¤éš”ç¦»çº§åˆ«ï¼Œè¡¨ç¤ºæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“æžœã€‚ä¸åŒäº‹åŠ¡ä¹‹é—´è¯»å–åˆ°å…¶ä»–äº‹åŠ¡ä¸­æœªæäº¤çš„æ•°æ®ï¼Œé€šå¸¸è¿™ç§æƒ…å†µä¹Ÿè¢«ç§°ä¹‹ä¸ºè„è¯»ï¼ˆDirty Readï¼‰ï¼Œä¼šé€ æˆæ•°æ®çš„é€»è¾‘å¤„ç†é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å¤šçº¿ç¨‹é‡Œé¢ç»å¸¸è¯´çš„æ•°æ®ä¸å®‰å…¨äº†ã€‚åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå‡ ä¹Žå¾ˆå°‘è§åˆ°ä½¿ç”¨çš„ï¼Œå› ä¸ºå®ƒçš„æ€§èƒ½ä¹Ÿä¸æ¯”å…¶ä»–çº§åˆ«è¦å¥½å¤šå°‘ã€‚ Read Committedï¼ˆè¯»å–æäº¤å†…å®¹ï¼‰ï¼š æ­¤éš”ç¦»çº§åˆ«æ˜¯æŒ‡ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ç›¸åŒçš„ä¸¤æ¬¡æŸ¥è¯¢å¯èƒ½äº§ç”Ÿçš„ç»“æžœä¼šä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒæ¬¡æŸ¥è¯¢èƒ½è¯»å–åˆ°å…¶ä»–äº‹åŠ¡å·²ç»æäº¤çš„æœ€æ–°æ•°æ®ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä¸å¯é‡å¤è¯»ï¼ˆUnrepeatable Readï¼‰çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚å› ä¸ºåŒä¸€äº‹åŠ¡çš„å…¶ä»–å®žä¾‹åœ¨è¯¥å®žä¾‹å¤„ç†æœŸé—´ï¼Œå¯èƒ½ä¼šå¯¹å…¶ä»–äº‹åŠ¡è¿›è¡Œæ–°çš„ commitï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­çš„åŒä¸€ select ä¸Šï¼Œå¤šæ¬¡æ‰§è¡Œå¯èƒ½è¿”å›žä¸åŒç»“æžœã€‚è¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†ä¸æ˜¯ MySQL é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼‰ã€‚ Repeatable Readï¼ˆå¯é‡è¯»ï¼‰ï¼š è¿™æ˜¯ MySQL çš„é»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œå®ƒç¡®ä¿åŒä¸€ä¸ªäº‹åŠ¡å¤šæ¬¡æŸ¥è¯¢ç›¸åŒçš„æ•°æ®ï¼Œèƒ½è¯»åˆ°ç›¸åŒçš„æ•°æ®ã€‚å³ä½¿å¤šä¸ªäº‹åŠ¡çš„ä¿®æ”¹å·²ç» commitï¼Œæœ¬äº‹åŠ¡å¦‚æžœæ²¡æœ‰ç»“æŸï¼Œæ°¸è¿œè¯»åˆ°çš„æ˜¯ç›¸åŒæ•°æ®ï¼Œè¦æ³¨æ„å®ƒä¸ŽRead Committed çš„éš”ç¦»çº§åˆ«çš„åŒºåˆ«ï¼Œæ˜¯æ­£å¥½ç›¸åçš„ã€‚è¿™ä¼šå¯¼è‡´å¦ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼šå¹»è¯» ï¼ˆPhantom Readï¼‰ï¼Œå³è¯»åˆ°çš„æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ã€‚è¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ï¼Œä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜Žã€‚ ç¬¬ä¸€æ­¥ï¼šç”¨å·¥å…·æ‰“å¼€ä¸€ä¸ªæ•°æ®åº“çš„ DB è¿žæŽ¥ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ æŸ¥çœ‹ä¸€ä¸‹æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚ ç„¶åŽå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ user_info çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨ user_info è¡¨é‡Œé¢æ’å…¥äº†ä¸‰æ¡æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç¬¬äºŒæ­¥ï¼šæˆ‘ä»¬æ‰“å¼€å¦å¤–ä¸€ä¸ªç›¸åŒæ•°æ®åº“çš„ DB è¿žæŽ¥ï¼Œåˆ é™¤ä¸€æ¡æ•°æ®ï¼ŒSQL å¦‚ä¸‹ï¼š å½“åˆ é™¤æ‰§è¡ŒæˆåŠŸä¹‹åŽï¼Œæˆ‘ä»¬å¯ä»¥å¼€å¯ç¬¬ä¸‰ä¸ªè¿žæŽ¥ï¼Œçœ‹ä¸€ä¸‹æ•°æ®åº“é‡Œé¢ç¡®å®žå°‘äº†ä¸€æ¡ ID=1 çš„æ•°æ®ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†è¿”å›žç¬¬ä¸€ä¸ªè¿žæŽ¥ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œ select * from user_infoï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŸ¥åˆ°çš„è¿˜æ˜¯ä¸‰æ¡æ•°æ®ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„å¯é‡å¤è¯»ã€‚ Serializableï¼ˆå¯ä¸²è¡ŒåŒ–ï¼‰ï¼šè¿™æ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®ƒä¿è¯äº†æ¯ä¸ªäº‹åŠ¡æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå³å¼ºåˆ¶äº‹åŠ¡æŽ’åºï¼Œæ‰€æœ‰äº‹åŠ¡ä¹‹é—´ä¸å¯èƒ½äº§ç”Ÿå†²çªï¼Œä»Žè€Œè§£å†³å¹»è¯»é—®é¢˜ã€‚å¦‚æžœé…ç½®åœ¨è¿™ä¸ªçº§åˆ«çš„äº‹åŠ¡ï¼Œå¤„ç†æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå¹¶å‘æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡çš„ db è¿žæŽ¥è¶…æ—¶çŽ°è±¡å’Œé”ç«žäº‰ï¼Œä»Žè€Œé™ä½Žäº†æ•°æ®å¤„ç†çš„åžåé‡ã€‚ä¹Ÿå°±æ˜¯è¿™ä¸ªæ€§èƒ½æ¯”è¾ƒä½Žï¼Œæ‰€ä»¥é™¤äº†æŸäº›è´¢åŠ¡ç³»ç»Ÿä¹‹å¤–ï¼Œç”¨çš„äººä¸æ˜¯ç‰¹åˆ«å¤šã€‚ MySQL äº‹åŠ¡ä¸Žè¿žæŽ¥çš„å…³ç³»è¦æžæ¸…æ¥šäº‹åŠ¡å’Œè¿žæŽ¥æ± çš„å…³ç³»ï¼Œå¿…é¡»è¦å…ˆçŸ¥é“äºŒè€…å­˜åœ¨çš„å‰ææ¡ä»¶ã€‚ äº‹åŠ¡å¿…é¡»åœ¨åŒä¸€ä¸ªè¿žæŽ¥é‡Œé¢çš„ï¼Œç¦»å¼€è¿žæŽ¥æ²¡æœ‰äº‹åŠ¡å¯è¨€ï¼› MySQL æ•°æ®åº“é»˜è®¤ autocommit=1ï¼Œå³æ¯ä¸€æ¡ SQL æ‰§è¡Œå®Œè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼› æ•°æ®åº“é‡Œé¢çš„æ¯ä¸€æ¡ SQL æ‰§è¡Œçš„æ—¶å€™å¿…é¡»æœ‰äº‹åŠ¡çŽ¯å¢ƒï¼› MySQL åˆ›å»ºè¿žæŽ¥çš„æ—¶å€™é»˜è®¤å¼€å¯äº‹åŠ¡ï¼Œå…³é—­è¿žæŽ¥çš„æ—¶å€™å¦‚æžœå­˜åœ¨äº‹åŠ¡æ²¡æœ‰ commit çš„æƒ…å†µï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œ rollback æ“ä½œï¼› ä¸åŒçš„ connect ä¹‹é—´çš„äº‹åŠ¡æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚ çŸ¥é“äº†è¿™äº›æ¡ä»¶ï¼Œå°±å¯ä»¥ç»§ç»­æŽ¢ç´¢äºŒè€…çš„å…³ç³»äº†ã€‚åœ¨ connection å½“ä¸­ï¼Œæ“ä½œäº‹åŠ¡çš„æ–¹å¼åªæœ‰ä¸¤ç§ã€‚ MySQL äº‹åŠ¡çš„ä¸¤ç§æ“ä½œæ–¹å¼ç¬¬ä¸€ç§ï¼šç”¨ BEGINã€ROLLBACKã€COMMIT æ¥å®žçŽ°ã€‚ BEGIN å¼€å§‹ä¸€ä¸ªäº‹åŠ¡ ROLLBACK äº‹åŠ¡å›žæ»š COMMIT äº‹åŠ¡ç¡®è®¤ ç¬¬äºŒç§ï¼šç›´æŽ¥ç”¨ SET æ¥æ”¹å˜ MySQL çš„è‡ªåŠ¨æäº¤æ¨¡å¼ã€‚ SET AUTOCOMMIT=0 ç¦æ­¢è‡ªåŠ¨æäº¤ SET AUTOCOMMIT=1 å¼€å¯è‡ªåŠ¨æäº¤ MySQL æ•°æ®åº“çš„æœ€å¤§è¿žæŽ¥æ•°æ˜¯ä»€ä¹ˆï¼Ÿè€Œä»»ä½•æ•°æ®åº“çš„è¿žæŽ¥æ•°éƒ½æ˜¯æœ‰é™çš„ï¼Œå—å†…å­˜å’Œ CPU é™åˆ¶ã€‚ æŸ¥çœ‹æ•°æ®åº“æœ€å¤§è¿žæŽ¥æ•°ï¼š show variables like &#39;max_connections&#39; æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„è¿žæŽ¥æ•°ï¼š show global status like &#39;Max_used_connections&#39; è®¾ç½®æ•°æ®åº“æœ€å¤§è¿žæŽ¥æ•°ï¼š set global max_connections=1500 æ³¨æ„ï¼š å†è§‚å¯Ÿæ•°æ®åº“çš„è¿žæŽ¥æ•°çš„çš„åŒæ—¶ï¼Œéœ€è¦è§‚å¯ŸCPUå’Œå†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥æ­¤æ¥åˆ¤æ–­å½“å‰ç³»ç»Ÿæ•°æ®åº“ä¸­serverçš„è¿žæŽ¥æ•°æœ€ä½³å¤§å°æ˜¯å¤šå°‘ MySQL è¿žæŽ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯ 8 å°æ—¶ Spring é‡Œé¢äº‹åŠ¡çš„é…ç½®æ–¹æ³•Spring Bootä¼šé€šè¿‡ TransactionAutoConfiguration åŠ è½½ @EnableTransactionManagement æ³¨è§£å¸®æˆ‘ä»¬é»˜è®¤å¼€å¯äº‹åŠ¡ï¼Œå…³é”®ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Spring é‡Œé¢çš„äº‹åŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œå¸¸è§çš„æ˜¯ç›´æŽ¥é€šè¿‡ @Transaction çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œæ‰“å¼€ SimpleJpaRepository æºç ç±»ä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š 12345678Repository@Transactional(readOnly = true)public class SimpleJpaRepository&lt;T, ID&gt; implements JpaRepositoryImplementation&lt;T, ID&gt; &#123;...@Transactional@Overridepublic void deleteAll(Iterable&lt;? extends T&gt; entities) &#123;..... é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ SimpleJpaRepository é‡Œé¢çš„æ–¹æ³•éƒ½æ˜¯åªè¯»äº‹åŠ¡ï¼Œè€Œä¸€äº›æ›´æ–°çš„æ–¹æ³•éƒ½æ˜¯è¯»å†™äº‹åŠ¡ã€‚ æ‰€ä»¥æ¯ä¸ª Repository çš„æ–¹æ³•æ˜¯éƒ½æ˜¯æœ‰äº‹åŠ¡çš„ï¼Œå³ä½¿æ²¡æœ‰ä½¿ç”¨ä»»ä½•åŠ  @Transactional æ³¨è§£çš„æ–¹æ³•ï¼ŒæŒ‰ç…§ä¸Šé¢æ‰€è®²çš„ MySQL çš„ Transactional å¼€å¯åŽŸç†ï¼Œä¹Ÿä¼šæœ‰æ•°æ®åº“çš„äº‹åŠ¡ã€‚ é»˜è®¤ @Transactional æ³¨è§£å¼äº‹åŠ¡æ³¨è§£å¼äº‹åŠ¡åˆç§°æ˜¾å¼äº‹åŠ¡ï¼Œéœ€è¦æ‰‹åŠ¨æ˜¾å¼æ³¨è§£å£°æ˜Žï¼Œ@Transactional çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Inherited@Documentedpublic @interface Transactional &#123; @AliasFor("transactionManager") String value() default ""; @AliasFor("value") String transactionManager() default ""; Propagation propagation() default Propagation.REQUIRED; Isolation isolation() default Isolation.DEFAULT; int timeout() default TransactionDefinition.TIMEOUT_DEFAULT; boolean readOnly() default false; Class&lt;? extends Throwable&gt;[] rollbackFor() default &#123;&#125;; String[] rollbackForClassName() default &#123;&#125;; Class&lt;? extends Throwable&gt;[] noRollbackFor() default &#123;&#125;; String[] noRollbackForClassName() default &#123;&#125;;&#125; @Transactional æ³¨è§£ä¸­å¸¸ç”¨çš„å‚æ•°ï¼š å‚æ•°åç§° åŠŸèƒ½æè¿° readOnly è¯¥å±žæ€§ç”¨äºŽè®¾ç½®å½“å‰äº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œè®¾ç½®ä¸ºtrueè¡¨ç¤ºåªè¯»ï¼Œfalseåˆ™è¡¨ç¤ºå¯è¯»å†™ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚ä¾‹å¦‚ï¼š@Transactional(readOnly=true) rollbackFor è¯¥å±žæ€§ç”¨äºŽè®¾ç½®éœ€è¦è¿›è¡Œå›žæ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›žæ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š@Transactional(rollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š@Transactional(rollbackFor={RuntimeException.class, Exception.class}) rollbackForClassName è¯¥å±žæ€§ç”¨äºŽè®¾ç½®éœ€è¦è¿›è¡Œå›žæ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›žæ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š@Transactional(rollbackForClassName=â€RuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š@Transactional(rollbackForClassName={â€œRuntimeExceptionâ€,â€Exceptionâ€}) noRollbackFor è¯¥å±žæ€§ç”¨äºŽè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›žæ»šçš„å¼‚å¸¸ç±»æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›žæ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»ï¼š@Transactional(noRollbackFor=RuntimeException.class)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»ï¼š@Transactional(noRollbackFor={RuntimeException.class, Exception.class}) noRollbackForClassName è¯¥å±žæ€§ç”¨äºŽè®¾ç½®ä¸éœ€è¦è¿›è¡Œå›žæ»šçš„å¼‚å¸¸ç±»åç§°æ•°ç»„ï¼Œå½“æ–¹æ³•ä¸­æŠ›å‡ºæŒ‡å®šå¼‚å¸¸åç§°æ•°ç»„ä¸­çš„å¼‚å¸¸æ—¶ï¼Œä¸è¿›è¡Œäº‹åŠ¡å›žæ»šã€‚ä¾‹å¦‚ï¼šæŒ‡å®šå•ä¸€å¼‚å¸¸ç±»åç§°ï¼š@Transactional(noRollbackForClassName=â€RuntimeExceptionâ€)æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»åç§°ï¼š@Transactional(noRollbackForClassName={â€œRuntimeExceptionâ€,â€Exceptionâ€}) propagation è¯¥å±žæ€§ç”¨äºŽè®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºã€‚ä¾‹å¦‚ï¼š@Transactional(propagation=Propagation.NOT_SUPPORTED,readOnly=true) isolation è¯¥å±žæ€§ç”¨äºŽè®¾ç½®åº•å±‚æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œäº‹åŠ¡éš”ç¦»çº§åˆ«ç”¨äºŽå¤„ç†å¤šäº‹åŠ¡å¹¶å‘çš„æƒ…å†µï¼Œé€šå¸¸ä½¿ç”¨æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«å³å¯ï¼ŒåŸºæœ¬ä¸éœ€è¦è¿›è¡Œè®¾ç½® timeout è¯¥å±žæ€§ç”¨äºŽè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶ç§’æ•°ï¼Œé»˜è®¤å€¼ä¸º-1è¡¨ç¤ºæ°¸ä¸è¶…æ—¶ éš”ç¦»çº§åˆ«å’Œäº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶éš”ç¦»çº§åˆ« Isolation isolation() default Isolation.DEFAULTï¼šé»˜è®¤é‡‡ç”¨æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚å…¶ä¸­ï¼ŒIsolation æ˜¯ä¸ªæžšä¸¾å€¼ï¼š READ_UNCOMMITTEDï¼šè¯»å–æœªæäº¤æ•°æ®(ä¼šå‡ºçŽ°è„è¯», ä¸å¯é‡å¤è¯») åŸºæœ¬ä¸ä½¿ç”¨ READ_COMMITTEDï¼šè¯»å–å·²æäº¤æ•°æ®(ä¼šå‡ºçŽ°ä¸å¯é‡å¤è¯»å’Œå¹»è¯») REPEATABLE_READï¼šå¯é‡å¤è¯»(ä¼šå‡ºçŽ°å¹»è¯») SERIALIZABLEï¼šä¸²è¡ŒåŒ– MYSQLï¼šé»˜è®¤ä¸º REPEATABLE_READ çº§åˆ«SQLSERVERï¼šé»˜è®¤ä¸º READ_COMMITTED propagationï¼šä»£è¡¨çš„æ˜¯äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶ï¼Œè¿™ä¸ªæ˜¯ Spring äº‹åŠ¡çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæ˜¯ Spring æ¡†æž¶ç‹¬æœ‰çš„ï¼Œå®ƒå’Œ MySQL æ•°æ®åº“æ²¡æœ‰ä¸€ç‚¹å…³ç³»ã€‚æ‰€è°“äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºæ˜¯æŒ‡åœ¨åŒä¸€çº¿ç¨‹ä¸­ï¼Œåœ¨å¼€å§‹å½“å‰äº‹åŠ¡ä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹å½“å‰çº¿ç¨‹ä¸­æ˜¯å¦æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡å­˜åœ¨ï¼Œå¦‚æžœå­˜åœ¨ï¼Œæä¾›äº†ä¸ƒä¸ªé€‰é¡¹æ¥æŒ‡å®šå½“å‰äº‹åŠ¡çš„å‘ç”Ÿè¡Œä¸ºã€‚ org.springframework.transaction.annotation.Propagation è¿™ç±»æœ‰ 7 ä¸ªè¡¨ç¤ºä¼ æ’­è¡Œä¸ºçš„æžšä¸¾å€¼å¦‚ä¸‹ï¼š 123456789public enum Propagation &#123; REQUIRED(0), SUPPORTS(1), MANDATORY(2), REQUIRES_NEW(3), NOT_SUPPORTED(4), NEVER(5), NESTED(6)&#125; REQUIREDï¼šå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚è¿™ä¸ªå€¼æ˜¯é»˜è®¤çš„ã€‚ SUPPORTSï¼šå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éžäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚ MANDATORYï¼šå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ REQUIRES_NEWï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ NOT_SUPPORTEDï¼šä»¥éžäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ NEVERï¼šä»¥éžäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚ NESTEDï¼šå¦‚æžœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡æ¥è¿è¡Œï¼›å¦‚æžœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™è¯¥å–å€¼ç­‰ä»·äºŽ REQUIREDã€‚ è®¾ç½®æ–¹æ³•ï¼šé€šè¿‡ä½¿ç”¨ propagation å±žæ€§è®¾ç½®ï¼Œä¾‹å¦‚ï¼š 1@Transactional(propagation = Propagation.REQUIRES_NEW) @Transactional çš„å±€é™æ€§åˆ—ä¸¾ä¸€ä¸ªå½“å‰å¯¹è±¡è°ƒç”¨å¯¹è±¡è‡ªå·±é‡Œé¢çš„æ–¹æ³•ä¸èµ·ä½œç”¨çš„åœºæ™¯ã€‚ åœ¨ UserInfoServiceImpl çš„ save æ–¹æ³•ä¸­è°ƒç”¨äº†å¸¦äº‹åŠ¡çš„ calculate æ–¹æ³•ï¼Œè¯·çœ‹ä»£ç ï¼š 1234567891011121314151617181920212223@Componentpublic class UserInfoServiceImpl implements UserInfoService &#123; @Autowired private UserInfoRepository userInfoRepository; /** * æ ¹æ®UserIdäº§ç”Ÿçš„ä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘ */ @Override @Transactional(transactionManager = "db2TransactionManager") public UserInfo calculate(Long userId) &#123; UserInfo userInfo = userInfoRepository.findById(userId).get(); userInfo.setAges(userInfo.getAges()+1); //.....ç­‰ç­‰ä¸€äº›å¤æ‚äº‹åŠ¡å†…çš„æ“ä½œ userInfo.setTelephone(Instant.now().toString()); return userInfoRepository.saveAndFlush(userInfo); &#125; /** * æ­¤æ–¹æ³•è°ƒç”¨è‡ªèº«å¯¹è±¡çš„æ–¹æ³•ï¼Œå°±ä¼šå‘çŽ°calculateæ–¹æ³•ä¸Šé¢çš„äº‹åŠ¡æ˜¯å¤±æ•ˆçš„ */ public UserInfo save(Long userId) &#123; return this.calculate(userId); &#125;&#125; å½“åœ¨ UserInfoServiceImpl ç±»çš„å¤–éƒ¨è°ƒç”¨ save æ–¹æ³•çš„æ—¶å€™ï¼Œæ­¤æ—¶ save æ–¹æ³•é‡Œé¢è°ƒç”¨äº†è‡ªèº«çš„ calculate æ–¹æ³•ï¼Œå°±ä¼šå‘çŽ° calculate æ–¹æ³•ä¸Šé¢çš„äº‹åŠ¡æ˜¯æ²¡æœ‰æ•ˆæžœçš„ï¼Œè¿™ä¸ªæ˜¯ Spring çš„ä»£ç†æœºåˆ¶çš„é—®é¢˜ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¯ä»¥å¼•å…¥ä¸€ä¸ªç±» TransactionTemplateï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ç”¨æ³•ã€‚ TransactionTemplate çš„ç”¨æ³•æ­¤ç±»æ˜¯é€šè¿‡ TransactionAutoConfiguration åŠ è½½é…ç½®è¿›åŽ»çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é€šè¿‡æºç å¯ä»¥çœ‹åˆ°æ­¤ç±»æä¾›äº†ä¸€ä¸ªå…³é”® execute æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™é‡Œé¢ä¼šå¸®æˆ‘ä»¬å¤„ç†äº‹åŠ¡å¼€å§‹ã€rollbackã€commit çš„é€»è¾‘ï¼Œæ‰€ä»¥ç”¨çš„æ—¶å€™å°±éžå¸¸ç®€å•ï¼ŒæŠŠä¸Šé¢çš„æ–¹æ³•åšå¦‚ä¸‹æ”¹åŠ¨ï¼š 123public UserInfo save(Long userId) &#123; return transactionTemplate.execute(status -&gt; this.calculate(userId));&#125; æ­¤æ—¶å¤–éƒ¨å†è°ƒç”¨ save æ–¹æ³•çš„æ—¶å€™ï¼Œcalculate å°±ä¼šè¿›å…¥äº‹åŠ¡ç®¡ç†é‡Œé¢åŽ»äº†ã€‚ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢ä»£ç ä¸­çš„æ–¹æ³•è®¾ç½®äº‹åŠ¡çš„å±žæ€§ã€‚ 123456789transactionTemplate = new TransactionTemplate(transactionManager);//è®¾ç½®éš”ç¦»çº§åˆ«transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_REPEATABLE_READ);//è®¾ç½®ä¼ æ’­æœºåˆ¶transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRES_NEW);//è®¾ç½®è¶…æ—¶æ—¶é—´transactionTemplate.setTimeout(1000);//è®¾ç½®æ˜¯å¦åªè¯»transactionTemplate.setReadOnly(true); å¯ä»¥æ ¹æ® transactionTemplate çš„å®žçŽ°åŽŸç†ï¼Œè‡ªå·±å®žçŽ°ä¸€ä¸ª TransactionHelper è‡ªå®šä¹‰ TransactionHelperç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ª TransactionHelper ç±»ï¼Œè¿›è¡Œäº‹åŠ¡ç®¡ç† 12345678910111213/** * åˆ©ç”¨springè¿›è¡Œç®¡ç† */@Componentpublic class TransactionHelper &#123; /** * åˆ©ç”¨spring çš„æœºåˆ¶å’Œjdk8çš„functionæœºåˆ¶å®žçŽ°äº‹åŠ¡ */ @Transactional(rollbackFor = Exception.class) //å¯ä»¥æ ¹æ®å®žé™…ä¸šåŠ¡æƒ…å†µï¼ŒæŒ‡å®šæ˜Žç¡®çš„å›žæ»šå¼‚å¸¸ public &lt;T, R&gt; R transactional(Function&lt;T, R&gt; function, T t) &#123; return function.apply(t); &#125;&#125; ç¬¬äºŒæ­¥ï¼šç›´æŽ¥åœ¨ service ä¸­å°±å¯ä»¥ä½¿ç”¨äº† 12345678@Autowiredprivate TransactionHelper transactionHelper;/** * è°ƒç”¨å¤–éƒ¨çš„transactionHelperç±»ï¼Œåˆ©ç”¨transactionHelperæ–¹æ³•ä¸Šé¢çš„@Transactionæ³¨è§£ä½¿äº‹åŠ¡ç”Ÿæ•ˆ */public UserInfo save(Long userId) &#123; return transactionHelper.transactional((uid)-&gt;this.calculate(uid), userId);&#125; éšå¼äº‹åŠ¡ / AspectJ äº‹åŠ¡é…ç½®åªéœ€è¦åœ¨é¡¹ç›®ä¸­æ–°å¢žä¸€ä¸ªç±» AspectjTransactionConfig å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627@Configuration@EnableTransactionManagementpublic class AspectjTransactionConfig &#123; public static final String transactionExecution = "execution (* com.example..service.*.*(..))";//æŒ‡å®šæ‹¦æˆªå™¨ä½œç”¨çš„åŒ…è·¯å¾„ @Autowired private PlatformTransactionManager transactionManager; @Bean public DefaultPointcutAdvisor defaultPointcutAdvisor() &#123; //æŒ‡å®šä¸€èˆ¬è¦æ‹¦æˆªå“ªäº›ç±» AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut(); pointcut.setExpression(transactionExecution); //é…ç½®advisor DefaultPointcutAdvisor advisor = new DefaultPointcutAdvisor(); advisor.setPointcut(pointcut); //æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼ï¼ŒæŒ‡å®šä¸Šé¢çš„åŒ…è·¯å¾„é‡Œé¢çš„æ–¹æ³•çš„äº‹åŠ¡ç­–ç•¥ Properties attributes = new Properties(); attributes.setProperty("get*", "PROPAGATION_REQUIRED,-Exception"); attributes.setProperty("add*", "PROPAGATION_REQUIRED,-Exception"); attributes.setProperty("save*", "PROPAGATION_REQUIRED,-Exception"); attributes.setProperty("update*", "PROPAGATION_REQUIRED,-Exception"); attributes.setProperty("delete*", "PROPAGATION_REQUIRED,-Exception"); //åˆ›å»ºInterceptor TransactionInterceptor txAdvice = new TransactionInterceptor(transactionManager, attributes); advisor.setAdvice(txAdvice); return advisor; &#125;&#125; è¿™ç§æ–¹å¼ï¼Œåªè¦ç¬¦åˆæˆ‘ä»¬ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾è§„åˆ™çš„ service æ–¹æ³•ï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ äº‹åŠ¡äº†ï¼›å¦‚æžœæˆ‘ä»¬åœ¨æ–¹æ³•ä¸Šæ·»åŠ  @Transactionalï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸Šé¢çš„é»˜è®¤è§„åˆ™ã€‚ ä¸è¿‡è¿™ç§æ–¹æ³•è¿‘ä¸¤å¹´ä½¿ç”¨çš„å›¢é˜Ÿè¶Šæ¥è¶Šå°‘äº†ï¼Œå› ä¸ºæ³¨è§£çš„æ–¹å¼å…¶å®žå¾ˆæ–¹ä¾¿ï¼Œå¹¶ä¸”æ³¨è§£ @Transactional çš„æ–¹å¼æ›´å®¹æ˜“è®©äººç†è§£ï¼Œä»£ç ä¹Ÿæ›´ç®€å•ã€‚ é€šè¿‡æ—¥å¿—åˆ†æžé…ç½®æ–¹æ³•çš„è¿‡ç¨‹ä¸€ä¸ªæ–¹æ³•ç»åŽ†çš„ SQL å’Œè¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚ ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨æ•°æ®è¿žæŽ¥ä¸­åŠ ä¸Š logger=Slf4JLogger&amp;profileSQL=trueï¼Œç”¨æ¥æ˜¾ç¤º MySQL æ‰§è¡Œçš„ SQL æ—¥å¿— 12##########datasource1 é‡‡ç”¨Mysqlæ•°æ®åº“spring.datasource1.url=jdbc:mysql://localhost:3306/test?logger=Slf4JLogger&amp;profileSQL=true ç¬¬äºŒæ­¥ï¼Œæ‰“å¼€ Spring çš„äº‹åŠ¡å¤„ç†æ—¥å¿—ï¼Œç”¨æ¥è§‚å¯Ÿäº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ 1234567# Log Transactions Detailslogging.level.org.springframework.orm.jpa=DEBUGlogging.level.org.springframework.transaction=TRACElogging.level.org.hibernate.engine.transaction.internal.TransactionImpl=DEBUG# ç›‘æŽ§è¿žæŽ¥çš„æƒ…å†µlogging.level.org.hibernate.resource.jdbc=tracelogging.level.com.zaxxer.hikari=DEBUG ç¬¬ä¸‰æ­¥ï¼Œæ‰§è¡Œä¸€ä¸ª saveOrUpdate çš„æ“ä½œï¼Œè¯·çœ‹è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ã€‚ é€šè¿‡æ—¥å¿—å¯ä»¥å‘çŽ°ï¼Œæ‰§è¡Œä¸€ä¸ª saveUserInfo çš„åŠ¨ä½œï¼Œç”±äºŽåœ¨å…¶ä¸­é…ç½®äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ° JpaTransactionManager èŽ·å¾—äº‹åŠ¡çš„è¿‡ç¨‹ï¼Œå›¾ä¸Šé»„è‰²çš„éƒ¨åˆ†æ˜¯åŒä¸€ä¸ªè¿žæŽ¥é‡Œé¢æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œå…¶æ‰§è¡Œçš„æ•´ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š get connectionï¼šä»Žäº‹åŠ¡ç®¡ç†é‡Œé¢ï¼ŒèŽ·å¾—è¿žæŽ¥å°± begin å¼€å§‹äº‹åŠ¡äº†ã€‚æ²¡æœ‰çœ‹åˆ°æ˜¾ç¤ºçš„ begin çš„ SQLï¼ŒåŸºæœ¬ä¸Šå¯ä»¥æ–­å®šå®ƒåˆ©ç”¨äº† MySQL çš„ connection åˆå§‹åŒ–äº‹åŠ¡çš„ç‰¹æ€§ã€‚ set autocommit=0ï¼šå…³é—­è‡ªåŠ¨æäº¤æ¨¡å¼ï¼Œè¿™ä¸ªæ—¶å€™å¿…é¡»è¦åœ¨ç¨‹åºé‡Œé¢ commit æˆ–è€… rollbackã€‚ select user_infoï¼šçœ‹çœ‹ user_info æ•°æ®åº“é‡Œé¢æ˜¯å¦å­˜åœ¨æˆ‘ä»¬è¦ä¿å­˜çš„æ•°æ®ã€‚ update user_infoï¼šå‘çŽ°æ•°æ®åº“é‡Œé¢å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œã€‚ commitï¼šæ‰§è¡Œæäº¤äº‹åŠ¡ã€‚ set autocommit=1ï¼šäº‹åŠ¡æ‰§è¡Œå®Œï¼Œæ”¹å›ž autocommit çš„é»˜è®¤å€¼ï¼Œæ¯æ¡ SQL æ˜¯ç‹¬ç«‹çš„äº‹åŠ¡ã€‚ è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼Œå¦‚æžœé€šè¿‡ä¸‹é¢è¿™è¡Œä»£ç ï¼Œæ”¹å˜é»˜è®¤éš”ç¦»çº§åˆ«çš„è¯ï¼Œå†è§‚å¯Ÿæ—¥å¿—ã€‚ 1@Transactional(isolation = Isolation.READ_COMMITTED) è€Œåœ¨äº‹åŠ¡ç»“æŸä¹‹åŽï¼Œå®ƒè¿˜ä¼šè¿˜åŽŸæ­¤é“¾æŽ¥çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œåˆå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ Spring äº‹åŠ¡çš„å®žçŽ°åŽŸç†@Transactional çš„å·¥ä½œæœºåˆ¶ä¸»è¦æ˜¯åˆ©ç”¨çš„ Spring çš„ AOP åŽŸç†ï¼Œåœ¨åŠ è½½æ‰€æœ‰ç±»çš„æ—¶å€™ï¼Œå®¹å™¨å°±ä¼šçŸ¥é“æŸäº›ç±»éœ€è¦å¯¹åº”åœ°è¿›è¡Œå“ªäº› Interceptor çš„å¤„ç†ã€‚ Spring äº‹åŠ¡æºç åˆ†æžäº‹åŠ¡èŽ·å¾—è¿žæŽ¥çš„å…³é”®æ—¶æœºåœ¨ TransactionManagementConfigurationSelector é‡Œé¢è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ å°±ä¼šçŸ¥é“ä»£ç†çš„åŠ è½½ç±» ProxyTransactionManagementConfiguration å¯¹äº‹åŠ¡çš„å¤„ç†æœºåˆ¶ã€‚å…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ‰“å¼€ ProxyTransactionManagementConfiguration çš„è¯ï¼Œå°±ä¼šåŠ è½½ TransactionInterceptor çš„å¤„ç†ç±»ï¼Œå…³é”®æºç å¦‚ä¸‹å›¾ï¼š å¦‚æžœç»§ç»­åŠ è½½çš„è¯ï¼Œé‡Œé¢å°±ä¼šåŠ è½½å¸¦æœ‰ @Transactional æ³¨è§£çš„ç±»æˆ–è€…æ–¹æ³•ã€‚å…³é”®æºç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åŠ è½½æœŸé—´ï¼Œé€šè¿‡ @Transactional æ³¨è§£æ¥ç¡®å®šå“ªäº›æ–¹æ³•éœ€è¦è¿›è¡Œäº‹åŠ¡å¤„ç†ã€‚ 1o.s.orm.jpa.JpaTransactionManager : Creating new transaction with name è€Œè¿è¡ŒæœŸé—´é€šè¿‡ä¸Šé¢è¿™æ¡æ—¥å¿—ï¼Œå°±å¯ä»¥æ‰¾åˆ° JpaTransactionManager é‡Œé¢é€šè¿‡ getTransaction æ–¹æ³•åˆ›å»ºçš„äº‹åŠ¡ï¼Œç„¶åŽå†é€šè¿‡ debug æ¨¡å¼çš„ IDEA çº¿ç¨‹æ ˆè¿›è¡Œåˆ†æžï¼Œå°±èƒ½çŸ¥é“åˆ›å»ºäº‹åŠ¡çš„æ•´ä¸ªè¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚ä¸Šå›¾ï¼Œ createTransactionIfNecessary æ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ›å»ºäº‹åŠ¡çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç»§ç»­å¾€ä¸‹é¢ debug çš„è¯ï¼Œå°±ä¼šæ‰¾åˆ°åˆ›å»ºäº‹åŠ¡çš„å…³é”®ä»£ç ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ AbstractPlatformTransactionManager é‡Œé¢çš„ startTransaction æ–¹æ³•å¼€å¯äº‹åŠ¡ã€‚è¯·çœ‹ä¸‹å›¾ï¼š ç„¶åŽç»§ç»­å¾€ä¸‹æ–­ç‚¹è¿›è¡Œåˆ†æžï¼Œå½“æ–­ç‚¹èµ°åˆ°æœ€åŽçš„æ—¶å€™å°±æ˜¯å¼€å¯äº‹åŠ¡çš„æ—¶å€™ï¼Œå¿…é¡»è¦ä»Žæ•°æ®æºé‡Œé¢èŽ·å¾—è¿žæŽ¥ã€‚ çœ‹ä¸€ä¸‹æ–­ç‚¹çš„æ ˆä¿¡æ¯ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªå…³é”®çš„ debug ç‚¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å…¶ä¸­ï¼Œ ç¬¬ä¸€å¤„ï¼šæ˜¯å¤„ç†å¸¦ @Transactional çš„æ³¨è§£çš„æ–¹æ³•ï¼Œåˆ©ç”¨ CGLIB è¿›è¡Œäº‹åŠ¡æ‹¦æˆªå¤„ç†ï¼› ç¬¬äºŒå¤„ï¼šæ˜¯æ ¹æ® Spring çš„äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼Œæ¥åˆ¤æ–­æ˜¯ç”¨çŽ°æœ‰çš„äº‹åŠ¡ï¼Œè¿˜æ˜¯åˆ›å»ºæ–°çš„äº‹åŠ¡ï¼› ç¬¬ä¸ƒå¤„ï¼šæ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦çŽ°æœ‰è¿žæŽ¥ï¼Œå¦‚æžœæœ‰ç›´æŽ¥ç”¨ï¼Œå¦‚æžœæ²¡æœ‰å°±ä»Žç¬¬å…«å¤„çš„æ•°æ®æºé‡Œé¢çš„è¿žæŽ¥æ± ä¸­èŽ·å–è¿žæŽ¥ï¼Œç¬¬ä¸ƒå¤„çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š ä»€ä¹ˆæ—¶é—´é‡Šæ”¾è¿žæŽ¥åˆ°è¿žæŽ¥æ± åœ¨ LogicalConnectionManagedImpl çš„ releaseConnection æ–¹æ³•ä¸­è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åŽï¼Œå®ƒä¼šå°†è¿žæŽ¥é‡Šæ”¾åˆ°è¿žæŽ¥æ± é‡Œé¢ã€‚ é€šè¿‡ä¸Šé¢çš„ saveOrUpdate çš„è¯¦ç»†æ‰§è¡Œæ—¥å¿—ï¼Œå¯ä»¥è§‚å¯Ÿå‡ºæ¥ï¼š äº‹åŠ¡æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºå¼€å¯çš„ æ•°æ®åº“è¿žæŽ¥æ˜¯ä»€ä¹ˆæ—¶æœºå¼€å¯çš„ äº‹åŠ¡æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºå…³é—­çš„ æ•°æ®åº“è¿žæŽ¥æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºé‡Šæ”¾çš„ Spring ä¸­çš„äº‹åŠ¡å’Œè¿žæŽ¥çš„å…³ç³»æ˜¯ï¼Œå¼€å¯äº‹åŠ¡çš„åŒæ—¶èŽ·å– DB è¿žæŽ¥ï¼›äº‹åŠ¡å®Œæˆçš„æ—¶å€™é‡Šæ”¾ DB è¿žæŽ¥ã€‚ äº‹åŠ¡å’Œè¿žæŽ¥æ± åœ¨ JPA ä¸­çš„æ³¨æ„äº‹é¡¹æ•°æ®æºçš„è¿žæŽ¥æ± ä¸èƒ½é…ç½®è¿‡å¤§ï¼Œå¦åˆ™è¿žæŽ¥ä¹‹é—´åˆ‡æ¢å°±ä¼šéžå¸¸è€—è´¹åº”ç”¨å†…éƒ¨çš„ CPU å’Œå†…å­˜ï¼Œä»Žè€Œé™ä½Žåº”ç”¨å¯¹å¤–æä¾› API çš„åžåé‡ã€‚ æ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨äº‹åŠ¡çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„å¦‚ä¸‹å‡ ä¸ªäº‹é¡¹ï¼š äº‹åŠ¡å†…çš„é€»è¾‘ä¸èƒ½æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´å ç”¨ db è¿žæŽ¥çš„æ—¶é—´è¿‡é•¿ï¼Œä¼šé€ æˆæ•°æ®åº“è¿žæŽ¥ä¸å¤Ÿç”¨çš„æƒ…å†µï¼› è·¨åº”ç”¨çš„æ“ä½œï¼Œå¦‚ API è°ƒç”¨ç­‰ï¼Œå°½é‡ä¸è¦åœ¨æœ‰äº‹åŠ¡çš„æ–¹æ³•é‡Œé¢è¿›è¡Œï¼› å¦‚æžœåœ¨çœŸå®žä¸šåŠ¡åœºæ™¯ä¸­æœ‰è€—æ—¶çš„æ“ä½œï¼Œä¹Ÿéœ€è¦å¸¦äº‹åŠ¡æ—¶ï¼ˆå¦‚æ‰£æ¬¾çŽ¯èŠ‚ï¼‰ï¼Œé‚£ä¹ˆè¯·æ³¨æ„å¢žåŠ æ•°æ®æºé…ç½®çš„è¿žæŽ¥æ± æ•°ï¼› é€šè¿‡ MVC çš„åº”ç”¨è¯·æ±‚è¿žæŽ¥æ± æ•°é‡ï¼Œä¹Ÿè¦æ ¹æ®è¿žæŽ¥æ± çš„æ•°é‡å’Œäº‹åŠ¡çš„è€—æ—¶æƒ…å†µçµæ´»é…ç½®ï¼›è€Œ tomcat é»˜è®¤çš„è¯·æ±‚è¿žæŽ¥æ± æ•°é‡æ˜¯ 200 ä¸ªï¼Œå¯ä»¥æ ¹æ®å®žé™…æƒ…å†µæ¥å¢žåŠ æˆ–è€…å‡å°‘è¯·æ±‚çš„è¿žæŽ¥æ± æ•°é‡ï¼Œä»Žè€Œå‡å°‘å¹¶å‘å¤„ç†å¯¹äº‹åŠ¡çš„ä¾èµ–ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa å¤„ç†ç”Ÿäº§çŽ¯å¢ƒå¤šæ•°æ®æºçš„é—®é¢˜]]></title>
    <url>%2F2020%2F11%2F17%2FSpringDataJpa%E5%A4%84%E7%90%86%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[ç”Ÿäº§çŽ¯å¢ƒå¤šæ•°æ®æºçš„å¤„ç†æ–¹æ³•æœ‰å“ªäº›ï¼Ÿå·¥ä½œä¸­æˆ‘ä»¬æ—¶å¸¸ä¼šé‡åˆ°è·¨æ•°æ®åº“æ“ä½œçš„æƒ…å†µï¼Œè¿™æ—¶å€™å°±éœ€è¦é…ç½®å¤šæ•°æ®æºï¼š å¦‚ä½•é…ç½®ï¼Ÿ å¸¸ç”¨çš„æ–¹å¼åŠå…¶èƒŒåŽçš„åŽŸç†ï¼Ÿ å¸¸ç”¨çš„é…ç½®æ–¹å¼ é€šè¿‡å¤šä¸ª @Configuration æ–‡ä»¶ åˆ©ç”¨ AbstractRoutingDataSource é…ç½®å¤šæ•°æ®æº ç¬¬ä¸€ç§æ–¹å¼ï¼šå¤šä¸ªæ•°æ®æºçš„ @Configuration çš„é…ç½®æ–¹æ³• ðŸŽ¯ä¸»è¦æ€è·¯ï¼šä¸åŒ Package ä¸‹é¢çš„å®žä½“å’Œ Repository é‡‡ç”¨ä¸åŒçš„ Data Source æ‰€ä»¥æ”¹é€ ä¸€ä¸‹ example ç›®å½•ç»“æž„ï¼Œæ¥çœ‹çœ‹ä¸åŒ Repositories çš„æ•°æ®æºæ˜¯æ€Žä¹ˆå¤„ç†çš„ã€‚ ç¬¬ä¸€æ­¥ï¼šè§„åˆ’ Entity å’Œ Repository çš„ç›®å½•ç»“æž„ï¼Œä¸ºäº†æ–¹ä¾¿é…ç½®å¤šæ•°æ®æºã€‚ å°† User å’Œ UserAddressã€UserRepository å’Œ UserAddressRepository ç§»åŠ¨åˆ° db1 é‡Œé¢ï¼› å°† UserInfo å’Œ UserInfoRepository ç§»åŠ¨åˆ° db2 é‡Œé¢ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æŠŠå®žä½“å’Œ Repository åˆ†åˆ«æ”¾åˆ°äº† db1 å’Œ db2 ä¸¤ä¸ªç›®å½•é‡Œé¢ï¼Œå‡è®¾æ•°æ®æº 1 æ˜¯ MySQLï¼ŒUser è¡¨å’Œ UserAddress è¡¨åœ¨æ•°æ®æº 1 é‡Œé¢ï¼Œé‚£ä¹ˆéœ€è¦é…ç½®ä¸€ä¸ªæ•°æ®æº 1 çš„ Configuration ç±»ï¼Œå¹¶ä¸”åœ¨é‡Œé¢é…ç½® DataSourceã€TransactionManager å’Œ EntityManagerã€‚ ç¬¬äºŒæ­¥ï¼šé…ç½® DataSource1Config ç±»ã€‚ ç›®å½•ç»“æž„è°ƒæ•´å®Œä¹‹åŽï¼ŒæŽ¥ä¸‹æ¥å¼€å§‹é…ç½®æ•°æ®æºï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Configuration@EnableTransactionManagement//å¼€å¯äº‹åŠ¡//åˆ©ç”¨EnableJpaRepositoriesé…ç½®å“ªäº›åŒ…ä¸‹é¢çš„Repositoriesï¼Œé‡‡ç”¨å“ªä¸ªEntityManagerFactoryå’Œå“ªä¸ªtransactionManager@EnableJpaRepositories( basePackages = &#123;"com.example.jpa.example1.db1"&#125;,//æ•°æ®æº1çš„repositoryçš„åŒ…è·¯å¾„ entityManagerFactoryRef = "db1EntityManagerFactory",//æ”¹å˜æ•°æ®æº1çš„EntityManagerFactoryçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb1EntityManagerFactory transactionManagerRef = "db1TransactionManager"//æ”¹å˜æ•°æ®æº1çš„transactionManagerçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb1TransactionManager )public class DataSource1Config &#123; /** * æŒ‡å®šæ•°æ®æº1çš„dataSourceé…ç½® * @return */ @Primary @Bean(name = "db1DataSourceProperties") @ConfigurationProperties("spring.datasource1") //æ•°æ®æº1çš„dbé…ç½®å‰ç¼€é‡‡ç”¨spring.datasource1 public DataSourceProperties dataSourceProperties() &#123; return new DataSourceProperties(); &#125; /** * å¯ä»¥é€‰æ‹©ä¸åŒçš„æ•°æ®æºï¼Œè¿™é‡Œç”¨HikariDataSourceä¸¾ä¾‹ï¼Œåˆ›å»ºæ•°æ®æº1 * @param db1DataSourceProperties * @return */ @Primary @Bean(name = "db1DataSource") @ConfigurationProperties(prefix = "spring.datasource.hikari.db1") //é…ç½®æ•°æ®æº1æ‰€ç”¨çš„hikarié…ç½®keyçš„å‰ç¼€ public HikariDataSource dataSource(@Qualifier("db1DataSourceProperties") DataSourceProperties db1DataSourceProperties) &#123; HikariDataSource dataSource = db1DataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build(); if (StringUtils.hasText(db1DataSourceProperties.getName())) &#123; dataSource.setPoolName(db1DataSourceProperties.getName()); &#125; return dataSource; &#125; /** * é…ç½®æ•°æ®æº1çš„entityManagerFactoryå‘½åä¸ºdb1EntityManagerFactoryï¼Œç”¨æ¥å¯¹å®žä½“è¿›è¡Œä¸€äº›æ“ä½œ * @param builder * @param db1DataSource entityManagerä¾èµ–db1DataSource * @return */ @Primary @Bean(name = "db1EntityManagerFactory") public LocalContainerEntityManagerFactoryBean entityManagerFactory(EntityManagerFactoryBuilder builder, @Qualifier("db1DataSource") DataSource db1DataSource) &#123; return builder.dataSource(db1DataSource) .packages("com.example.jpa.example1.db1") //æ•°æ®1çš„å®žä½“æ‰€åœ¨çš„è·¯å¾„ .persistenceUnit("db1")// persistenceUnitçš„åå­—é‡‡ç”¨db1 .build(); &#125; /** * é…ç½®æ•°æ®æº1çš„äº‹åŠ¡ç®¡ç†è€…ï¼Œå‘½åä¸ºdb1TransactionManagerä¾èµ–db1EntityManagerFactory * @param db1EntityManagerFactory * @return */ @Primary @Bean(name = "db1TransactionManager") public PlatformTransactionManager transactionManager(@Qualifier("db1EntityManagerFactory") EntityManagerFactory db1EntityManagerFactory) &#123; return new JpaTransactionManager(db1EntityManagerFactory); &#125;&#125; åˆ°è¿™é‡Œï¼Œæ•°æ®æº 1 å°±é…ç½®å®Œäº†ï¼Œä¸‹é¢å†é…ç½®æ•°æ®æº 2ã€‚ ç¬¬ä¸‰æ­¥ï¼šé…ç½® DataSource2Config ç±»ï¼ŒåŠ è½½æ•°æ®æº 2ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Configuration@EnableTransactionManagement//å¼€å¯äº‹åŠ¡//åˆ©ç”¨EnableJpaRepositoriesï¼Œé…ç½®å“ªäº›åŒ…ä¸‹é¢çš„Repositoriesï¼Œé‡‡ç”¨å“ªä¸ªEntityManagerFactoryå’Œå“ªä¸ªtransactionManager@EnableJpaRepositories( basePackages = &#123;"com.example.jpa.example1.db2"&#125;,//æ•°æ®æº2çš„repositoryçš„åŒ…è·¯å¾„ entityManagerFactoryRef = "db2EntityManagerFactory",//æ”¹å˜æ•°æ®æº2çš„EntityManagerFactoryçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb2EntityManagerFactory transactionManagerRef = "db2TransactionManager"//æ”¹å˜æ•°æ®æº2çš„transactionManagerçš„é»˜è®¤å€¼ï¼Œæ”¹ä¸ºdb2TransactionManager)public class DataSource2Config &#123; /** * æŒ‡å®šæ•°æ®æº2çš„dataSourceé…ç½® * * @return */ @Bean(name = "db2DataSourceProperties") @ConfigurationProperties("spring.datasource2") //æ•°æ®æº2çš„dbé…ç½®å‰ç¼€é‡‡ç”¨spring.datasource2 public DataSourceProperties dataSourceProperties() &#123; return new DataSourceProperties(); &#125; /** * å¯ä»¥é€‰æ‹©ä¸åŒçš„æ•°æ®æºï¼Œè¿™é‡Œæˆ‘ç”¨HikariDataSourceä¸¾ä¾‹ï¼Œåˆ›å»ºæ•°æ®æº2 * * @param db2DataSourceProperties * @return */ @Bean(name = "db2DataSource") @ConfigurationProperties(prefix = "spring.datasource.hikari.db2") //é…ç½®æ•°æ®æº2çš„hikarié…ç½®keyçš„å‰ç¼€ public HikariDataSource dataSource(@Qualifier("db2DataSourceProperties") DataSourceProperties db2DataSourceProperties) &#123; HikariDataSource dataSource = db2DataSourceProperties.initializeDataSourceBuilder().type(HikariDataSource.class).build(); if (StringUtils.hasText(db2DataSourceProperties.getName())) &#123; dataSource.setPoolName(db2DataSourceProperties.getName()); &#125; return dataSource; &#125; /** * é…ç½®æ•°æ®æº2çš„entityManagerFactoryå‘½åä¸ºdb2EntityManagerFactoryï¼Œç”¨æ¥å¯¹å®žä½“è¿›è¡Œä¸€äº›æ“ä½œ * * @param builder * @param db2DataSource entityManagerä¾èµ–db2DataSource * @return */ @Bean(name = "db2EntityManagerFactory") public LocalContainerEntityManagerFactoryBean entityManagerFactory(EntityManagerFactoryBuilder builder, @Qualifier("db2DataSource") DataSource db2DataSource) &#123; return builder.dataSource(db2DataSource) .packages("com.example.jpa.example1.db2") //æ•°æ®2çš„å®žä½“æ‰€åœ¨çš„è·¯å¾„ .persistenceUnit("db2")// persistenceUnitçš„åå­—é‡‡ç”¨db2 .build(); &#125; /** * é…ç½®æ•°æ®æº2çš„äº‹åŠ¡ç®¡ç†è€…ï¼Œå‘½åä¸ºdb2TransactionManagerä¾èµ–db2EntityManagerFactory * * @param db2EntityManagerFactory * @return */ @Bean(name = "db2TransactionManager") public PlatformTransactionManager transactionManager(@Qualifier("db2EntityManagerFactory") EntityManagerFactory db2EntityManagerFactory) &#123; return new JpaTransactionManager(db2EntityManagerFactory); &#125;&#125; ðŸ¤£æ³¨æ„ï¼šDataSource1Config å’Œ DataSource2Config ä¸åŒçš„æ˜¯ï¼Œ1 é‡Œé¢æ¯ä¸ª @Bean éƒ½ @Primaryï¼Œè€Œ 2 é‡Œé¢ä¸æ˜¯çš„ã€‚ ç¬¬å››æ­¥ï¼šé€šè¿‡ application.properties é…ç½®ä¸¤ä¸ªæ•°æ®æºçš„å€¼ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819###########datasource1 é‡‡ç”¨Mysqlæ•°æ®åº“spring.datasource1.url=jdbc:mysql://localhost:3306/test2?logger=Slf4JLogger&amp;profileSQL=truespring.datasource1.username=rootspring.datasource1.password=root##æ•°æ®æº1çš„è¿žæŽ¥æ± çš„åå­—spring.datasource.hikari.db1.pool-name=jpa-hikari-pool-db1##æœ€é•¿ç”Ÿå‘½å‘¨æœŸ15åˆ†é’Ÿå¤Ÿäº†spring.datasource.hikari.db1.maxLifetime=900000spring.datasource.hikari.db1.maximumPoolSize=8###########datasource2 é‡‡ç”¨h2å†…å­˜æ•°æ®åº“spring.datasource2.url=jdbc:h2:~/testspring.datasource2.username=saspring.datasource2.password=sa##æ•°æ®æº2çš„è¿žæŽ¥æ± çš„åå­—spring.datasource.hikari.db2.pool-name=jpa-hikari-pool-db2##æœ€é•¿ç”Ÿå‘½å‘¨æœŸå’Œæ•°æ®æº1åŒºåˆ†å¼€ï¼Œè®¾ç½®æˆ500ç§’spring.datasource.hikari.db2.maxLifetime=500000##æœ€å¤§è¿žæŽ¥æ± å¤§å°å’Œæ•°æ®æº1åŒºåˆ†å¼€ï¼Œé…ç½®æˆ6ä¸ªspring.datasource.hikari.db2.maximumPoolSize=6 ç¬¬äº”æ­¥ï¼šå†™ä¸ª Controller æµ‹è¯•ä¸€ä¸‹ã€‚ 123456789101112131415@RestControllerpublic class UserController &#123; @Autowired private UserRepository userRepository; @Autowired private UserInfoRepository userInfoRepository; //æ“ä½œuserçš„Repository @PostMapping("/user") public User saveUser(@RequestBody User user) &#123; return userRepository.save(user); &#125; //æ“ä½œuserInfoçš„Repository @PostMapping("/user/info") public UserInfo saveUserInfo(@RequestBody UserInfo userInfo) &#123; return userInfoRepository.save(userInfo); &#125;&#125; ç¬¬å…­æ­¥ï¼šç›´æŽ¥å¯åŠ¨æˆ‘ä»¬çš„é¡¹ç›®ï¼Œæµ‹è¯•ä¸€ä¸‹ã€‚ è¯·çœ‹è¿™ä¸€æ­¥çš„å¯åŠ¨æ—¥å¿—ï¼š å¯ä»¥çœ‹åˆ°å¯åŠ¨çš„æ˜¯ä¸¤ä¸ªæ•°æ®æºï¼Œå…¶å¯¹åº”çš„è¿žæŽ¥æ± çš„ç›‘æŽ§æ˜¯ä¸ä¸€æ ·çš„ï¼šæ•°æ®æº 1 æœ‰ 8 ä¸ªï¼Œæ•°æ®æº 2 æœ‰ 6 ä¸ªã€‚ å¦‚æžœåˆ†åˆ«è¯·æ±‚ Controller å†™çš„ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿä¼šåˆ†åˆ«æ’å…¥åˆ°ä¸åŒçš„æ•°æ®æºé‡Œé¢åŽ»ã€‚ Datasource ä¸Ž TransactionManagerã€EntityManagerFactory çš„å…³ç³»åˆ†æžé€šè¿‡ä¸€ä¸ªç±»çš„å…³ç³»å›¾æ¥åˆ†æžä¸€ä¸‹ï¼š å…¶ä¸­ï¼Œ HikariDataSource è´Ÿè´£å®žçŽ° DataSourceï¼Œäº¤ç»™ EntityManager å’Œ TransactionManager ä½¿ç”¨ï¼› EntityManager æ˜¯åˆ©ç”¨ DataSource æ¥æ“ä½œæ•°æ®åº“ï¼Œè€Œå…¶å®žçŽ°ç±»æ˜¯ SessionImplï¼› EntityManagerFactory æ˜¯ç”¨æ¥ç®¡ç†å’Œç”Ÿæˆ EntityManager çš„ï¼Œè€Œ EntityManagerFactory çš„å®žçŽ°ç±»æ˜¯ LocalContainerEntityManagerFactoryBeanï¼Œé€šè¿‡å®žçŽ° FactoryBean æŽ¥å£å®žçŽ°ï¼Œåˆ©ç”¨äº† FactoryBean åœ¨ Spring ä¸­çš„ bean ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Datasource1Config é‡Œé¢é…ç½® LocalContainerEntityManagerFactoryBean çš„ bean çš„æ³¨å…¥æ–¹å¼ï¼› JpaTransactionManager æ˜¯ç”¨æ¥ç®¡ç†äº‹åŠ¡çš„ï¼Œå®žçŽ°äº† TransactionManager å¹¶ä¸”é€šè¿‡ EntityManagerFactory å’Œ Datasource è¿›è¡Œ db æ“ä½œï¼Œæ‰€ä»¥è¦åœ¨ DataSourceConfig é‡Œé¢å‘Šè¯‰ JpaTransactionManager ç”¨çš„ TransactionManager æ˜¯ db1EntityManagerFactoryã€‚ ðŸ“å…³ç³»å›¾ï¼š DataSourceConfig -&gt; TransactionManager -&gt; EntityManagerFactory -&gt; EntityManager -&gt; DataSource â€‹ â†“ â†“ â†“ â€‹ JpaTransactionManager -&gt; LocalContainerEntityManagerFactoryBean -&gt; .. -&gt; HikariDataSource é»˜è®¤æƒ…å†µä¸‹ Datasource çš„ EntityManagerFactory å’Œ TransactionManager æ˜¯æ€Žä¹ˆåŠ è½½å’Œé…ç½®çš„å‘¢ï¼Ÿ é»˜è®¤çš„ JpaBaseConfiguration çš„åŠ è½½æ–¹å¼åˆ†æžå¯ä»¥é€šè¿‡ HibernateJpaConfigurationï¼Œæ‰¾åˆ°çˆ¶ç±» JpaBaseConfiguration ç±»ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š æŽ¥ç€æ‰“å¼€ JpaBaseConfiguration å°±å¯ä»¥çœ‹åˆ°å¤šæ•°æ®æºçš„å‚è€ƒåŽŸåž‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å•ä¸ªæ•°æ®æºæƒ…å†µä¸‹çš„ EntityManagerFactory å’Œ TransactionManager çš„åŠ è½½æ–¹æ³•ï¼Œ å¹¶ä¸”æˆ‘ä»¬åœ¨å¤šæ•°æ®æºçš„é…ç½®é‡Œé¢è¿˜åŠ è½½äº†ä¸€ä¸ªç±»ï¼šEntityManagerFactoryBuilder ï¼Œæ­£æ˜¯ä»Žä¸Šé¢çš„æ–¹æ³•åŠ è½½è¿›åŽ»çš„ã€‚ ç¬¬äºŒç§æ–¹å¼ï¼šåˆ©ç”¨ AbstractRoutingDataSource é…ç½®å¤šæ•°æ®æºDataSource çš„æœ¬è´¨æ˜¯èŽ·å¾—æ•°æ®åº“è¿žæŽ¥ï¼Œè€Œ AbstractRoutingDataSource å¸®æˆ‘ä»¬å®žçŽ°äº†åŠ¨æ€èŽ·å¾—æ•°æ®æºçš„å¯èƒ½æ€§ã€‚ ç¬¬ä¸€æ­¥ï¼šå®šä¸€ä¸ªæ•°æ®æºçš„æžšä¸¾ç±»ï¼Œç”¨æ¥æ ‡ç¤ºæ•°æ®æºæœ‰å“ªäº›ã€‚ 123456789101112131415/** * å®šä¹‰ä¸€ä¸ªæ•°æ®æºçš„æžšä¸¾ç±» */public enum RoutingDataSourceEnum &#123; DB1, // å®žé™…å·¥ä½œä¸­æžšä¸¾çš„è¯­ä¹‰å¯ä»¥æ›´åŠ æ˜Žç¡®ä¸€ç‚¹ï¼› DB2; public static RoutingDataSourceEnum findByCode(String dbRouting) &#123; for (RoutingDataSourceEnum e : values()) &#123; if (e.name().equals(dbRouting)) &#123; return e; &#125; &#125; return db1;//æ²¡æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤è¿”å›žæ•°æ®æº1 &#125;&#125; ç¬¬äºŒæ­¥ï¼šæ–°å¢ž DataSourceRoutingHolderï¼Œç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹éœ€è¦é‡‡ç”¨çš„æ•°æ®æºã€‚ 123456789101112131415/** * åˆ©ç”¨ ThreadLocal æ¥å­˜å‚¨ï¼Œå½“å‰çš„çº¿ç¨‹ä½¿ç”¨çš„æ•°æ® */public class DataSourceRoutingHolder &#123; private static ThreadLocal&lt;RoutingDataSourceEnum&gt; threadLocal = new ThreadLocal&lt;&gt;(); public static void setBranchContext(RoutingDataSourceEnum dataSourceEnum) &#123; threadLocal.set(dataSourceEnum); &#125; public static RoutingDataSourceEnum getBranchContext() &#123; return threadLocal.get(); &#125; public static void clearBranchContext() &#123; threadLocal.remove(); &#125;&#125; ç¬¬ä¸‰æ­¥ï¼šé…ç½® RoutingDataSourceConfigï¼Œç”¨æ¥æŒ‡å®šå“ªäº› Entity å’Œ Repository é‡‡ç”¨åŠ¨æ€æ•°æ®æºã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859@Configuration@EnableTransactionManagement@EnableJpaRepositories( //æ•°æ®æºçš„ repository çš„åŒ…è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬è¦†ç›– db1 å’Œ db2 çš„åŒ…è·¯å¾„ basePackages = &#123;"com.example.jpa.example1"&#125;, entityManagerFactoryRef = "routingEntityManagerFactory", transactionManagerRef = "routingTransactionManager")public class RoutingDataSourceConfig &#123; @Autowired @Qualifier("db1DataSource") private DataSource db1DataSource; @Autowired @Qualifier("db2DataSource") private DataSource db2DataSource; /** * åˆ›å»ºRoutingDataSourceï¼Œå¼•ç”¨æˆ‘ä»¬ä¹‹å‰é…ç½®çš„db1DataSourceå’Œdb2DataSource * * @return */ @Bean(name = "routingDataSource") public DataSource dataSource() &#123; Map&lt;Object, Object&gt; dataSourceMap = Maps.newHashMapWithExpectedSize(2); dataSourceMap.put(RoutingDataSourceEnum.DB1, db1DataSource); dataSourceMap.put(RoutingDataSourceEnum.DB2, db2DataSource); RoutingDataSource routingDataSource = new RoutingDataSource(); //è®¾ç½®RoutingDataSourceçš„é»˜è®¤æ•°æ®æº routingDataSource.setDefaultTargetDataSource(db1DataSource); //è®¾ç½®RoutingDataSourceçš„æ•°æ®æºåˆ—è¡¨ routingDataSource.setTargetDataSources(dataSourceMap); return routingDataSource; &#125; /** * ç±»ä¼¼db1å’Œdb2çš„é…ç½®ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œé‡‡ç”¨routingDataSource * @param builder * @param routingDataSource entityManagerä¾èµ–routingDataSource * @return */ @Bean(name = "routingEntityManagerFactory") public LocalContainerEntityManagerFactoryBean entityManagerFactory(EntityManagerFactoryBuilder builder, @Qualifier("routingDataSource") DataSource routingDataSource) &#123; return builder.dataSource(routingDataSource) .packages("com.example.jpa.example1") //æ•°æ®routingçš„å®žä½“æ‰€åœ¨çš„è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬è¦†ç›–db1å’Œdb2çš„è·¯å¾„ .persistenceUnit("db-routing")// persistenceUnitçš„åå­—é‡‡ç”¨db-routing .build(); &#125; /** * é…ç½®æ•°æ®çš„äº‹åŠ¡ç®¡ç†è€…ï¼Œå‘½åä¸º routingTransactionManager ä¾èµ– routingEntityManagerFactory * * @param routingEntityManagerFactory * @return */ @Bean(name = "routingTransactionManager") public PlatformTransactionManager transactionManager(@Qualifier("routingEntityManagerFactory") EntityManagerFactory routingEntityManagerFactory) &#123; return new JpaTransactionManager(routingEntityManagerFactory); &#125;&#125; è·¯ç”±æ•°æ®æºé…ç½®ä¸Ž DataSource1Config å’Œ DataSource2Config æœ‰ç›¸äº’è¦†ç›–å…³ç³»ï¼Œè¿™é‡Œè¦†ç›– db1 å’Œ db2 çš„åŒ…è·¯å¾„ï¼Œä»¥ä¾¿äºŽåŠ¨æ€æ•°æ®æºç”Ÿæ•ˆã€‚ ç¬¬å››æ­¥ï¼šå†™ä¸€ä¸ª MVC æ‹¦æˆªå™¨ï¼Œç”¨æ¥æŒ‡å®šè¯·æ±‚åˆ†åˆ«é‡‡ç”¨ä»€ä¹ˆæ•°æ®æºã€‚ æ–°å»ºä¸€ä¸ªç±» DataSourceInterceptorï¼Œç”¨æ¥åœ¨è¯·æ±‚å‰åŽæŒ‡å®šæ•°æ®æºï¼Œè¯·çœ‹ä»£ç ï¼š 123456789101112131415161718192021222324/** * åŠ¨æ€è·¯ç”±çš„å®žçŽ°é€»è¾‘ï¼Œæˆ‘ä»¬é€šè¿‡è¯·æ±‚é‡Œé¢çš„db-routingï¼Œæ¥æŒ‡å®šæ­¤è¯·æ±‚é‡‡ç”¨ä»€ä¹ˆæ•°æ®æº */@Componentpublic class DataSourceInterceptor extends HandlerInterceptorAdapter &#123; /** * è¯·æ±‚å¤„ç†ä¹‹å‰æ›´æ”¹çº¿ç¨‹é‡Œé¢çš„æ•°æ®æº */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; String dbRouting = request.getHeader("db-routing"); DataSourceRoutingHolder.setBranchContext(RoutingDataSourceEnum.findByCode(dbRouting)); return super.preHandle(request, response, handler); &#125; /** * è¯·æ±‚ç»“æŸä¹‹åŽæ¸…ç†çº¿ç¨‹é‡Œé¢çš„æ•°æ®æº */ @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123; super.afterCompletion(request, response, handler, ex); DataSourceRoutingHolder.clearBranchContext(); &#125;&#125; åŒæ—¶éœ€è¦åœ¨å®žçŽ° WebMvcConfigurer çš„é…ç½®é‡Œé¢ï¼ŒæŠŠæˆ‘ä»¬è‡ªå®šä¹‰æ‹¦æˆªå™¨ dataSourceInterceptor åŠ è½½è¿›åŽ»ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415/** * å®žçŽ°WebMvcConfigurer */@Configurationpublic class MyWebMvcConfigurer implements WebMvcConfigurer &#123; @Autowired private DataSourceInterceptor dataSourceInterceptor; //æ·»åŠ è‡ªå®šä¹‰æ‹¦æˆªå™¨ @Override public void addInterceptors(InterceptorRegistry registry) &#123; registry.addInterceptor(dataSourceInterceptor).addPathPatterns("/**"); WebMvcConfigurer.super.addInterceptors(registry); &#125;......&#125; æ­¤å¤„é‡‡ç”¨çš„æ˜¯ MVC çš„æ‹¦æˆªå™¨æœºåˆ¶åŠ¨æ€æ”¹å˜çš„æ•°æ®é…ç½®ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå·±çš„ AOP ä»»æ„çš„æ‹¦æˆªå™¨ï¼Œå¦‚äº‹åŠ¡æ‹¦æˆªå™¨ã€Service çš„æ‹¦æˆªå™¨ç­‰ï¼Œéƒ½å¯ä»¥å®žçŽ°ã€‚ ðŸ“æ³¨æ„ï¼šè¦åœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰é…ç½®å®Œæ¯• ç¬¬äº”æ­¥ï¼šå¯åŠ¨æµ‹è¯•ã€‚ åœ¨ Http è¯·æ±‚å¤´é‡Œé¢åŠ ä¸Š db-routingï¼šDB2ï¼Œé‚£ä¹ˆæœ¬æ¬¡è¯·æ±‚å°±ä¼šé‡‡ç”¨æ•°æ®æº 2 è¿›è¡Œå¤„ç†ï¼Œè¯·æ±‚ä»£ç å¦‚ä¸‹ï¼š 1234567POST /user/info HTTP/1.1Host: 127.0.0.1:8089Content-Type: application/jsondb-routing: DB2Cache-Control: no-cachePostman-Token: 56d8dc02-7f3e-7b95-7ff1-572a4bb7d102&#123;"ages":10&#125; é€šè¿‡ä¸Šé¢äº”ä¸ªæ­¥éª¤ï¼Œå¯ä»¥åˆ©ç”¨ AbstractRoutingDataSource å®žçŽ°åŠ¨æ€æ•°æ®æºï¼Œå®žé™…å·¥ä½œä¸­å¯èƒ½æ›´å¤æ‚ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘å¤šçº¿ç¨‹ã€çº¿ç¨‹å®‰å…¨ç­‰é—®é¢˜ã€‚ å¤šæ•°æ®æºçš„æ³¨æ„äº‹é¡¹ è¿™ç§æ–¹å¼åˆ©ç”¨äº†å½“å‰çº¿ç¨‹äº‹åŠ¡ä¸å˜çš„åŽŸç†ï¼Œæ‰€ä»¥è¦æ³¨æ„å¼‚æ­¥çº¿ç¨‹çš„å¤„ç†æ–¹å¼ï¼› è¿™ç§æ–¹å¼åˆ©ç”¨äº† DataSource çš„åŽŸç†ï¼ŒåŠ¨æ€åœ°è¿”å›žä¸åŒçš„ db è¿žæŽ¥ï¼Œä¸€èˆ¬éœ€è¦åœ¨å¼€å¯äº‹åŠ¡ä¹‹å‰ä½¿ç”¨ï¼Œéœ€è¦æ³¨æ„äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼› æ¯”è¾ƒé€‚åˆè¯»å†™æ“ä½œåˆ†å¼€çš„ä¸šåŠ¡åœºæ™¯ï¼› å¤šæ•°æ®çš„æƒ…å†µä¸‹ï¼Œé¿å…ä¸€ä¸ªäº‹åŠ¡é‡Œé¢é‡‡ç”¨ä¸åŒçš„æ•°æ®æºï¼Œè¿™æ ·ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘ç”Ÿï¼Œæ¯”å¦‚æ­»é”çŽ°è±¡ï¼› å­¦ä¼šé€šè¿‡æ—¥å¿—æ£€æŸ¥å¼€å¯è¯·æ±‚çš„æ–¹æ³•å’Œå¼€å¯çš„æ•°æ®æºæ˜¯å¦æ­£ç¡®ï¼Œå¯ä»¥é€šè¿‡ Debug æ–­ç‚¹æ¥è§‚å¯Ÿæ•°æ®æºæ˜¯å¦é€‰æ‹©çš„æ­£ç¡®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¾®æœåŠ¡ä¸‹çš„å»ºè®®åœ¨å®žé™…å·¥ä½œä¸­ï¼Œä¸ºäº†ä¾¿æ·çœäº‹ï¼Œæ›´å¤šå¼€å‘è€…å–œæ¬¢é…ç½®å¤šä¸ªæ•°æ®æºï¼Œä½†æ˜¯å¼ºçƒˆå»ºè®®ä¸è¦åœ¨å¯¹ç”¨æˆ·ç›´æŽ¥æä¾›çš„ API æœåŠ¡ä¸Šé¢é…ç½®å¤šæ•°æ®æºï¼Œå¦åˆ™å°†å‡ºçŽ°ä»¤äººæŽªæ‰‹ä¸åŠçš„ Bugã€‚ å¦‚æžœæ˜¯åšåŽå°ç®¡ç†ç•Œé¢ï¼Œä¾›å…¬å¸å†…éƒ¨å‘˜å·¥ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆè¿™ç§ API å¯ä»¥ä¸ºäº†æ–¹ä¾¿è€Œä½¿ç”¨å¤šæ•°æ®æºã€‚ å¾®æœåŠ¡çš„å¤§çŽ¯å¢ƒä¸‹ï¼ŒæœåŠ¡è¶Šå°ï¼Œå†…èšè¶Šé«˜ï¼Œä½Žè€¦åˆæœåŠ¡è¶Šå¥å£®ï¼Œæ‰€ä»¥ä¸€èˆ¬è·¨åº“ä¹‹é—´é€šè¿‡ REST çš„ API åè®®ï¼Œè¿›è¡Œå†…éƒ¨æœåŠ¡ä¹‹é—´çš„è°ƒç”¨ï¼Œæ˜¯æœ€ç¨³å¦¥çš„æ–¹å¼ï¼ŒåŽŸå› æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š REST çš„ API åè®®æ›´å®¹æ˜“ç›‘æŽ§ï¼Œæ›´å®¹æ˜“å®žçŽ°äº‹åŠ¡çš„åŽŸå­æ€§ï¼› db ä¹‹é—´è§£è€¦ï¼Œä½¿ä¸šåŠ¡é¢†åŸŸä»£ç èŒè´£æ›´æ¸…æ™°ï¼Œæ›´å®¹æ˜“å„è‡ªå¤„ç†å„ç§é—®é¢˜ï¼› åªè¯»å’Œè¯»å†™çš„ API æ›´å®¹æ˜“åˆ†ç¦»å’Œç®¡ç†ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç³»ç»Ÿæž¶æž„æ¼”åŒ–]]></title>
    <url>%2F2020%2F11%2F15%2F%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8C%96%2F</url>
    <content type="text"><![CDATA[ç³»ç»Ÿæž¶æž„ç³»ç»ŸæŠ€æœ¯æŒ‘æˆ˜ä¸Žæ–¹æ¡ˆäº’è”ç½‘ç³»ç»Ÿé¢ä¸´æ€Žæ ·çš„æŒ‘æˆ˜? éœ€è¦é¢å¯¹é«˜å¹¶å‘ç”¨æˆ·ï¼Œå¤§æµé‡è®¿é—® Google æ—¥å‡ PV æ•° 35 äº¿ï¼Œæ—¥å‡ IP è®¿é—®æ•° 3 äº¿ å¾®ä¿¡åœ¨çº¿ç”¨æˆ·æ•° 10 äº¿ å¤©çŒ«åŒåä¸€æ´»åŠ¨ä¸€å¤©äº¤æ˜“é¢ 3000 äº¿ é«˜å¯ç”¨ ç³»ç»Ÿ 7Ã—24 å°æ—¶ä¸é—´æ–­æœåŠ¡ï¼Œå¤§åž‹äº’è”ç½‘ç«™çš„å®•æœºäº‹ä»¶é€šå¸¸ä¼šæˆä¸ºæ–°é—»ç„¦ç‚¹ éœ€è¦å­˜å‚¨ã€ç®¡ç†æµ·é‡æ•°æ® Facebook æ¯å‘¨ä¸Šä¼ çš„ç…§ç‰‡æ•°ç›®æŽ¥è¿‘10äº¿ ç™¾åº¦æ”¶å½•çš„ç½‘é¡µæ•°ç›®æœ‰æ•°ç™¾äº¿ Google æœ‰è¿‘ç™¾ä¸‡å°æœåŠ¡å™¨ä¸ºå…¨çƒç”¨æˆ·æä¾›æœåŠ¡ ç”¨æˆ·åˆ†å¸ƒå¹¿æ³›ï¼Œç½‘ç»œæƒ…å†µå¤æ‚ è®¸å¤šå¤§åž‹äº’è”ç½‘éƒ½æ˜¯ä¸ºå…¨çƒç”¨æˆ·æä¾›æœåŠ¡çš„ï¼Œç”¨æˆ·åˆ†å¸ƒèŒƒå›´å¹¿ï¼Œå„åœ°ç½‘ç»œæƒ…å†µåƒå·®ä¸‡åˆ«ã€‚ åœ¨å›½å†…ï¼Œæœ‰å„ä¸ªè¿è¥å•†ç½‘ç»œäº’é€šéš¾çš„é—®é¢˜ã€‚è€Œä¸­ç¾Žå…‰ç¼†çš„æ•°æ¬¡æ•…éšœï¼Œä¹Ÿè®©ä¸€äº›å¯¹å›½å¤–ç”¨æˆ·ä¾èµ–è¾ƒå¤§çš„ç½‘ç«™ä¸å¾—ä¸è€ƒè™‘åœ¨æµ·å¤–å»ºç«‹æ•°æ®ä¸­å¿ƒ å®‰å…¨çŽ¯å¢ƒæ¶åŠ£ ç”±äºŽäº’è”ç½‘çš„å¼€æ”¾æ€§ï¼Œä½¿å¾—äº’è”ç½‘ç«™æ›´å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œå¤§åž‹ç½‘ç«™å‡ ä¹Žæ¯å¤©éƒ½ä¼šé‡åˆ°é»‘å®¢æ”»å‡»æƒ…å†µã€‚2011å¹´å›½å†…å¤šä¸ªé‡è¦ç½‘ç«™æ³„éœ²ç”¨æˆ·å¯†ç ï¼Œè®©æ™®é€šç”¨æˆ·ä¹Ÿç›´é¢ä¸€æ¬¡äº’è”ç½‘å®‰å…¨é—®é¢˜ éœ€æ±‚å¿«é€Ÿå˜æ›´ï¼Œå‘å¸ƒé¢‘ç¹ å’Œä¼ ç»Ÿè½¯ä»¶çš„ç‰ˆæœ¬å‘å¸ƒé¢‘çŽ‡ä¸åŒï¼Œäº’è”ç½‘äº§å“ä¸ºå¿«é€Ÿé€‚åº”å¸‚åœºï¼Œæ»¡è¶³ç”¨æˆ·éœ€æ±‚ï¼Œå…¶äº§å“å‘å¸ƒé¢‘çŽ‡ä¹Ÿæ˜¯æžé«˜çš„ã€‚Office çš„äº§å“ç‰ˆæœ¬ä»¥å¹´ä¸ºå•ä½å‘å¸ƒï¼Œè€Œä¸€èˆ¬å¤§åž‹ç½‘ç«™çš„äº§å“æ¯å‘¨éƒ½æœ‰æ–°ç‰ˆæœ¬å‘å¸ƒä¸Šçº¿ï¼Œè‡³äºŽä¸­å°åž‹ç½‘ç«™çš„å‘å¸ƒå°±æ›´é¢‘ç¹äº†ï¼Œæœ‰æ—¶å€™ä¸€å¤©ä¼šå‘å¸ƒå‡ åæ¬¡ æ¸è¿›å¼å‘å±• ä¸åŒäºŽä¼ ç»Ÿè½¯ä»¶äº§å“æˆ–è€…ä¼ä¸šåº”ç”¨ç³»ç»Ÿï¼Œä¸€å¼€å§‹å°±è§„åˆ’å¥½å…¨éƒ¨çš„åŠŸèƒ½å’ŒéžåŠŸèƒ½éœ€æ±‚ï¼Œå‡  ä¹Žæ‰€æœ‰çš„å¤§åž‹äº’è”ç½‘ç«™éƒ½æ˜¯ä»Žä¸€ä¸ªå°ç½‘ç«™å¼€å§‹ï¼Œæ¸è¿›çš„å‘å±•èµ·æ¥çš„ã€‚ å¥½çš„äº’è”ç½‘äº§å“éƒ½æ˜¯æ…¢æ…¢è¿è¥å‡ºæ¥çš„ï¼Œä¸æ˜¯ä¸€å¼€å§‹å°±å¼€å‘å¥½çš„ã€‚é‚£äº›åˆšå»ºç«‹å°±æŠ•å…¥å·¨èµ„ï¼Œ æœ‰å·¨å¤§èƒŒæ™¯çš„ç½‘ç«™ï¼ŒåŽæ¥å‘å±•éƒ½å¾ˆæƒ¨æ·¡ã€‚ åº”å¯¹é«˜å¹¶å‘æŒ‘æˆ˜çš„ä¸¤ä¸ªæŠ€æœ¯æ–¹å‘åž‚ç›´ä¼¸ç¼©â€‹ é€šè¿‡å‡çº§ç¡¬ä»¶å’Œç½‘ç»œåžåèƒ½åŠ›å¯ä»¥å®žçŽ°åž‚ç›´ä¼¸ç¼©ã€‚ç”±äºŽä¸éœ€è¦æ”¹å˜åº”ç”¨æž¶æž„ï¼Œæ‰€ä»¥é€šå¸¸ è¢«è®¤ä¸ºæ˜¯æœ€ç®€å•çš„çŸ­æœŸä¼¸ç¼©æ€§æ–¹æ¡ˆã€‚ é€šè¿‡ä½¿ç”¨ RAIDï¼ˆç‹¬ç«‹å†—ä½™ç£ç›˜é˜µåˆ—ï¼‰å¢žåŠ  I/O åžåèƒ½åŠ› é€šè¿‡åˆ‡æ¢åˆ° SSDï¼ˆå›ºæ€ç¡¬ç›˜ï¼‰æ”¹å–„ I/O è®¿é—®é€Ÿåº¦ é€šè¿‡å¢žåŠ å†…å­˜å‡å°‘ I/O æ“ä½œ é€šè¿‡å‡çº§ç½‘ç»œæŽ¥å£æˆ–è€…å¢žåŠ ç½‘ç»œæŽ¥å£æé«˜ç½‘ç»œåžåèƒ½åŠ› æ›´æ–°æœåŠ¡å™¨ä½¿ç”¨æ›´å¤šå¤„ç†å™¨æˆ–è€…æ›´å¤šè¶…çº¿ç¨‹ ç¼ºç‚¹è¾¾åˆ°æŸä¸ªç¨‹åº¦åŽï¼Œå¢žåŠ è®¡ç®—èƒ½åŠ›éœ€è¦çš„æ›´å¤šçš„èŠ±è´¹ã€‚ åž‚ç›´ä¼¸ç¼©æœ‰ç‰©ç†æžé™ã€‚ æ“ä½œç³»ç»Ÿçš„è®¾è®¡æˆ–è€…åº”ç”¨ç¨‹åºè‡ªèº«åˆ¶çº¦ç€åž‚ç›´ä¼¸ç¼©æœ€å¤šåªèƒ½è¾¾åˆ°æŸä¸ªç‚¹ã€‚ æ°´å¹³ä¼¸ç¼©æ°´å¹³ä¼¸ç¼©æ˜¯æŒ‡é€šè¿‡å¢žåŠ æœåŠ¡å™¨æå‡è®¡ç®—èƒ½åŠ›çš„ä¸€ç±»æž¶æž„æ–¹æ³•ã€‚ æ°´å¹³ä¼¸ç¼©è¢«è®¤ä¸ºæ˜¯ä¼¸ç¼©æ€§çš„åœ£æ¯ï¼Œæ°´å¹³ä¼¸ç¼©å¯ä»¥å…‹æœåž‚ç›´ä¼¸ç¼©å¸¦æ¥çš„å•ä½è®¡ç®—æˆæœ¬éšè®¡ç®— èƒ½åŠ›å¢žåŠ è€Œè¿…é€Ÿé£™å‡çš„é—®é¢˜ã€‚ å¦å¤–ï¼Œæ°´å¹³ä¼¸ç¼©æ€»æ˜¯å¯ä»¥å¢žåŠ æ›´å¤šæœåŠ¡å™¨ï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šåƒåž‚ç›´ä¼¸ç¼©é‚£æ ·é­é‡åˆ°å•å°æœ åŠ¡å™¨çš„æžé™ã€‚ äº’è”ç½‘æž¶æž„æ¼”åŒ–ç¬¬é›¶é˜¶æ®µï¼šæœ€ç®€å•çš„äº’è”ç½‘åº”ç”¨æž¶æž„ä¸€å°æœåŠ¡å™¨é‡Œé¢å®Œæˆæ‰€æœ‰çš„äº‹æƒ… ç¬¬ä¸€é˜¶æ®µï¼šåº”ç”¨æ•°æ®åˆ†ç¦» ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ”¹å–„ç³»ç»Ÿæ€§èƒ½ ç¬¬ä¸‰é˜¶æ®µï¼šä½¿ç”¨åº”ç”¨æœåŠ¡å™¨é›†ç¾¤æ”¹å–„ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ› ç¬¬å››é˜¶æ®µï¼šæ•°æ®åº“è¯»å†™åˆ†ç¦» ç¬¬äº”é˜¶æ®µï¼šä½¿ç”¨åå‘ä»£ç†å’Œ CDN åŠ é€Ÿç½‘ç«™å“åº” ç¬¬å…­é˜¶æ®µï¼šä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ ç¬¬ä¸ƒé˜¶æ®µï¼šä½¿ç”¨ NoSQL å’Œæœç´¢å¼•æ“Ž ç¬¬å…«é˜¶æ®µï¼šä¸šåŠ¡æ‹†åˆ† ç¬¬ä¹é˜¶æ®µï¼šå¾®æœåŠ¡åŠä¸­å°åŒ– ç¬¬åé˜¶æ®µ å¤§æ•°æ®ä¸Žæ™ºèƒ½åŒ–äº’è”ç½‘æž¶æž„æ¨¡å¼æ¯ä¸€ä¸ªæ¨¡å¼æè¿°äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬å‘¨å›´ä¸æ–­é‡å¤å‘ç”Ÿçš„é—®é¢˜ä»¥åŠè¯¥é—®é¢˜è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚è¿™ æ ·ï¼Œä½ å°±èƒ½ä¸€æ¬¡åˆä¸€æ¬¡çš„ä½¿ç”¨è¯¥æ–¹æ¡ˆè€Œä¸å¿…åšé‡å¤å·¥ä½œã€‚ æ¨¡å¼çš„å…³é”®åœ¨äºŽæ¨¡å¼çš„å¯é‡å¤æ€§ï¼Œé—®é¢˜ä¸Žåœºæ™¯çš„å¯é‡å¤æ€§å¸¦æ¥è§£å†³æ–¹æ¡ˆçš„å¯é‡å¤ä½¿ç”¨ã€‚ äº’è”ç½‘æž¶æž„æ¨¡å¼å°±æ˜¯è¯•å›¾åŽ»æè¿°é‚£äº›ä¸ºè§£å†³äº’è”ç½‘ç³»ç»Ÿé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€æ˜“æ‰©å±•ã€å¯ä¼¸ ç¼©ã€å®‰å…¨ç­‰ç›®æ ‡ï¼Œè¢«å¾ˆå¤šäº’è”ç½‘åº”ç”¨é‡å¤ä½¿ç”¨çš„ä¸€äº›è§£å†³æ–¹æ¡ˆï¼Œè¿™äº›è§£å†³æ–¹æ¡ˆæ˜¯äº’è”ç½‘ è½¯ä»¶ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚ åˆ†å±‚åˆ†å±‚æ˜¯ä¼ä¸šåº”ç”¨ç³»ç»Ÿä¸­æœ€å¸¸è§çš„ä¸€ç§æž¶æž„æ¨¡å¼ï¼Œå°†ç³»ç»Ÿåœ¨æ¨ªå‘ç»´åº¦ä¸Šåˆ‡åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œ æ¯ä¸ªéƒ¨åˆ†è´Ÿè´£ä¸€éƒ¨åˆ†ç›¸å¯¹æ¯”è¾ƒå•ä¸€çš„èŒè´£ï¼Œç„¶åŽé€šè¿‡ä¸Šå±‚å¯¹ä¸‹å±‚ä¾èµ–å’Œè°ƒç”¨ç»„æˆä¸€ä¸ªå®Œ æ•´çš„ç³»ç»Ÿã€‚ åˆ†å‰²å¦‚æžœè¯´åˆ†å±‚æ˜¯å°†è½¯ä»¶åœ¨æ¨ªå‘æ–¹é¢è¿›è¡Œåˆ‡åˆ†ï¼Œé‚£ä¹ˆåˆ†å‰²å°±æ˜¯åœ¨çºµå‘æ–¹é¢å¯¹è½¯ä»¶è¿›è¡Œåˆ‡åˆ†ã€‚ ç³»ç»Ÿè¶Šå¤§ï¼ŒåŠŸèƒ½è¶Šå¤æ‚ï¼ŒæœåŠ¡å’Œæ•°æ®å¤„ç†çš„ç§ç±»ä¹Ÿè¶Šå¤šï¼Œå°†è¿™äº›ä¸åŒçš„åŠŸèƒ½å’ŒæœåŠ¡åˆ†å‰²å¼€æ¥ï¼ŒåŒ…è£…æˆé«˜å†…èšä½Žè€¦åˆçš„æ¨¡å—å•å…ƒï¼Œä¸€æ–¹é¢æœ‰åŠ©äºŽè½¯ä»¶çš„å¼€å‘å’Œç»´æŠ¤ï¼›å¦ä¸€æ–¹é¢ï¼Œ ä¾¿äºŽä¸åŒæ¨¡å—çš„åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæé«˜ç½‘ç«™çš„å¹¶å‘å¤„ç†èƒ½åŠ›å’ŒåŠŸèƒ½æ‰©å±•èƒ½åŠ›ã€‚ åˆ†å¸ƒå¼å¯¹äºŽå¤§åž‹ç½‘ç«™ï¼Œåˆ†å±‚å’Œåˆ†å‰²çš„ä¸€ä¸ªä¸»è¦ç›®çš„æ˜¯ä¸ºäº†åˆ‡åˆ†åŽçš„æ¨¡å—ä¾¿äºŽåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°±æ˜¯å°†ä¸åŒæ¨¡å—éƒ¨ç½²åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡è¿œç¨‹è°ƒç”¨ååŒå·¥ä½œã€‚åˆ†å¸ƒå¼æ„å‘³ç€è§£å†³åŒæ ·çš„é—®é¢˜å¯ä»¥ä½¿ç”¨æ›´å¤šçš„è®¡ç®—æœºï¼Œè®¡ç®—æœºè¶Šå¤šï¼ŒCPUã€å†…å­˜ã€å­˜å‚¨èµ„æºä¹Ÿå°±è¶Šå¤šï¼Œèƒ½å¤Ÿå¤„ç†çš„å¹¶å‘è®¿é—®å’Œæ•°æ®é‡å°±è¶Šå¤§ã€‚ åˆ†å¸ƒå¼åº”ç”¨å’ŒæœåŠ¡ åˆ†å¸ƒå¼é™æ€èµ„æº åˆ†å¸ƒå¼æ•°æ®å’Œå­˜å‚¨ åˆ†å¸ƒå¼è®¡ç®— é›†ç¾¤ä½¿ç”¨åˆ†å¸ƒå¼è™½ç„¶å·²ç»å°†åˆ†å±‚å’Œåˆ†å‰²åŽçš„æ¨¡å—ç‹¬ç«‹éƒ¨ç½²ï¼Œä½†æ˜¯å¯¹äºŽç”¨æˆ·è®¿é—®é›†ä¸­çš„æ¨¡å—ï¼Œ æ¯”å¦‚ç½‘ç«™çš„é¦–é¡µï¼Œè¿˜éœ€è¦å°†ç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡å™¨é›†ç¾¤åŒ–ï¼Œå³å¤šå°æœåŠ¡å™¨éƒ¨ç½²ç›¸åŒåº”ç”¨æž„æˆä¸€ä¸ªé›†ç¾¤ï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡è®¾å¤‡å…±åŒå¯¹å¤–æä¾›æœåŠ¡ã€‚ ç¼“å­˜ç¼“å­˜å°±æ˜¯å°†æ•°æ®å­˜æ”¾åœ¨è·ç¦»è®¡ç®—æœ€è¿‘çš„ä½ç½®ä»¥åŠ å¿«å¤„ç†é€Ÿåº¦ã€‚ç¼“å­˜æ˜¯æ”¹å–„è½¯ä»¶æ€§èƒ½çš„ç¬¬ä¸€æ‰‹æ®µï¼ŒçŽ°ä»£ CPU è¶Šæ¥è¶Šå¿«çš„ä¸€ä¸ªé‡è¦å› ç´ å°±æ˜¯ä½¿ç”¨äº†æ›´å¤šçš„ç¼“å­˜ï¼Œåœ¨å¤æ‚çš„è½¯ä»¶è®¾è®¡ä¸­ï¼Œç¼“å­˜å‡ ä¹Žæ— å¤„ä¸åœ¨ã€‚å¤§åž‹ç½‘ç«™æž¶æž„è®¾è®¡åœ¨å¾ˆå¤šæ–¹é¢éƒ½ä½¿ç”¨äº†ç¼“å­˜è®¾è®¡ã€‚ CDN åå‘ä»£ç† æœ¬åœ°ç¼“å­˜ è¿œç¨‹ç¼“å­˜ å¼‚æ­¥è®¡ç®—æœºè½¯ä»¶å‘å±•çš„ä¸€ä¸ªé‡è¦ç›®æ ‡å’Œé©±åŠ¨åŠ›æ˜¯é™ä½Žè½¯ä»¶è€¦åˆæ€§ã€‚äº‹ç‰©ä¹‹é—´è¶Šå°‘ç›´æŽ¥å…³ç³»ï¼Œ é‚£ä¹ˆå°±è¶Šå°‘è¢«å½¼æ­¤å½±å“ï¼Œè¶Šå¯ä»¥ç‹¬ç«‹å‘å±•ã€‚å¤§åž‹ç½‘ç«™æž¶æž„ä¸­ï¼Œç³»ç»Ÿè§£è€¦åˆçš„æ‰‹æ®µé™¤äº†å‰é¢æåˆ°çš„åˆ†å±‚ã€åˆ†å‰²ã€åˆ†å¸ƒç­‰æ‰‹æ®µï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦æ‰‹æ®µæ˜¯å¼‚æ­¥ï¼Œå°±æ˜¯å°†ä¸€ä¸ªä¸šåŠ¡æ“ä½œåˆ†æˆå¤šä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µä¹‹é—´é€šè¿‡å…±äº«æ•°æ®è€Œä¸æ˜¯ç›´æŽ¥è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œåä½œã€‚ æé«˜ç³»ç»Ÿå¯ç”¨æ€§ åŠ å¿«ç½‘ç«™å“åº”é€Ÿåº¦ æ¶ˆé™¤å¹¶å‘è®¿é—®é«˜å³° å†—ä½™äº’è”ç½‘åº”ç”¨éœ€è¦ 7Ã—24 å°æ—¶è¿žç»­è¿è¡Œï¼Œä½†æ˜¯æœåŠ¡å™¨æ€»æœ‰å¯èƒ½ä¼šå‡ºçŽ°æ•…éšœï¼Œç‰¹åˆ«æ˜¯æœåŠ¡å™¨è§„æ¨¡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å®•æœºæ˜¯å¿…ç„¶äº‹ä»¶ã€‚è¦æƒ³ä¿è¯åœ¨æœåŠ¡å™¨å®•æœºçš„æƒ…å†µä¸‹ç½‘ç«™ä¾ç„¶å¯ä»¥ç»§ç»­æœåŠ¡ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå°±éœ€è¦ä¸€å®šç¨‹åº¦çš„æœåŠ¡å™¨å†—ä½™è¿è¡Œï¼Œæ•°æ®å†—ä½™å¤‡ä»½ã€‚ è‡ªåŠ¨åŒ–åœ¨æ— äººå€¼å®ˆçš„æƒ…å†µä¸‹ç½‘ç«™å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä¸€åˆ‡éƒ½å¯ä»¥è‡ªåŠ¨åŒ–æ˜¯ç½‘ç«™çš„ç†æƒ³çŠ¶æ€ã€‚ç›®å‰äº’è”ç½‘çš„è‡ªåŠ¨åŒ–æž¶æž„è®¾è®¡ä¸»è¦é›†ä¸­åœ¨è¿ç»´æ–¹é¢ã€‚ å®‰å…¨äº’è”ç½‘çš„å¼€æ”¾ç‰¹æ€§ä½¿å¾—å…¶ä»Žè¯žç”Ÿèµ·å°±é¢å¯¹å·¨å¤§çš„å®‰å…¨æŒ‘æˆ˜ï¼Œç½‘ç«™åœ¨å®‰å…¨æž¶æž„æ–¹é¢ä¹Ÿç§¯ç´¯äº†è®¸å¤šæ¨¡å¼ï¼šé€šè¿‡å¯†ç å’Œæ‰‹æœºæ ¡éªŒç è¿›è¡Œèº«ä»½è®¤è¯ï¼›ç™»å½•ã€äº¤æ˜“ç­‰æ“ä½œéœ€è¦å¯¹ç½‘ç»œé€šè®¯è¿›è¡ŒåŠ å¯†ï¼Œç½‘ç«™æœåŠ¡å™¨ä¸Šå­˜å‚¨çš„æ•æ„Ÿæ•°æ®å¦‚ç”¨æˆ·ä¿¡æ¯ç­‰ä¹Ÿè¿›è¡ŒåŠ å¯†å¤„ç†ï¼›ä¸ºäº†é˜²æ­¢æœºå™¨äººç¨‹åºæ»¥ç”¨ç½‘ç»œèµ„æºä¾›ç»™ç½‘ç«™ï¼Œç½‘ç«™ä½¿ç”¨éªŒè¯ç è¿›è¡Œè¯†åˆ«ï¼›å¯¹äºŽå¸¸è§çš„ç”¨äºŽæ”»å‡»ç½‘ç«™çš„ XSS æ”»å‡»ï¼ŒSQL æ³¨å…¥ï¼Œè¿›è¡Œç¼–ç è½¬æ¢ç­‰ç›¸åº”å¤„ç†ï¼›å¯¹äºŽåžƒåœ¾ä¿¡æ¯ã€æ•æ„Ÿä¿¡æ¯è¿›è¡Œè¿‡æ»¤ï¼› å¯¹è½¬è´¦äº¤æ˜“ç­‰é‡è¦æ“ä½œæ ¹æ®äº¤æ˜“æ¨¡å¼å’Œäº¤æ˜“ä¿¡æ¯è¿›è¡Œé£Žé™©æŽ§åˆ¶ã€‚ å¦‚ä½•è¡¡é‡ä¸€ä¸ªç³»ç»Ÿçš„æž¶æž„è®¾è®¡é«˜æ€§èƒ½æ€§èƒ½æ˜¯äº’è”ç½‘çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ï¼Œé™¤éžæ˜¯æ²¡å¾—é€‰æ‹©ï¼Œå¦åˆ™ç”¨æˆ·æ— æ³•å¿å—ä¸€ä¸ªå“åº”ç¼“æ…¢çš„åº”ç”¨ã€‚ä¸€ä¸ªæ‰“å¼€ç¼“æ…¢åº”ç”¨ä¼šå¯¼è‡´ä¸¥é‡çš„ç”¨æˆ·æµå¤±ï¼Œå¾ˆå¤šæ—¶å€™ç³»ç»Ÿæ€§èƒ½é—®é¢˜æ˜¯ç³»ç»Ÿæž¶æž„å‡çº§ä¼˜åŒ–çš„è§¦å‘å™¨ã€‚å¯ä»¥è¯´æ€§èƒ½æ˜¯äº’è”ç½‘ç³»ç»Ÿæž¶æž„è®¾è®¡çš„ä¸€ä¸ªé‡è¦æ–¹é¢ï¼Œä»»ä½•æž¶æž„è®¾è®¡æ–¹æ¡ˆéƒ½å¿…é¡»è€ƒè™‘å¯èƒ½ä¼šå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚ ä¹Ÿæ­£æ˜¯å› ä¸ºæ€§èƒ½é—®é¢˜å‡ ä¹Žæ— å¤„ä¸åœ¨ï¼Œæ‰€ä»¥ä¼˜åŒ–ç½‘ç«™æ€§èƒ½çš„æ‰‹æ®µä¹Ÿéžå¸¸å¤šï¼Œä»Žç”¨æˆ·ç«¯åˆ°æ•°æ®åº“ï¼Œä»Žä»£ç åˆ°æœºæˆ¿éƒ¨ç½²ï¼Œå½±å“ç”¨æˆ·è¯·æ±‚çš„æ‰€æœ‰çŽ¯èŠ‚éƒ½å¯ä»¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚ é«˜å¯ç”¨å› ä¸ºäº’è”ç½‘åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨çš„æœåŠ¡å™¨ç¡¬ä»¶é€šå¸¸æ˜¯æ™®é€šçš„å•†ç”¨æœåŠ¡å™¨ï¼Œè¿™äº›æœåŠ¡å™¨çš„è®¾è®¡ç›®æ ‡æœ¬èº«å¹¶ä¸ä¿è¯é«˜å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºçŽ°æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„æœåŠ¡å™¨å®•æœºã€‚å¤§åž‹äº’è”ç½‘ç³»ç»Ÿé€šå¸¸éƒ½ä¼šæœ‰ä¸Šä¸‡å°æœåŠ¡å™¨ï¼Œæ¯å¤©éƒ½å¿…å®šä¼šæœ‰ä¸€äº›æœåŠ¡å™¨å®•æœºï¼Œå› æ­¤ç³»ç»Ÿé«˜å¯ç”¨æž¶æž„è®¾è®¡çš„å‰ææ˜¯å¿…ç„¶ä¼šå‡ºçŽ°æœåŠ¡å™¨å®•æœºï¼Œè€Œé«˜å¯ç”¨è®¾è®¡çš„ç›®æ ‡å°±æ˜¯å½“æœåŠ¡å™¨å®•æœºçš„æ—¶å€™ï¼ŒæœåŠ¡æˆ–è€…åº”ç”¨ä¾ç„¶å¯ç”¨ã€‚ ç³»ç»Ÿé«˜å¯ç”¨çš„ä¸»è¦æ‰‹æ®µæ˜¯å†—ä½™ï¼Œåº”ç”¨éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸ŠåŒæ—¶æä¾›è®¿é—®ï¼Œæ•°æ®å­˜å‚¨åœ¨å¤šå°æœåŠ¡å™¨ä¸Šäº’ç›¸å¤‡ä»½ï¼Œä»»ä½•ä¸€å°æœåŠ¡å™¨å®•æœºéƒ½ä¸ä¼šå½±å“åº”ç”¨çš„æ•´ä½“å¯ç”¨ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ å¯ä¼¸ç¼©å¤§åž‹äº’è”ç½‘åº”ç”¨é€šè¿‡é›†ç¾¤çš„æ–¹å¼å°†å¤šå°æœåŠ¡å™¨ç»„æˆä¸€ä¸ªæ•´ä½“å…±åŒæä¾›æœåŠ¡ã€‚æ‰€è°“ä¼¸ç¼©æ€§æ˜¯æŒ‡é€šè¿‡ä¸æ–­å‘é›†ç¾¤ä¸­åŠ å…¥æœåŠ¡å™¨çš„æ‰‹æ®µæ¥ç¼“è§£ä¸æ–­ä¸Šå‡çš„ç”¨æˆ·å¹¶å‘è®¿é—®åŽ‹åŠ›å’Œä¸æ–­å¢žé•¿çš„æ•°æ®å­˜å‚¨éœ€æ±‚ã€‚ è¡¡é‡æž¶æž„ä¼¸ç¼©æ€§çš„ä¸»è¦æ ‡å‡†å°±æ˜¯ æ˜¯å¦å¯ä»¥ç”¨å¤šå°æœåŠ¡å™¨æž„å»ºé›†ç¾¤ æ˜¯å¦å®¹æ˜“å‘é›†ç¾¤ä¸­æ·»åŠ æ–°çš„æœåŠ¡å™¨ åŠ å…¥æ–°çš„æœåŠ¡å™¨åŽæ˜¯å¦å¯ä»¥æä¾›å’ŒåŽŸæ¥çš„æœåŠ¡å™¨æ— å·®åˆ«çš„æœåŠ¡ é›†ç¾¤ä¸­å¯å®¹çº³çš„æ€»çš„æœåŠ¡å™¨æ•°é‡æ˜¯å¦æœ‰é™åˆ¶ å¯æ‰©å±•ä¸åŒäºŽå…¶ä»–æž¶æž„è¦ç´ ä¸»è¦å…³æ³¨éžåŠŸèƒ½æ€§éœ€æ±‚ï¼Œæ‰©å±•æ€§æž¶æž„ç›´æŽ¥å…³æ³¨ç³»ç»Ÿçš„åŠŸèƒ½éœ€æ±‚ã€‚äº’è”ç½‘åº”ç”¨å¿«é€Ÿå‘å±•ï¼ŒåŠŸèƒ½ä¸æ–­æ‰©å±•ï¼Œå¦‚ä½•è®¾è®¡ç³»ç»Ÿçš„æž¶æž„ä½¿å…¶èƒ½å¤Ÿå¿«é€Ÿå“åº”éœ€æ±‚å˜åŒ–ï¼Œ æ˜¯ç³»ç»Ÿå¯æ‰©å±•æž¶æž„ä¸»è¦çš„ç›®çš„ã€‚ è¡¡é‡ç³»ç»Ÿæž¶æž„æ‰©å±•æ€§å¥½åçš„ä¸»è¦æ ‡å‡†å°±æ˜¯åœ¨ç³»ç»Ÿå¢žåŠ æ–°çš„ä¸šåŠ¡äº§å“æ—¶ æ˜¯å¦å¯ä»¥å®žçŽ°å¯¹çŽ°æœ‰äº§å“é€æ˜Žæ— å½±å“ï¼Œä¸éœ€è¦ä»»ä½•æ”¹åŠ¨æˆ–è€…å¾ˆå°‘æ”¹åŠ¨æ—¢æœ‰ä¸šåŠ¡åŠŸèƒ½å°±å¯ä»¥ä¸Šçº¿æ–°äº§å“ã€‚ ä¸åŒäº§å“ä¹‹é—´æ˜¯å¦å¾ˆå°‘è€¦åˆï¼Œä¸€ä¸ªäº§å“æ”¹åŠ¨å¯¹å…¶ä»–äº§å“æ— å½±å“ï¼Œå…¶ä»–äº§å“å’ŒåŠŸèƒ½ä¸éœ€è¦ å—ç‰µè¿žè¿›è¡Œæ”¹åŠ¨ã€‚ å¯æ‰©å±•æž¶æž„çš„ä¸»è¦æ‰‹æ®µæ˜¯äº‹ä»¶é©±åŠ¨æž¶æž„å’Œåˆ†å¸ƒå¼æœåŠ¡ã€‚ å®‰å…¨äº’è”ç½‘æ˜¯å¼€æ”¾çš„ï¼Œä»»ä½•äººåœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®ç³»ç»Ÿã€‚ç³»ç»Ÿçš„å®‰å…¨æž¶æž„å°±æ˜¯ä¿æŠ¤ç³»ç»Ÿä¸å—æ¶æ„è®¿é—®å’Œæ”»å‡»ï¼Œä¿æŠ¤ç½‘ç«™çš„é‡è¦æ•°æ®ä¸è¢«çªƒå–ã€‚ è¡¡é‡ç³»ç»Ÿå®‰å…¨æž¶æž„çš„æ ‡å‡†å°±æ˜¯é’ˆå¯¹çŽ°å­˜å’Œæ½œåœ¨çš„å„ç§æ”»å‡»ä¸Žçªƒå¯†æ‰‹æ®µï¼Œæ˜¯å¦æœ‰å¯é çš„åº”å¯¹ç­–ç•¥ã€‚ äº’è”ç½‘æž¶æž„æŠ€æœ¯ å‰ç«¯æž¶æž„ App åŠ Web å¼€å‘æŠ€æœ¯ æµè§ˆå™¨åŠ HTTP ä¼˜åŒ–æŠ€æœ¯ CDN åŠ¨é™åˆ†ç¦» å›¾ç‰‡æœåŠ¡ åå‘ä»£ç† DNS ç½‘å…³åŠåº”ç”¨å±‚æž¶æž„ ç½‘å…³æž¶æž„ è´Ÿè½½å‡è¡¡ åŠ¨æ€é¡µé¢é™æ€åŒ– ä¸šåŠ¡æ‹†åˆ† æœåŠ¡å±‚æž¶æž„ å¾®æœåŠ¡æ¡†æž¶ åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ— åˆ†å¸ƒå¼ç¼“å­˜ åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼ˆé”ï¼‰æœåŠ¡ å­˜å‚¨å±‚æž¶æž„ åˆ†å¸ƒå¼æ–‡ä»¶ åˆ†å¸ƒå¼å…³ç³»æ•°æ®åº“ NoSQL æ•°æ®åº“ åŽå°æž¶æž„ å¤§æ•°æ®å¹³å° æœç´¢å¼•æ“Ž æŽ¨èå¼•æ“Ž æ•°æ®ä»“åº“ è¿ç»´ä¸Žå®‰å…¨ æ•°æ®é‡‡é›†ä¸Žå±•ç¤º æ•°æ®ç›‘æŽ§ä¸ŽæŠ¥è­¦ æ”»å‡»ä¸Žé˜²æŠ¤ æ•°æ®åŠ å¯†ä¸Žè§£å¯†]]></content>
      <categories>
        <category>æž¶æž„</category>
      </categories>
      <tags>
        <tag>æž¶æž„</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa è‡ªå®šä¹‰å‚æ•°è§£æžå™¨]]></title>
    <url>%2F2020%2F11%2F13%2FSpringDataJpa%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8%2F</url>
    <content type="text"><![CDATA[è‡ªå®šä¹‰ HandlerMethodArgumentResolverå‚æ•°è§£æžå™¨ â€“ Method Argument Resolver SpringDataWebConfiguration ç±»æ˜¯å¦‚ä½•è¢«åŠ è½½çš„ PageableHandlerMethodArgumentResolver æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ SortHandlerMethodArgumentResolver æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ å¦‚ä½•å®šä¹‰è‡ªå·±çš„ HandlerMethodArgumentResolvers ç±» è¿˜æœ‰æ²¡æœ‰å…¶ä»– Web åœºæ™¯éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰å‘¢ Page å’Œ Sort å‚æ•°åŽŸç†æ˜¯ @EnableSpringDataWebSupport æ³¨è§£å°†SpringDataWebConfigurationè¿™ä¸ªç±»åŠ è½½è¿›åŽ»çš„ï¼Œè¿™ä¸ªç±»é‡Œé¢æŠŠåˆ†é¡µå’ŒæŽ’åºçš„å‚æ•°åŠ è½½è¿›åŽ»ï¼Œå…³é”®ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š å…¶ä¸­ï¼Œ@EnableSpringDataWebSupport æ³¨è§£æ˜¯ Spring Data JPA å¯¹ Web æ”¯æŒéœ€è¦å¼€å¯çš„å…¥å£ï¼Œç”±äºŽæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Spring Bootï¼Œæ‰€ä»¥ @EnableSpringDataWebSupport ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åŽ»æŒ‡å®šã€‚è¿™æ˜¯ç”±äºŽ Spring Boot æœ‰è‡ªåŠ¨åŠ è½½çš„æœºåˆ¶ï¼ŒSpringDataWebAutoConfiguration ç±»é‡Œé¢å¼•ç”¨äº† @EnableSpringDataWebSupport çš„æ³¨è§£ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦æ‰‹åŠ¨åŽ»å¼•ç”¨äº†ã€‚å…³é”®ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š è€Œ Spring Boot çš„è‡ªåŠ¨åŠ è½½çš„æ ¸å¿ƒæ–‡ä»¶å°±æ˜¯ spring.factories æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰“å¼€ spring-boot-autoconfigure-2.3.3.jar åŒ…ï¼Œçœ‹ä¸€ä¸‹ spring.factories æ–‡ä»¶å†…å®¹ï¼Œå¯ä»¥æ‰¾åˆ° SpringDataWebAutoConfiguration è¿™ä¸ªé…ç½®ç±»ï¼Œå¦‚ä¸‹ï¼š ç»“è®ºï¼šåªè¦æ˜¯ Spring Boot é¡¹ç›®ï¼Œä»€ä¹ˆéƒ½ä¸éœ€è¦åšï¼Œå®ƒä¼šå¤©ç„¶åœ°è®© Spring Data JPA æ”¯æŒ Web ç›¸å…³çš„æ“ä½œã€‚ å› ä¸º PageableHandlerMethodArgumentResolver å’Œ SortHandlerMethodArgumentResolver ä¸¤ä¸ªç±»æ˜¯é€šè¿‡ SpringDataWebConfiguration åŠ è½½è¿›åŽ»çš„ï¼Œæ‰€ä»¥åŸºæœ¬å¯ä»¥çŸ¥é“ Spring Data JPA çš„ Page å’Œ Sort å‚æ•°æ˜¯å› ä¸º SpringDataWebConfiguration é‡Œé¢ @Bean çš„æ³¨å…¥æ‰ç”Ÿæ•ˆçš„ã€‚ é€šè¿‡ PageableHandlerMethodArgumentResolver å’Œ SortHandlerMethodArgumentResolver è¿™ä¸¤ä¸ªç±»çš„æºç ï¼Œå¯ä»¥çŸ¥é“å®ƒä»¬å®žçŽ°äº† org.springframework.web.method.support.HandlerMethodArgumentResolver è¿™ä¸ªæŽ¥å£ï¼Œä»Žè€Œå¯¹ Request é‡Œé¢çš„ Page å’Œ Sort çš„å‚æ•°åšäº†å¤„ç†é€»è¾‘å’Œè§£æžé€»è¾‘ã€‚ åœ¨å®žé™…å·¥ä½œä¸­ï¼Œå¯èƒ½å­˜åœ¨ç‰¹æ®Šæƒ…å†µéœ€è¦å¯¹å…¶è¿›è¡Œæ‰©å±•ï¼Œæ¯”å¦‚ Page çš„å‚æ•°å¯èƒ½éœ€è¦æ”¯æŒå¤šç§ Key çš„æƒ…å†µï¼Œé‚£ä¹ˆåº”è¯¥æ€Žä¹ˆåšå‘¢ï¼Ÿ HandlerMethodArgumentResolver ç”¨æ³•æŽ¥å£æ–¹æ³•è¯¦è§£ç†Ÿæ‚‰ MVC çš„äººéƒ½çŸ¥é“ï¼ŒHandlerMethodArgumentResolvers åœ¨ Spring MVC ä¸­çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ Controller é‡Œé¢çš„æ–¹æ³•å‚æ•°åšè§£æžï¼Œå³å¯ä»¥æŠŠ Request é‡Œé¢çš„å€¼æ˜ å°„åˆ°æ–¹æ³•çš„å‚æ•°ä¸­ã€‚æ‰“å¼€æ­¤ç±»çš„æºç ä¼šå‘çŽ°åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678public interface HandlerMethodArgumentResolver &#123; //æ£€æŸ¥æ–¹æ³•çš„å‚æ•°æ˜¯å¦æ”¯æŒå¤„ç†å’Œè½¬åŒ– boolean supportsParameter(MethodParameter parameter); //æ ¹æ®requestä¸Šä¸‹æ–‡ï¼Œè§£æžæ–¹æ³•çš„å‚æ•° @Nullable Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception;&#125; æ­¤æŽ¥å£çš„åº”ç”¨åœºæ™¯éžå¸¸å¹¿æ³›ï¼Œå¯ä»¥çœ‹åˆ°å…¶å­ç±»éžå¸¸å¤šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶ä¸­å‡ ä¸ªç±»çš„ä½œç”¨å¦‚ä¸‹ï¼š PathVariableMapMethodArgumentResolver ä¸“é—¨è§£æž @PathVariable é‡Œé¢çš„å€¼ï¼› RequestResponseBodyMethodProcessor ä¸“é—¨è§£æž @RequestBody æ³¨è§£çš„æ–¹æ³•å‚æ•°çš„å€¼ï¼› RequestParamMethodArgumentResolver ä¸“é—¨è§£æž @RequestParam çš„æ³¨è§£å‚æ•°çš„å€¼ï¼Œå½“æ–¹æ³•çš„å‚æ•°ä¸­æ²¡æœ‰ä»»ä½•æ³¨è§£çš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯ @RequestParamï¼› PageableHandlerMethodArgumentResolver ä¸“é—¨è§£æž @PageableDefault Pageable çš„å€¼ SortHandlerMethodArgumentResolver ä¸Ž HttpMessageConverter çš„å…³ç³»æ‰“å¼€ RequestResponseBodyMethodProcessor å°±ä¼šå‘çŽ°ï¼Œè¿™ä¸ªç±»ä¸­ä¸»è¦å¤„ç†çš„æ˜¯ï¼Œæ–¹æ³•é‡Œé¢å¸¦ @RequestBody æ³¨è§£çš„å‚æ•°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è€Œå…¶ä¸­çš„ readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType()) æ–¹æ³•ï¼Œå¦‚æžœæˆ‘ä»¬ç‚¹è¿›åŽ»ç»§ç»­è§‚å¯Ÿï¼Œå‘çŽ°é‡Œé¢ä¼šæ ¹æ® Http è¯·æ±‚çš„ MediaTypeï¼Œæ¥é€‰æ‹©ä¸åŒçš„ HttpMessageConverter è¿›è¡Œè½¬åŒ–ã€‚ ä¸åŒçš„ HttpMessageConverter éƒ½æ˜¯ç”± RequestResponseBodyMethodProcessor è¿›è¡Œè°ƒç”¨çš„ HttpMessageConverter çš„æ‰§è¡Œé¡ºåºå½“æˆ‘ä»¬è‡ªå®šä¹‰ HandlerMethodArgumentResolver æ—¶ï¼Œé€šè¿‡ä¸‹é¢çš„æ–¹æ³•åŠ è½½è¿›åŽ»ã€‚ 1234@Overridepublic void addArgumentResolvers(List&lt;HandlerMethodArgumentResolver&gt; resolvers) &#123; resolvers.add(myPageableHandlerMethodArgumentResolver);&#125; åœ¨ List&lt;HandlerMethodArgumentResolver&gt; é‡Œé¢è‡ªå®šä¹‰çš„ resolver çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œä¹Ÿå°±æ˜¯ä¼šä¼˜å…ˆæ‰§è¡Œ HandlerMethodArgumentResolver ä¹‹åŽï¼Œæ‰ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œç³»ç»Ÿé‡Œé¢è‡ªå¸¦çš„é‚£ä¸€æ‰¹ HttpMessageConverterï¼ŒæŒ‰ç…§ List çš„é¡ºåºæ‰§è¡Œã€‚ Spring é‡Œé¢æœ‰ä¸ªæ‰§è¡Œæ•ˆçŽ‡é—®é¢˜ï¼Œå°±æ˜¯ä¸€æ—¦ä¸€æ¬¡æ‰§è¡Œæ‰¾åˆ°äº†éœ€è¦çš„ HandlerMethodArgumentResolver çš„æ—¶å€™ï¼Œåˆ©ç”¨ Spring ä¸­çš„ç¼“å­˜æœºåˆ¶ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å°±ä¸ä¼šå†éåŽ† List&lt;HandlerMethodArgumentResolver&gt; äº†ï¼Œè€Œæ˜¯ç›´æŽ¥ç”¨ä¸Šæ¬¡æ‰¾åˆ°çš„ HandlerMethodArgumentResolverï¼Œè¿™æ ·æå‡äº†æ‰§è¡Œæ•ˆçŽ‡ã€‚ å¦‚æžœæƒ³è¦äº†è§£æ›´å¤šçš„ Resolverï¼Œå¯ä»¥çœ‹ä¸‹å›¾è¿™ä¸ªç±»çš„ä»£ç ï¼š å¦‚ä½•è‡ªå®šä¹‰ HandlerMethodArgumentResolveråœ¨å®žé™…çš„å·¥ä½œä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å¯¹è€é¡¹ç›®è¿›è¡Œæ”¹ç‰ˆçš„å·¥ä½œï¼Œå¦‚æžœè¦æˆ‘ä»¬æŠŠæ—§çš„ API æŽ¥å£æ”¹é€ æˆ JPA çš„æŠ€æœ¯å®žçŽ°ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºçŽ°éœ€è¦æ–°ã€è€å‚æ•°çš„é—®é¢˜ã€‚å‡è®¾åœ¨å®žé™…åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ Page çš„å‚æ•°æ˜¯ page[number]ï¼Œè€Œ page size çš„å‚æ•°æ˜¯ page[size]ï¼Œçœ‹çœ‹åº”è¯¥æ€Žä¹ˆåšã€‚ ç¬¬ä¸€æ­¥ï¼šæ–°å»º MyPageableHandlerMethodArgumentResolver è¿™ä¸ªç±»çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š ç”¨æ¥å…¼å®¹ ?page[size]=2&amp;page[number]=0 çš„å‚æ•°æƒ…å†µï¼› æ”¯æŒ JPA æ–°çš„å‚æ•°å½¢å¼ ?size=2&amp;page=0ã€‚ é€šè¿‡è‡ªå®šä¹‰çš„ MyPageableHandlerMethodArgumentResolver æ¥å®žçŽ°è¿™ä¸ªéœ€æ±‚ï¼Œè¯·çœ‹ä¸‹é¢è¿™æ®µä»£ç ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * é€šè¿‡@ComponentæŠŠæ­¤ç±»åŠ è½½åˆ°Springçš„å®¹å™¨é‡Œé¢åŽ» */@Componentpublic class MyPageableHandlerMethodArgumentResolver extends PageableHandlerMethodArgumentResolver implements HandlerMethodArgumentResolver &#123; //æˆ‘ä»¬å‡è®¾sortçš„å‚æ•°æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‡‡ç”¨PageableHandlerMethodArgumentResolveré‡Œé¢çš„å†™æ³• private static final SortHandlerMethodArgumentResolver DEFAULT_SORT_RESOLVER = new SortHandlerMethodArgumentResolver(); //ç»™å®šä¸¤ä¸ªé»˜è®¤å€¼ private static final Integer DEFAULT_PAGE = 0; private static final Integer DEFAULT_SIZE = 10; //å…¼å®¹æ–°ç‰ˆï¼Œå¼•å…¥JPAçš„åˆ†é¡µå‚æ•° private static final String JPA_PAGE_PARAMETER = "page"; private static final String JPA_SIZE_PARAMETER = "size"; //å…¼å®¹åŽŸæ¥è€çš„åˆ†é¡µå‚æ•° private static final String DEFAULT_PAGE_PARAMETER = "page[number]"; private static final String DEFAULT_SIZE_PARAMETER = "page[size]"; private SortArgumentResolver sortResolver; //æ¨¡ä»¿ PageableHandlerMethodArgumentResolver é‡Œé¢çš„æž„é€ æ–¹æ³• public MyPageableHandlerMethodArgumentResolver(@Nullable SortArgumentResolver sortResolver) &#123; this.sortResolver = sortResolver == null ? DEFAULT_SORT_RESOLVER : sortResolver; &#125; @Override public boolean supportsParameter(MethodParameter parameter) &#123;// å‡è®¾ç”¨æˆ‘ä»¬è‡ªå·±çš„ç±» MyPageRequest æŽ¥æ”¶å‚æ•° return MyPageRequest.class.equals(parameter.getParameterType()); //åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¯æŒé€šè¿‡Spring Data JPAé‡Œé¢çš„Pageableå‚æ•°è¿›è¡ŒæŽ¥æ”¶ï¼Œä¸¤ç§æ•ˆæžœæ˜¯ä¸€æ ·çš„// return Pageable.class.equals(parameter.getParameterType()); &#125; /** * å‚æ•°å°è£…é€»è¾‘pageå’Œsortï¼ŒJPAå‚æ•°çš„ä¼˜å…ˆçº§é«˜äºŽpage[number]å’Œpage[size]å‚æ•° */ //public Pageable resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) &#123; //è¿™ç§æ˜¯Pageableçš„æ–¹å¼ @Override public MyPageRequest resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) &#123; String jpaPageString = webRequest.getParameter(JPA_PAGE_PARAMETER); String jpaSizeString = webRequest.getParameter(JPA_SIZE_PARAMETER); //æˆ‘ä»¬åˆ†åˆ«å–å‚æ•°é‡Œé¢pageã€sortå’Œ page[number]ã€page[size]çš„å€¼ String pageString = webRequest.getParameter(DEFAULT_PAGE_PARAMETER); String sizeString = webRequest.getParameter(DEFAULT_SIZE_PARAMETER); //å½“ä¸¤ä¸ªéƒ½æœ‰å€¼æ—¶å€™çš„ä¼˜å…ˆçº§ï¼ŒåŠå…¶é»˜è®¤å€¼çš„é€»è¾‘ Integer page = jpaPageString != null ? Integer.valueOf(jpaPageString) : pageString != null ? Integer.valueOf(pageString) : DEFAULT_PAGE; //åœ¨è¿™é‡ŒåŒæ—¶å¯ä»¥è®¡ç®— page+1çš„é€»è¾‘;å¦‚ï¼špage=page+1; Integer size = jpaSizeString != null ? Integer.valueOf(jpaSizeString) : sizeString != null ? Integer.valueOf(sizeString) : DEFAULT_SIZE; //æˆ‘ä»¬å‡è®¾ï¼ŒsortæŽ’åºçš„å–å€¼æ–¹æ³•å…ˆä¸å‘ç”Ÿæ”¹å˜ Sort sort = sortResolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);// å¦‚æžœä½¿ç”¨ Pageable å‚æ•°æŽ¥æ”¶å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨è‡ªå®šä¹‰ MyPageRequest å¯¹è±¡ï¼Œç›´æŽ¥è¿”å›ž PageRequest;// return PageRequest.of(page,size,sort); //å°† page å’Œ size è®¡ç®—å‡ºæ¥çš„è®°è¿‡å°è£…åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„ MyPageRequest ç±»é‡Œé¢åŽ» MyPageRequest myPageRequest = new MyPageRequest(page, size,sort); //è¿”å›ž controller é‡Œé¢çš„å‚æ•°éœ€è¦çš„å¯¹è±¡ï¼› return myPageRequest; &#125;&#125; ä»£ç çš„é€»è¾‘å°±æ˜¯å– Request çš„ Page ç›¸å…³çš„å‚æ•°ï¼Œå°è£…åˆ°å¯¹è±¡ä¸­è¿”å›žç»™ Controller çš„æ–¹æ³•å‚æ•°é‡Œé¢ã€‚ å…¶ä¸­ MyPageRequest ä¸æ˜¯å¿…éœ€çš„ï¼Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºä¸åŒçš„åšæ³•ã€‚ ç¬¬äºŒæ­¥ï¼šæ–°å»º MyPageRequest 12345678/** * ç»§æ‰¿çˆ¶ç±»ï¼Œå¯ä»¥çœæŽ‰å¾ˆå¤šè®¡ç®— page å’Œ index çš„é€»è¾‘ */public class MyPageRequest extends PageRequest &#123; protected MyPageRequest(int page, int size, Sort sort) &#123; super(page, size, sort); &#125;&#125; æ­¤ç±»ï¼Œæˆ‘ä»¬ç”¨æ¥æŽ¥æ”¶ Page ç›¸å…³çš„å‚æ•°å€¼ï¼Œä¹Ÿä¸æ˜¯å¿…éœ€çš„ã€‚ ç¬¬ä¸‰æ­¥ï¼šimplements WebMvcConfigurer åŠ è½½ myPageableHandlerMethodArgumentResolver 12345678910111213141516/** * å®žçŽ° WebMvcConfigurer */@Configurationpublic class MyWebMvcConfigurer implements WebMvcConfigurer &#123; @Autowired private MyPageableHandlerMethodArgumentResolver myPageableHandlerMethodArgumentResolver; /** * è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼ŒæŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ myPageableHandlerMethodArgumentResolver åŠ è½½åˆ°åŽŸå§‹çš„ mvc çš„ resolvers é‡Œé¢åŽ» * @param resolvers */ @Override public void addArgumentResolvers(List&lt;HandlerMethodArgumentResolver&gt; resolvers) &#123; resolvers.add(myPageableHandlerMethodArgumentResolver); &#125;&#125; è¿™é‡Œåˆ©ç”¨ Spring MVC çš„æœºåˆ¶åŠ è½½æˆ‘ä»¬è‡ªå®šä¹‰çš„ myPageableHandlerMethodArgumentResolverï¼Œç”±äºŽè‡ªå®šä¹‰çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œæ‰€ä»¥ç”¨ MyPageRequest.class å’Œ Pageable.class éƒ½æ˜¯å¯ä»¥çš„ ç¬¬å››æ­¥ï¼š Controller é‡Œé¢çš„å†™æ³• 12345678910//ç”¨ Pageable è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥çš„@GetMapping("/users")public Page&lt;UserInfo&gt; queryByPage(Pageable pageable, UserInfo userInfo) &#123; return userInfoRepository.findAll(Example.of(userInfo),pageable);&#125;//ç”¨ MyPageRequest è¿›è¡ŒæŽ¥æ”¶@GetMapping("/users/mypage")public Page&lt;UserInfo&gt; queryByMyPage(MyPageRequest pageable, UserInfo userInfo) &#123; return userInfoRepository.findAll(Example.of(userInfo),pageable);&#125; è¿™é‡Œåˆ©ç”¨ Pageable å’Œ MyPageRequest ä¸¤ç§æ–¹å¼éƒ½æ˜¯å¯ä»¥çš„ã€‚ ç¬¬äº”æ­¥ï¼šå¯åŠ¨é¡¹ç›®æµ‹è¯•ä¸€ä¸‹ ä¾æ¬¡å¯ä»¥æµ‹è¯•ä¸‹é¢ä¸¤ç§æƒ…å†µï¼Œå‘çŽ°éƒ½æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ã€‚ 1GET http://localhost:8089/users?page[size]=2&amp;page[number]=0&amp;ages=10&amp;sort=id,desc 1GET http://localhost:8089/users?size=2&amp;page=0&amp;ages=10&amp;sort=id,desc 1GET http://localhost:8089/users/mypage?page[size]=2&amp;page[number]=0&amp;ages=10&amp;sort=id,desc 1GET http://localhost:8089/users/mypage?size=2&amp;page=0&amp;ages=10&amp;sort=id,desc æ¼”ç¤ºçš„ Controller æ–¹æ³•é‡Œé¢æœ‰å¤šä¸ªå‚æ•°çš„ï¼Œæ¯ä¸ªå‚æ•°éƒ½å„å¸å…¶èŒï¼Œæ‰¾åˆ°è‡ªå·±å¯¹åº”çš„ HandlerMethodArgumentResolverï¼Œè¿™æ­£æ˜¯ Spring MVC æ¡†æž¶çš„ä¼˜é›…ä¹‹å¤„ã€‚ å®žé™…å·¥ä½œçš„å»ºè®®è‡ªå®šä¹‰ HandlerMethodArgumentResolver åˆ°åº•å¯¹æˆ‘ä»¬çš„å·¥ä½œèµ·åˆ°å“ªäº›ä½œç”¨å‘¢ï¼Ÿ åœºæ™¯ä¸€å½“æˆ‘ä»¬åœ¨ Controller é‡Œé¢å¤„ç†æŸäº›å‚æ•°æ—¶ï¼Œé‡å¤çš„æ­¥éª¤éžå¸¸å¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘å†™ä¸€ä¸‹è‡ªå·±çš„æ¡†æž¶ï¼Œæ¥å¤„ç†è¯·æ±‚é‡Œé¢çš„å‚æ•°ï¼Œè€Œ Controller é‡Œé¢çš„ä»£ç å°±ä¼šå˜å¾—éžå¸¸ä¼˜é›…ï¼Œä¸éœ€è¦å…³å¿ƒå…¶ä»–æ¡†æž¶ä»£ç ï¼Œåªè¦çŸ¥é“æ–¹æ³•çš„å‚æ•°æœ‰å€¼å°±å¯ä»¥äº†ã€‚ åœºæ™¯äºŒå†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨å®žé™…å·¥ä½œä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤ JPA é‡Œé¢çš„ Page æ˜¯ä»Ž 0 å¼€å§‹ï¼Œè€Œæˆ‘ä»¬å¯èƒ½æœ‰äº›è€çš„ä»£ç ä¹Ÿè¦ç»´æŠ¤ï¼Œå› ä¸ºè€çš„ä»£ç å¤§å¤šæ•°çš„ Page éƒ½ä¼šä»Ž 1 å¼€å§‹ã€‚å¦‚æžœæˆ‘ä»¬ä¸è‡ªå®šä¹‰ HandlerMethodArgumentResolverï¼Œé‚£ä¹ˆåœ¨ç”¨åˆ°åˆ†é¡µæ—¶ï¼Œæ¯ä¸ª Controller çš„æ–¹æ³•é‡Œé¢éƒ½éœ€è¦å…³å¿ƒè¿™ä¸ªé€»è¾‘ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä½ å°±åº”è¯¥æƒ³åˆ°ä¸Šé¢åˆ—ä¸¾çš„è‡ªå®šä¹‰ MyPageableHandlerMethodArgumentResolver çš„ resolveArgument æ–¹æ³•çš„å®žçŽ°ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•æˆ‘ä»¬åªéœ€è¦åœ¨é‡Œé¢ä¿®æ”¹ Page çš„è®¡ç®—é€»è¾‘å³å¯ã€‚ åœºæ™¯ä¸‰å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨å®žé™…çš„å·¥ä½œä¸­ï¼Œè¿˜ç»å¸¸ä¼šé‡åˆ°â€œå–å½“å‰ç”¨æˆ·â€çš„åº”ç”¨åœºæ™¯ã€‚æ­¤æ—¶ï¼Œæ™®é€šåšæ³•æ˜¯ï¼Œå½“ä½¿ç”¨åˆ°å½“å‰ç”¨æˆ·çš„ UserInfo æ—¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦æ ¹æ®è¯·æ±‚ header çš„ token å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 1234567@PostMapping("user/info")public UserInfo getUserInfo(@RequestHeader String token) &#123; // ä¼ªä»£ç  Long userId = redisTemplate.get(token); UserInfo useInfo = userInfoRepository.getById(userId); return userInfo;&#125; å¦‚æžœæˆ‘ä»¬ä½¿ç”¨ HandlerMethodArgumentResolver æŽ¥å£æ¥å®žçŽ°ï¼Œä»£ç å°±ä¼šå˜å¾—ä¼˜é›…è®¸å¤šã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š å®žçŽ° HandlerMethodArgumentResolver æŽ¥å£ 12345678910111213141516171819202122@Componentpublic class UserInfoArgumentResolver implements HandlerMethodArgumentResolver &#123; private final RedisTemplate redisTemplate;//ä¼ªä»£ç ï¼Œå‡è®¾æˆ‘ä»¬tokenæ˜¯æ”¾åœ¨redisé‡Œé¢çš„ private final UserInfoRepository userInfoRepository; public UserInfoArgumentResolver(RedisTemplate redisTemplate, UserInfoRepository userInfoRepository) &#123; this.redisTemplate = redisTemplate;//ä¼ªä»£ç ï¼Œå‡è®¾æˆ‘ä»¬tokenæ˜¯æ”¾åœ¨redisé‡Œé¢çš„ this.userInfoRepository = userInfoRepository; &#125; @Override public boolean supportsParameter(MethodParameter parameter) &#123; return UserInfo.class.isAssignableFrom(parameter.getParameterType()); &#125; @Override public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception &#123; HttpServletRequest nativeRequest = (HttpServletRequest) webRequest.getNativeRequest(); String token = nativeRequest.getHeader("token"); Long userId = (Long) redisTemplate.opsForValue().get(token);//ä¼ªä»£ç ï¼Œå‡è®¾æˆ‘ä»¬tokenæ˜¯æ”¾åœ¨redisé‡Œé¢çš„ UserInfo useInfo = userInfoRepository.getOne(userId); return useInfo; &#125;&#125; åªéœ€è¦åœ¨ MyWebMvcConfigurer é‡Œé¢æŠŠ userInfoArgumentResolver æ·»åŠ è¿›åŽ»å³å¯ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 12345678910111213@Configurationpublic class MyWebMvcConfigurer implements WebMvcConfigurer &#123; @Autowired private MyPageableHandlerMethodArgumentResolver myPageableHandlerMethodArgumentResolver; @Autowired private UserInfoArgumentResolver userInfoArgumentResolver; @Override public void addArgumentResolvers(List&lt;HandlerMethodArgumentResolver&gt; resolvers) &#123; resolvers.add(myPageableHandlerMethodArgumentResolver); //æˆ‘ä»¬åªéœ€è¦æŠŠuserInfoArgumentResolveråŠ å…¥resolversä¸­å³å¯ resolvers.add(userInfoArgumentResolver); &#125;&#125; åœ¨ Controller ä¸­ä½¿ç”¨ 12345678910111213@RestControllerpublic class UserInfoController &#123; //èŽ·å¾—å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ @GetMapping("user/info") public UserInfo getUserInfo(UserInfo userInfo) &#123; return userInfo; &#125; //ç»™å½“å‰ç”¨æˆ· say hello @PostMapping("sayHello") public String sayHello(UserInfo userInfo) &#123; return "hello " + userInfo.getTelephone(); &#125;&#125; ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Controller é‡Œé¢å¯ä»¥å®Œå…¨çœæŽ‰æ ¹æ® token ä»Ž redis å–å½“å‰ç”¨æˆ·ä¿¡æ¯çš„è¿‡ç¨‹ï¼Œä¼˜åŒ–äº†æ“ä½œæµç¨‹ã€‚ åœºæ™¯å››æœ‰çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šæ›´æ”¹ Pageable çš„é»˜è®¤å€¼å’Œå‚æ•°çš„åå­—ï¼Œä¹Ÿå¯ä»¥åœ¨ application.properties çš„æ–‡ä»¶é‡Œé¢é€šè¿‡å¦‚ä¸‹çš„ Key å€¼å¯¹è‡ªå®šä¹‰è¿›è¡Œé…ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ€è·¯æ‹“å±•WebMvcConfigurer ä»‹ç»å½“æˆ‘ä»¬åš Spring çš„ MVC å¼€å‘çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé€šè¿‡å®žçŽ° WebMvcConfigurer åŽ»åšä¸€äº›å…¬ç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾å‡ ä¸ªå¸¸è§çš„æ–¹æ³• 12345678910111213141516/** æ‹¦æˆªå™¨é…ç½® */void addInterceptors(InterceptorRegistry var1);/** è§†å›¾è·³è½¬æŽ§åˆ¶å™¨ */void addViewControllers(ViewControllerRegistry registry);/** é™æ€èµ„æºå¤„ç† */void addResourceHandlers(ResourceHandlerRegistry registry);/** é»˜è®¤é™æ€èµ„æºå¤„ç†å™¨ */void configureDefaultServletHandling(DefaultServletHandlerConfigurer configurer);/** è¿™é‡Œé…ç½®è§†å›¾è§£æžå™¨ */void configureViewResolvers(ViewResolverRegistry registry);/** é…ç½®å†…å®¹è£å†³çš„ä¸€äº›é€‰é¡¹ */void configureContentNegotiation(ContentNegotiationConfigurer configurer);/** è§£å†³è·¨åŸŸé—®é¢˜ */void addCorsMappings(CorsRegistry registry);/** æ·»åŠ å¯¹ controller çš„ Return çš„ç»“æžœçš„å¤„ç† */void addReturnValueHandlers(List&lt;HandlerMethodReturnValueHandler&gt; handlers); å½“æˆ‘ä»¬å®žçŽ° Restful é£Žæ ¼çš„ API åè®®æ—¶ï¼Œä¼šç»å¸¸çœ‹åˆ°å…¶å¯¹ json å“åº”ç»“æžœè¿›è¡Œäº†ç»Ÿä¸€çš„å°è£…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨ HandlerMethodReturnValueHandler æ¥å®žçŽ°ï¼Œå†æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚ ç”¨ Result å¯¹ JSON çš„è¿”å›žç»“æžœè¿›è¡Œç»Ÿä¸€å°è£…ä¸‹é¢é€šè¿‡äº”ä¸ªæ­¥éª¤æ¥å®žçŽ°ä¸€ä¸ªé€šè¿‡è‡ªå®šä¹‰æ³¨è§£ï¼Œåˆ©ç”¨HandlerMethodReturnValueHandler å®žçŽ° JSON ç»“æžœå°è£…çš„ä¾‹å­ã€‚ ç¬¬ä¸€æ­¥ï¼šæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ @WarpWithDataï¼Œè¡¨ç¤ºæ­¤æ³¨è§£åŒ…è£…çš„è¿”å›žç»“æžœç”¨ Data è¿›è¡ŒåŒ…è£…ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documented/** è‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£å¯¹è¿”å›žç»“æžœè¿›è¡ŒåŒ…è£… */public @interface WarpWithData &#123;&#125; ç¬¬äºŒæ­¥ï¼šè‡ªå®šä¹‰ MyWarpWithDataHandlerMethodReturnValueHandlerï¼Œå¹¶ç»§æ‰¿ RequestResponseBodyMethodProcessor æ¥å®žçŽ° HandlerMethodReturnValueHandler æŽ¥å£ï¼Œç”¨æ¥å¤„ç† Data åŒ…è£…çš„ç»“æžœï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920//è‡ªå®šä¹‰è‡ªå·±çš„ return çš„å¤„ç†ç±»ï¼Œæˆ‘ä»¬ç›´æŽ¥ç»§æ‰¿ RequestResponseBodyMethodProcessorï¼Œè¿™æ ·çˆ¶ç±»é‡Œé¢çš„æ–¹æ³•æˆ‘ä»¬ç›´æŽ¥ä½¿ç”¨å°±å¯ä»¥äº†@Componentpublic class MyWarpWithDataHandlerMethodReturnValueHandler extends RequestResponseBodyMethodProcessor implements HandlerMethodReturnValueHandler &#123; //å‚è€ƒçˆ¶ç±» RequestResponseBodyMethodProcessor çš„åšæ³• public MyWarpWithDataHandlerMethodReturnValueHandler(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) &#123; super(converters); &#125; //åªå¤„ç†éœ€è¦åŒ…è£…çš„æ³¨è§£çš„æ–¹æ³• @Override public boolean supportsReturnType(MethodParameter returnType) &#123; return returnType.hasMethodAnnotation(WarpWithData.class); &#125; //å°†è¿”å›žç»“æžœåŒ…è£…ä¸€å±‚ Data @Override public void handleReturnValue(Object returnValue, MethodParameter methodParameter, ModelAndViewContainer modelAndViewContainer, NativeWebRequest nativeWebRequest) throws IOException, HttpMediaTypeNotAcceptableException &#123; Map&lt;String,Object&gt; res = new HashMap&lt;&gt;(); res.put("data",returnValue); super.handleReturnValue(res,methodParameter,modelAndViewContainer,nativeWebRequest); &#125;&#125; ç¬¬ä¸‰æ­¥ï¼šåœ¨ MyWebMvcConfigurer é‡Œé¢ç›´æŽ¥æŠŠ myWarpWithDataHandlerMethodReturnValueHandler åŠ å…¥ handlers é‡Œé¢å³å¯ï¼Œä¹Ÿæ˜¯é€šè¿‡è¦†ç›–çˆ¶ç±» WebMvcConfigurer é‡Œé¢çš„ addReturnValueHandlers æ–¹æ³•å®Œæˆçš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920@Configurationpublic class MyWebMvcConfigurer implements WebMvcConfigurer &#123; @Autowired private MyWarpWithDataHandlerMethodReturnValueHandler myWarpWithDataHandlerMethodReturnValueHandler; //æŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ myWarpWithDataHandlerMethodReturnValueHandler åŠ å…¥ handlers é‡Œé¢å³å¯ @Override public void addReturnValueHandlers(List&lt;HandlerMethodReturnValueHandler&gt; handlers) &#123; handlers.add(myWarpWithDataHandlerMethodReturnValueHandler); &#125; @Autowired private RequestMappingHandlerAdapter requestMappingHandlerAdapter; //ç”±äºŽ HandlerMethodReturnValueHandler å¤„ç†çš„ä¼˜å…ˆçº§é—®é¢˜ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹æ³•ï¼ŒæŠŠæˆ‘ä»¬è‡ªå®šä¹‰çš„ myWarpWithDataHandlerMethodReturnValueHandler æ”¾åˆ°ç¬¬ä¸€ä¸ªï¼› @PostConstruct public void init() &#123; List&lt;HandlerMethodReturnValueHandler&gt; returnValueHandlers = Lists.newArrayList(myWarpWithDataHandlerMethodReturnValueHandler); // å–å‡ºåŽŸå§‹åˆ—è¡¨ï¼Œé‡æ–°è¦†ç›–è¿›åŽ»ï¼› returnValueHandlers.addAll(requestMappingHandlerAdapter.getReturnValueHandlers()); requestMappingHandlerAdapter.setReturnValueHandlers(returnValueHandlers); &#125;&#125; è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åˆ©ç”¨ @PostConstruct è°ƒæ•´äº†ä¸€ä¸‹ HandlerMethodReturnValueHandler åŠ è½½çš„ä¼˜å…ˆçº§ï¼Œä½¿å…¶ç”Ÿæ•ˆã€‚ ç¬¬å››æ­¥ï¼šController æ–¹æ³•ä¸­ç›´æŽ¥åŠ ä¸Š @WarpWithData æ³¨è§£ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 12345@GetMapping("/user/&#123;id&#125;")@WarpWithDatapublic UserInfo getUserInfoFromPath(@PathVariable("id") Long id) &#123; return userInfoRepository.getOne(id);&#125; ç¬¬äº”æ­¥ï¼šæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ã€‚ 1GET http://localhost:8089/user/1 å°±ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æžœï¼Œè¿”å›žçš„ JSON ç»“æžœå¤šäº†ä¸€ä¸ª Data åŒ…è£…ã€‚ 12345678910111213&#123; "data": &#123; "id": 1, "version": 0, "createUserId": null, "createTime": "2020-10-23T00:23:10.185Z", "lastModifiedUserId": null, "lastModifiedTime": "2020-10-23T00:23:10.185Z", "ages": 10, "telephone": null, "hibernateLazyInitializer": &#123;&#125; &#125;&#125;]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa å¯¹ WebMVC çš„æ”¯æŒ]]></title>
    <url>%2F2020%2F11%2F11%2FSpringDataJpa%E5%AF%B9WebMVC%E7%9A%84%E6%94%AF%E6%8C%81%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa å¯¹ WebMVC çš„æ”¯æŒSpring Data å¯¹ Spring MVC åšäº†å¾ˆå¥½çš„æ”¯æŒï¼Œä½“çŽ°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š æ”¯æŒåœ¨ Controller å±‚ç›´æŽ¥è¿”å›žå®žä½“ï¼Œè€Œä¸ä½¿ç”¨å…¶æ˜¾å¼çš„è°ƒç”¨æ–¹æ³•ï¼› å¯¹ MVC å±‚æ”¯æŒæ ‡å‡†çš„åˆ†é¡µå’ŒæŽ’åºåŠŸèƒ½ï¼› æ‰©å±•çš„æ’ä»¶æ”¯æŒ Querydslï¼Œå¯ä»¥å¸®å¿™è¿›è¡Œä¸€äº›é€šç”¨çš„æŸ¥è¯¢é€»è¾‘ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¼€å¯ Spring Data å¯¹ Spring Web MVC æ”¯æŒéœ€è¦åœ¨ @Configuration çš„é…ç½®æ–‡ä»¶é‡Œé¢æ·»åŠ  @EnableSpringDataWebSupport è¿™ä¸€æ³¨è§£ï¼Œå¦‚ä¸‹é¢è¿™ç§å½¢å¼ï¼š 12345@Configuration@EnableWebMvc//å¼€å¯æ”¯æŒSpring Data Webçš„æ”¯æŒ@EnableSpringDataWebSupportpublic class WebConfiguration &#123; &#125; ç”±äºŽæˆ‘ä»¬ç”¨äº† Spring Bootï¼Œå…¶æœ‰è‡ªåŠ¨åŠ è½½æœºåˆ¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½ SpringDataWebAutoConfiguration ç±»ï¼Œå‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š 1234567@EnableSpringDataWebSupport@ConditionalOnWebApplication(type = Type.SERVLET)@ConditionalOnClass(&#123; PageableHandlerMethodArgumentResolver.class, WebMvcConfigurer.class &#125;)@ConditionalOnMissingBean(PageableHandlerMethodArgumentResolver.class)@EnableConfigurationProperties(SpringDataWebProperties.class)@AutoConfigureAfter(RepositoryRestMvcAutoConfiguration.class)public class SpringDataWebAutoConfiguration &#123; ... &#125; ä»Žç±»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œ@EnableSpringDataWebSupport ä¼šè‡ªåŠ¨å¼€å¯ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ç”¨ Spring Boot + JPA + MVC çš„æ—¶å€™ï¼Œä»€ä¹ˆéƒ½ä¸éœ€è¦åšï¼Œå› ä¸º Spring Boot åˆ©ç”¨ Spring Data å¯¹ Spring MVC åšäº†å¾ˆå¤š Web å¼€å‘çš„å¤©ç„¶æ”¯æŒã€‚æ”¯æŒçš„ç»„ä»¶æœ‰ DomainConverterã€Pageã€Sortã€DataBindingã€Dynamic Param ç­‰ã€‚ DomainClassConverter ç»„ä»¶è¿™ä¸ªç»„ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯å¸®æˆ‘ä»¬æŠŠ Path ä¸­ ID çš„å˜é‡ï¼Œæˆ– Request å‚æ•°ä¸­çš„å˜é‡ ID çš„å‚æ•°å€¼ï¼Œç›´æŽ¥è½¬åŒ–æˆå®žä½“å¯¹è±¡æ³¨å†Œåˆ° Controller æ–¹æ³•çš„å‚æ•°é‡Œé¢ã€‚æ€Žä¹ˆç†è§£å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼Œå°±å¾ˆå¥½æ‡‚äº†ã€‚ ä¸¾ä¾‹é¦–å…ˆï¼Œå†™ä¸€ä¸ª MVC çš„ Controllerï¼Œåˆ†åˆ«ä»Ž Path å’Œ Param å˜é‡é‡Œé¢ï¼Œæ ¹æ® ID è½¬åŒ–æˆå®žä½“ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021@RestControllerpublic class UserInfoController &#123; /** * ä»Žpathå˜é‡é‡Œé¢èŽ·å¾—å‚æ•°IDçš„å€¼ï¼Œç„¶åŽç›´æŽ¥è½¬åŒ–æˆUserInfoå®žä½“ * @param userInfo * @return */ @GetMapping("/user/&#123;id&#125;") public UserInfo getUserInfoFromPath(@PathVariable("id") UserInfo userInfo) &#123; return userInfo; &#125; /** * å°†requestçš„paramä¸­çš„IDå˜é‡å€¼ï¼Œè½¬åŒ–æˆUserInfoå®žä½“ * @param userInfo * @return */ @GetMapping("/user") public UserInfo getUserInfoFromRequestParam(@RequestParam("id") UserInfo userInfo) &#123; return userInfo; &#125;&#125; ç„¶åŽï¼Œæˆ‘ä»¬è¿è¡Œèµ·æ¥ï¼Œçœ‹ä¸€ä¸‹ç»“æžœï¼š 123456789GET http://localhost:8089/user/1Content-Type: application/json&#123; "id": 1, "version": 0, "ages": 10, "telephone": "123456789"&#125; ä»Žç»“æžœæ¥çœ‹ï¼ŒController é‡Œé¢çš„ getUserInfoFromRequestParam æ–¹æ³•ä¼šè‡ªåŠ¨æ ¹æ® ID æŸ¥è¯¢å®žä½“å¯¹è±¡ UserInfoï¼Œç„¶åŽæ³¨å…¥æ–¹æ³•çš„å‚æ•°é‡Œé¢ã€‚é‚£å®ƒæ˜¯æ€Žä¹ˆå®žçŽ°çš„å‘¢ï¼Ÿ æºç åˆ†æžDomainClassConverter ç±»é‡Œé¢æœ‰ä¸ª ToEntityConverter çš„å†…éƒ¨è½¬åŒ–ç±»çš„ Matches æ–¹æ³•ï¼Œå®ƒä¼šåˆ¤æ–­å‚æ•°çš„ç±»åž‹æ˜¯ä¸æ˜¯å®žä½“ï¼Œå¹¶ä¸”æœ‰æ²¡æœ‰å¯¹åº”çš„å®žä½“ Repository å­˜åœ¨ã€‚å¦‚æžœä¸å­˜åœ¨ï¼Œå°±ä¼šç›´æŽ¥æŠ¥é”™è¯´æ‰¾ä¸åˆ°åˆé€‚çš„å‚æ•°è½¬åŒ–å™¨ã€‚ DomainClassConverter é‡Œé¢çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324public class DomainClassConverter&lt;T extends ConversionService &amp; ConverterRegistry&gt; implements ConditionalGenericConverter, ApplicationContextAware &#123; @Override public boolean matches(TypeDescriptor sourceType, TypeDescriptor targetType) &#123; //åˆ¤æ–­å‚æ•°çš„ç±»åž‹æ˜¯ä¸æ˜¯å®žä½“ if (sourceType.isAssignableTo(targetType)) &#123; return false; &#125; Class&lt;?&gt; domainType = targetType.getType(); //æœ‰æ²¡æœ‰å¯¹åº”çš„å®žä½“çš„ Repository å­˜åœ¨ if (!repositories.hasRepositoryFor(domainType)) &#123; return false; &#125; Optional&lt;RepositoryInformation&gt; repositoryInformation = repositories.getRepositoryInformationFor(domainType); return repositoryInformation.map(it -&gt; &#123; Class&lt;?&gt; rawIdType = it.getIdType(); return sourceType.equals(TypeDescriptor.valueOf(rawIdType)) || conversionService.canConvert(sourceType.getType(), rawIdType); &#125;).orElseThrow( () -&gt; new IllegalStateException(String.format("Couldn't find RepositoryInformation for %s!", domainType))); &#125;&#125;......&#125; æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­å…¶å®žæ˜¯éœ€è¦æœ‰ UserInfoRepository çš„ï¼Œå¦åˆ™ä¼šå¤±è´¥ã€‚ é€šè¿‡æºç æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æžœ matches=trueï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œä¸‹é¢çš„ convert æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ findById çš„æ–¹æ³•å¸®æˆ‘ä»¬æ‰§è¡ŒæŸ¥è¯¢åŠ¨ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è€Œ DomainClassConverter æ˜¯ Spring MVC è‡ªå®šä¹‰ Formatter çš„ä¸€ç§æœºåˆ¶ï¼ŒåŠ è½½è¿›åŽ»ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š è€Œ SpringDataWebConfiguration æ˜¯å› ä¸ºå®žçŽ°äº† WebMvcConfigurer çš„ addFormatters æ‰€æœ‰åŠ è½½äº†è‡ªå®šä¹‰å‚æ•°è½¬åŒ–å™¨çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æ‰æœ‰äº† DomainClassConverter ç»„ä»¶çš„æ”¯æŒã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š 1234@Configurationpublic class SpringDataWebConfiguration implements WebMvcConfigurer, BeanClassLoaderAware &#123;......&#125; ä»Žæºç ä¸Šæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒDomainClassConverter åªä¼šæ ¹æ® ID æ¥æŸ¥è¯¢å®žä½“ï¼Œå¾ˆæœ‰å±€é™æ€§ï¼Œæ²¡æœ‰æ›´åŠ çµæ´»çš„å‚æ•°è½¬åŒ–åŠŸèƒ½ï¼Œä¸è¿‡ä½ ä¹Ÿå¯ä»¥æ ¹æ®æºç è‡ªå·±è¿›è¡Œæ‰©å±•ã€‚ Page å’Œ Sort çš„å‚æ•°æ”¯æŒä¸¾ä¾‹é¦–å…ˆï¼Œæ–°å»ºä¸€ä¸ª UserInfoControllerï¼Œé‡Œé¢æ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æµ‹è¯•åˆ†é¡µå’ŒæŽ’åºã€‚ 12345678@GetMapping("/users")public Page&lt;UserInfo&gt; queryByPage(Pageable pageable, UserInfo userInfo) &#123; return userInfoRepository.findAll(Example.of(userInfo),pageable);&#125;@GetMapping("/users/sort")public HttpEntity&lt;List&lt;UserInfo&gt;&gt; queryBySort(Sort sort) &#123; return new HttpEntity&lt;&gt;(userInfoRepository.findAll(sort));&#125; å…¶ä¸­ï¼ŒqueryByPage æ–¹æ³•ä¸­ï¼Œä¸¤ä¸ªå‚æ•°å¯ä»¥åˆ†åˆ«æŽ¥æ”¶åˆ†é¡µå‚æ•°å’ŒæŸ¥è¯¢æ¡ä»¶ï¼Œæˆ‘ä»¬è¯·æ±‚ä¸€ä¸‹ï¼Œçœ‹çœ‹æ•ˆæžœï¼š 1GET http://localhost:8089/users?size=2&amp;page=0&amp;ages=10&amp;sort=id,desc å‚æ•°é‡Œé¢å¯ä»¥æ”¯æŒåˆ†é¡µå¤§å°ä¸º 2ã€é¡µç  0ã€æŽ’åºï¼ˆæŒ‰ç…§ ID å€’åºï¼‰ ages=10 æ‰€æœ‰ç»“æžœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041&#123; "content": [ &#123; "id": 4, "version": 0, "ages": 10, "telephone": "123456789" &#125;, &#123; "id": 3, "version": 0, "ages": 10, "telephone": "123456789" &#125; ], "pageable": &#123; "sort": &#123; "sorted": true, "unsorted": false, "empty": false &#125;, "offset": 0, "pageNumber": 0, "pageSize": 2, "unpaged": false, "paged": true &#125;, "totalPages": 2, "totalElements": 4, "last": false, "size": 2, "number": 0, "numberOfElements": 2, "sort": &#123; "sorted": true, "unsorted": false, "empty": false &#125;, "first": true, "empty": false&#125; å› æ­¤ï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼šPageable æ—¢æ”¯æŒåˆ†é¡µå‚æ•°ï¼Œä¹Ÿæ”¯æŒæŽ’åºå‚æ•°ã€‚å¹¶ä¸”ä»Žä¸‹é¢è¿™è¡Œä»£ç å¯ä»¥çœ‹å‡ºå…¶ä¹Ÿå¯ä»¥å•ç‹¬è°ƒç”¨ Sort å‚æ•°ã€‚ 1GET http://localhost:8089/users/sort?ages=10&amp;sort=id,desc åŽŸç†åˆ†æžå’Œ DomainClassConverter ç»„ä»¶çš„æ”¯æŒæ˜¯ä¸€æ ·çš„ï¼Œç”±äºŽ SpringDataWebConfiguration å®žçŽ°äº† WebMvcConfigurer æŽ¥å£ï¼Œé€šè¿‡ addArgumentResolvers æ–¹æ³•ï¼Œæ‰©å±•äº† Controller æ–¹æ³•çš„å‚æ•° HandlerMethodArgumentResolver ï¼Œä»Žä¸‹é¢å›¾ç‰‡ä¸­ä½ å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚ æˆ‘ä»¬é€šè¿‡ç®­å¤´çš„åœ°æ–¹åˆ†æžä¸€ä¸‹ SortHandlerMethodArgumentResolver çš„ç±»ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š è¿™ä¸ªç±»é‡Œé¢æœ€å…³é”®çš„å°±æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š supportsParameterï¼šè¡¨ç¤ºåªå¤„ç†ç±»åž‹ä¸º Sort.class çš„å‚æ•°ï¼› resolveArgumentï¼šå¯ä»¥æŠŠè¯·æ±‚é‡Œé¢å‚æ•°çš„å€¼ï¼Œè½¬æ¢æˆè¯¥æ–¹æ³•é‡Œé¢çš„å‚æ•° Sort å¯¹è±¡ã€‚ è¿™é‡Œè¿˜è¦æåˆ°çš„æ˜¯å¦å¤–ä¸€ä¸ªç±»ï¼šPageableHandlerMethodArgumentResolver ç±»ã€‚ è¿™ä¸ªç±»é‡Œé¢ä¹Ÿæœ‰ä¸¤ä¸ªæœ€å…³é”®çš„æ–¹æ³•ï¼š supportsParameterï¼šè¡¨ç¤ºæˆ‘åªå¤„ç†ç±»åž‹æ˜¯ Pageable.class çš„å‚æ•°ï¼› resolveArgumentï¼šæŠŠè¯·æ±‚é‡Œé¢å‚æ•°çš„å€¼ï¼Œè½¬æ¢æˆè¯¥æ–¹æ³•é‡Œé¢çš„å‚æ•° Pageable çš„å®žçŽ°ç±» PageRequestã€‚ Web DataBinding SupportSpring Data JPA é‡Œé¢ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ @ProjectedPayload å’Œ @JsonPath å¯¹æŽ¥å£è¿›è¡Œæ³¨è§£æ”¯æŒï¼Œä¸è¿‡è¦æ³¨æ„è¿™ä¸Ž Jackson æ³¨è§£çš„åŒºåˆ«åœ¨äºŽï¼Œæ­¤æ—¶ç”¨çš„æ˜¯æŽ¥å£ã€‚ ä¸¾ä¾‹ç¬¬ä¸€æ­¥ï¼šå¦‚æžœè¦æ”¯æŒ Projectionï¼Œå¿…é¡»è¦åœ¨ gradle é‡Œé¢å¼•å…¥ jsonpath ä¾èµ–æ‰å¯ä»¥ï¼š 1implementation &apos;com.jayway.jsonpath:json-path&apos; ç¬¬äºŒæ­¥ï¼šæ–°å»ºä¸€ä¸ª UserInfoInterface æŽ¥å£ç±»ï¼Œç”¨æ¥æŽ¥æ”¶æŽ¥å£ä¼ é€’çš„ json å¯¹è±¡ã€‚ 123456789101112package com.example.jpa.example1;import org.springframework.data.web.JsonPath;import org.springframework.data.web.ProjectedPayload;@ProjectedPayloadpublic interface UserInfoInterface &#123; @JsonPath("$.ages") // ç¬¬ä¸€çº§å‚æ•°/JSONé‡Œé¢æ‰¾ageså­—æ®µ// @JsonPath("$..ages") $..ä»£è¡¨ä»»æ„å±‚çº§æ‰¾ageså­—æ®µ Integer getAges(); @JsonPath("$.telephone") //ç¬¬ä¸€çº§æ‰¾å‚æ•°/JSONé‡Œé¢çš„telephoneå­—æ®µ// @JsonPath(&#123; "$.telephone", "$.user.telephone" &#125;) //ç¬¬ä¸€çº§æˆ–è€…userä¸‹é¢çš„telephoneéƒ½å¯ä»¥ String getTelephone();&#125; ç¬¬ä¸‰æ­¥ï¼šåœ¨ Controller é‡Œé¢æ–°å»ºä¸€ä¸ª post æ–¹æ³•ï¼Œé€šè¿‡æŽ¥å£èŽ·å¾— RequestBody å‚æ•°å¯¹è±¡é‡Œé¢çš„å€¼ã€‚ 1234@PostMapping("/users/projected")public UserInfoInterface saveUserInfo(@RequestBody UserInfoInterface userInfoInterface) &#123; return userInfoInterface;&#125; ç¬¬å››æ­¥ï¼šæˆ‘ä»¬å‘é€ä¸€ä¸ª post è¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567POST http://localhost:8089/users/projectedContent-Type: application/json&#123; "ages":10, "telephone":"123456789"&#125; æ­¤æ—¶å¯ä»¥æ­£å¸¸å¾—åˆ°å¦‚ä¸‹ç»“æžœï¼š 1234&#123; "ages": 10, "telephone": "123456789"&#125; è¿™ä¸ªå“åº”ç»“æžœè¯´æ˜Žäº†æŽ¥å£å¯ä»¥æ­£å¸¸æ˜ å°„ã€‚ åŽŸç†åˆ†æž Spring é‡Œé¢æ˜¯å¦‚ä½•é€šè¿‡ HttpMessageConverter å¯¹ Projected è¿›è¡Œçš„æ”¯æŒ æŸ¥çœ‹SpringDataWebConfigurationç±»ï¼Œå…¶ä¸­å®žçŽ°çš„ WebMvcConfigurer æŽ¥å£é‡Œé¢æœ‰ä¸ª extendMessageConverters æ–¹æ³•ï¼Œæ–¹æ³•é‡Œé¢åŠ äº†ä¸€ä¸ª ProjectingJackson2HttpMessageConverter çš„ç±»ï¼Œè¿™ä¸ªç±»ä¼šæŠŠå¸¦ ProjectedPayload.class æ³¨è§£çš„æŽ¥å£è¿›è¡Œ Converterã€‚ å…¶ä¸­ä¸»è¦çš„ä¸¤ä¸ªæ–¹æ³•ï¼š åŠ è½½ ProjectingJackson2HttpMessageConverterï¼Œç”¨æ¥åš Projecting çš„æŽ¥å£è½¬åŒ–ã€‚é€šè¿‡æºç çœ‹ä¸€ä¸‹æ˜¯åœ¨å“ªé‡Œè¢«åŠ è½½è¿›åŽ»çš„ï¼Œå¦‚ä¸‹ï¼š è€Œ ProjectingJackson2HttpMessageConverter ä¸»è¦æ˜¯ç»§æ‰¿äº† MappingJackson2HttpMessageConverterï¼Œå¹¶ä¸”å®žçŽ°äº† HttpMessageConverter çš„æŽ¥å£é‡Œé¢çš„ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶ä¸­ï¼Œ canRead é€šè¿‡åˆ¤æ–­å‚æ•°çš„å®žä½“ç±»åž‹é‡Œé¢æ˜¯å¦æœ‰æŽ¥å£ï¼Œä»¥åŠæ˜¯å¦æœ‰ ProjectedPayload.class æ³¨è§£åŽï¼Œæ‰è¿›è¡Œè§£æžï¼› read æ–¹æ³•è´Ÿè´£æŠŠ HttpInputMessage è½¬åŒ–æˆ Projected çš„æ˜ å°„ä»£ç†å¯¹è±¡ã€‚ QueryDSL Web Supportå®žé™…å·¥ä½œä¸­ï¼Œç»å¸¸æœ‰äººä¼šç”¨ Querydsl åšä¸€äº›å¤æ‚æŸ¥è¯¢ï¼Œæ–¹ä¾¿ç”Ÿæˆ Rest çš„ API æŽ¥å£ï¼Œé‚£ä¹ˆè¿™ç§æ–¹æ³•æœ‰ä»€ä¹ˆå¥½å¤„ï¼Œåˆä¼šæš´éœ²ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿ ä¸¾ä¾‹ç¬¬ä¸€æ­¥ï¼šéœ€è¦ gradle å¼•å…¥ querydsl çš„ä¾èµ–ã€‚ 12345678implementation &apos;com.querydsl:querydsl-apt&apos;implementation &apos;com.querydsl:querydsl-jpa&apos;annotationProcessor(&quot;com.querydsl:querydsl-apt:4.3.1:jpa&quot;, &quot;org.hibernate.javax.persistence:hibernate-jpa-2.1-api:1.0.2.Final&quot;, &quot;javax.annotation:javax.annotation-api:1.3.2&quot;, &quot;org.projectlombok:lombok&quot;)annotationProcessor(&quot;org.springframework.boot:spring-boot-starter-data-jpa&quot;)annotationProcessor &apos;org.projectlombok:lombok&apos; ç¬¬äºŒæ­¥ï¼šUserInfoRepository ç»§æ‰¿ QuerydslPredicateExecutor æŽ¥å£ï¼Œå°±å¯ä»¥å®žçŽ° QueryDSL çš„æŸ¥è¯¢æ–¹æ³•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š 1public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt;, QuerydslPredicateExecutor&lt;UserInfo&gt; &#123;&#125; ç¬¬ä¸‰æ­¥ï¼šController é‡Œé¢ç›´æŽ¥åˆ©ç”¨ @QuerydslPredicate æ³¨è§£æŽ¥æ”¶ Predicate å‚æ•°ã€‚ 12345@GetMapping(value = "user/dsl")Page&lt;UserInfo&gt; queryByDsl(@QuerydslPredicate(root = UserInfo.class) com.querydsl.core.types.Predicate predicate, Pageable pageable) &#123; //è¿™é‡Œé¢ç”¨çš„æ˜¯ userInfoRepository é‡Œé¢çš„ QuerydslPredicateExecutor é‡Œé¢çš„æ–¹æ³• return userInfoRepository.findAll(predicate, pageable);&#125; ç¬¬å››æ­¥ï¼šç›´æŽ¥è¯·æ±‚æˆ‘ä»¬çš„ user / dsl å³å¯ï¼Œè¿™é‡Œåˆ©ç”¨ queryDsl çš„è¯­æ³• ï¼Œä½¿ &amp;ages=10 ä½œä¸ºæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546GET http://localhost:8089/user/dsl?size=2&amp;page=0&amp;ages=10&amp;sort=id%2Cdesc&amp;ages=10Content-Type: application/json&#123; "content": [ &#123; "id": 2, "version": 0, "ages": 10, "telephone": "123456789" &#125;, &#123; "id": 1, "version": 0, "ages": 10, "telephone": "123456789" &#125; ], "pageable": &#123; "sort": &#123; "sorted": true, "unsorted": false, "empty": false &#125;, "offset": 0, "pageNumber": 0, "pageSize": 2, "unpaged": false, "paged": true &#125;, "totalPages": 1, "totalElements": 2, "last": true, "size": 2, "number": 0, "sort": &#123; "sorted": true, "unsorted": false, "empty": false &#125;, "numberOfElements": 2, "first": true, "empty": false&#125;Response code: 200; Time: 721ms; Content length: 425 bytes ç»“è®º: QueryDSL å¯ä»¥å¸®æˆ‘ä»¬çœåŽ»åˆ›å»º Predicate çš„è¿‡ç¨‹ï¼Œç®€åŒ–äº†æ“ä½œæµç¨‹ã€‚ä½†æ˜¯å®ƒä¾ç„¶å­˜åœ¨ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚å¤šäº†ä¸€äº›æ¨¡ç³ŠæŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ã€å¤§å°æŸ¥è¯¢ï¼Œå®ƒå¯¹è¿™äº›æ–¹é¢çš„æ”¯æŒä¸æ˜¯ç‰¹åˆ«å‹å¥½ã€‚å¯èƒ½æœªæ¥ä¼šæ›´æ–°ã€ä¼˜åŒ– åŽŸç†åˆ†æžQueryDSL ä¹Ÿæ˜¯ä¸»è¦åˆ©ç”¨è‡ªå®šä¹‰ Spring MVC çš„ HandlerMethodArgumentResolver å®žçŽ°ç±»ï¼Œæ ¹æ®è¯·æ±‚çš„å‚æ•°å­—æ®µï¼Œè½¬åŒ–æˆ Controller é‡Œé¢æ‰€éœ€è¦çš„å‚æ•°ï¼Œè¯·çœ‹ä¸€ä¸‹æºç ã€‚ 12345public class QuerydslPredicateArgumentResolver implements HandlerMethodArgumentResolver &#123;....public Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer, NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception &#123; ..... åœ¨å®žé™…å¼€å‘ä¸­ï¼Œå…³äºŽ insert å’Œ update çš„æŽ¥å£æ˜¯â€œé€ƒä¸æŽ‰â€çš„ï¼Œä½†ä¸æ˜¯æ¯æ¬¡çš„å­—æ®µéƒ½ä¼šå…¨éƒ¨ä¼ é€’è¿‡æ¥ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åº”è¯¥æ€Žä¹ˆåšå‘¢ï¼Ÿè¿™å°±æ¶‰åŠäº†ä¸Šè¿°å®žä¾‹é‡Œé¢çš„ä¸¤ä¸ªæ³¨è§£ @DynamicUpdate å’Œ @DynamicInsertï¼Œä¸‹é¢æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚ @DynamicUpdate &amp; @DynamicInsert è¯¦è§£@DynamicInsertï¼šè¿™ä¸ªæ³¨è§£è¡¨ç¤º insert çš„æ—¶å€™ï¼Œä¼šåŠ¨æ€ç”Ÿäº§ insert SQL è¯­å¥ å…¶ç”Ÿæˆ SQL çš„è§„åˆ™æ˜¯ï¼šåªæœ‰éžç©ºçš„å­—æ®µæ‰èƒ½ç”Ÿæˆ SQLã€‚ä»£ç å¦‚ä¸‹ï¼š 123456@Target( TYPE )@Retention( RUNTIME )public @interface DynamicInsert &#123; //é»˜è®¤æ˜¯trueï¼Œå¦‚æžœè®¾ç½®æˆfalseï¼Œå°±è¡¨ç¤ºç©ºçš„å­—æ®µä¹Ÿä¼šç”Ÿæˆsqlè¯­å¥ï¼› boolean value() default true;&#125; è¿™ä¸ªæ³¨è§£ä¸»è¦æ˜¯ç”¨åœ¨ @Entity çš„å®žä½“ä¸­ï¼Œå¦‚æžœåŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼Œå°±è¡¨ç¤ºç”Ÿæˆçš„ insert SQL çš„ Columns åªåŒ…å«éžç©ºçš„å­—æ®µï¼›å¦‚æžœå®žä½“ä¸­ä¸åŠ è¿™ä¸ªæ³¨è§£ï¼Œé»˜è®¤çš„æƒ…å†µæ˜¯ç©ºçš„ï¼Œå­—æ®µä¹Ÿä¼šä½œä¸º insert è¯­å¥é‡Œé¢çš„ Columnsã€‚ @DynamicUpdateï¼šå’Œ insert æ˜¯ä¸€ä¸ªæ„æ€ï¼Œåªä¸è¿‡è¿™ä¸ªæ³¨è§£æŒ‡çš„æ˜¯åœ¨ update çš„æ—¶å€™ï¼Œä¼šåŠ¨æ€äº§ç”Ÿ update SQL è¯­å¥ ç”Ÿæˆ SQL çš„è§„åˆ™æ˜¯ï¼šåªæœ‰éžç©ºçš„å­—æ®µæ‰ç”Ÿæˆåˆ° update SQL é‡Œé¢ã€‚ä»£ç å¦‚ä¸‹ï¼š 123456@Target( TYPE )@Retention( RUNTIME )public @interface DynamicUpdate &#123; //å’Œinserté‡Œé¢ä¸€ä¸ªæ„æ€ï¼Œé»˜è®¤true; boolean value() default true;&#125; å’Œä¸Šä¸€ä¸ªæ³¨è§£çš„åŽŸç†ç±»ä¼¼ï¼Œè¿™ä¸ªæ³¨è§£ä¹Ÿæ˜¯ç”¨åœ¨ @Entity çš„å®žä½“ä¸­ï¼Œå¦‚æžœåŠ ä¸Šè¿™ä¸ªæ³¨è§£ï¼Œå°±è¡¨ç¤ºç”Ÿæˆçš„ update SQL çš„ Columns åªåŒ…å«éžç©ºçš„å­—æ®µï¼›å¦‚æžœä¸åŠ è¿™ä¸ªæ³¨è§£ï¼Œé»˜è®¤çš„æƒ…å†µæ˜¯ç©ºçš„å­—æ®µä¹Ÿä¼šä½œä¸º update è¯­å¥é‡Œé¢çš„ Columnsã€‚ ä¸¾ä¾‹ç¬¬ä¸€æ­¥ï¼šä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ User å®žä½“ï¼šåŠ ä¸Š @DynamicInsert å’Œ @DynamicUpdate æ³¨è§£ã€‚ 123456789@DynamicInsert@DynamicUpdatepublic class User extends BaseEntity &#123; private String name; private String email; @Enumerated(EnumType.STRING) private SexEnum sex; private Integer age;......&#125;//å…¶ä»–ä¸å˜çš„ä¿¡æ¯çœç•¥ ç¬¬äºŒæ­¥ï¼šUserInfo å®žä½“è¿˜ä¿æŒä¸å˜ï¼Œå³æ²¡æœ‰åŠ ä¸Š @DynamicInsert å’Œ @DynamicUpdate æ³¨è§£ã€‚ 1234567891011@Entity@Data@AllArgsConstructor@NoArgsConstructorpublic class UserInfo extends BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private Integer ages; private String telephone;&#125; ç¬¬ä¸‰æ­¥ï¼šæˆ‘ä»¬åœ¨ UserController é‡Œé¢æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯•æ–°å¢žå’Œæ›´æ–° Userã€‚ 1234@PostMapping("/user")public User saveUser(@RequestBody User user) &#123; return userRepository.save(user);&#125; ç¬¬å››æ­¥ï¼šåœ¨ UserInfoController é‡Œé¢æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯•æ–°å¢žå’Œæ›´æ–° UserInfoã€‚ 1234@PostMapping("/user/info")public UserInfo saveUserInfo(@RequestBody UserInfo userInfo) &#123; return userInfoRepository.save(userInfo);&#125; ç¬¬äº”æ­¥ï¼šæµ‹è¯•ä¸€ä¸‹ UserControllerçš„ post çš„ user æƒ…å†µï¼Œçœ‹ä¸€ä¸‹ insert çš„æƒ…å†µã€‚ 1234567#### é€šè¿‡postæµ‹è¯•insertPOST /user HTTP/1.1Host: 127.0.0.1:8089Content-Type: application/jsonCache-Control: no-cachePostman-Token: 56d8dc02-7f3e-7b95-7ff1-572a4bb7d102&#123;"ages":10, "name":"jack"&#125; è¿™æ—¶ï¼Œå‘é€ä¸€ä¸ª post è¯·æ±‚ï¼Œåªå¸¦ ages å’Œ name å­—æ®µï¼Œè€Œå¹¶æ²¡æœ‰å¸¦ä¸Š User å®žä½“é‡Œé¢çš„å…¶ä»–å­—æ®µï¼Œç”Ÿæˆçš„ SQL å¦‚ä¸‹ï¼š 1Hibernate: insert into user (create_time, last_modified_time, version, name, id) values (?, ?, ?, ?, ?) é™¤äº† BaseEntity é‡Œé¢çš„ä¸€äº›åŸºç¡€å­—æ®µï¼Œè€Œå…¶ä»–å­—æ®µå¹¶æ²¡æœ‰ç”Ÿæˆåˆ° insert è¯­å¥é‡Œé¢ã€‚ ç¬¬å…­æ­¥ï¼šæˆ‘ä»¬å†æµ‹è¯•ä¸€ä¸‹ user çš„ update æƒ…å†µã€‚ 1234567#### è¿˜æ˜¯å‘ç”Ÿpostè¯·æ±‚ï¼Œå¸¦ä¸ŠIDå’Œversionæ‰§è¡Œupdateæ“ä½œPOST /user HTTP/1.1Host: 127.0.0.1:8089Content-Type: application/jsonCache-Control: no-cachePostman-Token: 56d8dc02-7f3e-7b95-7ff1-572a4bb7d102&#123;"ages":10,"name":"jack1","id":1,"version":0&#125; æ­¤æ—¶çœ‹åˆ°ï¼Œupdate å’Œ insert çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯ï¼Œå½“ Entity é‡Œé¢æœ‰ version å­—æ®µçš„æ—¶å€™ï¼Œæˆ‘ä»¬å†å¸¦ä¸Š version å’Œ id å°±ä¼šæ˜¾ç¤ºä¸º updateï¼Œå†çœ‹ä¸€ä¸‹è°ƒç”¨å®Œä¹‹åŽçš„ sqlï¼šç”¨ä¸€æ¡ select æŸ¥è¯¢ä¸€ä¸‹å®žä½“æ˜¯å¦å­˜åœ¨ï¼Œä»£ç å¦‚ä¸‹ï¼š 1Hibernate: select user0_.id as id1_1_0_, user0_.create_time as create_t2_1_0_, user0_.create_user_id as create_u3_1_0_, user0_.last_modified_time as last_mod4_1_0_, user0_.last_modified_user_id as last_mod5_1_0_, user0_.version as version6_1_0_, user0_.age as age7_1_0_, user0_.deleted as deleted8_1_0_, user0_.email as email9_1_0_, user0_.name as name10_1_0_, user0_.sex as sex11_1_0_ from user user0_ where user0_.id=? å…¶ä¸­ä¸€æ¡ update åŠ¨æ€æ›´æ–°äº†æˆ‘ä»¬ä¼ é€’çš„é‚£äº›å€¼ï¼Œè€Œä¸æ›´æ–° null çš„å­—æ®µï¼Œå¹¶ä¸”åªæ›´æ–°æœ‰å˜åŒ–çš„å­—æ®µï¼Œæ“ä½œå¦‚ä¸‹ï¼š 1Hibernate: update user set last_modified_time=?, version=?, name=? where id=? and version=? ç¬¬ä¸ƒæ­¥ï¼šé‚£ä¹ˆæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ UserInfo çš„ insert æ–¹æ³•ã€‚ 1234567#### insertPOST /user/info HTTP/1.1Host: 127.0.0.1:8089Content-Type: application/jsonCache-Control: no-cachePostman-Token: 56d8dc02-7f3e-7b95-7ff1-572a4bb7d102&#123;"ages":10&#125; å‘é€ä¸€ä¸ª post çš„ insert æ“ä½œï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ SQLï¼š 1Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?) å‘çŽ°æ— è®ºæœ‰æ²¡æœ‰ä¼ é€’å€¼ï¼Œæ¯ä¸ªå­—æ®µéƒ½åšäº† insertï¼Œæ²¡æœ‰ä¼ é€’çš„è¯ä¼šç”¨ null ä»£æ›¿ã€‚ç¬¬å…«æ­¥ï¼šæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ UserInfo çš„ update æ–¹æ³•ã€‚ 1234567#### updatePOST /user/info HTTP/1.1Host: 127.0.0.1:8089Content-Type: application/jsonCache-Control: no-cachePostman-Token: 56d8dc02-7f3e-7b95-7ff1-572a4bb7d102&#123;"ages":10,"id":1,"version":0&#125; 1Hibernate: update user_info set create_time=?, create_user_id=?, last_modified_time=?, last_modified_user_id=?, version=?, ages=?, telephone=? where id=? and version=? é€šè¿‡ update çš„ SQL å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿åªä¼ é€’äº† ages çš„å€¼ï¼Œå®ƒä¹Ÿä¼šæŠŠæˆ‘ä»¬æ²¡æœ‰ä¼ é€’çš„ telephone æ›´æ–°æˆ nullã€‚ é€šè¿‡ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­åº”è¯¥èƒ½å¼„æ¸…æ¥š @DynamicInsert å’Œ @DynamicUpdate æ³¨è§£ä½œç”¨ï¼Œåœ¨å†™ API çš„æ—¶å€™å°±è¦è€ƒè™‘ä¸€ä¸‹æ˜¯å¦éœ€è¦å¯¹ null çš„å­—æ®µè¿›è¡Œæ“ä½œã€‚ Spring Data å¯¹ç³»ç»Ÿç›‘æŽ§åšäº†å“ªäº›æ”¯æŒï¼Ÿæˆ‘ä»¬æ—¢ç„¶åšäº† MVCï¼Œä¸€å®šä¹Ÿå…ä¸äº†è¦å¯¹ç³»ç»Ÿè¿›è¡Œç›‘æŽ§ï¼Œé‚£ä¹ˆæ€Žä¹ˆçœ‹ç›‘æŽ§æŒ‡æ ‡å‘¢ï¼Ÿ å¯¹æ•°æ®å±‚é¢çš„ç³»ç»Ÿè¿›è¡Œç›‘æŽ§ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚ æ–¹æ³•ä¸€ï¼š/actuator/health çš„æ”¯æŒï¼Œé‡Œé¢ä¼šæ£€æŸ¥ DB çš„çŠ¶æ€ã€‚ æ–¹æ³•äºŒï¼š/actuator/prometheus é‡Œé¢ä¼šåŒ…å«ä¸€äº› Hibernate å’Œ Datasource çš„ metricã€‚ è¿™ä¸ªæ–¹æ³•åœ¨æˆ‘ä»¬åš grafana å›¾è¡¨çš„æ—¶å€™ä¼šå¾ˆæœ‰ç”¨ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š å¼€å¯ prometheus éœ€è¦ gradle é¢å¤–å¼•å…¥ä¸‹é¢è¿™ä¸ªåŒ…ï¼š 1implementation &apos;io.micrometer:micrometer-registry-prometheus&apos; å¼€å¯ Hibernate çš„ statistics éœ€è¦é…ç½®å¦‚ä¸‹æ“ä½œï¼š 123spring.jpa.properties.hibernate.generate_statistics=truemanagement.endpoint.prometheus.enabled=truemanagement.metrics.export.prometheus.enabled=true]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa ä¹è§‚é”ä¸Žé‡è¯•æœºåˆ¶]]></title>
    <url>%2F2020%2F11%2F10%2FSpringDataJpa%E4%B9%90%E8%A7%82%E9%94%81%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa ä¹è§‚é”ä¸Žé‡è¯•æœºåˆ¶ä»€ä¹ˆæ˜¯ä¹è§‚é”ä¹è§‚é”åœ¨å®žé™…å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¸¸ç”¨ï¼Œå®ƒæ²¡æœ‰åŠ é”ã€æ²¡æœ‰é˜»å¡žï¼Œåœ¨å¤šçº¿ç¨‹çŽ¯å¢ƒä»¥åŠé«˜å¹¶å‘çš„æƒ…å†µä¸‹ CPU çš„åˆ©ç”¨çŽ‡æ˜¯æœ€é«˜çš„ï¼Œåžåé‡ä¹Ÿæ˜¯æœ€å¤§çš„ã€‚ è€Œ Java Persistence API åè®®ä¹Ÿå¯¹ä¹è§‚é”çš„æ“ä½œåšäº†è§„å®šï¼šé€šè¿‡æŒ‡å®š @Version å­—æ®µå¯¹æ•°æ®å¢žåŠ ç‰ˆæœ¬å·æŽ§åˆ¶ï¼Œè¿›è€Œåœ¨æ›´æ–°çš„æ—¶å€™åˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦æœ‰å˜åŒ–ã€‚å¦‚æžœæ²¡æœ‰å˜åŒ–å°±ç›´æŽ¥æ›´æ–°ï¼›å¦‚æžœæœ‰å˜åŒ–ï¼Œå°±ä¼šæ›´æ–°å¤±è´¥å¹¶æŠ›å‡ºâ€œOptimisticLockExceptionâ€å¼‚å¸¸ã€‚æˆ‘ä»¬ç”¨ SQL è¡¨ç¤ºä¸€ä¸‹ä¹è§‚é”çš„åšæ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š 12select uid, name, version from user where id=1;update user set name='jack', version=version+1 where id=1 and version=1 å‡è®¾æœ¬æ¬¡æŸ¥è¯¢çš„ version=1ï¼Œåœ¨æ›´æ–°æ“ä½œæ—¶ï¼ŒåŠ ä¸Šè¿™æ¬¡æŸ¥å‡ºæ¥çš„ Versionï¼Œè¿™æ ·å’Œæˆ‘ä»¬ä¸Šä¸€ä¸ªç‰ˆæœ¬ç›¸åŒï¼Œå°±ä¼šæ›´æ–°æˆåŠŸï¼Œå¹¶ä¸”ä¸ä¼šå‡ºçŽ°äº’ç›¸è¦†ç›–çš„é—®é¢˜ï¼Œä¿è¯äº†æ•°æ®çš„åŽŸå­æ€§ã€‚ è¿™å°±æ˜¯ä¹è§‚é”åœ¨æ•°æ®åº“é‡Œé¢çš„åº”ç”¨ã€‚ ä¹è§‚é”çš„å®žçŽ°æ–¹æ³•JPA åè®®è§„å®šï¼Œæƒ³è¦å®žçŽ°ä¹è§‚é”å¯ä»¥é€šè¿‡ @Version æ³¨è§£æ ‡æ³¨åœ¨æŸä¸ªå­—æ®µä¸Šé¢ï¼Œå¹¶ä¸”å¯ä»¥æŒä¹…åŒ–åˆ° DB å³å¯ã€‚å…¶æ”¯æŒçš„ç±»åž‹æœ‰å¦‚ä¸‹å››ç§ï¼š Integer Short Long java.sql.Timestamp è¿™æ ·å°±å¯ä»¥å®Œæˆä¹è§‚é”çš„æ“ä½œã€‚æˆ‘æ¯”è¾ƒæŽ¨èä½¿ç”¨ Integer ç±»åž‹çš„å­—æ®µï¼Œå› ä¸ºè¿™æ ·è¯­ä¹‰æ¯”è¾ƒæ¸…æ™°ã€ç®€å•ã€‚ æ³¨æ„ï¼šSpring Data JPA é‡Œé¢æœ‰ä¸¤ä¸ª @Version æ³¨è§£ è¯·ä½¿ç”¨ @javax.persistence.Version è€Œä¸æ˜¯ @org.springframework.data.annotation.Version @Version çš„ç”¨æ³•1. å®žä½“é‡Œé¢æ·»åŠ å¸¦ @Version æ³¨è§£çš„æŒä¹…åŒ–å­—æ®µ ç›´æŽ¥åœ¨è¿™ä¸ª BaseEntity åŸºç±»é‡Œé¢æ·»åŠ  @Version å³å¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªå­—æ®µæ”¾åœ¨ sub-class-entity é‡Œé¢ã€‚æŽ¨èæ”¾åœ¨åŸºç±»é‡Œé¢ï¼Œå› ä¸ºè¿™æ®µé€»è¾‘æ˜¯å…¬å…±çš„å­—æ®µã€‚æ”¹åŠ¨å®Œä¹‹åŽæˆ‘ä»¬çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910@Data@MappedSuperclasspublic class BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; @Version private Integer version; //......å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä¸Šä¸€è¯¾æ—¶è®²è§£çš„ auditing å­—æ®µï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆçœç•¥&#125; 2. ç”¨ UserInfo å®žä½“ç»§æ‰¿ BaseEntityï¼Œå°±å¯ä»¥å®žçŽ° @Version çš„æ•ˆæžœï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructor@ToString(callSuper = true)public class UserInfo extends BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private Integer ages; private String telephone;&#125; 3. åˆ›å»º UserInfoRepositoryï¼Œæ–¹ä¾¿è¿›è¡Œ DB æ“ä½œã€‚ 1public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt; &#123;&#125; 4. åˆ›å»º UserInfoService å’Œ UserInfoServiceImplï¼Œç”¨æ¥æ¨¡æ‹Ÿ Service çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829public interface UserInfoService &#123; /** * æ ¹æ® UserId äº§ç”Ÿçš„ä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘ */ UserInfo calculate(Long userId);&#125;@Componentpublic class UserInfoServiceImpl implements UserInfoService &#123; @Autowired private UserInfoRepository userInfoRepository; /** * æ ¹æ® UserId äº§ç”Ÿçš„ä¸€äº›ä¸šåŠ¡è®¡ç®—é€»è¾‘ * @param userId * @return */ @Override @Transactional public UserInfo calculate(Long userId) &#123; UserInfo userInfo = userInfoRepository.getOne(userId); try &#123; //æ¨¡æ‹Ÿå¤æ‚çš„ä¸šåŠ¡è®¡ç®—é€»è¾‘è€—æ—¶æ“ä½œï¼› Thread.sleep(500); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; userInfo.setAges(userInfo.getAges()+1); return userInfoRepository.saveAndFlush(userInfo); &#125;&#125; å…¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ @Transactional å¼€å¯äº‹åŠ¡ï¼Œå¹¶ä¸”åœ¨æŸ¥è¯¢æ–¹æ³•åŽé¢æ¨¡æ‹Ÿå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œç”¨æ¥å‘ˆçŽ°å¤šçº¿ç¨‹çš„å¹¶å‘é—®é¢˜ã€‚ 5. æµ‹è¯•ç”¨ä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344@ExtendWith(SpringExtension.class)@DataJpaTest@ComponentScan(basePackageClasses=UserInfoServiceImpl.class)public class UserInfoServiceTest &#123; @Autowired private UserInfoService userInfoService; @Autowired private UserInfoRepository userInfoRepository; @Test public void testVersion() &#123; //åŠ ä¸€æ¡æ•°æ® UserInfo userInfo = userInfoRepository.save(UserInfo.builder().ages(20).telephone("1233456").build()); //éªŒè¯ä¸€ä¸‹æ•°æ®åº“é‡Œé¢çš„å€¼ Assertions.assertEquals(0, userInfo.getVersion()); Assertions.assertEquals(20, userInfo.getAges()); userInfoService.calculate(1L); //éªŒè¯ä¸€ä¸‹æ›´æ–°æˆåŠŸçš„å€¼ UserInfo u2 = userInfoRepository.getOne(1L); Assertions.assertEquals(1, u2.getVersion()); Assertions.assertEquals(21, u2.getAges()); &#125; @Test @Rollback(false) @Transactional(propagation = Propagation.NEVER) public void testVersionException() &#123; //åŠ ä¸€æ¡æ•°æ® userInfoRepository.saveAndFlush(UserInfo.builder().ages(20).telephone("1233456").build()); //æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡ new Thread(() -&gt; userInfoService.calculate(1L)).start(); try &#123; Thread.sleep(10L);// &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; //å¦‚æžœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¼šå‘ç”Ÿä¹è§‚é”å¼‚å¸¸ï¼› Exception exception = Assertions.assertThrows(ObjectOptimisticLockingFailureException.class, () -&gt; &#123; userInfoService.calculate(1L); //æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡ &#125;); System.out.println(exception); &#125;&#125; ä»Žä¸Šé¢çš„æµ‹è¯•å¾—åˆ°çš„ç»“æžœä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ testVersion()ï¼Œä¼šå‘çŽ°åœ¨ save çš„æ—¶å€™ï¼Œ Version ä¼šè‡ªåŠ¨ +1ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä¸º 0ï¼›update çš„æ—¶å€™ä¹Ÿä¼šé™„å¸¦ Version æ¡ä»¶ã€‚é€šè¿‡ä¸‹å›¾çš„ SQLï¼Œä¹Ÿå¯ä»¥çœ‹åˆ° Version çš„å˜åŒ–ã€‚ è€Œå½“é¢æˆ‘ä»¬è°ƒç”¨ testVersionException() æµ‹è¯•æ–¹æ³•çš„æ—¶å€™ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹æ¨¡æ‹Ÿä¸¤ä¸ªå¹¶å‘æƒ…å†µï¼Œä¼šå‘çŽ°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å–åˆ°äº†åŽ†å²æ•°æ®ï¼Œå¹¶åœ¨ç¨åŽéƒ½å¯¹åŽ†å²æ•°æ®è¿›è¡Œäº†æ›´æ–°ã€‚ ç”±æ­¤ä½ ä¼šå‘çŽ°ï¼Œç¬¬äºŒæ¬¡æµ‹è¯•çš„ç»“æžœæ˜¯ä¹è§‚é”å¼‚å¸¸ï¼Œæ›´æ–°ä¸æˆåŠŸã€‚è¯·çœ‹ä¸€ä¸‹æµ‹è¯•çš„æ—¥å¿—ã€‚ é€šè¿‡æ—¥å¿—åˆä¼šå‘çŽ°ï¼Œä¸¤ä¸ª SQL åŒæ—¶æ›´æ–°çš„æ—¶å€™ï¼ŒVersion æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯å®ƒå¯¼è‡´äº†ä¹è§‚é”å¼‚å¸¸ã€‚ ðŸ“Œæ³¨æ„ï¼šä¹è§‚é”å¼‚å¸¸ä¸ä»…ä»…æ˜¯åŒä¸€ä¸ªæ–¹æ³•å¤šçº¿ç¨‹æ‰ä¼šå‡ºçŽ°çš„é—®é¢˜ï¼Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•è€Œé‡‡ç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼›ä¸åŒçš„æ–¹æ³•ã€ä¸åŒçš„é¡¹ç›®ï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´ä¹è§‚é”å¼‚å¸¸ã€‚ä¹è§‚é”çš„æœ¬è´¨æ˜¯ SQL å±‚é¢å‘ç”Ÿçš„ï¼Œå’Œä½¿ç”¨çš„æ¡†æž¶ã€æŠ€æœ¯æ²¡æœ‰å…³ç³»ã€‚ @Version å¯¹ Save æ–¹æ³•çš„å½±å“é€šè¿‡ä¸Šé¢çš„å®žä¾‹å‘çŽ°ï¼Œ@Version åº•å±‚å®žçŽ°é€»è¾‘å’Œ @EntityListeners ä¸€ç‚¹å…³ç³»æ²¡æœ‰ï¼Œåº•å±‚æ˜¯é€šè¿‡ Hibernate åˆ¤æ–­å®žä½“é‡Œé¢æ˜¯å¦æœ‰ @Version çš„æŒä¹…åŒ–å­—æ®µï¼Œåˆ©ç”¨ä¹è§‚é”æœºåˆ¶æ¥åˆ›å»ºå’Œä½¿ç”¨ Version çš„å€¼ã€‚ å› æ­¤ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼šJava Persistence API è´Ÿè´£åˆ¶å®šåè®®ï¼ŒHibernate è´Ÿè´£å®žçŽ°é€»è¾‘ï¼ŒSpring Data JPA è´Ÿè´£å°è£…å’Œä½¿ç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹ Save å¯¹è±¡çš„æ—¶å€™ï¼Œå¦‚ä½•åˆ¤æ–­æ˜¯æ–°å¢žçš„è¿˜æ˜¯ merge çš„é€»è¾‘å‘¢ï¼Ÿ isNew åˆ¤æ–­çš„é€»è¾‘é€šè¿‡æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥ SimpleJpaRepository.class çš„ Save æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°å¦‚ä¸‹å›¾æ˜¾ç¤ºçš„ç•Œé¢ï¼š ç„¶åŽï¼Œæˆ‘ä»¬è¿›å…¥ JpaMetamodelEntityInformation.class çš„ isNew æ–¹æ³•ä¸­ï¼Œåˆä¼šçœ‹åˆ°ä¸‹å›¾æ˜¾ç¤ºçš„ç•Œé¢ï¼š å…¶ä¸­ï¼Œç¬¬ä¸€æ®µé€»è¾‘ï¼Œåˆ¤æ–­å…¶ä¸­æ˜¯å¦æœ‰ @Version æ ‡æ³¨çš„å±žæ€§ï¼Œå¹¶ä¸”è¯¥å±žæ€§æ˜¯å¦ä¸ºåŸºç¡€ç±»åž‹ã€‚å¦‚æžœä¸æ»¡è¶³æ¡ä»¶ï¼Œè°ƒç”¨ super.isNew(entity) æ–¹æ³•ï¼Œè€Œ super.isNew é‡Œé¢åªåˆ¤æ–­äº† ID å­—æ®µæ˜¯å¦æœ‰å€¼ã€‚ ç¬¬äºŒæ®µé€»è¾‘ï¼Œå¦‚æžœæœ‰ @Version å­—æ®µï¼Œé‚£ä¹ˆçœ‹çœ‹è¿™ä¸ªå­—æ®µæ˜¯å¦æœ‰å€¼ï¼Œå¦‚æžœæ²¡æœ‰å°±è¿”å›ž trueï¼Œå¦‚æžœæœ‰å€¼åˆ™è¿”å›ž falseã€‚ ðŸŽ¯ ç»“è®ºï¼šå¦‚æžœæœ‰ @Version æ³¨è§£çš„å­—æ®µï¼Œå°±ä»¥ @Version å­—æ®µæ¥åˆ¤æ–­ save / updateï¼›å¦‚æžœæ²¡æœ‰ï¼Œå°±ä»¥ @ID å­—æ®µæ˜¯å¦æœ‰å€¼æ¥åˆ¤æ–­ save / updateã€‚ æ³¨æ„ï¼šè™½ç„¶çœ‹åˆ°çš„æ˜¯ merge æ–¹æ³•ï¼Œä½†æ˜¯ä¸ä¸€å®šä¼šæ‰§è¡Œ update æ“ä½œï¼Œmerge æ–¹æ³•ä¼šåˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºæ¸¸ç¦»çŠ¶æ€ï¼Œä»¥åŠæœ‰æ—  ID å€¼ã€‚å®ƒä¼šå…ˆè§¦å‘ä¸€æ¡ select è¯­å¥ï¼Œå¹¶æ ¹æ® ID æŸ¥ä¸€ä¸‹è¿™æ¡è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨ï¼Œè™½ç„¶ ID å’Œ Version å­—æ®µéƒ½æœ‰å€¼ï¼Œä½†ä¹Ÿåªæ˜¯æ‰§è¡Œ insert è¯­å¥ï¼›å¦‚æžœæœ¬æ¡ ID è®°å½•å­˜åœ¨ï¼Œæ‰ä¼šæ‰§è¡Œ update çš„ sqlã€‚è‡³äºŽè¿™ä¸ªå…·ä½“çš„ insert å’Œ update çš„ sqlã€ä¼ é€’çš„å‚æ•°æ˜¯ä»€ä¹ˆã€‚ æ€»ä¹‹ï¼Œå¦‚æžœä½¿ç”¨çº¯ç²¹çš„ saveOrUpdate æ–¹æ³•ï¼Œé‚£ä¹ˆå®Œå…¨ä¸éœ€è¦è‡ªå·±å†™è¿™ä¸€æ®µé€»è¾‘ï¼Œåªè¦ä¿è¯ ID å’Œ Version å­˜åœ¨è¯¥æœ‰çš„å€¼å°±å¯ä»¥äº†ï¼ŒJPA ä¼šå¸®æˆ‘ä»¬å®žçŽ°å‰©ä¸‹çš„é€»è¾‘ã€‚ å®žé™…å·¥ä½œä¸­ï¼Œç‰¹åˆ«æ˜¯åˆ†å¸ƒå¼æ›´æ–°çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“ç¢°åˆ°ä¹è§‚é”ï¼Œè¿™æ—¶å€™è¿˜è¦ç»“åˆé‡è¯•æœºåˆ¶æ‰èƒ½å®Œç¾Žè§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚ å…ˆäº†è§£ä¸€ä¸‹ Spring æ”¯æŒçš„é‡è¯•æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ é‡è¯•æœºåˆ¶è¯¦è§£Spring å…¨å®¶æ¡¶é‡Œé¢æä¾›äº†@Retryable çš„æ³¨è§£ï¼Œä¼šå¸®æˆ‘ä»¬è¿›è¡Œé‡è¯•ã€‚ä¸‹é¢çœ‹ä¸€ä¸ª @Retryable çš„ä¾‹å­ã€‚ ç¬¬ä¸€æ­¥ï¼šåˆ©ç”¨ gradle å¼•å…¥ spring-retry çš„ä¾èµ– jarï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1implementation &apos;org.springframework.retry:spring-retry&apos; ç¬¬äºŒæ­¥ï¼šåœ¨ UserInfoServiceImpl çš„æ–¹æ³•ä¸­æ·»åŠ  @Retryable æ³¨è§£ï¼Œå°±å¯ä»¥å®žçŽ°é‡è¯•çš„æœºåˆ¶äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š ç¬¬ä¸‰æ­¥ï¼šæ–°å¢žä¸€ä¸ª RetryConfiguration å¹¶æ·»åŠ  @EnableRetry æ³¨è§£ï¼Œæ˜¯ä¸ºäº†å¼€å¯é‡è¯•æœºåˆ¶ï¼Œä½¿ @Retryable ç”Ÿæ•ˆã€‚ 1234@EnableRetry@Configurationpublic class RetryConfiguration &#123;&#125; ç¬¬å››æ­¥ï¼šæµ‹è¯•ç”¨ä¾‹æµ‹è¯•ä¸€ä¸‹ã€‚ 1234567891011121314151617181920212223242526272829@ExtendWith(SpringExtension.class)@DataJpaTest@ComponentScan(basePackageClasses=UserInfoServiceImpl.class)@Import(RetryConfiguration.class)public class UserInfoServiceRetryTest &#123; @Autowired private UserInfoService userInfoService; @Autowired private UserInfoRepository userInfoRepository; @Test @Rollback(false) @Transactional(propagation = Propagation.NEVER) public void testRetryable() &#123; //åŠ ä¸€æ¡æ•°æ® userInfoRepository.saveAndFlush(UserInfo.builder().ages(20).telephone("1233456").build()); //æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡ new Thread(() -&gt; userInfoService.calculate(1L)).start(); try &#123; Thread.sleep(10L);// &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; //æ¨¡æ‹Ÿå¤šçº¿ç¨‹æ‰§è¡Œä¸¤æ¬¡ï¼Œç”±äºŽåŠ äº†@EnableRetryï¼Œæ‰€ä»¥è¿™æ¬¡ä¹Ÿä¼šæˆåŠŸ UserInfo userInfo = userInfoService.calculate(1L); //ç»è¿‡äº†ä¸¤æ¬¡è®¡ç®—ï¼Œå¹´é¾„å˜æˆäº† 22 Assertions.assertEquals(22,userInfo.getAges()); Assertions.assertEquals(2,userInfo.getVersion()); &#125;&#125; åœ¨æµ‹è¯•ç”¨ä¾‹é‡Œé¢æ‰§è¡Œ @Import(RetryConfiguration.class)ï¼Œè¿™æ ·å°±å¼€å¯äº†é‡è¯•æœºåˆ¶ï¼Œç„¶åŽç»§ç»­åœ¨é‡Œé¢æ¨¡æ‹Ÿäº†ä¸¤æ¬¡çº¿ç¨‹è°ƒç”¨ï¼Œå‘çŽ°ç¬¬äºŒæ¬¡å‘ç”Ÿäº†ä¹è§‚é”å¼‚å¸¸ä¹‹åŽä¾ç„¶æˆåŠŸäº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯å¤±è´¥äº†ä¸€æ¬¡ä¹‹åŽåˆè¿›è¡Œäº†é‡è¯•ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡æˆåŠŸäº†ã€‚ é€šè¿‡æ¡ˆä¾‹å‘çŽ° Retry çš„é€»è¾‘å…¶å®žå¾ˆç®€å•ï¼Œåªéœ€è¦åˆ©ç”¨ @Retryable æ³¨è§£å³å¯ @Retryable è¯¦ç»†ç”¨æ³•å…¶æºç é‡Œé¢æä¾›äº†å¾ˆå¤šæ–¹æ³•ï¼Œçœ‹ä¸‹é¢è¿™ä¸ªå›¾ç‰‡ã€‚ ä¸‹é¢å¯¹å¸¸ç”¨çš„ @Retryable æ³¨è§£ä¸­çš„å‚æ•°åšä¸€ä¸‹è¯´æ˜Žï¼š maxAttemptsï¼šæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 3ï¼Œå¦‚æžœè¦è®¾ç½®çš„é‡è¯•æ¬¡æ•°ä¸º 3ï¼Œå¯ä»¥ä¸å†™ï¼› valueï¼šæŠ›å‡ºæŒ‡å®šå¼‚å¸¸æ‰ä¼šé‡è¯•ï¼› includeï¼šå’Œ value ä¸€æ ·ï¼Œé»˜è®¤ä¸ºç©ºï¼Œå½“ exclude ä¹Ÿä¸ºç©ºæ—¶ï¼Œé»˜è®¤å¼‚å¸¸ï¼› excludeï¼šæŒ‡å®šä¸å¤„ç†çš„å¼‚å¸¸ï¼› backoffï¼šé‡è¯•ç­‰å¾…ç­–ç•¥ï¼Œé»˜è®¤ä½¿ç”¨ @Backoff çš„ valueï¼Œé»˜è®¤ä¸º 1sï¼Œè¯·çœ‹ä¸‹é¢è¿™ä¸ªå›¾ã€‚ å…¶ä¸­ï¼š value=delayï¼šéš”å¤šå°‘æ¯«ç§’åŽé‡è¯•ï¼Œé»˜è®¤ä¸º 1000Lï¼Œå•ä½æ˜¯æ¯«ç§’ï¼› multiplierï¼ˆæŒ‡å®šå»¶è¿Ÿå€æ•°ï¼‰é»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºå›ºå®šæš‚åœ 1 ç§’åŽè¿›è¡Œé‡è¯•ï¼Œå¦‚æžœæŠŠ multiplier è®¾ç½®ä¸º 1.5ï¼Œåˆ™ç¬¬ä¸€æ¬¡é‡è¯•ä¸º 1.5 ç§’ï¼Œç¬¬äºŒæ¬¡ä¸º 3 ç§’ï¼Œç¬¬ä¸‰æ¬¡ä¸º 4.5 ç§’ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äºŽ @Retryable æ‰©å±•çš„ä½¿ç”¨ä¾‹å­ï¼Œå…·ä½“çœ‹ä¸€ä¸‹ä»£ç ï¼š 123456@Servicepublic interface MyService &#123; @Retryable( value = SQLException.class, maxAttempts = 2, backoff = @Backoff(delay = 100)) void retryServiceWithCustomization(String sql) throws SQLException;&#125; å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ˜Žç¡®æŒ‡å®š SQLException.class å¼‚å¸¸çš„æ—¶å€™éœ€è¦é‡è¯•ä¸¤æ¬¡ï¼Œæ¯æ¬¡ä¸­é—´é—´éš” 100 æ¯«ç§’ã€‚ 123456@Service public interface MyService &#123; @Retryable( value = SQLException.class, maxAttemptsExpression = "$&#123;retry.maxAttempts&#125;", backoff = @Backoff(delayExpression = "$&#123;retry.maxDelay&#125;")) void retryServiceWithExternalizedConfiguration(String sql) throws SQLException; &#125; æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥åˆ©ç”¨ SpEL è¡¨è¾¾å¼è¯»å–é…ç½®æ–‡ä»¶é‡Œé¢çš„å€¼ã€‚ å¦‚æžœä½ é‡åˆ°æ›´å¤æ‚çš„åœºæ™¯ï¼Œå¯ä»¥åˆ° GitHub ä¸­çœ‹ä¸€ä¸‹å®˜æ–¹çš„ Retryableæ–‡æ¡£ã€‚ ä¹è§‚é”+é‡è¯•æœºåˆ¶çš„æœ€ä½³å®žè·µå»ºè®®ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š 12@Retryable(value = ObjectOptimisticLockingFailureException.class, backoff = @Backoff(multiplier = 1.5, random = true)) è¿™é‡Œæ˜Žç¡®æŒ‡å®š ObjectOptimisticLockingFailureException.class ç­‰ä¹è§‚é”å¼‚å¸¸è¦è¿›è¡Œé‡è¯•ï¼Œå¦‚æžœå¼•èµ·å…¶ä»–å¼‚å¸¸çš„è¯ï¼Œé‡è¯•ä¹Ÿä¼šå¤±è´¥ï¼Œæ²¡æœ‰æ„ä¹‰ï¼›è€Œ backoff é‡‡ç”¨éšæœº +1.5 å€çš„ç³»æ•°ï¼Œè¿™æ ·åŸºæœ¬å¾ˆå°‘ä¼šå‡ºçŽ°è¿žç»­ 3 æ¬¡ä¹è§‚é”å¼‚å¸¸çš„æƒ…å†µï¼Œå¹¶ä¸”ä¹Ÿå¾ˆéš¾å‘ç”Ÿé‡è¯•é£Žæš´è€Œå¼•èµ·ç³»ç»Ÿé‡è¯•å´©æºƒçš„é—®é¢˜ã€‚ æ‚²è§‚é”çš„ç±»åž‹æ€Žä¹ˆå®žçŽ°ï¼Ÿ(ä¸æŽ¨èä½¿ç”¨)Java Persistence API 2.0 åè®®é‡Œé¢æœ‰ä¸€ä¸ª LockModeType æžšä¸¾å€¼ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰å®ƒæ”¯æŒçš„ä¹è§‚é”å’Œæ‚²è§‚é”çš„å€¼ã€‚ 12345678910111213141516171819public enum LockModeType&#123; //ç­‰åŒäºŽOPTIMISTICï¼Œé»˜è®¤ï¼Œç”¨æ¥å…¼å®¹2.0ä¹‹å‰çš„åè®® READ, //ç­‰åŒäºŽOPTIMISTIC_FORCE_INCREMENTï¼Œç”¨æ¥å…¼å®¹2.0ä¹‹å‰çš„åè®® WRITE, //ä¹è§‚é”ï¼Œé»˜è®¤ï¼Œ2.0åè®®æ–°å¢ž OPTIMISTIC, //ä¹è§‚å†™é”ï¼Œå¼ºåˆ¶versionåŠ 1ï¼Œ2.0åè®®æ–°å¢ž OPTIMISTIC_FORCE_INCREMENT, //æ‚²è§‚è¯»é” 2.0åè®®æ–°å¢ž PESSIMISTIC_READ, //æ‚²è§‚å†™é”ï¼Œversionä¸å˜ï¼Œ2.0åè®®æ–°å¢ž PESSIMISTIC_WRITE, //æ‚²è§‚å†™é”ï¼Œversionä¼šæ–°å¢žï¼Œ2.0åè®®æ–°å¢ž PESSIMISTIC_FORCE_INCREMENT, //2.0åè®®æ–°å¢žæ— é”çŠ¶æ€ NONE&#125; åªéœ€è¦åœ¨è‡ªå·±çš„ Repository é‡Œé¢è¦†ç›–çˆ¶ç±»çš„ Repository æ–¹æ³•ï¼Œç„¶åŽæ·»åŠ  @Lock æ³¨è§£å¹¶æŒ‡å®š LockModeType å³å¯æ”¯æŒæ‚²è§‚é”ï¼Œè¯·çœ‹å¦‚ä¸‹ä»£ç ï¼š 1234public interface UserInfoRepository extends JpaRepository&lt;UserInfo, Long&gt; &#123; @Lock(LockModeType.PESSIMISTIC_WRITE) Optional&lt;UserInfo&gt; findById(Long userId);&#125; UserInfoRepository é‡Œé¢è¦†ç›–äº†çˆ¶ç±»çš„ findById æ–¹æ³•ï¼Œå¹¶æŒ‡å®šé”çš„ç±»åž‹ä¸ºæ‚²è§‚é”ã€‚å¦‚æžœå°† service æ”¹è°ƒç”¨ä¸ºæ‚²è§‚é”çš„æ–¹æ³•ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç„¶åŽå†æ‰§è¡Œä¸Šé¢æµ‹è¯•ä¸­ testRetryable çš„æ–¹æ³•ï¼Œè·‘å®Œæµ‹è¯•ç”¨ä¾‹çš„ç»“æžœä¾ç„¶æ˜¯é€šè¿‡çš„ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ—¥å¿—ã€‚ åˆšæ‰çš„ä¸²è¡Œæ“ä½œå®Œå…¨å˜æˆäº†å¹¶è¡Œæ“ä½œã€‚æ‰€ä»¥å°‘äº†ä¸€æ¬¡ Retry çš„è¿‡ç¨‹ï¼Œç»“æžœè¿˜æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­è¦æ…Žç”¨æ‚²è§‚é”ï¼Œå› ä¸ºå®ƒæ˜¯é˜»å¡žçš„ï¼Œä¸€æ—¦å‘ç”ŸæœåŠ¡å¼‚å¸¸ï¼Œå¯èƒ½ä¼šé€ æˆæ­»é”çš„çŽ°è±¡ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>ä¹è§‚é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JavaScript forå¾ªçŽ¯å†™æ³•]]></title>
    <url>%2F2020%2F11%2F10%2FJavaScript%20for%E5%BE%AA%E7%8E%AF%E5%86%99%E6%B3%95%2F</url>
    <content type="text"><![CDATA[JavaScript forå¾ªçŽ¯å†™æ³•ç®€å• for å¾ªçŽ¯ä¸‹é¢å…ˆæ¥çœ‹çœ‹å¤§å®¶æœ€å¸¸è§çš„ä¸€ç§å†™æ³•ï¼š 1234const arr = [1, 2, 3];for(let i = 0; i &lt; arr.length; i++) &#123; console.log(arr[i]);&#125; å½“æ•°ç»„é•¿åº¦åœ¨å¾ªçŽ¯è¿‡ç¨‹ä¸­ä¸ä¼šæ”¹å˜æ—¶ï¼Œæˆ‘ä»¬åº”å°†æ•°ç»„é•¿åº¦ç”¨å˜é‡å­˜å‚¨èµ·æ¥ï¼Œè¿™æ ·ä¼šèŽ·å¾—æ›´å¥½çš„æ•ˆçŽ‡ï¼Œä¸‹é¢æ˜¯æ”¹è¿›çš„å†™æ³•ï¼š 1234const arr = [1, 2, 3];for(let i = 0, len = arr.length; i &lt; len; i++) &#123; console.log(arr[i]);&#125; for-iné€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ for-in æ¥éåŽ†ä¸€éæ•°ç»„çš„å†…å®¹ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345const arr = [1, 2, 3];let index;for(index in arr) &#123; console.log("arr[" + index + "] = " + arr[index]);&#125; ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿è¡Œç»“æžœå¦‚ä¸‹ï¼š 123arr[0] = 1arr[1] = 2arr[2] = 3 ä½†è¿™ä¹ˆåšå¾€å¾€ä¼šå‡ºçŽ°é—®é¢˜ã€‚ for-in çš„çœŸç›¸ for-in å¾ªçŽ¯éåŽ†çš„æ˜¯å¯¹è±¡çš„å±žæ€§ï¼Œè€Œä¸æ˜¯æ•°ç»„çš„ç´¢å¼•ã€‚å› æ­¤ï¼Œ for-in éåŽ†çš„å¯¹è±¡ä¾¿ä¸å±€é™äºŽæ•°ç»„ï¼Œè¿˜å¯ä»¥éåŽ†å¯¹è±¡ã€‚ä¾‹å­å¦‚ä¸‹ï¼š 123456789const person = &#123; fname: "san", lname: "zhang", age: 99&#125;;let info;for(info in person) &#123; console.log("person[" + info + "] = " + person[info]);&#125; ç»“æžœå¦‚ä¸‹ï¼š 123person[fname] = sanperson[lname] = zhangperson[age] = 99 éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ for-in éåŽ†å±žæ€§çš„é¡ºåºå¹¶ä¸ç¡®å®šï¼Œå³è¾“å‡ºçš„ç»“æžœé¡ºåºä¸Žå±žæ€§åœ¨å¯¹è±¡ä¸­çš„é¡ºåºæ— å…³ï¼Œä¹Ÿä¸Žå±žæ€§çš„å­—æ¯é¡ºåºæ— å…³ï¼Œä¸Žå…¶ä»–ä»»ä½•é¡ºåºä¹Ÿæ— å…³ã€‚ Array çš„çœŸç›¸ Array åœ¨ JavaScript ä¸­æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ Array çš„ç´¢å¼•æ˜¯å±žæ€§åã€‚äº‹å®žä¸Šï¼Œ JavaScript ä¸­çš„ â€œarrayâ€ æœ‰äº›è¯¯å¯¼æ€§ï¼Œ JavaScript ä¸­çš„ Array å¹¶ä¸åƒå¤§éƒ¨åˆ†å…¶ä»–è¯­è¨€çš„æ•°ç»„ã€‚é¦–å…ˆï¼Œ JavaScript ä¸­çš„ Array åœ¨å†…å­˜ä¸Šå¹¶ä¸è¿žç»­ï¼Œå…¶æ¬¡ï¼Œ Array çš„ç´¢å¼•å¹¶ä¸æ˜¯æŒ‡åç§»é‡ã€‚å®žé™…ä¸Šï¼Œ Array çš„ç´¢å¼•ä¹Ÿä¸æ˜¯ Number ç±»åž‹ï¼Œè€Œæ˜¯ String ç±»åž‹çš„ã€‚æˆ‘ä»¬å¯ä»¥æ­£ç¡®ä½¿ç”¨å¦‚ arr[0] çš„å†™æ³•çš„åŽŸå› æ˜¯è¯­è¨€å¯ä»¥è‡ªåŠ¨å°† Number ç±»åž‹çš„ 0 è½¬æ¢æˆ String ç±»åž‹çš„ â€œ0â€³ ã€‚æ‰€ä»¥ï¼Œåœ¨ JavaScript ä¸­ä»Žæ¥å°±æ²¡æœ‰ Array çš„ç´¢å¼•ï¼Œè€Œåªæœ‰ç±»ä¼¼ â€œ0â€³ ã€ â€œ1â€³ ç­‰ç­‰çš„å±žæ€§ã€‚æœ‰è¶£çš„æ˜¯ï¼Œæ¯ä¸ª Array å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª length çš„å±žæ€§ï¼Œå¯¼è‡´å…¶è¡¨çŽ°åœ°æ›´åƒå…¶ä»–è¯­è¨€çš„æ•°ç»„ã€‚ä½†ä¸ºä»€ä¹ˆåœ¨éåŽ† Array å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰è¾“å‡º length è¿™ä¸€æ¡å±žæ€§å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º for-in åªèƒ½éåŽ†â€œå¯æžšä¸¾çš„å±žæ€§â€ï¼Œ length å±žäºŽä¸å¯æžšä¸¾å±žæ€§ï¼Œå®žé™…ä¸Šï¼Œ Array å¯¹è±¡è¿˜æœ‰è®¸å¤šå…¶ä»–ä¸å¯æžšä¸¾çš„å±žæ€§ã€‚ çŽ°åœ¨ï¼Œæˆ‘ä»¬å†å›žè¿‡å¤´æ¥çœ‹çœ‹ç”¨ for-in æ¥å¾ªçŽ¯æ•°ç»„çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å‰é¢éåŽ†æ•°ç»„çš„ä¾‹å­ï¼š 123456const arr = [1, 2, 3];arr.name = "Hello world";let index;for(index in arr) &#123; console.log("arr[" + index + "] = " + arr[index]);&#125; è¿è¡Œç»“æžœæ˜¯ï¼š 1234arr[0] = 1arr[1] = 2arr[2] = 3arr[name] = Hello world æˆ‘ä»¬çœ‹åˆ° for-in å¾ªçŽ¯è®¿é—®äº†æˆ‘ä»¬æ–°å¢žçš„ â€œnameâ€ å±žæ€§ï¼Œå› ä¸º for-in éåŽ†äº†å¯¹è±¡çš„æ‰€æœ‰å±žæ€§ï¼Œè€Œä¸ä»…ä»…æ˜¯â€œç´¢å¼•â€ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„è¾“å‡ºçš„ç´¢å¼•å€¼ï¼Œå³ â€œ0â€³ã€ â€œ1â€³ã€ â€œ2â€³ä¸æ˜¯ Number ç±»åž‹çš„ï¼Œè€Œæ˜¯ String ç±»åž‹çš„ï¼Œå› ä¸ºå…¶å°±æ˜¯ä½œä¸ºå±žæ€§è¾“å‡ºï¼Œè€Œä¸æ˜¯ç´¢å¼•ã€‚é‚£æ˜¯ä¸æ˜¯è¯´ä¸åœ¨æˆ‘ä»¬çš„ Array å¯¹è±¡ä¸­æ·»åŠ æ–°çš„å±žæ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥åªè¾“å‡ºæ•°ç»„ä¸­çš„å†…å®¹äº†å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å› ä¸º for-in ä¸ä»…ä»…éåŽ† array è‡ªèº«çš„å±žæ€§ï¼Œå…¶è¿˜éåŽ† array åŽŸåž‹é“¾ä¸Šçš„æ‰€æœ‰å¯æžšä¸¾çš„å±žæ€§ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼š 1234567Array.prototype.fatherName = "Father";const arr = [1, 2, 3];arr.name = "Hello world";let index;for(index in arr) &#123; console.log("arr[" + index + "] = " + arr[index]);&#125; è¿è¡Œç»“æžœæ˜¯ï¼š 12345arr[0] = 1arr[1] = 2arr[2] = 3arr[name] = Hello worldarr[fatherName] = Father å†™åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘çŽ° for-in å¹¶ä¸é€‚åˆç”¨æ¥éåŽ† Array ä¸­çš„å…ƒç´ ï¼Œå…¶æ›´é€‚åˆéåŽ†å¯¹è±¡ä¸­çš„å±žæ€§ï¼Œè¿™ä¹Ÿæ˜¯å…¶è¢«åˆ›é€ å‡ºæ¥çš„åˆè¡·ã€‚å´æœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå°±æ˜¯ç¨€ç–æ•°ç»„ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š 12345678910111213let key;const arr = [];arr[0] = "a";arr[100] = "b";arr[10000] = "c";for(key in arr) &#123; if(arr.hasOwnProperty(key) &amp;&amp; /^0$|^[1-9]\d*$/.test(key) &amp;&amp; key &lt;= 4294967294 ) &#123; console.log(arr[key]); &#125;&#125; for-in åªä¼šéåŽ†å­˜åœ¨çš„å®žä½“ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ for-in éåŽ†äº†3æ¬¡ï¼ˆéåŽ†å±žæ€§åˆ†åˆ«ä¸ºâ€0â€³ã€ â€œ100â€³ã€ â€œ10000â€³çš„å…ƒç´ ï¼Œæ™®é€š for å¾ªçŽ¯åˆ™ä¼šéåŽ† 10001 æ¬¡ï¼‰ã€‚æ‰€ä»¥ï¼Œåªè¦å¤„ç†å¾—å½“ï¼Œ for-in åœ¨éåŽ† Array ä¸­å…ƒç´ ä¹Ÿèƒ½å‘æŒ¥å·¨å¤§ä½œç”¨ã€‚ ä¸ºäº†é¿å…é‡å¤åŠ³åŠ¨ï¼Œæˆ‘ä»¬å¯ä»¥åŒ…è£…ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š 12345function arrayHasOwnIndex(array, prop) &#123; return array.hasOwnProperty(prop) &amp;&amp; /^0$|^[1-9]\d*$/.test(prop) &amp;&amp; prop &lt;= 4294967294; // 2^32 - 2&#125; ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š 12345for (let key in arr) &#123; if (arrayHasOwnIndex(arr, key)) &#123; console.log(arr[key]); &#125;&#125; for-in æ€§èƒ½ æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œæ¯æ¬¡è¿­ä»£æ“ä½œä¼šåŒæ—¶æœç´¢å®žä¾‹æˆ–è€…åŽŸåž‹å±žæ€§ï¼Œ for-in å¾ªçŽ¯çš„æ¯æ¬¡è¿­ä»£éƒ½ä¼šäº§ç”Ÿæ›´å¤šå¼€é”€ï¼Œå› æ­¤è¦æ¯”å…¶ä»–å¾ªçŽ¯ç±»åž‹æ…¢ï¼Œä¸€èˆ¬é€Ÿåº¦ä¸ºå…¶ä»–ç±»åž‹å¾ªçŽ¯çš„ 1/7ã€‚å› æ­¤ï¼Œé™¤éžæ˜Žç¡®éœ€è¦è¿­ä»£ä¸€ä¸ªå±žæ€§æ•°é‡æœªçŸ¥çš„å¯¹è±¡ï¼Œå¦åˆ™åº”é¿å…ä½¿ç”¨ for-in å¾ªçŽ¯ã€‚å¦‚æžœéœ€è¦éåŽ†ä¸€ä¸ªæ•°é‡æœ‰é™çš„å·²çŸ¥å±žæ€§åˆ—è¡¨ï¼Œä½¿ç”¨å…¶ä»–å¾ªçŽ¯ä¼šæ›´å¿«ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š 123456789const obj = &#123; "prop1": "value1", "prop2": "value2"&#125;;const props = ["prop1", "prop2"];for(let i = 0; i &lt; props.length; i++) &#123; console.log(obj[props[i]]);&#125; ä¸Šé¢ä»£ç ä¸­ï¼Œå°†å¯¹è±¡çš„å±žæ€§éƒ½å­˜å…¥ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç›¸å¯¹äºŽ for-in æŸ¥æ‰¾æ¯ä¸€ä¸ªå±žæ€§ï¼Œè¯¥ä»£ç åªå…³æ³¨ç»™å®šçš„å±žæ€§ï¼ŒèŠ‚çœäº†å¾ªçŽ¯çš„å¼€é”€å’Œæ—¶é—´ã€‚ forEachåœ¨ ES5 ä¸­ï¼Œå¼•å…¥äº†æ–°çš„å¾ªçŽ¯ï¼Œå³ forEach å¾ªçŽ¯ã€‚ 1234const arr = [1, 2, 3];arr.forEach((data) =&gt; &#123; console.log(data);&#125;); è¿è¡Œç»“æžœï¼š 123123 forEach æ–¹æ³•ä¸ºæ•°ç»„ä¸­å«æœ‰æœ‰æ•ˆå€¼çš„æ¯ä¸€é¡¹æ‰§è¡Œä¸€æ¬¡ callback å‡½æ•°ï¼Œé‚£äº›å·²åˆ é™¤ï¼ˆä½¿ç”¨ delete æ–¹æ³•ç­‰æƒ…å†µï¼‰æˆ–è€…ä»Žæœªèµ‹å€¼çš„é¡¹å°†è¢«è·³è¿‡ï¼ˆä¸åŒ…æ‹¬é‚£äº›å€¼ä¸º undefined æˆ– null çš„é¡¹ï¼‰ã€‚ callback å‡½æ•°ä¼šè¢«ä¾æ¬¡ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š æ•°ç»„å½“å‰é¡¹çš„å€¼ï¼› æ•°ç»„å½“å‰é¡¹çš„ç´¢å¼•ï¼› æ•°ç»„å¯¹è±¡æœ¬èº«ï¼› éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒforEach éåŽ†çš„èŒƒå›´åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ callback å‰å°±ä¼šç¡®å®šã€‚è°ƒç”¨forEach åŽæ·»åŠ åˆ°æ•°ç»„ä¸­çš„é¡¹ä¸ä¼šè¢« callback è®¿é—®åˆ°ã€‚å¦‚æžœå·²ç»å­˜åœ¨çš„å€¼è¢«æ”¹å˜ï¼Œåˆ™ä¼ é€’ç»™ callback çš„å€¼æ˜¯ forEach éåŽ†åˆ°ä»–ä»¬é‚£ä¸€åˆ»çš„å€¼ã€‚å·²åˆ é™¤çš„é¡¹ä¸ä¼šè¢«éåŽ†åˆ°ã€‚ 12345678const arr = [];arr[0] = "a";arr[3] = "b";arr[10] = "c";arr.name = "Hello world";arr.forEach((data, index, array) =&gt; &#123; console.log(data, index, array);&#125;); è¿è¡Œç»“æžœï¼š 123a 0 ["a", 3: "b", 10: "c", name: "Hello world"]b 3 ["a", 3: "b", 10: "c", name: "Hello world"]c 10 ["a", 3: "b", 10: "c", name: "Hello world"] è¿™é‡Œçš„ index æ˜¯ Number ç±»åž‹ï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šåƒ for-in ä¸€æ ·éåŽ†åŽŸåž‹é“¾ä¸Šçš„å±žæ€§ã€‚ æ‰€ä»¥ï¼Œä½¿ç”¨ forEach æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸“é—¨åœ°å£°æ˜Ž index å’ŒéåŽ†çš„å…ƒç´ ï¼Œå› ä¸ºè¿™äº›éƒ½ä½œä¸ºå›žè°ƒå‡½æ•°çš„å‚æ•°ã€‚ å¦å¤–ï¼ŒforEach å°†ä¼šéåŽ†æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œä½†æ˜¯ ES5 å®šä¹‰äº†ä¸€äº›å…¶ä»–æœ‰ç”¨çš„æ–¹æ³•ï¼Œä¸‹é¢æ˜¯ä¸€éƒ¨åˆ†ï¼š every: å¾ªçŽ¯åœ¨ç¬¬ä¸€æ¬¡ return false åŽè¿”å›ž some: å¾ªçŽ¯åœ¨ç¬¬ä¸€æ¬¡ return true åŽè¿”å›ž filter: è¿”å›žä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œè¯¥æ•°ç»„å†…çš„å…ƒç´ æ»¡è¶³å›žè°ƒå‡½æ•° map: å°†åŽŸæ•°ç»„ä¸­çš„å…ƒç´ å¤„ç†åŽå†è¿”å›ž reduce: å¯¹æ•°ç»„ä¸­çš„å…ƒç´ ä¾æ¬¡å¤„ç†ï¼Œå°†ä¸Šæ¬¡å¤„ç†ç»“æžœä½œä¸ºä¸‹æ¬¡å¤„ç†çš„è¾“å…¥ï¼Œæœ€åŽå¾—åˆ°æœ€ç»ˆç»“æžœã€‚ forEach æ€§èƒ½ åœ¨ä¸åŒæµè§ˆå™¨ä¸‹æµ‹è¯•çš„ç»“æžœéƒ½æ˜¯ forEach çš„é€Ÿåº¦ä¸å¦‚ forã€‚å¦‚æžœå¤§å®¶æŠŠæµ‹è¯•ä»£ç æ”¾åœ¨æŽ§åˆ¶å°çš„è¯ï¼Œå¯èƒ½ä¼šå¾—åˆ°ä¸ä¸€æ ·çš„ç»“æžœï¼Œä¸»è¦åŽŸå› æ˜¯æŽ§åˆ¶å°çš„æ‰§è¡ŒçŽ¯å¢ƒä¸ŽçœŸå®žçš„ä»£ç æ‰§è¡ŒçŽ¯å¢ƒæœ‰æ‰€åŒºåˆ«ã€‚ for-ofå…ˆæ¥çœ‹ä¸ªä¾‹å­ï¼š 1234const arr = ['a', 'b', 'c'];for(let data of arr) &#123; console.log(data);&#125; è¿è¡Œç»“æžœæ˜¯ï¼š 123abc ä¸ºä»€ä¹ˆè¦å¼•è¿› for-ofï¼Ÿ è¦å›žç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ES6ä¹‹å‰çš„ 3 ç§ for å¾ªçŽ¯æœ‰ä»€ä¹ˆç¼ºé™·ï¼š forEach ä¸èƒ½ break å’Œ returnï¼› for-in ç¼ºç‚¹æ›´åŠ æ˜Žæ˜¾ï¼Œå®ƒä¸ä»…éåŽ†æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œè¿˜ä¼šéåŽ†è‡ªå®šä¹‰çš„å±žæ€§ï¼Œç”šè‡³åŽŸåž‹é“¾ä¸Šçš„å±žæ€§éƒ½è¢«è®¿é—®åˆ°ã€‚è€Œä¸”ï¼ŒéåŽ†æ•°ç»„å…ƒç´ çš„é¡ºåºå¯èƒ½æ˜¯éšæœºçš„ã€‚ æ‰€ä»¥ï¼Œé‰´äºŽä»¥ä¸Šç§ç§ç¼ºé™·ï¼Œæˆ‘ä»¬éœ€è¦æ”¹è¿›åŽŸå…ˆçš„ for å¾ªçŽ¯ã€‚ä½† ES6 ä¸ä¼šç ´åä½ å·²ç»å†™å¥½çš„ JS ä»£ç ã€‚ç›®å‰ï¼Œæˆåƒä¸Šä¸‡çš„ Web ç½‘ç«™ä¾èµ– for-in å¾ªçŽ¯ï¼Œå…¶ä¸­ä¸€äº›ç½‘ç«™ç”šè‡³å°†å…¶ç”¨äºŽæ•°ç»„éåŽ†ã€‚å¦‚æžœæƒ³é€šè¿‡ä¿®æ­£ for-in å¾ªçŽ¯å¢žåŠ æ•°ç»„éåŽ†æ”¯æŒä¼šè®©è¿™ä¸€åˆ‡å˜å¾—æ›´åŠ æ··ä¹±ï¼Œå› æ­¤ï¼Œæ ‡å‡†å§”å‘˜ä¼šåœ¨ ES6 ä¸­å¢žåŠ äº†ä¸€ç§æ–°çš„å¾ªçŽ¯è¯­æ³•æ¥è§£å†³ç›®å‰çš„é—®é¢˜ï¼Œå³ for-of ã€‚ é‚£ for-of åˆ°åº•å¯ä»¥å¹²ä»€ä¹ˆå‘¢ï¼Ÿ è·Ÿ forEach ç›¸æ¯”ï¼Œå¯ä»¥æ­£ç¡®å“åº” break, continue, returnã€‚ for-of å¾ªçŽ¯ä¸ä»…æ”¯æŒæ•°ç»„ï¼Œè¿˜æ”¯æŒå¤§å¤šæ•°ç±»æ•°ç»„å¯¹è±¡ï¼Œä¾‹å¦‚ DOM nodelist å¯¹è±¡ã€‚ for-of å¾ªçŽ¯ä¹Ÿæ”¯æŒå­—ç¬¦ä¸²éåŽ†ï¼Œå®ƒå°†å­—ç¬¦ä¸²è§†ä¸ºä¸€ç³»åˆ— Unicode å­—ç¬¦æ¥è¿›è¡ŒéåŽ†ã€‚ for-of ä¹Ÿæ”¯æŒ Map å’Œ Set ï¼ˆä¸¤è€…å‡ä¸º ES6 ä¸­æ–°å¢žçš„ç±»åž‹ï¼‰å¯¹è±¡éåŽ†ã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œfor-of å¾ªçŽ¯æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š è¿™æ˜¯æœ€ç®€æ´ã€æœ€ç›´æŽ¥çš„éåŽ†æ•°ç»„å…ƒç´ çš„è¯­æ³•ã€‚ è¿™ä¸ªæ–¹æ³•é¿å¼€äº† for-in å¾ªçŽ¯çš„æ‰€æœ‰ç¼ºé™·ã€‚ ä¸Ž forEach ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥æ­£ç¡®å“åº” breakã€continue å’Œ return è¯­å¥ã€‚ å…¶ä¸ä»…å¯ä»¥éåŽ†æ•°ç»„ï¼Œè¿˜å¯ä»¥éåŽ†ç±»æ•°ç»„å¯¹è±¡å’Œå…¶ä»–å¯è¿­ä»£å¯¹è±¡ã€‚ ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfor-ofå¾ªçŽ¯ä¸æ”¯æŒæ™®é€šå¯¹è±¡ï¼Œä½†å¦‚æžœä½ æƒ³è¿­ä»£ä¸€ä¸ªå¯¹è±¡çš„å±žæ€§ï¼Œä½ å¯ä»¥ç”¨ for-in å¾ªçŽ¯ï¼ˆè¿™ä¹Ÿæ˜¯å®ƒçš„æœ¬èŒå·¥ä½œï¼‰ã€‚ æœ€åŽè¦è¯´çš„æ˜¯ï¼ŒES6 å¼•è¿›çš„å¦ä¸€ä¸ªæ–¹å¼ä¹Ÿèƒ½å®žçŽ°éåŽ†æ•°ç»„çš„å€¼ï¼Œé‚£å°±æ˜¯ Iteratorã€‚ä¸Šä¸ªä¾‹å­ï¼š 1234567const arr = ['a', 'b', 'c'];const iter = arr[Symbol.iterator]();iter.next() // &#123; value: 'a', done: false &#125;iter.next() // &#123; value: 'b', done: false &#125;iter.next() // &#123; value: 'c', done: false &#125;iter.next() // &#123; value: undefined, done: true &#125;]]></content>
      <categories>
        <category>å‰ç«¯</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ECMAScript]]></title>
    <url>%2F2020%2F11%2F09%2FECMAScript%2F</url>
    <content type="text"><![CDATA[ECMAScript ES å…¨ç§° ECMAScriptï¼ŒECMAScript æ˜¯ ECMA åˆ¶å®šçš„æ ‡å‡†åŒ–è„šæœ¬è¯­è¨€ ES6æ–°ç‰¹æ€§ï¼ˆ2015ï¼‰ES6ä¸­çš„ç‰¹æ€§æ¯”è¾ƒå¤šã€‚ åˆ—ä¸¾å‡ ä¸ªå¸¸ç”¨çš„ï¼š ç±» æ¨¡å—åŒ– ç®­å¤´å‡½æ•° å‡½æ•°å‚æ•°é»˜è®¤å€¼ æ¨¡æ¿å­—ç¬¦ä¸² è§£æž„èµ‹å€¼ å»¶å±•æ“ä½œç¬¦ å¯¹è±¡å±žæ€§ç®€å†™ Promise Let ä¸Ž Const ç±»ï¼ˆclassï¼‰1234567891011121314151617181920212223242526272829303132333435class Animal &#123; // æž„é€ å‡½æ•°ï¼Œå®žä¾‹åŒ–çš„æ—¶å€™å°†ä¼šè¢«è°ƒç”¨ï¼Œå¦‚æžœä¸æŒ‡å®šï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªä¸å¸¦å‚æ•°çš„é»˜è®¤æž„é€ å‡½æ•°. constructor(name, color) &#123; this.name = name; this.color = color; &#125; // toString æ˜¯åŽŸåž‹å¯¹è±¡ä¸Šçš„å±žæ€§ toString() &#123; console.log('name:' + this.name + ',color:' + this.color); &#125; &#125;var animal = new Animal('dog','white'); //å®žä¾‹åŒ– Animalanimal.toString();console.log(animal.hasOwnProperty('name')); // trueconsole.log(animal.hasOwnProperty('toString')); // falseconsole.log(animal.__proto__.hasOwnProperty('toString')); // trueclass Cat extends Animal &#123; constructor(action) &#123; // å­ç±»å¿…é¡»è¦åœ¨constructorä¸­æŒ‡å®š super å‡½æ•°ï¼Œå¦åˆ™åœ¨æ–°å»ºå®žä¾‹çš„æ—¶å€™ä¼šæŠ¥é”™. // å¦‚æžœæ²¡æœ‰ç½®é¡¶consructor, é»˜è®¤å¸¦superå‡½æ•°çš„constructorå°†ä¼šè¢«æ·»åŠ  super('cat','white'); this.action = action; &#125; toString() &#123; console.log(super.toString()); &#125;&#125;var cat = new Cat('catch')cat.toString();// å®žä¾‹cat æ˜¯ Cat å’Œ Animal çš„å®žä¾‹ï¼Œå’Œ Es5 å®Œå…¨ä¸€è‡´ã€‚console.log(cat instanceof Cat); // trueconsole.log(cat instanceof Animal); // true æ¨¡å—åŒ–(Module)ES5 ä¸æ”¯æŒåŽŸç”Ÿçš„æ¨¡å—åŒ–ï¼Œåœ¨ ES6 ä¸­æ¨¡å—ä½œä¸ºé‡è¦çš„ç»„æˆéƒ¨åˆ†è¢«æ·»åŠ è¿›æ¥ã€‚æ¨¡å—çš„åŠŸèƒ½ä¸»è¦ç”± export å’Œ import ç»„æˆã€‚æ¯ä¸€ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±å•ç‹¬çš„ä½œç”¨åŸŸï¼Œæ¨¡å—ä¹‹é—´çš„ç›¸äº’è°ƒç”¨å…³ç³»æ˜¯é€šè¿‡ export æ¥è§„å®šæ¨¡å—å¯¹å¤–æš´éœ²çš„æŽ¥å£ï¼Œé€šè¿‡ import æ¥å¼•ç”¨å…¶å®ƒæ¨¡å—æä¾›çš„æŽ¥å£ã€‚åŒæ—¶è¿˜ä¸ºæ¨¡å—åˆ›é€ äº†å‘½åç©ºé—´ï¼Œé˜²æ­¢å‡½æ•°çš„å‘½åå†²çªã€‚ å¯¼å‡º(export)ES6 å…è®¸åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ä½¿ç”¨ export æ¥å¯¼å‡ºå¤šä¸ªå˜é‡æˆ–å‡½æ•°ã€‚ å¯¼å‡ºå˜é‡12//test.jsexport var name = 'Rainbow' ES6ä¸ä»…æ”¯æŒå˜é‡çš„å¯¼å‡ºï¼Œä¹Ÿæ”¯æŒå¸¸é‡çš„å¯¼å‡ºã€‚ export const sqrt = Math.sqrt // å¯¼å‡ºå¸¸é‡ ES6 å°†ä¸€ä¸ªæ–‡ä»¶è§†ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œä¸Šé¢çš„æ¨¡å—é€šè¿‡ export å‘å¤–è¾“å‡ºäº†ä¸€ä¸ªå˜é‡ã€‚ä¸€ä¸ªæ¨¡å—ä¹Ÿå¯ä»¥åŒæ—¶å¾€å¤–é¢è¾“å‡ºå¤šä¸ªå˜é‡ã€‚ 1234//test.js var name = 'Rainbow'; var age = '24'; export &#123;name, age&#125;; å¯¼å‡ºå‡½æ•°1234// myModule.jsexport function myModule(someArg) &#123; return someArg;&#125; å¯¼å…¥(import)å®šä¹‰å¥½æ¨¡å—çš„è¾“å‡ºä»¥åŽå°±å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ªæ¨¡å—é€šè¿‡ import å¼•ç”¨ã€‚ 12import &#123;myModule&#125; from 'myModule' // main.jsimport &#123;name,age&#125; from 'test' // test.js ä¸€æ¡ import è¯­å¥å¯ä»¥åŒæ—¶å¯¼å…¥é»˜è®¤å‡½æ•°å’Œå…¶å®ƒå˜é‡ã€‚import defaultMethod, { otherMethod } from &#39;xxx.js&#39; ç®­å¤´ï¼ˆArrowï¼‰å‡½æ•°=&gt;ä¸åªæ˜¯å…³é”®å­— function çš„ç®€å†™ï¼Œå®ƒè¿˜å¸¦æ¥äº†å…¶å®ƒå¥½å¤„ã€‚ç®­å¤´å‡½æ•°ä¸ŽåŒ…å›´å®ƒçš„ä»£ç å…±äº«åŒä¸€ä¸ªthisï¼Œèƒ½å¸®ä½ å¾ˆå¥½çš„è§£å†³ this çš„æŒ‡å‘é—®é¢˜ã€‚æœ‰ç»éªŒçš„ JavaScript å¼€å‘è€…éƒ½ç†Ÿæ‚‰è¯¸å¦‚var self = thisæˆ–var that = thisè¿™ç§å¼•ç”¨å¤–å›´ this çš„æ¨¡å¼ã€‚ä½†å€ŸåŠ©=&gt;ï¼Œå°±ä¸éœ€è¦è¿™ç§æ¨¡å¼äº†ã€‚ ç®­å¤´å‡½æ•°çš„ç»“æž„ç®­å¤´å‡½æ•°çš„ç®­å¤´=&gt;ä¹‹å‰æ˜¯ä¸€ä¸ªç©ºæ‹¬å·ã€å•ä¸ªçš„å‚æ•°åã€æˆ–ç”¨æ‹¬å·æ‹¬èµ·çš„å¤šä¸ªå‚æ•°åï¼Œè€Œç®­å¤´ä¹‹åŽå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆä½œä¸ºå‡½æ•°çš„è¿”å›žå€¼ï¼‰ï¼Œæˆ–è€…æ˜¯ç”¨èŠ±æ‹¬å·æ‹¬èµ·çš„å‡½æ•°ä½“ï¼ˆéœ€è¦è‡ªè¡Œé€šè¿‡ return æ¥è¿”å›žå€¼ï¼Œå¦åˆ™è¿”å›žçš„æ˜¯ undefinedï¼‰ã€‚ 12345678910111213// ç®­å¤´å‡½æ•°çš„ä¾‹å­()=&gt;1v=&gt;v+1(a,b)=&gt;a+b()=&gt;&#123; alert("foo");&#125;e=&gt;&#123; if (e == 0)&#123; return 0; &#125; return 1000/e;&#125; ä¸è®ºæ˜¯ç®­å¤´å‡½æ•°è¿˜æ˜¯ bindï¼Œæ¯æ¬¡è¢«æ‰§è¡Œéƒ½è¿”å›žçš„æ˜¯ä¸€ä¸ªæ–°çš„å‡½æ•°å¼•ç”¨ï¼Œå› æ­¤å¦‚æžœä½ è¿˜éœ€è¦å‡½æ•°çš„å¼•ç”¨åŽ»åšä¸€äº›åˆ«çš„äº‹æƒ…ï¼ˆè­¬å¦‚å¸è½½ç›‘å¬å™¨ï¼‰ï¼Œé‚£ä¹ˆä½ å¿…é¡»è‡ªå·±ä¿å­˜è¿™ä¸ªå¼•ç”¨ã€‚ å¸è½½ç›‘å¬å™¨æ—¶çš„é™·é˜±é”™è¯¯çš„åšæ³• 12345678910class PauseMenu extends React.Component&#123; componentWillMount()&#123; AppStateIOS.addEventListener('change', this.onAppPaused.bind(this)); &#125; componentWillUnmount()&#123; AppStateIOS.removeEventListener('change', this.onAppPaused.bind(this)); &#125; onAppPaused(event)&#123; &#125;&#125; æ­£ç¡®çš„åšæ³• 1234567891011121314class PauseMenu extends React.Component&#123; constructor(props)&#123; super(props); this._onAppPaused = this.onAppPaused.bind(this); &#125; componentWillMount()&#123; AppStateIOS.addEventListener('change', this._onAppPaused); &#125; componentWillUnmount()&#123; AppStateIOS.removeEventListener('change', this._onAppPaused); &#125; onAppPaused(event)&#123; &#125;&#125; é™¤ä¸Šè¿°çš„åšæ³•å¤–ï¼Œè¿˜å¯ä»¥è¿™æ ·åšï¼š 1234567891011class PauseMenu extends React.Component&#123; componentWillMount()&#123; AppStateIOS.addEventListener('change', this.onAppPaused); &#125; componentWillUnmount()&#123; AppStateIOS.removeEventListener('change', this.onAppPaused); &#125; onAppPaused = (event) =&gt; &#123; //æŠŠå‡½æ•°ç›´æŽ¥ä½œä¸ºä¸€ä¸ªarrow functionçš„å±žæ€§æ¥å®šä¹‰ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å°±ç»‘å®šå¥½äº†thisæŒ‡é’ˆ &#125;&#125; å‡½æ•°å‚æ•°é»˜è®¤å€¼ES6æ”¯æŒåœ¨å®šä¹‰å‡½æ•°çš„æ—¶å€™ä¸ºå…¶è®¾ç½®é»˜è®¤å€¼ï¼š 1234function foo(height = 50, color = 'red')&#123; // ...&#125; ä¸ä½¿ç”¨é»˜è®¤å€¼ï¼š 123456function foo(height, color)&#123; var height = height || 50; var color = color || 'red'; //...&#125; è¿™æ ·å†™ä¸€èˆ¬æ²¡é—®é¢˜ï¼Œä½†å½“å‚æ•°çš„å¸ƒå°”å€¼ä¸º false æ—¶ï¼Œå°±ä¼šæœ‰é—®é¢˜äº†ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬è¿™æ ·è°ƒç”¨fooå‡½æ•°ï¼š 1foo(0, "") å› ä¸º 0 çš„å¸ƒå°”å€¼ä¸º falseï¼Œè¿™æ · height çš„å–å€¼å°†æ˜¯50ã€‚åŒç† color çš„å–å€¼ä¸º â€˜redâ€™ã€‚ æ‰€ä»¥è¯´ï¼Œå‡½æ•°å‚æ•°é»˜è®¤å€¼ä¸ä»…èƒ½æ˜¯ä»£ç å˜å¾—æ›´åŠ ç®€æ´è€Œä¸”èƒ½è§„é¿ä¸€äº›é—®é¢˜ã€‚ æ¨¡æ¿å­—ç¬¦ä¸²ES6 æ”¯æŒæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œä½¿å¾—å­—ç¬¦ä¸²çš„æ‹¼æŽ¥æ›´åŠ çš„ç®€æ´ã€ç›´è§‚ã€‚ ä¸ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ï¼š 1var name = 'Your name is ' + first + ' ' + last + '.' ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ï¼š 1var name = `Your name is $&#123;first&#125; $&#123;last&#125;.` åœ¨ ES6 ä¸­é€šè¿‡${}å°±å¯ä»¥å®Œæˆå­—ç¬¦ä¸²çš„æ‹¼æŽ¥ï¼Œåªéœ€è¦å°†å˜é‡æ”¾åœ¨å¤§æ‹¬å·ä¹‹ä¸­ã€‚ è§£æž„èµ‹å€¼è§£æž„èµ‹å€¼è¯­æ³•æ˜¯ JavaScript çš„ä¸€ç§è¡¨è¾¾å¼ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä»Žæ•°ç»„æˆ–è€…å¯¹è±¡ä¸­å¿«é€Ÿæå–å€¼èµ‹ç»™å®šä¹‰çš„å˜é‡ã€‚ èŽ·å–æ•°ç»„ä¸­çš„å€¼ä»Žæ•°ç»„ä¸­èŽ·å–å€¼å¹¶èµ‹å€¼åˆ°å˜é‡ä¸­ï¼Œå˜é‡çš„é¡ºåºä¸Žæ•°ç»„ä¸­å¯¹è±¡é¡ºåºå¯¹åº”ã€‚ 123456789101112131415161718var foo = ["one", "two", "three", "four"];var [a, b, c] = foo;console.log(a); // "one"console.log(b); // "two"console.log(c); // "three"//å¦‚æžœä½ è¦å¿½ç•¥æŸäº›å€¼ï¼Œä½ å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„å†™æ³•èŽ·å–ä½ æƒ³è¦çš„å€¼var [first, , , last] = foo;console.log(first); // "one"console.log(last); // "four"//ä½ ä¹Ÿå¯ä»¥è¿™æ ·å†™var a, b; //å…ˆå£°æ˜Žå˜é‡[a, b] = [1, 2];console.log(a); // 1console.log(b); // 2 å¦‚æžœæ²¡æœ‰ä»Žæ•°ç»„ä¸­çš„èŽ·å–åˆ°å€¼ï¼Œä½ å¯ä»¥ä¸ºå˜é‡è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ã€‚ 12345var a, b;[a=5, b=7] = [1];console.log(a); // 1console.log(b); // 7 é€šè¿‡è§£æž„èµ‹å€¼å¯ä»¥æ–¹ä¾¿çš„äº¤æ¢ä¸¤ä¸ªå˜é‡çš„å€¼ã€‚ 123456var a = 1;var b = 3;[a, b] = [b, a];console.log(a); // 3console.log(b); // 1 èŽ·å–å¯¹è±¡ä¸­çš„å€¼12345678910const student = &#123; name:'Ming', age:'18', city:'Shanghai' &#125;;const &#123;name, age, city&#125; = student;console.log(name); // "Ming"console.log(age); // "18"console.log(city); // "Shanghai" å»¶å±•æ“ä½œç¬¦( Spread operator )å»¶å±•æ“ä½œç¬¦...å¯ä»¥åœ¨å‡½æ•°è°ƒç”¨/æ•°ç»„æž„é€ æ—¶ï¼Œå°†æ•°ç»„è¡¨è¾¾å¼æˆ–è€… string åœ¨è¯­æ³•å±‚é¢å±•å¼€ï¼›è¿˜å¯ä»¥åœ¨æž„é€ å¯¹è±¡æ—¶ï¼Œå°†å¯¹è±¡è¡¨è¾¾å¼æŒ‰ key-value çš„æ–¹å¼å±•å¼€ã€‚ è¯­æ³•å‡½æ•°è°ƒç”¨ 1myFunction(...iterableObj); æ•°ç»„æž„é€ æˆ–å­—ç¬¦ä¸² 1[...iterableObj, '4', ...'hello', 6]; æž„é€ å¯¹è±¡æ—¶ï¼Œè¿›è¡Œå…‹éš†æˆ–è€…å±žæ€§æ‹·è´ï¼ˆECMAScript 2018è§„èŒƒæ–°å¢žç‰¹æ€§ï¼‰ 1let objClone = &#123; ...obj &#125;; åº”ç”¨åœºæ™¯åœ¨å‡½æ•°è°ƒç”¨æ—¶ä½¿ç”¨å»¶å±•æ“ä½œç¬¦ 12345678910function sum(x, y, z) &#123; return x + y + z;&#125;const numbers = [1, 2, 3];//ä¸ä½¿ç”¨å»¶å±•æ“ä½œç¬¦console.log(sum.apply(null, numbers));//ä½¿ç”¨å»¶å±•æ“ä½œç¬¦console.log(sum(...numbers));// 6 æž„é€ æ•°ç»„ æ²¡æœ‰å±•å¼€è¯­æ³•çš„æ—¶å€™ï¼Œåªèƒ½ç»„åˆä½¿ç”¨ pushã€spliceã€concat ç­‰æ–¹æ³•ï¼Œæ¥å°†å·²æœ‰æ•°ç»„å…ƒç´ å˜æˆæ–°æ•°ç»„çš„ä¸€éƒ¨åˆ†ã€‚æœ‰äº†å±•å¼€è¯­æ³•ï¼Œæž„é€ æ–°æ•°ç»„ä¼šå˜å¾—æ›´ç®€å•ã€æ›´ä¼˜é›…ï¼š 123const stuendts = ['Jine', 'Tom']; const persons = ['Tony', ...stuendts, 'Aaron', 'Anna'];conslog.log(persions) // ["Tony", "Jine", "Tom", "Aaron", "Anna"] å’Œå‚æ•°åˆ—è¡¨çš„å±•å¼€ç±»ä¼¼ï¼Œ... åœ¨æž„é€ å­—æ•°ç»„æ—¶ï¼Œå¯ä»¥åœ¨ä»»æ„ä½ç½®å¤šæ¬¡ä½¿ç”¨ã€‚ æ•°ç»„æ‹·è´ 1234var arr = [1, 2, 3];var arr2 = [...arr]; // ç­‰åŒäºŽ arr.slice()arr2.push(4); console.log(arr2) //[1, 2, 3, 4] å±•å¼€è¯­æ³•å’Œ Object.assign() è¡Œä¸ºä¸€è‡´, æ‰§è¡Œçš„éƒ½æ˜¯æµ…æ‹·è´(åªéåŽ†ä¸€å±‚)ã€‚ è¿žæŽ¥å¤šä¸ªæ•°ç»„ 12345var arr1 = [0, 1, 2];var arr2 = [3, 4, 5];var arr3 = [...arr1, ...arr2]; // å°† arr2 ä¸­æ‰€æœ‰å…ƒç´ é™„åŠ åˆ° arr1 åŽé¢å¹¶è¿”å›ž// ç­‰åŒäºŽvar arr4 = arr1.concat(arr2); åœ¨ECMAScript 2018ä¸­å»¶å±•æ“ä½œç¬¦å¢žåŠ äº†å¯¹å¯¹è±¡çš„æ”¯æŒ 12345678var obj1 = &#123; foo: 'bar', x: 42 &#125;;var obj2 = &#123; foo: 'baz', y: 13 &#125;;var clonedObj = &#123; ...obj1 &#125;;// å…‹éš†åŽçš„å¯¹è±¡: &#123; foo: "bar", x: 42 &#125;var mergedObj = &#123; ...obj1, ...obj2 &#125;;// åˆå¹¶åŽçš„å¯¹è±¡: &#123; foo: "baz", x: 42, y: 13 &#125; åœ¨Reactä¸­çš„åº”ç”¨é€šå¸¸æˆ‘ä»¬åœ¨å°è£…ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œä¼šå¯¹å¤–å…¬å¼€ä¸€äº› props ç”¨äºŽå®žçŽ°åŠŸèƒ½ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹åœ¨å¤–éƒ¨ä½¿ç”¨éƒ½åº”æ˜¾ç¤ºçš„ä¼ é€’ props ã€‚ä½†æ˜¯å½“ä¼ é€’å¤§é‡çš„propsæ—¶ï¼Œä¼šéžå¸¸ç¹çï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ...(å»¶å±•æ“ä½œç¬¦ï¼Œç”¨äºŽå–å‡ºå‚æ•°å¯¹è±¡çš„æ‰€æœ‰å¯éåŽ†å±žæ€§) æ¥è¿›è¡Œä¼ é€’ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åº”è¯¥è¿™æ ·å†™ï¼š 1&lt;CustomComponent name ='Jine' age =&#123;21&#125; /&gt; ä½¿ç”¨ ... ï¼Œç­‰åŒäºŽä¸Šé¢çš„å†™æ³• 12345const params = &#123; name: 'Jine', age: 21&#125;&lt;CustomComponent &#123;...params&#125; /&gt; é…åˆè§£æž„èµ‹å€¼é¿å…ä¼ å…¥ä¸€äº›ä¸éœ€è¦çš„å‚æ•° 1234567891011var params = &#123; name: '123', title: '456', type: 'aaa'&#125;var &#123; type, ...other &#125; = params;&lt;CustomComponent type='normal' number=&#123;2&#125; &#123;...other&#125; /&gt;//ç­‰åŒäºŽ&lt;CustomComponent type='normal' number=&#123;2&#125; name='123' title='456' /&gt; å¯¹è±¡å±žæ€§ç®€å†™åœ¨ES6ä¸­å…è®¸æˆ‘ä»¬åœ¨è®¾ç½®ä¸€ä¸ªå¯¹è±¡çš„å±žæ€§çš„æ—¶å€™ä¸æŒ‡å®šå±žæ€§åã€‚ ä¸ä½¿ç”¨ES6 12345678const name='Ming', age='18', city='Shanghai';const student = &#123; name:name, age:age, city:city&#125;;console.log(student); //&#123;name: "Ming", age: "18", city: "Shanghai"&#125; å¯¹è±¡ä¸­å¿…é¡»åŒ…å«å±žæ€§å’Œå€¼ï¼Œæ˜¾å¾—éžå¸¸å†—ä½™ã€‚ ä½¿ç”¨ES6 12345678const name='Ming', age='18', city='Shanghai';const student = &#123; name, age, city&#125;;console.log(student); //&#123;name: "Ming", age: "18", city: "Shanghai"&#125; å¯¹è±¡ä¸­ç›´æŽ¥å†™å˜é‡ï¼Œéžå¸¸ç®€æ´ã€‚ PromisePromise æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆcallbackæ›´åŠ çš„ä¼˜é›…ã€‚å®ƒæœ€æ—©ç”±ç¤¾åŒºæå‡ºå’Œå®žçŽ°çš„ï¼ŒES6 å°†å…¶å†™è¿›äº†è¯­è¨€æ ‡å‡†ï¼Œç»Ÿä¸€äº†ç”¨æ³•ï¼ŒåŽŸç”Ÿæä¾›äº†Promiseå¯¹è±¡ã€‚ ä¸ä½¿ç”¨ES6 åµŒå¥—ä¸¤ä¸ª setTimeout å›žè°ƒå‡½æ•°ï¼š 12345678setTimeout(function()&#123; console.log('Hello'); // 1ç§’åŽè¾“å‡º "Hello" setTimeout(function() &#123; console.log('Hi'); // 2ç§’åŽè¾“å‡º "Hi" &#125;, 1000);&#125;, 1000); ä½¿ç”¨ES6 123456789101112131415var waitSecond = new Promise(function(resolve, reject)&#123; setTimeout(resolve, 1000);&#125;);waitSecond .then(function() &#123; console.log("Hello"); // 1ç§’åŽè¾“å‡º"Hello" return waitSecond; &#125;) .then(function() &#123; console.log("Hi"); // 2ç§’åŽè¾“å‡º"Hi" &#125;); ä¸Šé¢çš„çš„ä»£ç ä½¿ç”¨ä¸¤ä¸ª then æ¥è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ä¸²è¡ŒåŒ–ï¼Œé¿å…äº†å›žè°ƒåœ°ç‹±ï¼š æ”¯æŒ let ä¸Ž conståœ¨ä¹‹å‰ JS æ˜¯æ²¡æœ‰å—çº§ä½œç”¨åŸŸçš„ï¼Œconst ä¸Ž let å¡«è¡¥äº†è¿™æ–¹ä¾¿çš„ç©ºç™½ï¼Œconst ä¸Ž let éƒ½æ˜¯å—çº§ä½œç”¨åŸŸã€‚ ä½¿ç”¨ var å®šä¹‰çš„å˜é‡ä¸ºå‡½æ•°çº§ä½œç”¨åŸŸ 12345&#123; var a = 10;&#125;console.log(a); // è¾“å‡º10 ä½¿ç”¨ let ä¸Ž const å®šä¹‰çš„å˜é‡ä¸ºå—çº§ä½œç”¨åŸŸ 12345&#123; let a = 10;&#125;console.log(a); //-1 or Errorâ€œReferenceError: a is not definedâ€ ES7æ–°ç‰¹æ€§ï¼ˆ2016ï¼‰ES2016æ·»åŠ äº†ä¸¤ä¸ªå°çš„ç‰¹æ€§æ¥è¯´æ˜Žæ ‡å‡†åŒ–è¿‡ç¨‹ï¼š æ•°ç»„ includes() æ–¹æ³•ï¼Œç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œæ ¹æ®æƒ…å†µï¼Œå¦‚æžœåŒ…å«åˆ™è¿”å›ž trueï¼Œå¦åˆ™è¿”å›ž falseã€‚ a ** b æŒ‡æ•°è¿ç®—ç¬¦ï¼Œå®ƒä¸Ž Math.pow(a, b) ç›¸åŒã€‚ Array.prototype.includes()includes() å‡½æ•°ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªæ•°ç»„æ˜¯å¦åŒ…å«ä¸€ä¸ªæŒ‡å®šçš„å€¼ï¼Œå¦‚æžœåŒ…å«åˆ™è¿”å›ž trueï¼Œå¦åˆ™è¿”å›žfalseã€‚ includes å‡½æ•°ä¸Ž indexOf å‡½æ•°å¾ˆç›¸ä¼¼ï¼Œä¸‹é¢ä¸¤ä¸ªè¡¨è¾¾å¼æ˜¯ç­‰ä»·çš„ï¼š 12arr.includes(x)arr.indexOf(x) &gt;= 0 åœ¨ ES7 ä¹‹å‰çš„åšæ³• ä½¿ç”¨indexOf()éªŒè¯æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªå…ƒç´ ï¼Œè¿™æ—¶éœ€è¦æ ¹æ®è¿”å›žå€¼æ˜¯å¦ä¸º-1æ¥åˆ¤æ–­ï¼š 123456let arr = ['react', 'angular', 'vue'];if (arr.indexOf('react') !== -1)&#123; console.log('reactå­˜åœ¨');&#125; ä½¿ç”¨ ES7 çš„ includes() ä½¿ç”¨ includes() éªŒè¯æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªå…ƒç´ ï¼Œè¿™æ ·æ›´åŠ ç›´è§‚ç®€å• 123456let arr = ['react', 'angular', 'vue'];if (arr.includes('react'))&#123; console.log('reactå­˜åœ¨');&#125; æŒ‡æ•°æ“ä½œç¬¦åœ¨ ES7 ä¸­å¼•å…¥äº†æŒ‡æ•°è¿ç®—ç¬¦**ï¼Œ**å…·æœ‰ä¸ŽMath.pow(..)ç­‰æ•ˆçš„è®¡ç®—ç»“æžœã€‚ ä¸ä½¿ç”¨æŒ‡æ•°æ“ä½œç¬¦ ä½¿ç”¨è‡ªå®šä¹‰çš„é€’å½’å‡½æ•° calculateExponent æˆ–è€… Math.pow() è¿›è¡ŒæŒ‡æ•°è¿ç®—ï¼š 1234567891011121314function calculateExponent(base, exponent)&#123; if (exponent === 1) &#123; return base; &#125; else &#123; return base * calculateExponent(base, exponent - 1); &#125;&#125;console.log(calculateExponent(2, 10)); // è¾“å‡º1024console.log(Math.pow(2, 10)); // è¾“å‡º1024 ä½¿ç”¨æŒ‡æ•°æ“ä½œç¬¦ ä½¿ç”¨æŒ‡æ•°è¿ç®—ç¬¦**ï¼Œå°±åƒ+ã€-ç­‰æ“ä½œç¬¦ä¸€æ ·ï¼š 1console.log(2**10);// è¾“å‡º1024 ES8æ–°ç‰¹æ€§ï¼ˆ2017ï¼‰ async/await Object.values() Object.entries() String padding: padStart()å’ŒpadEnd()ï¼Œå¡«å……å­—ç¬¦ä¸²è¾¾åˆ°å½“å‰é•¿åº¦ å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å· Object.getOwnPropertyDescriptors() ShareArrayBufferå’ŒAtomicså¯¹è±¡ï¼Œç”¨äºŽä»Žå…±äº«å†…å­˜ä½ç½®è¯»å–å’Œå†™å…¥ async/await ES6 æä¾›çš„ Promise æ–¹æ³•å’Œ ES7 æä¾›çš„ Async/Await è¯­æ³•ç³–å¯ä»¥æ›´å¥½è§£å†³å¤šå±‚å›žè°ƒé—®é¢˜ Promise å¯¹è±¡ç”¨äºŽè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆçŠ¶æ€ï¼ˆå®Œæˆæˆ–å¤±è´¥ï¼‰ï¼Œä»¥åŠå…¶è¿”å›žçš„å€¼ã€‚ async è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª async å‡½æ•°ï¼Œå³å¼‚æ­¥å‡½æ•°ã€‚ await æ“ä½œç¬¦ç”¨äºŽç­‰å¾…ä¸€ä¸ª Promise å¯¹è±¡ã€‚å®ƒåªèƒ½åœ¨å¼‚æ­¥å‡½æ•° async function ä¸­ä½¿ç”¨ï¼ŒPromise è¿”å›žç»“æžœåŽï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ await åŽé¢è·Ÿç€çš„åº”è¯¥æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼ˆå½“ç„¶ï¼Œå…¶ä»–è¿”å›žå€¼ä¹Ÿæ²¡å…³ç³»ï¼Œåªæ˜¯ä¼šç«‹å³æ‰§è¡Œï¼Œä¸è¿‡é‚£æ ·å°±æ²¡æœ‰æ„ä¹‰äº†â€¦ï¼‰ await ç­‰å¾…çš„è™½ç„¶æ˜¯ Promise å¯¹è±¡ï¼Œä½†ä¸å¿…å†™.then(..)ï¼Œç›´æŽ¥å¯ä»¥å¾—åˆ°è¿”å›žå€¼ã€‚ Object.values()Object.values()æ˜¯ä¸€ä¸ªä¸ŽObject.keys()ç±»ä¼¼çš„æ–°å‡½æ•°ï¼Œä½†è¿”å›žçš„æ˜¯Objectè‡ªèº«å±žæ€§çš„æ‰€æœ‰å€¼ï¼Œä¸åŒ…æ‹¬ç»§æ‰¿çš„å€¼ã€‚ å‡è®¾æˆ‘ä»¬è¦éåŽ†å¦‚ä¸‹å¯¹è±¡objçš„æ‰€æœ‰å€¼ï¼š 1const obj = &#123;a: 1, b: 2, c: 3&#125;; ä¸ä½¿ç”¨Object.values() :ES7 12const vals=Object.keys(obj).map(key=&gt;obj[key]);console.log(vals);//[1, 2, 3] ä½¿ç”¨Object.values() :ES8 12const values=Object.values(obj1);console.log(values);//[1, 2, 3] ä»Žä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹å‡ºObject.values()ä¸ºæˆ‘ä»¬çœåŽ»äº†éåŽ†keyï¼Œå¹¶æ ¹æ®è¿™äº›keyèŽ·å–valueçš„æ­¥éª¤ã€‚ Object.entries()Object.entries()å‡½æ•°è¿”å›žä¸€ä¸ªç»™å®šå¯¹è±¡è‡ªèº«å¯æžšä¸¾å±žæ€§çš„é”®å€¼å¯¹çš„æ•°ç»„ã€‚ æŽ¥ä¸‹æ¥æˆ‘ä»¬æ¥éåŽ†ä¸Šæ–‡ä¸­çš„objå¯¹è±¡çš„æ‰€æœ‰å±žæ€§çš„keyå’Œvalueï¼š ä¸ä½¿ç”¨Object.entries() :ES7 123456Object.keys(obj).forEach(key=&gt;&#123; console.log('key:'+key+' value:'+obj[key]);&#125;)//key:a value:1//key:b value:2//key:c value:3 ä½¿ç”¨Object.entries() :ES8 123456for(let [key,value] of Object.entries(obj1))&#123; console.log(`key: $&#123;key&#125; value:$&#123;value&#125;`)&#125;//key:a value:1//key:b value:2//key:c value:3 String paddingåœ¨ ES8 ä¸­ String æ–°å¢žäº†ä¸¤ä¸ªå®žä¾‹å‡½æ•°String.prototype.padStartå’ŒString.prototype.padEndï¼Œå…è®¸å°†ç©ºå­—ç¬¦ä¸²æˆ–å…¶ä»–å­—ç¬¦ä¸²æ·»åŠ åˆ°åŽŸå§‹å­—ç¬¦ä¸²çš„å¼€å¤´æˆ–ç»“å°¾ã€‚ String.padStart(targetLength,[padString]) targetLengthï¼šå½“å‰å­—ç¬¦ä¸²éœ€è¦å¡«å……åˆ°çš„ç›®æ ‡é•¿åº¦ã€‚å¦‚æžœè¿™ä¸ªæ•°å€¼å°äºŽå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ™è¿”å›žå½“å‰å­—ç¬¦ä¸²æœ¬èº«ã€‚ padString(å¯é€‰)ï¼šå¡«å……å­—ç¬¦ä¸²ã€‚å¦‚æžœå­—ç¬¦ä¸²å¤ªé•¿ï¼Œä½¿å¡«å……åŽçš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡äº†ç›®æ ‡é•¿åº¦ï¼Œåˆ™åªä¿ç•™æœ€å·¦ä¾§çš„éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†ä¼šè¢«æˆªæ–­ï¼Œæ­¤å‚æ•°çš„ç¼ºçœå€¼ä¸º â€œ â€œã€‚ 12console.log('0.0'.padStart(4,'10')) //10.0console.log('0.0'.padStart(20)) // 0.00 String.padEnd(targetLength,padString]) targetLengthï¼šå½“å‰å­—ç¬¦ä¸²éœ€è¦å¡«å……åˆ°çš„ç›®æ ‡é•¿åº¦ã€‚å¦‚æžœè¿™ä¸ªæ•°å€¼å°äºŽå½“å‰å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œåˆ™è¿”å›žå½“å‰å­—ç¬¦ä¸²æœ¬èº«ã€‚ padString(å¯é€‰)ï¼šå¡«å……å­—ç¬¦ä¸²ã€‚å¦‚æžœå­—ç¬¦ä¸²å¤ªé•¿ï¼Œä½¿å¡«å……åŽçš„å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡äº†ç›®æ ‡é•¿åº¦ï¼Œåˆ™åªä¿ç•™æœ€å·¦ä¾§çš„éƒ¨åˆ†ï¼Œå…¶ä»–éƒ¨åˆ†ä¼šè¢«æˆªæ–­ï¼Œæ­¤å‚æ•°çš„ç¼ºçœå€¼ä¸º â€œ â€œï¼› 12console.log('0.0'.padEnd(4,'0')) //0.00 console.log('0.0'.padEnd(10,'0')) // 0.00000000 å‡½æ•°å‚æ•°åˆ—è¡¨ç»“å°¾å…è®¸é€—å·ä¸»è¦ä½œç”¨æ˜¯æ–¹ä¾¿ä½¿ç”¨ git è¿›è¡Œå¤šäººåä½œå¼€å‘æ—¶ä¿®æ”¹åŒä¸€ä¸ªå‡½æ•°å‡å°‘ä¸å¿…è¦çš„è¡Œå˜æ›´ã€‚ Object.getOwnPropertyDescriptors()Object.getOwnPropertyDescriptors()å‡½æ•°ç”¨æ¥èŽ·å–ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰è‡ªèº«å±žæ€§çš„æè¿°ç¬¦ï¼Œå¦‚æžœæ²¡æœ‰ä»»ä½•è‡ªèº«å±žæ€§ï¼Œåˆ™è¿”å›žç©ºå¯¹è±¡ã€‚ å‡½æ•°åŽŸåž‹ï¼š 1Object.getOwnPropertyDescriptors(obj) è¿”å›žobjå¯¹è±¡çš„æ‰€æœ‰è‡ªèº«å±žæ€§çš„æè¿°ç¬¦ï¼Œå¦‚æžœæ²¡æœ‰ä»»ä½•è‡ªèº«å±žæ€§ï¼Œåˆ™è¿”å›žç©ºå¯¹è±¡ã€‚ 12345678910111213141516171819const obj2 = &#123; name: 'Jine', get age() &#123; return '18' &#125;&#125;;Object.getOwnPropertyDescriptors(obj2)// &#123;// age: &#123;// configurable: true,// enumerable: true,// get: function age()&#123;&#125;, //the getter function// set: undefined// &#125;,// name: &#123;// configurable: true,// enumerable: true,// value:"Jine",// writable:true// &#125;// &#125; SharedArrayBufferå¯¹è±¡SharedArrayBuffer å¯¹è±¡ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé€šç”¨çš„ï¼Œå›ºå®šé•¿åº¦çš„åŽŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºï¼Œç±»ä¼¼äºŽ ArrayBuffer å¯¹è±¡ï¼Œå®ƒä»¬éƒ½å¯ä»¥ç”¨æ¥åœ¨å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ä¸Šåˆ›å»ºè§†å›¾ã€‚ä¸Ž ArrayBuffer ä¸åŒçš„æ˜¯ï¼ŒSharedArrayBuffer ä¸èƒ½è¢«åˆ†ç¦»ã€‚ 123456/** * * @param &#123;*&#125; length æ‰€åˆ›å»ºçš„æ•°ç»„ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥å­—èŠ‚(byte)ä¸ºå•ä½ã€‚ * @returns &#123;SharedArrayBuffer&#125; ä¸€ä¸ªå¤§å°æŒ‡å®šçš„æ–° SharedArrayBuffer å¯¹è±¡ã€‚å…¶å†…å®¹è¢«åˆå§‹åŒ–ä¸º 0ã€‚ */new SharedArrayBuffer(length) Atomicså¯¹è±¡Atomics å¯¹è±¡æä¾›äº†ä¸€ç»„é™æ€æ–¹æ³•ç”¨æ¥å¯¹ SharedArrayBuffer å¯¹è±¡è¿›è¡ŒåŽŸå­æ“ä½œã€‚ è¿™äº›åŽŸå­æ“ä½œå±žäºŽ Atomics æ¨¡å—ã€‚ä¸Žä¸€èˆ¬çš„å…¨å±€å¯¹è±¡ä¸åŒï¼ŒAtomics ä¸æ˜¯æž„é€ å‡½æ•°ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ new æ“ä½œç¬¦è°ƒç”¨ï¼Œä¹Ÿä¸èƒ½å°†å…¶å½“ä½œå‡½æ•°ç›´æŽ¥è°ƒç”¨ã€‚Atomics çš„æ‰€æœ‰å±žæ€§å’Œæ–¹æ³•éƒ½æ˜¯é™æ€çš„ï¼ˆä¸Ž Math å¯¹è±¡ä¸€æ ·ï¼‰ã€‚ å¤šä¸ªå…±äº«å†…å­˜çš„çº¿ç¨‹èƒ½å¤ŸåŒæ—¶è¯»å†™åŒä¸€ä½ç½®ä¸Šçš„æ•°æ®ã€‚åŽŸå­æ“ä½œä¼šç¡®ä¿æ­£åœ¨è¯»æˆ–å†™çš„æ•°æ®çš„å€¼æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå³ä¸‹ä¸€ä¸ªåŽŸå­æ“ä½œä¸€å®šä¼šåœ¨ä¸Šä¸€ä¸ªåŽŸå­æ“ä½œç»“æŸåŽæ‰ä¼šå¼€å§‹ï¼Œå…¶æ“ä½œè¿‡ç¨‹ä¸ä¼šä¸­æ–­ã€‚ Atomics.add() å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸Žç»™å®šçš„å€¼ç›¸åŠ ï¼Œå¹¶è¿”å›žç›¸åŠ å‰è¯¥å…ƒç´ çš„å€¼ã€‚ Atomics.and() å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸Žç»™å®šçš„å€¼ç›¸ä¸Žï¼Œå¹¶è¿”å›žä¸Žæ“ä½œå‰è¯¥å…ƒç´ çš„å€¼ã€‚ Atomics.compareExchange() å¦‚æžœæ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ ä¸Žç»™å®šçš„å€¼ä¸ç­‰ï¼Œåˆ™å°†å…¶æ›´æ–°ä¸ºæ–°çš„å€¼ï¼Œå¹¶è¿”å›žè¯¥å…ƒç´ åŽŸå…ˆçš„å€¼ã€‚ Atomics.exchange() å°†æ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ æ›´æ–°ä¸ºç»™å®šçš„å€¼ï¼Œå¹¶è¿”å›žè¯¥å…ƒç´ æ›´æ–°å‰çš„å€¼ã€‚ Atomics.load() è¿”å›žæ•°ç»„ä¸­æŒ‡å®šå…ƒç´ çš„å€¼ã€‚ Atomics.or() å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸Žç»™å®šçš„å€¼ç›¸æˆ–ï¼Œå¹¶è¿”å›žæˆ–æ“ä½œå‰è¯¥å…ƒç´ çš„å€¼ã€‚ Atomics.store() å°†æ•°ç»„ä¸­æŒ‡å®šçš„å…ƒç´ è®¾ç½®ä¸ºç»™å®šçš„å€¼ï¼Œå¹¶è¿”å›žè¯¥å€¼ã€‚ Atomics.sub() å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸Žç»™å®šçš„å€¼ç›¸å‡ï¼Œå¹¶è¿”å›žç›¸å‡å‰è¯¥å…ƒç´ çš„å€¼ã€‚ Atomics.xor() å°†æŒ‡å®šä½ç½®ä¸Šçš„æ•°ç»„å…ƒç´ ä¸Žç»™å®šçš„å€¼ç›¸å¼‚æˆ–ï¼Œå¹¶è¿”å›žå¼‚æˆ–æ“ä½œå‰è¯¥å…ƒç´ çš„å€¼ã€‚ wait() å’Œ wake() æ–¹æ³•é‡‡ç”¨çš„æ˜¯ Linux ä¸Šçš„ futexes æ¨¡åž‹ï¼ˆfast user-space mutexï¼Œå¿«é€Ÿç”¨æˆ·ç©ºé—´äº’æ–¥é‡ï¼‰ï¼Œå¯ä»¥è®©è¿›ç¨‹ä¸€ç›´ç­‰å¾…ç›´åˆ°æŸä¸ªç‰¹å®šçš„æ¡ä»¶ä¸ºçœŸï¼Œä¸»è¦ç”¨äºŽå®žçŽ°é˜»å¡žã€‚ Atomics.wait() æ£€æµ‹æ•°ç»„ä¸­æŸä¸ªæŒ‡å®šä½ç½®ä¸Šçš„å€¼æ˜¯å¦ä»ç„¶æ˜¯ç»™å®šå€¼ï¼Œæ˜¯åˆ™ä¿æŒæŒ‚èµ·ç›´åˆ°è¢«å”¤é†’æˆ–è¶…æ—¶ã€‚è¿”å›žå€¼ä¸º â€œokâ€ã€â€not-equalâ€ æˆ– â€œtime-outâ€ã€‚è°ƒç”¨æ—¶ï¼Œå¦‚æžœå½“å‰çº¿ç¨‹ä¸å…è®¸é˜»å¡žï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå¤§å¤šæ•°æµè§ˆå™¨éƒ½ä¸å…è®¸åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ wait()ï¼‰ã€‚ Atomics.wake() å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­æ­£åœ¨æ•°ç»„æŒ‡å®šä½ç½®çš„å…ƒç´ ä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚è¿”å›žå€¼ä¸ºæˆåŠŸå”¤é†’çš„çº¿ç¨‹æ•°é‡ã€‚ Atomics.isLockFree(size) å¯ä»¥ç”¨æ¥æ£€æµ‹å½“å‰ç³»ç»Ÿæ˜¯å¦æ”¯æŒç¡¬ä»¶çº§çš„åŽŸå­æ“ä½œã€‚å¯¹äºŽæŒ‡å®šå¤§å°çš„æ•°ç»„ï¼Œå¦‚æžœå½“å‰ç³»ç»Ÿæ”¯æŒç¡¬ä»¶çº§çš„åŽŸå­æ“ä½œï¼Œåˆ™è¿”å›ž trueï¼›å¦åˆ™å°±æ„å‘³ç€å¯¹äºŽè¯¥æ•°ç»„ï¼ŒAtomics å¯¹è±¡ä¸­çš„å„åŽŸå­æ“ä½œéƒ½åªèƒ½ç”¨é”æ¥å®žçŽ°ã€‚æ­¤å‡½æ•°é¢å‘çš„æ˜¯æŠ€æœ¯ä¸“å®¶ã€‚â€“&gt; ES9æ–°ç‰¹æ€§ï¼ˆ2018ï¼‰ å¼‚æ­¥è¿­ä»£ Promise.finally() Rest/Spread å±žæ€§ æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•èŽ·ç»„ï¼ˆRegular Expression Named Capture Groupsï¼‰ æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€ï¼ˆlookbehindï¼‰ æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼ æ­£åˆ™è¡¨è¾¾å¼ Unicode è½¬ä¹‰ éžè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸² å¼‚æ­¥è¿­ä»£åœ¨async/awaitçš„æŸäº›æ—¶åˆ»ï¼Œä½ å¯èƒ½å°è¯•åœ¨åŒæ­¥å¾ªçŽ¯ä¸­è°ƒç”¨å¼‚æ­¥å‡½æ•°ã€‚ä¾‹å¦‚ï¼š 12345async function process(array) &#123; for (let i of array) &#123; await doSomething(i); &#125;&#125; è¿™æ®µä»£ç ä¸ä¼šæ­£å¸¸è¿è¡Œï¼Œä¸‹é¢è¿™æ®µåŒæ ·ä¹Ÿä¸ä¼šï¼š 12345async function process(array) &#123; array.forEach(async i =&gt; &#123; await doSomething(i); &#125;);&#125; è¿™æ®µä»£ç ä¸­ï¼Œå¾ªçŽ¯æœ¬èº«ä¾æ—§ä¿æŒåŒæ­¥ï¼Œå¹¶åœ¨åœ¨å†…éƒ¨å¼‚æ­¥å‡½æ•°ä¹‹å‰å…¨éƒ¨è°ƒç”¨å®Œæˆã€‚ ES2018 å¼•å…¥å¼‚æ­¥è¿­ä»£å™¨ï¼ˆasynchronous iteratorsï¼‰ï¼Œè¿™å°±åƒå¸¸è§„è¿­ä»£å™¨ï¼Œé™¤äº†next()æ–¹æ³•è¿”å›žä¸€ä¸ªPromiseã€‚å› æ­¤awaitå¯ä»¥å’Œfor...ofå¾ªçŽ¯ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¸²è¡Œçš„æ–¹å¼è¿è¡Œå¼‚æ­¥æ“ä½œã€‚ä¾‹å¦‚ï¼š 12345async function process(array) &#123; for await (let i of array) &#123; doSomething(i); &#125;&#125; Promise.finally()ä¸€ä¸ª Promise è°ƒç”¨é“¾è¦ä¹ˆæˆåŠŸåˆ°è¾¾æœ€åŽä¸€ä¸ª.then()ï¼Œè¦ä¹ˆå¤±è´¥è§¦å‘.catch()ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ æƒ³è¦åœ¨æ— è®ºPromiseè¿è¡ŒæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿è¡Œç›¸åŒçš„ä»£ç ï¼Œä¾‹å¦‚æ¸…é™¤ï¼Œåˆ é™¤å¯¹è¯ï¼Œå…³é—­æ•°æ®åº“è¿žæŽ¥ç­‰ã€‚ .finally()å…è®¸ä½ æŒ‡å®šæœ€ç»ˆçš„é€»è¾‘ï¼š 1234567891011function doSomething() &#123; doSomething1() .then(doSomething2) .then(doSomething3) .catch(err =&gt; &#123; console.log(err); &#125;) .finally(() =&gt; &#123; // finish here! &#125;);&#125; Rest/Spread å±žæ€§ES2015 å¼•å…¥äº†Restå‚æ•°å’Œæ‰©å±•è¿ç®—ç¬¦ã€‚ä¸‰ä¸ªç‚¹ï¼ˆâ€¦ï¼‰ä»…ç”¨äºŽæ•°ç»„ã€‚Restå‚æ•°è¯­æ³•å…è®¸æˆ‘ä»¬å°†ä¸€ä¸ªä¸å®šæ•°é‡çš„å‚æ•°è¡¨ç¤ºä¸ºä¸€ä¸ªæ•°ç»„ã€‚ 1234567restParam(1, 2, 3, 4, 5);function restParam(p1, p2, ...p3) &#123; // p1 = 1 // p2 = 2 // p3 = [3, 4, 5]&#125; å±•å¼€æ“ä½œç¬¦ä»¥ç›¸åçš„æ–¹å¼å·¥ä½œï¼Œå°†æ•°ç»„è½¬æ¢æˆå¯ä¼ é€’ç»™å‡½æ•°çš„å•ç‹¬å‚æ•°ã€‚ä¾‹å¦‚Math.max()è¿”å›žç»™å®šæ•°å­—ä¸­çš„æœ€å¤§å€¼ï¼š 12const values = [99, 100, -1, 48, 16];console.log( Math.max(...values) ); // 100 ES2018 ä¸ºå¯¹è±¡è§£æž„æä¾›äº†å’Œæ•°ç»„ä¸€æ ·çš„Restå‚æ•°ï¼ˆï¼‰å’Œå±•å¼€æ“ä½œç¬¦ï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789const myObject = &#123; a: 1, b: 2, c: 3&#125;;const &#123; a, ...x &#125; = myObject;// a = 1// x = &#123; b: 2, c: 3 &#125; æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨å®ƒç»™å‡½æ•°ä¼ é€’å‚æ•°ï¼š 12345678910restParam(&#123; a: 1, b: 2, c: 3&#125;);function restParam(&#123; a, ...x &#125;) &#123; // a = 1 // x = &#123; b: 2, c: 3 &#125;&#125; è·Ÿæ•°ç»„ä¸€æ ·ï¼ŒRestå‚æ•°åªèƒ½åœ¨å£°æ˜Žçš„ç»“å°¾å¤„ä½¿ç”¨ã€‚æ­¤å¤–ï¼Œå®ƒåªé€‚ç”¨äºŽæ¯ä¸ªå¯¹è±¡çš„é¡¶å±‚ï¼Œå¦‚æžœå¯¹è±¡ä¸­åµŒå¥—å¯¹è±¡åˆ™æ— æ³•é€‚ç”¨ã€‚ æ‰©å±•è¿ç®—ç¬¦å¯ä»¥åœ¨å…¶ä»–å¯¹è±¡å†…ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š 123const obj1 = &#123; a: 1, b: 2, c: 3 &#125;;const obj2 = &#123; ...obj1, z: 26 &#125;;// obj2 is &#123; a: 1, b: 2, c: 3, z: 26 &#125; å¯ä»¥ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦æ‹·è´ä¸€ä¸ªå¯¹è±¡ï¼Œåƒæ˜¯è¿™æ ·obj2 = {...obj1}ï¼Œä½†æ˜¯ è¿™åªæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æµ…æ‹·è´ã€‚å¦å¤–ï¼Œå¦‚æžœä¸€ä¸ªå¯¹è±¡Açš„å±žæ€§æ˜¯å¯¹è±¡Bï¼Œé‚£ä¹ˆåœ¨å…‹éš†åŽçš„å¯¹è±¡ cloneB ä¸­ï¼Œè¯¥å±žæ€§æŒ‡å‘å¯¹è±¡Bã€‚ æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•èŽ·ç»„JavaScript æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥è¿”å›žä¸€ä¸ªåŒ¹é…çš„å¯¹è±¡â€”â€”ä¸€ä¸ªåŒ…å«åŒ¹é…å­—ç¬¦ä¸²çš„ç±»æ•°ç»„ï¼Œä¾‹å¦‚ï¼šä»¥YYYY-MM-DDçš„æ ¼å¼è§£æžæ—¥æœŸï¼š 123456const reDate = /([0-9]&#123;4&#125;)-([0-9]&#123;2&#125;)-([0-9]&#123;2&#125;)/, match = reDate.exec('2018-04-30'), year = match[1], // 2018 month = match[2], // 04 day = match[3]; // 30 è¿™æ ·çš„ä»£ç å¾ˆéš¾è¯»æ‡‚ï¼Œå¹¶ä¸”æ”¹å˜æ­£åˆ™è¡¨è¾¾å¼çš„ç»“æž„æœ‰å¯èƒ½æ”¹å˜åŒ¹é…å¯¹è±¡çš„ç´¢å¼•ã€‚ ES2018 å…è®¸å‘½åæ•èŽ·ç»„ä½¿ç”¨ç¬¦å·?&lt;name&gt;ï¼Œåœ¨æ‰“å¼€æ•èŽ·æ‹¬å·(åŽç«‹å³å‘½åï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š 123456const reDate = /(?&lt;year&gt;[0-9]&#123;4&#125;)-(?&lt;month&gt;[0-9]&#123;2&#125;)-(?&lt;day&gt;[0-9]&#123;2&#125;)/, match = reDate.exec('2018-04-30'), year = match.groups.year, // 2018 month = match.groups.month, // 04 day = match.groups.day; // 30 ä»»ä½•åŒ¹é…å¤±è´¥çš„å‘½åç»„éƒ½å°†è¿”å›žundefinedã€‚ å‘½åæ•èŽ·ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨replace()æ–¹æ³•ä¸­ã€‚ä¾‹å¦‚å°†æ—¥æœŸè½¬æ¢ä¸ºç¾Žå›½çš„ MM-DD-YYYY æ ¼å¼ï¼š 1234const reDate = /(?&lt;year&gt;[0-9]&#123;4&#125;)-(?&lt;month&gt;[0-9]&#123;2&#125;)-(?&lt;day&gt;[0-9]&#123;2&#125;)/, d = '2018-04-30', usDate = d.replace(reDate, '$&lt;month&gt;-$&lt;day&gt;-$&lt;year&gt;'); æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€ç›®å‰ JavaScript åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­æ”¯æŒå…ˆè¡Œæ–­è¨€ï¼ˆlookaheadï¼‰ã€‚è¿™æ„å‘³ç€åŒ¹é…ä¼šå‘ç”Ÿï¼Œä½†ä¸ä¼šæœ‰ä»»ä½•æ•èŽ·ï¼Œå¹¶ä¸”æ–­è¨€æ²¡æœ‰åŒ…å«åœ¨æ•´ä¸ªåŒ¹é…å­—æ®µä¸­ã€‚ä¾‹å¦‚ä»Žä»·æ ¼ä¸­æ•èŽ·è´§å¸ç¬¦å·ï¼š 12345const reLookahead = /\D(?=\d+)/, match = reLookahead.exec('$123.89');console.log( match[0] ); // $ ES2018 å¼•å…¥ä»¥ç›¸åŒæ–¹å¼å·¥ä½œä½†æ˜¯åŒ¹é…å‰é¢çš„åå‘æ–­è¨€ï¼ˆlookbehindï¼‰ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥å¿½ç•¥è´§å¸ç¬¦å·ï¼Œå•çº¯çš„æ•èŽ·ä»·æ ¼çš„æ•°å­—ï¼š 12345const reLookbehind = /(?&lt;=\D)\d+/, match = reLookbehind.exec('$123.89');console.log( match[0] ); // 123.89 ä»¥ä¸Šæ˜¯ è‚¯å®šåå‘æ–­è¨€ï¼Œéžæ•°å­—\Då¿…é¡»å­˜åœ¨ã€‚åŒæ ·çš„ï¼Œè¿˜å­˜åœ¨ å¦å®šåå‘æ–­è¨€ï¼Œè¡¨ç¤ºä¸€ä¸ªå€¼å¿…é¡»ä¸å­˜åœ¨ï¼Œä¾‹å¦‚ï¼š 12345const reLookbehindNeg = /(?&lt;!\D)\d+/, match = reLookbehind.exec('$123.89');console.log( match[0] ); // null æ­£åˆ™è¡¨è¾¾å¼dotAllæ¨¡å¼æ­£åˆ™è¡¨è¾¾å¼ä¸­ç‚¹.åŒ¹é…é™¤å›žè½¦å¤–çš„ä»»ä½•å•å­—ç¬¦ï¼Œæ ‡è®°sæ”¹å˜è¿™ç§è¡Œä¸ºï¼Œå…è®¸è¡Œç»ˆæ­¢ç¬¦çš„å‡ºçŽ°ï¼Œä¾‹å¦‚ï¼š 12/hello.world/.test('hello\nworld'); // false/hello.world/s.test('hello\nworld'); // true æ­£åˆ™è¡¨è¾¾å¼ Unicode è½¬ä¹‰åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ¬åœ°è®¿é—® Unicode å­—ç¬¦å±žæ€§æ˜¯ä¸è¢«å…è®¸çš„ã€‚ES2018æ·»åŠ äº† Unicode å±žæ€§è½¬ä¹‰â€”â€”å½¢å¼ä¸º\p{...}å’Œ\P{...}ï¼Œåœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­ä½¿ç”¨æ ‡è®° u (unicode) è®¾ç½®ï¼Œåœ¨\på—å„¿å†…ï¼Œå¯ä»¥ä»¥é”®å€¼å¯¹çš„æ–¹å¼è®¾ç½®éœ€è¦åŒ¹é…çš„å±žæ€§è€Œéžå…·ä½“å†…å®¹ã€‚ä¾‹å¦‚ï¼š 12const reGreekSymbol = /\p&#123;Script=Greek&#125;/u;reGreekSymbol.test('Ï€'); // true æ­¤ç‰¹æ€§å¯ä»¥é¿å…ä½¿ç”¨ç‰¹å®š Unicode åŒºé—´æ¥è¿›è¡Œå†…å®¹ç±»åž‹åˆ¤æ–­ï¼Œæå‡å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ éžè½¬ä¹‰åºåˆ—çš„æ¨¡æ¿å­—ç¬¦ä¸²ä¹‹å‰ï¼Œ\uå¼€å§‹ä¸€ä¸ª unicode è½¬ä¹‰ï¼Œ\xå¼€å§‹ä¸€ä¸ªåå…­è¿›åˆ¶è½¬ä¹‰ï¼Œ\åŽè·Ÿä¸€ä¸ªæ•°å­—å¼€å§‹ä¸€ä¸ªå…«è¿›åˆ¶è½¬ä¹‰ã€‚è¿™ä½¿å¾—åˆ›å»ºç‰¹å®šçš„å­—ç¬¦ä¸²å˜å¾—ä¸å¯èƒ½ï¼Œä¾‹å¦‚Windowsæ–‡ä»¶è·¯å¾„ C:\uuu\xxx\111ã€‚æ›´å¤šç»†èŠ‚å‚è€ƒæ¨¡æ¿å­—ç¬¦ä¸²ã€‚ ES10æ–°ç‰¹æ€§ï¼ˆ2019ï¼‰ è¡Œåˆ†éš”ç¬¦ï¼ˆU + 2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU + 2029ï¼‰ç¬¦å·çŽ°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸ŽJSONåŒ¹é… æ›´åŠ å‹å¥½çš„ JSON.stringify æ–°å¢žäº†Arrayçš„flat()æ–¹æ³•å’ŒflatMap()æ–¹æ³• æ–°å¢žäº†Stringçš„trimStart()æ–¹æ³•å’ŒtrimEnd()æ–¹æ³• Object.fromEntries() Symbol.prototype.description String.prototype.matchAll Function.prototype.toString()çŽ°åœ¨è¿”å›žç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š ç®€åŒ–try {} catch {},ä¿®æ”¹ catch ç»‘å®š æ–°çš„åŸºæœ¬æ•°æ®ç±»åž‹BigInt globalThis import() Legacy RegEx ç§æœ‰çš„å®žä¾‹æ–¹æ³•å’Œè®¿é—®å™¨ è¡Œåˆ†éš”ç¬¦ï¼ˆU + 2028ï¼‰å’Œæ®µåˆ†éš”ç¬¦ï¼ˆU + 2029ï¼‰ç¬¦å·çŽ°åœ¨å…è®¸åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­ï¼Œä¸Ž JSON åŒ¹é…ä»¥å‰ï¼Œè¿™äº›ç¬¦å·åœ¨å­—ç¬¦ä¸²æ–‡å­—ä¸­è¢«è§†ä¸ºè¡Œç»ˆæ­¢ç¬¦ï¼Œå› æ­¤ä½¿ç”¨å®ƒä»¬ä¼šå¯¼è‡´ SyntaxError å¼‚å¸¸ã€‚ æ›´åŠ å‹å¥½çš„ JSON.stringifyå¦‚æžœè¾“å…¥ Unicode æ ¼å¼ä½†æ˜¯è¶…å‡ºèŒƒå›´çš„å­—ç¬¦ï¼Œåœ¨åŽŸå…ˆ JSON.stringify è¿”å›žæ ¼å¼é”™è¯¯çš„Unicode å­—ç¬¦ä¸²ã€‚çŽ°åœ¨å®žçŽ°äº†ä¸€ä¸ªæ”¹å˜ JSON.stringify çš„ç¬¬3é˜¶æ®µææ¡ˆï¼Œå› æ­¤å®ƒä¸ºå…¶è¾“å‡ºè½¬ä¹‰åºåˆ—ï¼Œä½¿å…¶æˆä¸ºæœ‰æ•ˆUnicodeï¼ˆå¹¶ä»¥UTF-8è¡¨ç¤ºï¼‰ æ–°å¢žäº† Array çš„ flat() æ–¹æ³•å’Œ flatMap() æ–¹æ³•flat() å’Œ flatMap()æœ¬è´¨ä¸Šå°±æ˜¯æ˜¯å½’çº³ï¼ˆreduceï¼‰ ä¸Ž åˆå¹¶ï¼ˆconcatï¼‰çš„æ“ä½œã€‚ Array.prototype.flat()flat() æ–¹æ³•ä¼šæŒ‰ç…§ä¸€ä¸ªå¯æŒ‡å®šçš„æ·±åº¦é€’å½’éåŽ†æ•°ç»„ï¼Œå¹¶å°†æ‰€æœ‰å…ƒç´ ä¸ŽéåŽ†åˆ°çš„å­æ•°ç»„ä¸­çš„å…ƒç´ åˆå¹¶ä¸ºä¸€ä¸ªæ–°æ•°ç»„è¿”å›žã€‚ flat()æ–¹æ³•æœ€åŸºæœ¬çš„ä½œç”¨å°±æ˜¯æ•°ç»„é™ç»´ 123456789101112131415var arr1 = [1, 2, [3, 4]];arr1.flat(); // [1, 2, 3, 4]var arr2 = [1, 2, [3, 4, [5, 6]]];arr2.flat();// [1, 2, 3, 4, [5, 6]]var arr3 = [1, 2, [3, 4, [5, 6]]];arr3.flat(2);// [1, 2, 3, 4, 5, 6]//ä½¿ç”¨ Infinity ä½œä¸ºæ·±åº¦ï¼Œå±•å¼€ä»»æ„æ·±åº¦çš„åµŒå¥—æ•°ç»„arr3.flat(Infinity); // [1, 2, 3, 4, 5, 6] å…¶æ¬¡ï¼Œè¿˜å¯ä»¥åˆ©ç”¨flat()æ–¹æ³•çš„ç‰¹æ€§æ¥åŽ»é™¤æ•°ç»„çš„ç©ºé¡¹ 123var arr4 = [1, 2, , 4, 5];arr4.flat();// [1, 2, 4, 5] Array.prototype.flatMap()flatMap() æ–¹æ³•é¦–å…ˆä½¿ç”¨æ˜ å°„å‡½æ•°æ˜ å°„æ¯ä¸ªå…ƒç´ ï¼Œç„¶åŽå°†ç»“æžœåŽ‹ç¼©æˆä¸€ä¸ªæ–°æ•°ç»„ã€‚å®ƒä¸Ž map å’Œ æ·±åº¦å€¼1 çš„ flat å‡ ä¹Žç›¸åŒï¼Œä½† flatMap é€šå¸¸åœ¨åˆå¹¶æˆä¸€ç§æ–¹æ³•çš„æ•ˆçŽ‡ç¨å¾®é«˜ä¸€äº›ã€‚ è¿™é‡Œæˆ‘ä»¬æ‹¿mapæ–¹æ³•ä¸ŽflatMapæ–¹æ³•åšä¸€ä¸ªæ¯”è¾ƒã€‚ 1234567891011var arr1 = [1, 2, 3, 4];arr1.map(x =&gt; [x * 2]); // [[2], [4], [6], [8]]arr1.flatMap(x =&gt; [x * 2]);// [2, 4, 6, 8]// åªä¼šå°† flatMap ä¸­çš„å‡½æ•°è¿”å›žçš„æ•°ç»„ â€œåŽ‹å¹³â€ ä¸€å±‚arr1.flatMap(x =&gt; [[x * 2]]);// [[2], [4], [6], [8]] æ–°å¢žäº†Stringçš„ trimStart() æ–¹æ³•å’Œ trimEnd() æ–¹æ³•æ–°å¢žçš„è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆå¥½ç†è§£ï¼Œåˆ†åˆ«åŽ»é™¤å­—ç¬¦ä¸²é¦–å°¾ç©ºç™½å­—ç¬¦ã€‚ Object.fromEntries()Object.entries()æ–¹æ³•çš„ä½œç”¨æ˜¯è¿”å›žä¸€ä¸ªç»™å®šå¯¹è±¡è‡ªèº«å¯æžšä¸¾å±žæ€§çš„é”®å€¼å¯¹æ•°ç»„ï¼Œå…¶æŽ’åˆ—ä¸Žä½¿ç”¨ forâ€¦in å¾ªçŽ¯éåŽ†è¯¥å¯¹è±¡æ—¶è¿”å›žçš„é¡ºåºä¸€è‡´ï¼ˆåŒºåˆ«åœ¨äºŽ for-in å¾ªçŽ¯ä¹Ÿæžšä¸¾åŽŸåž‹é“¾ä¸­çš„å±žæ€§ï¼‰ã€‚ è€ŒObject.fromEntries() åˆ™æ˜¯ Object.entries() çš„åè½¬ã€‚ Object.fromEntries() å‡½æ•°ä¼ å…¥ä¸€ä¸ªé”®å€¼å¯¹çš„åˆ—è¡¨ï¼Œå¹¶è¿”å›žä¸€ä¸ªå¸¦æœ‰è¿™äº›é”®å€¼å¯¹çš„æ–°å¯¹è±¡ã€‚è¿™ä¸ªè¿­ä»£å‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªèƒ½å¤Ÿå®žçŽ°@iteratoræ–¹æ³•çš„çš„å¯¹è±¡ï¼Œè¿”å›žä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚å®ƒç”Ÿæˆä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå…ƒç´ çš„ç±»ä¼¼æ•°ç»„çš„å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å°†ç”¨ä½œå±žæ€§é”®çš„å€¼ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ä¸Žè¯¥å±žæ€§é”®å…³è”çš„å€¼ã€‚ é€šè¿‡ Object.fromEntriesï¼Œ å¯ä»¥å°† Map è½¬åŒ–ä¸º Object: 123const map = new Map([ ['foo', 'bar'], ['baz', 42] ]);const obj = Object.fromEntries(map);console.log(obj); // &#123; foo: "bar", baz: 42 &#125; é€šè¿‡ Object.fromEntriesï¼Œ å¯ä»¥å°† Array è½¬åŒ–ä¸º Object: 1234const arr = [ ['0', 'a'], ['1', 'b'], ['2', 'c'] ];const obj = Object.fromEntries(arr);console.log(obj); // &#123; 0: "a", 1: "b", 2: "c" &#125;å¤åˆ¶ä»£ç  Symbol.prototype.descriptioné€šè¿‡å·¥åŽ‚å‡½æ•° Symbol() åˆ›å»ºç¬¦å·æ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©é€šè¿‡å‚æ•°æä¾›å­—ç¬¦ä¸²ä½œä¸ºæè¿°ï¼š 1const sym = Symbol('The description'); ä»¥å‰ï¼Œè®¿é—®æè¿°çš„å”¯ä¸€æ–¹æ³•æ˜¯å°†ç¬¦å·è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼š 1assert.equal(String(sym), 'Symbol(The description)'); çŽ°åœ¨å¼•å…¥äº†getter Symbol.prototype.description ä»¥ç›´æŽ¥è®¿é—®æè¿°ï¼š 1assert.equal(sym.description, 'The description'); String.prototype.matchAllmatchAll() æ–¹æ³•è¿”å›žä¸€ä¸ªåŒ…å«æ‰€æœ‰åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼åŠåˆ†ç»„æ•èŽ·ç»“æžœçš„è¿­ä»£å™¨ã€‚ åœ¨ matchAll å‡ºçŽ°ä¹‹å‰ï¼Œé€šè¿‡åœ¨å¾ªçŽ¯ä¸­è°ƒç”¨ regexp.exec æ¥èŽ·å–æ‰€æœ‰åŒ¹é…é¡¹ä¿¡æ¯ï¼ˆ regexp éœ€ä½¿ç”¨ /g æ ‡å¿—ï¼š 12345678const regexp = RegExp('foo*','g');const str = 'table football, foosball';while ((matches = regexp.exec(str)) !== null) &#123; console.log(`Found $&#123;matches[0]&#125;. Next starts at $&#123;regexp.lastIndex&#125;.`); // expected output: "Found foo. Next starts at 9." // expected output: "Found foo. Next starts at 19."&#125; å¦‚æžœä½¿ç”¨ matchAll ï¼Œå°±å¯ä»¥ä¸å¿…ä½¿ç”¨ while å¾ªçŽ¯åŠ  exec æ–¹å¼ï¼ˆä¸”æ­£åˆ™è¡¨è¾¾å¼éœ€ä½¿ç”¨ï¼gæ ‡å¿—ï¼‰ã€‚ä½¿ç”¨ matchAll ä¼šå¾—åˆ°ä¸€ä¸ªè¿­ä»£å™¨çš„è¿”å›žå€¼ï¼Œé…åˆ forâ€¦ofï¼Œarray spreadï¼Œor Array.from() å¯ä»¥æ›´æ–¹ä¾¿å®žçŽ°åŠŸèƒ½ï¼š 12345678910111213141516const regexp = RegExp('foo*','g'); const str = 'table football, foosball';let matches = str.matchAll(regexp);for (const match of matches) &#123; console.log(match);&#125;// Array [ "foo" ]// Array [ "foo" ]// matches iterator is exhausted after the for..of iteration// Call matchAll again to create a new iteratormatches = str.matchAll(regexp);Array.from(matches, m =&gt; m[0]);// Array [ "foo", "foo" ] matchAll å¯ä»¥æ›´å¥½çš„ç”¨äºŽåˆ†ç»„1234567891011var regexp = /t(e)(st(\d?))/g;var str = 'test1test2';str.match(regexp); // Array ['test1', 'test2']let array = [...str.matchAll(regexp)];array[0];// ['test1', 'e', 'st1', '1', index: 0, input: 'test1test2', length: 4]array[1];// ['test2', 'e', 'st2', '2', index: 5, input: 'test1test2', length: 4] Function.prototype.toString() çŽ°åœ¨è¿”å›žç²¾ç¡®å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ³¨é‡Š123456789101112function /* comment */ foo /* another comment */() &#123;&#125;// ä¹‹å‰ä¸ä¼šæ‰“å°æ³¨é‡Šéƒ¨åˆ†console.log(foo.toString()); // function foo()&#123;&#125;// ES2019 ä¼šæŠŠæ³¨é‡Šä¸€åŒæ‰“å°console.log(foo.toString()); // function /* comment */ foo /* another comment */ ()&#123;&#125;// ç®­å¤´å‡½æ•°const bar /* comment */ = /* another comment */ () =&gt; &#123;&#125;;console.log(bar.toString()); // () =&gt; &#123;&#125; ä¿®æ”¹ catch ç»‘å®šåœ¨ ES10 ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡è¯­æ³•ä¸º catch å­å¥ç»‘å®šå¼‚å¸¸å˜é‡ï¼Œæ— è®ºæ˜¯å¦æœ‰å¿…è¦ã€‚å¾ˆå¤šæ—¶å€™ catch å—æ˜¯å¤šä½™çš„ã€‚ ES10 ææ¡ˆä½¿æˆ‘ä»¬èƒ½å¤Ÿç®€å•çš„æŠŠå˜é‡çœç•¥æŽ‰ã€‚ ä¸ç®—å¤§çš„æ”¹åŠ¨ã€‚ ä¹‹å‰æ˜¯ 1try &#123;&#125; catch(e) &#123;&#125; çŽ°åœ¨æ˜¯ 1try &#123;&#125; catch &#123;&#125; æ–°çš„åŸºæœ¬æ•°æ®ç±»åž‹ BigIntçŽ°åœ¨çš„åŸºæœ¬æ•°æ®ç±»åž‹ï¼ˆå€¼ç±»åž‹ï¼‰ä¸æ­¢5ç§ï¼ˆES6ä¹‹åŽæ˜¯å…­ç§ï¼‰ï¼ŒåŠ ä¸Š BigInt ä¸€å…±æœ‰ä¸ƒç§åŸºæœ¬æ•°æ®ç±»åž‹ï¼Œåˆ†åˆ«æ˜¯ï¼š Stringã€Numberã€Booleanã€Nullã€Undefinedã€Symbolã€BigInt]]></content>
      <categories>
        <category>å‰ç«¯</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>ECMAScript</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Vue created ä¸Ž mounted]]></title>
    <url>%2F2020%2F11%2F09%2FVue%20created%20%E4%B8%8E%20mounted%2F</url>
    <content type="text"><![CDATA[Vue created ä¸Ž mounted åŒºåˆ« ç”Ÿå‘½å‘¨æœŸ æ˜¯å¦èŽ·å–domèŠ‚ç‚¹ æ˜¯å¦å¯ä»¥èŽ·å–data æ˜¯å¦èŽ·å–methods beforeCreate å¦ å¦ å¦ created å¦ æ˜¯ æ˜¯ beforeMount å¦ æ˜¯ æ˜¯ mounted æ˜¯ æ˜¯ æ˜¯ createdï¼šåœ¨æ¨¡æ¿æ¸²æŸ“æˆ html å‰è°ƒç”¨ï¼Œå³é€šå¸¸åˆå§‹åŒ–æŸäº›å±žæ€§å€¼ï¼Œç„¶åŽå†æ¸²æŸ“æˆè§†å›¾ã€‚ mountedï¼šåœ¨æ¨¡æ¿æ¸²æŸ“æˆ html åŽè°ƒç”¨ï¼Œé€šå¸¸æ˜¯åˆå§‹åŒ–é¡µé¢å®ŒæˆåŽï¼Œå†å¯¹ html çš„dom èŠ‚ç‚¹è¿›è¡Œä¸€äº›éœ€è¦çš„æ“ä½œã€‚ å¦‚æžœè¦ç±»ä¼¼ let ctx = document.getElementById(ID)èŽ·å– dom å…ƒç´ ï¼Œåªèƒ½ç­‰è¿™ä¸ªhtml æ¸²æŸ“å®ŒåŽæ‰å¯ä»¥è¿›è¡Œï¼Œé‚£ä¹ˆå°±ç”¨ mounted ï¼Œå¦‚æžœä¸éœ€è¦ created å³å¯ã€‚]]></content>
      <categories>
        <category>Vue</category>
      </categories>
      <tags>
        <tag>Vue</tag>
        <tag>Mixin</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa @Entityçš„å›žè°ƒæ–¹æ³•]]></title>
    <url>%2F2020%2F11%2F09%2FSpringDataJpa%E7%9A%84%40Entity%E5%9B%9E%E8%B0%83%E6%96%B9%E6%B3%95%2F</url>
    <content type="text"><![CDATA[@Entity çš„å›žè°ƒæ–¹æ³•JPA çš„ Callbacks æœ‰å“ªäº›JPA åè®®é‡Œé¢è§„å®šï¼Œå¯ä»¥é€šè¿‡ä¸€äº›æ³¨è§£ï¼Œä¸ºå…¶ç›‘å¬å›žè°ƒäº‹ä»¶ã€æŒ‡å®šå›žè°ƒæ–¹æ³•ã€‚ å›žè°ƒäº‹ä»¶æ³¨è§£è¡¨ï¼š Annotation Description @PrePersist EntityManager.persist æ–¹æ³•è°ƒç”¨ä¹‹å‰çš„å›žè°ƒæ³¨è§£ï¼Œå³æ–°å¢žä¹‹å‰è°ƒç”¨ @PostPersist EntityManager.persist æ–¹æ³•ä¹‹åŽè°ƒç”¨çš„å›žè°ƒæ³¨è§£ï¼ŒEntityManager.flush æˆ– EntityManager.commit æ–¹æ³•ä¹‹åŽè°ƒç”¨çš„æ­¤æ–¹æ³•ï¼Œå³ä¿å­˜åˆ°æ•°æ®åº“ä¹‹åŽè¿›è¡Œè°ƒç”¨ @PreRemove EntityManager.remove ä¹‹å‰è°ƒç”¨çš„å›žè°ƒæ³¨è§£ï¼Œå³åˆ é™¤ä¹‹å‰è°ƒç”¨ @PostRemove EntityManager.remove ä¹‹åŽè°ƒç”¨çš„å›žè°ƒæ³¨è§£ï¼Œå³åˆ é™¤ä¹‹åŽè°ƒç”¨ @PreUpdate åœ¨å®žä½“æ›´æ–°ä¹‹å‰è°ƒç”¨ï¼Œæ‰€è°“çš„æ›´æ–°èµ·å§‹æ˜¯åœ¨mergeä¹‹åŽï¼Œå®žä½“å‘ç”Ÿå˜åŒ–ï¼Œè¿™ä¸€æ³¨è§£å¯ä»¥åœ¨å˜åŒ–å‚¨å­˜åˆ°æ•°æ®åº“ä¹‹å‰è°ƒç”¨ @PostUpdate åœ¨å®žä½“æ›´æ–°ä¹‹åŽè°ƒç”¨ï¼Œå³å®žä½“çš„å­—æ®µçš„å€¼å˜åŒ–ä¹‹åŽï¼Œåœ¨è°ƒç”¨EntityManager.flush æˆ– EntityManager.commit æ–¹æ³•ä¹‹åŽè°ƒç”¨çš„æ­¤æ–¹æ³• @postLoad åœ¨å®žä½“ä»ŽDBåŠ è½½åˆ°ç¨‹åºé‡Œé¢ä¹‹åŽå›žè°ƒ æ³¨æ„ï¼š å›žè°ƒå‡½æ•°éƒ½æ˜¯å’Œ EntityManager.flush æˆ– EntityManager.commit åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œé¢æ‰§è¡Œçš„ï¼Œåªä¸è¿‡è°ƒç”¨æ–¹æ³•æœ‰å…ˆåŽä¹‹åˆ†ï¼Œéƒ½æ˜¯åŒæ­¥è°ƒç”¨ï¼Œæ‰€ä»¥å½“ä»»ä½•ä¸€ä¸ªå›žè°ƒæ–¹æ³•é‡Œé¢å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½ä¼šè§¦å‘äº‹åŠ¡è¿›è¡Œå›žæ»šï¼Œè€Œä¸ä¼šè§¦å‘äº‹åŠ¡æäº¤ã€‚ Callbacks æ³¨è§£å¯ä»¥æ”¾åœ¨å®žä½“é‡Œé¢ï¼Œå¯ä»¥æ”¾åœ¨ super-class é‡Œé¢ï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨ Entity çš„ listener é‡Œé¢ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ”¾åœ¨å®žä½“ï¼ˆæˆ–è€… super-classï¼‰é‡Œé¢çš„æ–¹æ³•ï¼Œç­¾åæ ¼å¼ä¸ºâ€œvoid ()â€ï¼Œå³æ²¡æœ‰å‚æ•°ï¼Œæ–¹æ³•é‡Œé¢æ“ä½œçš„æ˜¯ this å¯¹è±¡è‡ªå·±ï¼›æ”¾åœ¨å®žä½“çš„ Entity Listener é‡Œé¢çš„æ–¹æ³•ç­¾åæ ¼å¼ä¸ºâ€œvoid (Object)â€ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•å¯ä»¥æœ‰å‚æ•°ï¼Œå‚æ•°æ˜¯ä»£è¡¨ç”¨æ¥æŽ¥æ”¶å›žè°ƒæ–¹æ³•çš„å®žä½“ã€‚ ä¸Šè¿°æ³¨è§£ç”Ÿæ•ˆçš„å›žè°ƒæ–¹æ³•å¯ä»¥æ˜¯ publicã€privateã€protectedã€friendly ç±»åž‹çš„ï¼Œä½†æ˜¯ä¸èƒ½æ˜¯ static å’Œ final ç±»åž‹çš„æ–¹æ³•ã€‚ JPA Callbacks çš„ä½¿ç”¨æ–¹æ³•åœ¨å®žä½“å’Œ super-class ä¸­ä½¿ç”¨ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹ BaseEntityï¼Œåœ¨é‡Œé¢æ–°å¢žå›žè°ƒå‡½æ•°å’Œæ³¨è§£ï¼Œä»£ç å¦‚ä¸‹: 123456789101112131415161718192021222324252627282930313233343536373839404142434445package com.example.jpa.example1.base;import lombok.Data;import org.springframework.data.annotation.*;import org.springframework.data.jpa.domain.support.AuditingEntityListener;import javax.persistence.*;import java.time.Instant;@Data@MappedSuperclass@EntityListeners(AuditingEntityListener.class)public class BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id;// @CreatedBy è¿™ä¸ªå¯èƒ½ä¼šè¢« AuditingEntityListener è¦†ç›–ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå…ˆæ³¨é‡ŠæŽ‰ private Integer createUserId; @CreatedDate private Instant createTime; @LastModifiedBy private Integer lastModifiedUserId; @LastModifiedDate private Instant lastModifiedTime;// @Version ç”±äºŽæœ¬èº«æœ‰ä¹è§‚é”æœºåˆ¶ï¼Œè¿™ä¸ªæµ‹è¯•çš„æ—¶å€™å…ˆæ³¨é‡ŠæŽ‰ï¼Œæ”¹ç”¨æ‰‹åŠ¨è®¾ç½®çš„å€¼ï¼› private Integer version; @PreUpdate public void preUpdate() &#123; System.out.println("preUpdate::"+this.toString()); this.setCreateUserId(200); &#125; @PostUpdate public void postUpdate() &#123; System.out.println("postUpdate::"+this.toString()); &#125; @PreRemove public void preRemove() &#123; System.out.println("preRemove::"+this.toString()); &#125; @PostRemove public void postRemove() &#123; System.out.println("postRemove::"+this.toString()); &#125; @PostLoad public void postLoad() &#123; System.out.println("postLoad::"+this.toString()); &#125;&#125; ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº†@PreUpdateã€@PostUpdateã€@PreRemoveã€@PostRemoveã€@PostLoad å‡ ä¸ªæ³¨è§£ï¼Œå¹¶åœ¨ç›¸åº”çš„å›žè°ƒæ–¹æ³•é‡Œé¢åŠ äº†ç›¸åº”çš„æ—¥å¿—ã€‚å¹¶ä¸”åœ¨ @PreUpdate æ–¹æ³•é‡Œé¢ä¿®æ”¹äº† create_user_id çš„å€¼ä¸º 200ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åŽç»­æµ‹è¯•ã€‚ ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ä¸€ä¸‹ User ç±»ï¼Œä¹Ÿæ–°å¢žä¸¤ä¸ªå›žè°ƒå‡½æ•°ï¼Œå¹¶ä¸”å’Œ BaseEntity åšæ³•ä¸€æ · 123456789101112131415161718192021222324252627282930313233package com.example.jpa.example1;import com.example.jpa.example1.base.BaseEntity;import com.fasterxml.jackson.annotation.JsonIgnore;import lombok.*;import javax.persistence.*;import java.util.List;@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "addresses",callSuper = true)@EqualsAndHashCode(callSuper=false)public class User extends BaseEntity &#123;// implements Auditable&lt;Integer,Long, Instant&gt; &#123; private String name; private String email; @Enumerated(EnumType.STRING) private SexEnum sex; private Integer age; @OneToMany(mappedBy = "user") @JsonIgnore private List&lt;UserAddress&gt; addresses; private Boolean deleted; @PrePersist private void prePersist() &#123; System.out.println("prePersist::"+this.toString()); this.setVersion(1); &#125; @PostPersist public void postPersist() &#123; System.out.println("postPersist::"+this.toString()); &#125;&#125; ä½¿ç”¨äº† @PrePersistã€@PostPersist å›žè°ƒäº‹ä»¶ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨ @PrePersist é‡Œé¢å°† version ä¿®æ”¹ä¸º 1ã€‚ ç¬¬ä¸‰æ­¥ï¼šå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364@DataJpaTest@TestInstance(TestInstance.Lifecycle.PER_CLASS)@Import(JpaConfiguration.class)public class UserRepositoryTest &#123; @Autowired private UserRepository userRepository; @MockBean MyAuditorAware myAuditorAware; /** * ä¸ºäº†å’Œæµ‹è¯•æ–¹æ³•çš„äº‹åŠ¡åˆ†å¼€ï¼Œæˆ‘ä»¬åœ¨ init é‡Œé¢åˆå§‹åŒ–æ•°æ®åšæ–°å¢žæ“ä½œ */ @BeforeAll @Rollback(false) @Transactional public void init() &#123; //ç”±äºŽæµ‹è¯•ç”¨ä¾‹æ¨¡æ‹Ÿ web context çŽ¯å¢ƒï¼Œè¿™é‡Œåˆ©ç”¨ @MockBeanï¼ŒmockæŽ‰æ–¹æ³•ï¼ŒæœŸå¾…è¿”å›ž13è¿™ä¸ªç”¨æˆ·ID Mockito.when(myAuditorAware.getCurrentAuditor()).thenReturn(Optional.of(13)); User u1 = User.builder() .name("jack") .email("123456@126.com") .sex(SexEnum.BOY) .age(20) .build(); //æ²¡æœ‰saveä¹‹å‰ versionæ˜¯null Assertions.assertNull(u1.getVersion()); userRepository.save(u1); //è¿™é‡Œé¢è§¦å‘ä¿å­˜æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°†versionè®¾ç½®æˆäº†1ï¼Œç„¶åŽéªŒè¯ä¸€ä¸‹ Assertions.assertEquals(1,u1.getVersion()); &#125; /** * æµ‹è¯•ä¸€ä¸‹æ›´æ–°å’ŒæŸ¥è¯¢ */ @Test @Rollback(false) @Transactional public void testCallBackUpdate() &#123; //æ­¤æ—¶ä¼šè§¦å‘@PostLoadäº‹ä»¶ User u1 = userRepository.getOne(1L); //ä»Ždbé‡Œé¢é‡æ–°æŸ¥è¯¢å‡ºæ¥ï¼ŒéªŒè¯ä¸€ä¸‹versionæ˜¯ä¸æ˜¯1 Assertions.assertEquals(1,u1.getVersion()); u1.setSex(SexEnum.GIRL); //æ­¤æ—¶ä¼šè§¦å‘@PreUpdateäº‹ä»¶ userRepository.save(u1); List&lt;User&gt; u3 = userRepository.findAll(); u3.stream().forEach(u-&gt;&#123; //ä»ŽdbæŸ¥è¯¢å‡ºæ¥ï¼ŒéªŒè¯ä¸€ä¸‹CreateUserIdæ˜¯å¦ä¸ºæˆ‘ä»¬åˆšæ‰ä¿®æ”¹çš„200 Assertions.assertEquals(200,u.getCreateUserId()); &#125;); &#125; /** * æµ‹è¯•ä¸€ä¸‹åˆ é™¤äº‹ä»¶ */ @Test @Rollback(false) @Transactional public void testCallBackDelete() &#123; //æ­¤æ—¶ä¼šè§¦å‘@PostLoadäº‹ä»¶ User u1 = userRepository.getOne(1L); Assertions.assertEquals(200,u1.getCreateUserId()); userRepository.delete(u1); //æ­¤æ—¶ä¼šè§¦å‘@PreRemoveã€@PostRemoveäº‹ä»¶ System.out.println("delete_after::"); &#125;&#125; é€šè¿‡æµ‹è¯•ç”¨ä¾‹éªŒè¯äº†å›žè°ƒå‡½æ•°çš„äº‹ä»¶åŽï¼Œçœ‹ä¸€ä¸‹è¾“å‡ºçš„ SQL å’Œæ—¥å¿—ï¼š é€šè¿‡ä¸Šå›¾çš„æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°å“åº”çš„å›žè°ƒå‡½æ•°è¢«è§¦å‘äº†ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°æ‰§è¡Œé¡ºåºä¸ºï¼š ä¿å­˜ï¼šPrePersist -&gt; Insert -&gt; PostPersist æŸ¥è¯¢ï¼šSelect -&gt; PostLoad æ›´æ–°ï¼šPreUpdate -&gt; Update -&gt; PostUpdate åˆ é™¤ï¼šPreRemove -&gt; Remove -&gt; PostRemove è‹¥å›žè°ƒå‡½æ•°é‡Œé¢å‘ç”Ÿå¼‚å¸¸ï¼Œæ•°æ®ä¼šå›žæ»šï¼Œå¦‚åœ¨@PostPersistçš„æ–¹æ³•é‡ŒæŠ›å¼‚å¸¸ 12345@PostPersistpublic void postPersist() &#123; System.out.println("postPersist::"+this.toString()); throw new RuntimeException("jack test exception transactional roll back");&#125; å†è·‘æµ‹è¯•ç”¨ä¾‹å°±ä¼šå‘çŽ°ï¼Œå…¶ä¸­å‘ç”Ÿäº† RollbackException å¼‚å¸¸ï¼Œè¿™æ ·çš„è¯æ•°æ®æ˜¯ä¸ä¼šæäº¤åˆ° DB é‡Œé¢çš„ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´æ•°æ®è¿›è¡Œå›žæ»šï¼ŒåŽé¢çš„ä¸šåŠ¡æµç¨‹æ— æ³•æ‰§è¡Œä¸‹åŽ»ã€‚ 12Could not commit JPA transaction; nested exception is javax.persistence.RollbackException: Error while committing the transactionorg.springframework.transaction.TransactionSystemException: Could not commit JPA transaction; nested exception is javax.persistence.RollbackException: Error while committing the transaction æ‰€ä»¥åœ¨ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œä½ è¦æ³¨æ„è€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œé¿å…ä¸å¿…è¦çš„éº»çƒ¦ã€‚ è‡ªå®šä¹‰ EntityListenerç¬¬ä¸€æ­¥ï¼šè‡ªå®šä¹‰ä¸€ä¸ª EntityLoggingListener ç”¨æ¥è®°å½•æ“ä½œæ—¥å¿—ï¼Œé€šè¿‡ listener çš„æ–¹å¼é…ç½®å›žè°ƒå‡½æ•°æ³¨è§£ 12345678910111213141516171819202122232425262728293031323334353637383940package com.example.jpa.example1.base;import com.example.jpa.example1.User;import lombok.extern.log4j.Log4j2;import javax.persistence.*;@Log4j2public class EntityLoggingListener &#123; @PrePersist private void prePersist(BaseEntity entity) &#123; //entity.setVersion(1); å¦‚æžœæ³¨é‡Šäº†ï¼Œæµ‹è¯•ç”¨ä¾‹è¿™ä¸ªåœ°æ–¹çš„éªŒè¯ä¹Ÿéœ€è¦åŽ»æŽ‰ log.info("prePersist::&#123;&#125;",entity.toString()); &#125; @PostPersist public void postPersist(Object entity) &#123; log.info("postPersist::&#123;&#125;",entity.toString()); &#125; @PreUpdate public void preUpdate(BaseEntity entity) &#123; //entity.setCreateUserId(200); å¦‚æžœæ³¨é‡Šäº†ï¼Œæµ‹è¯•ç”¨ä¾‹è¿™ä¸ªåœ°æ–¹çš„éªŒè¯ä¹Ÿéœ€è¦åŽ»æŽ‰ log.info("preUpdate::&#123;&#125;",entity.toString()); &#125; @PostUpdate public void postUpdate(Object entity) &#123; log.info("postUpdate::&#123;&#125;",entity.toString()); &#125; @PreRemove public void preRemove(Object entity) &#123; log.info("preRemove::&#123;&#125;",entity.toString()); &#125; @PostRemove public void postRemove(Object entity) &#123; log.info("postRemove::&#123;&#125;",entity.toString()); &#125; @PostLoad public void postLoad(Object entity) &#123; //æŸ¥è¯¢æ–¹æ³•é‡Œé¢å¯ä»¥å¯¹ä¸€äº›æ•æ„Ÿä¿¡æ¯åšä¸€äº›æ—¥å¿— if (User.class.isInstance(entity)) &#123; log.info("postLoad::&#123;&#125;",entity.toString()); &#125; &#125;&#125; åœ¨è¿™ä¸€æ­¥éª¤ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼š ä¸Šé¢æ³¨é‡Šçš„ä»£ç ï¼Œä¹Ÿå¯ä»¥æ”¹å˜ entity é‡Œé¢çš„å€¼ï¼Œä½†æ˜¯åœ¨è¿™ä¸ª Listener çš„é‡Œé¢æˆ‘ä»¬ä¸åšä¿®æ”¹ï¼Œæ‰€ä»¥æŠŠ setVersion å’Œ setCreateUserId æ³¨é‡ŠæŽ‰äº†ï¼Œè¦æ³¨æ„æµ‹è¯•ç”¨ä¾‹é‡Œé¢è¿™ä¸¤å¤„ä¹Ÿéœ€è¦ä¿®æ”¹ã€‚ å¦‚æžœåœ¨ @PostLoad é‡Œé¢è®°å½•æ—¥å¿—ï¼Œä¸ä¸€å®šæ¯ä¸ªå®žä½“ã€æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦è®°å½•æ—¥å¿—ï¼Œåªéœ€è¦å¯¹ä¸€äº›æ•æ„Ÿçš„å®žä½“æˆ–è€…å­—æ®µåšæ—¥å¿—è®°å½•å³å¯ã€‚ å›žè°ƒå‡½æ•°æ—¶å¯ä»¥åŠ ä¸Šå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥æ˜¯çˆ¶ç±» Objectï¼Œå¯ä»¥æ˜¯ BaseEntityï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“çš„æŸä¸€ä¸ªå®žä½“ï¼›æŽ¨èç”¨ BaseEntityï¼Œå› ä¸ºè¿™æ ·çš„æ–¹æ³•æ˜¯ç±»åž‹å®‰å…¨çš„ï¼Œå®ƒå¯ä»¥çº¦å®šä¸€äº›æ¡†æž¶é€»è¾‘ï¼Œæ¯”å¦‚ getCreateUserIdã€getLastModifiedUserId ç­‰ã€‚ ç¬¬äºŒæ­¥ï¼šå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚ è¿™æ¬¡æ‰§è¡Œ testCallBackDelete()ï¼Œçœ‹çœ‹ä¼šå¾—åˆ°ä»€ä¹ˆæ ·çš„æ•ˆæžœã€‚ 123452020-10-05 13:55:19.332 INFO 62541 --- [ Test worker] c.e.j.e.base.EntityLoggingListener : prePersist::User(super=BaseEntity(id=null, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=null), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)2020-10-05 13:55:19.449 INFO 62541 --- [ Test worker] c.e.j.e.base.EntityLoggingListener : postPersist::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)2020-10-05 13:55:19.698 INFO 62541 --- [ Test worker] c.e.j.e.base.EntityLoggingListener : postLoad::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)2020-10-05 13:55:19.719 INFO 62541 --- [ Test worker] c.e.j.e.base.EntityLoggingListener : preRemove::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null)2020-10-05 13:55:19.798 INFO 62541 --- [ Test worker] c.e.j.e.base.EntityLoggingListener : postRemove::User(super=BaseEntity(id=1, createUserId=13, createTime=2020-10-05T05:55:19.246Z, lastModifiedUserId=13, lastModifiedTime=2020-10-05T05:55:19.246Z, version=0), name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null) é€šè¿‡æ—¥å¿—æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ° callback æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼ŒåŠå…¶å®žä½“å‚æ•°çš„å€¼ã€‚ä½ å°±ä¼šå‘çŽ°ï¼ŒåŽŸæ¥è‡ªå®šä¹‰ EntityListener å›žè°ƒå‡½æ•°çš„æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ç®€å•ã€‚ ç»†å¿ƒçš„ä½ è¿™ä¸ªæ—¶å€™å¯èƒ½ä¹Ÿä¼šå‘çŽ°ï¼Œæˆ‘ä»¬ä¸Šé¢å…¶å®žåº”ç”¨äº†ä¸¤ä¸ª EntityListenerï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ @EntityListeners æœ‰ä¸ªåŠ è½½é¡ºåºçš„é—®é¢˜ï¼Œä½ éœ€è¦é‡ç‚¹æ³¨æ„ä¸€ä¸‹ã€‚ å…³äºŽ @EntityListeners åŠ è½½é¡ºåºçš„è¯´æ˜Ž é»˜è®¤å¦‚æžœå­ç±»å’Œçˆ¶ç±»éƒ½æœ‰ EntityListenersï¼Œé‚£ä¹ˆ listeners ä¼šæŒ‰ç…§åŠ è½½çš„é¡ºåºæ‰§è¡Œæ‰€æœ‰ EntityListenersï¼› EntityListeners å’Œå®žä½“é‡Œé¢çš„å›žè°ƒå‡½æ•°æ³¨è§£å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œä½†éœ€è¦æ³¨æ„é¡ºåºé—®é¢˜ï¼› å¦‚æžœæˆ‘ä»¬ä¸æƒ³åŠ è½½ super-class é‡Œé¢çš„EntityListenersï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨è§£ @ExcludeSuperclassListenersï¼ŒæŽ’é™¤æ‰€æœ‰çˆ¶ç±»é‡Œé¢çš„å®žä½“ç›‘å¬è€…ï¼Œéœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†åœ¨å­ç±»å®žä½“é‡Œé¢é‡æ–°å¼•å…¥å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234@ExcludeSuperclassListenerspublic class User extends BaseEntity &#123;......&#125; JPA Callbacks çš„æœ€ä½³å®žè·µä¸ªäººç»éªŒæ€»ç»“äº†å‡ ä¸ªæœ€ä½³å®žè·µ å›žè°ƒå‡½æ•°é‡Œé¢åº”å°½é‡é¿å…ç›´æŽ¥æ“ä½œä¸šåŠ¡ä»£ç ï¼Œæœ€å¥½ç”¨ä¸€äº›å…·æœ‰æ¡†æž¶æ€§çš„å…¬ç”¨ä»£ç ï¼Œå¦‚ Auditing æˆ– å®žä½“æ“ä½œæ—¥å¿— ç­‰ï¼› æ³¨æ„å›žè°ƒå‡½æ•°æ–¹æ³•è¦åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡Œï¼Œå¼‚å¸¸è¦å¯é¢„æœŸï¼Œéžå¯é¢„æœŸçš„å¼‚å¸¸è¦è¿›è¡Œæ•èŽ·ï¼Œä»¥å…å‡ºçŽ°æ„æƒ³ä¸åˆ°çš„çº¿ä¸Š Bugï¼› å›žè°ƒå‡½æ•°æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œå¦‚æžœä¸€äº›è®¡ç®—é‡å¤§çš„å’Œä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡å‘æ¶ˆæ¯ç­‰æœºåˆ¶å¼‚æ­¥å¤„ç†ï¼Œä»¥å…é˜»å¡žä¸»æµç¨‹ï¼Œå½±å“æŽ¥å£çš„æ€§èƒ½ã€‚æ¯”å¦‚ä¸Šé¢è¯´çš„æ—¥å¿—ï¼Œå¦‚æžœæˆ‘ä»¬è¦å°†å…¶è®°å½•åˆ°æ•°æ®åº“é‡Œé¢ï¼Œå¯ä»¥åœ¨å›žè°ƒæ–¹æ³•é‡Œé¢å‘ä¸ªæ¶ˆæ¯ï¼Œæ”¹è¿›ä¹‹åŽå°†å˜æˆå¦‚ä¸‹æ ¼å¼ï¼š 123456789101112131415161718192021222324252627282930public class AuditLoggingListener &#123; @PostLoad private void postLoad(Object entity) &#123; this.notice(entity, OperateType.load); &#125; @PostPersist private void postPersist(Object entity) &#123; this.notice(entity, OperateType.create); &#125; @PostRemove private void PostRemove(Object entity) &#123; this.notice(entity, OperateType.remove); &#125; @PostUpdate private void PostUpdate(Object entity) &#123; this.notice(entity, OperateType.update); &#125; private void notice(Object entity, OperateType type) &#123; //æˆ‘ä»¬é€šè¿‡active mq å¼‚æ­¥å‘å‡ºæ¶ˆæ¯å¤„ç†äº‹ä»¶ ActiveMqEventManager.notice(new ActiveMqEvent(type, entity)); &#125; @Getter enum OperateType &#123; create("åˆ›å»º"), remove("åˆ é™¤"),update("ä¿®æ”¹"),load("æŸ¥è¯¢"); private final String description; OperateType(String description) &#123; this.description=description; &#125; &#125;&#125; åœ¨å›žè°ƒå‡½æ•°é‡Œé¢ï¼Œå°½é‡ä¸è¦ç›´æŽ¥åœ¨æ“ä½œ EntityManager åŽå†åš session çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å…¶ä»–æŒä¹…åŒ–æ“ä½œï¼Œä»¥å…ç ´åäº‹åŠ¡çš„å¤„ç†æµç¨‹ï¼›ä¹Ÿä¸è¦è¿›è¡Œå…¶ä»–é¢å¤–çš„å…³è”å…³ç³»æ›´æ–°åŠ¨ä½œï¼Œä¸šåŠ¡æ€§çš„ä»£ç ä¸€å®šè¦æ”¾åœ¨ service å±‚é¢ï¼Œå¦åˆ™å¤ªè¿‡å¤æ‚ï¼Œæ—¶é—´é•¿äº†ä»£ç å¾ˆéš¾ç»´æŠ¤ï¼› å›žè°ƒå‡½æ•°é‡Œé¢æ¯”è¾ƒé€‚åˆç”¨ä¸€äº›è®¡ç®—åž‹çš„transientæ–¹æ³•ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªæ“ä½œï¼š 1234567public class UserListener &#123; @PrePersist public void prePersist(User user) &#123; //é€šè¿‡ä¸€äº›é€»è¾‘è®¡ç®—å¹´é¾„ï¼› user.calculationAge(); &#125;&#125; JPA å®˜æ–¹æ¯”è¾ƒå»ºè®®æ”¾ä¸€äº›é»˜è®¤å€¼ï¼Œä½†æ˜¯æˆ‘ä¸æ˜¯ç‰¹åˆ«èµžåŒï¼Œå› ä¸ºè§‰å¾—é‚£æ ·ä¸å¤Ÿç›´è§‚ï¼Œç›´æŽ¥ç”¨å­—æ®µåˆå§‹åŒ–å°±å¯ä»¥äº†ï¼Œæ²¡å¿…è¦åœ¨å›žè°ƒå‡½æ•°é‡Œé¢æ”¾ç½®é»˜è®¤å€¼ã€‚ é™¤äº†æ—¥å¿—ï¼Œå…¶ä»–å…¬ç”¨çš„åœºæ™¯ä¸å¤šã€‚å½“é‡åˆ°å…¶ä»–åœºæ™¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„å®žä½“å®žé™…æƒ…å†µåˆ¶å®šè‡ªå·±ç‹¬æœ‰çš„ EntityListener æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š 12345678910@Entity@EntityListeners(UserListener.class)public class User extends BaseEntity &#123;// implements Auditable&lt;Integer,Long, Instant&gt; &#123; @Transient public void calculationAge() &#123; //é€šè¿‡ä¸€äº›é€»è¾‘è®¡ç®—å¹´é¾„ï¼› this.age=10; &#125; ......//å…¶ä»–ä¸é‡è¦çš„çœç•¥&#125; ä¾‹å¦‚ï¼ŒUser ä¸­æˆ‘ä»¬æœ‰ä¸ªè®¡ç®—å¹´é¾„çš„é€»è¾‘è¦ç‹¬ç«‹è°ƒç”¨ï¼Œå°±å¯ä»¥åœ¨æŒä¹…åŒ–ä¹‹å‰è°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ–°å»ºä¸€ä¸ªè‡ªå·±çš„ UserListener å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567public class UserListener &#123; @PrePersist public void prePersist(User user) &#123; //é€šè¿‡ä¸€äº›é€»è¾‘è®¡ç®—å¹´é¾„ï¼› user.calculationAge(); &#125;&#125; JPA Callbacks çš„å®žçŽ°åŽŸç†ï¼Œäº‹ä»¶æœºåˆ¶Java Persistence API è§„å®šï¼šJPA çš„å®žçŽ°æ–¹éœ€è¦å®žçŽ°åŠŸèƒ½ï¼Œéœ€è¦æ”¯æŒå›žè°ƒäº‹ä»¶æ³¨è§£ï¼›è€Œ Hibernate å†…éƒ¨è´Ÿè´£å®žçŽ°ï¼ŒHibernate å†…éƒ¨ç»´æŠ¤äº†ä¸€å¥—å®žä½“çš„ EventTypeï¼Œå…¶å†…éƒ¨åŒ…å«äº†å„ç§å›žè°ƒäº‹ä»¶ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹ï¼š 123456789public static final EventType&lt;PreLoadEventListener&gt; PRE_LOAD = create( "pre-load", PreLoadEventListener.class );public static final EventType&lt;PreDeleteEventListener&gt; PRE_DELETE = create( "pre-delete", PreDeleteEventListener.class );public static final EventType&lt;PreUpdateEventListener&gt; PRE_UPDATE = create( "pre-update", PreUpdateEventListener.class );public static final EventType&lt;PreInsertEventListener&gt; PRE_INSERT = create( "pre-insert", PreInsertEventListener.class );public static final EventType&lt;PostLoadEventListener&gt; POST_LOAD = create( "post-load", PostLoadEventListener.class );public static final EventType&lt;PostDeleteEventListener&gt; POST_DELETE = create( "post-delete", PostDeleteEventListener.class );public static final EventType&lt;PostUpdateEventListener&gt; POST_UPDATE = create( "post-update", PostUpdateEventListener.class );public static final EventType&lt;PostInsertEventListener&gt; POST_INSERT = create( "post-insert", PostInsertEventListener.class );æ›´å¤šçš„äº‹ä»¶ç±»åž‹ï¼Œä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ org.hibernate.event.spi.EventType ç±»ï¼Œäº†è§£æ›´å¤šï¼›åœ¨ session factory æž„å»ºçš„æ—¶å€™ï¼ŒEventListenerRegistryImpl è´Ÿè´£æ³¨å†Œè¿™äº›äº‹ä»¶ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ debug çš„å…³é”®èŠ‚ç‚¹ï¼š è¿™éƒ¨åˆ†åŽŸç†ä¸å¸¸ç”¨ï¼ŒçŸ¥é“æœ‰è¿™ä¹ˆå›žäº‹å³å¯]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¾è®¡æ¨¡å¼]]></title>
    <url>%2F2020%2F11%2F09%2F%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%2F</url>
    <content type="text"><![CDATA[ç®€å•å·¥åŽ‚æ¨¡å¼åˆå«åšé™æ€å·¥åŽ‚æ–¹æ³•ï¼ˆStatic Factory Methodï¼‰ ç®€å•å·¥åŽ‚æ¨¡å¼çš„å®žè´¨æ˜¯ç”±ä¸€ä¸ªå·¥åŽ‚ç±»æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼ŒåŠ¨æ€å†³å®šåº”è¯¥åˆ›å»ºå“ªä¸€ä¸ªäº§å“ç±»ã€‚ Spring ä¸­çš„BeanFactoryå°±æ˜¯ç®€å•å·¥åŽ‚æ¨¡å¼çš„ä½“çŽ°ï¼Œæ ¹æ®ä¼ å…¥ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†æ¥èŽ·å¾—beanå¯¹è±¡ï¼Œä½†æ˜¯å¦æ˜¯åœ¨ä¼ å…¥å‚æ•°åŽåˆ›å»ºè¿˜æ˜¯ä¼ å…¥å‚æ•°å‰åˆ›å»ºè¿™ä¸ªè¦æ ¹æ®å…·ä½“æƒ…å†µæ¥å®šã€‚å¦‚ä¸‹é…ç½®ï¼Œå°±æ˜¯åœ¨ HelloItxxz ç±»ä¸­åˆ›å»ºä¸€ä¸ª itxxzBeanã€‚ 123456789101112&lt;beans&gt; &lt;bean id="singletonBean" class="com.itxxz.HelloItxxz"&gt; &lt;constructor-arg&gt; &lt;value&gt;Hello! è¿™æ˜¯singletonBean&lt;/value&gt; &lt;/constructor-arg&gt; &lt;/bean&gt; &lt;bean id="itxxzBean" class="com.itxxz.HelloItxxz" singleton="false"&gt; &lt;constructor-arg&gt; &lt;value&gt;Hello! è¿™æ˜¯itxxzBean! &lt;/value&gt; &lt;/constructor-arg&gt; &lt;/bean&gt;&lt;/beans&gt; å•ä¾‹æ¨¡å¼æ‡’æ±‰æ¨¡å¼çº¿ç¨‹ä¸å®‰å…¨å®žçŽ° 123456789101112public class Singleton &#123; private static Singleton instance; private Singleton() &#123;&#125; public static Singleton getInstance() &#123; if (instance == null) &#123; instance = new Singleton(); &#125; return instance; &#125;&#125; åŒé‡æ£€æŸ¥æ¨¡å¼å®žçŽ° 12345678910111213141516public class Singleton &#123; private static volatile Singleton singleton; private Singleton() &#123;&#125; public static Singleton getSingleton() &#123; if (singleton == null) &#123; synchronized (Singleton.class) &#123; if (singleton == null) &#123; singleton = new Singleton(); &#125; &#125; &#125; return singleton; &#125;&#125; é¥¿æ±‰å•ä¾‹æ¨¡å¼123456789public class Singleton &#123; private static final Singleton instance = new Singleton(); private Singleton() &#123;&#125; public static Singleton getInstance() &#123; return instance; &#125;&#125; æžšä¸¾å•ä¾‹æ¨¡å¼123public enum Singleton &#123; INSTANCE;&#125; ç­–ç•¥æ¨¡å¼ ( Strategy Pattern )å®šä¹‰è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚ ä¼˜ç‚¹ ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è¯­å¥ ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç³»åˆ—çš„å¯ä¾›é‡ç”¨çš„ç®—æ³•æ—ï¼Œæ°å½“ä½¿ç”¨ç»§æ‰¿å¯ä»¥æŠŠç®—æ³•æ—çš„å…¬å…±ä»£ç è½¬ç§»åˆ°çˆ¶ç±»é‡Œé¢ï¼Œä»Žè€Œé¿å…é‡å¤çš„ä»£ç  ç­–ç•¥æ¨¡å¼å¯ä»¥æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸åŒå®žçŽ°ï¼Œå®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæ—¶é—´æˆ–ç©ºé—´è¦æ±‚é€‰æ‹©ä¸åŒçš„ ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŽŸåˆ™çš„å®Œç¾Žæ”¯æŒï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŽŸä»£ç çš„æƒ…å†µä¸‹ï¼Œçµæ´»å¢žåŠ æ–°ç®—æ³• ç­–ç•¥æ¨¡å¼æŠŠç®—æ³•çš„ä½¿ç”¨æ”¾åˆ°çŽ¯å¢ƒç±»ä¸­ï¼Œè€Œç®—æ³•çš„å®žçŽ°ç§»åˆ°å…·ä½“ç­–ç•¥ç±»ä¸­ï¼Œå®žçŽ°äº†äºŒè€…çš„åˆ†ç¦» ç¼ºç‚¹ å®¢æˆ·ç«¯å¿…é¡»ç†è§£æ‰€æœ‰ç­–ç•¥ç®—æ³•çš„åŒºåˆ«ï¼Œä»¥ä¾¿é€‚æ—¶é€‰æ‹©æ°å½“çš„ç®—æ³•ç±» ç­–ç•¥æ¨¡å¼é€ æˆå¾ˆå¤šçš„ç­–ç•¥ç±» å®žçŽ°ç»§æ‰¿å®žçŽ°å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¼ºåˆ¶å­ç±»å®žçŽ°è¯¥æ–¹æ³• è¿™ç§å®žçŽ°ï¼Œå¯¹çˆ¶ç±»å¯¹å­ç±»ä¸ä¸€å®šæ˜¯é€æ˜Žçš„ï¼Œå¦‚æžœçˆ¶ç±»æä¾›äº†é»˜è®¤çš„å®žçŽ°ï¼Œå­ç±»éœ€è¦äº†è§£å®žçŽ°çš„ç»†èŠ‚ï¼Œå†å†³å®šæ˜¯å¦é‡å†™ 123456789101112131415161718public abstract class Action &#123; // ä¹Ÿå¯ä»¥å°†è¯¥æ–¹æ³•è®¾ç½®æˆæŠ½è±¡æ–¹æ³•ï¼Œ å¼ºè¿«å­ç±»æ¥å®žçŽ°è¯¥æ–¹æ³• public void execute() &#123; // æä¾›ä¸€ä¸ªé»˜è®¤çš„å®žçŽ° &#125;&#125;public class ActionModelA extends Action &#123; public void execute() &#123; aStyleBrake();// A é£Žæ ¼çš„è¡Œä¸º &#125;&#125;public class ActionModelB extends Action &#123; public void execute() &#123; bStyleBrake(); // B é£Žæ ¼çš„è¡Œä¸º &#125;&#125; ç»„åˆå®žçŽ°è¿™ç§å®žçŽ°æ˜¯é€æ˜Žçš„ï¼Œåªéœ€è¦æ”¹å˜å¯¹è±¡çš„å¼•ç”¨å°±å¯ä»¥æ”¹å˜å…¶è¡Œä¸ºã€‚ 123456789101112131415161718192021222324252627public interface IBrakeBehavior &#123; void execute();&#125;public class AStyleBrake implements IBrakeBehavior &#123; public void execute() &#123; aStyleBrake(); // A é£Žæ ¼çš„è¡Œä¸º &#125;&#125;public class BStyleBrake implements IBrakeBehavior &#123; public void execute() &#123; bStyleBrake(); // B é£Žæ ¼çš„è¡Œä¸º &#125;&#125;public class Action &#123; protected IBrakeBehavior brakeBehavior; public void execute() &#123; brakeBehavior.execute(); &#125; public void setBrakeBehavior(final IBrakeBehavior brakeType) &#123; this.brakeBehavior = brakeType; &#125;&#125; æœ€åŽé€šè¿‡å·¥åŽ‚ç±»ï¼Œæ ¹æ®è¿è¡Œçš„å‚æ•°é€‰æ‹©å‡ºå¯¹åº”çš„å®žçŽ° 1Action action = ActionFactory.createAction(String parameters); action.execute(); åªæœ‰åœ¨ç­–ç•¥é€‰æ‹©é‡Œæœ‰æ¡ä»¶é€‰æ‹©è¯­å¥ï¼Œå…¶ä»–åœ°æ–¹ä¸å‡ºçŽ°ã€‚ å¦‚ä¸Šè¿°çš„createAction()æ–¹æ³• é€‚é…å™¨æ¨¡å¼ ( Adapter Pattern )å®šä¹‰å°†ä¸€ä¸ªç±»çš„æŽ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæŽ¥å£ï¼Œä½¿å¾—åŽŸæœ¬ç”±äºŽæŽ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œã€‚åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š ç±»é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸Žé€‚é…è€…ä¹‹é—´æ˜¯ç»§æ‰¿ï¼ˆæˆ–å®žçŽ°ï¼‰å…³ç³» å¯¹è±¡é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸Žé€‚é…è€…ä¹‹é—´æ˜¯å…³è”å…³ç³» å‰è€…çš„è€¦åˆåº¦æ¯”åŽè€…é«˜ï¼Œä¸”è¦æ±‚å¼€å‘äº†è§£çŽ°æœ‰ç»„ä»¶åº“ä¸­çš„ç›¸å…³ç»„ä»¶çš„å†…éƒ¨ç»“æž„ï¼Œåº”ç”¨ç›¸å¯¹è¾ƒå°‘äº›ã€‚ ä¼˜ç‚¹ å°†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»è§£è€¦ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªé€‚é…å™¨ç±»æ¥é‡ç”¨çŽ°æœ‰çš„é€‚é…è€…ç±»ï¼Œè€Œæ— é¡»ä¿®æ”¹åŽŸæœ‰ä»£ç ã€‚ å¢žåŠ äº†ç±»çš„é€æ˜Žæ€§å’Œå¤ç”¨æ€§ï¼Œå°†å…·ä½“çš„å®žçŽ°å°è£…åœ¨é€‚é…è€…ç±»ä¸­ï¼Œå¯¹äºŽå®¢æˆ·ç«¯ç±»æ¥è¯´æ˜¯é€æ˜Žçš„ï¼Œè€Œä¸”æé«˜äº†é€‚é…è€…çš„å¤ç”¨æ€§ã€‚ çµæ´»æ€§å’Œæ‰©å±•æ€§éƒ½éžå¸¸å¥½ï¼Œé€šè¿‡ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›´æ¢é€‚é…å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹åŽŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šå¢žåŠ æ–°çš„é€‚é…å™¨ç±»ï¼Œå®Œå…¨ç¬¦åˆâ€œå¼€é—­åŽŸåˆ™â€ã€‚ ç±»é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š ç”±äºŽé€‚é…å™¨ç±»æ˜¯é€‚é…è€…ç±»çš„å­ç±»ï¼Œå› æ­¤å¯ä»¥åœ¨é€‚é…å™¨ç±»ä¸­ç½®æ¢ä¸€äº›é€‚é…è€…çš„æ–¹æ³•ï¼Œä½¿å¾—é€‚é…å™¨çš„çµæ´»æ€§æ›´å¼ºã€‚ å¯¹è±¡é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š åŒä¸€ä¸ªé€‚é…å™¨å¯ä»¥æŠŠé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æŽ¥å£ã€‚ ç¼ºç‚¹ç±»é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š å¯¹äºŽ Java ç­‰ä¸æ”¯æŒå¤šé‡ç»§æ‰¿çš„è¯­è¨€ï¼Œä¸€æ¬¡æœ€å¤šåªèƒ½é€‚é…ä¸€ä¸ªé€‚é…è€…ç±»ï¼Œè€Œä¸”ç›®æ ‡æŠ½è±¡ç±»åªèƒ½ä¸ºæŠ½è±¡ç±»ï¼Œä¸èƒ½ä¸ºå…·ä½“ç±»ï¼Œå…¶ä½¿ç”¨æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œä¸èƒ½å°†ä¸€ä¸ªé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æŽ¥å£ã€‚ å¯¹è±¡é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š ä¸Žç±»é€‚é…å™¨æ¨¡å¼ç›¸æ¯”ï¼Œè¦æƒ³ç½®æ¢é€‚é…è€…ç±»çš„æ–¹æ³•å°±ä¸å®¹æ˜“ã€‚å¦‚æžœä¸€å®šè¦ç½®æ¢æŽ‰é€‚é…è€…ç±»çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹æ³•ï¼Œå°±åªå¥½å…ˆåšä¸€ä¸ªé€‚é…è€…ç±»çš„å­ç±»ï¼Œå°†é€‚é…è€…ç±»çš„æ–¹æ³•ç½®æ¢æŽ‰ï¼Œç„¶åŽå†æŠŠé€‚é…è€…ç±»çš„å­ç±»å½“åšçœŸæ­£çš„é€‚é…è€…è¿›è¡Œé€‚é…ï¼Œå®žçŽ°è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ã€‚ å®žçŽ°è§’è‰² Targetï¼ˆç›®æ ‡æŠ½è±¡ç±»ï¼‰ï¼šç›®æ ‡æŠ½è±¡ç±»å®šä¹‰å®¢æˆ·æ‰€éœ€æŽ¥å£ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–æŽ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“ç±»ã€‚ Adapterï¼ˆé€‚é…å™¨ç±»ï¼‰ï¼šé€‚é…å™¨å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªæŽ¥å£ï¼Œä½œä¸ºä¸€ä¸ªè½¬æ¢å™¨ï¼Œå¯¹ Adaptee å’Œ Target è¿›è¡Œé€‚é…ï¼Œé€‚é…å™¨ç±»æ˜¯é€‚é…å™¨æ¨¡å¼çš„æ ¸å¿ƒï¼Œåœ¨å¯¹è±¡é€‚é…å™¨ä¸­ï¼Œå®ƒé€šè¿‡ç»§æ‰¿ Target å¹¶å…³è”ä¸€ä¸ª Adaptee å¯¹è±¡ä½¿äºŒè€…äº§ç”Ÿè”ç³»ã€‚ Adapteeï¼ˆé€‚é…è€…ç±»ï¼‰ï¼šé€‚é…è€…å³è¢«é€‚é…çš„è§’è‰²ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æŽ¥å£ï¼Œè¿™ä¸ªæŽ¥å£éœ€è¦é€‚é…ï¼Œé€‚é…è€…ç±»ä¸€èˆ¬æ˜¯ä¸€ä¸ªå…·ä½“ç±»ï¼ŒåŒ…å«äº†å®¢æˆ·å¸Œæœ›ä½¿ç”¨çš„ä¸šåŠ¡æ–¹æ³•ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ²¡æœ‰é€‚é…è€…ç±»çš„æºä»£ç ã€‚ ç±»é€‚é…å™¨é¦–å…ˆæœ‰ä¸€ä¸ªå·²å­˜åœ¨çš„å°†è¢«é€‚é…çš„ç±»ï¼š 12345public class Adaptee &#123; public void adapteeRequest() &#123; System.out.println("è¢«é€‚é…è€…çš„æ–¹æ³•"); &#125;&#125; å®šä¹‰ä¸€ä¸ªç›®æ ‡æŽ¥å£ï¼š 123public interface Target &#123; void request();&#125; å¦‚æžœé€šè¿‡ä¸€ä¸ªé€‚é…å™¨ç±»ï¼Œå®žçŽ° Target æŽ¥å£ï¼ŒåŒæ—¶ç»§æ‰¿äº† Adaptee ç±»ï¼Œç„¶åŽåœ¨å®žçŽ°çš„ request() æ–¹æ³•ä¸­è°ƒç”¨çˆ¶ç±»çš„ adapteeRequest() å³å¯å®žçŽ° 12345678public class Adapter extends Adaptee implements Target&#123; @Override public void request() &#123; //...ä¸€äº›æ“ä½œ... super.adapteeRequest(); //...ä¸€äº›æ“ä½œ... &#125;&#125; å¯¹è±¡é€‚é…å™¨å¯¹è±¡é€‚é…å™¨ä¸Žç±»é€‚é…å™¨ä¸åŒä¹‹å¤„åœ¨äºŽï¼Œç±»é€‚é…å™¨é€šè¿‡ç»§æ‰¿æ¥å®Œæˆé€‚é…ï¼Œå¯¹è±¡é€‚é…å™¨åˆ™æ˜¯é€šè¿‡å…³è”æ¥å®Œæˆï¼Œè¿™é‡Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ Adapter ç±»å³å¯å°†è½¬å˜ä¸ºå¯¹è±¡é€‚é…å™¨ 1234567891011public class Adapter implements Target&#123; // é€‚é…è€…æ˜¯å¯¹è±¡é€‚é…å™¨çš„ä¸€ä¸ªå±žæ€§ private Adaptee adaptee = new Adaptee(); @Override public void request() &#123; //... adaptee.adapteeRequest(); //... &#125;&#125; è£…é¥°å™¨æ¨¡å¼åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬çš„é¡¹ç›®éœ€è¦è¿žæŽ¥å¤šä¸ªæ•°æ®åº“ï¼Œè€Œä¸”ä¸åŒçš„å®¢æˆ·åœ¨æ¯æ¬¡è®¿é—®ä¸­æ ¹æ®éœ€è¦ä¼šåŽ»è®¿é—®ä¸åŒçš„æ•°æ®åº“ã€‚æˆ‘ä»¬ä»¥å¾€åœ¨springå’Œhibernateæ¡†æž¶ä¸­æ€»æ˜¯é…ç½®ä¸€ä¸ªæ•°æ®æºï¼Œå› è€ŒsessionFactoryçš„dataSourceå±žæ€§æ€»æ˜¯æŒ‡å‘è¿™ä¸ªæ•°æ®æºå¹¶ä¸”æ’å®šä¸å˜ï¼Œæ‰€æœ‰DAOåœ¨ä½¿ç”¨sessionFactoryçš„æ—¶å€™éƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ•°æ®æºè®¿é—®æ•°æ®åº“ã€‚ ä½†æ˜¯çŽ°åœ¨ï¼Œç”±äºŽé¡¹ç›®çš„éœ€è¦ï¼Œæˆ‘ä»¬çš„DAOåœ¨è®¿é—®sessionFactoryçš„æ—¶å€™éƒ½ä¸å¾—ä¸åœ¨å¤šä¸ªæ•°æ®æºä¸­ä¸æ–­åˆ‡æ¢ï¼Œé—®é¢˜å°±å‡ºçŽ°äº†ï¼šå¦‚ä½•è®©sessionFactoryåœ¨æ‰§è¡Œæ•°æ®æŒä¹…åŒ–çš„æ—¶å€™ï¼Œæ ¹æ®å®¢æˆ·çš„éœ€æ±‚èƒ½å¤ŸåŠ¨æ€åˆ‡æ¢ä¸åŒçš„æ•°æ®æºï¼Ÿæˆ‘ä»¬èƒ½ä¸èƒ½åœ¨springçš„æ¡†æž¶ä¸‹é€šè¿‡å°‘é‡ä¿®æ”¹å¾—åˆ°è§£å†³ï¼Ÿæ˜¯å¦æœ‰ä»€ä¹ˆè®¾è®¡æ¨¡å¼å¯ä»¥åˆ©ç”¨å‘¢ï¼Ÿ é¦–å…ˆæƒ³åˆ°åœ¨springçš„applicationContextä¸­é…ç½®æ‰€æœ‰çš„dataSourceã€‚è¿™äº›dataSourceå¯èƒ½æ˜¯å„ç§ä¸åŒç±»åž‹çš„ï¼Œæ¯”å¦‚ä¸åŒçš„æ•°æ®åº“ï¼šOracleã€SQL Serverã€MySQLç­‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸åŒçš„æ•°æ®æºï¼šæ¯”å¦‚apache æä¾›çš„org.apache.commons.dbcp.BasicDataSourceã€springæä¾›çš„org.springframework.jndi.JndiObjectFactoryBeanç­‰ã€‚ç„¶åŽsessionFactoryæ ¹æ®å®¢æˆ·çš„æ¯æ¬¡è¯·æ±‚ï¼Œå°†dataSourceå±žæ€§è®¾ç½®æˆä¸åŒçš„æ•°æ®æºï¼Œä»¥åˆ°è¾¾åˆ‡æ¢æ•°æ®æºçš„ç›®çš„ã€‚ springä¸­ç”¨åˆ°çš„åŒ…è£…å™¨æ¨¡å¼åœ¨ç±»åä¸Šæœ‰ä¸¤ç§è¡¨çŽ°ï¼šä¸€ç§æ˜¯ç±»åä¸­å«æœ‰Wrapperï¼Œå¦ä¸€ç§æ˜¯ç±»åä¸­å«æœ‰Decoratorã€‚ åŸºæœ¬ä¸Šéƒ½æ˜¯åŠ¨æ€åœ°ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ ä¸€äº›é¢å¤–çš„èŒè´£ã€‚ æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æž¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚Template Methodä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æž„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚ Template Methodæ¨¡å¼ä¸€èˆ¬æ˜¯éœ€è¦ç»§æ‰¿çš„ã€‚è¿™é‡Œæƒ³è¦æŽ¢è®¨å¦ä¸€ç§å¯¹Template Methodçš„ç†è§£ã€‚springä¸­çš„JdbcTemplateï¼Œåœ¨ç”¨è¿™ä¸ªç±»æ—¶å¹¶ä¸æƒ³åŽ»ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå› ä¸ºè¿™ä¸ªç±»çš„æ–¹æ³•å¤ªå¤šï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æƒ³ç”¨åˆ°JdbcTemplateå·²æœ‰çš„ç¨³å®šçš„ã€å…¬ç”¨çš„æ•°æ®åº“è¿žæŽ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€Žä¹ˆåŠžå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠå˜åŒ–çš„ä¸œè¥¿æŠ½å‡ºæ¥ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ å…¥JdbcTemplateçš„æ–¹æ³•ä¸­ã€‚ä½†æ˜¯å˜åŒ–çš„ä¸œè¥¿æ˜¯ä¸€æ®µä»£ç ï¼Œè€Œä¸”è¿™æ®µä»£ç ä¼šç”¨åˆ°JdbcTemplateä¸­çš„å˜é‡ã€‚æ€Žä¹ˆåŠžï¼Ÿé‚£æˆ‘ä»¬å°±ç”¨å›žè°ƒå¯¹è±¡å§ã€‚ åœ¨è¿™ä¸ªå›žè°ƒå¯¹è±¡ä¸­å®šä¹‰ä¸€ä¸ªæ“çºµJdbcTemplateä¸­å˜é‡çš„æ–¹æ³•ï¼Œæˆ‘ä»¬åŽ»å®žçŽ°è¿™ä¸ªæ–¹æ³•ï¼Œå°±æŠŠå˜åŒ–çš„ä¸œè¥¿é›†ä¸­åˆ°è¿™é‡Œäº†ã€‚ç„¶åŽæˆ‘ä»¬å†ä¼ å…¥è¿™ä¸ªå›žè°ƒå¯¹è±¡åˆ°JdbcTemplateï¼Œä»Žè€Œå®Œæˆäº†è°ƒç”¨ã€‚è¿™å¯èƒ½æ˜¯Template Methodä¸éœ€è¦ç»§æ‰¿çš„å¦ä¸€ç§å®žçŽ°æ–¹å¼ã€‚ ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š JdbcTemplateä¸­çš„executeæ–¹æ³• ![](F:/CloudNode/åŽå°/2-Java EE/Spring/image/6.png) ç»„åˆæ¨¡å¼]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa Persistence Context æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µ]]></title>
    <url>%2F2020%2F11%2F05%2FSpringDataJpa%E7%9A%84PersistenceContext%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%2F</url>
    <content type="text"><![CDATA[Persistence Context æ‰€è¡¨è¾¾çš„æ ¸å¿ƒæ¦‚å¿µEntityManagerFactory å’Œ Persistence Unit æ˜¯ä»€ä¹ˆæŒ‰ç…§ JPA åè®®é‡Œé¢çš„å®šä¹‰ï¼špersistence unit æ˜¯ä¸€äº›æŒä¹…åŒ–é…ç½®çš„é›†åˆï¼Œé‡Œé¢åŒ…å«äº†æ•°æ®æºçš„é…ç½®ã€EntityManagerFactory çš„é…ç½®ï¼ŒSpring 3.1 ä¹‹å‰ä¸»è¦æ˜¯é€šè¿‡ persistence.xml çš„æ–¹å¼æ¥é…ç½®ä¸€ä¸ª persistence unitï¼Œè€Œ Spring 3.1 ä¹‹åŽå·²ç»ä¸å†æŽ¨èè¿™ç§æ–¹å¼äº†ï¼Œä½†æ˜¯è¿˜ä¿ç•™äº† persistence unit çš„æ¦‚å¿µï¼Œåªéœ€è¦åœ¨é…ç½® LocalContainerEntityManagerFactory çš„æ—¶å€™ï¼ŒæŒ‡å®š persistence unit çš„åå­—å³å¯ï¼Œå¦‚ï¼š 12345678@Bean(name = "db2EntityManagerFactory")public LocalContainerEntityManagerFactoryBean entityManagerFactory(EntityManagerFactoryBuilder builder, @Qualifier("db2DataSource") DataSource db2DataSource) &#123; return builder.dataSource(db2DataSource) .packages("com.example.jpa.example1.db2") //æ•°æ®2çš„å®žä½“æ‰€åœ¨çš„è·¯å¾„ .persistenceUnit("db2")// persistenceUnitçš„åå­—é‡‡ç”¨db2 .build();&#125; EntityManagerFactory çš„ç”¨é€”å°±æ¯”è¾ƒæ˜Žæ˜¾äº†ï¼Œå³æ ¹æ®ä¸åŒçš„æ•°æ®æºï¼Œæ¥ç®¡ç† Entity å’Œåˆ›å»º EntityMangerï¼Œåœ¨æ•´ä¸ª application çš„ç”Ÿå‘½å‘¨æœŸä¸­æ˜¯å•ä¾‹çŠ¶æ€ã€‚æ‰€ä»¥åœ¨ spring çš„ application é‡Œé¢èŽ·å¾— EntityManagerFactory æœ‰ä¸¤ç§æ–¹å¼ã€‚ ç¬¬ä¸€ç§ï¼šé€šè¿‡ Spring çš„ Bean çš„æ–¹å¼æ³¨å…¥ã€‚ 123@Autowired@Qualifier(value="db2EntityManagerFactory") private EntityManagerFactory entityManagerFactory; è¿™ç§æ–¹å¼æ˜¯æ¯”è¾ƒæŽ¨èçš„ï¼Œå®ƒåˆ©ç”¨äº† Spring è‡ªèº«çš„ Bean çš„ç®¡ç†æœºåˆ¶ã€‚ ç¬¬äºŒç§ï¼šåˆ©ç”¨ java.persistence.PersistenceUnit æ³¨è§£çš„æ–¹å¼èŽ·å–ã€‚ 12@PersistenceUnit("db2")private EntityManagerFactory entityManagerFactory; EntityManager å’Œ PersistenceContext æ˜¯ä»€ä¹ˆæŒ‰ç…§ JPA åè®®çš„è§„èŒƒï¼ŒPersistenceContext æ˜¯ç”¨æ¥ç®¡ç†ä¼šè¯é‡Œé¢çš„ Entity çŠ¶æ€çš„ä¸€ä¸ªä¸Šä¸‹æ–‡çŽ¯å¢ƒï¼Œä½¿ Entity çš„å®žä¾‹æœ‰äº†ä¸åŒçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å®žä½“å®žä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ è€Œè¿™äº›å®žä½“åœ¨ PersistenceContext ä¸­çš„ä¸åŒçŠ¶æ€éƒ½æ˜¯é€šè¿‡ EntityManager æä¾›çš„ä¸€äº›æ–¹æ³•è¿›è¡Œç®¡ç†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š PersistenceContext æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œæ˜¯ JPA åè®®å®šä¹‰çš„ï¼Œè€Œ Hibernate çš„å®žçŽ°æ˜¯é€šè¿‡ Session åˆ›å»ºå’Œé”€æ¯çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª Session æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª PersistenceContextï¼› PersistenceContext æ˜¯æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼Œé‡Œé¢ç®¡ç†çš„æ˜¯ Entity çš„çŠ¶æ€ï¼› EntityManager æ˜¯é€šè¿‡ PersistenceContext åˆ›å»ºçš„ï¼Œç”¨æ¥ç®¡ç† PersistenceContext ä¸­ Entity çŠ¶æ€çš„æ–¹æ³•ï¼Œç¦»å¼€ PersistenceContext æŒä¹…åŒ–ä¸Šä¸‹æ–‡ï¼ŒEntityManager æ²¡æœ‰æ„ä¹‰ï¼› EntityManger æ˜¯æ“ä½œå¯¹è±¡çš„å”¯ä¸€å…¥å£ï¼Œä¸€ä¸ªè¯·æ±‚é‡Œé¢å¯èƒ½ä¼šæœ‰å¤šä¸ª EntityManger å¯¹è±¡ã€‚ çœ‹ä¸€ä¸‹ PersistenceContext æ˜¯æ€Žä¹ˆåˆ›å»ºçš„ã€‚ç›´æŽ¥æ‰“å¼€ SessionImpl çš„æž„é€ æ–¹æ³•ï¼Œå°±å¯ä»¥çŸ¥é“ PersistenceContext æ˜¯å’Œ Session çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š 12345678910111213//sessionå®žä¾‹åˆå§‹åŒ–çš„å…¥å£public SessionImpl(SessionFactoryImpl factory, SessionCreationOptions options) &#123; super( factory, options ); //Sessioné‡Œé¢åˆ›å»ºäº†persistenceContextï¼Œæ¯æ¬¡sessionéƒ½æ˜¯æ–°å¯¹è±¡ this.persistenceContext = createPersistenceContext();// ......çœç•¥ä¸€äº›ä¸é‡è¦çš„ä»£ç  protected StatefulPersistenceContext createPersistenceContext() &#123; return new StatefulPersistenceContext( this );&#125;//StatefulPersistenceContextå°±æ˜¯PersistenceContextçš„å®žçŽ°ç±»public class StatefulPersistenceContext implements PersistenceContext &#123;// ......&#125; EntityManger éœ€è¦é€šè¿‡ @PersistenceContext çš„æ–¹å¼è¿›è¡ŒèŽ·å–ï¼Œä»£ç å¦‚ä¸‹ï¼š 12@PersistenceContextprivate EntityManager em; è€Œå…¶ä¸­ @PersistenceContext çš„å±žæ€§é…ç½®æœ‰å¦‚ä¸‹è¿™äº›ã€‚ 1234567891011public @interface PersistenceContext &#123; String name() default ""; //PersistenceContextUnitçš„åå­—ï¼Œå¤šæ•°æ®æºçš„æ—¶å€™æœ‰ç”¨ String unitName() default ""; //æ˜¯æŒ‡åˆ›å»ºçš„EntityManagerçš„ç”Ÿå‘½å‘¨æœŸæ˜¯å­˜åœ¨äº‹åŠ¡å†…è¿˜æ˜¯å¯ä»¥è·¨äº‹åŠ¡ï¼Œé»˜è®¤ä¸ºç”Ÿå‘½å‘¨æœŸå’Œäº‹åŠ¡ä¸€æ ·ï¼› PersistenceContextType type() default PersistenceContextType.TRANSACTION; //åŒæ­¥çš„ç±»åž‹ï¼šåªæœ‰SYNCHRONIZEDå’Œ UNSYNCHRONIZED ä¸¤ä¸ªå€¼ç”¨æ¥è¡¨ç¤ºï¼Œä½†å¼€å¯äº‹åŠ¡çš„æ—¶å€™æ˜¯å¦è‡ªåŠ¨åŠ å…¥å·²å¼€å¯çš„äº‹åŠ¡é‡Œé¢ï¼Œé»˜è®¤SYNCHRONIZEDè¡¨ç¤ºè‡ªåŠ¨åŠ å…¥ï¼Œä¸åˆ›å»ºæ–°çš„äº‹åŠ¡ã€‚è€ŒUNSYNCHRONIZEDè¡¨ç¤ºï¼Œä¸è‡ªåŠ¨åŠ å…¥ä¸Šä¸‹æ–‡å·²ç»æœ‰çš„äº‹åŠ¡ï¼Œè‡ªåŠ¨å¼€å¯æ–°çš„äº‹åŠ¡ï¼›è¿™é‡Œä½ ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„çœ‹ä¸€ä¸‹äº‹åŠ¡çš„æ—¥å¿—ï¼› SynchronizationType synchronization() default SynchronizationType.SYNCHRONIZED; //æŒä¹…åŒ–çš„é…ç½®å±žæ€§ï¼Œè¿™é‡ŒæŒ‡hibernateä¸­AvailableSettingsé‡Œé¢çš„å€¼ PersistenceProperty[] properties() default &#123;&#125;;&#125; ä¸€èˆ¬æƒ…å†µä¸‹ä¿æŒé»˜è®¤å³å¯ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®å®žé™…æƒ…å†µè‡ªç”±ç»„åˆï¼Œä¸¾ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ã€‚ 12345678910111213@PersistenceContext( unitName = "db2",//é‡‡ç”¨æ•°æ®æº2çš„ //å¯ä»¥è·¨äº‹åŠ¡çš„EntityManager type = PersistenceContextType.EXTENDED, properties = &#123; //é€šè¿‡propertiesæ”¹å˜ä¸€ä¸‹è‡ªåŠ¨flushçš„æœºåˆ¶ @PersistenceProperty( name="org.hibernate.flushMode", value= "MANUAL"//æ”¹æˆæ‰‹åŠ¨åˆ·æ–°æ–¹å¼ ) &#125;)private EntityManager entityManager; å®žä½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ—¢ç„¶ PersistenceContext æ˜¯å­˜å‚¨ Entity çš„ï¼Œé‚£ä¹ˆ Entity åœ¨ PersistenceContext é‡Œé¢è‚¯å®šæœ‰ä¸åŒçš„çŠ¶æ€ã€‚å¯¹æ­¤ï¼ŒJPA åè®®å®šä¹‰äº†å››ç§çŠ¶æ€ï¼šnewã€managerã€detachedã€removedã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç¬¬ä¸€ç§ï¼šNew çŠ¶æ€çš„å¯¹è±¡å½“ä½¿ç”¨å…³é”®å­— new çš„æ—¶å€™åˆ›å»ºçš„å®žä½“å¯¹è±¡ï¼Œç§°ä¸º new çŠ¶æ€çš„ Entity å¯¹è±¡ã€‚å®ƒéœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š new çŠ¶æ€çš„å®žä½“ Id å’Œ Version å­—æ®µéƒ½æ˜¯ nullï¼› new çŠ¶æ€çš„å®žä½“æ²¡æœ‰åœ¨ PersistenceContext ä¸­å‡ºçŽ°è¿‡ã€‚ é‚£ä¹ˆå¦‚æžœè¦æŠŠ new çŠ¶æ€çš„ Entity æ”¾åˆ° PersistenceContext é‡Œé¢ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š æ‰§è¡Œ entityManager.persist(entity) æ–¹æ³•ï¼› é€šè¿‡å…³è”å…³ç³»çš„å®žä½“å…³ç³»é…ç½® cascade=PERSIST or cascade=ALL è¿™ç§ç±»åž‹ï¼Œå¹¶ä¸”å…³è”å…³ç³»çš„ä¸€æ–¹ï¼Œä¹Ÿæ‰§è¡Œäº† entityManager.persist(entity) æ–¹æ³•ã€‚ 1234567891011@Testpublic void testPersist() &#123; UserInfo userInfo = UserInfo.builder().lastName("jack").build(); //é€šè¿‡ contains æ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨ PersistenceContext é‡Œé¢ï¼Œæ­¤æ—¶ä¸åœ¨ Assertions.assertFalse(entityManager.contains(userInfo)); //é€šè¿‡ persist æ–¹æ³•æŠŠå¯¹è±¡æ”¾åˆ° PersistenceContext é‡Œé¢ entityManager.persist(userInfo); //é€šè¿‡ contains æ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨ PersistenceContext é‡Œé¢ï¼Œæ­¤æ—¶åœ¨ Assertions.assertTrue(entityManager.contains(userInfo)); Assertions.assertNotNull(userInfo.getId());&#125; ç¬¬äºŒç§ï¼šDetachedï¼ˆæ¸¸ç¦»ï¼‰çš„å®žä½“å¯¹è±¡Detached çŠ¶æ€çš„å¯¹è±¡è¡¨ç¤ºå’Œ PersistenceContext è„±ç¦»å…³ç³»çš„ Entity å¯¹è±¡ã€‚å®ƒå’Œ new çŠ¶æ€çš„å¯¹è±¡çš„ä¸åŒç‚¹åœ¨äºŽï¼š Detached æœ‰æŒä¹…åŒ–çš„ ID å˜æˆæŒä¹…åŒ–å¯¹è±¡éœ€è¦è¿›è¡Œ merger æ“ä½œï¼Œmerger æ“ä½œä¼š copy ä¸€ä¸ªæ–°çš„å®žä½“å¯¹è±¡ï¼Œç„¶åŽæŠŠæ–°çš„å®žä½“å¯¹è±¡å˜æˆ Manager çŠ¶æ€ è€Œ Detached å’Œ new çŠ¶æ€çš„å¯¹è±¡ç›¸åŒç‚¹ä¹Ÿæœ‰ä¸¤ä¸ªæ–¹é¢ï¼š éƒ½å’Œ PersistenceContext è„±ç¦»äº†å…³ç³»ï¼› å½“æ‰§è¡Œ flush æ“ä½œæˆ–è€… commit æ“ä½œçš„æ—¶å€™ï¼Œä¸ä¼šè¿›è¡Œæ•°æ®åº“åŒæ­¥ã€‚ å¦‚æžœæƒ³è®© Manager(persist) çŠ¶æ€çš„å¯¹è±¡ä»Ž PersistenceContext é‡Œé¢æ¸¸ç¦»å‡ºæ¥å˜æˆ Detached çš„çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ EntityManager çš„ Detach æ–¹æ³•å®žçŽ°ï¼šentityManager.detach(entity); å½“æ‰§è¡Œå®Œ entityManager.clear()ã€entityManager.close()ï¼Œæˆ–è€…äº‹åŠ¡ commit()ã€äº‹åŠ¡ rollback() ä¹‹åŽï¼Œæ‰€æœ‰æ›¾ç»åœ¨ PersistenceContext é‡Œé¢çš„å®žä½“éƒ½ä¼šå˜æˆ Detached çŠ¶æ€ã€‚ è€Œæ¸¸ç¦»çŠ¶æ€çš„å¯¹è±¡æƒ³å›žåˆ° PersistenceContext é‡Œé¢å˜æˆ manager çŠ¶æ€çš„è¯ï¼Œåªèƒ½æ‰§è¡Œ entityManager çš„ merge æ–¹æ³•ï¼šentityManager.merge(entity); æ¸¸ç¦»çŠ¶æ€çš„å®žä½“æ‰§è¡Œ EntityManager ä¸­ persist æ–¹æ³•çš„æ—¶å€™å°±ä¼šæŠ¥å¼‚å¸¸ï¼š 12345678910111213@Testpublic void testMergeException() &#123; //é€šè¿‡newçš„æ–¹å¼æž„å»ºä¸€ä¸ªæ¸¸ç¦»çŠ¶æ€çš„å¯¹è±¡ UserInfo userInfo = UserInfo.builder().id(1L).lastName("jack").version(1).build(); //éªŒè¯æ˜¯å¦å­˜åœ¨äºŽpersistence context é‡Œé¢ï¼Œnewçš„è‚¯å®šä¸å­˜åœ¨ Assertions.assertFalse(entityManager.contains(userInfo)); //å½“æ‰§è¡Œpersistæ–¹æ³•çš„æ—¶å€™å°±ä¼šæŠ¥å¼‚å¸¸ Assertions.assertThrows(PersistentObjectException.class,()-&gt;entityManager.persist(userInfo)); //detachedçŠ¶æ€çš„å®žä½“é€šè¿‡mergeçš„æ–¹å¼ä¿å­˜åœ¨äº†persistence contexté‡Œé¢ UserInfo user2 = entityManager.merge(userInfo); //éªŒè¯ä¸€ä¸‹å­˜åœ¨äºŽæŒä¹…åŒ–ä¸Šä¸‹æ–‡é‡Œé¢ Assertions.assertTrue(entityManager.contains(user2));&#125; ç¬¬ä¸‰ç§ï¼šManagerï¼ˆpersistï¼‰ çŠ¶æ€çš„å®žä½“Manager çŠ¶æ€çš„å®žä½“ï¼Œæ˜¯æŒ‡åœ¨ PersistenceContext é‡Œé¢ç®¡ç†çš„å®žä½“ï¼Œè€Œæ­¤ç§çŠ¶æ€çš„å®žä½“å½“æˆ‘ä»¬æ‰§è¡Œäº‹åŠ¡çš„ commit()ï¼Œæˆ–è€… entityManager çš„ flush æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šè¿›è¡Œæ•°æ®åº“çš„åŒæ­¥æ“ä½œã€‚å¯ä»¥è¯´æ˜¯å’Œæ•°æ®åº“çš„æ•°æ®æœ‰æ˜ å°„å…³ç³»ã€‚ New çŠ¶æ€å¦‚æžœè¦å˜æˆ Manager çš„çŠ¶æ€ï¼Œéœ€è¦æ‰§è¡Œ persist æ–¹æ³•ï¼›è€Œ Detached çŠ¶æ€çš„å®žä½“å¦‚æžœæƒ³å˜æˆ Manager çš„çŠ¶æ€ï¼Œåˆ™éœ€è¦æ‰§è¡Œ merge æ–¹æ³•ã€‚åœ¨ session çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä»»ä½•ä»Žæ•°æ®åº“é‡Œé¢æŸ¥è¯¢åˆ°çš„ Entity éƒ½ä¼šè‡ªåŠ¨æˆä¸º Manager çš„çŠ¶æ€ï¼Œå¦‚ entityManager.findById(id)ã€entityManager.getReference ç­‰æ–¹æ³•ã€‚ è€Œ Manager çŠ¶æ€çš„ Entity è¦åŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ï¼Œå¿…é¡»æ‰§è¡Œ EntityManager é‡Œé¢çš„ flush æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯¹ Entity å¯¹è±¡åšçš„ä»»ä½•å¢žåˆ æ”¹æŸ¥ï¼Œå¿…é¡»é€šè¿‡ entityManager.flush() æ‰§è¡Œä¹‹åŽæ‰ä¼šå˜æˆ SQL åŒæ­¥åˆ° DB é‡Œé¢ã€‚ 12345678910@Test@Rollback(value = false)public void testManagerException() &#123; UserInfo userInfo = UserInfo.builder().lastName("jack").build(); entityManager.persist(userInfo); System.out.println("æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql"); entityManager.flush(); System.out.println("æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql"); Assertions.assertTrue(entityManager.contains(userInfo));&#125; 123æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sqlHibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql ç¬¬å››ç§ï¼šRemoved çš„å®žä½“çŠ¶æ€Removed çš„çŠ¶æ€ï¼Œæ˜¯æŒ‡åˆ é™¤äº†çš„å®žä½“ï¼Œä½†æ˜¯æ­¤å®žä½“è¿˜åœ¨ PersistenceContext é‡Œé¢ï¼Œåªæ˜¯åœ¨å…¶ä¸­è¡¨ç¤ºä¸º Removed çš„çŠ¶æ€ï¼Œå®ƒå’Œ Detached çŠ¶æ€çš„å®žä½“æœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯åœ¨ä¸åœ¨ PersistenceContext é‡Œé¢ï¼Œä½†éƒ½æœ‰ ID å±žæ€§ã€‚ è€Œ Removed çŠ¶æ€çš„å®žä½“ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ entityManager.flush() æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šç”Ÿæˆä¸€æ¡ delete è¯­å¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚Removed çŠ¶æ€çš„å®žä½“ï¼Œåœ¨æ‰§è¡Œ flush() æ–¹æ³•ä¹‹å‰ï¼Œæ‰§è¡Œ entityManger.persist(removedEntity) æ–¹æ³•æ—¶å€™ï¼Œå°±ä¼šåŽ»æŽ‰åˆ é™¤çš„è¡¨ç¤ºï¼Œå˜æˆ Managed çš„çŠ¶æ€å®žä¾‹ã€‚ 12345678910@Testpublic void testDelete() &#123; UserInfo userInfo = UserInfo.builder().lastName("jack").build(); entityManager.persist(userInfo); entityManager.flush(); System.out.println("æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sql"); entityManager.remove(userInfo); entityManager.flush(); System.out.println("æ‰§è¡Œäº†flush()æ–¹æ³•ä¹‹åŽï¼Œåˆäº§ç”Ÿäº†delete sql");&#125; 1234Hibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)æ‰§è¡Œäº†flush()æ–¹æ³•ï¼Œäº§ç”Ÿäº†insert sqlHibernate: delete from user_info where id=? and version=?æ‰§è¡Œäº†flush()æ–¹æ³•ä¹‹åŽï¼Œåˆäº§ç”Ÿäº†delete sql MyBatis æ˜¯å¯¹æ•°æ®åº“çš„æ“ä½œæ‰€è§å³æ‰€å¾—çš„æ¨¡å¼ï¼›è€Œä½¿ç”¨ JPAï¼Œä½ çš„ä»»ä½•æ“ä½œéƒ½ä¸ä¼šäº§ç”Ÿ DB çš„sql EntityManager çš„ flush() æ–¹æ³•flush æ–¹æ³•çš„ç”¨æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨éœ€è¦ DB åŒæ­¥ sql æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰§è¡Œ entityManager.flush() å³å¯ Flush çš„ä½œç”¨flush é‡è¦çš„ã€å”¯ä¸€çš„ä½œç”¨ï¼Œå°±æ˜¯å°† Persistence Context ä¸­å˜åŒ–çš„å®žä½“è½¬åŒ–æˆ sql è¯­å¥ï¼ŒåŒæ­¥æ‰§è¡Œåˆ°æ•°æ®åº“é‡Œé¢ã€‚æ¢å¥è¯æ¥è¯´ï¼Œå¦‚æžœæˆ‘ä»¬ä¸æ‰§è¡Œ flush() æ–¹æ³•çš„è¯ï¼Œé€šè¿‡ EntityManager æ“ä½œçš„ä»»ä½• Entity è¿‡ç¨‹éƒ½ä¸ä¼šåŒæ­¥åˆ°æ•°æ®åº“é‡Œé¢ã€‚ è€Œ flush() æ–¹æ³•å¾ˆå¤šæ—¶å€™ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ“ä½œï¼Œè¿™é‡Œæˆ‘ç›´æŽ¥é€šè¿‡ entityManager æ“ä½œ flush() æ–¹æ³•ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ¼”ç¤ºæ‰§è¡Œè¿‡ç¨‹ã€‚å®žé™…å·¥ä½œä¸­å¾ˆå°‘ä¼šè¿™æ ·æ“ä½œï¼Œè€Œæ˜¯ä¼šç›´æŽ¥åˆ©ç”¨ JPA å’Œ Hibernate åº•å±‚æ¡†æž¶å¸®æˆ‘ä»¬å®žçŽ°çš„è‡ªåŠ¨ flush çš„æœºåˆ¶ã€‚ Flush çš„æœºåˆ¶JPA åè®®è§„å®šäº† EntityManager å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•ä¿®æ”¹ FlushModeã€‚ 123456789//entity manager é‡Œé¢æä¾›çš„ä¿®æ”¹FlushModeçš„æ–¹æ³•public void setFlushMode(FlushModeType flushMode);//FlushModeTypeåªæœ‰ä¸¤ä¸ªå€¼ï¼Œè‡ªåŠ¨å’Œäº‹åŠ¡æäº¤ä¹‹å‰public enum FlushModeType &#123; //äº‹åŠ¡commitä¹‹å‰ COMMIT, //è‡ªåŠ¨è§„åˆ™ï¼Œé»˜è®¤ AUTO&#125; è€Œ Hibernate è¿˜æä¾›äº†ä¸€ç§æ‰‹åŠ¨è§¦å‘çš„æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç çš„æ–¹å¼è¿›è¡Œä¿®æ”¹ã€‚ 12345@PersistenceContext(properties = &#123;@PersistenceProperty( name = "org.hibernate.flushMode", value = "MANUAL"//æ‰‹åŠ¨flush)&#125;)private EntityManager entityManager; æ‰‹åŠ¨å’Œ commit çš„æ—¶å€™å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æ‰‹åŠ¨æ‰§è¡Œ flush æ–¹æ³•ï¼›äº‹åŠ¡å°±æ˜¯ä»£ç åœ¨æ‰§è¡Œäº‹åŠ¡ commit çš„æ—¶å€™ï¼Œå¿…é¡»è¦æ‰§è¡Œ flush() æ–¹æ³• Flush çš„è‡ªåŠ¨æœºåˆ¶é»˜è®¤æƒ…å†µä¸‹ï¼ŒJPA å’Œ Hibernate éƒ½æ˜¯é‡‡ç”¨çš„ AUTO çš„ Flush æœºåˆ¶ï¼Œè‡ªåŠ¨è§¦å‘çš„è§„åˆ™å¦‚ä¸‹ï¼š äº‹åŠ¡ commit ä¹‹å‰ï¼Œå³æŒ‡æ‰§è¡Œ transactionManager.commit() ä¹‹å‰éƒ½ä¼šè§¦å‘ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼› æ‰§è¡Œä»»ä½•çš„ JPQL æˆ–è€… native SQLï¼ˆä»£æ›¿ç›´æŽ¥æ“ä½œ Entity çš„æ–¹æ³•ï¼‰éƒ½ä¼šè§¦å‘ flushã€‚ 12345678910111213141516 @Test public void testPersist() &#123; UserInfo userInfo = UserInfo.builder().lastName("jack").build(); //é€šè¿‡containsæ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨PersistenceContexté‡Œé¢ï¼Œæ­¤æ—¶ä¸åœ¨ Assertions.assertFalse(entityManager.contains(userInfo)); //é€šè¿‡persistæ–¹æ³•æŠŠå¯¹è±¡æ”¾åˆ°PersistenceContexté‡Œé¢ entityManager.persist(userInfo);//æ˜¯ç›´æŽ¥æ“ä½œEntityçš„ï¼Œä¸ä¼šè§¦å‘flushæ“ä½œ //entityManager.remove(userInfo);//æ˜¯ç›´æŽ¥æ“ä½œEntityçš„ï¼Œä¸ä¼šè§¦å‘flushæ“ä½œ System.out.println("æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sql"); UserInfo userInfo2 = entityManager.find(UserInfo.class,2L);//æ˜¯ç›´æŽ¥æ“ä½œEntityçš„ï¼Œè¿™ä¸ªå°±ä¸ä¼šè§¦å‘flushæ“ä½œ// userInfoRepository.queryByFlushTest();//æ˜¯æ“ä½œJPQLçš„ï¼Œè¿™ä¸ªå°±ä¼šå…ˆè§¦å‘flushæ“ä½œï¼› System.out.println("flush()æ–¹æ³•ï¼Œäº§ç”Ÿinsert sql"); //é€šè¿‡containsæ–¹æ³•å¯ä»¥éªŒè¯å¯¹è±¡æ˜¯å¦åœ¨ PersistenceContext é‡Œé¢ï¼Œæ­¤æ—¶åœ¨ Assertions.assertTrue(entityManager.contains(userInfo)); Assertions.assertNotNull(userInfo.getId()); &#125; è€Œåªæœ‰æ‰§è¡Œç±»ä¼¼ .queryByFlushTest() è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘ flushï¼Œå› ä¸ºå®ƒæ˜¯ç”¨çš„ JPQL çš„æœºåˆ¶æ‰§è¡Œçš„ã€‚ ä¸Šé¢çš„æ–¹æ³•è§¦å‘äº† flush çš„æ—¥å¿—ï¼Œä¼šè¾“å‡ºå¦‚ä¸‹æ ¼å¼ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™é‡Œå¤šäº†ä¸€ä¸ª insert è¯­å¥ã€‚ 1234æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sqlHibernate: insert into user_info (create_time, create_user_id, last_modified_time, last_modified_user_id, version, ages, email_address, last_name, telephone, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)Hibernate: select userinfo0_.id as id1_0_, userinfo0_.create_time as create_t2_0_, userinfo0_.create_user_id as create_u3_0_, userinfo0_.last_modified_time as last_mod4_0_, userinfo0_.last_modified_user_id as last_mod5_0_, userinfo0_.version as version6_0_, userinfo0_.ages as ages7_0_, userinfo0_.email_address as email_ad8_0_, userinfo0_.last_name as last_nam9_0_, userinfo0_.telephone as telepho10_0_ from user_info userinfo0_ where userinfo0_.id=2flush()æ–¹æ³•ï¼Œäº§ç”Ÿinsert sql æ²¡æœ‰è§¦å‘ flush çš„æ—¥å¿—è¾“å‡ºçš„æ˜¯å¦‚ä¸‹æ ¼å¼ï¼Œå…¶ä¸­æ²¡æœ‰ insert è¯­å¥ã€‚ 123æ²¡æœ‰æ‰§è¡Œ flush()æ–¹æ³•ï¼Œæ²¡æœ‰äº§ç”Ÿinsert sqlHibernate: select userinfo0_.id as id1_0_0_, userinfo0_.create_time as create_t2_0_0_, userinfo0_.create_user_id as create_u3_0_0_, userinfo0_.last_modified_time as last_mod4_0_0_, userinfo0_.last_modified_user_id as last_mod5_0_0_, userinfo0_.version as version6_0_0_, userinfo0_.ages as ages7_0_0_, userinfo0_.email_address as email_ad8_0_0_, userinfo0_.last_name as last_nam9_0_0_, userinfo0_.telephone as telepho10_0_0_ from user_info userinfo0_ where userinfo0_.id=?flush()æ–¹æ³•ï¼Œäº§ç”Ÿinsert sql Flush ä¼šæ”¹å˜ SQL çš„æ‰§è¡Œé¡ºåºflush() æ–¹æ³•è°ƒç”¨ä¹‹åŽï¼ŒåŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œsql çš„æ‰§è¡Œé¡ºåºä¼šå˜æˆå¦‚ä¸‹æ¨¡å¼ï¼š insert çš„å…ˆæ‰§è¡Œ delete çš„ç¬¬äºŒä¸ªæ‰§è¡Œ update çš„ç¬¬ä¸‰ä¸ªæ‰§è¡Œ 123entityManager.remove(u3);UserInfo userInfo = UserInfo.builder().lastName("jack").build();entityManager.persist(userInfo); çœ‹ä¸€ä¸‹æ‰§è¡Œçš„ sql ä¼šå˜æˆå¦‚ä¸‹æ¨¡æ ·ï¼Œå³å…ˆ insert åŽ deleteã€‚ 12Hibernate: insert into user_info ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚Hibernate: delete from user_info where id=? and version=? è¿™ç§ä¼šæ”¹å˜é¡ºåºçš„çŽ°è±¡ï¼Œä¸»è¦æ˜¯ç”± persistence context çš„å®žä½“çŠ¶æ€æœºåˆ¶å¯¼è‡´çš„ï¼Œæ‰€ä»¥åœ¨ Hibernate çš„çŽ¯å¢ƒä¸­ï¼Œé¡ºåºä¼šå˜æˆå¦‚ä¸‹çš„ ActionQueue çš„æ¨¡å¼ï¼š OrphanRemovalAction EntityInsertAction EntityIdentityInsertAction EntityUpdateAction CollectionRemoveAction CollectionUpdateAction CollectionRecreateAction EntityDeleteAction Flush ä¸Žäº‹åŠ¡ Commit çš„å…³ç³»å¤§æ¦‚æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š åœ¨å½“å‰çš„äº‹åŠ¡æ‰§è¡Œ commit çš„æ—¶å€™ï¼Œä¼šè§¦å‘ flush æ–¹æ³•ï¼› åœ¨å½“å‰çš„äº‹åŠ¡æ‰§è¡Œå®Œ commit çš„æ—¶å€™ï¼Œå¦‚æžœéš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»çš„è¯ï¼Œflush ä¹‹åŽæ‰§è¡Œçš„ updateã€insertã€delete çš„æ“ä½œï¼Œä¼šè¢«å…¶ä»–çš„æ–°äº‹åŠ¡çœ‹åˆ°æœ€æ–°ç»“æžœï¼› å‡è®¾å½“å‰çš„äº‹åŠ¡æ˜¯å¯é‡å¤è¯»çš„ï¼Œå½“æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œ flush æ–¹æ³•ä¹‹åŽï¼Œæ²¡æœ‰æ‰§è¡Œäº‹åŠ¡ commit æ–¹æ³•ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡æ˜¯çœ‹ä¸åˆ°æœ€æ–°å€¼å˜åŒ–çš„ï¼Œä½†æ˜¯æœ€æ–°å€¼å˜åŒ–å¯¹å½“å‰æ²¡æœ‰ commit çš„äº‹åŠ¡æ˜¯æœ‰æ•ˆçš„ï¼› å¦‚æžœæ‰§è¡Œäº† flush ä¹‹åŽï¼Œå½“å‰äº‹åŠ¡å‘ç”Ÿäº† rollback æ“ä½œï¼Œé‚£ä¹ˆæ•°æ®å°†ä¼šè¢«å›žæ»šï¼ˆæ•°æ®åº“çš„æœºåˆ¶ï¼‰ã€‚ saveAndFlush å’Œ save çš„åŒºåˆ«**Repository é‡Œé¢æœ‰ä¸€ä¸ª saveAndFlush(entity); çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š 12345678@Transactional@Overridepublic &lt;S extends T&gt; S saveAndFlush(S entity) &#123; //æ‰§è¡Œäº†saveæ–¹æ³•ä¹‹åŽï¼Œè°ƒç”¨äº†flush()æ–¹æ³• S result = save(entity); flush(); return result;&#125; è€Œå¦ä¸€ä¸ª **Repository é‡Œé¢çš„ save çš„æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š 1234567891011// æ²¡æœ‰åš flush æ“ä½œï¼Œåªæ˜¯ï¼Œæ‰§è¡Œäº† persist æˆ–è€… merge çš„æ“ä½œ@Transactional@Overridepublic &lt;S extends T&gt; S save(S entity) &#123; if (entityInformation.isNew(entity)) &#123; em.persist(entity); return entity; &#125; else &#123; return em.merge(entity); &#125;&#125; åŒºåˆ«æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š saveAndFlush æ‰§è¡Œå®Œsaveï¼Œå†æ‰§è¡Œ flushï¼Œä¼šåˆ·æ–°æ•´ä¸ª PersistenceContext é‡Œé¢çš„å®žä½“å¹¶è¿›å…¥åˆ°æ•°æ®åº“é‡Œé¢ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬é¢‘ç¹è°ƒç”¨ saveAndFlush å°±å¤±åŽ»äº† cache çš„æ„ä¹‰ï¼Œè¿™ä¸ªæ—¶å€™å°±å’Œæ‰§è¡Œ mybatis çš„ saveOrUpdate æ˜¯ä¸€æ ·çš„æ•ˆæžœï¼› å½“å¤šæ¬¡è°ƒç”¨ç›¸åŒçš„ save æ–¹æ³•çš„æ—¶å€™ï¼Œæœ€ç»ˆ flush æ‰§è¡Œåªä¼šäº§ç”Ÿä¸€æ¡ sqlï¼Œåœ¨æ€§èƒ½ä¸Šä¼šæ¯” saveAndFlush é«˜ä¸€ç‚¹ï¼› ä¸ç®¡æ˜¯ saveAndFlush è¿˜æ˜¯ saveï¼Œéƒ½å—å½“å‰äº‹åŠ¡æŽ§åˆ¶ï¼Œäº‹åŠ¡åœ¨æ²¡æœ‰ commit ä¹‹å‰ï¼Œéƒ½åªä¼šå½±å“å½“å‰äº‹åŠ¡çš„æ“ä½œï¼› ç»¼ä¸Šï¼Œä¸¤ç§æœ¬è´¨çš„åŒºåˆ«å°±æ˜¯ flush æ‰§è¡Œçš„æ—¶æœºä¸ä¸€æ ·è€Œå·²ï¼Œå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„äº‹åŠ¡ä¸€è‡´æ€§æ²¡æœ‰ä»»ä½•å½±å“ã€‚ç„¶è€Œæœ‰çš„æ—¶å€™ï¼Œå³ä½¿æˆ‘ä»¬è°ƒç”¨äº† flush çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ¡ sql éƒ½æ²¡æœ‰ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå†æ¥äº†è§£ä¸€ä¸ªæ¦‚å¿µï¼šDirtyã€‚ Entity çš„ Dirty åˆ¤æ–­é€»è¾‘åŠå…¶ä½œç”¨åœ¨ PersistenceContext é‡Œé¢è¿˜æœ‰ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå°±æ˜¯å½“å®žä½“ä¸æ˜¯ Dirty çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä»»ä½•å˜åŒ–çš„æ—¶å€™ï¼Œæ˜¯ä¸ä¼šè¿›è¡Œä»»ä½• db æ“ä½œçš„ã€‚æ‰€ä»¥å³ä½¿æˆ‘ä»¬æ‰§è¡Œ flush å’Œ commitï¼Œå®žä½“æ²¡æœ‰å˜åŒ–ï¼Œå°±æ²¡æœ‰å¿…è¦æ‰§è¡Œï¼Œè¿™ä¹Ÿèƒ½å¤§å¤§å‡å°‘æ•°æ®åº“çš„åŽ‹åŠ›ã€‚Dirty çš„æ•ˆæžœçš„ä¾‹å­ï¼š 123456789//æˆ‘ä»¬å‡è®¾æ•°æ®åº“é‡Œé¢å­˜åœ¨ä¸€æ¡id=1çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸åšä»»ä½•æ”¹å˜æ‰§è¡Œsaveæˆ–è€…saveAndFlushï¼Œé™¤äº†selectä¹‹å¤–ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•sqlè¯­å¥ï¼›@Test@Transactional@Rollback(value = false)public void testDirty() &#123; UserInfo userInfo = userInfoRepository.findById(1L).get(); userInfoRepository.saveAndFlush(userInfo); userInfoRepository.save(userInfo);&#125; é‚£ä¹ˆå½“æˆ‘ä»¬å°è¯•æ”¹å˜ä¸€ä¸‹ userInfo é‡Œé¢çš„å€¼ï¼Œå½“æ‰§è¡Œå¦‚ä¸‹æ–¹æ³•çš„æ—¶å€™å°±ä¼šäº§ç”Ÿ update çš„ sqlã€‚ 12345678@Test@Transactional@Rollback(value = false)public void testDirty() &#123; UserInfo userInfo = userInfoRepository.findById(1L).get(); userInfo.setLastName("jack_test_dirty"); userInfoRepository.saveAndFlush(userInfo);&#125; Entity åˆ¤æ–­ Dirty çš„è¿‡ç¨‹DefaultFlushEntityEventListener çš„æºç é‡Œé¢ isUpdateNecessary çš„å…³é”®æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š çœ‹ dirtyCheck çš„å®žçŽ°ï¼Œå¯ä»¥çœ‹å‘çŽ°å¦‚ä¸‹å…³é”®ç‚¹ï¼Œä»Žè€Œæ‰¾å‡ºå‘ç”Ÿå˜åŒ–çš„ propertiesã€‚ å†ä»”ç»†çœ‹ persister.findDirtyï¼ˆvalues, loadedState, entity, sessionï¼‰ï¼Œå¯ä»¥çœ‹å‡ºæ¥æºç é‡Œé¢æ˜¯é€šè¿‡ä¸€ä¸ªå­—æ®µä¸€ä¸ªå­—æ®µæ¯”è¾ƒçš„ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“ PersistenceContext ä¸­çš„å‰åŽä¸¤ä¸ª Entity çš„å“ªäº›å­—æ®µå‘ç”Ÿäº†å˜åŒ–ã€‚å› æ­¤å½“æˆ‘ä»¬æ‰§è¡Œå®Œ save ä¹‹åŽï¼Œæ²¡æœ‰äº§ç”Ÿä»»ä½• sqlï¼ˆå› ä¸ºæ²¡æœ‰å˜åŒ–ï¼‰ã€‚ æ€»ç»“ï¼šåœ¨ flush çš„æ—¶å€™ï¼ŒHibernate ä¼šä¸€ä¸ªä¸ªåˆ¤æ–­å®žä½“çš„å‰åŽå¯¹è±¡ä¸­å“ªä¸ªå±žæ€§å‘ç”Ÿå˜åŒ–äº†ï¼Œå¦‚æžœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¸äº§ç”Ÿ update çš„ sql è¯­å¥ï¼›åªæœ‰å˜åŒ–æ‰ä¼šæ‰ç”Ÿ update sqlï¼Œå¹¶ä¸”å¯ä»¥åšåˆ°åŒä¸€ä¸ªäº‹åŠ¡é‡Œé¢çš„å¤šæ¬¡ update åˆå¹¶ï¼Œä»Žè€Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥å‡è½» DB çš„åŽ‹åŠ›ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa çš„å®¡è®¡åŠŸèƒ½]]></title>
    <url>%2F2020%2F11%2F05%2FSpringDataJpa%E7%9A%84%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD%2F</url>
    <content type="text"><![CDATA[JPA çš„å®¡è®¡åŠŸèƒ½ JPA çš„å®¡è®¡åŠŸèƒ½ï¼Œå³ Auditing Auditing æŒ‡çš„æ˜¯ä»€ä¹ˆAuditing æ˜¯å¸®æˆ‘ä»¬åšå®¡è®¡ç”¨çš„ï¼Œå½“æˆ‘ä»¬æ“ä½œä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œéœ€è¦çŸ¥é“è¿™æ˜¯è°åˆ›å»ºçš„ã€ä»€ä¹ˆæ—¶é—´åˆ›å»ºçš„ã€æœ€åŽä¿®æ”¹äººæ˜¯è°ã€æœ€åŽä¿®æ”¹æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Œç”šè‡³éœ€è¦ä¿®æ”¹è®°å½•â€¦â€¦è¿™äº›éƒ½æ˜¯ Spring Data JPA é‡Œé¢çš„ Auditing æ”¯æŒçš„ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†å››ä¸ªæ³¨è§£æ¥å®Œæˆä¸Šé¢è¯´çš„ä¸€ç³»åˆ—äº‹æƒ…ï¼Œå¦‚ä¸‹ï¼š @CreatedBy æ˜¯å“ªä¸ªç”¨æˆ·åˆ›å»ºçš„ã€‚ @CreatedDate åˆ›å»ºçš„æ—¶é—´ã€‚ @LastModifiedBy æœ€åŽä¿®æ”¹å®žä½“çš„ç”¨æˆ·ã€‚ @LastModifiedDate æœ€åŽä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ã€‚ è¿™å°±æ˜¯ Auditing äº† Auditing å¦‚ä½•å®žçŽ°åˆ©ç”¨ä¸Šé¢çš„å››ä¸ªæ³¨è§£å®žçŽ°æ–¹æ³•ï¼Œä¸€å…±æœ‰ä¸‰ç§æ–¹å¼å®žçŽ° Auditingã€‚ æ–¹å¼ä¸€ï¼šç›´æŽ¥åœ¨å®žä¾‹é‡Œé¢æ·»åŠ æ³¨è§£åœ¨ User å®žä½“æ·»åŠ å››ä¸ªå­—æ®µï¼Œåˆ†åˆ«è®°å½•åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ã€æœ€åŽä¿®æ”¹äººã€æœ€åŽä¿®æ”¹æ—¶é—´ã€‚ ç¬¬ä¸€æ­¥ï¼šåœ¨ User é‡Œé¢æ·»åŠ å››ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”æ–°å¢ž @EntityListeners(AuditingEntityListener.class) æ³¨è§£ã€‚ æ·»åŠ å®Œä¹‹åŽï¼ŒUser çš„å®žä½“ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "addresses")@EntityListeners(AuditingEntityListener.class)public class User implements Serializable &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email; @Enumerated(EnumType.STRING) private SexEnum sex; private Integer age; @OneToMany(mappedBy = "user") @JsonIgnore private List&lt;UserAddress&gt; addresses; private Boolean deleted; @CreatedBy private Integer createUserId; @CreatedDate private Date createTime; @LastModifiedBy private Integer lastModifiedUserId; @LastModifiedDate private Date lastModifiedTime;&#125; åœ¨ @Entity å®žä½“ä¸­æˆ‘ä»¬éœ€è¦åšä¸¤ç‚¹æ“ä½œï¼š å…¶ä¸­æœ€ä¸»è¦çš„å››ä¸ªå­—æ®µåˆ†åˆ«è®°å½•åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ã€æœ€åŽä¿®æ”¹äººã€æœ€åŽä¿®æ”¹æ—¶é—´ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678@CreatedByprivate Integer createUserId;@CreatedDateprivate Date createTime;@LastModifiedByprivate Integer lastModifiedUserId;@LastModifiedDateprivate Date lastModifiedTime; å…¶ä¸­ AuditingEntityListener ä¸èƒ½å°‘ï¼Œå¿…é¡»é€šè¿‡è¿™æ®µä»£ç ï¼š 1@EntityListeners(AuditingEntityListener.class) åœ¨ Entity çš„å®žä½“ä¸Šé¢è¿›è¡Œæ³¨è§£ã€‚ ç¬¬äºŒæ­¥ï¼šå®žçŽ° AuditorAware æŽ¥å£ï¼Œå‘Šè¯‰ JPA å½“å‰çš„ç”¨æˆ·æ˜¯è°ã€‚ éœ€è¦å®žçŽ° AuditorAware æŽ¥å£ï¼Œä»¥åŠ getCurrentAuditor æ–¹æ³•ï¼Œå¹¶è¿”å›žä¸€ä¸ª Integer çš„ user IDã€‚è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰è¿”å›žä¿®æ”¹ç”¨æˆ·çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·å 12345678910public class MyAuditorAware implements AuditorAware&lt;Integer&gt; &#123; //éœ€è¦å®žçŽ°AuditorAwareæŽ¥å£ï¼Œè¿”å›žå½“å‰çš„ç”¨æˆ·ID @Override public Optional&lt;Integer&gt; getCurrentAuditor() &#123; ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes(); Integer userId = (Integer) servletRequestAttributes.getRequest().getSession().getAttribute("userId"); return Optional.ofNullable(userId); &#125;&#125; è¿™é‡Œå…³é”®çš„ä¸€æ­¥ï¼Œæ˜¯å®žçŽ° AuditorAware æŽ¥å£çš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123public interface AuditorAware&lt;T&gt; &#123; T getCurrentAuditor();&#125; ðŸŽ¯æ³¨æ„ï¼šè¿™é‡ŒèŽ·å¾—ç”¨æˆ· ID çš„æ–¹æ³•ä¸æ­¢è¿™ä¸€ç§ï¼Œå®žé™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å°†å½“å‰çš„ user ä¿¡æ¯æ”¾åœ¨ Session ä¸­ï¼Œå¯èƒ½æŠŠå½“å‰ä¿¡æ¯æ”¾åœ¨ Redis ä¸­ï¼Œä¹Ÿå¯èƒ½æ”¾åœ¨ Spring çš„ security é‡Œé¢ç®¡ç†ã€‚ æ­¤å¤–ï¼Œè¿™é‡Œçš„å®žçŽ°ä¼šæœ‰ç•¥å¾®å·®å¼‚ï¼Œæˆ‘ä»¬ä»¥ security ä¸ºä¾‹ï¼š 12345Authentication authentication = SecurityContextHolder.getContext().getAuthentication();if (authentication == null || !authentication.isAuthenticated()) &#123; return null;&#125;Integer userId = ((LoginUserInfo) authentication.getPrincipal()).getUser().getId(); è¿™æ—¶èŽ·å– userId çš„ä»£ç å¯èƒ½ä¼šå˜æˆä¸Šé¢è¿™æ ·å­ã€‚ ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ @EnableJpaAuditing æ³¨è§£å¼€å¯ JPA çš„ Auditing åŠŸèƒ½ã€‚ ç¬¬ä¸‰æ­¥æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼Œå¦‚æžœæƒ³ä½¿ä¸Šé¢çš„é…ç½®ç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯ JPA çš„ Auditing åŠŸèƒ½ï¼ˆé»˜è®¤æ²¡å¼€å¯ï¼‰ã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°çš„æ³¨è§£æ˜¯ @EnableJpaAuditingï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415@Inherited@Documented@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Import(JpaAuditingRegistrar.class)public @interface EnableJpaAuditing &#123;//auditorç”¨æˆ·çš„èŽ·å–æ–¹æ³•ï¼Œé»˜è®¤æ˜¯æ‰¾AuditorAwareçš„å®žçŽ°ç±»ï¼›String auditorAwareRef() default "";//æ˜¯å¦åœ¨åˆ›å»ºä¿®æ”¹çš„æ—¶å€™è®¾ç½®æ—¶é—´ï¼Œé»˜è®¤æ˜¯trueboolean setDates() default true;//åœ¨åˆ›å»ºçš„æ—¶å€™æ˜¯å¦åŒæ—¶ä½œä¸ºä¿®æ”¹ï¼Œé»˜è®¤æ˜¯trueboolean modifyOnCreate() default true;//æ—¶é—´çš„ç”Ÿæˆæ–¹æ³•ï¼Œé»˜è®¤æ˜¯å–å½“å‰æ—¶é—´(ä¸ºä»€ä¹ˆæä¾›è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿå› ä¸ºæµ‹è¯•çš„æ—¶å€™æœ‰å¯èƒ½å¸Œæœ›æ—¶é—´ä¿æŒä¸å˜ï¼Œå®ƒæä¾›äº†ä¸€ç§è‡ªå®šä¹‰çš„æ–¹æ³•)ï¼›String dateTimeProviderRef() default "";&#125; åœ¨äº†è§£äº†@EnableJpaAuditingæ³¨è§£ä¹‹åŽï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªConfiguration æ–‡ä»¶ï¼Œæ·»åŠ  @EnableJpaAuditing æ³¨è§£ï¼Œå¹¶ä¸”æŠŠæˆ‘ä»¬çš„ MyAuditorAware åŠ è½½è¿›åŽ»å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789@Configuration@EnableJpaAuditingpublic class JpaConfiguration &#123; @Bean @ConditionalOnMissingBean(name = "myAuditorAware") MyAuditorAware myAuditorAware() &#123; return new MyAuditorAware(); &#125;&#125; ç»éªŒä¹‹è°ˆ è¿™é‡Œè¯´ä¸€ä¸ª Configuration çš„æœ€ä½³å®žè·µçš„å†™æ³•ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å•ç‹¬å†™ä¸€ä¸ªConfiguration çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æŠŠ@EnableJpaAuditing æ”¾åœ¨ Application çš„ç±»é‡Œé¢å‘¢ï¼Ÿå› ä¸ºè¿™æ ·çš„è¯ Configuration æ–‡ä»¶å¯ä»¥å•ç‹¬åŠ è½½ã€å•ç‹¬æµ‹è¯•ï¼Œå¦‚æžœéƒ½æ”¾åœ¨ Application ç±»é‡Œé¢çš„è¯ï¼Œå²‚ä¸æ˜¯æ¯æ¬¡æµ‹è¯•éƒ½è¦å¯åŠ¨æ•´ä¸ªåº”ç”¨å—ï¼Ÿ MyAuditorAware ä¹Ÿå¯ä»¥é€šè¿‡ @Component æ³¨è§£è¿›è¡ŒåŠ è½½ï¼Œæˆ‘ä¸ºä»€ä¹ˆæŽ¨è @Bean çš„æ–¹å¼å‘¢ï¼Ÿå› ä¸ºè¿™ç§æ–¹å¼å¯ä»¥è®©ä½¿ç”¨çš„äººç›´æŽ¥é€šè¿‡æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶çŸ¥é“æˆ‘ä»¬è‡ªå®šä¹‰äº†å“ªäº›ç»„ä»¶ï¼Œä¸ä¼šè®©ç”¨çš„äººäº§ç”Ÿä¸å¿…è¦çš„æƒŠè®¶ï¼Œè¿™æ˜¯ä¸€ç‚¹å†™ framework çš„ç»éªŒï¼Œä¾›ä½ å‚è€ƒã€‚ ç¬¬å››æ­¥ï¼šæˆ‘ä»¬å†™ä¸ªæµ‹è¯•ç”¨ä¾‹æµ‹è¯•ä¸€ä¸‹ã€‚ 12345678910111213141516171819202122232425262728@DataJpaTest@TestInstance(TestInstance.Lifecycle.PER_CLASS)@Import(JpaConfiguration.class)public class UserRepositoryTest &#123; @Autowired private UserRepository userRepository; @MockBean MyAuditorAware myAuditorAware; @Test public void testAuditing() &#123; //ç”±äºŽæµ‹è¯•ç”¨ä¾‹æ¨¡æ‹Ÿweb contextçŽ¯å¢ƒä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ©ç”¨@MockBeanï¼ŒmockæŽ‰æˆ‘ä»¬çš„æ–¹æ³•ï¼ŒæœŸå¾…è¿”å›ž13è¿™ä¸ªç”¨æˆ·ID Mockito.when(myAuditorAware.getCurrentAuditor()).thenReturn(Optional.of(13)); //æˆ‘ä»¬æ²¡æœ‰æ˜¾å¼çš„æŒ‡å®šæ›´æ–°æ—¶é—´ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°äººã€åˆ›å»ºäºº User user = User.builder() .name("jack") .email("123456@126.com") .sex(SexEnum.BOY) .age(20) .build(); userRepository.save(user); //éªŒè¯æ˜¯å¦æœ‰åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ï¼ŒUserIDæ˜¯å¦æ­£ç¡®ï¼› List&lt;User&gt; users = userRepository.findAll(); Assertions.assertEquals(13,users.get(0).getCreateUserId()); Assertions.assertNotNull(users.get(0).getLastModifiedTime()); System.out.println(users.get(0)); &#125;&#125;éœ€è¦æ³¨æ„çš„æ˜¯ï¼š æˆ‘ä»¬åˆ©ç”¨ @MockBean æ¨¡æ‹Ÿ MyAuditorAware è¿”å›žç»“æžœ 13 è¿™ä¸ª User IDï¼› æˆ‘ä»¬æµ‹è¯•å¹¶éªŒè¯ create_user_id æ˜¯å¦æ˜¯æˆ‘ä»¬é¢„æœŸçš„ã€‚ æµ‹è¯•ç»“æžœå¦‚ä¸‹ï¼š 1User(id=1, name=jack, email=123456@126.com, sex=BOY, age=20, deleted=null, createUserId=13, createTime=Sat Oct 03 21:19:57 CST 2020, lastModifiedUserId=13, lastModifiedTime=Sat Oct 03 21:19:57 CST 2020) ç»“æžœå®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚ æ–¹å¼äºŒï¼šå®žä½“é‡Œé¢å®žçŽ°Auditable æŽ¥å£æˆ‘ä»¬æ”¹ä¸€ä¸‹ä¸Šé¢çš„ User å®žä½“å¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "addresses")@EntityListeners(AuditingEntityListener.class)public class User implements Auditable&lt;Integer,Long, Instant&gt; &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email; @Enumerated(EnumType.STRING) private SexEnum sex; private Integer age; @OneToMany(mappedBy = "user") @JsonIgnore private List&lt;UserAddress&gt; addresses; private Boolean deleted; private Integer createUserId; private Instant createTime; private Integer lastModifiedUserId; private Instant lastModifiedTime; @Override public Optional&lt;Integer&gt; getCreatedBy() &#123; return Optional.ofNullable(this.createUserId); &#125; @Override public void setCreatedBy(Integer createdBy) &#123; this.createUserId = createdBy; &#125; @Override public Optional&lt;Instant&gt; getCreatedDate() &#123; return Optional.ofNullable(this.createTime); &#125; @Override public void setCreatedDate(Instant creationDate) &#123; this.createTime = creationDate; &#125; @Override public Optional&lt;Integer&gt; getLastModifiedBy() &#123; return Optional.ofNullable(this.lastModifiedUserId); &#125; @Override public void setLastModifiedBy(Integer lastModifiedBy) &#123; this.lastModifiedUserId = lastModifiedBy; &#125; @Override public void setLastModifiedDate(Instant lastModifiedDate) &#123; this.lastModifiedTime = lastModifiedDate; &#125; @Override public Optional&lt;Instant&gt; getLastModifiedDate() &#123; return Optional.ofNullable(this.lastModifiedTime); &#125; @Override public boolean isNew() &#123; return id==null; &#125;&#125; ä¸Žç¬¬ä¸€ç§æ–¹å¼çš„å·®å¼‚æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬è¦åŽ»æŽ‰ä¸Šé¢è¯´çš„å››ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”è¦å®žçŽ°æŽ¥å£ Auditable çš„æ–¹æ³•ï¼Œä»£ç ä¼šå˜å¾—å¾ˆå†—ä½™å’Œå•°å”†ã€‚ è€Œå…¶ä»–éƒ½ä¸å˜ï¼Œæˆ‘ä»¬å†è·‘ä¸€æ¬¡åˆšæ‰çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå‘çŽ°æ•ˆæžœæ˜¯ä¸€æ ·çš„ã€‚ä»Žä»£ç çš„å¤æ‚ç¨‹åº¦æ¥çœ‹ï¼Œè¿™ç§æ–¹å¼ä¸æŽ¨èä½¿ç”¨ã€‚ æ–¹å¼ä¸‰ï¼šåˆ©ç”¨ @MappedSuperclass æ³¨è§£å®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³å…¬å…± BaseEntity çš„é—®é¢˜ï¼Œè€Œä¸”å…¶ä»£è¡¨çš„æ˜¯ç»§æ‰¿å®ƒçš„æ¯ä¸€ä¸ªç±»éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¡¨ã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ @MappedSuperclass çš„è¯­æ³•ã€‚ 12345@Documented@Target(&#123;TYPE&#125;)@Retention(RUNTIME)public @interface MappedSuperclass &#123;&#125; å®ƒæ³¨è§£é‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œå…¶å®žå°±æ˜¯ä»£è¡¨äº†æŠ½è±¡å…³ç³»ï¼Œå³æ‰€æœ‰å­ç±»çš„å…¬å…±å­—æ®µè€Œå·²ã€‚é‚£ä¹ˆæŽ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å®žä¾‹ã€‚ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª BaseEntityï¼Œé‡Œé¢æ”¾ä¸€äº›å®žä½“çš„å…¬å…±å­—æ®µå’Œæ³¨è§£ã€‚ 1234567891011121314151617package com.example.jpa.example1.base;import org.springframework.data.annotation.*;import javax.persistence.MappedSuperclass;import java.time.Instant;@Data@MappedSuperclass@EntityListeners(AuditingEntityListener.class)public class BaseEntity &#123; @CreatedBy private Integer createUserId; @CreatedDate private Instant createTime; @LastModifiedBy private Integer lastModifiedUserId; @LastModifiedDate private Instant lastModifiedTime;&#125; æ³¨æ„ï¼š BaseEntity é‡Œé¢éœ€è¦ç”¨ä¸Šé¢æåˆ°çš„å››ä¸ªæ³¨è§£ï¼Œå¹¶ä¸”åŠ ä¸Š@EntityListeners(AuditingEntityListener.class)ï¼Œè¿™æ ·æ‰€æœ‰çš„å­ç±»å°±ä¸éœ€è¦åŠ äº†ã€‚ ç¬¬äºŒæ­¥ï¼šå®žä½“ç›´æŽ¥ç»§æ‰¿ BaseEntity å³å¯ã€‚ æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ User å®žä¾‹ç»§æ‰¿ BaseEntityï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructor@ToString(exclude = "addresses")public class User extends BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email; @Enumerated(EnumType.STRING) private SexEnum sex; private Integer age; @OneToMany(mappedBy = "user") @JsonIgnore private List&lt;UserAddress&gt; addresses; private Boolean deleted;&#125; è¿™æ ·çš„è¯ï¼ŒUser å®žä½“å°±ä¸éœ€è¦å…³å¿ƒå¤ªå¤šï¼Œæˆ‘ä»¬åªå…³æ³¨è‡ªå·±éœ€è¦çš„é€»è¾‘å³å¯ï¼Œå¦‚ä¸‹ï¼š åŽ»æŽ‰äº† @EntityListeners(AuditingEntityListener.class)ï¼› åŽ»æŽ‰äº† @CreatedByã€@CreatedDateã€@LastModifiedByã€@LastModifiedDate å››ä¸ªæ³¨è§£çš„å…¬å…±å­—æ®µã€‚ æŽ¥ç€æˆ‘ä»¬å†è·‘ä¸€ä¸‹ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå‘çŽ°æ•ˆæžœè¿˜æ˜¯ä¸€æ ·çš„ã€‚ è¿™ç§æ–¹å¼ï¼Œæ˜¯æˆ‘æœ€æŽ¨èçš„ï¼Œä¹Ÿæ˜¯å®žé™…å·¥ä½œä¸­ä½¿ç”¨æœ€å¤šçš„ä¸€ç§æ–¹å¼ã€‚å®ƒçš„å¥½å¤„æ˜¾è€Œæ˜“è§å°±æ˜¯å…¬ç”¨æ€§å¼ºï¼Œä»£ç ç®€å•ï¼Œéœ€è¦å…³å¿ƒçš„å°‘ã€‚ é€šè¿‡ä¸Šé¢çš„å®žé™…æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…¶å®žä¹Ÿèƒ½å¾ˆå®¹æ˜“å‘çŽ° Auditing å¸®æˆ‘ä»¬è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹ã€‚ JPA çš„å®¡è®¡åŠŸèƒ½è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ å¯ä»¥å¾ˆå®¹æ˜“åœ°è®©æˆ‘ä»¬å†™è‡ªå·±çš„ BaseEntityï¼ŒæŠŠä¸€äº›å…¬å…±çš„å­—æ®µæ”¾åœ¨é‡Œé¢ï¼Œä¸éœ€è¦æˆ‘ä»¬å…³å¿ƒå¤ªå¤šå’Œä¸šåŠ¡æ— å…³çš„å­—æ®µï¼Œæ›´å®¹æ˜“è®©æˆ‘ä»¬å…¬å¸çš„è¡¨æ›´åŠ ç»Ÿä¸€å’Œè§„èŒƒï¼Œå°±æ˜¯ç»Ÿä¸€åŠ ä¸Š @CreatedByã€@CreatedDateã€@LastModifiedByã€@LastModifiedDate ç­‰ã€‚ å®žé™…å·¥ä½œä¸­ï¼ŒBaseEntity å¯èƒ½è¿˜æ›´å¤æ‚ä¸€ç‚¹ï¼Œæ¯”å¦‚è¯´æŠŠ ID å’Œ @Version åŠ è¿›åŽ»ï¼Œä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼š 123456789101112131415161718@Data@MappedSuperclass@EntityListeners(AuditingEntityListener.class)public class BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; @CreatedBy private Integer createUserId; @CreatedDate private Instant createTime; @LastModifiedBy private Integer lastModifiedUserId; @LastModifiedDate private Instant lastModifiedTime; @Version private Integer version;&#125; Auditing åœ¨å®žæˆ˜åº”ç”¨åœºæ™¯ä¸­ï¼Œæ¯”è¾ƒé€‚åˆåšåŽå°ç®¡ç†é¡¹ç›®ï¼Œå¯¹åº”çº¯ç²¹çš„ RESTAPI é¡¹ç›®ï¼Œæä¾›ç»™ç”¨æˆ·ç›´æŽ¥æŸ¥è¯¢çš„ API çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä¸€ä¸ªç‰¹æ®Šçš„ User IDã€‚ Auditing çš„å®žçŽ°åŽŸç†ç¬¬ä¸€æ­¥ï¼šè¿˜æ˜¯ä»Ž @EnableJpaAuditing å…¥æ‰‹åˆ†æžã€‚ æˆ‘ä»¬å‰é¢è®²äº†å®ƒçš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™æ¬¡æˆ‘ä»¬åˆ†æžä¸€ä¸‹å…¶åŠ è½½åŽŸç†ï¼Œçœ‹ä¸‹é¢çš„å›¾ï¼š æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œé¦–å…ˆ Auditing è¿™å¥—å°è£…æ˜¯ Spring Data JPA å®žçŽ°çš„ï¼Œè€Œä¸æ˜¯ Java Persistence API è§„å®šçš„ï¼Œå…¶æ³¨è§£é‡Œé¢è¿˜æœ‰ä¸€é¡¹é‡è¦åŠŸèƒ½å°±æ˜¯ @Import(JpaAuditingRegistrar.class) è¿™ä¸ªç±»ï¼Œå®ƒå¸®æˆ‘ä»¬å¤„ç† Auditing çš„é€»è¾‘ã€‚ æˆ‘ä»¬çœ‹å…¶æºç ï¼Œä¸€æ­¥ä¸€æ­¥åœ° debug ä¸‹åŽ»å¯ä»¥å‘çŽ°å¦‚ä¸‹æ‰€ç¤ºï¼š è¿›ä¸€æ­¥è¿›å…¥åˆ°å¦‚ä¸‹æ–¹æ³•ä¸­ï¼š å¯ä»¥çœ‹åˆ° Spring å®¹å™¨ç»™ AuditingEntityListener.class æ³¨å…¥äº†ä¸€ä¸ª AuditingHandler çš„å¤„ç†ç±»ã€‚ ç¬¬äºŒæ­¥ï¼šæ‰“å¼€ AuditingEntityListener.class çš„æºç åˆ†æž debug ä¸€ä¸‹ã€‚ 12345678910111213141516171819202122232425262728@Configurablepublic class AuditingEntityListener &#123; private @Nullable ObjectFactory&lt;AuditingHandler&gt; handler; public void setAuditingHandler(ObjectFactory&lt;AuditingHandler&gt; auditingHandler) &#123; Assert.notNull(auditingHandler, "AuditingHandler must not be null!"); this.handler = auditingHandler; &#125; @PrePersist public void touchForCreate(Object target) &#123; Assert.notNull(target, "Entity must not be null!"); if (handler != null) &#123; AuditingHandler object = handler.getObject(); if (object != null) &#123; object.markCreated(target); &#125; &#125; &#125; @PreUpdate public void touchForUpdate(Object target) &#123; Assert.notNull(target, "Entity must not be null!"); if (handler != null) &#123; AuditingHandler object = handler.getObject(); if (object != null) &#123; object.markModified(target); &#125; &#125; &#125;&#125; ä»Žæºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAuditingEntityListener çš„å®žçŽ°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåˆ©ç”¨äº† Java Persistence API é‡Œé¢çš„@PrePersistã€@PreUpdate å›žè°ƒå‡½æ•°ï¼Œåœ¨æ›´æ–°å’Œåˆ›å»ºä¹‹å‰é€šè¿‡AuditingHandler æ·»åŠ äº†ç”¨æˆ·ä¿¡æ¯å’Œæ—¶é—´ä¿¡æ¯ã€‚ åŽŸç†åˆ†æžç»“è®ºæŸ¥çœ‹ Auditing çš„å®žçŽ°æºç ï¼Œå…¶å®žç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ€è·¯ï¼Œå°±æ˜¯æ€Žä¹ˆåˆ©ç”¨ @PrePersistã€@PreUpdate ç­‰å›žè°ƒå‡½æ•°å’Œ @EntityListeners å®šä¹‰è‡ªå·±çš„æ¡†æž¶ä»£ç ã€‚è¿™æ˜¯å€¼å¾—æˆ‘ä»¬å­¦ä¹ å’Œå‚è€ƒçš„ï¼Œæ¯”å¦‚è¯´ Auditing çš„æ“ä½œæ—¥å¿—åœºæ™¯ç­‰ã€‚ æƒ³æˆåŠŸé…ç½® Auditing åŠŸèƒ½ï¼Œå¿…é¡»å°† @EnableJpaAuditing å’Œ @EntityListeners(AuditingEntityListener.class) ä¸€èµ·ä½¿ç”¨æ‰æœ‰æ•ˆã€‚ æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ä¸é€šè¿‡ Spring data JPA ç»™æˆ‘ä»¬æä¾›çš„ Auditing åŠŸèƒ½ï¼Œè€Œæ˜¯ç›´æŽ¥ä½¿ç”¨ @PrePersistã€@PreUpdate å›žè°ƒå‡½æ•°æ³¨è§£åœ¨å®žä½“ä¸Šï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæžœå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œå› ä¸ºå›žè°ƒå‡½æ•°æ˜¯å®žçŽ°çš„æœ¬è´¨ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Auditing</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Stream API]]></title>
    <url>%2F2020%2F11%2F05%2FStream%20API%2F</url>
    <content type="text"><![CDATA[Stream ç®€ä»‹ä»€ä¹ˆæ˜¯æµStream ä¸æ˜¯é›†åˆå…ƒç´ ï¼Œå®ƒä¸æ˜¯æ•°æ®ç»“æž„å¹¶ä¸ä¿å­˜æ•°æ®ï¼Œå®ƒæ˜¯æœ‰å…³ç®—æ³•å’Œè®¡ç®—çš„ã€‚ ä¸ŽIteratorçš„å¼‚åŒ â€‹ ç›¸åŒç‚¹ï¼š å•å‘çš„ï¼Œæ•°æ®åªèƒ½éåŽ†ä¸€æ¬¡ã€‚ â€‹ ä¸åŒç‚¹ï¼š streamå¯ä»¥å¹¶è¡Œæ“ä½œ Stream çš„å¦å¤–ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œ==æ•°æ®æºæœ¬èº«å¯ä»¥æ˜¯æ— é™çš„==ã€‚ Stream çš„å¹¶è¡Œæ“ä½œä¾èµ–äºŽ Java7 ä¸­å¼•å…¥çš„ Fork/Join æ¡†æž¶æ¥æ‹†åˆ†ä»»åŠ¡å’ŒåŠ é€Ÿå¤„ç†è¿‡ç¨‹ã€‚ 123456Java çš„å¹¶è¡ŒAPIæ¼”å˜åŽ†ç¨‹åŸºæœ¬å¦‚ä¸‹ï¼š 1. 1.0-1.4 ä¸­çš„ java.lang.Thread 2. 5.0 ä¸­çš„ java.util.concurrent 3. 6.0 ä¸­çš„ Phasers ç­‰ 4. 7.0 ä¸­çš„ Fork/Join æ¡†æž¶ 5. 8.0 ä¸­çš„ Lambda ç”Ÿæˆ Stream Sourceæ–¹å¼Collection and Array Collection.stream() Collection.parallelStream() Arrays.stream(T array) or Stream.of() BufferedReader java.io.BufferedReader.lines() é™æ€å·¥åŽ‚ java.util.stream.IntStream.range() java.nio.file.Files.walk() è‡ªå·±æž„å»º java.util.Spliterator å…¶å®ƒ Random.ints() BitSet.stream() Pattern.splitAsStream(java.lang.CharSequence) JarFile.stream() å¸¸è§çš„streamæŽ¥å£ç»§æ‰¿å…³ç³»å¦‚å›¾ å¯¹äºŽåŸºæœ¬æ•°å€¼åž‹ï¼Œç›®å‰æœ‰ä¸‰ç§å¯¹åº”çš„åŒ…è£…ç±»åž‹ Streamï¼š IntStreamã€LongStreamã€DoubleStreamã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ Stream&lt;Integer&gt;ã€Stream&lt;Long&gt;ã€Stream&lt;Double&gt;ï¼Œä½†æ˜¯ boxing å’Œ unboxing ä¼šå¾ˆè€—æ—¶ï¼Œæ‰€ä»¥ç‰¹åˆ«ä¸ºè¿™ä¸‰ç§åŸºæœ¬æ•°å€¼åž‹æä¾›äº†å¯¹åº”çš„ Streamã€‚ ä¸ºä»€ä¹ˆä¸ºä¸åŒæ•°æ®ç±»åž‹è®¾ç½®ä¸åŒstreamæŽ¥å£ æé«˜æ€§èƒ½ å¢žåŠ ç‰¹å®šæŽ¥å£å‡½æ•° ä¸ºä»€ä¹ˆä¸æŠŠIntStreamç­‰è®¾è®¡æˆStreamçš„å­æŽ¥å£ï¼Ÿæ¯•ç«Ÿè¿™æŽ¥å£ä¸­çš„æ–¹æ³•åå¤§éƒ¨åˆ†æ˜¯ä¸€æ ·çš„ã€‚ â€‹ è™½ç„¶è¿™äº›æ–¹æ³•çš„åå­—ç›¸åŒï¼Œä½†æ˜¯è¿”å›žç±»åž‹ä¸åŒï¼Œå¦‚æžœè®¾è®¡æˆçˆ¶å­æŽ¥å£å…³ç³»ï¼Œè¿™äº›æ–¹æ³•å°†ä¸èƒ½å…±å­˜ï¼Œ â€‹ å› ä¸ºJavaä¸å…è®¸åªæœ‰è¿”å›žç±»åž‹ä¸åŒçš„æ–¹æ³•é‡è½½ã€‚ è™½ç„¶å¤§éƒ¨åˆ†æƒ…å†µä¸‹streamæ˜¯å®¹å™¨è°ƒç”¨Collection.stream()æ–¹æ³•å¾—åˆ°çš„ï¼Œä½†streamå’Œcollectionsæœ‰ä»¥ä¸‹ä¸åŒï¼š æ— å­˜å‚¨ã€‚streamä¸æ˜¯ä¸€ç§æ•°æ®ç»“æž„ï¼Œå®ƒåªæ˜¯æŸç§æ•°æ®æºçš„ä¸€ä¸ªè§†å›¾ï¼Œæ•°æ®æºå¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒJavaå®¹å™¨æˆ–I/O channelç­‰ã€‚ ä¸ºå‡½æ•°å¼ç¼–ç¨‹è€Œç”Ÿã€‚å¯¹streamçš„ä»»ä½•ä¿®æ”¹éƒ½ä¸ä¼šä¿®æ”¹èƒŒåŽçš„æ•°æ®æºï¼Œæ¯”å¦‚å¯¹streamæ‰§è¡Œè¿‡æ»¤æ“ä½œå¹¶ä¸ä¼šåˆ é™¤è¢«è¿‡æ»¤çš„å…ƒç´ ï¼Œè€Œæ˜¯ä¼šäº§ç”Ÿä¸€ä¸ªä¸åŒ…å«è¢«è¿‡æ»¤å…ƒç´ çš„æ–°streamã€‚ æƒ°å¼æ‰§è¡Œã€‚streamä¸Šçš„æ“ä½œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåªæœ‰ç­‰åˆ°ç”¨æˆ·çœŸæ­£éœ€è¦ç»“æžœçš„æ—¶å€™æ‰ä¼šæ‰§è¡Œã€‚ å¯æ¶ˆè´¹æ€§ã€‚streamåªèƒ½è¢«â€œæ¶ˆè´¹â€ä¸€æ¬¡ï¼Œä¸€æ—¦éåŽ†è¿‡å°±ä¼šå¤±æ•ˆï¼Œå°±åƒå®¹å™¨çš„è¿­ä»£å™¨é‚£æ ·ï¼Œæƒ³è¦å†æ¬¡éåŽ†å¿…é¡»é‡æ–°ç”Ÿæˆã€‚ Stream æ“ä½œå¯¹streamçš„æ“ä½œåˆ†ä¸ºä¸ºä¸¤ç±»ï¼Œä¸­é—´æ“ä½œ(intermediate)å’Œç»“æŸæ“ä½œ(terminal)ï¼ŒäºŒè€…ç‰¹ç‚¹æ˜¯ï¼š ä¸­é—´æ“ä½œæ€»æ˜¯ä¼šæƒ°å¼æ‰§è¡Œï¼Œè°ƒç”¨ä¸­é—´æ“ä½œåªä¼šç”Ÿæˆä¸€ä¸ªæ ‡è®°äº†è¯¥æ“ä½œçš„æ–°streamï¼Œä»…æ­¤è€Œå·²ã€‚ ç»“æŸæ“ä½œä¼šè§¦å‘å®žé™…è®¡ç®—ï¼Œè®¡ç®—å‘ç”Ÿæ—¶ä¼šæŠŠæ‰€æœ‰ä¸­é—´æ“ä½œç§¯æ”’çš„æ“ä½œä»¥pipelineçš„æ–¹å¼æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿­ä»£æ¬¡æ•°ã€‚è®¡ç®—å®Œæˆä¹‹åŽstreamå°±ä¼šå¤±æ•ˆã€‚ StreamæŽ¥å£çš„éƒ¨åˆ†å¸¸è§æ–¹æ³• æ“ä½œç±»åž‹ æŽ¥å£æ–¹æ³• intermediate concat() ã€distinct()ã€ filter()ã€ flatMap()ã€ limit()ã€ map()ã€ peek()ã€ skip()ã€ sorted() ã€parallel() ã€sequential()ã€ unordered() terminal forEach()ã€forEachOrdered()ã€findFirst()ã€ findAny() ã€count() ã€max()ã€ min()ã€anyMatch()ã€allMatch() ã€noneMatch()ã€toArray()ã€ collect()ã€reduce() short-circuiting anyMatch()ã€ allMatch()ã€ noneMatch()ã€ findFirst()ã€ findAny()ã€ limit() åŒºåˆ†ä¸­é—´æ“ä½œå’Œç»“æŸæ“ä½œæœ€ç®€å•çš„æ–¹æ³• â€‹ å°±æ˜¯çœ‹æ–¹æ³•çš„è¿”å›žå€¼ï¼Œè¿”å›žå€¼ä¸ºstreamçš„å¤§éƒ½æ˜¯ä¸­é—´æ“ä½œï¼Œå¦åˆ™æ˜¯ç»“æŸæ“ä½œã€‚ TerminalforEach() / forEachOrdered()void forEach(Consumer&lt;? super E&gt; action) void forEachOrdered(Consumer&lt;? super E&gt; action) ä½œç”¨æ˜¯å¯¹å®¹å™¨ä¸­çš„æ¯ä¸ªå…ƒç´ æ‰§è¡ŒactionæŒ‡å®šçš„åŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯å¯¹å…ƒç´ è¿›è¡ŒéåŽ†ã€‚ ç”±äºŽforEach() / forEachOrdered() æ˜¯ç»“æŸæ–¹æ³•ï¼Œä¸Šè¿°ä»£ç ä¼šç«‹å³æ‰§è¡Œï¼Œè¾“å‡ºæ‰€æœ‰å­—ç¬¦ä¸²ã€‚ 123// ä½¿ç”¨Stream.forEach()è¿­ä»£ Stream.of("AAA", "BBB", "CCC").parallel().forEach(System.out::println); Stream.of("AAA", "BBB", "CCC").parallel().forEachOrdered(System.out::println); åŒºåˆ« â€‹ åœ¨å¹¶è¡Œæµä¸­ï¼ŒforEachOrdered()ä¼šä¿è¯æ˜¯é¡ºåºæ‰§è¡Œï¼Œè€ŒforEach()ä¸ä¼šã€‚ findFirst() / findAny()è¿™æ˜¯ä¸€ä¸ª terminal å…¼ short-circuiting æ“ä½œï¼Œå®ƒæ€»æ˜¯è¿”å›ž Stream çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…ç©ºã€‚ è¿”å›žå€¼ç±»åž‹ï¼šOptional ç›®çš„æ˜¯å°½å¯èƒ½é¿å… NullPointerException 123456789101112131415161718192021222324252627public static void main(String[] args)&#123; String strA = " abcd "; String strB = null; print(strA); print(""); print(strB); getLength(strA); getLength(""); getLength(strB);&#125;public static void print(String text) &#123; // Java 8 Optional.ofNullable(text).ifPresent(System.out::println); // Pre-Java 8 if (text != null) &#123; System.out.println(text); &#125; &#125;public static int getLength(String text) &#123; // Java 8 return Optional.ofNullable(text).map(String::length).orElse(-1); // Pre-Java 8 // return if (text != null) ? text.length() : -1; &#125;; count()æ±‚ç»“æžœçš„ä¸ªæ•°ï¼Œç±»ä¼¼äºŽlistçš„size()æ–¹æ³• è¿”å›žå€¼ï¼šlongåž‹ 12long count = Stream.of("111", "2", "33").filter(s -&gt; s.length() == 1).count();System.out.println(count); max() / min()æ±‚æœ€å¤§å€¼ï¼Œæœ€å°å€¼ å‚æ•°ï¼šComparatoræŽ¥å£ è¿”å›žå€¼ï¼šoptional 123456789String str1 = Stream.of("111", "2", "33").max((s1, s2) -&gt; s1.length() - s2.length()).get();String str2 = Stream.of("111", "2", "33").max(Comparator.comparingInt(String::length)).get();System.out.println(str1);System.out.println(str2);String str3 = Stream.of("111", "2", "33").min((s1, s2) -&gt; s1.length() - s2.length()).get();String str4 = Stream.of("111", "2", "33").min(Comparator.comparingInt(String::length)).get();System.out.println(str3);System.out.println(str4); anyMatch()æŸ¥æ‰¾streamä¸­æ˜¯å¦å­˜åœ¨ä»»ä½•ä¸€ä¸ªå…ƒç´ æ»¡è¶³åŒ¹é…æ¡ä»¶ï¼Œå¦‚æžœæ¡ä»¶ä¸ºtrue å°±åœæ­¢éåŽ†ï¼Œå¦åˆ™ç»§ç»­éåŽ†ã€‚ å‚æ•°ï¼šPredicateæŽ¥å£ è¿”å›žå€¼ï¼šboolean 1234boolean isStartWithA = Stream.of("d2", "a2", "b1", "b3", "c") .map(String::toUpperCase) .anyMatch(s -&gt; s.startsWith("A"));System.out.println(isStartWithA); ä¸Šè¿°ä¾‹å­ â€‹ éåŽ†åˆ°a2ï¼Œåˆ™æ»¡è¶³anyMatchçš„æ¡ä»¶ï¼Œåˆ™é€€å‡ºéåŽ†ï¼Œå¹¶è¿”å›žtrueã€‚ allMatch() / noneMatch()allMatch(): æŸ¥æ‰¾streamä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦==éƒ½æ»¡è¶³==ç»™å®šçš„åŒ¹é…æ¡ä»¶ï¼Œå¦‚æžœæ¡ä»¶ä¸º false å°±åœæ­¢éåŽ†ï¼Œå¦åˆ™ç»§ç»­éåŽ†ã€‚ noneMatch(): æŸ¥æ‰¾streamä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦==éƒ½ä¸æ»¡è¶³==ç»™å®šçš„åŒ¹é…æ¡ä»¶ï¼Œå¦‚æžœæ¡ä»¶ä¸º true å°±åœæ­¢éåŽ†ï¼Œå¦åˆ™ç»§ç»­éåŽ†ã€‚ å‚æ•°ï¼šPredicate æŽ¥å£ è¿”å›žå€¼ï¼šboolean 12345boolean isStartWithA = Stream.of("d2", "a2", "b1", "b3", "c") .map(String::toUpperCase) .allMatch(s -&gt; s.startsWith("A")); //.noneMatch(s -&gt; s.startsWith("A"));System.out.println(isStartWithA); æŸ¥çœ‹æ‰§è¡Œæµç¨‹ï¼Œå¯ä»¥é€‰æ‹©åœ¨è¡¨è¾¾å¼é‡Œè¾“å‡ºæ£€éªŒï¼š â€‹ å¦‚ allMatch()ï¼Œå¯ä»¥æ›¿æ¢æˆnoneMatch() å’ŒanyMatch() 12345678910&gt; Stream.of("d2", "a2", "b1", "b3", "c")&gt; .map(s -&gt; &#123;&gt; System.out.println("map: " + s);&gt; return s.toUpperCase();&gt; &#125;)&gt; .allMatch(s -&gt; &#123;&gt; System.out.println("allMatch: " + s);&gt; return s.startsWith("A");&gt; &#125;);&gt; toArray()toArray() å°†æµè½¬æ¢ä¸ºæ•°ç»„ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š 12Object[] toArray()&lt;A&gt; A[] toArray(IntFunction&lt;A[]&gt; generator) æ— å‚çš„ï¼Œè¿”å›žä¸€ä¸ªobjectå¯¹è±¡æ•°ç»„ï¼Œä¸€èˆ¬æ²¡ä»€ä¹ˆç”¨ã€‚ æœ‰å‚çš„ï¼Œéœ€è¦å†™ä¸€ä¸ªfuncation&lt;T,R&gt;æŽ¥å£ï¼Œ è€ŒIntFuncation&lt;R&gt; æ˜¯funcation&lt;T,R&gt;æŽ¥å£çš„å­æŽ¥å£ï¼Œè§„å®šäº†è¾“å…¥æ˜¯intç±»åž‹ã€‚ 12345678// :: è¡¨ç¤ºå¼•ç”¨ï¼Œä¸€ç§æ˜¯æ–¹æ³•(é™æ€ï¼Œå®žä¾‹)çš„å¼•ç”¨;// ä¸€ç§çš„æž„é€ æ–¹æ³•çš„å¼•ç”¨(æž„é€ çš„éœ€è¦åç€å†™,å¦‚new String[] &gt; String[]::new)IntFunction&lt;String[]&gt; function = String[]::new;String[] as = Stream.of("AAA", "BBB", "CCC").parallel().toArray(function);System.out.println(Arrays.toString(as)); collect()1. Collection, Collections, collect, Collector, Collectors Collectionæ˜¯Javaé›†åˆçš„ç¥–å…ˆæŽ¥å£ã€‚Collectionsæ˜¯java.utilåŒ…ä¸‹çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå†…æ¶µå„ç§å¤„ç†é›†åˆçš„é™æ€æ–¹æ³•ã€‚java.util.stream.Stream#collect(java.util.stream.Collector&lt;? super T,A,R&gt;)æ˜¯Streamçš„ä¸€ä¸ªå‡½æ•°ï¼Œè´Ÿè´£æ”¶é›†æµã€‚java.util.stream.Collector æ˜¯ä¸€ä¸ªæ”¶é›†å‡½æ•°çš„æŽ¥å£, å£°æ˜Žäº†ä¸€ä¸ªæ”¶é›†å™¨çš„åŠŸèƒ½ã€‚java.util.stream.Collectosåˆ™æ˜¯ä¸€ä¸ªæ”¶é›†å™¨çš„å·¥å…·ç±»ï¼Œå†…ç½®äº†ä¸€ç³»åˆ—æ”¶é›†å™¨å®žçŽ°ã€‚ å°† stream è½¬æ¢æˆ æ”¶é›†å™¨ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•ã€‚ 1234&lt;R&gt; R collect(Supplier&lt;R&gt; supplier, BiConsumer&lt;R, ? super T&gt; accumulator, BiConsumer&lt;R, R&gt; combiner);&lt;R, A&gt; R collect(Collector&lt;? super T, A, R&gt; collector) ç¬¬ä¸€ç§æž„é€ æ–¹æ³•ï¼š 12345678910111213 List&lt;String&gt; list = Lists.newArrayList("111", "222", "333", "444", "555"); //Supplier&lt;R&gt;æŽ¥å£ ç”¨æ¥åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªæŒ‡å®šæ•°æ®ç±»åž‹çš„å¯¹è±¡ //BiConsumer&lt;R, ? super T&gt; accumulatoræŽ¥å£ ç”¨æ¥å£°æ˜Žä¸€äº›æ“ä½œã€‚ // * å‚æ•°R æ˜¯æŒ‡supplieråˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œ // * å‚æ•°T æ˜¯æŒ‡æ¯æ¬¡è¿­ä»£çš„å¯¹è±¡ //BiConsumer&lt;R, R&gt; combineræŽ¥å£ æŒ‡å®šæ‰§è¡Œçš„å‚æ•°ç±»åž‹ï¼Œä»¥åŠè¿”å›žå€¼ç±»åž‹ HashMap&lt;String, String&gt; map = list.stream() .collect(HashMap::new, (hashMap, str) -&gt; hashMap.put(str, str),// (hashMap, hashMap2) -&gt; hashMap.putAll(hashMap2));// HashMap::putAll); Map::putAll); è§£é‡Š â€‹ 1ã€æ¯æ¬¡å¾ªçŽ¯éƒ½åˆ›å»ºä¸€ä¸ªhashMap â€‹ 2ã€æ¯æ¬¡å¾ªçŽ¯éƒ½æŠŠå½“å‰éåŽ†çš„å€¼ï¼Œå­˜å‚¨åœ¨åˆ›å»ºå‡ºæ¥çš„hashMapä¸­ â€‹ 3ã€æœ€åŽå†ç”¨ä¸Šä¸€æ¬¡çš„hashMapï¼ŒputAllè¿™æ¬¡éåŽ†çš„hashMapï¼Œæœ€åŽéåŽ†å®ŒåŽå°±ä¼šè¿”å›žä¸€ä¸ªæ€»çš„Map ç¬¬äºŒç§æž„é€ æ–¹æ³•ï¼š â€‹ ä½¿ç”¨Collectorså·¥å…·ç±» 2.Collectors collecté‡Œé¢çš„æ“ä½œç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚ å¯ä»¥æŠŠstreamï¼Œä½¿ç”¨æŸäº›æ•°æ®ç»“æž„å­˜å‚¨èµ·æ¥ã€‚è€Œcollectorså°±æ˜¯æ–¹ä¾¿æˆ‘ä»¬æž„é€ æ”¶é›†å™¨çš„ã€‚ Collectors.toList() ï¼š æž„é€ ä¸€ä¸ªlist Collectors.toSet() ï¼š æž„é€ ä¸€ä¸ªset Collectors.toCollection(ArrayList::new) ï¼š æž„é€ ä¸€ä¸ªè‡ªå®šä¹‰æ”¶é›†å™¨ï¼Œå‚æ•°ç”¨è‡ªå®šä¹‰æ”¶é›†å™¨ï¼Œè¿™é‡Œç”¨liståªæ˜¯æ–¹ä¾¿ä¸¾ä¾‹ Collectors.joining() ï¼š ==æž„é€ ä¸€ä¸ªstring==ï¼Œå‚æ•°æ˜¯åˆ†å‰²ç¬¦ï¼Œå‰ç¼€ï¼ŒåŽç¼€ Collectors.toMap() å’Œ Collectors.toConcurrentMap() æœ‰ä¸‰ä¸ªæ–¹æ³• æž„é€ æ–¹æ³•å·®ä¸å¤šï¼Œè¿™é‡Œåªåˆ—ä¸¾toMapçš„æž„é€ æ–¹æ³• 1234567891011Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper, Function&lt;? super T, ? extends U&gt; valueMapper) Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper, Function&lt;? super T, ? extends U&gt; valueMapper, BinaryOperator&lt;U&gt; mergeFunction) Collector&lt;T, ?, M&gt; toMap(Function&lt;? super T, ? extends K&gt; keyMapper, Function&lt;? super T, ? extends U&gt; valueMapper, BinaryOperator&lt;U&gt; mergeFunction, Supplier&lt;M&gt; mapSupplier) â€‹ 12345678910111213141516171819202122232425262728293031323334353637 List&lt;String&gt; list = Lists.newArrayList("AAA", "BBB", "CCC", "DDD", "EEE"); //Function.identity() : ä»£è¡¨å½“å‰éåŽ†çš„å¯¹è±¡ //ç¬¬ä¸€ç§æž„é€ æ–¹æ³• //Function&lt;T, K&gt; : æŽ¥å£ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¾“å…¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å‡º //å¦‚ Function&lt;Party,String&gt; fun = party -&gt; party.getPartyType() Map&lt;String, String&gt; collect = list.stream() .collect(Collectors.toMap(Function.identity(), Function.identity())); Map&lt;String, String&gt; collect1 = list.stream() .collect(Collectors.toMap(String::toUpperCase, String::toLowerCase)); //å¦‚æžœkey,valueæ˜¯ç©ºçš„è¯ï¼Œä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œ //å› ä¸ºCollectors.toMap()åº•å±‚ä½¿ç”¨Map.merge()ï¼Œmergeä¸­key, valueä¸èƒ½ä¸ºç©º Map&lt;String, String&gt; collect2 = list.stream()// .collect(Collectors.toMap(String::toUpperCase, null)); .collect(Collectors.toMap(null, String::toUpperCase)); System.out.println(collect2); //ç¬¬äºŒç§æž„é€ æ–¹æ³• // å®šä¹‰å½“keyé‡å¤æ—¶çš„æ“ä½œï¼ŒCollectors.toMap()æ–¹æ³•å¦‚æžœkeyç›¸åŒï¼Œä¼šæŠ¥å¼‚å¸¸ï¼Œå¯ä»¥è‡ªå®šä¹‰å½“keyé‡å¤æ—¶çš„æ“ä½œ // BinaryOperator&lt;U&gt; mergeFunction Map&lt;String, String&gt; collect3 = list.stream() .collect(Collectors.toMap( String::toUpperCase, String::toLowerCase, (oldValue, newValue) -&gt; oldValue)); //ç¬¬ä¸‰ç§æž„é€ æ–¹æ³• //Supplier&lt;M&gt; mapSupplier :è‡ªå®šä¹‰ä½¿ç”¨Mapçš„ç±»åž‹ Map&lt;String, String&gt; collect4 = list.stream() .collect(Collectors.toMap( String::toUpperCase, String::toLowerCase, (oldValue, newValue) -&gt; oldValue,// HashMap::new));// ConcurrentHashMap::new)); LinkedHashMap::new)); toMap å’Œ toConcurrentMap çš„å¼‚åŒ Collectors.summarizingInt(String::length) â€‹ åŒç†æœ‰Doubleï¼ŒLong 12345678List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");IntSummaryStatistics collect = list.stream().collect(Collectors.summarizingInt(String::length));System.out.println(collect.getMax());System.out.println(collect.getMin());System.out.println(collect.getSum());System.out.println(collect.getAverage());System.out.println(collect.getCount()); å¯ä»¥ç»Ÿä¸€æ±‚é•¿åº¦æœ€å¤§å€¼ï¼Œæœ€å°å€¼ï¼Œå¹³å‡æ•°ï¼Œæ±‚å’Œï¼Œæ±‚ä¸ªæ•° Collectors.groupingBy() æœ‰ä¸‰ä¸ªæž„é€ æ–¹æ³•ï¼Œåˆ—è¡¨åˆ†ç»„ æŒ‰functionçš„æ¡ä»¶ï¼Œåˆ†æˆå¤šä¸ªç»„ 12345678Collector&lt;T, ?, Map&lt;K, List&lt;T&gt;&gt;&gt; groupingBy(Function&lt;? super T, ? extends K&gt; classifier)Collector&lt;T, ?, Map&lt;K, D&gt;&gt; groupingBy(Function&lt;? super T, ? extends K&gt; classifier, Collector&lt;? super T, A, D&gt; downstream) Collector&lt;T, ?, M&gt; groupingBy(Function&lt;? super T, ? extends K&gt; classifier, Supplier&lt;M&gt; mapFactory, Collector&lt;? super T, A, D&gt; downstream) ç¤ºä¾‹ï¼š 12345List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");Map&lt;Integer, List&lt;String&gt;&gt; collect = list.stream() .collect(Collectors.groupingBy(String::length));Map&lt;Integer, Long&gt; collect1 = list.stream() .collect(Collectors.groupingBy(String::length, counting())); Collectors.partitioningBy() ä¸¤ä¸ªæž„é€ æ–¹æ³•ï¼Œåˆ—è¡¨åˆ†å‰² æŒ‰ç…§Predicateï¼Œåˆ†å‰²æˆä¸¤ç»„ã€‚ 123Collector&lt;T, ?, Map&lt;Boolean, D&gt;&gt; partitioningBy(Predicate&lt;? super T&gt;)Collector&lt;T, ?, Map&lt;Boolean, D&gt;&gt; partitioningBy(Predicate&lt;? super T&gt; predicate, Collector&lt;? super T, A, D&gt; downstream) 123456789101112// åˆ†å‰²æ•°æ®å—Map&lt;Boolean, List&lt;Integer&gt;&gt; collectParty = Stream.of(1, 2, 3, 4) .collect(Collectors.partitioningBy(it -&gt; it % 2 == 0));List&lt;Integer&gt; integers = collectParty.get(true);System.out.println(integers);Map&lt;Boolean, Long&gt; partiCount = Stream.of(1, 2, 3, 4) .collect(Collectors.partitioningBy(it -&gt; it % 2 == 0, Collectors.counting()));System.out.println("partiCount: " + partiCount);// æ‰“å°ç»“æžœ// partiCount: &#123;false=2, true=2&#125; æ”¶é›†å™¨çš„æž„æˆ 1. åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æžœå®¹å™¨(supplier()) 2. å°†ä¸€ä¸ªæ–°çš„æ•°æ®å…ƒç´ åˆå¹¶åˆ°ä¸€ä¸ªç»“æžœå®¹å™¨ä¸­(accumulator()) 3. å°†ä¸¤ä¸ªç»“æžœå®¹å™¨åˆå¹¶æˆä¸€ä¸ª(combiner()) 4. åœ¨å®¹å™¨ä¸Šæ‰§è¡Œä¸€ä¸ªå¯é€‰çš„æœ€ç»ˆè½¬æ¢ (finisher()) æ”¶é›†å™¨å‚æ•°åˆ—è¡¨ toList() toSet() toCollection(Supplier&lt;C&gt;) counting() collectingAndThen(Collector&lt;T, A, R&gt;, Function&lt;R, RR&gt;) summingInt(ToIntFunction&lt;? super T&gt;) summingLong(ToLongFunction&lt;? super T&gt;) summingDouble(ToDoubleFunction&lt;? super T&gt;) maxBy(Comparator&lt;? super T&gt;) minBy(Comparator&lt;? super T&gt;) reducing(BinaryOperator&lt;T&gt;) reducing(T, BinaryOperator&lt;T&gt;) reducing(U, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;) joining() joining(CharSequence) joining(CharSequence, CharSequence, CharSequence) mapping(Function&lt;? super T, ? extends U&gt;, Collector&lt;? super U, A, R&gt;) toMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;) toMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;) toMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;, Supplier&lt;M&gt;) toConcurrentMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;) toConcurrentMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;) toConcurrentMap(Function&lt;? super T, ? extends K&gt;, Function&lt;? super T, ? extends U&gt;, BinaryOperator&lt;U&gt;, Supplier&lt;M&gt;) groupingBy(Function&lt;? super T, ? extends K&gt;) groupingBy(Function&lt;? super T, ? extends K&gt;, Supplier&lt;M&gt;, Collector&lt;? super T, A, D&gt;) groupingBy(Function&lt;? super T, ? extends K&gt;, Collector&lt;? super T, A, D&gt;) groupingByConcurrent(Function&lt;? super T, ? extends K&gt;) groupingByConcurrent(Function&lt;? super T, ? extends K&gt;, Supplier&lt;M&gt;, Collector&lt;? super T, A, D&gt;) groupingByConcurrent(Function&lt;? super T, ? extends K&gt;, Collector&lt;? super T, A, D&gt;) partitioningBy(Predicate&lt;? super T&gt;) partitioningBy(Predicate&lt;? super T&gt;, Collector&lt;? super T, A, D&gt;) averagingDouble(ToDoubleFunction&lt;? super T&gt;) averagingInt(ToIntFunction&lt;? super T&gt;) averagingLong(ToLongFunction&lt;? super T&gt;) summarizingDouble(ToDoubleFunction&lt;? super T&gt;) summarizingInt(ToIntFunction&lt;? super T&gt;) summarizingLong(ToLongFunction&lt;? super T&gt;) reduce()123Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator);T reduce(T identity, BinaryOperator&lt;T&gt; accumulator);&lt;U&gt; U reduce(U identity,BiFunction&lt;U, ? super T, U&gt; accumulator,BinaryOperator&lt;U&gt; combiner); æ–¹å¼ä¸€ï¼š ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼æ˜¯Streamçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯Streamçš„ç¬¬äºŒä¸ªå…ƒç´  12345Optional accResult = Stream.of(1, 2, 3, 4) .reduce((acc, item) -&gt; &#123; acc += item; return acc; &#125;) æ–¹å¼äºŒï¼šåœ¨æ–¹å¼ä¸€çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šåˆå§‹åŒ–çš„å€¼ 12345int accResult = Stream.of(1, 2, 3, 4) .reduce(0, (acc, item) -&gt; &#123; acc += item; return acc; &#125;); Intermediatefilter()Stream&lt;T&gt; filter(Predicate&lt;? super T&gt; predicate) ä½œç”¨æ˜¯è¿”å›žä¸€ä¸ªåªåŒ…å«æ»¡è¶³predicateæ¡ä»¶å…ƒç´ çš„Streamã€‚ 1234// ä¿ç•™é•¿åº¦ç­‰äºŽ3çš„å­—ç¬¦ä¸²Stream&lt;String&gt; stream= Stream.of("I", "love", "you", "too");stream.filter(str -&gt; str.length()==3) .forEach(str -&gt; System.out.println(str)); æ³¨æ„ â€‹ ç”±äºŽfilter()æ˜¯ä¸ªä¸­é—´æ“ä½œï¼Œå¦‚æžœåªè°ƒç”¨filter()ä¸ä¼šæœ‰å®žé™…è®¡ç®—ï¼Œå› æ­¤ä¹Ÿä¸ä¼šè¾“å‡ºä»»ä½•ä¿¡æ¯ã€‚ â€‹ filter ä¿ç•™æ¡ä»¶ä¸ºtrueçš„å…ƒç´ ã€‚ distinct()Stream&lt;T&gt; distinct() ä½œç”¨æ˜¯è¿”å›žä¸€ä¸ªåŽ»é™¤é‡å¤å…ƒç´ ä¹‹åŽçš„Streamã€‚ 123Stream&lt;String&gt; stream= Stream.of("I", "love", "you", "too", "too");stream.distinct() .forEach(str -&gt; System.out.println(str)); sorted()æŽ’åºå‡½æ•°æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ç”¨è‡ªç„¶é¡ºåºæŽ’åºï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨è‡ªå®šä¹‰æ¯”è¾ƒå™¨æŽ’åº åˆ†åˆ«ä¸ºStream&lt;T&gt; sorted()å’ŒStream&lt;T&gt; sorted(Comparator&lt;? super T&gt; comparator) 123Stream&lt;String&gt; stream= Stream.of("I", "love", "you", "too");stream.sorted((str1, str2) -&gt; str1.length()-str2.length()) .forEach(str -&gt; System.out.println(str)); ä¸Šè¿°ä»£ç å°†è¾“å‡ºæŒ‰ç…§é•¿åº¦å‡åºæŽ’åºåŽçš„å­—ç¬¦ä¸² map()&lt;R&gt; Stream&lt;R&gt; map(Function&lt;? super T,? extends R&gt; mapper)ï¼Œ ä½œç”¨æ˜¯è¿”å›žä¸€ä¸ªå¯¹å½“å‰æ‰€æœ‰å…ƒç´ æ‰§è¡Œmapperä¹‹åŽçš„ç»“æžœç»„æˆçš„Streamã€‚ 123Stream&lt;String&gt; stream = Stream.of("I", "love", "you", "too");stream.map(str -&gt; str.toUpperCase()) .forEach(str -&gt; System.out.println(str)); ä¸Šè¿°ä»£ç å°†è¾“å‡ºåŽŸå­—ç¬¦ä¸²çš„å¤§å†™å½¢å¼ã€‚ flatMap()&lt;R&gt; Stream&lt;R&gt; flatMap(Function&lt;? super T,? extends Stream&lt;? extends R&gt;&gt; mapper) ä½œç”¨æ˜¯å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡ŒmapperæŒ‡å®šçš„æ“ä½œï¼Œå¹¶ç”¨æ‰€æœ‰mapperè¿”å›žçš„streamä¸­çš„å…ƒç´ ç»„æˆä¸€ä¸ªæ–°çš„streamä½œä¸ºæœ€ç»ˆè¿”å›žç»“æžœã€‚ é€šä¿—çš„è®²flatMap()çš„ä½œç”¨å°±ç›¸å½“äºŽæŠŠåŽŸstreamä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½â€æ‘Šå¹³â€ä¹‹åŽç»„æˆçš„streamï¼Œè½¬æ¢å‰åŽå…ƒç´ çš„ä¸ªæ•°å’Œç±»åž‹éƒ½å¯èƒ½ä¼šæ”¹å˜ã€‚ 123Stream&lt;List&lt;Integer&gt;&gt; stream = Stream.of(Arrays.asList(1,2), Arrays.asList(3, 4, 5));stream.flatMap(list -&gt; list.stream()) .forEach(i -&gt; System.out.println(i)); ä¸Šè¿°ä»£ç ä¸­ï¼ŒåŽŸæ¥çš„streamä¸­æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«æ˜¯ä¸¤ä¸ªList&lt;Integer&gt;ï¼Œæ‰§è¡ŒflatMap()ä¹‹åŽï¼Œå°†æ¯ä¸ªListéƒ½â€œæ‘Šå¹³â€æˆäº†ä¸€ä¸ªä¸ªçš„æ•°å­—ï¼Œæ‰€ä»¥ä¼šæ–°äº§ç”Ÿä¸€ä¸ªç”±5ä¸ªæ•°å­—ç»„æˆçš„Streamã€‚æ‰€ä»¥æœ€ç»ˆå°†è¾“å‡º1~5è¿™5ä¸ªæ•°å­—ã€‚ å›¾ç¤º skip()è·³è¿‡å‰é¢ n ä¸ªå¯¹è±¡ 123456List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");List&lt;String&gt; list2 = list.stream().skip(3).collect(toList());System.out.println(list2); //[DDD, EEE]Optional&lt;String&gt; first = list.stream().skip(2).findFirst();System.out.println(first.get());//CCCC limit()èŽ·å–é™å®šä¸ªæ•°çš„å¯¹è±¡ 123456List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");List&lt;String&gt; list2 = list.stream().limit(2).collect(toList());System.out.println(list2); //[A, BBB]Optional&lt;String&gt; first = list.stream().limit(2).findFirst();System.out.println(first.get());//A concat()é™æ€æ–¹æ³•ï¼ŒæŠŠä¸¤ä¸ªStreamæ‹¼åœ¨ä¸€èµ· 123456List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");List&lt;String&gt; list2 = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");List&lt;String&gt; collect = Stream.concat(list.stream(), list2.stream()) .collect(Collectors.toList());System.out.println(collect); //[A, BBB, CCCC, DDD, EEE, A, BBB, CCCC, DDD, EEE] peek()å¯ä»¥åšä¸€äº›å³æ—¶çš„æ“ä½œï¼ŒåŠŸèƒ½å’ŒforEachç›¸åŒ 12345678List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE"); //ABBBCCCCDDDEEEList&lt;String&gt; collect = list.stream() .peek(System.out::print) .filter(s -&gt; s.length() == 3) .collect(Collectors.toList());System.out.println();System.out.println(collect);//[BBB, DDD, EEE] å’Œforeachçš„ä¸åŒç‚¹ï¼š â€‹ peek: ç”Ÿæˆä¸€ä¸ªåŒ…å«åŽŸstreamçš„æ‰€æœ‰å…ƒç´ çš„æ–°streamï¼ŒåŒæ—¶ä¼šæä¾›ä¸€ä¸ªæ¶ˆè´¹å‡½æ•°ï¼ˆConsumerå®žä¾‹ï¼‰ï¼Œ â€‹ æ–°streamæ¯ä¸ªå…ƒç´ è¢«æ¶ˆè´¹çš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œç»™å®šçš„æ¶ˆè´¹å‡½æ•°ï¼› â€‹ é€šä¿—çš„è®²ï¼špeekæ˜¯ä¸ªä¸­é—´æ“ä½œï¼Œå®ƒæä¾›äº†ä¸€ç§å¯¹æµä¸­æ‰€æœ‰å…ƒç´ æ“ä½œçš„æ–¹æ³•ï¼Œè€Œä¸ä¼šæŠŠè¿™ä¸ªæµæ¶ˆè´¹æŽ‰ â€‹ ï¼ˆforeachä¼šæŠŠæµæ¶ˆè´¹æŽ‰ï¼‰ parallel()å°†streamå˜æˆ å¹¶è¡Œstream 12345List&lt;String&gt; list = Lists.newArrayList("A", "BBB", "CCCC", "DDD", "EEE");boolean isParallel = list.stream().parallel().isParallel();System.out.println(isParallel);//trueboolean parallel = list.parallelStream().isParallel();System.out.println(parallel); //true sequential()unordered()]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>lambda</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Time ç›¸å…³çš„ç±»]]></title>
    <url>%2F2020%2F11%2F05%2FTime%20Class%2F</url>
    <content type="text"><![CDATA[Timeç›¸å…³ç±»â€‹ java.timeåŒ…ä¸­çš„æ˜¯ç±»æ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ã€‚æ–°çš„æ—¶é—´åŠæ—¥æœŸAPIä½äºŽjava.timeä¸­ Instantâ€”â€”å®ƒä»£è¡¨çš„æ˜¯æ—¶é—´æˆ³ LocalDateâ€”â€”ä¸åŒ…å«å…·ä½“æ—¶é—´çš„æ—¥æœŸï¼Œæ¯”å¦‚2014-01-14ã€‚å®ƒå¯ä»¥ç”¨æ¥å­˜å‚¨ç”Ÿæ—¥ï¼Œå‘¨å¹´çºªå¿µæ—¥ï¼Œå…¥èŒæ—¥æœŸç­‰ã€‚ LocalTimeâ€”â€”å®ƒä»£è¡¨çš„æ˜¯ä¸å«æ—¥æœŸçš„æ—¶é—´ LocalDateTimeâ€”â€”å®ƒåŒ…å«äº†æ—¥æœŸåŠæ—¶é—´ï¼Œä¸è¿‡è¿˜æ˜¯æ²¡æœ‰åç§»ä¿¡æ¯æˆ–è€…è¯´æ—¶åŒºã€‚ ZonedDateTimeâ€”â€”è¿™æ˜¯ä¸€ä¸ªåŒ…å«æ—¶åŒºçš„å®Œæ•´çš„æ—¥æœŸæ—¶é—´ï¼Œåç§»é‡æ˜¯ä»¥UTC/æ ¼æž—å¨æ²»æ—¶é—´ä¸ºåŸºå‡†çš„ã€‚ JDK8æ˜¯å¦‚ä½•å¤„ç†æ—¶é—´åŠæ—¥æœŸçš„1. å¤„ç†æ—¥æœŸâ€‹ LocalDateç±»ï¼Œèƒ½ç”¨æ¥è¡¨ç¤ºä»Šå¤©çš„æ—¥æœŸã€‚è¿™ä¸ªç±»ä¸Žjava.util.Dateç•¥æœ‰ä¸åŒï¼Œå› ä¸ºå®ƒåªåŒ…å«æ—¥æœŸï¼Œæ²¡æœ‰æ—¶é—´ã€‚ â€‹ MonthDayç±»ï¼Œè¿™ä¸ªç±»ç”±æœˆæ—¥ç»„åˆï¼Œä¸åŒ…å«å¹´ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥ä»£è¡¨æ¯å¹´é‡å¤å‡ºçŽ°çš„ä¸€äº›æ—¥æœŸæˆ–å…¶ä»–ç»„åˆã€‚æ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”å®ƒè¿˜æ˜¯ä¸€ä¸ªå€¼ç±»ï¼ˆvalue classï¼‰ã€‚ â€‹ YearMonthç±»ï¼Œè¿™ä¸ªç±»æœ‰å¹´æœˆç»„åˆï¼Œä¸åŒ…å«æ—¥ä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥æŸ¥æ‰¾è¿™ä¸ªæœˆåœ¨æŸä¸€å¹´é‡Œæœ‰å¤šå°‘å¤©ã€‚ â€‹ Periodç±»ï¼Œè®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ã€å‘¨ã€æœˆã€å¹´ã€‚ 1.1 èŽ·å–å½“å¤©çš„æ—¥æœŸ123LocalDate today = LocalDate.now();System.out.println("ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š" + today);// ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15 â€‹ åˆ›å»ºçš„æ—¥æœŸä¸åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œå¹¶ä¸”æ ¼å¼åŒ–äº†æ—¥æœŸã€‚ 1.2 èŽ·å–å½“å‰çš„å¹´æœˆæ—¥12345678910LocalDate today = LocalDate.now();int year = today.getYear();int month = today.getMonthValue();int day = today.getDayOfMonth();System.out.println("å¹´ï¼š" + year + "\næœˆï¼š" + month + "\næ—¥ï¼š" + day);/** * å¹´ï¼š2019 * æœˆï¼š1 * æ—¥ï¼š15 */ 1.3 èŽ·å–æŸä¸ªç‰¹å®šçš„æ—¥æœŸâ€‹ é€šè¿‡ of æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºå‡ºä»»æ„ä¸€ä¸ªæ—¥æœŸï¼Œå®ƒæŽ¥å—å¹´æœˆæ—¥çš„å‚æ•°ï¼Œç„¶åŽè¿”å›žä¸€ä¸ªç­‰ä»·çš„LocalDateå®žä¾‹ã€‚ â€‹ åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œéœ€è¦çš„æ—¥æœŸä½ å¡«å†™ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆï¼Œä¸åƒä¹‹å‰çš„APIä¸­æœˆä»½å¿…é¡»ä»Ž0å¼€å§‹ã€‚ 123LocalDate today = LocalDate.of(2018,12,15);System.out.println("ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ï¼š" + today);// ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ï¼š2018-12-15 1.4 æ£€æŸ¥ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦ç›¸ç­‰â€‹ LocalDateé‡å†™äº†equalsæ–¹æ³•æ¥è¿›è¡Œæ—¥æœŸçš„æ¯”è¾ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234LocalDate today = LocalDate.of(2019,1,15);LocalDate now = LocalDate.now();System.out.println("ä»Šå¤©çš„æ—¥æœŸæ˜¯2019-1-15å—ï¼š" + today.equals(now));// ä»Šå¤©çš„æ—¥æœŸæ˜¯2019-1-15å—ï¼štrue 1.5 å¦‚ä½•æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚ç”Ÿæ—¥åœ¨javaä¸­è¿˜æœ‰ä¸€ä¸ªä¸Žæ—¶é—´æ—¥æœŸç›¸å…³çš„ä»»åŠ¡å°±æ˜¯æ£€æŸ¥é‡å¤äº‹ä»¶ï¼Œæ¯”å¦‚æ¯æœˆçš„è´¦å•æ—¥ ä½¿ç”¨MonthDayç±»åˆ¤æ–­æ˜¯å¦æ˜¯æŸä¸ªèŠ‚æ—¥æˆ–è€…é‡å¤äº‹ä»¶ã€‚ 12345678910LocalDate dateOfBirth = LocalDate.of(1997,4,13);LocalDate now = LocalDate.now();MonthDay birthDay = MonthDay.of(dateOfBirth.getMonth(), dateOfBirth.getDayOfMonth());MonthDay currentMonthDay = MonthDay.from(now);if (currentMonthDay.equals(birthDay))&#123; System.out.println("ä»Šå¤©æ˜¯ä½ çš„ç”Ÿæ—¥");&#125;else&#123; System.out.println("å¯¹ä¸èµ·ï¼Œä»Šå¤©ä¸æ˜¯ä½ çš„ç”Ÿæ—¥");&#125;//å¯¹ä¸èµ·ï¼Œä»Šå¤©ä¸æ˜¯ä½ çš„ç”Ÿæ—¥ â€‹ MonthDayåªå­˜å‚¨äº†æœˆæ—¥ï¼Œå¯¹æ¯”ä¸¤ä¸ªæ—¥æœŸçš„æœˆæ—¥å³å¯çŸ¥é“æ˜¯å¦é‡å¤ 1.6 èŽ·å–1å‘¨åŽçš„æ—¥æœŸâ€‹ è¿™ä¸ªä¸Žä½¿ç”¨LocalTimeèŽ·å–2å°æ—¶åŽçš„æ—¶é—´çš„ä¾‹å­å¾ˆç›¸ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬èŽ·å–çš„æ˜¯1å‘¨åŽçš„æ—¥æœŸã€‚ â€‹ LocalDateæ˜¯ç”¨æ¥è¡¨ç¤ºæ— æ—¶é—´çš„æ—¥æœŸï¼Œä»–æœ‰ä¸€ä¸ªplus()æ–¹æ³•å¯ä»¥ç”¨æ¥å¢žåŠ æ—¥ï¼Œæ˜ŸæœŸï¼Œæœˆã€‚ â€‹ ChronoUnitåˆ™ç”¨æ¥è¡¨ç¤ºæ—¶é—´å•ä½ï¼ŒLocalDateä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤ä»»ä½•ä¿®æ”¹æ“ä½œéƒ½ä¼šè¿”å›žä¸€ä¸ªæ–°çš„å®žä¾‹ã€‚ 123456LocalDate today = LocalDate.now();System.out.println("ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š" + today);LocalDate oneToDay = today.plus(1, ChronoUnit.WEEKS);System.out.println("ä¸€å‘¨åŽçš„æ—¥æœŸæ˜¯ï¼š" + oneToDay);//ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15//ä¸€å‘¨åŽçš„æ—¥æœŸæ˜¯ï¼š2019-01-22 ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥å¢žåŠ ä¸€ä¸ªæœˆï¼Œä¸€å¹´ï¼Œä¸€å°æ—¶ï¼Œä¸€åˆ†ç­‰ç­‰ 1.7 ä¸€å¹´å‰çš„æ—¥æœŸâ€‹ ä½¿ç”¨LocalDateçš„plus()æ–¹æ³•æ¥ç»™æ—¥æœŸå¢žåŠ æ—¥å‘¨æœˆï¼Œ â€‹ çŽ°åœ¨æˆ‘ä»¬ç”¨minus()æ–¹æ³•æ¥ç»™æ—¥æœŸå‡å°‘æ—¥å‘¨æœˆï¼Œå¾€å‰æ‰¾ã€‚ 123456LocalDate today = LocalDate.now();System.out.println("ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š" + today);LocalDate previousYear = today.minus(1, ChronoUnit.YEARS);System.out.println("ä¸€å¹´å‰çš„æ—¥æœŸæ˜¯ï¼š" + previousYear);//ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15//ä¸€å¹´å‰çš„æ—¥æœŸæ˜¯ï¼š2018-01-15 1.8 å¦‚ä½•åˆ¤æ–­æŸä¸ªæ—¥æœŸåœ¨å¦ä¸€ä¸ªæ—¥æœŸçš„å‰é¢è¿˜æ˜¯åŽé¢â€‹ LocalDateç±»ä¸­ä½¿ç”¨isBefore()ã€isAfter()ã€equals()æ–¹æ³•æ¥æ¯”è¾ƒä¸¤ä¸ªæ—¥æœŸã€‚ â€‹ å¦‚æžœè°ƒç”¨æ–¹æ³•çš„é‚£ä¸ªæ—¥æœŸæ¯”ç»™å®šçš„æ—¥æœŸè¦æ—©çš„è¯ï¼ŒisBefore()æ–¹æ³•ä¼šè¿”å›žtrueã€‚ â€‹ å¦‚æžœè°ƒç”¨æ–¹æ³•çš„é‚£ä¸ªæ—¥æœŸæ¯”ç»™å®šçš„æ—¥æœŸè¦æ™šçš„è¯ï¼ŒisAfter()æ–¹æ³•ä¼šè¿”å›žtrueã€‚ 12345678910LocalDate today = LocalDate.now();System.out.println("ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š" + today);LocalDate tomorrow = today.plus(1, ChronoUnit.DAYS);System.out.println("æ˜Žå¤©çš„æ—¥æœŸæ˜¯ï¼š" + tomorrow);System.out.println("æ—¥æœŸï¼š" + tomorrow + "æ˜¯å¦åœ¨æ—¥æœŸï¼š" + today + "ä¹‹åŽï¼š" + tomorrow.isAfter(today));System.out.println("æ—¥æœŸï¼š" + tomorrow + "æ˜¯å¦åœ¨æ—¥æœŸï¼š" + today + "ä¹‹å‰ï¼š" + tomorrow.isBefore(today));//ä»Šå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-15//æ˜Žå¤©çš„æ—¥æœŸæ˜¯ï¼š2019-01-16//æ—¥æœŸï¼š2019-01-16æ˜¯å¦åœ¨æ—¥æœŸï¼š2019-01-15ä¹‹åŽï¼štrue//æ—¥æœŸï¼š2019-01-16æ˜¯å¦åœ¨æ—¥æœŸï¼š2019-01-15ä¹‹å‰ï¼šfalse java8ä¸­æ¯”è¾ƒæ—¥æœŸéžå¸¸ç®€å•ï¼Œä¸å†éœ€è¦ä½¿ç”¨Calendarè¿™æ ·å¦å¤–çš„ç±»æ¥å®Œæˆç±»ä¼¼çš„ä»»åŠ¡äº† 1.9 å¦‚ä½•è¡¨ç¤ºå›ºå®šçš„æ—¥æœŸï¼Œæ¯”å¦‚ä¿¡ç”¨å¡è¿‡æœŸæ—¶é—´æ­£å¦‚MonthDayè¡¨ç¤ºçš„æ˜¯æŸä¸ªé‡å¤å‡ºçŽ°çš„æ—¥å­ï¼ŒYearMonthæ˜¯å¦å¤–ä¸€ä¸ªç»„åˆï¼Œä»£è¡¨çš„æ˜¯åƒä¿¡ç”¨å¡è¿˜æ¬¾æ—¥ï¼Œå®šæœŸå­˜æ¬¾åˆ°æœŸæ—¥ï¼Œoptionsåˆ°æœŸæ—¥è¿™ç±»çš„æ—¥æœŸã€‚ä½ å¯ä»¥ç”¨è¿™ä¸ªç±»æ‰¾å‡ºè¿™ä¸ªæœˆæœ‰å¤šå°‘å¤©ï¼ŒLengthOfMonth()è¿™ä¸ªæ–¹æ³•è¿”å›žçš„æ˜¯è¿™ä¸ªYearMonthå®žä¾‹æœ‰å¤šå°‘å¤©ï¼Œè¿™å¯¹äºŽæ£€æŸ¥2æœˆæ˜¯å¦æ¶¦2æœˆå¾ˆæœ‰ç”¨ã€‚ 123456YearMonth currentYearMonth = YearMonth.now();System.out.printf("ä»Šå¹´è¿™ä¸ªæœˆ %s: æœ‰ %d å¤©%n", currentYearMonth, currentYearMonth.lengthOfMonth());YearMonth creditCardExpiry = YearMonth.of(2018, Month.FEBRUARY);System.out.printf("ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ %s %n", creditCardExpiry);//ä»Šå¹´è¿™ä¸ªæœˆ 2019-01: æœ‰ 31 å¤©//ä½ è¾“å…¥çš„æ—¥æœŸæ˜¯ 2018-02 1.10 å¦‚ä½•åœ¨java8ä¸­æ£€æŸ¥é—°å¹´â€‹ LocalDateç±»ç”±ä¸€ä¸ªisLeapYear()æ–¹æ³•æ¥è¿”å›žå½“å‰LocalDateå¯¹åº”çš„é‚£å¹´æ˜¯å¦æ˜¯é—°å¹´ 123LocalDate now = LocalDate.now();System.out.println("ä»Šå¤©æ˜¯ä¸æ˜¯é—°å¹´ï¼š" + now.isLeapYear());//ä»Šå¤©æ˜¯ä¸æ˜¯é—°å¹´ï¼šfalse 1.11 ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ï¼Œå¤šå°‘æœˆè®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´åŒ…å«å¤šå°‘å¤©ã€å‘¨ã€æœˆã€å¹´ã€‚ å¯ä»¥ç”¨java.time.Periodç±»å®Œæˆè¯¥åŠŸèƒ½ã€‚ ä¸‹é¢ä¾‹å­ä¸­å°†è®¡ç®—æ—¥æœŸä¸Žå°†æ¥çš„æ—¥æœŸä¹‹é—´ä¸€å…±æœ‰å‡ ä¸ªæœˆ 12345LocalDate today = LocalDate.now();LocalDate date = LocalDate.of(2018, Month.MARCH, 14);Period periodToNextJavaRelease = Period.between(today, date);System.out.printf("æ—¥æœŸ%så’Œæ—¥æœŸ%sç›¸å·®%sæœˆ ", today, date, periodToNextJavaRelease.getMonths());//æ—¥æœŸ2019-01-15å’Œæ—¥æœŸ2018-03-14ç›¸å·®-10æœˆ 2. å¤„ç†æ—¶é—´â€‹ LocalTimeç±»ï¼Œé»˜è®¤çš„æ ¼å¼æ˜¯hh:mm:ss:nnnï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ä¸åŒ…å«æ—¥æœŸçš„ 2.1 èŽ·å–å½“å‰æ—¶é—´123LocalTime localTime = LocalTime.now();System.out.println(localTime);// 15:18:30.974 2.2 å¢žåŠ æ—¶é—´é‡Œé¢çš„å°æ—¶æ•°â€‹ å¾ˆå¤šæ—¶å€™éœ€è¦å¯¹æ—¶é—´è¿›è¡Œæ“ä½œï¼Œæ¯”å¦‚åŠ ä¸€ä¸ªå°æ—¶æ¥è®¡ç®—ä¹‹åŽçš„æ—¶é—´ï¼Œjava8æä¾›äº†æ›´æ–¹ä¾¿çš„æ–¹æ³• å¦‚plusHoursï¼Œè¿™äº›æ–¹æ³•è¿”å›žçš„æ˜¯ä¸€ä¸ªæ–°çš„LocalTimeå®žä¾‹çš„å¼•ç”¨ï¼Œå› ä¸ºLocalTimeæ˜¯ä¸å¯å˜çš„ã€‚ 12345678LocalTime localTime = LocalTime.now();System.out.println("çŽ°åœ¨çš„æ—¶é—´æ˜¯ï¼š" + localTime);LocalTime two = localTime.plusHours(2);System.out.println("ä¸¤ä¸ªå°æ—¶åŽçš„æ—¶é—´æ˜¯ï¼š" + two);System.out.println("è¿™æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼š" + localTime.equals(two));//çŽ°åœ¨çš„æ—¶é—´æ˜¯ï¼š15:21:42.518//ä¸¤ä¸ªå°æ—¶åŽçš„æ—¶é—´æ˜¯ï¼š17:21:42.518//è¿™æ˜¯ç›¸åŒçš„å¯¹è±¡ï¼šfalse 3. å¤„ç†æ—¶åŒºâ€‹ java8ä¸­ä¸ä»…å°†æ—¥æœŸå’Œæ—¶é—´è¿›è¡Œäº†åˆ†ç¦»ï¼ŒåŒæ—¶è¿˜æœ‰æ—¶åŒºã€‚æ¯”å¦‚ZonIdä»£è¡¨çš„æ˜¯æŸä¸ªç‰¹å®šæ—¶åŒºï¼ŒZonedDateTimeä»£è¡¨å¸¦æ—¶åŒºçš„æ—¶é—´ï¼Œç­‰åŒäºŽä»¥å‰çš„GregorianCalendarç±»ã€‚ä½¿ç”¨è¯¥ç±»ï¼Œå¯ä»¥å°†æœ¬åœ°æ—¶é—´è½¬æ¢æˆå¦ä¸€ä¸ªæ—¶åŒºä¸­çš„å¯¹åº”æ—¶é—´ã€‚ 12345LocalDateTime localDateTime = LocalDateTime.now();ZoneId darWin = ZoneId.of(ZoneId.SHORT_IDS.get("ACT"));ZonedDateTime dateTimeInDarwin = ZonedDateTime.of(localDateTime, darWin);System.out.println("çŽ°åœ¨æ—¶åŒºçš„æ—¶é—´å’Œç‰¹å®šæ—¶åŒºçš„æ—¶é—´ï¼š" + dateTimeInDarwin);//çŽ°åœ¨æ—¶åŒºçš„æ—¶é—´å’Œç‰¹å®šæ—¶åŒºçš„æ—¶é—´ï¼š2019-01-15T15:58:31.859+09:30[Australia/Darwin] 4. èŽ·å–æ—¶é—´æˆ³Instantç±»ç”±ä¸€ä¸ªé™æ€çš„å·¥åŽ‚æ–¹æ³•now()å¯ä»¥è¿”å›žå½“å‰æ—¶é—´æˆ³ 123Instant timestamp = Instant.now();System.out.println("å½“å‰çš„æ—¶é—´æˆ³æ˜¯ï¼š" + timestamp);//å½“å‰çš„æ—¶é—´æˆ³æ˜¯ï¼š2019-01-15T08:27:59.561Z å½“å‰æ—¶é—´æˆ³æ˜¯åŒ…å«æ—¥æœŸå’Œæ—¶é—´çš„ï¼Œä¸Žjava.util.Dateå¾ˆç±»ä¼¼ï¼Œäº‹å®žä¸ŠInstantå°±æ˜¯java8ä»¥å‰çš„Dateï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªä¸¤ä¸ªç±»ä¸­çš„æ–¹æ³•åœ¨è¿™ä¸¤ä¸ªç±»åž‹ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œæ¯”å¦‚Date.from(Instant)å°±æ˜¯ç”¨æ¥æŠŠInstantè½¬æ¢æˆjava.util.dateçš„ï¼Œè€ŒDateã€‚toInstant()å°±æ˜¯å°†Dateè½¬æ¢æˆInstantçš„ 5.å…¨æ–°çš„æ—¥æœŸæ—¶é—´æ ¼å¼å™¨DateTimeFormatterâ€‹ åœ¨java8ä¹‹å‰ï¼Œæ—¶é—´æ—¥æœŸçš„æ ¼å¼åŒ–éžå¸¸éº»çƒ¦ï¼Œç»å¸¸ä½¿ç”¨SimpleDateFormatæ¥è¿›è¡Œæ ¼å¼åŒ–ï¼Œä½†æ˜¯SimpleDateFormatå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ â€‹ åœ¨java8ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªå…¨æ–°çš„çº¿ç¨‹å®‰å…¨çš„æ—¥æœŸä¸Žæ—¶é—´æ ¼å¼å™¨==DateTimeFormatter==ã€‚å¹¶ä¸”é¢„å®šä¹‰å¥½äº†æ ¼å¼ã€‚ 5.1 é¢„ç½®çš„æ ¼å¼å™¨æ¥æ ¼å¼åŒ–æ—¥æœŸâ€‹ æœ¬ä¾‹ä¸­ä½¿ç”¨çš„BASICISODATEæ ¼å¼ä¼šå°†20160414æ ¼å¼åŒ–æˆ2016-04-14 1234String dayAfterTomorrow = "20180116";LocalDate formatted = LocalDate.parse(dayAfterTomorrow, DateTimeFormatter.BASIC_ISO_DATE);System.out.printf("å­—ç¬¦ %s æ ¼å¼åŒ–åŽçš„æ—¥æœŸæ ¼å¼æ˜¯ %s %n",dayAfterTomorrow,formatted);//å­—ç¬¦ 20180116 æ ¼å¼åŒ–åŽçš„æ—¥æœŸæ ¼å¼æ˜¯ 2018-01-16 5.2 è‡ªå®šä¹‰æ ¼å¼å™¨æ¥è§£æžæ—¥æœŸâ€‹ æˆ‘ä»¬ä½¿ç”¨äº†é¢„ç½®çš„æ—¶é—´æ—¥æœŸæ ¼å¼å™¨æ¥è§£æžæ—¥æœŸå­—ç¬¦ä¸²äº†ï¼Œä½†æ˜¯æœ‰æ—¶é¢„ç½®çš„ä¸èƒ½æ»¡è¶³çš„æ—¶å€™å°±éœ€è¦æˆ‘ä»¬è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼å™¨äº†ï¼Œä¸‹é¢çš„ä¾‹å­ä¸­çš„æ—¥æœŸæ ¼å¼æ˜¯â€MM dd yyyyâ€.ä½ å¯ä»¥ç»™DateTimeFormatterçš„ofPatterné™æ€æ–¹æ³•()ä¼ å…¥ä»»ä½•çš„æ¨¡å¼ï¼Œå®ƒä¼šè¿”å›žä¸€ä¸ªå®žä¾‹ï¼Œè¿™ä¸ªæ¨¡å¼çš„å­—é¢é‡ä¸Žå‰ä¾‹ä¸­æ˜¯ç›¸åŒçš„ã€‚æ¯”å¦‚Mä»£è¡¨æœˆï¼Œmä»ä»£è¡¨åˆ†ï¼Œæ— æ•ˆçš„æ¨¡å¼ä¼šæŠ›å¼‚å¸¸DateTimeParseExceptionã€‚ 12345String day = "01 15 2019";DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MM dd yyyy");LocalDate holiday = LocalDate.parse(day, formatter);System.out.printf("å­—ç¬¦ %s è½¬æ¢æˆåŠŸåŽçš„æ—¥æœŸæ˜¯ %s%n", day, holiday);//å­—ç¬¦ 01 15 2019 è½¬æ¢æˆåŠŸåŽçš„æ—¥æœŸæ˜¯ 2019-01-15 20ã€å¯¹æ—¥æœŸè¿›è¡Œæ ¼å¼åŒ–ï¼Œè½¬æ¢æˆå­—ç¬¦ä¸² â€‹ æˆ‘ä»¬ä¸»è¦æ˜¯å¯¹æ—¥æœŸå­—ç¬¦ä¸²æ¥è¿›è¡Œè§£æžè½¬æ¢æˆæ—¥æœŸï¼Œåœ¨è¿™ä¸ªä¾‹å­æˆ‘ä»¬ç›¸åï¼Œæ˜¯æŠŠæ—¥æœŸè½¬æ¢æˆå­—ç¬¦ã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸ªLocalDateTimeç±»çš„å®žä¾‹ï¼Œæˆ‘ä»¬è¦æŠŠä»–è½¬æ¢æˆä¸€ä¸ªæ ¼å¼åŒ–å¥½çš„æ—¥æœŸä¸²ï¼Œä¸Žå‰ä¾‹ç›¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä»éœ€è¦åˆ¶å®šæ¨¡å¼ä¸²åŽ»åˆ›å»ºä¸€ä¸ªDateTimeFormatterç±»çš„å®žä¾‹ï¼Œä½†è°ƒç”¨çš„æ˜¯LocalDate.format()ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›žä¸€ä¸ªä»£è¡¨å½“å‰æ—¥æœŸçš„å­—ç¬¦ä¸²ï¼Œå¯¹åº”çš„æ¨¡å¼å°±æ˜¯ä¼ å…¥çš„DateTimeFormatterå®žä¾‹ä¸­å®šä¹‰å¥½çš„ã€‚ 12345LocalDateTime arrivalDate = LocalDateTime.now();DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern("MM dd yyyy HH:mm a");String format = arrivalDate.format(dateTimeFormatter);System.out.println("è½¬æ¢åŽçš„æ—¥æœŸ:" + format);//è½¬æ¢åŽçš„æ—¥æœŸ:01 15 2019 17:30 PM java8ä¸­æ—¥æœŸä¸Žæ—¶é—´APIçš„å‡ ä¸ªå…³é”®ç‚¹å›žé¡¾ä¸€ä¸‹ â—å®ƒæä¾›äº†javax.time.ZoneIdç”¨æ¥å¤„ç†æ—¶åŒºã€‚ â—å®ƒæä¾›äº†LocalDateä¸ŽLocalTimeç±» â—Java 8ä¸­æ–°çš„æ—¶é—´ä¸Žæ—¥æœŸAPIä¸­çš„æ‰€æœ‰ç±»éƒ½æ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™ä¸Žä¹‹å‰çš„Dateä¸ŽCalendar APIä¸­çš„æ°å¥½ç›¸åï¼Œé‚£é‡Œé¢åƒjava.util.Dateä»¥åŠSimpleDateFormatè¿™äº›å…³é”®çš„ç±»éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ â—æ–°çš„æ—¶é—´ä¸Žæ—¥æœŸAPIä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯å®ƒå®šä¹‰æ¸…æ¥šäº†åŸºæœ¬çš„æ—¶é—´ä¸Žæ—¥æœŸçš„æ¦‚å¿µï¼Œæ¯”æ–¹è¯´ï¼Œçž¬æ—¶æ—¶é—´ï¼ŒæŒç»­æ—¶é—´ï¼Œæ—¥æœŸï¼Œæ—¶é—´ï¼Œæ—¶åŒºä»¥åŠæ—¶é—´æ®µã€‚å®ƒä»¬éƒ½æ˜¯åŸºäºŽISOæ—¥åŽ†ä½“ç³»çš„ã€‚ æ¯ä¸ªJavaå¼€å‘äººå‘˜éƒ½åº”è¯¥è‡³å°‘äº†è§£è¿™å¥—æ–°çš„APIä¸­çš„è¿™äº”ä¸ªç±»ï¼š â—Instant å®ƒä»£è¡¨çš„æ˜¯æ—¶é—´æˆ³ï¼Œæ¯”å¦‚2016-04-14T14:20:13.592Zï¼Œè¿™å¯ä»¥ä»Žjava.time.Clockç±»ä¸­èŽ·å–ï¼Œåƒè¿™æ ·ï¼š Instant current = Clock.system(ZoneId.of(â€œAsia/Tokyoâ€)).instant(); â—LocalDate å®ƒè¡¨ç¤ºçš„æ˜¯ä¸å¸¦æ—¶é—´çš„æ—¥æœŸï¼Œæ¯”å¦‚2016-04-14ã€‚å®ƒå¯ä»¥ç”¨æ¥å­˜å‚¨ç”Ÿæ—¥ï¼Œå‘¨å¹´çºªå¿µæ—¥ï¼Œå…¥èŒæ—¥æœŸç­‰ã€‚ â—LocalTime - å®ƒè¡¨ç¤ºçš„æ˜¯ä¸å¸¦æ—¥æœŸçš„æ—¶é—´ â—LocalDateTime - å®ƒåŒ…å«äº†æ—¶é—´ä¸Žæ—¥æœŸï¼Œä¸è¿‡æ²¡æœ‰å¸¦æ—¶åŒºçš„åç§»é‡ â—ZonedDateTime - è¿™æ˜¯ä¸€ä¸ªå¸¦æ—¶åŒºçš„å®Œæ•´æ—¶é—´ï¼Œå®ƒæ ¹æ®UTC/æ ¼æž—å¨æ²»æ—¶é—´æ¥è¿›è¡Œæ—¶åŒºè°ƒæ•´ â—è¿™ä¸ªåº“çš„ä¸»åŒ…æ˜¯java.timeï¼Œé‡Œé¢åŒ…å«äº†ä»£è¡¨æ—¥æœŸï¼Œæ—¶é—´ï¼Œçž¬æ—¶ä»¥åŠæŒç»­æ—¶é—´çš„ç±»ã€‚å®ƒæœ‰ä¸¤ä¸ªå­packageï¼Œä¸€ä¸ªæ˜¯java.time.foramtï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆç”¨é€”å°±å¾ˆæ˜Žæ˜¾äº†ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯java.time.temporalï¼Œå®ƒèƒ½ä»Žæ›´ä½Žå±‚é¢å¯¹å„ä¸ªå­—æ®µè¿›è¡Œè®¿é—®ã€‚ â—æ—¶åŒºæŒ‡çš„æ˜¯åœ°çƒä¸Šå…±äº«åŒä¸€æ ‡å‡†æ—¶é—´çš„åœ°åŒºã€‚æ¯ä¸ªæ—¶åŒºéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ç¬¦ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªåœ°åŒº/åŸŽå¸‚(Asia/Tokyo)çš„æ ¼å¼ä»¥åŠä»Žæ ¼æž—å¨æ²»æ—¶é—´å¼€å§‹çš„ä¸€ä¸ªåç§»æ—¶é—´ã€‚æ¯”å¦‚è¯´ï¼Œä¸œäº¬çš„åç§»æ—¶é—´å°±æ˜¯+09:00ã€‚ â—OffsetDateTimeç±»å®žé™…ä¸ŠåŒ…å«äº†LocalDateTimeä¸ŽZoneOffsetã€‚å®ƒç”¨æ¥è¡¨ç¤ºä¸€ä¸ªåŒ…å«æ ¼æž—å¨æ²»æ—¶é—´åç§»é‡ï¼ˆ+/-å°æ—¶ï¼šåˆ†ï¼Œæ¯”å¦‚+06:00æˆ–è€… -08ï¼š00ï¼‰çš„å®Œæ•´çš„æ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰åŠæ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼Œçº³ç§’ï¼‰ã€‚ â—DateTimeFormatterç±»ç”¨äºŽåœ¨Javaä¸­è¿›è¡Œæ—¥æœŸçš„æ ¼å¼åŒ–ä¸Žè§£æžã€‚ä¸ŽSimpleDateFormatä¸åŒï¼Œå®ƒæ˜¯ä¸å¯å˜ä¸”çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æžœéœ€è¦çš„è¯ï¼Œå¯ä»¥èµ‹å€¼ç»™ä¸€ä¸ªé™æ€å˜é‡ã€‚DateTimeFormatterç±»æä¾›äº†è®¸å¤šé¢„å®šä¹‰çš„æ ¼å¼å™¨ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±æƒ³è¦çš„æ ¼å¼ã€‚å½“ç„¶äº†ï¼Œæ ¹æ®çº¦å®šï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªparse()æ–¹æ³•æ˜¯ç”¨äºŽå°†å­—ç¬¦ä¸²è½¬æ¢æˆæ—¥æœŸçš„ï¼Œå¦‚æžœè½¬æ¢æœŸé—´å‡ºçŽ°ä»»ä½•é”™è¯¯ï¼Œå®ƒä¼šæŠ›å‡ºDateTimeParseExceptionå¼‚å¸¸ã€‚ç±»ä¼¼çš„ï¼ŒDateFormatterç±»ä¹Ÿæœ‰ä¸€ä¸ªç”¨äºŽæ ¼å¼åŒ–æ—¥æœŸçš„format()æ–¹æ³•ï¼Œå®ƒå‡ºé”™çš„è¯åˆ™ä¼šæŠ›å‡ºDateTimeExceptionå¼‚å¸¸ã€‚ â—å†è¯´ä¸€å¥ï¼Œâ€œMMM d yyyyâ€ä¸Žâ€œMMm dd yyyyâ€è¿™ä¸¤ä¸ªæ—¥æœŸæ ¼å¼ä¹Ÿç•¥æœ‰ä¸åŒï¼Œå‰è€…èƒ½è¯†åˆ«å‡ºâ€Jan 2 2014â€ä¸Žâ€Jan 14 2014â€è¿™ä¸¤ä¸ªä¸²ï¼Œè€ŒåŽè€…å¦‚æžœä¼ è¿›æ¥çš„æ˜¯â€Jan 2 2014â€åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒæœŸæœ›æœˆä»½å¤„ä¼ è¿›æ¥çš„æ˜¯ä¸¤ä¸ªå­—ç¬¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨å¤©ä¸ºä¸ªä½æ•°çš„æƒ…å†µä¸‹ï¼Œä½ å¾—åœ¨å‰é¢è¡¥0ï¼Œæ¯”å¦‚â€Jan 2 2014â€åº”è¯¥æ”¹ä¸ºâ€Jan 02 2014â€ã€‚]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>Time</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Oracleçš„ä¸€äº›å¸¸ç”¨SQL]]></title>
    <url>%2F2020%2F11%2F05%2FOracle%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8SQL%2F</url>
    <content type="text"><![CDATA[Oracleçš„ä¸€äº›å¸¸ç”¨SQLæŸ¥å¤–é”®å»ºåœ¨å“ªä¸ªè¡¨ä¸Šæœ‰æ—¶å€™åˆ é™¤æŸå¼ è¡¨è®°å½•çš„æ—¶å€™ï¼Œä¼šæŠ¥é”™å¤–é”®çº¦æŸä¸èƒ½åˆ é™¤ã€‚ å¦‚æžœä¸äº†è§£è¡¨ä¹‹é—´çš„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æŸ¥è¯¢åˆ°å¤–é”®æ˜¯å»ºåœ¨å“ªå¼ è¡¨ä¸Šçš„ï¼š 1select * from dba_constraints where constraint_name='xxx' and constraint_type = 'R'; åœ¨åžƒåœ¾æ¡¶æŸ¥è¢«åˆ é™¤çš„è¡¨123456select object_name, original_name, partition_name, type, ts_name, createtime, droptimefrom recyclebin-- where original_name = 'extra_charge_detail'where to_date(droptime, 'yyyy-mm-dd hh24:mi:ss') &gt;= sysdate - 1 and type = 'table'order by droptime desc å›žæ»šè¢«åˆ é™¤çš„è¡¨123SELECT * FROM "BIN$l5cbNm6DbqDgU54w3gpQfA==$0";FLASHBACK TABLE "BIN$l5l+JWZRPQ7gU54w3goSNw==$0" TO BEFORE DROP;FLASHBACK TABLE user2 TO BEFORE DROP rename to user2_v2; -- é‡å‘½å å¦‚æžœå·²ç»æ–°å»ºäº†åŒåè¡¨ å°†Clobè½¬æˆå­—ç¬¦ä¸²WM_CONCAT å‡½æ•°å‡ºæ¥çš„æ•°æ®æ˜¯clobç±»åž‹çš„ï¼Œç»„åˆæˆçš„æ•°æ®è‡ªåŠ¨ç”¨&#39;,&#39;åˆ†å‰² æ–¹å¼ä¸€to_char å‡½æ•° é•¿åº¦åªèƒ½åˆ°4000ï¼Œè¶…å‡ºä¼šæˆªå– 12345SELECT O.UUID, O.SOURCE, TO_CHAR(WM_CONCAT(OI.REQ_NO)) AS REQNOSFROM ORDER O LEFT JOIN ORDER_DETAIL OI ON O.UUID = OI.ORDER_UUIDWHERE OI.REQ_NO IS NOT NULLGROUP BY O.UUID, O.SOURCE; æ–¹å¼äºŒdbms_lob.substr å‡½æ•° å¯ä»¥æŒ‡å®šé•¿åº¦ï¼Œè¶…å‡ºä¼šæˆªå– 12345SELECT O.UUID, O.SOURCE, DBMS_LOB.SUBSTR((WM_CONCAT(OI.REQ_NO), 8000)) AS REQNOSFROM ORDER O LEFT JOIN ORDER_DETAIL OI ON O.UUID = OI.ORDER_UUIDWHERE OI.REQ_NO IS NOT NULLGROUP BY O.UUID, O.SOURCE; æ–¹å¼ä¸‰ç”¨ä»£ç è½¬æ¢ 12345678910 Reader is = ((Clob)tuple[i]).getCharacterStream();// å¾—åˆ°æµ BufferedReader br = new BufferedReader(is); String s = br.readLine(); StringBuffer sb = new StringBuffer();// æ‰§è¡Œå¾ªçŽ¯å°†å­—ç¬¦ä¸²å…¨éƒ¨å–å‡ºä»˜å€¼ç»™StringBufferç”±StringBufferè½¬æˆSTRING while (s != null) &#123; sb.append(s); s = br.readLine(); &#125; return sb.toString();]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>Oracle</category>
      </categories>
      <tags>
        <tag>æ•°æ®åº“</tag>
        <tag>Oracle</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JVM æ ¸å¿ƒæŠ€æœ¯]]></title>
    <url>%2F2020%2F10%2F19%2FJVM%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%2F</url>
    <content type="text"><![CDATA[JVM åŸºç¡€çŸ¥è¯†ä»€ä¹ˆæ˜¯ JVMJVM æ˜¯ Java Virtual Machineï¼ˆ Java è™šæ‹Ÿæœºï¼‰çš„ç¼©å†™ï¼Œæ˜¯é€šè¿‡åœ¨å®žé™…çš„è®¡ç®—æœºä¸Šä»¿çœŸæ¨¡æ‹Ÿå„ç§è®¡ç®—æœºåŠŸèƒ½æ¥å®žçŽ°çš„ã€‚ç”±ä¸€å¥—å­—èŠ‚ç æŒ‡ä»¤é›†ã€ä¸€ç»„å¯„å­˜å™¨ã€ä¸€ä¸ªæ ˆã€ä¸€ä¸ªåžƒåœ¾å›žæ”¶å †å’Œä¸€ä¸ªå­˜å‚¨æ–¹æ³•åŸŸç­‰ç»„æˆã€‚JVM å±è”½äº†ä¸Žæ“ä½œç³»ç»Ÿå¹³å°ç›¸å…³çš„ä¿¡æ¯ï¼Œä½¿å¾— Java ç¨‹åºåªéœ€è¦ç”Ÿæˆåœ¨ Java è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ç›®æ ‡ä»£ç ï¼ˆå­—èŠ‚ç ï¼‰ï¼Œå°±å¯åœ¨å¤šç§å¹³å°ä¸Šä¸åŠ ä¿®æ”¹çš„è¿è¡Œï¼Œè¿™ä¹Ÿæ˜¯ Java èƒ½å¤Ÿâ€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œçš„â€åŽŸå› ã€‚ JREã€JDK å’Œ JVM çš„å…³ç³» JVMï¼ˆ Java Virtual Machineï¼Œ Java è™šæ‹Ÿæœºï¼‰æ˜¯ JRE çš„ä¸€éƒ¨åˆ†ã€‚JVM ä¸»è¦å·¥ä½œæ˜¯è§£é‡Šè‡ªå·±çš„æŒ‡ä»¤é›†ï¼ˆå³å­—èŠ‚ç ï¼‰å¹¶æ˜ å°„åˆ°æœ¬åœ°çš„CPUæŒ‡ä»¤é›†å’ŒOSçš„ç³»ç»Ÿè°ƒç”¨ã€‚Java è¯­è¨€æ˜¯è·¨å¹³å°è¿è¡Œçš„ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¼šæœ‰ä¸åŒçš„ JVM æ˜ å°„è§„åˆ™ï¼Œä½¿ä¹‹ä¸Žæ“ä½œç³»ç»Ÿæ— å…³ï¼Œå®Œæˆè·¨å¹³å°æ€§ã€‚ JREï¼ˆ Java Runtime Environmentï¼Œ Java è¿è¡ŒçŽ¯å¢ƒï¼‰ï¼šåœ¨ Java å¹³å°ï¼Œæ‰€æœ‰çš„ç¨‹åºéƒ½è¦åœ¨ JRE ä¸‹æ‰èƒ½å¤Ÿè¿è¡Œã€‚åŒ…æ‹¬ JVM å’Œ Java æ ¸å¿ƒç±»åº“å’Œæ”¯æŒæ–‡ä»¶ã€‚ JDKï¼ˆ Java Development Kitï¼ŒJava å¼€å‘å·¥å…·åŒ…ï¼‰ï¼šæ˜¯ç”¨æ¥ç¼–è¯‘ã€è°ƒè¯• Java ç¨‹åºçš„å¼€å‘å·¥å…·åŒ…ï¼ŒåŒ…æ‹¬ Java å·¥å…·ï¼ˆ javac/java/jdb ç­‰ï¼‰å’Œ Java åŸºç¡€çš„ç±»åº“ã€‚ ðŸ“Œ åŒ…å«å…³ç³»ï¼šJVM &lt; JRE &lt; JDK JVM åŽŸç†Java ä½“ç³»ç»“æž„ä»‹ç» Class Loaderï¼ˆç±»åŠ è½½å™¨ï¼‰ï¼šç”¨äºŽè£…è½½ .class æ–‡ä»¶ã€‚ Execution Engineï¼ˆæ‰§è¡Œå¼•æ“Žï¼‰ï¼šç”¨äºŽæ‰§è¡Œå­—èŠ‚ç æˆ–è€…æœ¬åœ°æ–¹æ³•ã€‚ è¿è¡Œæ—¶æ•°æ®åŒºï¼šæ–¹æ³•åŒºã€å †ã€java æ ˆã€pc å¯„å­˜å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆã€‚ JVM ç”Ÿå‘½å‘¨æœŸä»‹ç»Java å®žä¾‹å¯¹åº”ä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„ Java ç¨‹åºï¼ˆè¿›ç¨‹çº§åˆ«ï¼‰ å¯åŠ¨ å¯åŠ¨ä¸€ä¸ª Java ç¨‹åºï¼Œä¸€ä¸ª JVM å®žä¾‹å°±äº§ç”Ÿã€‚æ‹¥æœ‰ public static void main(String[] args) å‡½æ•°çš„ class å¯ä»¥ä½œä¸º JVM å®žä¾‹è¿è¡Œçš„èµ·ç‚¹ã€‚ è¿è¡Œ main() ä½œä¸ºç¨‹åºåˆå§‹çº¿ç¨‹çš„èµ·ç‚¹ï¼Œä»»ä½•å…¶ä»–çº¿ç¨‹å‡å¯ç”±è¯¥çº¿ç¨‹å¯åŠ¨ã€‚ JVM å†…éƒ¨æœ‰ä¸¤ç§çº¿ç¨‹ï¼šå®ˆæŠ¤çº¿ç¨‹å’Œéžå®ˆæŠ¤çº¿ç¨‹ï¼Œmain() å±žäºŽéžå®ˆæŠ¤çº¿ç¨‹ï¼Œå®ˆæŠ¤çº¿ç¨‹é€šå¸¸ç”± JVM ä½¿ç”¨ï¼Œç¨‹åºå¯ä»¥æŒ‡å®šåˆ›å»ºçš„çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚ æ¶ˆäº¡ å½“ç¨‹åºä¸­çš„æ‰€æœ‰éžå®ˆæŠ¤çº¿ç¨‹éƒ½ç»ˆæ­¢æ—¶ï¼ŒJVM æ‰é€€å‡ºï¼›è‹¥å®‰å…¨ç®¡ç†å™¨å…è®¸ï¼Œç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨ Runtime ç±»æˆ–è€… System.exit() æ¥é€€å‡ºã€‚ JVM æ‰§è¡Œå¼•æ“Žå®žä¾‹åˆ™å¯¹åº”äº†å±žäºŽç”¨æˆ·è¿è¡Œç¨‹åºçº¿ç¨‹ï¼Œå®ƒæ˜¯çº¿ç¨‹çº§åˆ«çš„ã€‚ JVM ç±»åŠ è½½å™¨å‚è€ƒèµ„æ–™ç±»åŠ è½½å™¨ ç±»çš„ç”Ÿå‘½å‘¨æœŸ è£…è½½ï¼ˆloadingï¼‰ï¼š è´Ÿè´£æ‰¾åˆ° Class æ–‡ä»¶å¹¶åŠ è½½è‡³ JVM ä¸­ï¼ŒJVM é€šè¿‡ç±»åã€ç±»æ‰€åœ¨çš„åŒ…åã€ClassLoaderå®Œæˆç±»çš„åŠ è½½ã€‚å› æ­¤ï¼Œæ ‡è¯†ä¸€ä¸ªè¢«åŠ è½½äº†çš„ç±»ï¼šç±»å + åŒ…å + ClassLoader å®žä¾‹ IDã€‚ é“¾æŽ¥ï¼ˆlinkingï¼‰ï¼š éªŒè¯ï¼ˆVerifyingï¼‰ï¼šéªŒè¯ Class æ–‡ä»¶çš„æ ¼å¼ä»¥åŠä¾èµ–ï¼Œä¿è¯ JVM èƒ½å¤Ÿæ‰§è¡Œ å‡†å¤‡ï¼ˆPreparingï¼‰ï¼šä¸ºç”± static ä¿®é¥°çš„æˆå‘˜å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤çš„åˆå§‹å€¼ é»˜è®¤åˆå§‹å€¼å¦‚ä¸‹ï¼š å…«ç§åŸºæœ¬æ•°æ®ç±»åž‹é»˜è®¤çš„åˆå§‹å€¼æ˜¯0 å¼•ç”¨ç±»åž‹é»˜è®¤çš„åˆå§‹å€¼æ˜¯ null æœ‰ static final ä¿®é¥°çš„ä¼šç›´æŽ¥èµ‹å€¼ è§£æžï¼ˆResolvingï¼‰ï¼šæŠŠå¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æŽ¥å¼•ç”¨ã€‚ å³ JVM ä¼šå°†æ‰€æœ‰çš„ç±»æˆ–æŽ¥å£åã€å­—æ®µåã€æ–¹æ³•åè½¬æ¢ä¸ºå…·ä½“çš„å†…å­˜åœ°å€ åˆå§‹åŒ–ï¼ˆInitializingï¼‰ï¼š è´Ÿè´£å°†ç±»ä¸­çš„é™æ€å˜é‡ï¼ˆç±»å˜é‡ï¼‰èµ‹å€¼çš„è¿‡ç¨‹ï¼Œå³åªæœ‰ static ä¿®é¥°çš„æ‰èƒ½è¢«åˆå§‹åŒ–ã€‚ æ‰§è¡Œé¡ºåºï¼šçˆ¶ç±»é™æ€åŸŸæˆ–ç€é™æ€ä»£ç å—ï¼Œç„¶åŽæ˜¯å­ç±»é™æ€åŸŸæˆ–è€…å­ç±»é™æ€ä»£ç å— ä½¿ç”¨ï¼ˆUsingï¼‰ï¼š å¯¹è±¡å®žä¾‹åŒ–ï¼šæ‰§è¡Œç±»ä¸­æž„é€ å‡½æ•°çš„å†…å®¹ å¦‚æžœå­˜åœ¨çˆ¶ç±»ï¼ŒJVM ä¼šé€šè¿‡æ˜¾ç¤ºæˆ–è€…éšç¤ºçš„æ–¹å¼å…ˆæ‰§è¡Œçˆ¶ç±»çš„æž„é€ å‡½æ•°ï¼Œåœ¨å †å†…å­˜ä¸­ä¸ºçˆ¶ç±»çš„å®žä¾‹å˜é‡å¼€è¾Ÿç©ºé—´ï¼Œå¹¶èµ‹äºˆé»˜è®¤çš„åˆå§‹å€¼ï¼Œç„¶åŽåœ¨æ ¹æ®æž„é€ å‡½æ•°çš„ä»£ç å†…å®¹å°†çœŸæ­£çš„å€¼èµ‹äºˆå®žä¾‹å˜é‡æœ¬èº«ï¼Œç„¶åŽï¼Œå¼•ç”¨å˜é‡èŽ·å–å¯¹è±¡çš„é¦–åœ°å€ï¼Œé€šè¿‡æ“ä½œå¯¹è±¡æ¥è°ƒç”¨å®žä¾‹å˜é‡å’Œæ–¹æ³• åžƒåœ¾æ”¶é›†ï¼šå½“å¯¹è±¡ä¸å†è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šè¢«è™šæ‹Ÿæœºæ ‡ä¸Šç‰¹åˆ«çš„åžƒåœ¾è®°å·ï¼Œåœ¨å †ä¸­ç­‰å¾… GC å›žæ”¶ å¯¹è±¡ç»ˆç»“ï¼šå¯¹è±¡è¢« GC å›žæ”¶åŽï¼Œå¯¹è±¡å°±ä¸å†å­˜åœ¨ï¼Œå¯¹è±¡çš„ç”Ÿå‘½ä¹Ÿå°±èµ°åˆ°äº†å°½å¤´ å¸è½½ï¼ˆUnloadingï¼‰ï¼š å³ç±»çš„ç”Ÿå‘½å‘¨æœŸèµ°åˆ°äº†æœ€åŽä¸€æ­¥ï¼Œç¨‹åºä¸­ä¸å†æœ‰è¯¥ç±»çš„å¼•ç”¨ï¼Œè¯¥ç±»ä¹Ÿå°±ä¼šè¢« JVM æ‰§è¡Œåžƒåœ¾å›žæ”¶ï¼Œä»Žæ­¤ç”Ÿå‘½ç»“æŸâ€¦ ç±»åˆå§‹åŒ–é¡ºåº ç±»åˆå§‹åŒ–çš„ä¸€äº›è§„åˆ™ï¼š ç±»ä»Žé¡¶è‡³åº•çš„é¡ºåºåˆå§‹åŒ–ï¼Œæ‰€ä»¥å£°æ˜Žåœ¨é¡¶éƒ¨çš„å­—æ®µçš„æ—©äºŽåº•éƒ¨çš„å­—æ®µåˆå§‹åŒ– è¶…ç±»æ—©äºŽå­ç±»å’Œè¡ç”Ÿç±»çš„åˆå§‹åŒ– å¦‚æžœç±»çš„åˆå§‹åŒ–æ˜¯ç”±äºŽè®¿é—®é™æ€åŸŸè€Œè§¦å‘ï¼Œé‚£ä¹ˆåªæœ‰å£°æ˜Žé™æ€åŸŸçš„ç±»æ‰è¢«åˆå§‹åŒ–ï¼Œè€Œä¸ä¼šè§¦å‘è¶…ç±»çš„åˆå§‹åŒ–æˆ–è€…å­ç±»çš„ åˆå§‹åŒ–å³ä½¿é™æ€åŸŸè¢«å­ç±»æˆ–å­æŽ¥å£æˆ–è€…å®ƒçš„å®žçŽ°ç±»æ‰€å¼•ç”¨ æŽ¥å£åˆå§‹åŒ–ä¸ä¼šå¯¼è‡´çˆ¶æŽ¥å£çš„åˆå§‹åŒ– é™æ€åŸŸçš„åˆå§‹åŒ–æ˜¯åœ¨ç±»çš„é™æ€åˆå§‹åŒ–æœŸé—´ï¼Œéžé™æ€åŸŸçš„åˆå§‹åŒ–æ—¶åœ¨ç±»çš„å®žä¾‹åˆ›å»ºæœŸé—´ã€‚è¿™æ„å‘³è¿™é™æ€åŸŸåˆå§‹åŒ–åœ¨éžé™æ€åŸŸä¹‹å‰ éžé™æ€åŸŸé€šè¿‡æž„é€ å™¨åˆå§‹åŒ–ï¼Œå­ç±»åœ¨åšä»»ä½•åˆå§‹åŒ–ä¹‹å‰æž„é€ å™¨ä¼šéšå«åœ°è°ƒç”¨çˆ¶ç±»çš„æž„é€ å™¨ï¼Œä»–ä¿è¯äº†éžé™æ€æˆ–å®žä¾‹å˜é‡ï¼ˆçˆ¶ç±»ï¼‰åˆå§‹åŒ–æ—©äºŽå­ç±» ç±»çš„åŠ è½½æ—¶æœº å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–ç”¨æˆ·æŒ‡å®šçš„ä¸»ç±»ï¼Œå°±æ˜¯å¯åŠ¨æ‰§è¡Œçš„ main æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼› å½“é‡åˆ°ç”¨ä»¥æ–°å»ºç›®æ ‡ç±»å®žä¾‹çš„ new æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ– new æŒ‡ä»¤çš„ç›®æ ‡ç±»ï¼Œå°±æ˜¯ new ä¸€ä¸ªç±»çš„æ—¶å€™è¦åˆå§‹åŒ–ï¼› å½“é‡åˆ°è°ƒç”¨é™æ€æ–¹æ³•çš„æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ–è¯¥é™æ€æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼› å½“é‡åˆ°è®¿é—®é™æ€å­—æ®µçš„æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ–è¯¥é™æ€å­—æ®µæ‰€åœ¨çš„ç±»ï¼› å­ç±»çš„åˆå§‹åŒ–ä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ï¼› å¦‚æžœä¸€ä¸ªæŽ¥å£å®šä¹‰äº† default æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æŽ¥å®žçŽ°æˆ–è€…é—´æŽ¥å®žçŽ°è¯¥æŽ¥å£çš„ç±»çš„åˆå§‹åŒ–ï¼Œ ä¼š è§¦å‘è¯¥æŽ¥å£çš„åˆå§‹åŒ–ï¼› ä½¿ç”¨åå°„ API å¯¹æŸä¸ªç±»è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ–è¿™ä¸ªç±»ï¼Œå…¶å®žè·Ÿå‰é¢ä¸€æ ·ï¼Œåå°„è°ƒç”¨ è¦ä¹ˆæ˜¯å·²ç»æœ‰å®žä¾‹äº†ï¼Œè¦ä¹ˆæ˜¯é™æ€æ–¹æ³•ï¼Œéƒ½éœ€è¦åˆå§‹åŒ–ï¼› å½“åˆæ¬¡è°ƒç”¨ MethodHandle å®žä¾‹æ—¶ï¼Œåˆå§‹åŒ–è¯¥ MethodHandle æŒ‡å‘çš„æ–¹æ³•æ‰€åœ¨çš„ç±»ã€‚ ä¸ä¼šåˆå§‹åŒ–ï¼ˆå¯èƒ½ä¼šåŠ è½½ï¼‰ä¸‰ç±»åŠ è½½å™¨æ˜¾ç¤ºå½“å‰ ClassLoader åŠ è½½äº†å“ªäº› Jar?è‡ªå®šä¹‰ ClassLoaderæ·»åŠ å¼•ç”¨ç±»çš„å‡ ç§æ–¹å¼JVM å†…å­˜æ¨¡åž‹JVM å†…å­˜ç»“æž„JVM å†…å­˜æ•´ä½“ç»“æž„JVM æ ˆå†…å­˜ç»“æž„JVMé˜Ÿå†…å­˜ç»“æž„CPUä¸Žå†…å­˜è¡Œä¸ºå°ç»“ï¼šä»€ä¹ˆæ˜¯ JMM ?JAVA å­—èŠ‚ç å‚è€ƒèµ„æ–™JAVAå­—èŠ‚ç çš„æŽ¢ç§˜ è½»æ¾çœ‹æ‡‚JAVAå­—èŠ‚ç  ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿå­—èŠ‚ç ç”±å•å­—èŠ‚çš„æŒ‡ä»¤ç»„æˆï¼Œç†è®ºä¸Šæœ€å¤šæ”¯æŒ256ä¸ªæ“ä½œç ï¼ˆopcodeï¼‰ï¼Œå®žé™…ä¸ŠJavaåªä½¿ç”¨äº†200å·¦å³çš„æ“ä½œç ï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œç åˆ™ä¿ç•™ç»™è°ƒè¯•æ“ä½œ æ ¹æ®æŒ‡ä»¤çš„æ€§è´¨ï¼Œä¸»è¦åˆ†ä¸ºå››ä¸ªå¤§ç±»ï¼š æ ˆæ“ä½œæŒ‡ä»¤ï¼ŒåŒ…æ‹¬ä¸Žå±€éƒ¨å˜é‡äº¤äº’çš„æŒ‡ä»¤ ç¨‹åºæµç¨‹æŽ§åˆ¶æŒ‡ä»¤ å¯¹è±¡æ“ä½œæŒ‡ä»¤ï¼ŒåŒ…æ‹¬æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ ç®—æœ¯è¿ç®—ä»¥åŠç±»åž‹è½¬æ¢æŒ‡ä»¤ ç”Ÿæˆå­—èŠ‚ç æœ€ç®€å•çš„å­—èŠ‚ç å¤æ‚ç‚¹çš„ä¾‹å­å­—èŠ‚ç çš„è¿è¡Œæ—¶ç»“æž„ä»ŽåŠ©è®°ç¬¦åˆ°äºŒè¿›åˆ¶å››åˆ™è¿è¡Œçš„ä¾‹å­æ•°å€¼å¤„ç†ä¸Žæœ¬åœ°å˜é‡è¡¨ç®—æ•°æ“ä½œä¸Žç±»åž‹è½¬æ¢ä¸€ä¸ªå®Œæ•´çš„å¾ªçŽ¯æŽ§åˆ¶æ–¹æ³•è°ƒç”¨çš„æŒ‡ä»¤ invokestaticï¼šé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæŒ‡ä»¤ç”¨äºŽè°ƒç”¨æŸä¸ªç±»çš„é™æ€æ–¹æ³•ï¼Œè¿™æ˜¯æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ä¸­æœ€å¿«çš„ä¸€ä¸ªã€‚ invokespecialï¼šç”¨æ¥è°ƒç”¨æž„é€ å‡½æ•°ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºŽè°ƒç”¨åŒä¸€ä¸ªç±»ä¸­çš„ private æ–¹æ³•, ä»¥åŠå¯è§çš„è¶…ç±»æ–¹æ³•ã€‚ invokevirtualï¼šå¦‚æžœæ˜¯å…·ä½“ç±»åž‹çš„ç›®æ ‡å¯¹è±¡ï¼Œinvokevirtual ç”¨äºŽè°ƒç”¨å…¬å…±ï¼Œå—ä¿æŠ¤å’Œ package çº§çš„ç§æœ‰æ–¹æ³•ã€‚ invokeinterfaceï¼šå½“é€šè¿‡æŽ¥å£å¼•ç”¨æ¥è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°†ä¼šç¼–è¯‘ä¸º invokeinterface æŒ‡ä»¤ã€‚ invokedynamicï¼šJDK7 æ–°å¢žåŠ çš„æŒ‡ä»¤ï¼Œæ˜¯å®žçŽ°â€œåŠ¨æ€ç±»åž‹è¯­è¨€â€ï¼ˆDynamically Typed Languageï¼‰æ”¯æŒè€Œè¿›è¡Œçš„å‡çº§æ”¹è¿›ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ JDK8 ä»¥åŽæ”¯æŒ lambda è¡¨è¾¾å¼çš„å®žçŽ°åŸºç¡€ã€‚ ä¸€ä¸ªåŠ¨æ€ä¾‹å­JVM å¯åŠ¨å‚æ•°ç³»ç»Ÿå±žæ€§è¿è¡Œæ¨¡å¼å †å†…å­˜GCç›¸å…³åˆ†æžè¯Šæ–­JavaAgents]]></content>
      <tags>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa çš„ Entity æ³¨è§£]]></title>
    <url>%2F2020%2F10%2F16%2FSpringDataJpa%E7%9A%84Entity%E6%B3%A8%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa çš„ Entity æ³¨è§£JPA åè®®ä¸­å…³äºŽ Entity çš„ç›¸å…³è§„å®š JPA åè®®é‡Œé¢å…³äºŽå®žä½“åšäº†ä¸€äº›è§„å®šã€‚ï¼ˆæŽ¨èä¸€ä¸ªæŸ¥çœ‹ JPA åè®®çš„å®˜æ–¹åœ°å€ï¼‰ å®žä½“æ˜¯ç›´æŽ¥è¿›è¡Œæ•°æ®åº“æŒä¹…åŒ–æ“ä½œçš„é¢†åŸŸå¯¹è±¡ï¼ˆå³ä¸€ä¸ªç®€å•çš„ POJOï¼Œå¯ä»¥æŒ‰ç…§ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†ï¼‰ï¼Œå¿…é¡»é€šè¿‡ @Entity æ³¨è§£è¿›è¡Œæ ‡ç¤ºã€‚ å®žä½“å¿…é¡»æœ‰ä¸€ä¸ª public æˆ–è€… protected çš„æ— å‚æ•°æž„é€ æ–¹æ³•ã€‚ æŒä¹…åŒ–æ˜ å°„çš„æ³¨è§£å¯ä»¥æ ‡ç¤ºåœ¨ Entity çš„å­—æ®µ field ä¸Šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12@Column(length = 20, nullable = false)private String userName; é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥å°†æŒä¹…åŒ–æ³¨è§£è¿ç”¨åœ¨ Entity é‡Œé¢çš„ get/set æ–¹æ³•ä¸Šï¼Œé€šå¸¸æˆ‘ä»¬æ˜¯æ”¾åœ¨ get æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234@Column(length = 20, nullable = false)public String getUserName()&#123; return userName;&#125; æ¦‚æ‹¬èµ·æ¥ï¼Œå°±æ˜¯ Entity é‡Œé¢çš„æ³¨è§£ç”Ÿæ•ˆåªæœ‰ä¸¤ç§æ–¹å¼ï¼šå°†æ³¨è§£å†™åœ¨å­—æ®µä¸Šæˆ–è€…å°†æ³¨è§£å†™åœ¨æ–¹æ³•ä¸Šï¼ˆJPA é‡Œé¢ç§° Propertyï¼‰ã€‚ æ³¨æ„ï¼šåœ¨åŒä¸€ä¸ª Entity é‡Œé¢åªèƒ½æœ‰ä¸€ç§æ–¹å¼ç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ³¨è§£è¦ä¹ˆå…¨éƒ¨å†™åœ¨ field ä¸Šé¢ï¼Œè¦ä¹ˆå°±å…¨éƒ¨å†™åœ¨ Property ä¸Šé¢ã€‚ åªè¦æ˜¯åœ¨ @Entity çš„å®žä½“é‡Œé¢è¢«æ³¨è§£æ ‡æ³¨çš„å­—æ®µï¼Œéƒ½ä¼šè¢«æ˜ å°„åˆ°æ•°æ®åº“ä¸­ï¼Œé™¤äº†ä½¿ç”¨ @Transient æ³¨è§£çš„å­—æ®µä¹‹å¤–ã€‚ å®žä½“é‡Œé¢å¿…é¡»è¦æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä¸»é”®æ ‡ç¤ºçš„å­—æ®µå¯ä»¥æ˜¯å•ä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å¤åˆä¸»é”®å­—æ®µã€‚ ðŸŽ¯æœ‰å…´è¶£å¯ä»¥è¯»ä¸€è¯» Java Persistence API åè®®ï¼Œè¿™æ ·åœ¨åš JPA å¼€å‘çš„æ—¶å€™å°±ä¼šé¡ºæ‰‹å¾ˆå¤šï¼Œå¯ä»¥ç†è§£å¾ˆå¤š Hibernate é‡Œé¢å®žçŽ°æ–¹æ³•ã€‚å½“é‡åˆ°è§£å†³ä¸äº†çš„é—®é¢˜æ—¶ï¼Œå°±åŽ»çœ‹åè®®ã€é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæ·±å…¥æŒ–æŽ˜ä¸€ä¸‹ï¼Œå¯èƒ½å°±ä¼šæ‰¾åˆ°ç­”æ¡ˆã€‚ JPA é‡Œé¢æ”¯æŒçš„å“ªäº›æ³¨è§£é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨ IDEA å·¥å…·ï¼Œæ‰“å¼€ @Entity æ‰€åœ¨çš„åŒ…ï¼Œå°±å¯ä»¥çœ‹åˆ° JPA é‡Œé¢æ”¯æŒçš„æ³¨è§£æœ‰å“ªäº›ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š åœ¨ jakarta.persistence-api çš„åŒ…è·¯å¾„ä¸‹é¢å¤§æ¦‚æœ‰ä¸€ç™¾å¤šä¸ªæ³¨è§£ï¼Œæ²¡äº‹çš„æ—¶å€™å¯ä»¥åˆ°è¿™é‡Œé¢ä¸€ä¸ªä¸€ä¸ªåœ°çœ‹ï¼Œä¹Ÿå¯ä»¥åˆ° JPA çš„åè®®é‡Œé¢å¯¹ç…§æŸ¥çœ‹æ–‡æ¡£ã€‚ è¿™é‡ŒåªæåŠä¸€äº›æœ€å¸¸è§çš„ï¼ŒåŒ…æ‹¬ @Entityã€@Tableã€@Accessã€@Idã€@GeneratedValueã€@Enumeratedã€@Basicã€@Columnã€@Transientã€@Lobã€@Temporal ç­‰ã€‚ @Entity ç”¨äºŽå®šä¹‰å¯¹è±¡å°†ä¼šæˆä¸ºè¢« JPA ç®¡ç†çš„å®žä½“ï¼Œå¿…å¡«ï¼Œå°†å­—æ®µæ˜ å°„åˆ°æŒ‡å®šçš„æ•°æ®åº“è¡¨ä¸­ï¼Œä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œç›´æŽ¥ç”¨åœ¨å®žä½“ç±»ä¸Šé¢å³å¯ï¼Œé€šè¿‡æºç è¡¨è¾¾çš„è¯­æ³•å¦‚ä¸‹ï¼š 12345@Target(TYPE) //è¡¨ç¤ºæ­¤æ³¨è§£åªèƒ½ç”¨åœ¨classä¸Šé¢public @interface Entity &#123; //å¯é€‰ï¼Œé»˜è®¤æ˜¯å®žä½“ç±»çš„åå­—ï¼Œæ•´ä¸ªåº”ç”¨é‡Œé¢å…¨å±€å”¯ä¸€ã€‚ String name() default "";&#125; @Table ç”¨äºŽæŒ‡å®šæ•°æ®åº“çš„è¡¨åï¼Œè¡¨ç¤ºæ­¤å®žä½“å¯¹åº”çš„æ•°æ®åº“é‡Œé¢çš„è¡¨åï¼Œéžå¿…å¡«ï¼Œé»˜è®¤è¡¨åå’Œ entity åå­—ä¸€æ ·ã€‚ 1234567891011@Target(TYPE) //ä¸€æ ·åªèƒ½ç”¨åœ¨ç±»ä¸Šé¢public @interface Table &#123; //è¡¨çš„åå­—ï¼Œå¯é€‰ã€‚å¦‚æžœä¸å¡«å†™ï¼Œç³»ç»Ÿè®¤ä¸ºå’Œå®žä½“çš„åå­—ä¸€æ ·ä¸ºè¡¨åã€‚ String name() default ""; //æ­¤è¡¨æ‰€åœ¨schemaï¼Œå¯é€‰ String schema() default ""; //å”¯ä¸€æ€§çº¦æŸï¼Œåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æœ‰ç”¨ï¼Œè¡¨åˆ›å»ºä¹‹åŽåŽé¢å°±ä¸éœ€è¦äº†ã€‚ UniqueConstraint[] uniqueConstraints() default &#123; &#125;; //ç´¢å¼•ï¼Œåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ä½¿ç”¨ï¼Œè¡¨åˆ›å»ºä¹‹åŽåŽé¢å°±ä¸éœ€è¦äº†ã€‚ Index[] indexes() default &#123;&#125;;&#125; @Access ç”¨äºŽæŒ‡å®š entity é‡Œé¢çš„æ³¨è§£æ˜¯å†™åœ¨å­—æ®µä¸Šé¢ï¼Œè¿˜æ˜¯ get/set æ–¹æ³•ä¸Šé¢ç”Ÿæ•ˆï¼Œéžå¿…å¡«ã€‚åœ¨é»˜è®¤ä¸å¡«å†™çš„æƒ…å†µä¸‹ï¼Œå½“å®žä½“é‡Œé¢çš„ç¬¬ä¸€ä¸ªæ³¨è§£å‡ºçŽ°åœ¨å­—æ®µä¸Šæˆ–è€… get/set æ–¹æ³•ä¸Šé¢ï¼Œå°±ä»¥ç¬¬ä¸€æ¬¡å‡ºçŽ°çš„æ–¹å¼ä¸ºå‡†ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå®žä½“é‡Œé¢çš„æ³¨è§£æ—¢æœ‰ç”¨åœ¨ field ä¸Šé¢ï¼Œåˆæœ‰ç”¨åœ¨ properties ä¸Šé¢çš„æ—¶å€™ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ä½ å°±ä¼šæ˜Žç™½ã€‚ 123456@Idprivate Long id;@Column(length = 20, nullable = false)public String getUserName()&#123; return userName;&#125; é‚£ä¹ˆç”±äºŽ @Id æ˜¯å®žä½“é‡Œé¢ç¬¬ä¸€ä¸ªå‡ºçŽ°çš„æ³¨è§£ï¼Œå¹¶ä¸”ä½œç”¨åœ¨å­—æ®µä¸Šé¢ï¼Œæ‰€ä»¥æ‰€æœ‰å†™åœ¨ get/set æ–¹æ³•ä¸Šé¢çš„æ³¨è§£å°±ä¼šå¤±æ•ˆã€‚è€Œ @Access å¯ä»¥å¹²é¢„é»˜è®¤å€¼ï¼ŒæŒ‡å®šæ˜¯åœ¨ fields ä¸Šé¢ç”Ÿæ•ˆè¿˜æ˜¯åœ¨ properties ä¸Šé¢ç”Ÿæ•ˆã€‚æˆ‘ä»¬é€šè¿‡æºç çœ‹ä¸‹è¯­æ³•ï¼š 123456789101112//è¡¨ç¤ºæ­¤æ³¨è§£å¯ä»¥è¿ç”¨åœ¨classä¸Š(é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±å¯ä»¥æŒ‡å®šæ­¤å®žä½“çš„é»˜è®¤æ³¨è§£ç”Ÿæ•ˆç­–ç•¥äº†)ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨æ–¹æ³•ä¸Šæˆ–è€…å­—æ®µä¸Š(è¡¨ç¤ºå¯ä»¥ç‹¬ç«‹è®¾ç½®æŸä¸€ä¸ªå­—æ®µæˆ–è€…æ–¹æ³•çš„ç”Ÿæ•ˆç­–ç•¥)ï¼›@Target( &#123; TYPE, METHOD, FIELD &#125;)@Retention(RUNTIME)public @interface Access &#123; //æŒ‡å®šæ˜¯å­—æ®µä¸Šé¢ç”Ÿæ•ˆè¿˜æ˜¯æ–¹æ³•ä¸Šé¢ç”Ÿæ•ˆ AccessType value();&#125;public enum AccessType &#123; FIELD, PROPERTY&#125; @Id å®šä¹‰å±žæ€§ä¸ºæ•°æ®åº“çš„ä¸»é”®ï¼Œä¸€ä¸ªå®žä½“é‡Œé¢å¿…é¡»æœ‰ä¸€ä¸ªä¸»é”®ï¼Œä½†ä¸ä¸€å®šæ˜¯è¿™ä¸ªæ³¨è§£ï¼Œå¯ä»¥å’Œ @GeneratedValue é…åˆä½¿ç”¨æˆ–æˆå¯¹å‡ºçŽ°ã€‚ @GeneratedValue ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234567public @interface GeneratedValue &#123; //Idçš„ç”Ÿæˆç­–ç•¥ GenerationType strategy() default AUTO; //é€šè¿‡ Sequences ç”Ÿæˆ Idï¼Œå¸¸è§çš„æ˜¯ Oracle æ•°æ®åº“ ID ç”Ÿæˆè§„åˆ™ï¼Œ //è¿™ä¸ªæ—¶å€™éœ€è¦é…åˆ @SequenceGenerator ä½¿ç”¨ String generator() default "";&#125; å…¶ä¸­ï¼ŒGenerationType ä¸€å…±æœ‰ä»¥ä¸‹å››ä¸ªå€¼ï¼š 12345678910public enum GenerationType &#123; //é€šè¿‡è¡¨äº§ç”Ÿä¸»é”®ï¼Œæ¡†æž¶å€Ÿç”±è¡¨æ¨¡æ‹Ÿåºåˆ—äº§ç”Ÿä¸»é”®ï¼Œä½¿ç”¨è¯¥ç­–ç•¥å¯ä»¥ä½¿åº”ç”¨æ›´æ˜“äºŽæ•°æ®åº“ç§»æ¤ TABLE, //é€šè¿‡åºåˆ—äº§ç”Ÿä¸»é”®ï¼Œé€šè¿‡ @SequenceGenerator æ³¨è§£æŒ‡å®šåºåˆ—åï¼ŒMySql ä¸æ”¯æŒè¿™ç§æ–¹å¼ SEQUENCE, //é‡‡ç”¨æ•°æ®åº“ ID è‡ªå¢žé•¿ï¼Œ ä¸€èˆ¬ç”¨äºŽmysqlæ•°æ®åº“ IDENTITY, //JPA è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„ç­–ç•¥ï¼Œæ˜¯é»˜è®¤é€‰é¡¹ AUTO&#125; @Enumerated è¿™ä¸ªæ³¨è§£å¾ˆå¥½ç”¨ï¼Œå› ä¸ºå®ƒå¯¹ enum æä¾›äº†ä¸‹æ ‡å’Œ name ä¸¤ç§æ–¹å¼ï¼Œç”¨æ³•ç›´æŽ¥æ˜ å°„åœ¨ enum æžšä¸¾ç±»åž‹çš„å­—æ®µä¸Šã€‚è¯·çœ‹ä¸‹é¢æºç ï¼š 123456789101112@Target(&#123;METHOD, FIELD&#125;) //ä½œç”¨åœ¨æ–¹æ³•å’Œå­—æ®µä¸Špublic @interface Enumerated &#123; //æžšä¸¾æ˜ å°„çš„ç±»åž‹ï¼Œé»˜è®¤æ˜¯ORDINALï¼ˆå³æžšä¸¾å­—æ®µçš„ä¸‹æ ‡ï¼‰ã€‚ EnumType value() default ORDINAL;&#125;public enum EnumType &#123; //æ˜ å°„æžšä¸¾å­—æ®µçš„ä¸‹æ ‡ ORDINAL, //æ˜ å°„æžšä¸¾çš„Name STRING&#125; å†æ¥çœ‹ä¸€ä¸ª User é‡Œé¢å…³äºŽæ€§åˆ«æžšä¸¾çš„ä¾‹å­ï¼Œä½ å°±ä¼šçŸ¥é“ @Enumerated åœ¨è¿™é‡Œæ²¡ä»€ä¹ˆä½œç”¨äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789101112131415161718//æœ‰ä¸€ä¸ªæžšä¸¾ç±»ï¼Œç”¨æˆ·çš„æ€§åˆ«public enum Gender &#123; MALE("ç”·æ€§"), FEMALE("å¥³æ€§"); private String value; private Gender(String value) &#123; this.value = value; &#125;&#125;//å®žä½“ç±»@Enumeratedçš„å†™æ³•å¦‚ä¸‹@Entity@Table(name = "tb_user")public class User implements Serializable &#123; @Enumerated(EnumType.STRING) @Column(name = "user_gender") private Gender gender; .......................&#125; è¿™æ—¶å€™æ’å…¥ä¸¤æ¡æ•°æ®ï¼Œæ•°æ®åº“é‡Œé¢çš„å€¼ä¼šå˜æˆ MALE/FEMALEï¼Œè€Œä¸æ˜¯â€œç”·æ€§â€ / å¥³æ€§ã€‚ ðŸ“Œç»éªŒåˆ†äº«ï¼š å¦‚æžœæˆ‘ä»¬ç”¨ @Enumeratedï¼ˆEnumType.ORDINALï¼‰ï¼Œè¿™æ—¶å€™æ•°æ®åº“é‡Œé¢çš„å€¼æ˜¯ 0ã€1ã€‚ä½†æ˜¯å®žé™…å·¥ä½œä¸­ï¼Œä¸å»ºè®®ç”¨æ•°å­—ä¸‹æ ‡ï¼Œå› ä¸ºæžšä¸¾é‡Œé¢çš„å±žæ€§å€¼æ˜¯ä¼šä¸æ–­æ–°å¢žçš„ï¼Œå¦‚æžœæ–°å¢žä¸€ä¸ªï¼Œä½ç½®å˜åŒ–äº†å°±æƒ¨äº†ã€‚å¹¶ä¸” 0ã€1ã€2 è¿™ç§ä¸‹æ ‡åœ¨æ•°æ®åº“é‡Œé¢çœ‹ç€éžå¸¸ç—›è‹¦ï¼Œæ—¶é—´é•¿äº†å°±ä¼šä¸€ç‚¹ä¹Ÿçœ‹ä¸æ‡‚äº†ã€‚ @Basic è¡¨ç¤ºå±žæ€§æ˜¯åˆ°æ•°æ®åº“è¡¨çš„å­—æ®µçš„æ˜ å°„ã€‚å¦‚æžœå®žä½“çš„å­—æ®µä¸Šæ²¡æœ‰ä»»ä½•æ³¨è§£ï¼Œé»˜è®¤å³ä¸º @Basicã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤æ‰€æœ‰çš„å­—æ®µè‚¯å®šæ˜¯å’Œæ•°æ®åº“è¿›è¡Œæ˜ å°„çš„ï¼Œå¹¶ä¸”é»˜è®¤ä¸º Eager ç±»åž‹ã€‚ 123456public @interface Basic &#123; //å¯é€‰ï¼ŒEAGERï¼ˆé»˜è®¤ï¼‰ï¼šç«‹å³åŠ è½½ï¼›LAZYï¼šå»¶è¿ŸåŠ è½½ã€‚ï¼ˆLAZYä¸»è¦åº”ç”¨åœ¨å¤§å­—æ®µä¸Šé¢ï¼‰ FetchType fetch() default EAGER; //å¯é€‰ã€‚è¿™ä¸ªå­—æ®µæ˜¯å¦å¯ä»¥ä¸ºnullï¼Œé»˜è®¤æ˜¯trueã€‚ boolean optional() default true;&#125; @Transient è¡¨ç¤ºè¯¥å±žæ€§å¹¶éžä¸€ä¸ªåˆ°æ•°æ®åº“è¡¨çš„å­—æ®µçš„æ˜ å°„ï¼Œè¡¨ç¤ºéžæŒä¹…åŒ–å±žæ€§ã€‚JPA æ˜ å°„æ•°æ®åº“çš„æ—¶å€™å¿½ç•¥å®ƒï¼Œä¸Ž @Basic æœ‰ç›¸åçš„ä½œç”¨ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªå­—æ®µä¸Šé¢ @Transient å’Œ @Basic å¿…é¡»äºŒé€‰ä¸€ï¼Œè€Œä»€ä¹ˆéƒ½ä¸æŒ‡å®šçš„è¯ï¼Œé»˜è®¤æ˜¯ @Basicã€‚ @Column å®šä¹‰è¯¥å±žæ€§å¯¹åº”æ•°æ®åº“ä¸­çš„åˆ—åã€‚ 12345678910111213141516public @interface Column &#123; //æ•°æ®åº“ä¸­çš„è¡¨çš„åˆ—åï¼›å¯é€‰ï¼Œå¦‚æžœä¸å¡«å†™è®¤ä¸ºå­—æ®µåå’Œå®žä½“å±žæ€§åä¸€æ ·ã€‚ String name() default ""; //æ˜¯å¦å”¯ä¸€ã€‚é»˜è®¤falseï¼Œå¯é€‰ã€‚ boolean unique() default false; //æ•°æ®å­—æ®µæ˜¯å¦å…è®¸ç©ºã€‚å¯é€‰ï¼Œé»˜è®¤trueã€‚ boolean nullable() default true; //æ‰§è¡Œinsertæ“ä½œçš„æ—¶å€™æ˜¯å¦åŒ…å«æ­¤å­—æ®µï¼Œé»˜è®¤ï¼Œtrueï¼Œå¯é€‰ã€‚ boolean insertable() default true; //æ‰§è¡Œupdateçš„æ—¶å€™æ˜¯å¦åŒ…å«æ­¤å­—æ®µï¼Œé»˜è®¤ï¼Œtrueï¼Œå¯é€‰ã€‚ boolean updatable() default true; //è¡¨ç¤ºè¯¥å­—æ®µåœ¨æ•°æ®åº“ä¸­çš„å®žé™…ç±»åž‹ã€‚ String columnDefinition() default ""; //æ•°æ®åº“å­—æ®µçš„é•¿åº¦ï¼Œå¯é€‰ï¼Œé»˜è®¤255 int length() default 255;&#125; @Temporal ç”¨æ¥è®¾ç½® Date ç±»åž‹çš„å±žæ€§æ˜ å°„åˆ°å¯¹åº”ç²¾åº¦çš„å­—æ®µï¼Œå­˜åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š @Temporal(TemporalType.DATE) æ˜ å°„ä¸ºæ—¥æœŸï¼ˆåªæœ‰æ—¥æœŸï¼‰ @Temporal(TemporalType.TIME) æ˜ å°„ä¸ºæ—¥æœŸï¼ˆåªæœ‰æ—¶é—´ï¼‰ @Temporal(TemporalType.TIMESTAMP) æ˜ å°„ä¸ºæ—¥æœŸï¼ˆæ—¥æœŸ+æ—¶é—´ï¼‰ çœ‹ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼Œæ„Ÿå—ä¸€ä¸‹ä¸Šé¢æåˆ°çš„æ³¨è§£çš„å®Œæ•´ç”¨æ³•ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package com.example.jpa.example1;import lombok.Data;import javax.persistence.*;import java.util.Date;@Entity@Table(name = "user_topic")@Access(AccessType.FIELD)@Datapublic class UserTopic &#123; @Id @Column(name = "id", nullable = false) @GeneratedValue(strategy = GenerationType.IDENTITY) private Integer id; @Column(name = "title", nullable = true, length = 200) private String title; @Basic @Column(name = "create_user_id", nullable = true) private Integer createUserId; @Basic(fetch = FetchType.LAZY) @Column(name = "content", nullable = true, length = -1) @Lob private String content; @Basic(fetch = FetchType.LAZY) @Column(name = "image", nullable = true) @Lob private byte[] image; @Basic @Column(name = "create_time", nullable = true) @Temporal(TemporalType.TIMESTAMP) private Date createTime; @Basic @Column(name = "create_date", nullable = true) @Temporal(TemporalType.DATE) private Date createDate; @Enumerated(EnumType.STRING) @Column(name = "topic_type") private Type type; @Transient private String transientSimple; //éžæ•°æ®åº“æ˜ å°„å­—æ®µï¼Œä¸šåŠ¡ç±»åž‹çš„å­—æ®µ public String getTransientSimple() &#123; return title + "auto:jack" + type; &#125; //æœ‰ä¸€ä¸ªæžšä¸¾ç±»ï¼Œä¸»é¢˜çš„ç±»åž‹ public enum Type &#123; EN("è‹±æ–‡"), CN("ä¸­æ–‡"); private final String des; Type(String des) &#123; this.des = des; &#125; &#125;&#125; å…¶å®žè¿™é‡Œé¢çš„å¾ˆå¤šæ³¨è§£éƒ½å¯ä»¥çœç•¥ï¼Œç›´æŽ¥ä½¿ç”¨é»˜è®¤çš„å°±å¯ä»¥ã€‚å¦‚ @Basicã€@Column åå­—æœ‰ä¸€å®šçš„æ˜ å°„ç­–ç•¥ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ã€‚ æ­¤å¤–ï¼Œ@Access ä¹Ÿå¯ä»¥çœç•¥ï¼Œæˆ‘ä»¬åªè¦åœ¨è¿™äº›ç±»é‡Œé¢ä¿æŒä¸€è‡´å°±å¯ä»¥äº†ã€‚ ç”Ÿæˆè¿™äº›æ³¨è§£çš„å°æŠ€å·§æœ‰æ—¶å€™è€çš„ Table éžå¸¸å¤šï¼Œä¸€ä¸ªä¸€ä¸ªåŽ»å†™ entity ä¼šç‰¹åˆ«ç´¯ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨ IDEA å·¥å…·ç›´æŽ¥å¸®æˆ‘ä»¬ç”Ÿæˆ Entity ç±»ã€‚å…³é”®æ­¥éª¤å¦‚ä¸‹ï¼š é¦–å…ˆï¼Œæ‰“å¼€ Persistence è§†å›¾ï¼Œç‚¹å‡» Generate Persistence Mappingï¼ŒæŽ¥ç€ç‚¹å‡»é€‰ä¸­æ•°æ®æºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç„¶åŽï¼Œé€‰æ‹©è¡¨å’Œå­—æ®µï¼Œå¹¶ç‚¹å‡» OKã€‚ è¿™æ ·å°±å¯ä»¥ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„å®žä½“äº†ï¼Œå¤šç®€å•ã€‚å¦‚æžœæ˜¯æ–°åº“ã€æ–°è¡¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆå®šä¹‰å¥½å®žä½“ï¼Œé€šè¿‡å®žä½“é…ç½® JPA çš„ spring.jpa.generate-ddl=trueï¼Œåå‘ç›´æŽ¥ç”Ÿæˆ DDL æ“ä½œæ•°æ®åº“ç”Ÿæˆè¡¨ç»“æž„ã€‚ ðŸŽ¯æ³¨æ„ï¼šåœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­è¦æŠŠå¤–é”®å…³è”å…³ç³»å…³é—­ï¼Œä¸ç„¶ä¼šå‡ºçŽ°æ„æƒ³ä¸åˆ°çš„ ERRORï¼Œæ¯•ç«Ÿç”Ÿäº§çŽ¯å¢ƒä¸åŒå¼€å‘çŽ¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¼€å‘çŽ¯å¢ƒç”Ÿæˆçš„è¡¨å¯¼å‡º DDL åˆ°ç”Ÿäº§æ‰§è¡Œã€‚åˆ©ç”¨ç”Ÿæˆ DDL æ¥åšæµ‹è¯•å’Œå†™æ¡ˆä¾‹ï¼Œå¯ä»¥çœåŽ»åˆ›å»ºè¡¨çš„æ—¶é—´ï¼Œåªéœ€è¦å…³æ³¨ä»£ç å°±è¡Œäº†ã€‚ è”åˆä¸»é”®å¯ä»¥é€šè¿‡ javax.persistence.EmbeddedId å’Œ javax.persistence.IdClass ä¸¤ä¸ªæ³¨è§£å®žçŽ°è”åˆä¸»é”®çš„æ•ˆæžœã€‚ å¦‚ä½•é€šè¿‡ @IdClass åšåˆ°è”åˆä¸»é”®ï¼Ÿç¬¬ä¸€æ­¥ï¼šæ–°å»ºä¸€ä¸ª UserInfoID ç±»é‡Œé¢æ˜¯è”åˆä¸»é”®ã€‚ 12345678910111213package com.example.jpa.example1;import lombok.AllArgsConstructor;import lombok.Builder;import lombok.Data;import lombok.NoArgsConstructor;import java.io.Serializable;@Data@Builder@AllArgsConstructor@NoArgsConstructorpublic class UserInfoID implements Serializable &#123; private String name, telephone;&#125; ç¬¬äºŒæ­¥ï¼šå†æ–°å»ºä¸€ä¸ª UserInfo çš„å®žä½“ï¼Œé‡‡ç”¨ @IdClass å¼•ç”¨è”åˆä¸»é”®ç±»ã€‚ 12345678910111213@Entity@Data@Builder@IdClass(UserInfoID.class)@AllArgsConstructor@NoArgsConstructorpublic class UserInfo &#123; private Integer ages; @Id private String name; @Id private String telephone;&#125; ç¬¬ä¸‰æ­¥ï¼šæ–°å¢žä¸€ä¸ª UserInfoRepository ç±»æ¥åš CRUD æ“ä½œã€‚ 1234package com.example.jpa.example1;import org.springframework.data.jpa.repository.JpaRepository;public interface UserInfoRepository extends JpaRepository&lt;UserInfo, UserInfoID&gt; &#123;&#125; ç¬¬å››æ­¥ï¼šå†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæµ‹è¯•ä¸€ä¸‹ã€‚ 123456789101112131415161718package com.example.jpa.example1;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;import java.util.Optional;@DataJpaTestpublic class UserInfoRepositoryTest &#123; @Autowired private UserInfoRepository userInfoRepository; public void testIdClass() &#123; userInfoRepository.save(UserInfo.builder().ages(1) .name("jack").telephone("123456789").build()); Optional&lt;UserInfo&gt; userInfo = userInfoRepository.findById( UserInfoID.builder().name("jack").telephone("123456789").build()); System.out.println(userInfo.get()); &#125;&#125; è¾“å‡ºç»“æžœå¦‚ä¸‹ï¼š 123Hibernate: create table user_info (name varchar(255) not null, telephone varchar(255) not null, ages integer, primary key (name, telephone))Hibernate: select userinfo0_.name as name1_3_0_, userinfo0_.telephone as telephon2_3_0_, userinfo0_.ages as ages3_3_0_ from user_info userinfo0_ where userinfo0_.name=? and userinfo0_.telephone=?UserInfo(ages=1, name=jack, telephone=123456789) ä¸Šé¢çš„ä¾‹å­ï¼Œè¡¨çš„ä¸»é”®æ˜¯ (name, telephone)ï¼Œè€Œ Entity é‡Œé¢ä¸å†æ˜¯ä¸€ä¸ª @Id å­—æ®µäº†ã€‚ @Embeddable ä¸Ž @EmbeddedId æ³¨è§£ä½¿ç”¨ç¬¬ä¸€æ­¥ï¼šåœ¨æˆ‘ä»¬ä¸Šé¢ä¾‹å­ä¸­çš„ UserInfoID é‡Œé¢æ·»åŠ  @Embeddable æ³¨è§£ã€‚ 12345678@Data@Builder@AllArgsConstructor@NoArgsConstructor@Embeddablepublic class UserInfoID implements Serializable &#123; private String name, telephone;&#125; ç¬¬äºŒæ­¥ï¼šæ”¹ä¸€ä¸‹åˆšæ‰çš„ User å¯¹è±¡ï¼Œåˆ é™¤ @IdClassï¼Œæ·»åŠ  @EmbeddedId æ³¨è§£ï¼Œå¦‚ä¸‹ï¼š 123456789101112@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructorpublic class UserInfo &#123; private Integer ages; @EmbeddedId private UserInfoID userInfoID; @Column(unique = true) private String uniqueNumber;&#125; ç¬¬ä¸‰æ­¥ï¼šUserInfoRepository ä¸å˜ï¼Œæˆ‘ä»¬ç›´æŽ¥ä¿®æ”¹ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ã€‚ 12345678910111213@Test public void testIdClass() &#123; userInfoRepository.save( UserInfo.builder() .ages(1) .userInfoID(UserInfoID.builder().name("jack") .telephone("123456789").build()) .build()); Optional&lt;UserInfo&gt; userInfo = userInfoRepository.findById( UserInfoID.builder().name("jack").telephone("123456789").build()); System.out.println(userInfo.get()); &#125; è¿è¡Œå®Œä¹‹åŽï¼Œä½ å¯ä»¥å¾—åˆ°ç›¸åŒçš„ç»“æžœã€‚é‚£ä¹ˆ @IdClass å’Œ @EmbeddedId çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼ŒEmbedded ç”¨çš„æ˜¯å¯¹è±¡ï¼Œè€Œ IdClass ç”¨çš„æ˜¯å…·ä½“çš„æŸä¸€ä¸ªå­—æ®µï¼› äºŒè€…çš„JPQL ä¹Ÿä¼šä¸ä¸€æ ·ï¼š ç”¨ @IdClass JPQL çš„å†™æ³•ï¼šSELECT u.name FROM UserInfo u ç”¨ @EmbeddedId çš„ JPQL çš„å†™æ³•ï¼šselect u.userInfoId.name FROM UserInfo u è”åˆä¸»é”®è¿˜æœ‰éœ€è¦æ³¨æ„çš„å°±æ˜¯ï¼Œå®ƒä¸Žå”¯ä¸€æ€§ç´¢å¼•çº¦æŸçš„åŒºåˆ«æ˜¯å†™æ³•ä¸åŒï¼Œå¦‚ä¸Šé¢æ‰€è®²ï¼Œå”¯ä¸€æ€§ç´¢å¼•çš„å†™æ³•å¦‚ä¸‹ï¼š 12@Column(unique = true)private String uniqueNumber; å®žä½“ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä½•å®žçŽ°åœ¨ Java é¢å‘å¯¹è±¡çš„è¯­è¨€çŽ¯å¢ƒä¸­ï¼Œ@Entity ä¹‹é—´çš„å…³ç³»å¤šç§å¤šæ ·ï¼Œè€Œæ ¹æ® JPA çš„è§„èŒƒï¼Œå¤§è‡´å¯ä»¥å°†å…¶åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š çº¯ç²¹çš„ç»§æ‰¿ï¼Œå’Œè¡¨æ²¡å…³ç³»ï¼Œå¯¹è±¡ä¹‹é—´çš„å­—æ®µå…±äº«ã€‚åˆ©ç”¨æ³¨è§£ @MappedSuperclassï¼Œåè®®è§„å®šçˆ¶ç±»ä¸èƒ½æ˜¯ @Entityã€‚ å•è¡¨å¤šæ€é—®é¢˜ï¼ŒåŒä¸€å¼  Tableï¼Œè¡¨ç¤ºäº†ä¸åŒçš„å¯¹è±¡ï¼Œé€šè¿‡ä¸€ä¸ªå­—æ®µæ¥è¿›è¡ŒåŒºåˆ†ã€‚åˆ©ç”¨@Inheritance(strategy = InheritanceType.SINGLE_TABLE)æ³¨è§£å®Œæˆï¼Œåªæœ‰çˆ¶ç±»æœ‰ @Tableã€‚ å¤šè¡¨å¤šæ€ï¼Œæ¯ä¸€ä¸ªå­ç±»ä¸€å¼ è¡¨ï¼Œçˆ¶ç±»çš„è¡¨æ‹¥æœ‰æ‰€æœ‰å…¬ç”¨å­—æ®µã€‚é€šè¿‡@Inheritance(strategy = InheritanceType.JOINED)æ³¨è§£å®Œæˆï¼Œçˆ¶ç±»å’Œå­ç±»éƒ½æ˜¯è¡¨ï¼Œæœ‰å…¬ç”¨çš„å­—æ®µåœ¨çˆ¶è¡¨é‡Œé¢ã€‚ Object çš„ç»§æ‰¿ï¼Œæ•°æ®åº“é‡Œé¢æ¯ä¸€å¼ è¡¨æ˜¯åˆ†å¼€çš„ï¼Œç›¸äº’ç‹¬ç«‹ä¸å—å½±å“ã€‚é€šè¿‡@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)æ³¨è§£å®Œæˆï¼Œçˆ¶ç±»ï¼ˆå¯ä»¥æ˜¯ä¸€å¼ è¡¨ï¼Œä¹Ÿå¯ä»¥ä¸æ˜¯ï¼‰å’Œå­ç±»éƒ½æ˜¯è¡¨ï¼Œç›¸äº’ä¹‹é—´æ²¡æœ‰å…³ç³»ã€‚ å•è¡¨å¤šæ€InheritanceType.SINGLE_TABLE çˆ¶ç±»å®žä½“å¯¹è±¡ä¸Žå„ä¸ªå­å®žä½“å¯¹è±¡å…±ç”¨ä¸€å¼ è¡¨ï¼Œé€šè¿‡ä¸€ä¸ªå­—æ®µçš„ä¸åŒå€¼ä»£è¡¨ä¸åŒçš„å¯¹è±¡ã€‚ ä¸¾ä¾‹ï¼ŒæŠ½è±¡ä¸€ä¸ª Book å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213package com.example.jpa.example1.book;import lombok.Data;import javax.persistence.*;@Entity(name="book")@Data@Inheritance(strategy = InheritanceType.SINGLE_TABLE)@DiscriminatorColumn(name="color", discriminatorType = DiscriminatorType.STRING)public class Book &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String title;&#125; å†æ–°å»ºä¸€ä¸ª BlueBook å¯¹è±¡ï¼Œä½œä¸º Book çš„å­å¯¹è±¡ã€‚ 123456789101112package com.example.jpa.example1.book;import lombok.Data;import lombok.EqualsAndHashCode;import javax.persistence.DiscriminatorValue;import javax.persistence.Entity;@Entity@Data@EqualsAndHashCode(callSuper=false)@DiscriminatorValue("blue")public class BlueBook extends Book&#123; private String blueMark;&#125; å†æ–°å»ºä¸€ä¸ª RedBook å¯¹è±¡ï¼Œä½œä¸º Book çš„å¦ä¸€å­å¯¹è±¡ã€‚ 12345678//çº¢çš®ä¹¦@Entity@DiscriminatorValue("red")@Data@EqualsAndHashCode(callSuper=false)public class RedBook extends Book &#123; private String redMark;&#125; è¿™æ—¶ï¼Œä¸€å…±æ–°å»ºäº†ä¸‰ä¸ª Entity å¯¹è±¡ï¼Œå…¶å®žéƒ½æ˜¯æŒ‡ book è¿™ä¸€å¼ è¡¨ï¼Œé€šè¿‡ book è¡¨é‡Œé¢çš„ color å­—æ®µæ¥åŒºåˆ†çº¢ä¹¦è¿˜æ˜¯ç»¿ä¹¦ã€‚ æµ‹è¯•çœ‹çœ‹ç»“æžœï¼Œæ–°å»ºä¸€ä¸ª RedBookRepository ç±»ï¼Œç»“æžœå¦‚ä¸‹ï¼š 123package com.example.jpa.example1.book;import org.springframework.data.jpa.repository.JpaRepository;public interface RedBookRepository extends JpaRepository&lt;RedBook, Long&gt;&#123;&#125; ç„¶åŽå†æ–°å»ºä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š 123456789101112131415161718192021package com.example.jpa.example1;import com.example.jpa.example1.book.RedBook;import com.example.jpa.example1.book.RedBookRepository;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;@DataJpaTestpublic class RedBookRepositoryTest &#123; @Autowired private RedBookRepository redBookRepository; @Test public void testRedBook() &#123; RedBook redBook = new RedBook(); redBook.setTitle("redbook"); redBook.setRedMark("redmark"); redBook.setId(1L); redBookRepository.saveAndFlush(redBook); RedBook r = redBookRepository.findById(1L).get(); System.out.println(r.getId() + ":" + r.getTitle() + ":" + r.getRedMark()); &#125;&#125; æœ€åŽçœ‹ä¸€ä¸‹æ‰§è¡Œç»“æžœï¼š 1Hibernate: create table book (color varchar(31) not null, id bigint not null, title varchar(255), blue_mark varchar(255), red_mark varchar(255), primary key (id)) å‘çŽ°åªåˆ›å»ºäº†ä¸€å¼ è¡¨ï¼Œinsert äº†ä¸€æ¡æ•°æ®ï¼Œä½†æ˜¯ color å­—æ®µé»˜è®¤ç»™çš„æ˜¯ redã€‚ 1Hibernate: insert into book (title, red_mark, color, id) values (?, ?, 'red', ?) é‚£ä¹ˆå†çœ‹ä¸€ä¸‹æ‰“å°ç»“æžœï¼š 11:redbook:redmark ç»“æžœå®Œå…¨å’Œé¢„æœŸçš„ä¸€æ ·ï¼Œè¿™è¯´æ˜Žäº† RedBookã€BlueBookã€Bookï¼Œéƒ½æ˜¯ä¸€å¼ è¡¨ï¼Œé€šè¿‡å­—æ®µ color çš„å€¼ä¸ä¸€æ ·ï¼Œæ¥åŒºåˆ†ä¸åŒçš„å®žä½“ã€‚ å¤šè¡¨å¤šæ€InheritanceType.JOINED åœ¨è¿™ç§æ˜ å°„ç­–ç•¥é‡Œé¢ï¼Œç»§æ‰¿ç»“æž„ä¸­çš„æ¯ä¸€ä¸ªå®žä½“ï¼ˆentityï¼‰ç±»éƒ½ä¼šæ˜ å°„åˆ°æ•°æ®åº“é‡Œä¸€ä¸ªå•ç‹¬çš„è¡¨ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå®žä½“ï¼ˆentityï¼‰éƒ½ä¼šè¢«æ˜ å°„åˆ°æ•°æ®åº“ä¸­ï¼Œä¸€ä¸ªå®žä½“ï¼ˆentityï¼‰ç±»å¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€ä¸ªè¡¨ã€‚ å…¶ä¸­æ ¹å®žä½“ï¼ˆroot entityï¼‰å¯¹åº”çš„è¡¨ä¸­å®šä¹‰äº†ä¸»é”®ï¼ˆprimary keyï¼‰ï¼Œæ‰€æœ‰çš„å­ç±»å¯¹åº”çš„æ•°æ®åº“è¡¨éƒ½è¦å…±åŒä½¿ç”¨ Book é‡Œé¢çš„ @ID è¿™ä¸ªä¸»é”®ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¸‰ä¸ªå®žä½“ï¼Œæµ‹è¯•ä¸€ä¸‹InheritanceType.JOINEDï¼Œæ”¹åŠ¨å¦‚ä¸‹ï¼š 123456789101112package com.example.jpa.example1.book;import lombok.Data;import javax.persistence.*;@Entity(name="book")@Data@Inheritance(strategy = InheritanceType.JOINED)public class Book &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String title;&#125; å…¶æ¬¡ï¼Œæˆ‘ä»¬ Book çˆ¶ç±»ã€æ”¹å˜ Inheritance ç­–ç•¥ã€åˆ é™¤ DiscriminatorColumnï¼Œä½ ä¼šçœ‹åˆ°å¦‚ä¸‹ç»“æžœã€‚ 123456789101112package com.example.jpa.example1.book;import lombok.Data;import lombok.EqualsAndHashCode;import javax.persistence.Entity;import javax.persistence.PrimaryKeyJoinColumn;@Entity@Data@EqualsAndHashCode(callSuper=false)@PrimaryKeyJoinColumn(name = "book_id", referencedColumnName = "id")public class BlueBook extends Book&#123; private String blueMark;&#125; 123456789101112package com.example.jpa.example1.book;import lombok.Data;import lombok.EqualsAndHashCode;import javax.persistence.Entity;import javax.persistence.PrimaryKeyJoinColumn;@Entity@PrimaryKeyJoinColumn(name = "book_id", referencedColumnName = "id")@Data@EqualsAndHashCode(callSuper=false)public class RedBook extends Book &#123; private String redMark;&#125; ç„¶åŽï¼ŒBlueBook å’Œ RedBook ä¹Ÿåˆ é™¤ DiscriminatorColumnï¼Œæ–°å¢ž@PrimaryKeyJoinColumn(name = &quot;book_id&quot;, referencedColumnName = &quot;id&quot;)ï¼Œå’Œ book çˆ¶ç±»å…±ç”¨ä¸€ä¸ªä¸»é”®å€¼ï¼Œè€Œ RedBookRepository å’Œæµ‹è¯•ç”¨ä¾‹ä¸å˜ï¼Œæˆ‘ä»¬æ‰§è¡Œçœ‹ä¸€ä¸‹ç»“æžœã€‚ 12345Hibernate: create table blue_book (blue_mark varchar(255), book_id bigint not null, primary key (book_id))Hibernate: create table book (id bigint not null, title varchar(255), primary key (id))Hibernate: create table red_book (red_mark varchar(255), book_id bigint not null, primary key (book_id))Hibernate: alter table blue_book add constraint FK9uuwgq7a924vtnys1rgiyrlk7 foreign key (book_id) references bookHibernate: alter table red_book add constraint FKk8rvl61bjy9lgsr9nhxn5soq5 foreign key (book_id) references book ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸€å…±åˆ›å»ºäº†ä¸‰å¼ è¡¨ï¼Œå¹¶ä¸”æ–°å¢žäº†ä¸¤ä¸ªå¤–é”®çº¦æŸï¼› è€Œæˆ‘ä»¬ save çš„æ—¶å€™ä¹Ÿç”Ÿæˆäº†ä¸¤ä¸ª insert è¯­å¥ï¼Œå¦‚ä¸‹ï¼š 12Hibernate: insert into book (title, id) values (?, ?)Hibernate: insert into red_book (red_mark, book_id) values (?, ?) è€Œæ‰“å°ç»“æžœä¾ç„¶ä¸å˜ã€‚ 11:redbook:redmark è¿™ä¸ªæ–¹æ³•å’Œä¸Šé¢çš„ InheritanceType.SINGLE_TABLE åŒºåˆ«åœ¨äºŽè¡¨çš„æ•°é‡å’Œå…³ç³»ä¸ä¸€æ ·ï¼Œè¿™æ˜¯è¡¨è®¾è®¡çš„å¦ä¸€ç§æ–¹å¼ã€‚ Object çš„ç»§æ‰¿InheritanceType.TABLE_PER_CLASS å’Œ @MappedSuperClass ä¸€æ · æˆ‘ä»¬åœ¨ä½¿ç”¨ @MappedSuperClass ä¸»é”®çš„æ—¶å€™ï¼Œå¦‚æžœä¸æŒ‡å®š @Inheritanceï¼Œé»˜è®¤å°±æ˜¯æ­¤ç§ TABLE_PER_CLASS æ¨¡å¼ã€‚å½“ç„¶äº†ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¾ç¤ºæŒ‡å®šï¼Œè¦æ±‚ç»§æ‰¿åŸºç±»çš„éƒ½æ˜¯ä¸€å¼ è¡¨ï¼Œè€Œçˆ¶ç±»ä¸æ˜¯è¡¨ï¼Œæ˜¯ java å¯¹è±¡çš„æŠ½è±¡ç±»ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ã€‚ é¦–å…ˆï¼Œè¿˜æ˜¯æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä¸‰ä¸ªå®žä½“ã€‚ 123456789101112package com.example.jpa.example1.book;import lombok.Data;import javax.persistence.*;@Entity(name="book")@Data@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)public class Book &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String title;&#125; å…¶æ¬¡ï¼ŒBook è¡¨é‡‡ç”¨ TABLE_PER_CLASS ç­–ç•¥ï¼Œå…¶å­å®žä½“ç±»éƒ½ä»£è¡¨å„è‡ªçš„è¡¨ï¼Œå®žä½“ä»£ç å¦‚ä¸‹ï¼š 12345678910package com.example.jpa.example1.book;import lombok.Data;import lombok.EqualsAndHashCode;import javax.persistence.Entity;@Entity@Data@EqualsAndHashCode(callSuper=false)public class RedBook extends Book &#123; private String redMark;&#125; 12345678910package com.example.jpa.example1.book;import lombok.Data;import lombok.EqualsAndHashCode;import javax.persistence.Entity;@Entity@Data@EqualsAndHashCode(callSuper=false)public class BlueBook extends Book&#123; private String blueMark;&#125; è¿™æ—¶ï¼Œä»Ž RedBook å’Œ BlueBook é‡Œé¢åŽ»æŽ‰ PrimaryKeyJoinColumnï¼Œ è€Œ RedBookRepository å’Œæµ‹è¯•ç”¨ä¾‹ä¸å˜ï¼Œæˆ‘ä»¬æ‰§è¡Œçœ‹ä¸€ä¸‹ç»“æžœã€‚ 123Hibernate: create table blue_book (id bigint not null, title varchar(255), blue_mark varchar(255), primary key (id))Hibernate: create table book (id bigint not null, title varchar(255), primary key (id))Hibernate: create table red_book (id bigint not null, title varchar(255), red_mark varchar(255), primary key (id)) è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿˜æ˜¯åˆ›å»ºäº†ä¸‰å¼ è¡¨ï¼Œä½†ä¸‰å¼ è¡¨ä»€ä¹ˆå…³ç³»ä¹Ÿæ²¡æœ‰ã€‚ è€Œ insert è¯­å¥ä¹Ÿåªæœ‰ä¸€æ¡ï¼Œå¦‚ä¸‹ï¼š 1Hibernate: insert into red_book (title, red_mark, id) values (?, ?, ?) æ‰“å°ç»“æžœè¿˜æ˜¯ä¸å˜ã€‚ 11:redbook:redmark è¿™ä¸ªæ–¹æ³•ä¸Žä¸Šé¢ä¸¤ä¸ªç›¸æ¯”è¾ƒï¼Œè¯­ä¹‰æ›´åŠ æ¸…æ™°ï¼Œæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§åšæ³•ã€‚ å…³äºŽç»§æ‰¿å…³ç³»çš„ç»éªŒä¹‹è°ˆ ðŸŽ¯ä¸ªäººç»éªŒæ¥çœ‹ï¼Œ@Inheritance çš„è¿™ç§ä½¿ç”¨æ–¹å¼ä¼šé€æ¸è¢«æ·˜æ±°ï¼Œå› ä¸ºè¿™æ ·çš„è¡¨çš„è®¾è®¡å¾ˆå¤æ‚ï¼Œæœ¬åº”è¯¥åœ¨ä¸šåŠ¡å±‚é¢åšçš„äº‹æƒ…ï¼ˆå¤šæ€ï¼‰ï¼Œå´éƒ½åœ¨ dataSource çš„è¡¨çº§åˆ«åšäº†ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Entity æ³¨è§£</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa @Queryçš„ä½¿ç”¨]]></title>
    <url>%2F2020%2F10%2F14%2FSpringDataJpa%E7%9A%84%40Query%E7%94%A8%E6%B3%95%2F</url>
    <content type="text"><![CDATA[Spring Data Jpa @Queryçš„ä½¿ç”¨ å¿«é€Ÿä½“éªŒ @Query çš„æ–¹æ³•ã€ JpaQueryLookupStrategy å…³é”®æºç å‰–æžã€ @Query çš„åŸºæœ¬ç”¨æ³•ã€ @Query ä¹‹ Projections åº”ç”¨è¿”å›žæŒ‡å®š DTOã€ @Query åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³• å¿«é€Ÿä½“éªŒ @Query çš„æ–¹æ³•12345678910package com.example.jpa.example1;import org.springframework.data.jpa.repository.JpaRepository;import org.springframework.data.jpa.repository.Query;import org.springframework.data.repository.query.Param;public interface UserDtoRepository extends JpaRepository&lt;User,Long&gt; &#123; //é€šè¿‡queryæ³¨è§£æ ¹æ®nameæŸ¥è¯¢userä¿¡æ¯ @Query("From User where name=:name") User findByQuery(@Param("name") String nameParam);&#125; ç„¶åŽï¼Œæˆ‘ä»¬æ–°å¢žä¸€ä¸ªæµ‹è¯•ç±»ï¼š 12345678910111213141516171819package com.example.jpa.example1;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;@DataJpaTestpublic class UserRepositoryQueryTest &#123; @Autowired private UserDtoRepository userDtoRepository; @Test public void testQueryAnnotation() &#123;//æ–°å¢žä¸€æ¡æ•°æ®æ–¹ä¾¿æµ‹è¯• userDtoRepository.save(User.builder().name("jackxx").email("123456@126.com").sex("man").address("shanghai").build()); //è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•æŸ¥çœ‹ç»“æžœ User user2 = userDtoRepository.findByQuery("jack"); System.out.println(user2); &#125;&#125; æœ€åŽï¼Œçœ‹åˆ°è¿è¡Œçš„ç»“æžœå¦‚ä¸‹ï¼š 123Hibernate: insert into user (address, email, name, sex, version, id) values (?, ?, ?, ?, ?, ?)Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_, user0_.version as version6_0_ from user user0_ where user0_.name=?User(id=1, name=jack, email=123456@126.com, version=0, sex=man, address=shanghai) é€šè¿‡ä¸Šé¢çš„ä¾‹å­ä¸æ˜¯é€šè¿‡æ–¹æ³•åæ¥ç”ŸæˆæŸ¥è¯¢è¯­æ³•ï¼Œè€Œæ˜¯ @Query æ³¨è§£åœ¨å…¶ä¸­èµ·äº†ä½œç”¨ï¼Œ ä½¿ From User where name=:name JPQL ç”Ÿæ•ˆäº†ã€‚ JpaQueryLookupStrategy å…³é”®æºç å‰–æžæ‰“å¼€ QueryExecutorMethodInterceptor ç±»ï¼Œæ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š å†è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ—¶å€™åœ¨99è¡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç­–ç•¥æ˜¯CreateIfNotFoundï¼Œä¹Ÿå°±æ˜¯å¦‚æžœæœ‰@Queryæ³¨è§£ï¼Œé‚£ä¹ˆä»¥@Queryçš„æ³¨è§£å†…å®¹ä¸ºå‡†ï¼Œå¯ä»¥å¿½ç•¥æ–¹æ³•åã€‚ è¿›å…¥åˆ° lookupStrategy.resolveQuery é‡Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š é€šè¿‡ä¸Šå›¾çš„æ–­ç‚¹å’Œçº¢æ¡†ä¹‹å¤„ï¼Œå‘çŽ°Spring Data JPA è¿™ä¸ªåœ°æ–¹ä½¿ç”¨äº†ç­–ç•¥ã€æ¨¡å¼ï¼Œå½“æˆ‘ä»¬è‡ªå·±å†™ç­–ç•¥æ¨¡å¼çš„æ—¶å€™ä¹Ÿå¯ä»¥è¿›è¡Œå‚è€ƒã€‚ å¾€ä¸‹ debugï¼Œè¿›å…¥åˆ° resolveQuery æ–¹æ³•é‡Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å›¾ä¸­ â‘ å¤„ï¼Œå¦‚æžœ Query æ³¨è§£æ‰¾åˆ°äº†ï¼Œå°±ä¸ä¼šèµ°åˆ° â‘¡ å¤„äº†ã€‚ æŸ¥çœ‹ Query å±žæ€§ï¼Œä½ ä¼šå‘çŽ°è¿™é‡ŒåŒæ—¶ç”Ÿæˆäº†ä¸¤ä¸ª SQLï¼š æŸ¥è¯¢æ€»æ•°çš„ Query å®šä¹‰ æŸ¥è¯¢ç»“æžœçš„ Query å®šä¹‰ å¦‚æžœæƒ³çœ‹ Query å…·ä½“æ˜¯æ€Žä¹ˆç”Ÿæˆçš„ã€ä¸Šé¢çš„ @Param æ³¨è§£æ˜¯æ€Žä¹ˆç”Ÿæ•ˆçš„ï¼Œå¯ä»¥åœ¨ä¸Šé¢çš„å›¾ â‘  å¤„ debug ç»§ç»­å¾€é‡Œé¢çœ‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š @Query çš„åŸºæœ¬ç”¨æ³•åŸºæœ¬ç”¨æ³•123456789101112131415161718192021222324252627282930313233343536373839package org.springframework.data.jpa.repository;public @interface Query &#123; /** * æŒ‡å®šJPQLçš„æŸ¥è¯¢è¯­å¥ã€‚ï¼ˆnativeQuery=trueçš„æ—¶å€™ï¼Œæ˜¯åŽŸç”Ÿçš„Sqlè¯­å¥ï¼‰ */ String value() default ""; /** * æŒ‡å®šcountçš„JPQLè¯­å¥ï¼Œå¦‚æžœä¸æŒ‡å®šå°†æ ¹æ®queryè‡ªåŠ¨ç”Ÿæˆã€‚ * ï¼ˆå¦‚æžœå½“nativeQuery=trueçš„æ—¶å€™ï¼ŒæŒ‡çš„æ˜¯åŽŸç”Ÿçš„Sqlè¯­å¥ï¼‰ */ String countQuery() default ""; /** * æ ¹æ®å“ªä¸ªå­—æ®µæ¥countï¼Œä¸€èˆ¬é»˜è®¤å³å¯ã€‚ */ String countProjection() default ""; /** * é»˜è®¤æ˜¯falseï¼Œè¡¨ç¤ºvalueé‡Œé¢æ˜¯ä¸æ˜¯åŽŸç”Ÿçš„sqlè¯­å¥ */ boolean nativeQuery() default false; /** * å¯ä»¥æŒ‡å®šä¸€ä¸ªqueryçš„åå­—ï¼Œå¿…é¡»å”¯ä¸€çš„ã€‚ * å¦‚æžœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ç”Ÿæˆè§„åˆ™æ˜¯ï¼š * &#123;$domainClass&#125;.$&#123;queryMethodName&#125; */ String name() default ""; /* * å¯ä»¥æŒ‡å®šä¸€ä¸ªcountçš„queryçš„åå­—ï¼Œå¿…é¡»å”¯ä¸€çš„ã€‚ * å¦‚æžœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ç”Ÿæˆè§„åˆ™æ˜¯ï¼š * &#123;$domainClass&#125;.$&#123;queryMethodName&#125;.count */ String countName() default "";&#125; @Query ç”¨æ³•æ˜¯ä½¿ç”¨ JPQL ä¸ºå®žä½“åˆ›å»ºå£°æ˜Žå¼æŸ¥è¯¢æ–¹æ³•ã€‚æˆ‘ä»¬ä¸€èˆ¬åªéœ€è¦å…³å¿ƒ @Query é‡Œé¢çš„ value å’Œ nativeQueryã€countQuery çš„å€¼å³å¯ã€‚ ä½¿ç”¨å£°æ˜Žå¼ JPQL æŸ¥è¯¢æœ‰ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å¯åŠ¨çš„æ—¶å€™å°±çŸ¥é“ä½ çš„è¯­æ³•æ­£ç¡®ä¸æ­£ç¡®ã€‚ JPQL çš„è¯­æ³•æŸ¥è¯¢çš„è¯­æ³•ç»“æž„ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234SELECT ... FROM ...[WHERE ...][GROUP BY ... [HAVING ...]][ORDER BY ...] å®ƒçš„è¯­æ³•ç»“æž„æœ‰ç‚¹ç±»ä¼¼ SQLï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ JPQL FROM åŽé¢è·Ÿçš„æ˜¯å¯¹è±¡ï¼Œè€Œ SQL é‡Œé¢çš„å­—æ®µå¯¹åº”çš„æ˜¯å¯¹è±¡é‡Œé¢çš„å±žæ€§å­—æ®µã€‚ åŒç†æˆ‘ä»¬çœ‹ä¸€ä¸‹ update å’Œ delete çš„è¯­æ³•ç»“æž„ï¼š 12DELETE FROM ... [WHERE ...]UPDATE ... SET ... [WHERE ...] å…¶ä¸­â€œâ€¦â€çœç•¥çš„éƒ¨åˆ†æ˜¯å®žä½“å¯¹è±¡åå­—å’Œå®žä½“å¯¹è±¡é‡Œé¢çš„å­—æ®µåå­—ï¼Œè€Œå…¶ä¸­ç±»ä¼¼ SQL ä¸€æ ·åŒ…å«çš„è¯­æ³•å…³é”®å­—æœ‰ï¼š 1SELECT FROM WHERE UPDATE DELETE JOIN OUTER INNER LEFT GROUP BY HAVING FETCH DISTINCT OBJECT NULL TRUE FALSE NOT AND OR BETWEEN LIKE IN AS UNKNOWN EMPTY MEMBER OF IS AVG MAX MIN SUM COUNT ORDER BY ASC DESC MOD UPPER LOWER TRIM POSITION CHARACTER_LENGTH CHAR_LENGTH BIT_LENGTH CURRENT_TIME CURRENT_DATE CURRENT_TIMESTAMP NEW EXISTS ALL ANY SOME é€šè¿‡æŸ¥çœ‹è¿™ä¸ª Oracle çš„ JPQL æ–‡æ¡£ï¼Œæ‰¾åˆ°è§£å†³é—®é¢˜çš„åŠžæ³•ã€‚ @Query ç”¨æ³•æ¡ˆä¾‹ @Query æ€Žä¹ˆä½¿ç”¨ã€æ€Žä¹ˆä¼ é€’å‚æ•°ã€æ€Žä¹ˆåˆ†é¡µ æ¡ˆä¾‹ 1è¦åœ¨ Repository çš„æŸ¥è¯¢æ–¹æ³•ä¸Šå£°æ˜Žä¸€ä¸ªæ³¨è§£ï¼Œè¿™é‡Œå°±æ˜¯ @Query æ³¨è§£æ ‡æ³¨çš„åœ°æ–¹ã€‚ 1234public interface UserRepository extends JpaRepository&lt;User, Long&gt;&#123; @Query("select u from User u where u.emailAddress = ?1") User findByEmailAddress(String emailAddress);&#125; æ¡ˆä¾‹ 2LIKE æŸ¥è¯¢ï¼Œæ³¨æ„ firstname ä¸ä¼šè‡ªåŠ¨åŠ ä¸Šâ€œ%â€å…³é”®å­—ã€‚ 1234public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query("select u from User u where u.firstname like %?1") List&lt;User&gt; findByFirstnameEndsWith(String firstname);&#125; æ¡ˆä¾‹ 3ç›´æŽ¥ç”¨åŽŸå§‹ SQLï¼ŒnativeQuery = true å³å¯ã€‚ 1234public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query(value = "SELECT * FROM USERS WHERE EMAIL_ADDRESS = ?1", nativeQuery = true) User findByEmailAddress(String emailAddress);&#125; æ³¨æ„ï¼šnativeQuery ä¸æ”¯æŒç›´æŽ¥ Sort çš„å‚æ•°æŸ¥è¯¢ã€‚ æ¡ˆä¾‹ 4ä¸‹é¢æ˜¯nativeQuery çš„æŽ’åºé”™è¯¯çš„å†™æ³•ï¼Œä¼šå¯¼è‡´æ— æ³•å¯åŠ¨ã€‚ 1234public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query(value = "select * from user_info where first_name=?1",nativeQuery = true) List&lt;UserInfoEntity&gt; findByFirstName(String firstName,Sort sort);&#125; æ¡ˆä¾‹ 5nativeQuery æŽ’åºçš„æ­£ç¡®å†™æ³•ã€‚ 1234@Query(value = "select * from user_info where first_name=?1 order by ?2",nativeQuery = true)List&lt;UserInfoEntity&gt; findByFirstName(String firstName,String sort);//è°ƒç”¨çš„åœ°æ–¹å†™æ³•last_nameæ˜¯æ•°æ®é‡Œé¢çš„å­—æ®µåï¼Œä¸æ˜¯å¯¹è±¡çš„å­—æ®µårepository.findByFirstName("jackzhang","last_name"); é€šè¿‡ä¸Šé¢å‡ ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† @Query çš„å‡ ç§ç”¨æ³•ï¼Œä½ å°±ä¼šæ˜Žç™½æŽ’åºã€å‚æ•°ã€ä½¿ç”¨æ–¹æ³•ã€LIKEã€åŽŸå§‹ SQL æ€Žä¹ˆå†™ã€‚ @Query çš„æŽ’åº@Queryä¸­åœ¨ç”¨JPQLçš„æ—¶å€™ï¼Œæƒ³è¦å®žçŽ°æŽ’åºï¼Œæ–¹æ³•ä¸Šç›´æŽ¥ç”¨ PageRequest æˆ–è€… Sort å‚æ•°éƒ½å¯ä»¥åšåˆ°ã€‚ åœ¨æŽ’åºå®žä¾‹ä¸­ï¼Œå®žé™…ä½¿ç”¨çš„å±žæ€§éœ€è¦ä¸Žå®žä½“æ¨¡åž‹é‡Œé¢çš„å­—æ®µç›¸åŒ¹é…ï¼Œè¿™æ„å‘³ç€å®ƒä»¬éœ€è¦è§£æžä¸ºæŸ¥è¯¢ä¸­ä½¿ç”¨çš„å±žæ€§æˆ–åˆ«åã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¾‹å­ï¼Œè¿™æ˜¯ä¸€ä¸ªstate_field_path_expression JPQLçš„å®šä¹‰ï¼Œå¹¶ä¸” Sort çš„å¯¹è±¡æ”¯æŒä¸€äº›ç‰¹å®šçš„å‡½æ•°ã€‚ æ¡ˆä¾‹ 6Sort and JpaSort çš„ä½¿ç”¨ï¼Œå®ƒå¯ä»¥è¿›è¡ŒæŽ’åºã€‚ 1234567891011121314public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query("select u from User u where u.lastname like ?1%") List&lt;User&gt; findByAndSort(String lastname, Sort sort); @Query("select u.id, LENGTH(u.firstname) as fn_len from User u where u.lastname like ?1%") List&lt;Object[]&gt; findByAsArrayAndSort(String lastname, Sort sort);&#125;//è°ƒç”¨æ–¹çš„å†™æ³•ï¼Œå¦‚ä¸‹ï¼šrepo.findByAndSort("lannister", new Sort("firstname")); repo.findByAndSort("stark", new Sort("LENGTH(firstname)")); repo.findByAndSort("targaryen", JpaSort.unsafe("LENGTH(firstname)"));repo.findByAsArrayAndSort("bolton", new Sort("fn_len")); ä¸Šé¢è¿™ä¸ªæ¡ˆä¾‹è®²è¿°çš„æ˜¯æŽ’åºç”¨æ³•ï¼Œå†æ¥çœ‹ä¸‹ @Query çš„åˆ†é¡µç”¨æ³•ã€‚ @Query çš„åˆ†é¡µ@Query çš„åˆ†é¡µåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«ä¸º JQPl çš„æŽ’åºå’Œ nativeQuery çš„æŽ’åºã€‚ æ¡ˆä¾‹ 7ç›´æŽ¥ç”¨ Page å¯¹è±¡æŽ¥å—æŽ¥å£ï¼Œå‚æ•°ç›´æŽ¥ç”¨ Pageable çš„å®žçŽ°ç±»å³å¯ã€‚ 12345678public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query(value = "select u from User u where u.lastname = ?1") Page&lt;User&gt; findByLastname(String lastname, Pageable pageable);&#125;//è°ƒç”¨è€…çš„å†™æ³•repository.findByFirstName("jackzhang",new PageRequest(1,10)); æ¡ˆä¾‹ 8@Query å¯¹åŽŸç”Ÿ SQL çš„åˆ†é¡µæ”¯æŒï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«å‹å¥½ï¼Œå› ä¸ºè¿™ç§å†™æ³•æ¯”è¾ƒâ€œéª‡å®¢â€ï¼Œå¯èƒ½éšç€ç‰ˆæœ¬çš„ä¸åŒä¼šæœ‰æ‰€å˜åŒ–ã€‚æˆ‘ä»¬ä»¥ MySQL ä¸ºä¾‹ã€‚ 12345678910111213 public interface UserRepository extends JpaRepository&lt;UserInfoEntity, Integer&gt;, JpaSpecificationExecutor&lt;UserInfoEntity&gt; &#123; @Query(value = "select * from user_info where first_name=?1 /* #pageable# */", countQuery = "select count(*) from user_info where first_name=?1", nativeQuery = true) Page&lt;UserInfoEntity&gt; findByFirstName(String firstName, Pageable pageable);&#125;//è°ƒç”¨è€…çš„å†™æ³•return userRepository.findByFirstName("jackzhang",new PageRequest(1,10, Sort.Direction.DESC,"last_name"));//æ‰“å°å‡ºæ¥çš„sqlselect * from user_info where first_name=? /* #pageable# */ order by last_name desc limit ?, ? æ³¨æ„ï¼šè¿™ä¸ªæ³¨é‡Š / #pageable# / å¿…é¡»æœ‰ã€‚ å¦å¤–ï¼Œéšç€ç‰ˆæœ¬çš„å˜åŒ–ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å¯èƒ½ä¼šè¿›è¡Œä¼˜åŒ–ã€‚ æ­¤å¤–è¿˜æœ‰ä¸€ç§å®žçŽ°æ–¹æ³•ï¼Œå°±æ˜¯è‡ªå·±å†™ä¸¤ä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œè‡ªå·±æ‰‹åŠ¨åˆ†é¡µã€‚ @Param ç”¨æ³•@Param æ³¨è§£æŒ‡å®šæ–¹æ³•å‚æ•°çš„å…·ä½“åç§°ï¼Œé€šè¿‡ç»‘å®šçš„å‚æ•°åå­—æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œè¿™æ ·ä¸éœ€è¦å…³å¿ƒå‚æ•°çš„é¡ºåºã€‚æ¯”è¾ƒæŽ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºå®ƒæ¯”è¾ƒåˆ©äºŽä»£ç é‡æž„ã€‚å¦‚æžœä¸ç”¨ @Param ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå‚æ•°æ˜¯æœ‰åºçš„ï¼Œè¿™ä½¿å¾—æŸ¥è¯¢æ–¹æ³•å¯¹å‚æ•°ä½ç½®çš„é‡æž„å®¹æ˜“å‡ºé”™ã€‚æˆ‘ä»¬çœ‹ä¸ªæ¡ˆä¾‹ã€‚ æ¡ˆä¾‹ 9æ ¹æ® firstname å’Œ lastname å‚æ•°æŸ¥è¯¢ user å¯¹è±¡ã€‚ 123456public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query("select u from User u where u.firstname = :firstname or u.lastname = :lastname") User findByLastnameOrFirstname(@Param("lastname") String lastname, @Param("firstname") String firstname);&#125; æ¡ˆä¾‹ 10æ ¹æ®å‚æ•°è¿›è¡ŒæŸ¥è¯¢ï¼Œtop 10 å‰é¢è¯´çš„â€œquery methodâ€å…³é”®å­—ç…§æ ·æœ‰ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234567public interface UserRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query("select u from User u where u.firstname = :firstname or u.lastname = :lastname") User findTop10ByLastnameOrFirstname(@Param("lastname") String lastname, @Param("firstname") String firstname);&#125; é€šè¿‡ @Query å®šä¹‰è‡ªå·±çš„æŸ¥è¯¢æ–¹æ³•æ—¶ï¼Œå»ºè®®ä¹Ÿç”¨ Spring Data JPA çš„ name query çš„å‘½åæ–¹æ³•ï¼Œè¿™æ ·ä¸‹æ¥é£Žæ ¼å°±æ¯”è¾ƒç»Ÿä¸€äº†ã€‚ @Query ä¹‹ Projections åº”ç”¨è¿”å›žæŒ‡å®š DTOJPAæ–‡æ¡£ - 3.3.1 å…³äºŽ Projections æ–°å¢žä¸€å¼ è¡¨ UserExtendï¼Œé‡Œé¢åŒ…å«èº«ä»½è¯ã€å­¦å·ã€å¹´é¾„ç­‰ä¿¡æ¯ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„å®žä½“å˜æˆå¦‚ä¸‹æ¨¡æ ·ï¼š 123456789101112131415161718192021222324252627282930313233343536@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructorpublic class UserExtend &#123; //ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨ @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private Long userId; private String idCard; private Integer ages; private String studentNumber;&#125;@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructorpublic class User &#123; //ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨ @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email; @Version private Long version; private String sex; private String address;&#125; å¦‚æžœæˆ‘ä»¬æƒ³å®šä¹‰ä¸€ä¸ª DTO å¯¹è±¡ï¼Œé‡Œé¢åªè¦ nameã€emailã€idCardï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ€Žä¹ˆåŠžå‘¢ï¼Ÿè¿™ç§åœºæ™¯éžå¸¸å¸¸è§ï¼Œä½†å¥½å¤šäººä½¿ç”¨çš„éƒ½ä¸æ˜¯æœ€ä½³å®žè·µï¼Œæˆ‘åœ¨è¿™é‡Œä»‹ç»å‡ ç§æ–¹å¼åšä¸€ä¸‹å¯¹æ¯”ã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ï¼Œåˆšå­¦ JPA çš„æ—¶å€™åˆ«æ‰‹åˆ«è„šçš„å†™æ³•ï¼š 1234567891011public interface UserDtoRepository extends JpaRepository&lt;User,Long&gt; &#123; /** * æŸ¥è¯¢ç”¨æˆ·è¡¨é‡Œé¢çš„nameã€emailå’ŒUserExtendè¡¨é‡Œé¢çš„idCard * @param id * @return */ @Query("select u.name,u.email,e.idCard from User u,UserExtend e where u.id= e.userId and u.id=:id") List&lt;Object[]&gt; findByUserId(@Param("id") Long id);&#125; æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æµ‹è¯•ç”¨ä¾‹æ¥å–ä¸Šé¢ findByUserId æ–¹æ³•è¿”å›žçš„æ•°æ®ç»„ç»“æžœå€¼ï¼Œå†å¡žåˆ° DTO é‡Œé¢ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213@Testpublic void testQueryAnnotation() &#123;//æ–°å¢žä¸€æ¡ç”¨æˆ·æ•°æ® userDtoRepository.save(User.builder().name("jack").email("123456@126.com").sex("man").address("shanghai").build());//å†æ–°å¢žä¸€æ¡å’Œç”¨æˆ·ä¸€å¯¹ä¸€çš„UserExtendæ•°æ® userExtendRepository.save(UserExtend.builder().userId(1L).idCard("shengfengzhenghao").ages(18).studentNumber("xuehao001").build());//æŸ¥è¯¢æˆ‘ä»¬æƒ³è¦çš„ç»“æžœ List&lt;Object[]&gt; userArray = userDtoRepository.findByUserId(1L); System.out.println(String.valueOf(userArray.get(0)[0])+String.valueOf(userArray.get(0)[1])); UserDto userDto = UserDto.builder().name(String.valueOf(userArray.get(0)[0])).build(); System.out.println(userDto);&#125; å…¶å®žç»éªŒçš„ä¸°å¯Œçš„â€œè€å¸æœºâ€ä¸€çœ‹å°±çŸ¥é“è¿™è‚¯å®šä¸æ˜¯æœ€ä½³å®žè·µï¼Œè¿™å¤šéº»çƒ¦å‘€ï¼Œè‚¯å®šä¼šæœ‰æ›´ä¼˜è§£ã€‚é‚£ä¹ˆæˆ‘ä»¬å†å¯¹æ­¤ç¨åŠ æ”¹é€ ï¼Œç”¨ UserDto æŽ¥æ”¶è¿”å›žç»“æžœã€‚ åˆ©ç”¨ class UserDto èŽ·å–æˆ‘ä»¬æƒ³è¦çš„ç»“æžœé¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª UserDto ç±»çš„å†…å®¹ã€‚ 1234567891011package com.example.jpa.example1;import lombok.AllArgsConstructor;import lombok.Builder;import lombok.Data;@Data@Builder@AllArgsConstructorpublic class UserDto &#123; private String name,email,idCard;&#125; å…¶æ¬¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹åˆ©ç”¨ @Query åœ¨ Repository é‡Œé¢æ€Žä¹ˆå†™ã€‚ 123456public interface UserDtoRepository extends JpaRepository&lt;User, Long&gt; &#123; @Query("select new com.example.jpa.example1.UserDto(CONCAT(u.name,'JK123'),u.email,e.idCard) from User u,UserExtend e where u.id= e.userId and u.id=:id") UserDto findByUserDtoId(@Param("id") Long id);&#125; æˆ‘ä»¬åˆ©ç”¨ JPQLï¼Œnew äº†ä¸€ä¸ª UserDtoï¼›å†é€šè¿‡æž„é€ æ–¹æ³•ï¼ŒæŽ¥æ”¶æŸ¥è¯¢ç»“æžœã€‚å…¶ä¸­ä½ ä¼šå‘çŽ°ï¼Œæˆ‘ä»¬ç”¨ CONCAT çš„å…³é”®å­—åšäº†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æŽ¥ã€‚ ä½ å¯ä»¥æŸ¥çœ‹JPQLçš„ Oracle æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æºç æ¥çœ‹æ”¯æŒçš„å…³é”®å­—æœ‰å“ªäº›ã€‚ æ‰“å¼€ ParameterizedFunctionExpression ä¼šå‘çŽ° Hibernate æ”¯æŒçš„å…³é”®å­—æœ‰è¿™ä¹ˆå¤šï¼Œéƒ½æ˜¯ MySQL æ•°æ®åº“çš„æŸ¥è¯¢å…³é”®å­—ã€‚ ç„¶åŽï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ä¸Šé¢çš„æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ã€‚ 123456789101112131415@Testpublic void testQueryAnnotationDto() &#123; userDtoRepository.save( User.builder().name("jack").email("123456@126.com") .sex("man").address("shanghai").build()); userExtendRepository.save( UserExtend.builder() .userId(1L) .idCard("shengfengzhenghao") .ages(18) .studentNumber("xuehao001") .build()); UserDto userDto = userDtoRepository.findByUserDtoId(1L); System.out.println(userDto);&#125; æœ€åŽï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œç»“æžœå¦‚ä¸‹ã€‚è¿™æ—¶ä½ ä¼šå‘çŽ°ï¼Œæˆ‘ä»¬æŒ‰ç…§é¢„æœŸæ“ä½œå¾—åˆ°äº† UserDto çš„ç»“æžœã€‚ 1234Hibernate: insert into user (address, email, name, sex, version, id) values (?, ?, ?, ?, ?, ?)Hibernate: insert into user_extend (ages, id_card, student_number, user_id, id) values (?, ?, ?, ?, ?)Hibernate: select (user0_.name||'JK123') as col_0_0_, user0_.email as col_1_0_, userextend1_.id_card as col_2_0_ from user user0_ cross join user_extend userextend1_ where user0_.id=userextend1_.user_id and user0_.id=?UserDto(name=jackJK123, email=123456@126.com, idCard=shengfengzhenghao) é‚£ä¹ˆè¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ï¼Œä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ UserDto æŽ¥å£æ¥å®žçŽ°ä¸€ä¸‹ã€‚ åˆ©ç”¨ UserDto æŽ¥å£èŽ·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æžœé¦–å…ˆï¼Œæ–°å¢žä¸€ä¸ª UserSimpleDto æŽ¥å£æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ nameã€emailã€idCard ä¿¡æ¯ã€‚ 1234567package com.example.jpa.example1;public interface UserSimpleDto &#123; String getName(); String getEmail(); String getIdCard();&#125; å…¶æ¬¡ï¼Œåœ¨ UserDtoRepository é‡Œé¢æ–°å¢žä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›žç»“æžœæ˜¯ UserSimpleDto æŽ¥å£ã€‚ 123456public interface UserDtoRepository extends JpaRepository&lt;User, Long&gt; &#123;//åˆ©ç”¨æŽ¥å£DTOèŽ·å¾—è¿”å›žç»“æžœï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ¯ä¸ªå­—æ®µéœ€è¦aså’ŒæŽ¥å£é‡Œé¢çš„getæ–¹æ³•åå­—ä¿æŒä¸€æ ·@Query("select CONCAT(u.name,'JK123') as name,UPPER(u.email) as email ,e.idCard as idCard from User u,UserExtend e where u.id= e.userId and u.id=:id")UserSimpleDto findByUserSimpleDtoId(@Param("id") Long id);&#125; ç„¶åŽï¼Œæµ‹è¯•ç”¨ä¾‹å†™æ³•å¦‚ä¸‹ã€‚ 12345678910111213141516@Test public void testQueryAnnotationDto() &#123; userDtoRepository.save( User.builder().name("jack").email("123456@126.com") .sex("man").address("shanghai").build()); userExtendRepository.save( UserExtend.builder() .userId(1L) .idCard("shengfengzhenghao") .ages(18) .studentNumber("xuehao001") .build()); UserSimpleDto userDto = userDtoRepository.findByUserSimpleDtoId(1L); System.out.println(userDto); System.out.println(userDto.getName() + ":" + userDto.getEmail() + ":" + userDto.getIdCard()); &#125; æœ€åŽï¼Œæˆ‘ä»¬æ‰§è¡Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æžœã€‚ 12org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@373c28e5jackJK123:123456@126.COM:shengfengzhenghao æˆ‘ä»¬å‘çŽ°ï¼Œæ¯”èµ· DTO æˆ‘ä»¬ä¸éœ€è¦ new äº†ï¼Œå¹¶ä¸”æŽ¥å£åªèƒ½è¯»ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿”å›žçš„ç»“æžœ DTO çš„èŒè´£å°±æ›´å•ä¸€äº†ï¼Œåªç”¨æ¥æŸ¥è¯¢ã€‚ æŽ¥å£çš„æ–¹å¼æ˜¯æ¯”è¾ƒæŽ¨èçš„åšæ³•ï¼Œå› ä¸ºå®ƒæ˜¯åªè¯»çš„ï¼Œå¯¹æž„é€ æ–¹æ³•æ²¡æœ‰è¦æ±‚ï¼Œè¿”å›žçš„å®žé™…æ˜¯ HashMapã€‚ @Query åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¥äº†è§£ä¸€ä¸‹å¦‚ä½•å®žçŽ° @Query çš„åŠ¨æ€å‚æ•°æŸ¥è¯¢ã€‚ é¦–å…ˆï¼Œæ–°å¢žä¸€ä¸ª UserOnlyName æŽ¥å£ï¼ŒåªæŸ¥è¯¢ User é‡Œé¢çš„ name å’Œ email å­—æ®µã€‚ 1234567package com.example.jpa.example1;//èŽ·å¾—è¿”å›žç»“æžœpublic interface UserOnlyName &#123; String getName(); String getEmail();&#125; å…¶æ¬¡ï¼Œåœ¨æˆ‘ä»¬çš„ UserDtoRepository é‡Œé¢æ–°å¢žä¸¤ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªæ˜¯åˆ©ç”¨ JPQL å®žçŽ°åŠ¨æ€æŸ¥è¯¢ï¼Œä¸€ä¸ªæ˜¯åˆ©ç”¨åŽŸå§‹ SQL å®žçŽ°åŠ¨æ€æŸ¥è¯¢ã€‚ 12345678910111213141516171819202122232425package com.example.jpa.example1;import org.springframework.data.jpa.repository.JpaRepository;import org.springframework.data.jpa.repository.Query;import org.springframework.data.repository.query.Param;import java.util.List;public interface UserDtoRepository extends JpaRepository&lt;User, Long&gt; &#123; /** * åˆ©ç”¨JQPlåŠ¨æ€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ * @param name * @param email * @return UserSimpleDtoæŽ¥å£ */ @Query("select u.name as name,u.email as email from User u where (:name is null or u.name =:name) and (:email is null or u.email =:email)") UserOnlyName findByUser(@Param("name") String name,@Param("email") String email); /** * åˆ©ç”¨åŽŸå§‹sqlåŠ¨æ€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ * @param user * @return */@Query(value = "select u.name as name,u.email as email from user u where (:#&#123;#user.name&#125; is null or u.name =:#&#123;#user.name&#125;) and (:#&#123;#user.email&#125; is null or u.email =:#&#123;#user.email&#125;)",nativeQuery = true)UserOnlyName findByUser(@Param("user") User user); ç„¶åŽï¼Œæˆ‘ä»¬æ–°å¢žä¸€ä¸ªæµ‹è¯•ç±»ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸Šé¢æ–¹æ³•çš„ç»“æžœã€‚ 12345678910@Testpublic void testQueryDinamicDto() &#123;userDtoRepository.save(User.builder().name("jack").email("123456@126.com").sex("man").address("shanghai").build()); UserOnlyName userDto = userDtoRepository.findByUser("jack", null); System.out.println(userDto.getName() + ":" + userDto.getEmail()); UserOnlyName userDto2 = userDtoRepository.findByUser(User.builder().email("123456@126.com").build()); System.out.println(userDto2.getName() + ":" + userDto2.getEmail());&#125; æœ€åŽï¼Œè¿è¡Œç»“æžœå¦‚ä¸‹ã€‚ 1234567891011121314151617181920Hibernate: insert into user (address, email, name, sex, version, id) values (?, ?, ?, ?, ?, ?) : binding parameter [1] as [VARCHAR] - [shanghai] : binding parameter [2] as [VARCHAR] - [123456@126.com] : binding parameter [3] as [VARCHAR] - [jack] : binding parameter [4] as [VARCHAR] - [man] : binding parameter [5] as [BIGINT] - [0] : binding parameter [6] as [BIGINT] - [1]Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where (? is null or user0_.name=?) and (? is null or user0_.email=?) : binding parameter [1] as [VARCHAR] - [jack] : binding parameter [2] as [VARCHAR] - [jack] : binding parameter [3] as [VARCHAR] - [null] : binding parameter [4] as [VARCHAR] - [null]jack:123456@126.comHibernate: select u.name as name,u.email as email from user u where (? is null or u.name =?) and (? is null or u.email =?) : binding parameter [1] as [VARBINARY] - [null] : binding parameter [2] as [VARBINARY] - [null] : binding parameter [3] as [VARCHAR] - [123456@126.com] : binding parameter [4] as [VARCHAR] - [123456@126.com]jack:123456@126.com æ³¨æ„ï¼šå…¶ä¸­æˆ‘ä»¬æ‰“å°äº†ä¸€ä¸‹ SQL ä¼ å…¥çš„å‚æ•°ï¼Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬æ›´æ¸…æ¥šå‚æ•°éƒ½ä¼ å…¥äº†ä»€ä¹ˆå€¼ã€‚ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«é‡‡ç”¨äº† JPQL çš„åŠ¨æ€å‚æ•°å’Œ SPEL çš„è¡¨è¾¾å¼æ–¹å¼èŽ·å–å‚æ•° é€šè¿‡ä¸Šé¢çš„å®žä¾‹å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† :email is null or s.email = :email è¿™ç§æ–¹å¼æ¥å®žçŽ°åŠ¨æ€æŸ¥è¯¢çš„æ•ˆæžœï¼Œå®žé™…å·¥ä½œä¸­ä¹Ÿå¯èƒ½æ¼”å˜å¾—å¾ˆå¤æ‚ã€‚ èƒ½ç”¨æ–¹æ³•åè¡¨ç¤ºçš„ï¼Œå°½é‡ç”¨æ–¹æ³•åè¡¨ç¤ºï¼Œå› ä¸ºè¿™æ ·è¯­ä¹‰æ¸…æ™°ã€ç®€å•å¿«é€Ÿï¼ŒåŸºæœ¬ä¸Šåªè¦ç¼–è¯‘é€šè¿‡ï¼Œä¸€å®šä¸ä¼šæœ‰é—®é¢˜ï¼› èƒ½ç”¨ @Query é‡Œé¢çš„ JPQL è¡¨ç¤ºçš„ï¼Œå°±ç”¨ JPQLï¼Œè¿™æ ·ä¸Ž SQL æ— å…³ï¼Œä¸‡ä¸€å“ªå¤©æ¢æ•°æ®åº“äº†ï¼ŒåŸºæœ¬ä¸Šä»£ç ä¸ç”¨æ”¹å˜ï¼› æœ€åŽå®žåœ¨æ²¡æœ‰åŠžæ³•äº†ï¼Œå¯ä»¥é€‰æ‹© nativeQuery å†™åŽŸå§‹ SQLï¼Œç‰¹åˆ«æ˜¯ä¸€å¼€å§‹ä»Ž MyBatis è½¬è¿‡æ¥çš„åŒå­¦ï¼Œé€‰æ‹©å†™ SQL ä¼šæ›´å®¹æ˜“ä¸€äº›ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Defining Query Methods</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data Jpa DataSource åŠ è½½è¿‡ç¨‹]]></title>
    <url>%2F2020%2F10%2F14%2FSpringDataJpa%E7%9A%84DataSource%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%2F</url>
    <content type="text"><![CDATA[DataSource ä¸ºä½•ç‰©ï¼ŸåŠ è½½è¿‡ç¨‹æ˜¯æ€Žæ ·çš„ï¼Ÿæ•°æ®æºæ˜¯ä»€ä¹ˆï¼Ÿå½“æˆ‘ä»¬ç”¨ç¬¬ä¸‰æ–¹å·¥å…·åŽ»è¿žæŽ¥æ•°æ®åº“ï¼ˆMysqlï¼ŒOracle ç­‰ï¼‰çš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½ä¼šè®©æˆ‘ä»¬é€‰æ‹©æ•°æ®æºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä»¥ MySQL ä¸ºä¾‹ï¼Œå½“é€‰æ‹© MySQL çš„æ—¶å€™å°±ä¼šå¼¹å‡ºå¦‚ä¸‹å›¾æ˜¾ç¤ºçš„ç•Œé¢ï¼š å…¶ä¸­ï¼Œæˆ‘ä»¬åœ¨é€‰æ‹©äº† Driverï¼ˆé©±åŠ¨ï¼‰å’Œ Hostã€Userã€Password ç­‰ä¹‹åŽï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ª Connectionï¼Œç„¶åŽè¿žæŽ¥åˆ°æ•°æ®åº“é‡Œé¢äº†ã€‚ åŒæ ·çš„é“ç†ï¼Œåœ¨ Java é‡Œé¢æˆ‘ä»¬ä¹Ÿéœ€è¦ç”¨åˆ° DataSource åŽ»è¿žæŽ¥æ•°æ®åº“ï¼Œè€Œ Java å®šä¹‰äº†ä¸€å¥— JDBC çš„åè®®æ ‡å‡†ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª javax.sql.DataSource æŽ¥å£ç±»ï¼Œé€šè¿‡å®žçŽ°æ­¤ç±»å°±å¯ä»¥è¿›è¡Œæ•°æ®åº“è¿žæŽ¥ï¼Œæˆ‘ä»¬é€šè¿‡æºç æ¥åˆ†æžä¸€ä¸‹ã€‚ DataSource æºç åˆ†æžDataSource æŽ¥å£é‡Œé¢ä¸»è¦çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š 1234public interface DataSource extends CommonDataSource, Wrapper &#123; Connection getConnection() throws SQLException; Connection getConnection(String username, String password) throws SQLException;&#125; æˆ‘ä»¬é€šè¿‡æºç å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ°ï¼ŒDataSource çš„ä¸»è¦ç›®çš„å°±æ˜¯èŽ·å¾—æ•°æ®åº“è¿žæŽ¥ï¼Œå°±åƒæˆ‘ä»¬å‰é¢ç”¨å·¥å…·è¿žæŽ¥æ•°æ®åº“ä¸€æ ·ï¼Œåªä¸è¿‡å·¥å…·æ˜¯é€šè¿‡ç•Œé¢å®žçŽ°çš„ï¼Œè€Œ DataSource æ˜¯é€šè¿‡ä»£ç å®žçŽ°çš„ã€‚ é‚£ä¹ˆåœ¨ç¨‹åºé‡Œé¢å¦‚ä½•å®žçŽ°å‘¢ï¼Ÿä¹Ÿæœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹çš„å®žçŽ°æ–¹å¼ï¼Œå¸¸è§çš„æœ‰C3P0ã€BBCPã€Proxoolã€Druidã€Hikariï¼Œè€Œç›®å‰ Spring Boot é‡Œé¢æ˜¯é‡‡ç”¨ Hikari ä½œä¸ºé»˜è®¤æ•°æ®æºã€‚Hikari çš„ä¼˜ç‚¹æ˜¯ï¼šå¼€æºï¼Œç¤¾åŒºæ´»è·ƒï¼Œæ€§èƒ½é«˜ï¼Œç›‘æŽ§å®Œæ•´ã€‚æˆ‘ä»¬é€šè¿‡å·¥å…·çœ‹ä¸€ä¸‹é¡¹ç›®é‡Œé¢DataSource çš„å®žçŽ°ç±»æœ‰å“ªäº›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å…¶ä¸­ï¼Œå½“é‡‡ç”¨é»˜è®¤æ•°æ®æºçš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®æºçš„å®žçŽ°ç±»æœ‰ï¼š h2 é‡Œé¢çš„ JdbcDataSource MySQL è¿žæŽ¥é‡Œé¢çš„ MysqlDataSource HikariDataSourceï¼ˆé»˜è®¤æ•°æ®æºï¼Œä¹Ÿæ˜¯ Spring ç¤¾åŒºæŽ¨èçš„æœ€ä½³æ•°æ®æºï¼‰ ç›´æŽ¥æ‰“å¼€ HikariDataSource çš„æºç çœ‹ä¸€ä¸‹ï¼Œå®ƒçš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class HikariDataSource extends HikariConfig implements DataSource, Closeable&#123; private volatile HikariPool pool; public HikariDataSource(HikariConfig configuration) &#123; configuration.validate(); configuration.copyStateTo(this); LOGGER.info("&#123;&#125; - Starting...", configuration.getPoolName()); pool = fastPathPool = new HikariPool(this); LOGGER.info("&#123;&#125; - Start completed.", configuration.getPoolName()); this.seal(); &#125; //è¿™ä¸ªæ˜¯æœ€ä¸»è¦çš„å®žçŽ°é€»è¾‘ï¼Œå³é€šè¿‡è¿žæŽ¥æ± èŽ·å¾—è¿žæŽ¥çš„é€»è¾‘ public Connection getConnection() throws SQLException&#123; if (isClosed()) &#123; throw new SQLException("HikariDataSource " + this + " has been closed."); &#125; if (fastPathPool != null) &#123; return fastPathPool.getConnection(); &#125; // See http://en.wikipedia.org/wiki/Double-checked_locking#Usage_in_Java HikariPool result = pool; if (result == null) &#123; synchronized (this) &#123; result = pool; if (result == null) &#123; validate(); LOGGER.info("&#123;&#125; - Starting...", getPoolName()); try &#123; pool = result = new HikariPool(this); this.seal(); &#125; catch (PoolInitializationException pie) &#123; if (pie.getCause() instanceof SQLException) &#123; throw (SQLException) pie.getCause(); &#125; else &#123; throw pie; &#125; &#125; LOGGER.info("&#123;&#125; - Start completed.", getPoolName()); &#125; &#125; &#125; return result.getConnection(); &#125;......&#125; ä»Žä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°å…³é”®çš„ä¸¤ç‚¹é—®é¢˜ï¼š æ•°æ®æºçš„å…³é”®é…ç½®å±žæ€§æœ‰å“ªäº›ï¼Ÿ è¿žæŽ¥æ€Žä¹ˆèŽ·å¾—ï¼Ÿè¿žæŽ¥æ± çš„ä½œç”¨å¦‚ä½•ï¼Ÿ Hikari æ•°æ®æºçš„å…³é”®é…ç½®å±žæ€§æœ‰å“ªäº›ï¼Ÿç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒHikariConfig çš„é…ç½®é‡Œé¢æè¿°äº† Hikari æ•°æ®æºä¸»è¦çš„é…ç½®å±žæ€§ï¼Œæˆ‘ä»¬æ‰“å¼€æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š é€šè¿‡ä¸Šé¢çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°æ®æºçš„å…³é”®é…ç½®ä¿¡æ¯ï¼šç”¨æˆ·åã€å¯†ç ã€è¿žæŽ¥æ± çš„é…ç½®ã€jdbcUrlã€é©±åŠ¨çš„åå­—ç­‰ç­‰ Hikari æ•°æ®æºçš„è¿žæŽ¥æ€Žä¹ˆèŽ·å¾—ä¸Šé¢æåˆ°çš„ç¬¬ 2 ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡ getConnection æ–¹æ³•é‡Œé¢çš„ä»£ç å¯ä»¥çœ‹åˆ° HikariPool çš„ç”¨æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯é€šè¿‡è¿žæŽ¥æ± æ¥èŽ·å¾—è¿žæŽ¥çš„ï¼Œè¿™ä¸ªè¿žæŽ¥ç”¨è¿‡ä¹‹åŽæ²¡æœ‰æ–­å¼€ï¼Œè€Œæ˜¯é‡æ–°æ”¾å›žåˆ°è¿žæŽ¥æ± é‡Œé¢ï¼ˆè¿™ä¸ªåœ°æ–¹ä½ ä¸€å®šè¦è°¨è®°ï¼Œå®ƒä¹Ÿè¯´æ˜Žäº† connection æ˜¯å¯ä»¥å…±äº«çš„ï¼‰ã€‚ è¿žæŽ¥æ± çš„ç”¨é€”ï¼š åˆ›å»ºè¿žæŽ¥æ˜¯éžå¸¸æ˜‚è´µçš„ï¼Œè¿žæŽ¥æ± æŠ€æœ¯å¯ä»¥å…±äº«çŽ°æœ‰çš„è¿žæŽ¥ï¼Œä»¥å¢žåŠ ä»£ç çš„æ‰§è¡Œæ•ˆçŽ‡ã€‚ æ•°æ®æºã€é©±åŠ¨ã€è¿žæŽ¥ã€è¿žæŽ¥æ± çš„å…³ç³» æ•°æ®æºï¼ˆDataSourceï¼‰çš„ä½œç”¨æ˜¯ç»™åº”ç”¨ç¨‹åºæä¾›ä¸åŒ DB çš„è¿žæŽ¥ connectionï¼› è¿žæŽ¥ï¼ˆConnectionï¼‰æ˜¯é€šè¿‡è¿žæŽ¥æ± ï¼ˆPoolï¼‰èŽ·å–çš„ï¼Œè¿™ä¸»è¦æ˜¯å‡ºäºŽè¿žæŽ¥æ€§èƒ½çš„è€ƒè™‘ï¼› åˆ›å»ºå¥½è¿žæŽ¥ä¹‹åŽï¼Œé€šè¿‡æ•°æ®åº“çš„é©±åŠ¨ï¼ˆDriverï¼‰æ¥è¿›è¡Œæ•°æ®åº“æ“ä½œï¼› è€Œä¸åŒçš„ DBï¼ˆMySQL / H2 / Oracleï¼‰ï¼Œéƒ½æœ‰è‡ªå·±çš„é©±åŠ¨ç±»å’Œç›¸åº”çš„é©±åŠ¨ Jar åŒ…ã€‚ ç”¨ä¸€ä¸ªå›¾æ¥è¡¨ç¤ºä¸€ä¸‹ï¼š è€Œæˆ‘ä»¬å¸¸è¯´çš„ MySQL é©±åŠ¨ï¼Œå…¶å®žå°±æ˜¯ com.mysql.cj.jdbc.Driverï¼Œè€Œè¿™ä¸ªç±»ä¸»è¦å­˜åœ¨äºŽ mysql-connection-java:8.0* çš„ jar é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„ä¸åŒçš„æ•°æ®åº“æ‰€ä»£è¡¨çš„é©±åŠ¨ jar åŒ…ã€‚ è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯ spring boot 2.3.3 ç‰ˆæœ¬å¼•ç”¨çš„ mysql-connection-java 8.0 ç‰ˆæœ¬é©±åŠ¨ jar åŒ…ï¼Œä¸åŒçš„æ•°æ®åº“å¼•ç”¨çš„ jar åŒ…æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼ŒH2 æ•°æ®æºä¸­ï¼Œæˆ‘ä»¬ç”¨çš„é©±åŠ¨ç±»æ˜¯ org.h2.Driverï¼Œå…¶åŒ…å«åœ¨ com.h2database:h2:1.4.*jar åŒ…é‡Œé¢ã€‚ æ•°æ®æºçš„åŠ è½½åŽŸç†å’Œè¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ spring.factories æ–‡ä»¶å¯ä»¥çœ‹åˆ° JDBC æ•°æ®æºç›¸å…³çš„è‡ªåŠ¨åŠ è½½çš„ç±» DataSourceAutoConfigurationï¼Œé‚£ä¹ˆå°±ä»Žè¿™ä¸ªç±»å¼€å§‹åˆ†æžã€‚ DataSourceAutoConfiguration æ•°æ®æºçš„åŠ è½½è¿‡ç¨‹åˆ†æžDataSourceAutoConfiguration çš„å…³é”®æºç å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819202122//å°†spring.datasource.**çš„é…ç½®æ”¾åˆ°DataSourcePropertieså¯¹è±¡é‡Œé¢ï¼›@EnableConfigurationProperties(DataSourceProperties.class)@Import(&#123; DataSourcePoolMetadataProvidersConfiguration.class, DataSourceInitializationConfiguration.class &#125;)public class DataSourceAutoConfiguration &#123; //é»˜è®¤é›†æˆçš„æ•°æ®æºï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯H2ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¿«é€Ÿå¯åŠ¨å’Œä¸Šæ‰‹ï¼Œä¸€èˆ¬ä¸åœ¨ç”Ÿäº§çŽ¯å¢ƒåº”ç”¨ï¼› @Configuration(proxyBeanMethods = false) @Conditional(EmbeddedDatabaseCondition.class) @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;) @Import(EmbeddedDataSourceConfiguration.class) protected static class EmbeddedDatabaseConfiguration &#123; &#125; //åŠ è½½ä¸åŒçš„æ•°æ®æºçš„é…ç½® @Configuration(proxyBeanMethods = false) @Conditional(PooledDataSourceCondition.class) @ConditionalOnMissingBean(&#123; DataSource.class, XADataSource.class &#125;) @Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class &#125;) protected static class PooledDataSourceConfiguration &#123; &#125; ....&#125; ä»Žæºç ä¸­æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸‰ç‚¹æœ€å…³é”®çš„ä¿¡æ¯ï¼šç¬¬ä¸€ï¼Œé€šè¿‡ @EnableConfigurationProperties(DataSourceProperties.class) å¯ä»¥çœ‹å¾—å‡ºæ¥ spring.datasource çš„é…ç½®é¡¹æœ‰å“ªäº› DataSourceProperties å…³é”®ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930@ConfigurationProperties(prefix = "spring.datasource")public class DataSourceProperties implements BeanClassLoaderAware, InitializingBean &#123; private ClassLoader classLoader; private String name; private boolean generateUniqueName = true; private Class&lt;? extends DataSource&gt; type; private String driverClassName; private String url; private String username; private String password; //è®¡ç®—ç¡®å®š driverName çš„å€¼æ˜¯ä»€ä¹ˆ public String determineDriverClassName() &#123; if (StringUtils.hasText(this.driverClassName)) &#123; Assert.state(driverClassIsLoadable(), () -&gt; "Cannot load driver class: " + this.driverClassName); return this.driverClassName; &#125; String driverClassName = null; //æ­¤æ®µé€»è¾‘æ˜¯ï¼Œå½“æˆ‘ä»¬æ²¡æœ‰é…ç½®è‡ªå·±çš„ driverName çš„æ—¶å€™ï¼Œå®ƒä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„ DB çš„ urlè‡ªåŠ¨è®¡ç®—å‡ºæ¥ driverName çš„å€¼æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥å°±ä¼šå‘çŽ°æˆ‘ä»¬çŽ°åœ¨å¾ˆå¤š datasource é‡Œé¢çš„é…ç½®éƒ½çœåŽ»äº† driver-name çš„é…ç½®ï¼Œè¿™æ˜¯ Spring Boot çš„åŠŸåŠ³ã€‚ if (StringUtils.hasText(this.url)) &#123; driverClassName = DatabaseDriver.fromJdbcUrl(this.url).getDriverClassName(); &#125; if (!StringUtils.hasText(driverClassName)) &#123; driverClassName = this.embeddedDatabaseConnection.getDriverClassName(); &#125; if (!StringUtils.hasText(driverClassName)) &#123; throw new DataSourceBeanCreationException("Failed to determine a suitable driver class", this, this.embeddedDatabaseConnection); &#125; return driverClassName;&#125; æˆ‘ä»¬é€šè¿‡ DatabaseDriver çš„æºç å¯ä»¥çœ‹åˆ° MySQL çš„é»˜è®¤é©±åŠ¨ Spring Boot æ˜¯é‡‡ç”¨ com.mysql.cj.jdbc.Driver æ¥å®žçŽ°çš„ã€‚ åŒæ—¶ï¼Œ@ConfigurationProperties(prefix = &quot;spring.datasource&quot;) ä¹Ÿå‘Šè¯‰æˆ‘ä»¬ï¼Œapplication.properties é‡Œé¢çš„ datasource ç›¸å…³çš„å…¬å…±é…ç½®å¯ä»¥ä»¥ spring.datasource ä¸ºå¼€å¤´ï¼Œè¿™æ ·å½“å¯åŠ¨çš„æ—¶å€™ï¼ŒDataSourceProperties å°±ä¼šå°† datasource çš„ä¸€åˆ‡é…ç½®è‡ªåŠ¨åŠ è½½è¿›æ¥ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢åœ¨ application.properties é‡Œé¢çš„é…ç½®çš„ä¸€æ ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™é‡Œæœ‰ urlã€usernameã€passwordã€driver-class-name ç­‰å…³é”®é…ç½®ï¼Œä¸åŒæ•°æ®æºçš„å…¬å…±é…ç½®ä¹Ÿä¸å¤šã€‚ ç¬¬äºŒï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™ä¸€æ®µä»£ç ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ä¸åŒçš„æ•°æ®æºçš„é…ç½®æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ 123456@Import(&#123; DataSourceConfiguration.Hikari.class, DataSourceConfiguration.Tomcat.class, DataSourceConfiguration.Dbcp2.class, DataSourceConfiguration.Generic.class, DataSourceJmxConfiguration.class &#125;) æ‰“å¼€ DataSourceConfiguration çš„æºç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162abstract class DataSourceConfiguration &#123; @SuppressWarnings("unchecked") protected static &lt;T&gt; T createDataSource(DataSourceProperties properties, Class&lt;? extends DataSource&gt; type) &#123; return (T) properties.initializeDataSourceBuilder().type(type).build(); &#125; /** * Tomcatè¿žæŽ¥æ± æ•°æ®æºçš„é…ç½®ï¼Œå‰ææ¡ä»¶éœ€è¦å¼•å…¥tomcat-jdbc*.jar */ @Configuration(proxyBeanMethods = false) @ConditionalOnClass(org.apache.tomcat.jdbc.pool.DataSource.class) @ConditionalOnMissingBean(DataSource.class) @ConditionalOnProperty(name = "spring.datasource.type", havingValue = "org.apache.tomcat.jdbc.pool.DataSource", matchIfMissing = true) static class Tomcat &#123; @Bean @ConfigurationProperties(prefix = "spring.datasource.tomcat") org.apache.tomcat.jdbc.pool.DataSource dataSource(DataSourceProperties properties) &#123; org.apache.tomcat.jdbc.pool.DataSource dataSource = createDataSource(properties, org.apache.tomcat.jdbc.pool.DataSource.class); DatabaseDriver databaseDriver = DatabaseDriver.fromJdbcUrl(properties.determineUrl()); String validationQuery = databaseDriver.getValidationQuery(); if (validationQuery != null) &#123; dataSource.setTestOnBorrow(true); dataSource.setValidationQuery(validationQuery); &#125; return dataSource; &#125; &#125; /** * Hikariæ•°æ®æºçš„é…ç½®ï¼Œé»˜è®¤Spring BootåŠ è½½çš„æ˜¯Hikariæ•°æ®æº */ @Configuration(proxyBeanMethods = false) @ConditionalOnClass(HikariDataSource.class) @ConditionalOnMissingBean(DataSource.class) @ConditionalOnProperty(name = "spring.datasource.type", havingValue = "com.zaxxer.hikari.HikariDataSource", matchIfMissing = true) static class Hikari &#123; @Bean @ConfigurationProperties(prefix = "spring.datasource.hikari") HikariDataSource dataSource(DataSourceProperties properties) &#123; HikariDataSource dataSource = createDataSource(properties, HikariDataSource.class); if (StringUtils.hasText(properties.getName())) &#123; dataSource.setPoolName(properties.getName()); &#125; return dataSource; &#125; &#125; /** * DBCPæ•°æ®æºçš„é…ç½®ï¼ŒæŒ‰ç…§Spring Bootçš„è¯­æ³•ï¼Œæˆ‘ä»¬å¿…é¡»å¼•å…¥CommonsDbcp**.jarä¾èµ–æ‰æœ‰ç”¨ */ @Configuration(proxyBeanMethods = false) @ConditionalOnClass(org.apache.commons.dbcp2.BasicDataSource.class) @ConditionalOnMissingBean(DataSource.class) @ConditionalOnProperty(name = "spring.datasource.type", havingValue = "org.apache.commons.dbcp2.BasicDataSource", matchIfMissing = true) static class Dbcp2 &#123; @Bean @ConfigurationProperties(prefix = "spring.datasource.dbcp2") org.apache.commons.dbcp2.BasicDataSource dataSource(DataSourceProperties properties) &#123; return createDataSource(properties, org.apache.commons.dbcp2.BasicDataSource.class); &#125; &#125; é€šè¿‡ä¸Šè¿°æºç å¯ä»¥çœ‹åˆ°æœ€å¸¸è§çš„ä¸‰ç§æ•°æ®æºçš„é…ç½®ï¼š HikariDataSource tomcatçš„JDBC apacheçš„dbcp è€Œæœ€ç»ˆç”¨å“ªä¸ªï¼Œå°±çœ‹ä½ å¼•ç”¨äº†å“ªä¸ª dataSource çš„ jar åŒ…ã€‚ä¸è¿‡ Spring Boot 2.0 ä¹‹åŽå°±æŽ¨èä½¿ç”¨ Hikari æ•°æ®æºäº†ã€‚ ç¬¬ä¸‰ï¼Œé€šè¿‡ @ConfigurationProperties(prefix = &quot;spring.datasource.hikari&quot;) å’Œ HikariDataSource dataSource(DataSourceProperties properties) å¯ä»¥çŸ¥é“ï¼Œapplication.properties é‡Œé¢ spring.datasource.hikari å¼€å¤´çš„é…ç½®ä¼šè¢«æ˜ å°„åˆ° HikariDataSource å¯¹è±¡ä¸­ï¼Œ HikariDataSource ç»§æ‰¿äº† HikariConfigã€‚ æ‰€ä»¥é¡ºç†æˆç« åœ°ï¼Œå°±å¯ä»¥çŸ¥é“ Hikari æ•°æ®æºçš„é…ç½®æœ‰å“ªäº›äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š Hikari çš„é…ç½®æ¯”è¾ƒå¤šï¼Œä½ å®žé™…å·¥ä½œä¸­æƒ³è¦äº†è§£è¯¦ç»†é…ç½®ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ è¿™é‡Œåªè¯´ä¸€ä¸‹æœ€éœ€è¦å…³å¿ƒçš„é…ç½®ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªï¼š 123456789101112131415## æœ€å°ç©ºé—²é“¾æŽ¥æ•°é‡spring.datasource.hikari.minimum-idle=5## ç©ºé—²é“¾æŽ¥å­˜æ´»æœ€å¤§æ—¶é—´ï¼Œé»˜è®¤600000ï¼ˆ10åˆ†é’Ÿï¼‰spring.datasource.hikari.idle-timeout=180000## é“¾æŽ¥æ± æœ€å¤§é“¾æŽ¥æ•°ï¼Œé»˜è®¤æ˜¯10spring.datasource.hikari.maximum-pool-size=10## æ­¤å±žæ€§æŽ§åˆ¶ä»Žæ± è¿”å›žçš„é“¾æŽ¥çš„é»˜è®¤è‡ªåŠ¨æäº¤è¡Œä¸º,é»˜è®¤å€¼ï¼štruespring.datasource.hikari.auto-commit=true## æ•°æ®æºé“¾æŽ¥æ± çš„åç§°spring.datasource.hikari.pool-name=MyHikariCP## æ­¤å±žæ€§æŽ§åˆ¶æ± ä¸­é“¾æŽ¥çš„æœ€é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå€¼0è¡¨ç¤ºæ— é™ç”Ÿå‘½å‘¨æœŸï¼Œé»˜è®¤1800000å³30åˆ†é’Ÿspring.datasource.hikari.max-lifetime=1800000## æ•°æ®åº“é“¾æŽ¥è¶…æ—¶æ—¶é—´,é»˜è®¤30ç§’ï¼Œå³30000spring.datasource.hikari.connection-timeout=30000spring.datasource.hikari.connection-test-query=SELECT 1mysql è¿™é‡Œä»‹ç»çš„ä¸»è¦æ˜¯é’ˆå¯¹è¿žæŽ¥æ± çš„é…ç½®ï¼Œè¿žæŽ¥æ± æˆ‘ä»¬ä¸èƒ½é…ç½®å¾—å¤ªå¤§ï¼Œå› ä¸ºè¿žæŽ¥æ± å¤ªå¤§çš„è¯ï¼Œä¼šæœ‰é¢å¤–çš„ CPU å¼€é”€ï¼Œå¤„ç†è¿žæŽ¥æ± çš„çº¿ç¨‹åˆ‡æ¢åè€Œä¼šå¢žåŠ ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ï¼Œå‡ä½Žæ€§èƒ½ï¼›ç›¸åº”çš„ï¼Œè¿žæŽ¥æ± ä¹Ÿä¸èƒ½é…ç½®å¤ªå°ï¼Œå¤ªå°çš„è¯å¯èƒ½ä¼šå¢žåŠ è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ï¼Œä¹Ÿä¼šé™ä½Žä¸šåŠ¡å¤„ç†çš„åžåé‡ã€‚ Hikari æ•°æ®æºä¸‹çš„ MySQL é…ç½®æœ€ä½³å®žè·µ1234567891011121314151617181920##æ•°æ®æºçš„é…ç½®ï¼šlogger=Slf4JLogger&amp;profileSQL=trueæ˜¯ç”¨æ¥debugæ˜¾ç¤ºsqlçš„æ‰§è¡Œæ—¥å¿—çš„spring.datasource.url=jdbc:mysql://localhost:3306/test?logger=Slf4JLogger&amp;profileSQL=truespring.datasource.username=rootspring.datasource.password=E6kroWaR9F##é‡‡ç”¨é»˜è®¤çš„#spring.datasource.hikari.connectionTimeout=30000#spring.datasource.hikari.idleTimeout=300000##æŒ‡å®šä¸€ä¸ªé“¾æŽ¥æ± çš„åå­—ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ†æžçº¿ç¨‹é—®é¢˜spring.datasource.hikari.pool-name=jpa-hikari-pool##æœ€é•¿ç”Ÿå‘½å‘¨æœŸ15åˆ†é’Ÿå¤Ÿäº†spring.datasource.hikari.maxLifetime=900000spring.datasource.hikari.maximumPoolSize=8##æœ€å¤§å’Œæœ€å°ç›¸å¯¹åº”å‡å°‘åˆ›å»ºçº¿ç¨‹æ± çš„æ¶ˆè€—ï¼›spring.datasource.hikari.minimumIdle=8spring.datasource.hikari.connectionTestQuery=select 1 from dual##å½“é‡Šæ”¾è¿žæŽ¥åˆ°è¿žæŽ¥æ± ä¹‹åŽï¼Œé‡‡ç”¨é»˜è®¤çš„è‡ªåŠ¨æäº¤äº‹åŠ¡spring.datasource.hikari.autoCommit=true##ç”¨æ¥æ˜¾ç¤ºé“¾æŽ¥æµ‹traceæ—¥å¿—logging.level.com.zaxxer.hikari.HikariConfig=DEBUG logging.level.com.zaxxer.hikari=TRACE é€šè¿‡ä¸Šé¢çš„æ—¥å¿—é…ç½®ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™å¯ä»¥çœ‹åˆ°è¿žæŽ¥æ± çš„é…ç½®ç»“æžœå’Œ MySQL çš„æ‰§è¡Œæ—¥å¿—ï¼š å¦‚ä¸‹æ—¥å¿—ï¼Œæ˜¾ç¤ºäº† Hikari çš„ config é…ç½®ã€‚ å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œåˆ°åº•è¦åœ¨ä¸€ä¸ª MySQL çš„ connection ä¸Šé¢æ‰§è¡Œå“ªäº› SQL å‘¢ï¼Ÿé€šè¿‡å¦‚ä¸‹æ—¥å¿—æˆ‘ä»¬å¯ä»¥çœ‹å¾—å‡ºæ¥ã€‚ é€šè¿‡å¼€å¯ com.zaxxer.hikari.pool.HikariPool ç±»çš„ debug çº§åˆ«ï¼Œå¯ä»¥å®žæ—¶çœ‹åˆ°è¿žæŽ¥æ± çš„ä½¿ç”¨æƒ…å†µï¼šè½¯ä»¶æ—¥å¿—å¦‚ä¸‹ï¼ˆä¸Šå›¾ä¹Ÿæœ‰ä½“çŽ°ï¼‰ï¼š 1com.zaxxer.hikari.pool.HikariPool : jpa-hikari-pool - Pool stats (total=8, active=1, idle=7, waiting=0) é€šè¿‡ä¸Šé¢çš„ç›‘æŽ§æ—¥å¿—ï¼Œä½ åœ¨å®žé™…å·¥ä½œä¸­å¯ä»¥æ ¹æ®ä¸»æœºçš„ CPU æƒ…å†µå’Œä¸šåŠ¡å¤„ç†çš„è€—æ—¶æƒ…å†µï¼Œå†å¯¹è¿žæŽ¥æ± åšé€‚å½“çš„è°ƒæ•´ï¼Œä½†æ˜¯æ³¨æ„å·®è·ä¸è¦å¤ªå¤§ï¼Œä¸è¦ä¸€ä¸‹å°†è¿žæŽ¥æ± é…ç½®å‡ ç™¾ä¸ªï¼Œé‚£æ˜¯é”™è¯¯çš„é…ç½®ã€‚ Hikari æ•°æ®é€šè¿‡ Prometheus çš„ç›‘æŽ§æŒ‡æ ‡åº”ç”¨å°±åƒæ—¥å¿—é‡Œé¢æ‰“å°çš„ä¸€æ · 1com.zaxxer.hikari.pool.HikariPool : jpa-hikari-pool - Pool stats (total=8, active=0, idle=8, waiting=0) Hikari çš„ Metric ä¹Ÿå¸®æˆ‘ä»¬æä¾›äº† Prometheus çš„ç›‘æŽ§æŒ‡æ ‡ï¼Œå®žçŽ°æ–¹æ³•å¾ˆç®€å•ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š gradle ä¾èµ–é‡Œé¢æ·»åŠ  1implementation &apos;io.micrometer:micrometer-registry-prometheus&apos; application.properties é‡Œé¢æ·»åŠ  12345#Metrics related configurationsmanagement.endpoint.metrics.enabled=truemanagement.endpoints.web.exposure.include=*management.endpoint.prometheus.enabled=truemanagement.metrics.export.prometheus.enabled=true ç„¶åŽæˆ‘ä»¬å¯åŠ¨é¡¹ç›®ï¼Œé€šè¿‡ä¸‹å›¾ä¸­çš„åœ°å€å°±å¯ä»¥çœ‹åˆ°ï¼ŒPrometheus çš„ Metrics é‡Œé¢å¤šäº†å¾ˆå¤š HikariCP çš„æŒ‡æ ‡ã€‚ å½“çœ‹åˆ°è¿™äº›æŒ‡æ ‡ä¹‹åŽï¼Œå°±å¯ä»¥æ ¹æ® Grafana ç¤¾åŒºé‡Œé¢æä¾›çš„ HikariCP çš„ç›‘æŽ§ Dashboards çš„é…ç½®æ–‡æ¡£åœ°å€ï¼Œå¯¼å…¥åˆ°æˆ‘ä»¬è‡ªå·±çš„ Grafana é‡Œé¢ï¼Œå¯ä»¥é€šè¿‡å›¾è¡¨çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š é€šè¿‡è¿™ç§æ ‡å‡†çš„æ¨¡æ¿å°±å¯ä»¥çŸ¥é“ JDBC çš„è¿žæŽ¥æƒ…å†µã€Hikari çš„è¿žæŽ¥æƒ…å†µï¼Œä»¥åŠæ¯ä¸ªè¿žæŽ¥è¯·æ±‚æ—¶é—´ã€ä½¿ç”¨æ—¶é—´ã€‚è¿™æ ·å¯¹è¯Šæ–­ DB æ€§èƒ½é—®é¢˜éžå¸¸æœ‰å¸®åŠ©ã€‚ ä¸‹é¢å¯¹å…¶ä¸­ä¸€äº›å…³é”®æŒ‡æ ‡ä½œä¸€ä¸‹è¯´æ˜Žï¼š totalConnectionsï¼šæ€»è¿žæŽ¥æ•°ï¼ŒåŒ…æ‹¬ç©ºé—²çš„è¿žæŽ¥å’Œä½¿ç”¨ä¸­çš„è¿žæŽ¥ï¼Œå³ totalConnections = activeConnection + idleConnectionsï¼› idleConnectionsï¼šç©ºé—²è¿žæŽ¥æ•°ï¼Œä¹Ÿå«å¯ç”¨è¿žæŽ¥æ•°ï¼Œä¹Ÿå°±æ˜¯è¿žæŽ¥æ± é‡Œé¢çŽ°æˆçš„ DB è¿žæŽ¥æ•°ï¼› activeConnectionsï¼šæ´»è·ƒè¿žæŽ¥æ•°ï¼Œéžä¸šåŠ¡ç¹å¿™æœŸä¸€èˆ¬éƒ½æ˜¯ 0ï¼Œå¾ˆå¿«å°±ä¼šé‡Šæ”¾åˆ°è¿žæŽ¥æ± é‡Œé¢åŽ»ï¼› pendingThreadsï¼šæ­£åœ¨ç­‰å¾…è¿žæŽ¥çš„çº¿ç¨‹æ•°é‡ã€‚æŽ’æŸ¥æ€§èƒ½é—®é¢˜æ—¶ï¼Œè¿™ä¸ªæŒ‡æ ‡æ˜¯ä¸€ä¸ªé‡è¦çš„å‚è€ƒæŒ‡æ ‡ï¼Œå¦‚æžœæ­£åœ¨ç­‰å¾…è¿žæŽ¥çš„çº¿ç¨‹åœ¨ç›¸å½“é•¿ä¸€æ®µæ—¶é—´å†…æ•°é‡è¾ƒå¤šï¼Œè¯´æ˜Žæˆ‘ä»¬çš„è¿žæŽ¥æ²¡æœ‰åˆ©ç”¨å¥½ï¼Œæ˜¯ä¸æ˜¯å ç”¨è¿žæŽ¥çš„æ—¶é—´è¿‡é•¿äº†ï¼Ÿä¸€æ—¦æœ‰ pendingThreads çš„æ•°é‡äº†å¯ä»¥å‘ä¸ªå‘Šè­¦ï¼ŒæŸ¥æŸ¥åŽŸå› ï¼Œæˆ–è€…ä¼˜åŒ–ä¸€ä¸‹è¿žæŽ¥æ± ï¼› maxConnectionsï¼šæœ€å¤§è¿žæŽ¥æ•°ï¼Œç»Ÿè®¡æŒ‡æ ‡ï¼Œç»Ÿè®¡åˆ°ç›®å‰ä¸ºæ­¢è¿žæŽ¥çš„æœ€å¤§æ•°é‡ã€‚ minConnectionsï¼šæœ€å°è¿žæŽ¥æ•°ï¼Œç»Ÿè®¡æŒ‡æ ‡ï¼Œç»Ÿè®¡åˆ°ç›®å‰ä¸ºæ­¢è¿žæŽ¥çš„æœ€å°æ•°é‡ã€‚ usageTimeï¼šæ¯ä¸ªè¿žæŽ¥ä½¿ç”¨çš„æ—¶é—´ï¼Œå½“è¿žæŽ¥è¢«å›žæ”¶çš„æ—¶å€™ä¼šè®°å½•æ­¤æŒ‡æ ‡ï¼›ä¸€èˆ¬éƒ½åœ¨ mã€s çº§åˆ«ï¼Œä¸€æ—¦åˆ° s çº§åˆ«äº†å¯ä»¥å‘ä¸ªå‘Šè­¦ï¼› acquireTimeï¼šèŽ·å–æ¯ä¸ªè¿žæŽ¥éœ€è¦ç­‰å¾…æ—¶é—´ï¼Œä¸€ä¸ªè¯·æ±‚èŽ·å–æ•°æ®åº“è¿žæŽ¥åŽæˆ–è€…å› ä¸ºè¶…æ—¶å¤±è´¥åŽï¼Œä¼šè®°å½•æ­¤æŒ‡æ ‡ã€‚ connectionCreateTimeï¼šè¿žæŽ¥åˆ›å»ºæ—¶é—´ã€‚ åœ¨ Grafana å›¾è¡¨æˆ–è€… Prometheus é‡Œé¢éƒ½å¯ä»¥é…ç½®ä¸€äº›é‚®ä»¶æˆ–è€…çŸ­ä¿¡ç­‰å‘Šè­¦ï¼Œè¿™æ ·å½“æˆ‘ä»¬ DB è¿žæŽ¥æ± å‘ç”Ÿé—®é¢˜çš„æ—¶å€™å°±èƒ½å®žæ—¶çŸ¥é“ã€‚ æ„Ÿå…´è¶£å¯ä»¥ç ”ç©¶ä¸€ä¸‹ Prometheus Operatorã€‚ AliDruidDataSource çš„é…ç½®ä¸Žä»‹ç»åœ¨å®žé™…å·¥ä½œä¸­ï¼Œç”±äºŽ HikariCP å’Œ Druid å„æœ‰åƒç§‹ï¼Œå›½å†…çš„å¾ˆå¤šå¼€å‘è€…éƒ½ä½¿ç”¨ AliDruid ä½œä¸ºæ•°æ®æºã€‚ ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ Gradle ä¾èµ–1implementation &apos;com.alibaba:druid-spring-boot-starter:1.2.1&apos; ç¬¬äºŒæ­¥ï¼šé…ç½®æ•°æ®æº1234spring.datasource.druid.url= # æˆ–spring.datasource.url= spring.datasource.druid.username= # æˆ–spring.datasource.username=spring.datasource.druid.password= # æˆ–spring.datasource.password=spring.datasource.druid.driver-class-name= #æˆ– spring.datasource.driver-class-name= ç¬¬ä¸‰æ­¥ï¼šé…ç½®è¿žæŽ¥æ± 1234567891011121314151617spring.datasource.druid.initial-size=spring.datasource.druid.max-active=spring.datasource.druid.min-idle=spring.datasource.druid.max-wait=spring.datasource.druid.pool-prepared-statements=spring.datasource.druid.max-pool-prepared-statement-per-connection-size= spring.datasource.druid.max-open-prepared-statements= #å’Œä¸Šé¢çš„ç­‰ä»·spring.datasource.druid.validation-query=spring.datasource.druid.validation-query-timeout=spring.datasource.druid.test-on-borrow=spring.datasource.druid.test-on-return=spring.datasource.druid.test-while-idle=spring.datasource.druid.time-between-eviction-runs-millis=spring.datasource.druid.min-evictable-idle-time-millis=spring.datasource.druid.max-evictable-idle-time-millis=spring.datasource.druid.filters= #é…ç½®å¤šä¸ªè‹±æ–‡é€—å·åˆ†éš”....//more é€šè¿‡ä»¥ä¸Šä¸‰æ­¥å°±å¯ä»¥å®Œæˆ Druid æ•°æ®æºçš„é…ç½®äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ HikariCP æ•°æ®æºç»™æŽ’é™¤æŽ‰ï¼Œè€Œå…¶ä»– Druid çš„é…ç½®ï¼Œæ¯”å¦‚ç›‘æŽ§ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ å…¶å®˜æ–¹çš„æºç ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒæŒ‰ç…§ä¸Šé¢åˆ†æž HikariCP æ•°æ®æºçš„æ–¹æ³•ï¼Œå¯ä»¥æ‰¾ä¸€ä¸‹ aliDruid çš„æºç ï¼Œå…¶åŠ è½½çš„å…¥å£ç±»ï¼Œä¸€æ­¥ä¸€æ­¥åŽ»æŸ¥çœ‹å³å¯ã€‚ Naming å‘½åç­–ç•¥è¯¦è§£åŠå…¶å®žè·µåœ¨é…ç½® @Entity æ—¶ï¼Œä¸€å®šä¼šå¥½å¥‡è¡¨åã€å­—æ®µåã€å¤–é”®åã€å®žä½“å­—æ®µã€@Column å’Œæ•°æ®åº“çš„å­—æ®µä¹‹é—´ï¼Œæ˜ å°„å…³ç³»æ˜¯æ€Žä¹ˆæ ·çš„ï¼Ÿé»˜è®¤è§„åˆ™æ˜ å°„è§„åˆ™åˆæ˜¯ä»€ä¹ˆï¼Ÿå¦‚æžœå’Œé»˜è®¤ä¸ä¸€æ ·è¯¥æ€Žä¹ˆæ‰©å±•ï¼Ÿ Hibernate 5 çš„å‘½åç­–ç•¥Hibernate 5 é‡Œé¢æŠŠå®žä½“å’Œæ•°æ®åº“çš„å­—æ®µåå’Œè¡¨åçš„æ˜ å°„åˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤ ç¬¬ä¸€æ­¥ï¼šé€šè¿‡ImplicitNamingStrategyå…ˆæ‰¾åˆ°å®žä¾‹é‡Œé¢å®šä¹‰çš„é€»è¾‘çš„å­—æ®µåå­—ã€‚ è¿™æ˜¯é€šè¿‡ImplicitNamingStrategy çš„å®žçŽ°ç±»æŒ‡å®šé€»è¾‘å­—æ®µæŸ¥æ‰¾ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å½“å®žä½“é‡Œé¢å®šä¹‰äº† @Tableã€@Column æ³¨è§£çš„æ—¶å€™ï¼Œä»¥æ³¨è§£æŒ‡å®šåå­—è¿”å›žï¼›è€Œå½“æ²¡æœ‰è¿™äº›æ³¨è§£çš„æ—¶å€™ï¼Œè¿”å›žçš„æ˜¯å®žä½“é‡Œé¢çš„å­—æ®µçš„åå­—ã€‚ å…¶ä¸­ï¼Œorg.hibernate.boot.model.naming.ImplicitNamingStrategy æ˜¯ä¸€ä¸ªæŽ¥å£ï¼ŒImplicitNamingStrategyJpaCompliantImpl è¿™ä¸ªå®žçŽ°ç±»å…¼å®¹ JPA 2.0 çš„å­—æ®µæ˜ å°„è§„èŒƒã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦‚ä¸‹å››ä¸ªå®žçŽ°ç±»ï¼š ImplicitNamingStrategyLegacyHbmImplï¼šå…¼å®¹ Hibernate è€ç‰ˆæœ¬ä¸­çš„å‘½åè§„èŒƒï¼› ImplicitNamingStrategyLegacyJpaImplï¼šå…¼å®¹ JPA 1.0 è§„èŒƒä¸­çš„å‘½åè§„èŒƒï¼› ImplicitNamingStrategyComponentPathImplï¼š@Embedded ç­‰æ³¨è§£æ ‡å¿—çš„ç»„ä»¶å¤„ç†æ˜¯é€šè¿‡ attributePath å®Œæˆçš„ï¼Œå› æ­¤å¦‚æžœæˆ‘ä»¬åœ¨ä½¿ç”¨ @Embedded æ³¨è§£çš„æ—¶å€™ï¼Œå¦‚æžœè¦æŒ‡å®šå‘½åè§„èŒƒï¼Œå¯ä»¥ç›´æŽ¥ç»§æ‰¿è¿™ä¸ªç±»æ¥å®žçŽ°ï¼› SpringImplicitNamingStrategyï¼šé»˜è®¤çš„ spring data 2.2.3 çš„ç­–ç•¥ï¼Œåªæ˜¯æ‰©å±•äº† ImplicitNamingStrategyJpaCompliantImpl é‡Œé¢çš„ JoinTableName çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™é‡Œåªéœ€è¦å…³å¿ƒ SpringImplicitNamingStrategy å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„åŸºæœ¬ä¸Šç”¨ä¸åˆ°ã€‚ SpringImplicitNamingStrategy æ•ˆæžœå¦‚ä½•å‘¢ï¼Ÿä»£ç å¦‚ä¸‹ï¼š 1234567891011@Entity@Table(name = "userInfo")public class UserInfo extends BaseEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private Integer ages; private String lastName; @Column(name = "myAddress") private String emailAddress;&#125; é€šè¿‡ç¬¬ä¸€æ­¥å¯ä»¥å¾—åˆ°å¦‚ä¸‹é€»è¾‘å­—æ®µçš„æ˜ å°„ç»“æžœï¼š 12345UserInfo -&gt; userInfoid-&gt;idages-&gt;ageslastName -&gt; lastNameemailAddress -&gt; myAddress ç¬¬äºŒæ­¥ï¼šé€šè¿‡ PhysicalNamingStrategy å°†é€»è¾‘å­—æ®µè½¬åŒ–æˆæ•°æ®åº“çš„ç‰©ç†å­—æ®µåå­—ã€‚ å®ƒçš„å®žçŽ°ç±»è´Ÿè´£å°†é€»è¾‘å­—æ®µè½¬åŒ–æˆå¸¦ä¸‹åˆ’çº¿ï¼Œæˆ–è€…ç»Ÿä¸€ç»™å­—æ®µåŠ ä¸Šå‰ç¼€ï¼Œåˆæˆ–è€…åŠ ä¸ŠåŒå¼•å·ç­‰æ ¼å¼çš„æ•°æ®åº“å­—æ®µåå­—ï¼Œå…¶ä¸»è¦çš„æŽ¥å£æ˜¯ï¼šorg.hibernate.boot.model.naming.PhysicalNamingStrategyï¼Œè€Œå®ƒçš„å®žçŽ°ç±»ä¹Ÿåªæœ‰ä¸¤ä¸ªï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š PhysicalNamingStrategyStandardImplï¼šè¿™ä¸ªç±»ä»€ä¹ˆéƒ½æ²¡å¹²ï¼Œå³ç›´æŽ¥å°†ç¬¬ä¸€ä¸ªæ­¥éª¤å¾—åˆ°çš„é€»è¾‘å­—æ®µåå­—å½“æˆæ•°æ®åº“çš„å­—æ®µåå­—ä½¿ç”¨ã€‚è¿™ä¸ªä¸»è¦çš„åº”ç”¨åœºæ™¯æ˜¯ï¼Œå¦‚æžœæŸäº›å­—æ®µçš„å‘½åæ ¼å¼ä¸æ˜¯ä¸‹åˆ’çº¿çš„æ ¼å¼ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡ @Column çš„æ–¹å¼æ˜¾ç¤ºå£°æ˜Žçš„è¯ï¼Œå¯ä»¥æŠŠé»˜è®¤ç¬¬äºŒæ­¥çš„ç­–ç•¥æ”¹æˆ PhysicalNamingStrategyStandardImplã€‚é‚£ä¹ˆå¦‚æžœå†å¥—ç”¨ç¬¬ä¸€æ­¥çš„ä¾‹å­ï¼Œç»è¿‡è¿™ä¸ªç±»çš„è½¬åŒ–ä¼šå˜æˆå¦‚ä¸‹å½¢å¼ï¼š 12345userInfo -&gt; userInfoid-&gt;idages-&gt;ageslastName -&gt; lastNamemyAddress -&gt; myAddress å¯ä»¥çœ‹å‡ºæ¥é€»è¾‘åå­—åˆ°ç‰©ç†åå­—æ˜¯ä¿æŒä¸å˜çš„ã€‚ SpringPhysicalNamingStrategyï¼šè¿™ä¸ªç±»æ˜¯å°†ç¬¬ä¸€æ­¥å¾—åˆ°çš„é€»è¾‘å­—æ®µåå­—çš„å¤§å†™å­—æ¯å‰é¢åŠ ä¸Šä¸‹åˆ’çº¿ï¼Œå¹¶ä¸”å…¨éƒ¨è½¬åŒ–æˆå°å†™ï¼Œå°†ä¼šæ ‡è¯†å‡ºæ˜¯å¦éœ€è¦åŠ ä¸ŠåŒå¼•å·ã€‚æ­¤ç§æ˜¯é»˜è®¤ç­–ç•¥ã€‚æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œç¬¬ä¸€æ­¥å¾—åˆ°çš„é€»è¾‘å­—æ®µå°±ä¼šå˜æˆå¦‚ä¸‹æ˜ å°„ï¼š 12345userInfo -&gt; user_infoid-&gt;idages-&gt;ageslastName -&gt; last_namemyAddress -&gt; my_address æŠŠåˆšæ‰çš„å®žä½“æ‰§è¡Œä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„è¡¨çš„ç»“æž„å¦‚ä¸‹ï¼š 1Hibernate: create table user_info (id bigint not null, create_time timestamp, create_user_id integer, last_modified_time timestamp, last_modified_user_id integer, version integer, ages integer, my_address varchar(255), last_name varchar(255), telephone varchar(255), primary key (id))ï¼› ä¹Ÿå¯ä»¥é€šè¿‡åœ¨ SpringPhysicalNamingStrategy ç±»é‡Œé¢è®¾ç½®æ–­ç‚¹æ¥éªŒè¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åŠ è½½åŽŸç†ä¸Žè‡ªå®šä¹‰æ–¹æ³•ä¿®æ”¹é»˜è®¤ç­–ç•¥ï¼Œåªéœ€è¦åœ¨ application.properties é‡Œé¢ä¿®æ”¹ä¸‹é¢ä»£ç æ‰€ç¤ºçš„ä¸¤ä¸ªé…ç½®ï¼Œæ¢æˆè‡ªå·±çš„è‡ªå®šä¹‰çš„ç±»å³å¯ã€‚ 12spring.jpa.hibernate.naming.implicit-strategy=org.springframework.boot.orm.jpa.hibernate.SpringImplicitNamingStrategyspring.jpa.hibernate.naming.physical-strategy=org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy å¦‚æžœç›´æŽ¥æœç´¢ï¼šspring.jpa.hibernate å°±ä¼šå‘çŽ°ï¼Œå…¶é»˜è®¤é…ç½®æ˜¯åœ¨ org.springframework.boot.autoconfigure.orm.jpa.HibernateProerties è¿™ç±»é‡Œé¢çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ–¹æ³•ä¸­è¿›è¡ŒåŠ è½½ã€‚ å…¶ä¸­ï¼ŒIMPLICIT_NAMING_STRATEGY å’Œ PHYSICAL_NAMING_STRATEGY çš„å€¼å¦‚ä¸‹è¿°ä»£ç æ‰€ç¤ºï¼Œå®ƒæ˜¯ Hibernate 5 çš„é…ç½®å˜é‡ï¼Œç”¨æ¥æ”¹å˜ Hibernateçš„ naming çš„ç­–ç•¥ã€‚ 12String IMPLICIT_NAMING_STRATEGY = &quot;hibernate.implicit_naming_strategy&quot;;String PHYSICAL_NAMING_STRATEGY = &quot;hibernate.physical_naming_strategy&quot;; å¦‚æžœè‡ªå®šä¹‰çš„è¯ï¼Œç›´æŽ¥ç»§æ‰¿ SpringPhysicalNamingStrategy è¿™ä¸ªç±»ï¼Œç„¶åŽè¦†ç›–éœ€è¦å®žçŽ°çš„æ–¹æ³•å³å¯ã€‚é‚£ä¹ˆå®ƒå®žé™…çš„åº”ç”¨åœºæ™¯éƒ½æœ‰å“ªäº›å‘¢ï¼Ÿ è‡ªå®šä¹‰çš„å®žé™…åº”ç”¨åœºæ™¯æœ‰æ—¶å€™æˆ‘ä»¬æŽ¥è§¦åˆ°çš„ç³»ç»Ÿå¯èƒ½æ˜¯è€ç³»ç»Ÿï¼Œè¡¨å’Œå­—æ®µçš„å‘½åè§„èŒƒä¸ä¸€å®šæ˜¯ä¸‹åˆ’çº¿å½¢å¼ï¼Œæœ‰å¯èƒ½é©¼å³°å¼çš„å‘½åæ³•ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸åŒçš„ä¸šåŠ¡æœ‰ä¸åŒçš„è¡¨åå‰ç¼€ã€‚ä¸ç®¡æ˜¯å“ªä¸€ç§ï¼Œéƒ½å¯ä»¥é€šè¿‡ä¿®æ”¹ç¬¬äºŒé˜¶æ®µï¼šç‰©ç†æ˜ å°„çš„ç­–ç•¥ï¼Œæ”¹æˆ PhysicalNamingStrategyStandardImpl çš„å½¢å¼ 1spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl è¿™æ ·å¯ä»¥ä½¿ @Column/@Table ç­‰æ³¨è§£çš„è‡ªå®šä¹‰å€¼ç”Ÿæ•ˆï¼Œæˆ–è€…æ”¹æˆè‡ªå®šä¹‰çš„ MyPhysicalNamingStrategyã€‚ä¸è¿‡ä¸å»ºè®®ä¿®æ”¹ implicit-strategyï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦ï¼Œéœ€åªè¦åœ¨ physical-strategy ä¸Šåšæ–‡ç« å°±è¶³å¤Ÿäº†ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>DataSource</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç¼“å­˜çš„åŽŸç†ã€å¼•å…¥ä¸Žè®¾è®¡]]></title>
    <url>%2F2020%2F10%2F14%2F%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98-%E7%BC%93%E5%AD%98%E7%9A%84%E5%8E%9F%E7%90%86%E3%80%81%E5%BC%95%E5%85%A5%E4%B8%8E%E8%AE%BE%E8%AE%A1%2F</url>
    <content type="text"><![CDATA[ç¼“å­˜çš„åŽŸç†ã€å¼•å…¥ä¸Žè®¾è®¡ä¸šåŠ¡æ•°æ®è®¿é—®æ€§èƒ½å¤ªä½Žæ€Žä¹ˆåŠž ç¼“å­˜çš„åŸºæœ¬æ€æƒ³ ç¼“å­˜çš„ä¼˜ç‚¹ ç¼“å­˜çš„ä»£ä»· ç¼“å­˜çš„å®šä¹‰ ç¼“å­˜æœ€åˆçš„å«ä¹‰ï¼Œæ˜¯æŒ‡ç”¨äºŽåŠ é€Ÿ CPU æ•°æ®äº¤æ¢çš„ RAMï¼Œå³éšæœºå­˜å–å­˜å‚¨å™¨ï¼Œé€šå¸¸è¿™ç§å­˜å‚¨å™¨ä½¿ç”¨æ›´æ˜‚è´µä½†å¿«é€Ÿçš„é™æ€ RAMï¼ˆSRAMï¼‰æŠ€æœ¯ï¼Œç”¨ä»¥å¯¹ DRAM è¿›è¡ŒåŠ é€Ÿã€‚è¿™æ˜¯ä¸€ä¸ªç‹­ä¹‰ç¼“å­˜çš„å®šä¹‰ã€‚ è€Œå¹¿ä¹‰ç¼“å­˜çš„å®šä¹‰åˆ™æ›´å®½æ³›ï¼Œä»»ä½•å¯ä»¥ç”¨äºŽæ•°æ®é«˜é€Ÿäº¤æ¢çš„å­˜å‚¨ä»‹è´¨éƒ½æ˜¯ç¼“å­˜ï¼Œå¯ä»¥æ˜¯ç¡¬ä»¶ä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶ã€‚ ç¼“å­˜å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯é€šè¿‡å¼€è¾Ÿä¸€ä¸ªæ–°çš„æ•°æ®äº¤æ¢ç¼“å†²åŒºï¼Œæ¥è§£å†³åŽŸå§‹æ•°æ®èŽ·å–ä»£ä»·å¤ªå¤§çš„é—®é¢˜ï¼Œè®©æ•°æ®å¾—åˆ°æ›´å¿«çš„è®¿é—®ã€‚ç›®å‰è®²çš„ç¼“å­˜ä¸»è¦æ˜¯æŒ‡å¹¿ä¹‰ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯äº’è”ç½‘äº§å“å¤§é‡ä½¿ç”¨çš„å„ç§ç¼“å­˜ç»„ä»¶å’ŒæŠ€æœ¯ã€‚ ç¼“å­˜åŽŸç†ç¼“å­˜çš„åŸºæœ¬æ€æƒ³ ç¼“å­˜æž„å»ºçš„åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨æ—¶é—´å±€é™æ€§åŽŸç†ï¼Œé€šè¿‡ç©ºé—´æ¢æ—¶é—´æ¥è¾¾åˆ°åŠ é€Ÿæ•°æ®èŽ·å–çš„ç›®çš„ï¼ŒåŒæ—¶ç”±äºŽç¼“å­˜ç©ºé—´çš„æˆæœ¬è¾ƒé«˜ï¼Œåœ¨å®žé™…è®¾è®¡æž¶æž„ä¸­è¿˜è¦è€ƒè™‘è®¿é—®å»¶è¿Ÿå’Œæˆæœ¬çš„æƒè¡¡é—®é¢˜ã€‚è¿™é‡Œé¢æœ‰ 3 ä¸ªå…³é”®ç‚¹ã€‚ æ—¶é—´å±€é™æ€§åŽŸç†ï¼Œå³è¢«èŽ·å–è¿‡ä¸€æ¬¡çš„æ•°æ®åœ¨æœªæ¥ä¼šè¢«å¤šæ¬¡å¼•ç”¨ï¼Œæ¯”å¦‚ä¸€æ¡å¾®åšè¢«ä¸€ä¸ªäººæ„Ÿå…´è¶£å¹¶é˜…è¯»åŽï¼Œå®ƒå¤§æ¦‚çŽ‡è¿˜ä¼šè¢«æ›´å¤šäººé˜…è¯»ï¼Œå½“ç„¶å¦‚æžœå˜æˆçƒ­é—¨å¾®åšåŽï¼Œä¼šè¢«æ•°ä»¥ç™¾ä¸‡/åƒä¸‡è®¡ç®—çš„æ›´å¤šç”¨æˆ·æŸ¥çœ‹ã€‚ ä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œå› ä¸ºåŽŸå§‹æ•°æ®èŽ·å–å¤ªæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€è¾Ÿä¸€å—é«˜é€Ÿç‹¬ç«‹ç©ºé—´ï¼Œæä¾›é«˜æ•ˆè®¿é—®ï¼Œæ¥è¾¾åˆ°æ•°æ®èŽ·å–åŠ é€Ÿçš„ç›®çš„ã€‚ æ€§èƒ½æˆæœ¬ Tradeoffï¼Œæž„å»ºç³»ç»Ÿæ—¶å¸Œæœ›ç³»ç»Ÿçš„è®¿é—®æ€§èƒ½è¶Šé«˜è¶Šå¥½ï¼Œè®¿é—®å»¶è¿Ÿè¶Šä½Žå°è¶Šå¥½ã€‚ä½†ç»´æŒç›¸åŒæ•°æ®è§„æ¨¡çš„å­˜å‚¨åŠè®¿é—®ï¼Œæ€§èƒ½è¶Šé«˜å»¶è¿Ÿè¶Šå°ï¼Œæˆæœ¬ä¹Ÿä¼šè¶Šé«˜ï¼Œæ‰€ä»¥åœ¨ç³»ç»Ÿæž¶æž„è®¾è®¡æ—¶ï¼Œä½ éœ€è¦åœ¨ç³»ç»Ÿæ€§èƒ½å’Œå¼€å‘è¿è¡Œæˆæœ¬ä¹‹é—´åšå–èˆã€‚æ¯”å¦‚å·¦è¾¹è¿™å¼ å›¾ï¼Œç›¸åŒæˆæœ¬çš„å®¹é‡ï¼ŒSSD ç¡¬ç›˜å®¹é‡ä¼šæ¯”å†…å­˜å¤§ 10ï½ž30 å€ä»¥ä¸Šï¼Œä½†è¯»å†™å»¶è¿Ÿå´é«˜ 50ï½ž100 å€ã€‚ ç¼“å­˜çš„ä¼˜åŠ¿ç¼“å­˜çš„ä¼˜åŠ¿ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š æå‡è®¿é—®æ€§èƒ½ é™ä½Žç½‘ç»œæ‹¥å µ å‡è½»æœåŠ¡è´Ÿè½½ å¢žå¼ºå¯æ‰©å±•æ€§ ç¼“å­˜å­˜å‚¨åŽŸå§‹æ•°æ®ï¼Œå¯ä»¥å¤§å¹…æå‡è®¿é—®æ€§èƒ½ã€‚ä¸è¿‡åœ¨å®žé™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œç¼“å­˜ä¸­å­˜å‚¨çš„å¾€å¾€æ˜¯éœ€è¦é¢‘ç¹è®¿é—®çš„ä¸­é—´æ•°æ®ç”šè‡³æœ€ç»ˆç»“æžœï¼Œè¿™äº›æ•°æ®ç›¸æ¯” DB ä¸­çš„åŽŸå§‹æ•°æ®å°å¾ˆå¤šï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ç½‘ç»œæµé‡ï¼Œé™ä½Žç½‘ç»œæ‹¥å µï¼ŒåŒæ—¶ç”±äºŽå‡å°‘äº†è§£æžå’Œè®¡ç®—ï¼Œè°ƒç”¨æ–¹å’Œå­˜å‚¨æœåŠ¡çš„è´Ÿè½½ä¹Ÿå¯ä»¥å¤§å¹…é™ä½Žã€‚ç¼“å­˜çš„è¯»å†™æ€§èƒ½å¾ˆé«˜ï¼Œé¢„çƒ­å¿«ï¼Œåœ¨æ•°æ®è®¿é—®å­˜åœ¨æ€§èƒ½ç“¶é¢ˆæˆ–é‡åˆ°çªå‘æµé‡ï¼Œç³»ç»Ÿè¯»å†™åŽ‹åŠ›å¤§å¢žæ—¶ï¼Œå¯ä»¥å¿«é€Ÿéƒ¨ç½²ä¸Šçº¿ï¼ŒåŒæ—¶åœ¨æµé‡ç¨³å®šåŽï¼Œä¹Ÿå¯ä»¥éšæ—¶ä¸‹çº¿ï¼Œä»Žè€Œä½¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å¤§å¤§å¢žå¼ºã€‚ ç¼“å­˜çš„ä»£ä»·ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œä»»ä½•äº‹æƒ…éƒ½æœ‰ä¸¤é¢æ€§ï¼Œç¼“å­˜ä¹Ÿä¸ä¾‹å¤–ï¼Œæˆ‘ä»¬åœ¨äº«å—ç¼“å­˜å¸¦æ¥ä¸€ç³»åˆ—å¥½å¤„çš„åŒæ—¶ï¼Œä¹Ÿæ³¨å®šéœ€è¦ä»˜å‡ºä¸€å®šçš„ä»£ä»·ã€‚ é¦–å…ˆï¼ŒæœåŠ¡ç³»ç»Ÿä¸­å¼•å…¥ç¼“å­˜ï¼Œä¼šå¢žåŠ ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚ å…¶æ¬¡ï¼Œç”±äºŽç¼“å­˜ç›¸æ¯”åŽŸå§‹ DB å­˜å‚¨çš„æˆæœ¬æ›´é«˜ï¼Œæ‰€ä»¥ç³»ç»Ÿéƒ¨ç½²åŠè¿è¡Œçš„è´¹ç”¨ä¹Ÿä¼šæ›´é«˜ã€‚ æœ€åŽï¼Œç”±äºŽä¸€ä»½æ•°æ®åŒæ—¶å­˜åœ¨ç¼“å­˜å’Œ DB ä¸­ï¼Œç”šè‡³ç¼“å­˜å†…éƒ¨ä¹Ÿä¼šæœ‰å¤šä¸ªæ•°æ®å‰¯æœ¬ï¼Œå¤šä»½æ•°æ®å°±ä¼šå­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŒæ—¶ç¼“å­˜ä½“ç³»æœ¬èº«ä¹Ÿä¼šå­˜åœ¨å¯ç”¨æ€§é—®é¢˜å’Œåˆ†åŒºçš„é—®é¢˜ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åŠ å¼ºå¯¹ç¼“å­˜åŽŸç†ã€ç¼“å­˜ç»„ä»¶ä»¥åŠä¼˜ç§€ç¼“å­˜ä½“ç³»å®žè·µçš„ç†è§£ï¼Œä»Žç³»ç»Ÿæž¶æž„ä¹‹åˆå°±å¯¹ç¼“å­˜è¿›è¡Œè‰¯å¥½è®¾è®¡ï¼Œé™ä½Žç¼“å­˜å¼•å…¥çš„å‰¯ä½œç”¨ï¼Œè®©ç¼“å­˜ä½“ç³»æˆä¸ºæœåŠ¡ç³»ç»Ÿé«˜æ•ˆç¨³å®šè¿è¡Œçš„å¼ºåŠ›åŸºçŸ³ã€‚ ä¸€èˆ¬æ¥è®²ï¼ŒæœåŠ¡ç³»ç»Ÿçš„å…¨é‡åŽŸå§‹æ•°æ®å­˜å‚¨åœ¨ DB ä¸­ï¼ˆå¦‚ MySQLã€HBase ç­‰ï¼‰ï¼Œæ‰€æœ‰æ•°æ®çš„è¯»å†™éƒ½å¯ä»¥é€šè¿‡ DB æ“ä½œæ¥èŽ·å–ã€‚ä½† DB è¯»å†™æ€§èƒ½ä½Žã€å»¶è¿Ÿé«˜ï¼Œå¦‚ MySQL å•å®žä¾‹çš„è¯»å†™ QPS é€šå¸¸åªæœ‰åƒçº§åˆ«ï¼ˆ3000ï½ž6000ï¼‰ï¼Œè¯»å†™å¹³å‡è€—æ—¶ 10ï½ž100ms çº§åˆ«ï¼Œå¦‚æžœä¸€ä¸ªç”¨æˆ·è¯·æ±‚éœ€è¦æŸ¥ 20 ä¸ªä¸åŒçš„æ•°æ®æ¥èšåˆï¼Œä»…ä»… DB è¯·æ±‚å°±éœ€è¦æ•°ç™¾æ¯«ç§’ç”šè‡³æ•°ç§’ã€‚è€Œ cache çš„è¯»å†™æ€§èƒ½æ­£å¥½å¯ä»¥å¼¥è¡¥ DB çš„ä¸è¶³ï¼Œæ¯”å¦‚ Memcached çš„è¯»å†™ QPS å¯ä»¥è¾¾åˆ° 10ï½ž100ä¸‡ çº§åˆ«ï¼Œè¯»å†™å¹³å‡è€—æ—¶åœ¨ 1ms ä»¥ä¸‹ï¼Œç»“åˆå¹¶å‘è®¿é—®æŠ€æœ¯ï¼Œå•ä¸ªè¯·æ±‚å³ä¾¿æŸ¥ä¸Šç™¾æ¡æ•°æ®ï¼Œä¹Ÿå¯ä»¥è½»æ¾åº”å¯¹ã€‚ ä½† cache å®¹é‡å°ï¼Œåªèƒ½å­˜å‚¨éƒ¨åˆ†è®¿é—®é¢‘ç¹çš„çƒ­æ•°æ®ï¼ŒåŒæ—¶ï¼ŒåŒä¸€ä»½æ•°æ®å¯èƒ½åŒæ—¶å­˜åœ¨ cache å’Œ DBï¼Œå¦‚æžœå¤„ç†ä¸å½“ï¼Œå°±ä¼šå‡ºçŽ°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚æ‰€ä»¥æœåŠ¡ç³»ç»Ÿåœ¨å¤„ç†ä¸šåŠ¡è¯·æ±‚æ—¶ï¼Œéœ€è¦å¯¹ cache çš„è¯»å†™æ–¹å¼è¿›è¡Œé€‚å½“è®¾è®¡ï¼Œæ—¢è¦ä¿è¯æ•°æ®é«˜æ•ˆè¿”å›žï¼Œåˆè¦å°½é‡é¿å…æ•°æ®ä¸ä¸€è‡´ç­‰å„ç§é—®é¢˜ã€‚ å¦‚ä½•æ ¹æ®ä¸šåŠ¡æ¥é€‰æ‹©ç¼“å­˜æ¨¡å¼å’Œç»„ä»¶ ç¼“å­˜çš„è¯»å†™æ¨¡å¼ ç¼“å­˜çš„åˆ†ç±» ç¼“å­˜è¯»å†™æ¨¡å¼å¦‚ä¸‹å›¾ï¼Œä¸šåŠ¡ç³»ç»Ÿè¯»å†™ç¼“å­˜æœ‰ 3 ç§æ¨¡å¼ï¼š Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ Read/Write Throughï¼ˆè¯»å†™ç©¿é€ï¼‰ Write Behind Cachingï¼ˆå¼‚æ­¥ç¼“å­˜å†™å…¥ï¼‰ Cache Aside å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒCache Aside æ¨¡å¼ä¸­ï¼Œä¸šåŠ¡åº”ç”¨æ–¹ å¯¹äºŽå†™ï¼Œæ˜¯æ›´æ–° DB åŽï¼Œç›´æŽ¥å°† key ä»Ž cache ä¸­åˆ é™¤ï¼Œç”± DB é©±åŠ¨ç¼“å­˜æ•°æ®çš„æ›´æ–° å¯¹äºŽè¯»ï¼Œæ˜¯å…ˆè¯» cacheï¼Œå¦‚æžœ cache missï¼Œåˆ™è¯» DBï¼ŒåŒæ—¶å°†æ•°æ®å›žå†™åˆ° cache è¿™ç§æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œä¸šåŠ¡ç«¯å¤„ç†æ‰€æœ‰æ•°æ®è®¿é—®ç»†èŠ‚ï¼ŒåŒæ—¶åˆ©ç”¨ Lazy è®¡ç®—çš„æ€æƒ³ï¼Œæ›´æ–° DB åŽï¼Œç›´æŽ¥åˆ é™¤ cache å¹¶é€šè¿‡ DB æ›´æ–°ï¼Œç¡®ä¿æ•°æ®ä»¥ DB ç»“æžœä¸ºå‡†ï¼Œåˆ™å¯ä»¥å¤§å¹…é™ä½Ž cache å’Œ DB ä¸­æ•°æ®ä¸ä¸€è‡´çš„æ¦‚çŽ‡ã€‚ å¦‚æžœæ²¡æœ‰ä¸“é—¨çš„å­˜å‚¨æœåŠ¡ï¼ŒåŒæ—¶æ˜¯å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„ä¸šåŠ¡ï¼Œæˆ–è€…æ˜¯ç¼“å­˜æ•°æ®æ›´æ–°æ¯”è¾ƒå¤æ‚çš„ä¸šåŠ¡ï¼Œè¿™äº›æƒ…å†µéƒ½æ¯”è¾ƒé€‚åˆä½¿ç”¨ Cache Aside æ¨¡å¼ã€‚å¦‚å¾®åšå‘å±•åˆæœŸï¼Œä¸å°‘ä¸šåŠ¡é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œè¿™äº›ç¼“å­˜æ•°æ®éœ€è¦é€šè¿‡å¤šä¸ªåŽŸå§‹æ•°æ®è¿›è¡Œè®¡ç®—åŽè®¾ç½®ã€‚åœ¨éƒ¨åˆ†æ•°æ®å˜æ›´åŽï¼Œç›´æŽ¥åˆ é™¤ç¼“å­˜ã€‚åŒæ—¶ï¼Œä½¿ç”¨ä¸€ä¸ª Trigger ç»„ä»¶ï¼Œå®žæ—¶è¯»å– DB çš„å˜æ›´æ—¥å¿—ï¼Œç„¶åŽé‡æ–°è®¡ç®—å¹¶æ›´æ–°ç¼“å­˜ã€‚å¦‚æžœè¯»ç¼“å­˜çš„æ—¶å€™ï¼ŒTrigger è¿˜æ²¡å†™å…¥ cacheï¼Œåˆ™ç”±è°ƒç”¨æ–¹è‡ªè¡Œåˆ° DB åŠ è½½è®¡ç®—å¹¶å†™å…¥ cacheã€‚ æ„Ÿè§‰ç›´æŽ¥ç”¨@Cacheableå’Œ@CachePutæ³¨è§£å°±åŸºæœ¬è¾¾åˆ°è¿™ä¸ªæ•ˆæžœ Read/Write Through å¦‚ä¸Šå›¾ï¼Œå¯¹äºŽ Cache Aside æ¨¡å¼ï¼Œä¸šåŠ¡åº”ç”¨éœ€è¦åŒæ—¶ç»´æŠ¤ cache å’Œ DB ä¸¤ä¸ªæ•°æ®å­˜å‚¨æ–¹ï¼Œè¿‡äºŽç¹çï¼ŒäºŽæ˜¯å°±æœ‰äº† Read/Write Through æ¨¡å¼ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸šåŠ¡åº”ç”¨åªå…³æ³¨ä¸€ä¸ªå­˜å‚¨æœåŠ¡å³å¯ï¼Œä¸šåŠ¡æ–¹çš„è¯»å†™ cache å’Œ DB çš„æ“ä½œï¼Œéƒ½ç”±å­˜å‚¨æœåŠ¡ä»£ç†ã€‚å­˜å‚¨æœåŠ¡æ”¶åˆ°ä¸šåŠ¡åº”ç”¨çš„å†™è¯·æ±‚æ—¶ï¼Œä¼šé¦–å…ˆæŸ¥ cacheï¼Œå¦‚æžœæ•°æ®åœ¨ cache ä¸­ä¸å­˜åœ¨ï¼Œåˆ™åªæ›´æ–° DBï¼Œå¦‚æžœæ•°æ®åœ¨ cache ä¸­å­˜åœ¨ï¼Œåˆ™å…ˆæ›´æ–° cacheï¼Œç„¶åŽæ›´æ–° DBã€‚è€Œå­˜å‚¨æœåŠ¡æ”¶åˆ°è¯»è¯·æ±‚æ—¶ï¼Œå¦‚æžœå‘½ä¸­ cache ç›´æŽ¥è¿”å›žï¼Œå¦åˆ™å…ˆä»Ž DB åŠ è½½ï¼Œå›žç§åˆ° cache åŽè¿”å›žå“åº”ã€‚( cache ä¸ºå‡†) è¿™ç§æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œå­˜å‚¨æœåŠ¡å°è£…äº†æ‰€æœ‰çš„æ•°æ®å¤„ç†ç»†èŠ‚ï¼Œä¸šåŠ¡åº”ç”¨ç«¯ä»£ç åªç”¨å…³æ³¨ä¸šåŠ¡é€»è¾‘æœ¬èº«ï¼Œç³»ç»Ÿçš„éš”ç¦»æ€§æ›´ä½³ã€‚å¦å¤–ï¼Œè¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå¦‚æžœ cache ä¸­æ²¡æœ‰æ•°æ®åˆ™ä¸æ›´æ–°ï¼Œæœ‰ç¼“å­˜æ•°æ®æ‰æ›´æ–°ï¼Œå†…å­˜æ•ˆçŽ‡æ›´é«˜ã€‚ å¾®åš Feed çš„ Outbox Vectorï¼ˆå³ç”¨æˆ·æœ€æ–°å¾®åšåˆ—è¡¨ï¼‰å°±é‡‡ç”¨è¿™ç§æ¨¡å¼ã€‚ä¸€äº›ç²‰ä¸è¾ƒå°‘ä¸”ä¸æ´»è·ƒçš„ç”¨æˆ·å‘è¡¨å¾®åšåŽï¼ŒVector æœåŠ¡ä¼šé¦–å…ˆæŸ¥è¯¢ Vector Cacheï¼Œå¦‚æžœ cache ä¸­æ²¡æœ‰è¯¥ç”¨æˆ·çš„ Outbox è®°å½•ï¼Œåˆ™ä¸å†™è¯¥ç”¨æˆ·çš„ cache æ•°æ®ï¼Œç›´æŽ¥æ›´æ–° DB åŽå°±è¿”å›žï¼Œåªæœ‰ cache ä¸­å­˜åœ¨æ‰ä¼šé€šè¿‡ CAS æŒ‡ä»¤è¿›è¡Œæ›´æ–°ã€‚ Write Behind Caching Write Behind Caching æ¨¡å¼ä¸Ž Read/Write Through æ¨¡å¼ç±»ä¼¼ï¼Œä¹Ÿç”±æ•°æ®å­˜å‚¨æœåŠ¡æ¥ç®¡ç† cache å’Œ DB çš„è¯»å†™ã€‚ä¸åŒç‚¹æ˜¯ï¼Œæ•°æ®æ›´æ–°æ—¶ï¼ŒRead/write Through æ˜¯åŒæ­¥æ›´æ–° cache å’Œ DBï¼Œè€Œ Write Behind Caching åˆ™æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æŽ¥æ›´æ–° DBï¼Œè€Œæ˜¯æ”¹ä¸ºå¼‚æ­¥æ‰¹é‡çš„æ–¹å¼æ¥æ›´æ–° DBã€‚è¯¥æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œæ•°æ®å­˜å‚¨çš„å†™æ€§èƒ½æœ€é«˜ï¼Œéžå¸¸é€‚åˆä¸€äº›å˜æ›´ç‰¹åˆ«é¢‘ç¹çš„ä¸šåŠ¡ï¼Œç‰¹åˆ«æ˜¯å¯ä»¥åˆå¹¶å†™è¯·æ±‚çš„ä¸šåŠ¡ï¼Œæ¯”å¦‚å¯¹ä¸€äº›è®¡æ•°ä¸šåŠ¡ï¼Œä¸€æ¡ Feed è¢«ç‚¹èµž 1ä¸‡ æ¬¡ï¼Œå¦‚æžœæ›´æ–° 1ä¸‡ æ¬¡ DB ä»£ä»·å¾ˆå¤§ï¼Œè€Œåˆå¹¶æˆä¸€æ¬¡è¯·æ±‚ç›´æŽ¥åŠ  1ä¸‡ï¼Œåˆ™æ˜¯ä¸€ä¸ªéžå¸¸è½»é‡çš„æ“ä½œã€‚ä½†è¿™ç§æ¨¡åž‹æœ‰ä¸ªæ˜¾è‘—çš„ç¼ºç‚¹ï¼Œå³æ•°æ®çš„ä¸€è‡´æ€§å˜å·®ï¼Œç”šè‡³åœ¨ä¸€äº›æžç«¯åœºæ™¯ä¸‹å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ã€‚æ¯”å¦‚ç³»ç»Ÿ Crashã€æœºå™¨å®•æœºæ—¶ï¼Œå¦‚æžœæœ‰æ•°æ®è¿˜æ²¡ä¿å­˜åˆ° DBï¼Œåˆ™ä¼šå­˜åœ¨ä¸¢å¤±çš„é£Žé™©ã€‚ ðŸ“Œè¿™ç§è¯»å†™æ¨¡å¼é€‚åˆå˜æ›´é¢‘çŽ‡ç‰¹åˆ«é«˜ï¼Œä½†å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸å¤ªé«˜çš„ä¸šåŠ¡ï¼Œè¿™æ ·å†™æ“ä½œå¯ä»¥å¼‚æ­¥æ‰¹é‡å†™å…¥ DBï¼Œå‡å° DB åŽ‹åŠ›ã€‚ ä¸‰ç§æ¨¡å¼å„æœ‰ä¼˜åŠ£ï¼Œä¸å­˜åœ¨æœ€ä½³æ¨¡å¼ã€‚ å®žé™…ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿä¸å¯èƒ½è®¾è®¡å‡ºä¸€ä¸ªæœ€ä½³çš„å®Œç¾Žæ¨¡å¼å‡ºæ¥ï¼Œå¦‚åŒå‰é¢è®²åˆ°çš„ç©ºé—´æ¢æ—¶é—´ã€è®¿é—®å»¶è¿Ÿæ¢ä½Žæˆæœ¬ä¸€æ ·ï¼Œé«˜æ€§èƒ½å’Œå¼ºä¸€è‡´æ€§ä»Žæ¥éƒ½æ˜¯æœ‰å†²çªçš„ï¼Œç³»ç»Ÿè®¾è®¡ä»Žæ¥å°±æ˜¯å–èˆï¼Œéšå¤„éœ€è¦ trade-offã€‚ é‡è¦çš„æ˜¯æ€æƒ³ï¼šå³å¦‚ä½•æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œæ›´å¥½çš„åš trade-offï¼Œä»Žè€Œè®¾è®¡å‡ºæ›´å¥½çš„æœåŠ¡ç³»ç»Ÿã€‚ ç¼“å­˜åˆ†ç±»åŠå¸¸ç”¨ç¼“å­˜ä»‹ç»æŒ‰å®¿ä¸»å±‚æ¬¡åˆ†ç±»åˆ†ä¸ºæœ¬åœ° Cacheã€è¿›ç¨‹é—´ Cache å’Œè¿œç¨‹ Cacheã€‚ æœ¬åœ° Cacheï¼šæ˜¯æŒ‡ä¸šåŠ¡è¿›ç¨‹å†…çš„ç¼“å­˜ï¼Œè¿™ç±»ç¼“å­˜ç”±äºŽåœ¨ä¸šåŠ¡ç³»ç»Ÿè¿›ç¨‹å†…ï¼Œæ‰€ä»¥è¯»å†™æ€§èƒ½è¶…é«˜ä¸”æ— ä»»ä½•ç½‘ç»œå¼€é”€ï¼Œä½†ä¸è¶³æ˜¯ä¼šéšç€ä¸šåŠ¡ç³»ç»Ÿé‡å¯è€Œä¸¢å¤±ã€‚ è¿›ç¨‹é—´ Cacheï¼šæ˜¯æœ¬æœºç‹¬ç«‹è¿è¡Œçš„ç¼“å­˜ï¼Œè¿™ç±»ç¼“å­˜è¯»å†™æ€§èƒ½è¾ƒé«˜ï¼Œä¸ä¼šéšç€ä¸šåŠ¡ç³»ç»Ÿé‡å¯ä¸¢æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥å¤§å¹…å‡å°‘ç½‘ç»œå¼€é”€ï¼Œä½†ä¸è¶³æ˜¯ä¸šåŠ¡ç³»ç»Ÿå’Œç¼“å­˜éƒ½åœ¨ç›¸åŒå®¿ä¸»æœºï¼Œè¿ç»´å¤æ‚ï¼Œä¸”å­˜åœ¨èµ„æºç«žäº‰ã€‚( cache å’Œ project éƒ½åœ¨åŒä¸€ä¸ª Linux éƒ¨ç½² ) è¿œç¨‹ Cacheï¼šæ˜¯æŒ‡è·¨æœºå™¨éƒ¨ç½²çš„ç¼“å­˜ï¼Œè¿™ç±»ç¼“å­˜å› ä¸ºç‹¬ç«‹è®¾å¤‡éƒ¨ç½²ï¼Œå®¹é‡å¤§ä¸”æ˜“æ‰©å±•ï¼Œåœ¨äº’è”ç½‘ä¼ä¸šä½¿ç”¨æœ€å¹¿æ³›ã€‚ä¸è¿‡è¿œç¨‹ç¼“å­˜éœ€è¦è·¨æœºè®¿é—®ï¼Œåœ¨é«˜è¯»å†™åŽ‹åŠ›ä¸‹ï¼Œå¸¦å®½å®¹æ˜“æˆä¸ºç“¶é¢ˆã€‚ æœ¬åœ° Cache çš„ç¼“å­˜ç»„ä»¶æœ‰ Ehcacheã€Guava Cache ç­‰ï¼Œå¼€å‘è€…è‡ªå·±ä¹Ÿå¯ä»¥ç”¨ Mapã€Set ç­‰è½»æ¾æž„å»ºä¸€ä¸ªè‡ªå·±ä¸“ç”¨çš„æœ¬åœ° Cacheã€‚ è¿›ç¨‹é—´ Cache å’Œè¿œç¨‹ Cache çš„ç¼“å­˜ç»„ä»¶ç›¸åŒï¼Œåªæ˜¯éƒ¨ç½²ä½ç½®çš„å·®å¼‚ç½¢äº†ï¼Œè¿™ç±»ç¼“å­˜ç»„ä»¶æœ‰ Memcachedã€Redisã€Pika ç­‰ã€‚ æŒ‰å­˜å‚¨ä»‹è´¨åˆ†ç±»åˆ†ä¸ºå†…å­˜åž‹ç¼“å­˜å’ŒæŒä¹…åŒ–åž‹ç¼“å­˜ã€‚ å†…å­˜åž‹ç¼“å­˜å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ï¼Œè¯»å†™æ€§èƒ½å¾ˆé«˜ï¼Œä½†ç¼“å­˜ç³»ç»Ÿé‡å¯æˆ– Crash åŽï¼Œå†…å­˜æ•°æ®ä¼šä¸¢å¤±ã€‚ æŒä¹…åŒ–åž‹ç¼“å­˜å°†æ•°æ®å­˜å‚¨åˆ° SSD/Fusion-IO ç¡¬ç›˜ä¸­ï¼Œç›¸åŒæˆæœ¬ä¸‹ï¼Œè¿™ç§ç¼“å­˜çš„å®¹é‡ä¼šæ¯”å†…å­˜åž‹ç¼“å­˜å¤§ 1 ä¸ªæ•°é‡çº§ä»¥ä¸Šï¼Œè€Œä¸”æ•°æ®ä¼šæŒä¹…åŒ–è½åœ°ï¼Œé‡å¯ä¸ä¸¢å¤±ï¼Œä½†è¯»å†™æ€§èƒ½ç›¸å¯¹ä½Ž 1ï½ž2 ä¸ªæ•°é‡çº§ã€‚Memcached æ˜¯å…¸åž‹çš„å†…å­˜åž‹ç¼“å­˜ï¼Œè€Œ Pika ä»¥åŠå…¶ä»–åŸºäºŽ RocksDB å¼€å‘çš„ç¼“å­˜ç»„ä»¶ç­‰åˆ™å±žäºŽæŒä¹…åŒ–åž‹ç¼“å­˜ã€‚ è®¾è®¡ç¼“å­˜æž¶æž„æ—¶éœ€è¦è€ƒé‡å“ªäº›å› ç´ ç¼“å­˜çš„å¼•å…¥åŠæž¶æž„è®¾è®¡ç¼“å­˜ç»„ä»¶é€‰æ‹©åœ¨è®¾è®¡æž¶æž„ç¼“å­˜æ—¶ï¼Œé¦–å…ˆè¦é€‰å®šç¼“å­˜ç»„ä»¶ï¼Œæ¯”å¦‚è¦ç”¨ Local-Cacheï¼Œè¿˜æ˜¯ Redisã€Memcachedã€Pika ç­‰å¼€æºç¼“å­˜ç»„ä»¶ï¼Œå¦‚æžœä¸šåŠ¡ç¼“å­˜éœ€æ±‚æ¯”è¾ƒç‰¹æ®Šï¼Œè¿˜è¦è€ƒè™‘æ˜¯ç›´æŽ¥å®šåˆ¶å¼€å‘ä¸€ä¸ªæ–°çš„ç¼“å­˜ç»„ä»¶ï¼Œè¿˜æ˜¯å¯¹å¼€æºç¼“å­˜è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ¥æ»¡è¶³ä¸šåŠ¡éœ€è¦ã€‚ ç¼“å­˜æ•°æ®ç»“æž„è®¾è®¡ç¡®å®šå¥½ç¼“å­˜ç»„ä»¶åŽï¼Œè¿˜è¦æ ¹æ®ä¸šåŠ¡è®¿é—®çš„ç‰¹ç‚¹ï¼Œè¿›è¡Œç¼“å­˜æ•°æ®ç»“æž„çš„è®¾è®¡ã€‚ å¯¹äºŽç›´æŽ¥ç®€å• KV è¯»å†™çš„ä¸šåŠ¡ï¼Œä½ å¯ä»¥å°†è¿™äº›ä¸šåŠ¡æ•°æ®å°è£…ä¸º Stringã€Jsonã€Protocol Buffer ç­‰æ ¼å¼ï¼Œåºåˆ—åŒ–æˆå­—èŠ‚åºåˆ—ï¼Œç„¶åŽç›´æŽ¥å†™å…¥ç¼“å­˜ä¸­ã€‚è¯»å–æ—¶ï¼Œå…ˆä»Žç¼“å­˜ç»„ä»¶èŽ·å–åˆ°æ•°æ®çš„å­—èŠ‚åºåˆ—ï¼Œå†è¿›è¡Œååºåˆ—åŒ–æ“ä½œå³å¯ã€‚å¯¹äºŽåªéœ€è¦å­˜å–éƒ¨åˆ†å­—æ®µæˆ–éœ€è¦åœ¨ç¼“å­˜ç«¯è¿›è¡Œè®¡ç®—çš„ä¸šåŠ¡ï¼Œå¯ä»¥æŠŠæ•°æ®è®¾è®¡ä¸º Hashã€Setã€Listã€Geo ç­‰ç»“æž„ï¼Œå­˜å‚¨åˆ°æ”¯æŒå¤æ‚é›†åˆæ•°æ®ç±»åž‹çš„ç¼“å­˜ä¸­ï¼Œå¦‚ Redisã€Pika ç­‰ã€‚ ç¼“å­˜åˆ†å¸ƒè®¾è®¡ç¡®å®šäº†ç¼“å­˜ç»„ä»¶ï¼Œè®¾è®¡å¥½äº†ç¼“å­˜æ•°æ®ç»“æž„ï¼ŒæŽ¥ä¸‹æ¥å°±è¦è®¾è®¡ç¼“å­˜çš„åˆ†å¸ƒã€‚å¯ä»¥ä»Ž 3 ä¸ªç»´åº¦æ¥è¿›è¡Œç¼“å­˜åˆ†å¸ƒè®¾è®¡ã€‚ é¦–å…ˆï¼Œè¦é€‰æ‹©åˆ†å¸ƒå¼ç®—æ³•ï¼Œæ˜¯é‡‡ç”¨å–æ¨¡è¿˜æ˜¯ä¸€è‡´æ€§ Hash è¿›è¡Œåˆ†å¸ƒã€‚å–æ¨¡åˆ†å¸ƒçš„æ–¹æ¡ˆç®€å•ï¼Œæ¯ä¸ª key åªä¼šå­˜åœ¨ç¡®å®šçš„ç¼“å­˜èŠ‚ç‚¹ï¼Œä¸€è‡´æ€§ Hash åˆ†å¸ƒçš„æ–¹æ¡ˆç›¸å¯¹å¤æ‚ï¼Œä¸€ä¸ª key å¯¹åº”çš„ç¼“å­˜èŠ‚ç‚¹ä¸ç¡®å®šã€‚ä½†ä¸€è‡´æ€§ Hash åˆ†å¸ƒï¼Œå¯ä»¥åœ¨éƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œå°†å¤±æ•ˆèŠ‚ç‚¹çš„æ•°æ®è®¿é—®å‡è¡¡åˆ†æ•£åˆ°å…¶ä»–æ­£å¸¸å­˜æ´»çš„èŠ‚ç‚¹ï¼Œä»Žè€Œæ›´å¥½åœ°ä¿è¯äº†ç¼“å­˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ å…¶æ¬¡ï¼Œåˆ†å¸ƒè¯»å†™è®¿é—®å¦‚ä½•è¿›è¡Œå®žæ–½ï¼Œæ˜¯ç”±ç¼“å­˜ Client ç›´æŽ¥è¿›è¡Œ Hash åˆ†å¸ƒå®šä½è¯»å†™ï¼Œè¿˜æ˜¯é€šè¿‡ Proxy ä»£ç†æ¥è¿›è¡Œè¯»å†™è·¯ç”±ï¼ŸClient ç›´æŽ¥è¯»å†™ï¼Œè¯»å†™æ€§èƒ½æœ€ä½³ï¼Œä½†éœ€è¦ Client æ„ŸçŸ¥åˆ†å¸ƒç­–ç•¥ã€‚åœ¨ç¼“å­˜éƒ¨ç½²å‘ç”Ÿåœ¨çº¿å˜åŒ–æ—¶ï¼Œä¹Ÿéœ€è¦åŠæ—¶é€šçŸ¥æ‰€æœ‰ç¼“å­˜ Clientï¼Œé¿å…è¯»å†™å¼‚å¸¸ï¼Œå¦å¤–ï¼ŒClient å®žçŽ°ä¹Ÿè¾ƒå¤æ‚ã€‚è€Œé€šè¿‡ Proxy è·¯ç”±ï¼ŒClient åªéœ€ç›´æŽ¥è®¿é—® Proxyï¼Œåˆ†å¸ƒé€»è¾‘åŠéƒ¨ç½²å˜æ›´éƒ½ç”± Proxy æ¥å¤„ç†ï¼Œå¯¹ä¸šåŠ¡åº”ç”¨å¼€å‘æœ€å‹å¥½ï¼Œä½†ä¸šåŠ¡è®¿é—®å¤šä¸€è·³ï¼Œè®¿é—®æ€§èƒ½ä¼šæœ‰ä¸€å®šçš„æŸå¤±ã€‚ æœ€åŽï¼Œç¼“å­˜ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æžœå¾…ç¼“å­˜çš„æ•°æ®é‡å¢žé•¿è¿‡å¿«ï¼Œä¼šå¯¼è‡´å¤§é‡ç¼“å­˜æ•°æ®è¢«å‰”é™¤ï¼Œç¼“å­˜å‘½ä¸­çŽ‡ä¼šä¸‹é™ï¼Œæ•°æ®è®¿é—®æ€§èƒ½ä¼šéšä¹‹é™ä½Žï¼Œè¿™æ ·å°±éœ€è¦å°†æ•°æ®ä»Žç¼“å­˜èŠ‚ç‚¹è¿›è¡ŒåŠ¨æ€æ‹†åˆ†ï¼ŒæŠŠéƒ¨åˆ†æ•°æ®æ°´å¹³è¿ç§»åˆ°å…¶ä»–ç¼“å­˜èŠ‚ç‚¹ã€‚è¿™ä¸ªè¿ç§»è¿‡ç¨‹éœ€è¦è€ƒè™‘ï¼Œæ˜¯ç”± Proxy è¿›è¡Œè¿ç§»è¿˜æ˜¯ç¼“å­˜ Server è‡ªèº«è¿›è¡Œè¿ç§»ï¼Œç”šè‡³æ ¹æœ¬å°±ä¸æ”¯æŒè¿ç§»ã€‚å¯¹äºŽ Memcachedï¼Œä¸€èˆ¬ä¸æ”¯æŒè¿ç§»ï¼Œå¯¹ Redisï¼Œç¤¾åŒºç‰ˆæœ¬æ˜¯ä¾é ç¼“å­˜ Server è¿›è¡Œè¿ç§»ï¼Œè€Œå¯¹ Codis åˆ™æ˜¯é€šè¿‡ Adminã€Proxy é…åˆåŽç«¯ç¼“å­˜ç»„ä»¶è¿›è¡Œè¿ç§»ã€‚ ç¼“å­˜æž¶æž„éƒ¨ç½²åŠè¿ç»´ç®¡ç†è®¾è®¡å®Œæ¯•ç¼“å­˜çš„åˆ†å¸ƒç­–ç•¥åŽï¼ŒæŽ¥ä¸‹æ¥å°±è¦è€ƒè™‘ç¼“å­˜çš„æž¶æž„éƒ¨ç½²åŠè¿ç»´ç®¡ç†äº†ã€‚æž¶æž„éƒ¨ç½²ä¸»è¦è€ƒè™‘å¦‚ä½•å¯¹ç¼“å­˜è¿›è¡Œåˆ†æ± ã€åˆ†å±‚ã€åˆ† IDCï¼Œä»¥åŠæ˜¯å¦éœ€è¦è¿›è¡Œå¼‚æž„å¤„ç†ã€‚ æ ¸å¿ƒçš„ã€é«˜å¹¶å‘è®¿é—®çš„ä¸åŒæ•°æ®ï¼Œéœ€è¦åˆ†åˆ«åˆ†æ‹†åˆ°ç‹¬ç«‹çš„ç¼“å­˜æ± ä¸­ï¼Œè¿›è¡Œåˆ†åˆ«è®¿é—®ï¼Œé¿å…ç›¸äº’å½±å“ï¼›è®¿é—®é‡è¾ƒå°ã€éžæ ¸å¿ƒçš„ä¸šåŠ¡æ•°æ®ï¼Œåˆ™å¯ä»¥æ··å­˜ã€‚ å¯¹æµ·é‡æ•°æ®ã€è®¿é—®è¶…è¿‡ 10ï½ž100ä¸‡ çº§çš„ä¸šåŠ¡æ•°æ®ï¼Œè¦è€ƒè™‘åˆ†å±‚è®¿é—®ï¼Œå¹¶ä¸”è¦åˆ†æ‘Šè®¿é—®é‡ï¼Œé¿å…ç¼“å­˜è¿‡è½½ã€‚ å¦‚æžœä¸šåŠ¡ç³»ç»Ÿéœ€è¦å¤š IDC éƒ¨ç½²ç”šè‡³å¼‚åœ°å¤šæ´»ï¼Œåˆ™éœ€è¦å¯¹ç¼“å­˜ä½“ç³»ä¹Ÿè¿›è¡Œå¤š IDC éƒ¨ç½²ï¼Œè¦è€ƒè™‘å¦‚ä½•è·¨ IDC å¯¹ç¼“å­˜æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå¯ä»¥é‡‡ç”¨ç›´æŽ¥è·¨ IDC è¯»å†™ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ DataBus é…åˆé˜Ÿåˆ—æœºè¿›è¡Œä¸åŒ IDC çš„æ¶ˆæ¯åŒæ­¥ï¼Œç„¶åŽç”±æ¶ˆæ¯å¤„ç†æœºè¿›è¡Œç¼“å­˜æ›´æ–°ï¼Œè¿˜å¯ä»¥ç”±å„ä¸ª IDC çš„ DB Trigger è¿›è¡Œç¼“å­˜æ›´æ–°ã€‚ æŸäº›æžç«¯åœºæ™¯ä¸‹ï¼Œè¿˜éœ€è¦æŠŠå¤šç§ç¼“å­˜ç»„ä»¶è¿›è¡Œç»„åˆä½¿ç”¨ï¼Œé€šè¿‡ç¼“å­˜å¼‚æž„è¾¾åˆ°æœ€ä½³è¯»å†™æ€§èƒ½ã€‚ ç«™åœ¨ç³»ç»Ÿå±‚é¢ï¼Œè¦æƒ³æ›´å¥½å¾—ç®¡ç†ç¼“å­˜ï¼Œè¿˜è¦è€ƒè™‘ç¼“å­˜çš„æœåŠ¡åŒ–ï¼Œè€ƒè™‘ç¼“å­˜ä½“ç³»å¦‚ä½•æ›´å¥½å¾—è¿›è¡Œé›†ç¾¤ç®¡ç†ã€ç›‘æŽ§è¿ç»´ç­‰ã€‚ ç¼“å­˜è®¾è®¡æž¶æž„çš„å¸¸è§è€ƒé‡ç‚¹åœ¨ç¼“å­˜è®¾è®¡æž¶æž„çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€äº›éžå¸¸é‡è¦çš„è€ƒé‡ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåªæœ‰åˆ†æžæ¸…æ¥šäº†è¿™äº›è€ƒé‡ç‚¹ï¼Œæ‰èƒ½è®¾è®¡æž¶æž„å‡ºæ›´ä½³çš„ç¼“å­˜ä½“ç³»ã€‚ è¯»å†™æ–¹å¼é¦–å…ˆæ˜¯ value çš„è¯»å†™æ–¹å¼ã€‚æ˜¯å…¨éƒ¨æ•´ä½“è¯»å†™ï¼Œè¿˜æ˜¯åªéƒ¨åˆ†è¯»å†™åŠå˜æ›´ï¼Ÿæ˜¯å¦éœ€è¦å†…éƒ¨è®¡ç®—ï¼Ÿæ¯”å¦‚ï¼Œç”¨æˆ·ç²‰ä¸æ•°ï¼Œå¾ˆå¤šæ™®é€šç”¨æˆ·çš„ç²‰ä¸æœ‰å‡ åƒåˆ°å‡ ä¸‡ï¼Œè€Œå¤§ V çš„ç²‰ä¸æ›´æ˜¯é«˜è¾¾å‡ åƒä¸‡ç”šè‡³è¿‡äº¿ï¼Œå› æ­¤ï¼ŒèŽ·å–ç²‰ä¸åˆ—è¡¨è‚¯å®šä¸èƒ½é‡‡ç”¨æ•´ä½“è¯»å†™çš„æ–¹å¼ï¼Œåªèƒ½éƒ¨åˆ†èŽ·å–ã€‚å¦å¤–åœ¨åˆ¤æ–­æŸç”¨æˆ·æ˜¯å¦å…³æ³¨äº†å¦å¤–ä¸€ä¸ªç”¨æˆ·æ—¶ï¼Œä¹Ÿä¸éœ€è¦æ‹‰å–è¯¥ç”¨æˆ·çš„å…¨éƒ¨å…³æ³¨åˆ—è¡¨ï¼Œç›´æŽ¥åœ¨å…³æ³¨åˆ—è¡¨ä¸Šè¿›è¡Œæ£€æŸ¥åˆ¤æ–­ï¼Œç„¶åŽè¿”å›ž True/False æˆ– 0/1 çš„æ–¹å¼æ›´ä¸ºé«˜æ•ˆã€‚ KV sizeç„¶åŽæ˜¯ä¸åŒä¸šåŠ¡æ•°æ®ç¼“å­˜ KV çš„ sizeã€‚å¦‚æžœå•ä¸ªä¸šåŠ¡çš„ KV size è¿‡å¤§ï¼Œéœ€è¦åˆ†æ‹†æˆå¤šä¸ª KV æ¥ç¼“å­˜ã€‚ä½†æ˜¯ï¼Œä¸åŒç¼“å­˜æ•°æ®çš„ KV size å¦‚æžœå·®å¼‚è¿‡å¤§ï¼Œä¹Ÿä¸èƒ½ç¼“å­˜åœ¨ä¸€èµ·ï¼Œé¿å…ç¼“å­˜æ•ˆçŽ‡çš„ä½Žä¸‹å’Œç›¸äº’å½±å“ã€‚ key çš„æ•°é‡key çš„æ•°é‡ä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦è€ƒè™‘å› ç´ ã€‚å¦‚æžœ key æ•°é‡ä¸å¤§ï¼Œå¯ä»¥åœ¨ç¼“å­˜ä¸­å­˜ä¸‹å…¨é‡æ•°æ®ï¼ŒæŠŠç¼“å­˜å½“ DB å­˜å‚¨æ¥ç”¨ï¼Œå¦‚æžœç¼“å­˜è¯»å– missï¼Œåˆ™è¡¨æ˜Žæ•°æ®ä¸å­˜åœ¨ï¼Œæ ¹æœ¬ä¸éœ€è¦å†åŽ» DB æŸ¥è¯¢ã€‚å¦‚æžœæ•°æ®é‡å·¨å¤§ï¼Œåˆ™åœ¨ç¼“å­˜ä¸­å°½å¯èƒ½åªä¿ç•™é¢‘ç¹è®¿é—®çš„çƒ­æ•°æ®ï¼Œå¯¹äºŽå†·æ•°æ®ç›´æŽ¥è®¿é—® DBã€‚ è¯»å†™å³°å€¼å¦å¤–ï¼Œå¯¹ç¼“å­˜æ•°æ®çš„è¯»å†™å³°å€¼ï¼Œå¦‚æžœå°äºŽ 10ä¸‡ çº§åˆ«ï¼Œç®€å•åˆ†æ‹†åˆ°ç‹¬ç«‹ Cache æ± å³å¯ã€‚è€Œä¸€æ—¦æ•°æ®çš„è¯»å†™å³°å€¼è¶…è¿‡ 10ä¸‡ ç”šè‡³åˆ°è¾¾ 100ä¸‡ çº§çš„QPSï¼Œåˆ™éœ€è¦å¯¹ Cache è¿›è¡Œåˆ†å±‚å¤„ç†ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ Local-Cache é…åˆè¿œç¨‹ cacheï¼Œç”šè‡³è¿œç¨‹ç¼“å­˜å†…éƒ¨ç»§ç»­åˆ†å±‚å åŠ åˆ†æ± è¿›è¡Œå¤„ç†ã€‚å¾®åšä¸šåŠ¡ä¸­ï¼Œå¤§å¤šæ•°æ ¸å¿ƒä¸šåŠ¡çš„ Memcached è®¿é—®éƒ½é‡‡ç”¨çš„è¿™ç§å¤„ç†æ–¹å¼ã€‚ å‘½ä¸­çŽ‡ç¼“å­˜çš„å‘½ä¸­çŽ‡å¯¹æ•´ä¸ªæœåŠ¡ä½“ç³»çš„æ€§èƒ½å½±å“ç”šå¤§ã€‚å¯¹äºŽæ ¸å¿ƒé«˜å¹¶å‘è®¿é—®çš„ä¸šåŠ¡ï¼Œéœ€è¦é¢„ç•™è¶³å¤Ÿçš„å®¹é‡ï¼Œç¡®ä¿æ ¸å¿ƒä¸šåŠ¡ç¼“å­˜ç»´æŒè¾ƒé«˜çš„å‘½ä¸­çŽ‡ã€‚æ¯”å¦‚å¾®åšä¸­çš„ Feed Vector Cacheï¼Œå¸¸å¹´çš„å‘½ä¸­çŽ‡é«˜è¾¾ 99.5% ä»¥ä¸Šã€‚ä¸ºäº†æŒç»­ä¿æŒç¼“å­˜çš„å‘½ä¸­çŽ‡ï¼Œç¼“å­˜ä½“ç³»éœ€è¦æŒç»­ç›‘æŽ§ï¼ŒåŠæ—¶è¿›è¡Œæ•…éšœå¤„ç†æˆ–æ•…éšœè½¬ç§»ã€‚åŒæ—¶åœ¨éƒ¨åˆ†ç¼“å­˜èŠ‚ç‚¹å¼‚å¸¸ã€å‘½ä¸­çŽ‡ä¸‹é™æ—¶ï¼Œæ•…éšœè½¬ç§»æ–¹æ¡ˆï¼Œéœ€è¦è€ƒè™‘æ˜¯é‡‡ç”¨ä¸€è‡´æ€§ Hash åˆ†å¸ƒçš„è®¿é—®æ¼‚ç§»ç­–ç•¥ï¼Œè¿˜æ˜¯é‡‡ç”¨æ•°æ®å¤šå±‚å¤‡ä»½ç­–ç•¥ã€‚ è¿‡æœŸç­–ç•¥ å¯ä»¥è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè®©å†· key è‡ªåŠ¨è¿‡æœŸï¼› ä¹Ÿå¯ä»¥è®© key å¸¦ä¸Šæ—¶é—´æˆ³ï¼ŒåŒæ—¶è®¾ç½®è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚å¾ˆå¤šä¸šåŠ¡ç³»ç»Ÿå†…éƒ¨æœ‰è¿™æ ·ä¸€äº› key:key_20190801ã€‚ å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´å¹³å‡ç¼“å­˜ç©¿é€åŠ è½½æ—¶é—´åœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ä¹Ÿå¾ˆé‡è¦ï¼Œå¯¹äºŽä¸€äº›ç¼“å­˜ç©¿é€åŽï¼ŒåŠ è½½æ—¶é—´ç‰¹åˆ«é•¿æˆ–è€…éœ€è¦å¤æ‚è®¡ç®—çš„æ•°æ®ï¼Œè€Œä¸”è®¿é—®é‡è¿˜æ¯”è¾ƒå¤§çš„ä¸šåŠ¡æ•°æ®ï¼Œè¦é…ç½®æ›´å¤šå®¹é‡ï¼Œç»´æŒæ›´é«˜çš„å‘½ä¸­çŽ‡ï¼Œä»Žè€Œå‡å°‘ç©¿é€åˆ° DB çš„æ¦‚çŽ‡ï¼Œæ¥ç¡®ä¿æ•´ä¸ªç³»ç»Ÿçš„è®¿é—®æ€§èƒ½ã€‚ ç¼“å­˜å¯è¿ç»´æ€§å¯¹äºŽç¼“å­˜çš„å¯è¿ç»´æ€§è€ƒè™‘ï¼Œåˆ™éœ€è¦è€ƒè™‘ç¼“å­˜ä½“ç³»çš„é›†ç¾¤ç®¡ç†ï¼Œå¦‚ä½•è¿›è¡Œä¸€é”®æ‰©ç¼©å®¹ï¼Œå¦‚ä½•è¿›è¡Œç¼“å­˜ç»„ä»¶çš„å‡çº§å’Œå˜æ›´ï¼Œå¦‚ä½•å¿«é€Ÿå‘çŽ°å¹¶å®šä½é—®é¢˜ï¼Œå¦‚ä½•æŒç»­ç›‘æŽ§æŠ¥è­¦ï¼Œæœ€å¥½æœ‰ä¸€ä¸ªå®Œå–„çš„è¿ç»´å¹³å°ï¼Œå°†å„ç§è¿ç»´å·¥å…·è¿›è¡Œé›†æˆã€‚ ç¼“å­˜å®‰å…¨æ€§å¯¹äºŽç¼“å­˜çš„å®‰å…¨æ€§è€ƒè™‘ï¼Œä¸€æ–¹é¢å¯ä»¥é™åˆ¶æ¥æº IPï¼Œåªå…è®¸å†…ç½‘è®¿é—®ï¼ŒåŒæ—¶å¯¹äºŽä¸€äº›å…³é”®æ€§æŒ‡ä»¤ï¼Œéœ€è¦å¢žåŠ è®¿é—®æƒé™ï¼Œé¿å…è¢«æ”»å‡»æˆ–è¯¯æ“ä½œæ—¶ï¼Œå¯¼è‡´é‡å¤§åŽæžœã€‚]]></content>
      <categories>
        <category>ç¼“å­˜</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CollectionUtilså·¥å…·ç±»]]></title>
    <url>%2F2020%2F10%2F13%2FCollectionUtils%E5%B7%A5%E5%85%B7%E7%B1%BB%2F</url>
    <content type="text"><![CDATA[CollectionUtilså·¥å…·ç±»Apache Commons Collections ä½¿æ“ä½œé›†åˆæ—¶ï¼Œä»£ç æ›´åŠ ç®€æ´ å¸¸ç”¨APIå…ƒç´ ä¸ä¸ºnullæ—¶ï¼Œå‘é›†åˆæ·»åŠ å…ƒç´  1CollectionUtils.addIgnoreNull(targetList, targetObject); å°†ä¸¤ä¸ªå·²æŽ’åºçš„é›†åˆaå’Œbåˆå¹¶ä¸ºä¸€ä¸ªå·²æŽ’åºçš„åˆ—è¡¨ï¼Œä¿ç•™å…ƒç´ çš„è‡ªç„¶é¡ºåº 1CollectionUtils.collate(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b) å°†ä¸¤ä¸ªå·²æŽ’åºçš„é›†åˆaå’Œbåˆå¹¶åˆ°ä¸€ä¸ªå·²æŽ’åºçš„åˆ—è¡¨ä¸­ï¼Œæ ¹æ®æ¯”è¾ƒå™¨é¡ºåº 1CollectionUtils.collate(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b, Comparator&lt;? super O&gt; c) å¦‚æžœå‚æ•°æ˜¯nullï¼Œåˆ™è¿”å›žä¸å¯å˜çš„ç©ºé›†åˆï¼ˆnew EmptyList&lt;&gt;()ï¼‰ï¼Œå¦åˆ™è¿”å›žå‚æ•°æœ¬èº« 1CollectionUtils.emptyIfNull(Collection&lt;T&gt; collection) ç©ºå®‰å…¨æ£€æŸ¥æŒ‡å®šçš„é›†åˆæ˜¯å¦ä¸ºç©º 12CollectionUtils.isEmpty(Collection&lt;?&gt; coll)CollectionUtils.isNotEmpty(Collection&lt;?&gt; coll) åè½¬ç»™å®šæ•°ç»„çš„é¡ºåº 1CollectionUtils.reverseArray(Object[] array) å·®é›† 1CollectionUtils.subtract(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b) å¹¶é›† 1CollectionUtils.union(Iterable&lt;? extends O&gt; a, Iterable&lt;? extends O&gt; b) äº¤é›† 1CollectionUtils.intersection(Collection a, Collection b) äº¤é›†çš„è¡¥é›† 1CollectionUtils.disjunction(Collection a, Collection b)]]></content>
      <categories>
        <category>å·¥å…·ç±»</category>
      </categories>
      <tags>
        <tag>é›†åˆ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Data JPA è‡ªå®šä¹‰è¿”å›žå€¼]]></title>
    <url>%2F2020%2F09%2F27%2FSpringDataJpa%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%94%E5%9B%9E%E5%80%BC%2F</url>
    <content type="text"><![CDATA[Spring Data JPA è‡ªå®šä¹‰è¿”å›žå€¼æ‰“å¼€ SimpleJpaRepository ç›´æŽ¥çœ‹å®ƒçš„ Structure ï¼Œä»Žå®ƒå®žçŽ°çš„æ–¹æ³•ä»¥åŠçˆ¶ç±»æŽ¥å£çš„æ–¹æ³•çœ‹åˆ°ï¼Œè¿”å›žç±»åž‹åŒ…æ‹¬ï¼šOptionalã€Iterableã€Listã€Pageã€Longã€Booleanã€Entity ç­‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è€Œå®žé™…ä¸Šæ”¯æŒçš„è¿”å›žç±»åž‹è¿˜è¦å¤šä¸€äº›ã€‚ ç”±äºŽ Repository é‡Œé¢æ”¯æŒ Iterableï¼Œæ‰€ä»¥ java æ ‡å‡†çš„ Listã€Set éƒ½å¯ä»¥ä½œä¸ºè¿”å›žç»“æžœï¼Œå¹¶ä¸”ä¹Ÿä¼šæ”¯æŒå…¶å­ç±»ã€‚ æŸ¥è¯¢ç»“æžœçš„è¿”å›žå€¼StreamableSpring Data é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„å­ç±» Streamableï¼ŒStreamable å¯ä»¥æ›¿ä»£ Iterable æˆ–ä»»ä½•é›†åˆç±»åž‹ã€‚å®ƒè¿˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥è®¿é—® Streamï¼Œå¯ä»¥ç›´æŽ¥åœ¨å…ƒç´ ä¸Šè¿›è¡Œ â€¦.filter(â€¦) å’Œ â€¦.map(â€¦) æ“ä½œï¼Œå¹¶å°† Streamable è¿žæŽ¥åˆ°å…¶ä»–å…ƒç´ ã€‚ æˆ‘ä»¬çœ‹ä¸ªå…³äºŽ UserRepository ç›´æŽ¥ç»§æ‰¿ JpaRepository çš„ä¾‹å­ 12public interface UserRepository extends JpaRepository&lt;User,Long&gt; &#123;&#125; UserRepository ç±»ï¼Œåœ¨æµ‹è¯•ç±»é‡Œé¢åšå¦‚ä¸‹è°ƒç”¨ï¼š 12345678User user = userRepository.save( User.builder().name("jackxx").email("123456@126.com") .sex("man").address("shanghai").build());Assert.assertNotNull(user);Streamable&lt;User&gt; userStreamable = userRepository .findAll(PageRequest.of(0,10)) .and(User.builder().name("jack222").build());userStreamable.forEach(System.out::println); è¾“å‡ºå¦‚ä¸‹ï¼š 12User(id=1, name=jackxx, email=123456@126.com, sex=man, address=shanghai)User(id=null, name=jack222, email=null, sex=null, address=null) è¿™ä¸ªä¾‹å­ Streamable&lt;User&gt; userStreamableï¼Œå®žçŽ°äº† Streamable çš„è¿”å›žç»“æžœã€‚ è‡ªå®šä¹‰ Streamableå®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†è‡ªå®šä¹‰ Streamable çš„æ–¹æ³•ï¼Œä¸è¿‡åœ¨å®žé™…å·¥ä½œä¸­å¾ˆå°‘å‡ºçŽ°è¦è‡ªå®šä¹‰ä¿è¯ç»“æžœç±»çš„æƒ…å†µã€‚ 123456789101112131415class Product &#123; (1) MonetaryAmount getPrice() &#123; â€¦ &#125;&#125;@RequiredArgConstructor(staticName = "of")class Products implements Streamable&lt;Product&gt; &#123; (2) private Streamable&lt;Product&gt; streamable; public MonetaryAmount getTotal() &#123; (3) return streamable.stream() // .map(Priced::getPrice) .reduce(Money.of(0), MonetaryAmount::add); &#125;&#125;interface ProductRepository implements Repository&lt;Product, Long&gt; &#123; Products findAllByDescriptionContaining(String text); (4)&#125; ä»¥ä¸Šå››ä¸ªæ­¥éª¤ä»‹ç»äº†è‡ªå®šä¹‰ Streamable çš„æ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºï¼š ï¼ˆ1ï¼‰Product å®žä½“ï¼Œå…¬å¼€ API ä»¥è®¿é—®äº§å“ä»·æ ¼ã€‚ ï¼ˆ2ï¼‰Streamable&lt;Product&gt; çš„åŒ…è£…ç±»åž‹å¯ä»¥é€šè¿‡ Products.of(â€¦) æž„é€ ï¼ˆé€šè¿‡ Lombok æ³¨è§£åˆ›å»ºçš„å·¥åŽ‚æ–¹æ³•ï¼‰ã€‚ ï¼ˆ3ï¼‰åŒ…è£…å™¨ç±»åž‹åœ¨ Streamable&lt;Product&gt; ä¸Šå…¬å¼€äº†è®¡ç®—æ–°å€¼çš„å…¶ä»– APIã€‚ ï¼ˆ4ï¼‰å¯ä»¥å°†åŒ…è£…å™¨ç±»åž‹ç›´æŽ¥ç”¨ä½œæŸ¥è¯¢æ–¹æ³•è¿”å›žç±»åž‹ã€‚æ— é¡»è¿”å›ž Streamable&lt;Product&gt; å¹¶å°†å…¶æ‰‹åŠ¨åŒ…è£…åœ¨å­˜å‚¨åº“ Client ç«¯ä¸­ã€‚ å…¶åŽŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å®žçŽ° StreamableæŽ¥å£ï¼Œè‡ªå·±å®šä¹‰è‡ªå·±çš„å®žçŽ°ç±»å³å¯ã€‚ æºç åœ¨ QueryExecutionResultHandler ï¼Œå®ƒé‡Œé¢æœ‰å¯¹ Streamable å­ç±»çš„åˆ¤æ–­ï¼Œæ¥æ”¯æŒè‡ªå®šä¹‰ Streamableï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š é€šè¿‡æºç ä½ ä¼šå‘çŽ° Streamable ä¸ºä»€ä¹ˆç”Ÿæ•ˆï¼Œä¸‹é¢æ¥çœ‹çœ‹å¸¸è§çš„é›†åˆç±»çš„è¿”å›žå®žçŽ°ã€‚ List/Stream/Page/Sliceé¦–å…ˆï¼Œæ–°å»ºæˆ‘ä»¬çš„ UserRepositoryï¼š 12345678910111213package com.example.jpa.example1;import org.springframework.data.domain.Pageable;import org.springframework.data.jpa.repository.JpaRepository;import org.springframework.data.jpa.repository.Query;import java.util.stream.Stream;public interface UserRepository extends JpaRepository&lt;User,Long&gt; &#123; //è‡ªå®šä¹‰ä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œè¿”å›žStreamå¯¹è±¡ï¼Œå¹¶ä¸”æœ‰åˆ†é¡µå±žæ€§ @Query("select u from User u") Stream&lt;User&gt; findAllByCustomQueryAndStream(Pageable pageable); //æµ‹è¯•Sliceçš„è¿”å›žç»“æžœ @Query("select u from User u") Slice&lt;User&gt; findAllByCustomQueryAndSlice(Pageable pageable);&#125; ç„¶åŽï¼Œä¿®æ”¹ä¸€ä¸‹æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ç±»ï¼Œå¦‚ä¸‹ï¼ŒéªŒè¯ä¸€ä¸‹ç»“æžœï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package com.example.jpa.example1;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import org.assertj.core.util.Lists;import org.junit.Assert;import org.junit.jupiter.api.Test;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;import org.springframework.data.domain.Page;import org.springframework.data.domain.PageRequest;import org.springframework.data.domain.Slice;import org.springframework.data.util.Streamable;import java.util.List;import java.util.stream.Stream;@DataJpaTestpublic class UserRepositoryTest &#123; @Autowired private UserRepository userRepository; @Test public void testSaveUser() throws JsonProcessingException &#123; //æˆ‘ä»¬æ–°å¢ž7æ¡æ•°æ®æ–¹ä¾¿æµ‹è¯•åˆ†é¡µç»“æžœ userRepository.save(User.builder().name("jack1").email("123456@126.com") .sex("man").address("shanghai").build()); userRepository.save(User.builder().name("jack2").email("123456@126.com") .sex("man").address("shanghai").build()); userRepository.save(User.builder().name("jack3").email("123456@126.com") .sex("man").address("shanghai").build()); userRepository.save(User.builder().name("jack4").email("123456@126.com") .sex("man").address("shanghai").build()); userRepository.save(User.builder().name("jack5").email("123456@126.com") .sex("man").address("shanghai").build()); userRepository.save(User.builder().name("jack6").email("123456@126.com") .sex("man").address("shanghai").build()); userRepository.save(User.builder().name("jack7").email("123456@126.com") .sex("man").address("shanghai").build()); //æˆ‘ä»¬åˆ©ç”¨ObjectMapperå°†æˆ‘ä»¬çš„è¿”å›žç»“æžœJson to String ObjectMapper objectMapper = new ObjectMapper(); //è¿”å›žStreamç±»åž‹ç»“æžœï¼ˆ1ï¼‰ Stream&lt;User&gt; userStream = userRepository.findAllByCustomQueryAndStream(PageRequest.of(1,3)); userStream.forEach(System.out::println); //è¿”å›žåˆ†é¡µæ•°æ®ï¼ˆ2ï¼‰ Page&lt;User&gt; userPage = userRepository.findAll(PageRequest.of(0,3)); System.out.println(objectMapper.writeValueAsString(userPage)); //è¿”å›žSliceç»“æžœï¼ˆ3ï¼‰ Slice&lt;User&gt; userSlice = userRepository.findAllByCustomQueryAndSlice(PageRequest.of(0,3)); System.out.println(objectMapper.writeValueAsString(userSlice)); //è¿”å›žListç»“æžœï¼ˆ4ï¼‰ List&lt;User&gt; userList = userRepository.findAllById(Lists.newArrayList(1L,2L)); System.out.println(objectMapper.writeValueAsString(userList)); &#125;&#125; è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å››ç§æµ‹è¯•ç»“æžœï¼š ç¬¬ä¸€ç§ï¼šé€šè¿‡ Stream&lt;User&gt;å–ç¬¬äºŒé¡µçš„æ•°æ®å¾—åˆ°ç»“æžœå¦‚ä¸‹ï¼š 123User(id=4, name=jack4, email=123456@126.com, sex=man, address=shanghai)User(id=5, name=jack5, email=123456@126.com, sex=man, address=shanghai)User(id=6, name=jack6, email=123456@126.com, sex=man, address=shanghai) Spring Data çš„æ”¯æŒå¯ä»¥é€šè¿‡ä½¿ç”¨ Java 8 Stream ä½œä¸ºè¿”å›žç±»åž‹æ¥é€æ­¥å¤„ç†æŸ¥è¯¢æ–¹æ³•çš„ç»“æžœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæµçš„å…³é—­é—®é¢˜ï¼Œtry cache æ˜¯ä¸€ç§å¸¸ç”¨çš„å…³é—­æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 1234567891011Stream&lt;User&gt; stream;try &#123; stream = repository.findAllByCustomQueryAndStream() stream.forEach(â€¦);&#125; catch (Exception e) &#123; e.printStackTrace();&#125; finally &#123; if (stream!=null)&#123; stream.close(); &#125;&#125; ç¬¬äºŒç§ï¼šè¿”å›ž Page&lt;User&gt; çš„åˆ†é¡µæ•°æ®ç»“æžœå¾—åˆ°ç»“æžœå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950&#123; "content":[ &#123; "id":1, "name":"jack1", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125;, &#123; "id":2, "name":"jack2", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125;, &#123; "id":3, "name":"jack3", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125; ], "pageable":&#123; "sort":&#123; "sorted":false, "unsorted":true, "empty":true &#125;, "pageNumber":0, // å½“å‰é¡µç  "pageSize":3, // é¡µç å¤§å° "offset":0, // åç§»é‡ "paged":true, // æ˜¯å¦åˆ†é¡µäº† "unpaged":false &#125;, "totalPages":3, // ä¸€å…±æœ‰å¤šå°‘é¡µ "last":false, // æ˜¯å¦æ˜¯åˆ°æœ€åŽ "totalElements":7, // æ€»è®°å½•æ•° "numberOfElements":3, // å½“å‰æ•°æ®ä¸‹æ ‡ "sort":&#123; "sorted":false, "unsorted":true, "empty":true &#125;, "size":3, // å½“å‰contentå¤§å° "number":0, // å½“å‰é¡µé¢ç çš„ç´¢å¼• "first":true, // æ˜¯å¦æ˜¯ç¬¬ä¸€é¡µ "empty":false // æ˜¯å¦æœ‰æ•°æ®&#125; è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Page&lt;User&gt; è¿”å›žäº†ç¬¬ä¸€ä¸ªé¡µçš„æ•°æ®ï¼Œå¹¶ä¸”å‘Šè¯‰æˆ‘ä»¬ä¸€å…±æœ‰ä¸‰ä¸ªéƒ¨åˆ†çš„æ•°æ®ï¼š contentï¼šæ•°æ®çš„å†…å®¹ï¼ŒçŽ°åœ¨æŒ‡ User çš„ List 3 æ¡ã€‚ pageableï¼šåˆ†é¡µæ•°æ®ï¼ŒåŒ…æ‹¬æŽ’åºå­—æ®µæ˜¯ä»€ä¹ˆåŠå…¶æ–¹å‘ã€å½“å‰æ˜¯ç¬¬å‡ é¡µã€ä¸€å…±å¤šå°‘é¡µã€æ˜¯å¦æ˜¯æœ€åŽä¸€æ¡ç­‰ã€‚ å½“å‰æ•°æ®çš„æè¿°ï¼š â€œsizeâ€ï¼š3ï¼Œå½“å‰ content å¤§å° â€œnumberâ€ï¼š0ï¼Œå½“å‰é¡µé¢ç çš„ç´¢å¼• â€œfirstâ€ï¼štrueï¼Œæ˜¯å¦æ˜¯ç¬¬ä¸€é¡µ â€œemptyâ€ï¼šfalseï¼Œæ˜¯å¦æ²¡æœ‰æ•°æ® ç¬¬ä¸‰ç§ï¼šè¿”å›ž Slice&lt;User&gt; ç»“æžœå¾—åˆ°ç»“æžœå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&#123; "content":[ &#123; "id":4, "name":"jack4", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125;, &#123; "id":5, "name":"jack5", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125;, &#123; "id":6, "name":"jack6", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125; ], "pageable":&#123; "sort":&#123; "sorted":false, "unsorted":true, "empty":true &#125;, "pageNumber":1, "pageSize":3, "offset":3, "paged":true, "unpaged":false &#125;, "numberOfElements":3, "sort":&#123; "sorted":false, "unsorted":true, "empty":true &#125;, "size":3, "number":1, "first":false, "last":false, "empty":false&#125; è¿™æ—¶æˆ‘ä»¬å‘çŽ°ä¸Šé¢çš„ Page è¿”å›žç»“æžœå°‘äº†ï¼Œå°‘äº†è·Ÿè®°å½•æ•°ç›¸å…³çš„å†…å®¹ 1234"totalPages":3, // ä¸€å…±æœ‰å¤šå°‘é¡µ"last":false, // æ˜¯å¦æ˜¯åˆ°æœ€åŽ"totalElements":7, // æ€»è®°å½•æ•°"numberOfElements":3, // å½“å‰æ•°æ®ä¸‹æ ‡ å†æ¯”è¾ƒä¸€ä¸‹ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æµ‹è¯•ç»“æžœçš„æ‰§è¡Œ SQLï¼š ç¬¬äºŒç§æ‰§è¡Œçš„æ˜¯æ™®é€šçš„åˆ†é¡µæŸ¥è¯¢ SQLï¼š 1234-- æŸ¥è¯¢åˆ†é¡µæ•°æ®Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_ limit ?-- è®¡ç®—åˆ†é¡µæ•°æ®Hibernate: select count(user0_.id) as col_0_0_ from user user0_ ç¬¬ä¸‰ç§æ‰§è¡Œçš„ SQL å¦‚ä¸‹ï¼š 1Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_ limit ? offset ? é€šè¿‡å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼ŒåªæŸ¥è¯¢åç§»é‡ï¼Œä¸è®¡ç®—åˆ†é¡µæ•°æ®ï¼Œè¿™å°±æ˜¯ Page å’Œ Slice çš„ä¸»è¦åŒºåˆ«ã€‚æˆ‘ä»¬æŽ¥ç€çœ‹ç¬¬å››ç§æµ‹è¯•ç»“æžœã€‚ ç¬¬å››ç§ï¼šè¿”å›ž List&lt;User&gt;å¾—åˆ°ç»“æžœå¦‚ä¸‹ï¼š 12345678910111213141516[ &#123; "id":1, "name":"jack1", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125;, &#123; "id":2, "name":"jack2", "email":"123456@126.com", "sex":"man", "address":"shanghai" &#125;] å¯ä»¥å¾ˆç®€å•åœ°æŸ¥è¯¢å‡ºæ¥ ID=1 å’Œ ID=2 çš„æ•°æ®ï¼Œæ²¡æœ‰åˆ†é¡µä¿¡æ¯ã€‚ ä¸Šé¢å››ç§æ–¹æ³•ä»‹ç»äº†å¸¸è§çš„å¤šæ¡æ•°æ®è¿”å›žç»“æžœçš„å½¢å¼ï¼Œå•æ¡çš„æŸ¥è¯¢æ— éžå°±æ˜¯å¯¹ JDK8 çš„ Optional çš„æ”¯æŒã€‚æ¯”å¦‚æ”¯æŒäº† Null çš„ä¼˜é›…åˆ¤æ–­ï¼Œå†ä¸€ä¸ªå°±æ˜¯æ”¯æŒç›´æŽ¥è¿”å›ž Entityï¼Œæˆ–è€…ä¸€äº›å­˜åœ¨ / ä¸å­˜åœ¨çš„ Boolean çš„ç»“æžœå’Œä¸€äº› count æ¡æ•°çš„è¿”å›žç»“æžœè€Œå·²ã€‚ å¼‚æ­¥æŸ¥è¯¢è¿”å›žå€¼Feature/CompletableFuture/ListenableFutureæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Spring çš„å¼‚æ­¥æ–¹æ³•æ‰§è¡ŒRepositoryæŸ¥è¯¢ï¼Œè¿™æ„å‘³ç€æ–¹æ³•å°†åœ¨è°ƒç”¨æ—¶ç«‹å³è¿”å›žï¼Œå¹¶ä¸”å®žé™…çš„æŸ¥è¯¢æ‰§è¡Œå°†å‘ç”Ÿåœ¨å·²æäº¤ç»™ Spring TaskExecutor çš„ä»»åŠ¡ä¸­ï¼Œæ¯”è¾ƒé€‚åˆå®šæ—¶ä»»åŠ¡çš„å®žé™…åœºæ™¯ã€‚å¼‚æ­¥ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œç›´æŽ¥åŠ @Async æ³¨è§£å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456@AsyncFuture&lt;User&gt; findByFirstname(String firstname); (1)@AsyncCompletableFuture&lt;User&gt; findOneByFirstname(String firstname); (2)@AsyncListenableFuture&lt;User&gt; findOneByLastname(String lastname);(3) ä¸Šè¿°ä¸‰ä¸ªå¼‚æ­¥æ–¹æ³•çš„è¿”å›žç»“æžœï¼Œåˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šï¼š ç¬¬ä¸€å¤„ï¼šä½¿ç”¨ java.util.concurrent.Future çš„è¿”å›žç±»åž‹ï¼› ç¬¬äºŒå¤„ï¼šä½¿ç”¨ java.util.concurrent.CompletableFuture ä½œä¸ºè¿”å›žç±»åž‹ï¼› ç¬¬ä¸‰å¤„ï¼šä½¿ç”¨ org.springframework.util.concurrent.ListenableFuture ä½œä¸ºè¿”å›žç±»åž‹ã€‚ ä»¥ä¸Šæ˜¯å¯¹ @Async çš„æ”¯æŒï¼Œå…³äºŽå®žé™…ä½¿ç”¨éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹å†…å®¹ï¼š åœ¨å®žé™…å·¥ä½œä¸­ï¼Œç›´æŽ¥åœ¨ Repository è¿™ä¸€å±‚ä½¿ç”¨å¼‚æ­¥æ–¹æ³•çš„åœºæ™¯ä¸å¤šï¼Œä¸€èˆ¬éƒ½æ˜¯æŠŠå¼‚æ­¥æ³¨è§£æ”¾åœ¨ Service çš„æ–¹æ³•ä¸Šé¢ï¼Œè¿™æ ·çš„è¯ï¼Œå¯ä»¥æœ‰ä¸€äº›é¢å¤–é€»è¾‘ï¼Œå¦‚å‘çŸ­ä¿¡ã€å‘é‚®ä»¶ã€å‘æ¶ˆæ¯ç­‰é…åˆä½¿ç”¨ï¼› ä½¿ç”¨å¼‚æ­¥çš„æ—¶å€™ä¸€å®šè¦é…ç½®çº¿ç¨‹æ± ï¼Œè¿™ç‚¹åˆ‡è®°ï¼Œå¦åˆ™â€œæ­»â€å¾—ä¼šå¾ˆéš¾çœ‹ï¼› ðŸ“Œ ä¸‡ä¸€å¤±è´¥è¦æ€Žä¹ˆå¤„ç†ï¼Ÿå…³äºŽäº‹åŠ¡æ˜¯æ€Žä¹ˆå¤„ç†çš„å‘¢? æŽ¥ä¸‹æ¥çœ‹çœ‹ Repository å¯¹ Reactive æ˜¯å¦‚ä½•æ”¯æŒçš„ã€‚ å¯¹ Reactive æ”¯æŒ flux ä¸Ž MonoSpring Data Common é‡Œé¢å¯¹ Reactive è¿˜æ˜¯æœ‰æ”¯æŒçš„ï¼Œä½†æ˜¯ Common é‡Œé¢æä¾›çš„åªæ˜¯æŽ¥å£ï¼Œè€Œ JPA é‡Œé¢æ²¡æœ‰åšç›¸å…³çš„ Reactive çš„å®žçŽ°ï¼Œæ‰€ä»¥Spring Data JPA ä¸æ”¯æŒ Reactive å…¶ä»–å­æ¨¡å—ï¼Œå¦‚ mongoå®žçŽ°äº†è¯¥æŽ¥å£ ä¸‹é¢æˆ‘ä»¬åœ¨ gradle é‡Œé¢å¼•ç”¨ä¸€ä¸ª Spring Data Common çš„å­æ¨¡å— implementation â€˜org.springframework.boot:spring-boot-starter-data-mongodbâ€™ æ¥åŠ è½½ä¾èµ–ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ‰“å¼€ Repository çœ‹ Hierarchy å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¤šäº†ä¸€ä¸ª Mongo çš„ Repository çš„å®žçŽ°ï¼Œå¤©ç„¶åœ°æ”¯æŒç€ Reactive è¿™æ¡çº¿ã€‚ ç›¸ä¿¡åˆ°è¿™é‡Œä½ èƒ½æ„Ÿå—åˆ° Spring Data Common çš„å¼ºå¤§æ”¯æŒï¼Œå¯¹ Repository æŽ¥å£çš„ä¸åŒå®žçŽ°ä¹Ÿæœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚ æ€»ç»“ä¸‹é¢æ‰“å¼€ ResultProcessor ç±»çš„æºç çœ‹ä¸€ä¸‹æ”¯æŒçš„ç±»åž‹æœ‰å“ªäº›ã€‚ ä»Žä¸Šå›¾å¯ä»¥çœ‹å‡º processResult çš„æ—¶å€™åˆ†åˆ«å¯¹ PageQueryã€Streamã€Reactive æœ‰äº†å„è‡ªçš„åˆ¤æ–­ï¼Œæˆ‘ä»¬ debug åˆ°è¿™é‡Œçš„æ—¶å€™æ¥çœ‹ä¸€ä¸‹ convertï¼Œè¿›å…¥åˆ°ç±»é‡Œé¢ã€‚ å¯ä»¥çœ‹åˆ° QueryExecutorConverters é‡Œé¢å¯¹ JDK8ã€Guavaã€vavr ä¹Ÿåšäº†å„ç§æ”¯æŒï¼Œè‡ªè¡Œé˜…è¯»æºç  ä¸‹è¡¨åˆ—å‡ºäº† Spring Data JPA Query Method æœºåˆ¶æ”¯æŒçš„æ–¹æ³•çš„è¿”å›žå€¼ç±»åž‹ï¼š ðŸ“Œ Geospatial types (such as GeoResult, GeoResults, and GeoPage) are available only for data stores that support geospatial queries. Return type Description void ä¸è¿”å›žç»“æžœï¼Œä¸€èˆ¬æ˜¯æ›´æ–°æ“ä½œ Primitives Java çš„åŸºæœ¬ç±»åž‹ï¼Œä¸€èˆ¬å¸¸è§çš„æ˜¯ç»Ÿè®¡æ“ä½œ ï¼ˆå¦‚ longã€boolean ç­‰ï¼‰ Wrapper types Wrapper types Java çš„åŒ…è£…ç±» T è¿”å›žå”¯ä¸€çš„å®žä½“ï¼Œæ²¡æœ‰æŸ¥è¯¢ç»“æžœè¿”å›žnull ï¼Œè¶…è¿‡ä¸€ä¸ªç»“æžœä¼šæŠ›å‡ºIncorrectResultSizeDataAccessException Iterator&lt;T&gt; An Iterator. Collection&lt;T&gt; A Collection. List&lt;T&gt; A List. Optional&lt;T&gt; A Java 8 or Guava Optional. Expects the query method to return one result at most. If no result is found, Optional.empty() or Optional.absent() is returned. More than one result triggers an IncorrectResultSizeDataAccessException. Option&lt;T&gt; Either a Scala or Vavr Option type. Semantically the same behavior as Java 8â€™s Optional, described earlier. Stream&lt;T&gt; A Java 8 Stream. Streamable&lt;T&gt; A convenience extension of Iterable that directly exposes methods to stream, map and filter results, concatenate them etc. Types that implement Streamable and take a Streamable constructor or factory method argument Types that expose a constructor or â€¦.of(â€¦)/â€¦.valueOf(â€¦) factory method taking a Streamable as argument. See Returning Custom Streamable Wrapper Types for details. Vavr Seq, List, Map, Set Vavr collection types. See Support for Vavr Collections for details. Future&lt;T&gt; A Future. Expects a method to be annotated with @Async and requires Springâ€™s asynchronous method execution capability to be enabled. CompletableFuture&lt;T&gt; A Java 8 CompletableFuture. Expects a method to be annotated with @Async and requires Springâ€™s asynchronous method execution capability to be enabled. ListenableFuture A org.springframework.util.concurrent.ListenableFuture. Expects a method to be annotated with @Async and requires Springâ€™s asynchronous method execution capability to be enabled. Slice A sized chunk of data with an indication of whether there is more data available. Requires a Pageable method parameter. Page&lt;T&gt; A Slice with additional information, such as the total number of results. Requires a Pageable method parameter. GeoResult&lt;T&gt; A result entry with additional information, such as the distance to a reference location. GeoResults&lt;T&gt; A list of GeoResult&lt;T&gt; with additional information, such as the average distance to a reference location. GeoPage&lt;T&gt; A Page with GeoResult&lt;T&gt;, such as the average distance to a reference location. Mono&lt;T&gt; A Project Reactor Mono emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, Mono.empty() is returned. More than one result triggers an IncorrectResultSizeDataAccessException. Flux&lt;T&gt; A Project Reactor Flux emitting zero, one, or many elements using reactive repositories. Queries returning Flux can emit also an infinite number of elements. Single&lt;T&gt; A RxJava Single emitting a single element using reactive repositories. Expects the query method to return one result at most. If no result is found, Mono.empty() is returned. More than one result triggers an IncorrectResultSizeDataAccessException. Maybe&lt;T&gt; A RxJava Maybe emitting zero or one element using reactive repositories. Expects the query method to return one result at most. If no result is found, Mono.empty() is returned. More than one result triggers an IncorrectResultSizeDataAccessException. Flowable&lt;T&gt; A RxJava Flowable emitting zero, one, or many elements using reactive repositories. Queries returning Flowable can emit also an infinite number of elements. å¸¸è§çš„ DTO è¿”å›žç»“æžœçš„æ”¯æŒæ–¹æ³•Projections çš„æ¦‚å¿µ Spring JPA å¯¹ Projections æ‰©å±•çš„æ”¯æŒï¼Œè¿™æ˜¯ä¸ªéžå¸¸å¥½çš„ä¸œè¥¿ï¼Œä»Žå­—é¢æ„æ€ä¸Šç†è§£å°±æ˜¯æ˜ å°„ï¼ŒæŒ‡çš„æ˜¯å’Œ DB çš„æŸ¥è¯¢ç»“æžœçš„å­—æ®µæ˜ å°„å…³ç³»ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿”å›žçš„å­—æ®µå’Œ DB çš„æŸ¥è¯¢ç»“æžœçš„å­—æ®µæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼›ä½†æœ‰çš„æ—¶å€™ï¼Œéœ€è¦è¿”å›žä¸€äº›æŒ‡å®šçš„å­—æ®µï¼Œæˆ–è€…è¿”å›žä¸€äº›å¤åˆåž‹çš„å­—æ®µï¼Œè€Œä¸éœ€è¦å…¨éƒ¨è¿”å›žã€‚ ä¸€èˆ¬çš„åšæ³•æ˜¯è‡ªå·±å†™å„ç§ entity åˆ° view çš„å„ç§ convert çš„è½¬åŒ–é€»è¾‘ï¼Œè€Œ Spring Data æ­£æ˜¯è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œå…è®¸å¯¹ä¸“ç”¨è¿”å›žç±»åž‹è¿›è¡Œå»ºæ¨¡ï¼Œæœ‰é€‰æ‹©åœ°è¿”å›žåŒä¸€ä¸ªå®žä½“çš„ä¸åŒè§†å›¾å¯¹è±¡ã€‚ ä¸‹é¢è¿˜ä»¥ User æŸ¥è¯¢å¯¹è±¡ä¸ºä¾‹ï¼Œçœ‹çœ‹æ€Žä¹ˆè‡ªå®šä¹‰è¿”å›ž DTOï¼š 1234567891011121314@Entity@Data@Builder@AllArgsConstructor@NoArgsConstructorpublic class User &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email; private String sex; private String address;&#125; çœ‹ä¸Šé¢çš„åŽŸå§‹ User å®žä½“ä»£ç ï¼Œå¦‚æžœæˆ‘ä»¬åªæƒ³è¿”å›ž User å¯¹è±¡é‡Œé¢çš„ name å’Œ emailï¼Œåº”è¯¥æ€Žä¹ˆåšï¼Ÿä¸‹é¢ä»‹ç»ä¸‰ç§æ–¹æ³•ã€‚ ç¬¬ä¸€ç§ï¼šåŒä¸€å¼  Tableï¼Œä¸åŒ Entityé¦–å…ˆï¼Œæˆ‘ä»¬æ–°å¢žä¸€ä¸ªEntityç±»ï¼šé€šè¿‡ @Table æŒ‡å‘åŒä¸€å¼ è¡¨ï¼Œè¿™å¼ è¡¨å’Œ User å®žä¾‹é‡Œé¢çš„è¡¨ä¸€æ ·éƒ½æ˜¯ userï¼Œå®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š 12345678910111213@Entity@Table(name = "user")@Data@Builder@AllArgsConstructor@NoArgsConstructorpublic class UserOnlyNameEmailEntity &#123; @Id @GeneratedValue(strategy= GenerationType.AUTO) private Long id; private String name; private String email;&#125; ç„¶åŽï¼Œæ–°å¢žä¸€ä¸ª UserOnlyNameEmailEntityRepositoryï¼Œåšå•ç‹¬çš„æŸ¥è¯¢ï¼š 1234package com.example.jpa.example1;import org.springframework.data.jpa.repository.JpaRepository;public interface UserOnlyNameEmailEntityRepository extends JpaRepository&lt;UserOnlyNameEmailEntity, Long&gt; &#123;&#125; æœ€åŽï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹é‡Œé¢çš„å†™æ³•å¦‚ä¸‹ï¼š 1234567891011@Testpublic void testProjections() &#123; userRepository.save(User.builder().id(1L) .name("jack12") .email("123456@126.com").sex("man") .address("shanghai").build()); List&lt;User&gt; users= userRepository.findAll(); System.out.println(users); UserOnlyNameEmailEntity uName = userOnlyNameEmailEntityRepository.getOne(1L); System.out.println(uName);&#125; æˆ‘ä»¬çœ‹ä¸€ä¸‹è¾“å‡ºç»“æžœï¼š 12345Hibernate: insert into user (address, email, name, sex, id) values (?, ?, ?, ?, ?)Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_[User(id=1, name=jack12, email=123456@126.com, sex=man, address=shanghai)]Hibernate: select useronlyna0_.id as id1_0_0_, useronlyna0_.email as email3_0_0_, useronlyna0_.name as name4_0_0_ from user useronlyna0_ where useronlyna0_.id=?UserOnlyNameEmailEntity(id=1, name=jack12, email=123456@126.com) ä¸Šè¿°ç»“æžœå¯ä»¥çœ‹åˆ°ï¼Œå½“åœ¨ user è¡¨é‡Œé¢æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œè€Œ userRepository å’Œ userOnlyNameEmailEntityRepository æŸ¥è¯¢çš„éƒ½æ˜¯åŒä¸€å¼ è¡¨ userã€‚ å¥½å¤„ï¼šç®€å•ã€æ–¹ä¾¿ï¼Œå¾ˆå®¹æ˜“å¯ä»¥æƒ³åˆ°ï¼› ç¼ºç‚¹ï¼šé€šè¿‡ä¸¤ä¸ªå®žä½“éƒ½å¯ä»¥è¿›è¡Œ update æ“ä½œï¼Œå¦‚æžœåŒä¸€ä¸ªé¡¹ç›®é‡Œé¢è¿™ç§å®žä½“æ¯”è¾ƒå¤šï¼Œ â€‹ åˆ°æ—¶å€™å°±å®¹æ˜“ä¸çŸ¥é“æ˜¯è°æ›´æ–°çš„ï¼Œä»Žè€Œå¯¼è‡´å‡º bug ä¸å¥½å®šä½ï¼Œ â€‹ å®žä½“èŒè´£åˆ’åˆ†ä¸æ˜Žç¡®ã€‚ ç¬¬äºŒç§ï¼šå®šä¹‰ DTO ç±»é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª DTO ç±»æ¥è¿”å›žæˆ‘ä»¬æƒ³è¦çš„å­—æ®µï¼Œå®ƒæ˜¯ UserOnlyNameEmailDtoï¼Œç”¨æ¥æŽ¥æ”¶ nameã€email ä¸¤ä¸ªå­—æ®µçš„å€¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š 123456@Data@Builder@AllArgsConstructorpublic class UserOnlyNameEmailDto &#123; private String name, email;&#125; å…¶æ¬¡ï¼Œåœ¨ UserRepository é‡Œé¢åšå¦‚ä¸‹ç”¨æ³•ï¼š 1234public interface UserRepository extends JpaRepository&lt;User,Long&gt; &#123; //æµ‹è¯•åªè¿”å›žnameå’Œemailçš„DTO UserOnlyNameEmailDto findByEmail(String email);&#125; ç„¶åŽï¼Œæµ‹è¯•ç”¨ä¾‹é‡Œé¢å†™æ³•å¦‚ä¸‹ï¼š 12345678@Testpublic void testProjections() &#123;userRepository.save(User.builder().id(1L) .name("jack12").email("123456@126.com").sex("man") .address("shanghai").build());UserOnlyNameEmailDto userOnlyNameEmailDto = userRepository.findByEmail("123456@126.com");System.out.println(userOnlyNameEmailDto);&#125; æœ€åŽï¼Œè¾“å‡ºç»“æžœå¦‚ä¸‹ï¼š 12Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.email=?UserOnlyNameEmailDto(name=jack12, email=123456@126.com) è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æžœæˆ‘ä»¬åŽ»çœ‹æºç çš„è¯ï¼Œçœ‹å…³é”®çš„ PreferredConstructorDiscoverer ç±»æ—¶ä¼šå‘çŽ°ï¼ŒUserDTO é‡Œé¢åªèƒ½æœ‰ä¸€ä¸ªå…¨å‚æ•°æž„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒConstructor é€‰æ‹©çš„æ—¶å€™ä¼šå¸®æˆ‘ä»¬åšæž„é€ å‚æ•°çš„é€‰æ‹©ï¼Œå¦‚æžœ DTO é‡Œé¢æœ‰å¤šä¸ªæž„é€ æ–¹æ³•ï¼Œå°±ä¼šæŠ¥è½¬åŒ–é”™è¯¯çš„å¼‚å¸¸ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¼‚å¸¸æ˜¯è¿™æ ·çš„ï¼š 1No converter found capable of converting from type [com.example.jpa.example1.User] to type [com.example.jpa.example1.UserOnlyNameEmailDto ä¼˜ç‚¹ï¼šè¿”å›žçš„ç»“æžœä¸éœ€è¦æ˜¯ä¸ªå®žä½“å¯¹è±¡ï¼Œå¯¹ DB ä¸èƒ½è¿›è¡Œé™¤äº†æŸ¥è¯¢ä¹‹å¤–çš„ä»»ä½•æ“ä½œï¼› ç¼ºç‚¹ï¼šæœ‰ set æ–¹æ³•è¿˜å¯ä»¥æ”¹å˜é‡Œé¢çš„å€¼ï¼Œæž„é€ æ–¹æ³•ä¸èƒ½æ›´æ”¹ï¼Œå¿…é¡»å…¨å‚æ•°ï¼Œ â€‹ è¿™æ ·å¦‚æžœæ˜¯ä¸ç†Ÿæ‚‰ JPA çš„æ–°äººæ“ä½œçš„æ—¶å€™å¾ˆå®¹æ˜“å¼•å‘ Bugã€‚ ç¬¬ä¸‰ç§ï¼šå®šä¹‰ DTO æŽ¥å£æˆ‘ä»¬å†æ¥å­¦ä¹ ä¸€ç§è¿”å›žä¸åŒå­—æ®µçš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸Žä¸Šé¢ä¸¤ç§çš„åŒºåˆ«æ˜¯åªéœ€è¦å®šä¹‰æŽ¥å£ï¼Œå®ƒçš„å¥½å¤„æ˜¯åªè¯»ï¼Œä¸éœ€è¦æ·»åŠ æž„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬ä½¿ç”¨èµ·æ¥éžå¸¸çµæ´»ï¼Œä¸€èˆ¬å¾ˆéš¾äº§ç”Ÿ Bugï¼Œé‚£ä¹ˆå®ƒæ€Žä¹ˆå®žçŽ°å‘¢ï¼Ÿ é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ª UserOnlyName çš„æŽ¥å£ï¼š 12345package com.example.jpa.example1;public interface UserOnlyName &#123; String getName(); String getEmail();&#125; 12345678910package com.example.jpa.example1;import org.springframework.data.jpa.repository.JpaRepository;public interface UserRepository extends JpaRepository&lt;User,Long&gt; &#123; /** * æŽ¥å£çš„æ–¹å¼è¿”å›žDTO * @param address * @return */ UserOnlyName findByAddress(String address);&#125; ç„¶åŽï¼Œæµ‹è¯•ç”¨ä¾‹çš„å†™æ³•å¦‚ä¸‹ï¼š 12345678@Testpublic void testProjections() &#123;userRepository.save(User.builder().name("jack12") .email("123456@126.com").sex("man") .address("shanghai").build());UserOnlyName userOnlyName = userRepository.findByAddress("shanghai");System.out.println(userOnlyName);&#125; æœ€åŽï¼Œæˆ‘ä»¬çš„è¿è¡Œç»“æžœå¦‚ä¸‹ï¼š 12Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.address=?org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@1d369521 è¿™ä¸ªæ—¶å€™ä¼šå‘çŽ°æˆ‘ä»¬çš„ userOnlyName æŽ¥å£æˆäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‡Œé¢é€šè¿‡ Map çš„æ ¼å¼åŒ…å«äº†æˆ‘ä»¬çš„è¦è¿”å›žå­—æ®µçš„å€¼ï¼ˆå¦‚ï¼šnameã€emailï¼‰ï¼Œæˆ‘ä»¬ç”¨çš„æ—¶å€™ç›´æŽ¥è°ƒç”¨æŽ¥å£é‡Œé¢çš„æ–¹æ³•å³å¯ï¼Œå¦‚ userOnlyName.getName() å³å¯ï¼›è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æŽ¥å£ä¸ºåªè¯»ï¼Œå¹¶ä¸”è¯­ä¹‰æ›´æ¸…æ™°ï¼Œæ‰€ä»¥è¿™ç§æ˜¯æˆ‘æ¯”è¾ƒæŽ¨èçš„åšæ³•ã€‚ å…¶ä¸­æºç æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Œæˆ‘æ¥è¯´ä¸€ä¸ªç±»ï¼Œä½ å¯ä»¥é€šè¿‡ debugï¼Œçœ‹ä¸€ä¸‹æœ€ç»ˆ DTO å’ŒæŽ¥å£è½¬åŒ–æ‰§è¡Œçš„ query æœ‰ä»€ä¹ˆä¸åŒï¼Œçœ‹ä¸‹å›¾ä¸­ debug æ˜¾ç¤ºçš„ Query è¯­å¥çš„ä½ç½®ï¼š å›¾ä¸€ï¼šæ˜¯è¿”å›ž DTO æŽ¥å£å½¢å¼çš„ query ç”Ÿæˆçš„ JPQLï¼š å›¾äºŒï¼šæ˜¯è¿”å›ž DTO ç±»çš„æ—¶å€™ QueryStructure ç”Ÿæˆçš„ JPQL è¯­å¥ï¼š ä¸¤ç§æœ€å¤§çš„åŒºåˆ«æ˜¯ DTO ç±»éœ€è¦æž„é€ æ–¹æ³• new ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¬¬äºŒç§æ–¹æ³•é‡Œé¢éœ€è¦æ³¨æ„çš„ DTO æž„é€ å‡½æ•°çš„é—®é¢˜ï¼›è€Œé€šè¿‡å›¾ä¸€æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŽ¥å£ç›´æŽ¥é€šè¿‡ as åˆ«åï¼Œæ˜ å°„æˆ hashmap å³å¯ï¼Œéžå¸¸çµæ´»ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>è‡ªå®šä¹‰è¿”å›žå€¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Oracleçš„åŸºç¡€çŸ¥è¯†]]></title>
    <url>%2F2020%2F09%2F22%2FOracle%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%2F</url>
    <content type="text"><![CDATA[Oracle çš„åŸºç¡€çŸ¥è¯†æ•°æ®åº“è®¾è®¡ æ•°æ®åº“è®¾è®¡æ˜¯ç”»å‡ºæ•°æ®åº“çš„ERå›¾ï¼Œé€šè¿‡ERå›¾ç”Ÿæˆ sql å»ºåº“ä»£ç (DDL) ç”Ÿæˆçš„å»ºåº“ä»£ç çš„çº¦æŸéƒ½æ˜¯è¿½åŠ çš„ï¼Œæ–¹ä¾¿åˆ°æ—¶åˆ é™¤ SQLç±»åž‹ DQLï¼šæ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œå…³é”®å­— selectï¼Œ åŠŸèƒ½ï¼šæŸ¥è¯¢ DMLï¼šæ•°æ®æ“ä½œè¯­è¨€ï¼Œå…³é”®å­— insertã€deleteã€updateï¼ŒåŠŸèƒ½ï¼šæ“ä½œæ•°æ® DDLï¼šæ•°æ®å®šä¹‰è¯­è¨€ï¼Œå…³é”®å­— createã€dropã€alterï¼ŒåŠŸèƒ½ï¼šæ“ä½œæ•°æ®åº“å¯¹è±¡ DCLï¼šæ•°æ®æŽ§åˆ¶è¯­è¨€ï¼Œå…³é”®å­— grantã€revokeï¼ŒåŠŸèƒ½ï¼šç”¨æˆ·æŽˆæƒæ’¤æƒ TCLï¼šäº‹åŠ¡æŽ§åˆ¶è¯­è¨€ï¼Œå…³é”®å­— commitã€rollbackã€savepointï¼ŒåŠŸèƒ½ï¼šäº‹åŠ¡å¤„ç† æŸ¥è¯¢12345select [distinct]&#123;* | &lt;å­—æ®µå&gt; | è¡¨å.*&#125; from &lt;è¡¨å&gt;-- 1. ç»™è¡¨ä¸€ä¸ªåˆ«åselect * from emp e;-- 2. ç»™è¿”å›žå­—æ®µä¸€ä¸ªåˆ«åselect emp.ename as å‘˜å·¥å from emp; æ¡ä»¶æŸ¥è¯¢where å…³é”®å­— æŸ¥è¯¢è¿ç®—ç¬¦å¯¹æ¯”è¿ç®—ç¬¦ è¿ç®—ç¬¦ è¯´æ˜Ž = ç­‰å·ï¼›oracle é‡Œé¢çš„èµ‹å€¼è¯­å¥æ˜¯=: &gt; å¤§äºŽ &lt; å°äºŽ &gt;= å¤§äºŽç­‰äºŽ &lt;= å°äºŽç­‰äºŽ &lt;&gt; ä¸ç­‰äºŽï¼Œä¹Ÿå¯ä»¥ç”¨ != is ä¸€èˆ¬ç”¨äºŽåˆ¤ç©º is nullï¼Œis not null in é›†åˆ between ..and .. åœ¨..ä¹‹é—´ like æ¨¡ç³ŠæŸ¥è¯¢ &lt;&gt; æ˜¯æ ‡å‡† sql çš„ä¸ç­‰äºŽï¼Œä»»ä½•å…³ç³»åž‹æ•°æ®åº“éƒ½æ”¯æŒï¼Œ!= åªæœ‰éƒ¨åˆ†æ•°æ®åº“æ”¯æŒ é€»è¾‘è¿ç®—ç¬¦ è¿ç®—ç¬¦ è¯´æ˜Ž and ä¸Ž or æˆ– not éž æ¨¡ç³ŠæŸ¥è¯¢ æŸ¥è¯¢å‘˜å·¥çš„åå­—æœ‰ A æˆ–è€… E çš„å‘˜å·¥ 1select * from emp where ename like '%A%' or ename like '%E%'; æŸ¥è¯¢ç¬¬ä¸‰ä¸ªå­—ç¬¦æ˜¯ A çš„å‘˜å·¥ 1select * from emp where ename like '__A%'; æŸ¥è¯¢å‘˜å·¥åæœ‰ _ çš„å‘˜å·¥ï¼Œéœ€è¦è½¬ä¹‰ï¼›escape æ˜¯ä¸€ä¸ªå®šä¹‰è½¬ä¹‰å­—ç¬¦çš„æ„æ€ 1select * from emp where ename like '%\_%' escape '\'; åˆ†ç»„æŸ¥è¯¢ä»¥æŸä¸ªå­—æ®µä½œä¸ºåˆ†ç±»çš„æ¡ä»¶ç»Ÿè®¡éœ€æ±‚ï¼Œæœ‰æ¡ä»¶å°±éœ€è¦ç”¨åˆ° having ç­›é€‰ æŸ¥è¯¢è¯­å¥çš„å…³é”®å­—çš„ä¼˜å…ˆçº§åˆ«é—®é¢˜ï¼š 1from &gt; where &gt; group by &gt; having &gt; select &gt; order by ç»“è®ºï¼š åˆ†ç»„å‰ï¼šç¡®å®šçš„æ¡ä»¶ä½¿ç”¨ whereï¼Œ åˆ†ç»„åŽï¼šç¡®å®šçš„æ¡ä»¶ä½¿ç”¨ having åŽŸå› å°±æ˜¯ where çš„ä¼˜å…ˆçº§å¤§äºŽ group by å¤šè¡¨æŸ¥è¯¢ç¬›å¡å°”ç§¯ ç¬›å¡å°”ç§¯æ˜¯ä¸¤ä¸ªé›†åˆXå’ŒYçš„ç›´ç§¯ï¼Œè¡¨ç¤ºä¸ºX*Yï¼› Xé›†åˆçš„æ¯ä¸ªå…ƒç´ å’ŒYé›†åˆçš„æ¯ä¸ªå…ƒç´ æ‰€å½¢æˆçš„æœ‰åºå¯¹é›†åˆå°±æ˜¯Xå’ŒYçš„ç¬›å¡å°”ç§¯ ç­‰å€¼è¿žæŽ¥å½“æ¡ä»¶ä¸ºâ€œ=â€çš„è¿žæŽ¥ä¸ºç­‰å€¼è¿žæŽ¥ï¼Œæ˜¯è¿žæŽ¥å±žæ€§å€¼ç›¸ç­‰çš„é‚£äº›å…ƒç»„ï¼› å…¶ç»“æžœæ˜¯è¿žæŽ¥çš„è¡¨çš„æ‰€æœ‰åˆ—ï¼ŒåŒ…æ‹¬é‡å¤åˆ—ï¼Œç›¸å½“äºŽå†…è¿žæŽ¥ 123select * from emp, deptwhere emp.deptno = dept.deptno; ä¸ç­‰å€¼è¿žæŽ¥ä¸¤ä¸ªè¡¨ä¸­ç›¸å…³çš„ä¸¤åˆ—è¿›è¡Œä¸ç­‰è¿žæŽ¥ï¼› æ¯”è¾ƒç¬¦å·ä¸€èˆ¬ä¸º &lt;&gt;ã€&gt;ã€&lt;ã€&gt;=ã€&lt;=ã€LIKEã€INã€BETWEENâ€¦AND å†…è¿žæŽ¥123select * from emp inner join depton emp.deptno = dept.deptno; å¤–è¿žæŽ¥å¤–è¿žæŽ¥å°±æ˜¯è¿žæŽ¥ä¸¤ä¸ªè¡¨ï¼Œæ ¹æ®å·¦å¤–è¿˜æ˜¯å³å¤–è¿žæŽ¥ï¼ŒåŸºè¡¨çš„å­—æ®µä¼šå…¨éƒ¨æ˜¾ç¤ºï¼› å¦‚æžœå­—æ®µä¸å¯¹åº”ï¼ŒéžåŸºè¡¨çš„è¡¨æ‰€æœ‰çš„å­—æ®µå€¼ä¼šè®¾ä¸ºnull å·¦å¤–è¿žæŽ¥å·¦è¾¹çš„è¡¨ä½œä¸ºåŸºè¡¨ï¼Œå³è¡¨å¦‚æœ‰å·¦è¡¨ä¸å¯¹åº”çš„å­—æ®µåˆ™è®¾ä¸ºnull å³å¤–è¿žæŽ¥å³è¾¹çš„è¡¨ä½œä¸ºåŸºè¡¨ï¼Œå·¦è¡¨å¦‚æœ‰å³è¡¨ä¸å¯¹åº”çš„å­—æ®µåˆ™è®¾ä¸ºnull Oracle å¤–è¿žæŽ¥çš„ç‰¹æ®Šå†™æ³•ï¼ˆé¸¡è‚‹ï¼‰ ç­‰å€¼æŸ¥è¯¢çš„æ¡ä»¶ä¸ŠåŠ ä¸€ä¸ª(+)è¡¨ç¤ºä¸æ˜¯åŸºè¡¨ï¼Œåˆ™ä¸åŠ (+)æ‰æ˜¯åŸºè¡¨ å³å¤–è¿žæŽ¥ 1234&gt; select emp.*, dept.dname&gt; from emp,dept&gt; where emp.deptno(+) = dept.deptno;&gt; å·¦å¤–è¿žæŽ¥ 1234&gt; select emp.*, dept.dname&gt; from emp,dept&gt; where emp.deptno = dept.deptno(+);&gt; è‡ªè¿žæŽ¥æŽ’åº è¯­æ³•ï¼š 12345&gt; select * | å­—æ®µ &gt; from &lt;è¡¨å&gt;&gt; [where &lt;æ¡ä»¶&gt;]&gt; order by &lt;å­—æ®µ1, å­—æ®µ2&gt; desc | asc&gt; æŸ¥è¯¢å‘˜å·¥çš„ä¿¡æ¯ï¼ŒæŒ‰éƒ¨é—¨ç¼–å·æŽ’åºï¼Œå†æŒ‰å·¥èµ„æŽ’åº 1select * from emp order by deptno, sal; æŸ¥è¯¢å‘˜å·¥çš„ä¿¡æ¯ï¼ŒæŒ‰éƒ¨é—¨ç¼–å·æŽ’åº(æ­£åº)åŽï¼Œå†æŒ‰å·¥èµ„æŽ’åº(å€’åº) 1select * from emp order by deptno, sal desc; æŒ‰å‘˜å·¥çš„å¥–é‡‘æŽ’åºï¼Œå€’åºçš„æ—¶å€™ï¼Œnull æ”¾åœ¨åŽé¢ 12select * from emp order by comm desc nulls first; -- å°†nullå€¼æ”¾åœ¨æœ€å‰select * from emp order by comm desc nulls last; -- å°†nullå€¼æ”¾åœ¨æœ€åŽ å‡½æ•°å•è¡Œå‡½æ•°æ•°ç»„å‡½æ•°å››èˆäº”å…¥å‡½æ•° round(åŽŸå€¼, ç²¾åº¦) æ±‚å‘˜å·¥çš„å¹³å‡å·¥èµ„ï¼Œä¿ç•™ä¸¤ä½å°æ•° 12-- å¦‚æžœç²¾åº¦æ˜¯æ­£æ•°ï¼Œç²¾ç¡®çš„æ˜¯å°æ•°ä»Žå°æ•°ç‚¹ç¬¬ä¸€ä½å¼€å§‹ï¼Œå¾€å³ç§»select round(avg(sal), 2) avg(sal) from emp; å¦‚ï¼šå¹³å‡å·¥èµ„ = 2073.214 â€‹ round(å¹³å‡å·¥èµ„, 2) = 2073.21 12-- å¦‚æžœç²¾åº¦æ˜¯è´Ÿæ•°ï¼Œç²¾ç¡®çš„æ˜¯ä»Žä¸ªä½å¼€å§‹ï¼Œå¾€å·¦ç§»select round(avg(sal), -1), avg(sal) from emp; å¦‚ï¼šå¹³å‡å·¥èµ„ = 2073.214 â€‹ round(å¹³å‡å·¥èµ„, -1) = 2070 â€‹ round(å¹³å‡å·¥èµ„, -2) = 2100 â€‹ round(å¹³å‡å·¥èµ„, -3) = 2000 â€‹ round(å¹³å‡å·¥èµ„, -4) = 0 æˆªå–å‡½æ•° trunc(åŽŸå€¼, ç²¾åº¦) 12-- å’Œå››èˆäº”å…¥å·®ä¸å¤šåŒºåˆ«å°±æ˜¯ä¸ä¼šå‘ä¸Šè¿›ä½ï¼Œå°±æ˜¯æˆªå–ç²¾åº¦çš„ä½ç½®select trunc(avg(sal), 2) avg(sal) from emp; å­—ç¬¦å‡½æ•°æŸ¥è¯¢å‘˜å·¥çš„å§“åï¼Œæ ¼å¼ä¸º â€˜å‘˜å·¥å:å§“åâ€™ æ–¹å¼ä¸€ï¼šä½¿ç”¨ || è¿žæŽ¥ 1select 'å‘˜å·¥å:' || ename from emp; æ–¹å¼äºŒï¼šä½¿ç”¨ concat å‡½æ•° 1select concat('å‘˜å·¥å:', ename) from emp; é•¿åº¦å‡½æ•° length(åŽŸå€¼) 1select ename, length(ename) from emp; æ›¿æ¢å‡½æ•° replace(c1, c2, c3) c1ï¼šåŽŸå€¼ c2ï¼šéœ€è¦æ›¿æ¢çš„å€¼ c3ï¼šæ–°å€¼ å°† my name is leo çš„ my ä¿®æ”¹ä¸º your 1select replace('my name is leo', 'my', 'your') from dual; å› ä¸ºè¿™ä¸ªä¿®æ”¹æ²¡æœ‰è¡¨ï¼Œæ‰€ä»¥ç»™å®ƒä¸€ä¸ªä¸´æ—¶è¡¨ dual æ—¶é—´å‡½æ•°èŽ·å–ç³»ç»Ÿå½“å‰æ—¶é—´ 1select sysdate from dual; æœˆä»½å¯¹æ¯”å‡½æ•° months_between(d1, d2) d1 &lt; d2ï¼Œè¿”å›žè´Ÿæ•° d1 = d2ï¼Œè¿”å›ž 0 d1 &gt; d2ï¼Œè¿”å›žæ­£æ•° è¿”å›žå€¼ï¼šä¸¤ä¸ªæ—¥æœŸçš„æœˆä»½é—´éš” ä½œç”¨ï¼š ç”¨äºŽè®¡ç®—ä¸¤ä¸ªæ—¥æœŸé—´éš”çš„æœˆä»½æ•° å¯¹æ¯”ä¸¤ä¸ªæ—¥æœŸçš„å¤§å° 2018-06-26 ä¸Ž 2020-09-22 ç›¸éš”å¤šå°‘ä¸ªæœˆ 1234select months_between( to_date('2018-06-26', 'yyyy-mm-dd'), to_date('2020-09-22', 'yyyy-mm-dd')) from dual; æœˆä»½å¢žåŠ å‡½æ•° add_months(åŽŸå€¼, å¢žåŠ çš„æœˆä»½æ•°) ç»™å½“å‰æ—¥æœŸåŠ ä¸‰ä¸ªæœˆ 1select add_months(sysdate, 3) from dual; ç»™å½“å‰æ—¥æœŸå‡ä¸‰ä¸ªæœˆ 1select add_months(sysdate, -3) from dual; æ—¥æœŸæˆªå–å‡½æ•° extract( ç±»åž‹ from æ—¶é—´|æ—¥æœŸ) ç±»åž‹åŒ…æ‹¬ï¼š year month day hour minute second æˆªå–å¹´ 1select extract(year from sysdate) from dual; æˆªå–æœˆ 1select extract(month from sysdate); æˆªå–æ—¥ 1select extract(day from sysdate); æˆªå–æ—¶ æ–¹å¼ä¸€ï¼š 123select extract(hour from to_timestamp('2020-09-22 13:12:20', 'yyyy-mm-dd hh24:mi:ss'))from dual; æ–¹å¼äºŒï¼š 12select extract(hour from timestamp'2020-09-22 13:12:20') from dual; æˆªå–åˆ† 12select extract(minute from timestamp'2020-09-22 13:12:20)from dual; æˆªå–ç§’ 12select extract(second from timestamp'2020-09-22 13:12:20)from dual; æŸ¥è¯¢ 1981 å¹´å…¥èŒçš„å‘˜å·¥ 123select * from emp where extract(year from HIRE_DATE) = 1981; è½¬æ¢å‡½æ•°å­—ç¬¦ä¸²è½¬æˆæ—¥æœŸ to_date(åŽŸå€¼, â€˜æ ¼å¼â€™); å¹´ï¼šyyyyæœˆï¼šmmæ—¥ï¼šddæ—¶ï¼šhh è¡¨ç¤ºä½¿ç”¨12å°æ—¶åˆ¶ï¼Œhh24 è¡¨ç¤ºä½¿ç”¨24å°æ—¶åˆ¶åˆ†ï¼šmiç§’ï¼šss 123select to_date('2020-09-22', 'yyyy-mm-dd') from dual; select to_date('2020/09/22', 'yyyy/mm/dd') from dual;select to_date('09/22/2020', 'mm/dd/yyyy') from dual; å­—ç¬¦ä¸²è½¬æ—¶é—´ to_timestamp(åŽŸå€¼, â€˜æ ¼å¼â€™) 12select to_timestamp('2020-09-22 13:12:20', 'yyyy-mm-dd hh24:mi:ss')from dual; å…¶ä»–æ•°æ®ç±»åž‹è½¬æˆå­—ç¬¦ to_char(åŽŸå€¼, â€˜æ ¼å¼â€™) 12select to_char(sysdate, 'yyyy-mm-dd') from dual;select to_char(sysdate, 'yyyy/mm/dd') from dual; å°†å­—ç¬¦æ ¼å¼è½¬æˆæ•°å€¼æ ¼å¼ to_number(åŽŸå€¼, æ ¼å¼) oracleé‡Œé¢ï¼Œæ•°å€¼å ä½ç¬¦ä½¿ç”¨9 12select to number('$8,898,765', '$9,999,999')from dual; é€šç”¨å‡½æ•°ç©ºå¤„ç†å‡½æ•° nvl(åŽŸå€¼, æ›¿æ¢å€¼) å¦‚æžœåŽŸå€¼ä¸ºnullï¼Œé‚£ä¹ˆå°±è‡ªåŠ¨è½¬æˆæ›¿æ¢å€¼ï¼Œæ›¿æ¢å€¼çš„ç±»åž‹å¿…é¡»å’Œæ•°æ®è¡¨å­—æ®µå£°æ˜Žçš„å…¼å®¹ æŸ¥è¯¢å‘˜å·¥çš„å¥–é‡‘ï¼Œå¦‚æžœå¥–é‡‘ä¸º nullï¼Œé‚£ä¹ˆä¿®æ”¹ä¸º 0 1select ename, bonus, nvl(bonus, 0) from emp; nvl2(åŽŸå€¼, æ›¿æ¢å€¼1, æ›¿æ¢å€¼2) å¦‚æžœåŽŸå€¼ä¸ä¸ºç©ºï¼Œæ›¿æ¢æˆæ›¿æ¢å€¼1ï¼Œå¦åˆ™æ›¿æ¢æˆæ›¿æ¢å€¼2 æŸ¥è¯¢å‘˜å·¥çš„å¥–é‡‘ï¼Œå¦‚æžœå¥–é‡‘ä¸º null ï¼Œé‚£ä¹ˆä¿®æ”¹ä¸º 0ï¼Œä½¿ç”¨ nvl2 å®žçŽ° 1select ename, bonus, nvl2(bonus, bonus, 0) from dual; æ¡ä»¶å‡½æ•° decode(åŽŸå€¼, â€˜å€¼1â€™, â€˜ç¿»è¯‘å€¼1â€™, â€˜å€¼2â€™, â€˜ç¿»è¯‘å€¼2â€™, â€˜é»˜è®¤å€¼â€™) ä¸€ä¸ªæ ¹æ®å€¼æ¥åˆ¤æ–­è¾“å‡ºçš„ä¿¡æ¯ï¼›ç±»ä¼¼äºŽ if / else æŸ¥è¯¢å‘˜å·¥çš„å§“åå’Œå‘˜å·¥çš„éƒ¨é—¨ç¼–å·ï¼› å¦‚æžœç¼–å·ä¸º10ï¼Œè¿”å›žç»¼åˆéƒ¨ï¼Œå¦‚æžœç¼–å·ä¸º20ï¼Œè¿”å›žç ”å‘éƒ¨ï¼Œå¦‚æžœç¼–å·ä¸º30ï¼Œè¿”å›žé”€å”®éƒ¨ï¼Œå…¶ä»–è¿”å›žï¼ŒäººåŠ›èµ„æºéƒ¨ 12select ename decode(deptno, 10, 'ç»¼åˆéƒ¨', 20, 'ç ”å‘éƒ¨', 30, 'é”€å”®éƒ¨', 'äººåŠ›èµ„æºéƒ¨')from dual; æŸ¥è¯¢å‘˜å·¥çš„å¥–é‡‘ï¼Œå¦‚æžœå¥–é‡‘ä¸º nullï¼Œé‚£ä¹ˆä¿®æ”¹ä¸º â€˜æ²¡å¥–é‡‘â€™ 1select decode(comm, 'null', 'æ²¡å¥–é‡‘', bonus); å¤šè¡Œå‡½æ•° å¤šè¡Œå‡½æ•°ä¹Ÿå«èšåˆå‡½æ•° max()ï¼šæœ€å¤§å€¼ min()ï¼šæœ€å°å€¼ avg()ï¼šå¹³å‡å€¼ count()ï¼šç»Ÿè®¡ä¸ªæ•° sum()ï¼šæ±‚å’Œ]]></content>
      <categories>
        <category>æ•°æ®åº“</category>
        <category>Oracle</category>
      </categories>
      <tags>
        <tag>æ•°æ®åº“</tag>
        <tag>Oracle</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Defining Query Methodsè¯­æ³•]]></title>
    <url>%2F2020%2F09%2F22%2FSpringDataJpa%E7%9A%84DQM%E8%AF%AD%E6%B3%95%2F</url>
    <content type="text"><![CDATA[Defining Query MethodsSpring Data JPA çš„æ–¹æ³•åå®šä¹‰æŸ¥è¯¢æ–¹æ³• ï¼ˆ Defining Query Methods ï¼‰å¯ä»¥ä½¿è¯­ä¹‰æ›´åŠ æ¸…æ™°ï¼Œæå‡å¼€å‘æ•ˆçŽ‡ã€‚ DQM è¯­æ³•å…±æœ‰ 2 ç§ ç›´æŽ¥é€šè¿‡æ–¹æ³•åå®žçŽ° @Query æ‰‹åŠ¨åœ¨æ–¹æ³•ä¸Šå®šä¹‰ å®šä¹‰æŸ¥è¯¢æ–¹æ³•çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•è‹¥æƒ³è¦å®žçŽ° CRUD çš„æ“ä½œï¼Œå¸¸è§„åšæ³•æ˜¯å†™ä¸€å¤§å † SQL è¯­å¥ã€‚ä½†åœ¨ JPA é‡Œé¢ï¼Œåªéœ€è¦ç»§æ‰¿ Spring Data Common é‡Œé¢çš„ä»»æ„ Repository æŽ¥å£æˆ–è€…å­æŽ¥å£ï¼Œç„¶åŽç›´æŽ¥é€šè¿‡æ–¹æ³•åå°±å¯ä»¥å®žçŽ°ã€‚å…·ä½“ä½¿ç”¨æ­¥éª¤ï¼š User å®žä½“çš„ UserRepository ç»§æ‰¿ Spring Data Common é‡Œé¢çš„ Repository æŽ¥å£ 123public interface UserRepository extends CrudRepository&lt;User, Long&gt; &#123; User findByEmailAddress(String emailAddress);&#125; å¯¹äºŽ Service å±‚å°±å¯ä»¥ç›´æŽ¥ä½¿ç”¨ UserRepository æŽ¥å£ 12345678@Servicepublic class UserServiceImpl &#123; @Autowired private UserRepository userRepository; public void testJpa() &#123; userRepository.deleteAll(); userRepository.findAll(); userRepository.findByEmailAddress("zjk@126.com");&#125; è¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç›´æŽ¥è°ƒç”¨ CrudRepository é‡Œé¢æš´éœ²çš„æ‰€æœ‰æŽ¥å£æ–¹æ³•ï¼Œä»¥åŠ UserRepository é‡Œé¢å®šä¹‰çš„æ–¹æ³•ï¼Œä¸éœ€è¦å†™ä»»ä½• SQL è¯­å¥ï¼Œä¹Ÿä¸éœ€è¦å†™ä»»ä½•å®žçŽ°æ–¹æ³•ã€‚ é€‰æ‹©æ€§æš´éœ²æ–¹æ³•æœ‰æ—¶ä¸æƒ³æš´éœ² CrudRepository é‡Œé¢çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¯ä»¥ç›´æŽ¥ç»§æ‰¿æˆ‘ä»¬è®¤ä¸ºéœ€è¦æš´éœ²çš„é‚£äº›æ–¹æ³•çš„æŽ¥å£ã€‚ å‡å¦‚ UserRepository åªæƒ³æš´éœ² findOne å’Œ saveï¼Œé™¤äº†è¿™ä¸¤ä¸ªæ–¹æ³•ä¹‹å¤–ä¸å…è®¸ä»»ä½•çš„ User æ“ä½œï¼Œå…¶åšæ³•å¦‚ä¸‹ï¼š é€‰æ‹©æ€§åœ°æš´éœ² CRUD æ–¹æ³•ï¼Œç›´æŽ¥ç»§æ‰¿Repositoryï¼ˆå› ä¸ºè¿™é‡Œé¢æ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼‰ï¼ŒæŠŠCrudRepository é‡Œé¢çš„ save å’Œ findOne æ–¹æ³•å¤åˆ¶åˆ°æˆ‘ä»¬è‡ªå·±çš„ MyBaseRepository æŽ¥å£å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678@NoRepositoryBeaninterface MyBaseRepository&lt;T, ID extends Serializable&gt; extends Repository&lt;T, ID&gt; &#123; T findOne(ID id); T save(T entity);&#125;interface UserRepository extends MyBaseRepository&lt;User, Long&gt; &#123; User findByEmailAddress(String emailAddress);&#125; è¿™æ ·åœ¨ Service å±‚å°±åªæœ‰ findOneã€saveã€findByEmailAddress è¿™ 3 ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨ï¼Œä¸ä¼šæœ‰æ›´å¤šæ–¹æ³•äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ SimpleJpaRepository é‡Œé¢ä»»æ„å·²ç»å®žçŽ°çš„æ–¹æ³•åšé€‰æ‹©æ€§æš´éœ²ã€‚ ç»¼ä¸Šæ‰€è¿°ï¼Œå¾—å‡ºä»¥ä¸‹ 2 ç‚¹ç»“è®ºï¼š MyRepository Extends Repository æŽ¥å£å¯ä»¥å®žçŽ° Defining Query Methods çš„åŠŸèƒ½ï¼› ç»§æ‰¿å…¶ä»– Repository çš„å­æŽ¥å£ï¼Œæˆ–è€…è‡ªå®šä¹‰å­æŽ¥å£ï¼Œå¯ä»¥é€‰æ‹©æ€§åœ°æš´éœ² SimpleJpaRepository é‡Œé¢å·²ç»å®žçŽ°çš„åŸºç¡€å…¬ç”¨æ–¹æ³•ã€‚ æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½®é¸¡è‚‹ã€‚ã€‚ é€šè¿‡ @EnableJpaRepositories æ³¨è§£æ¥é…ç½®æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥ï¼Œè¯¦ç»†é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š 1@EnableJpaRepositories(queryLookupStrategy= QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND) QueryLookupStrategy.Key çš„å€¼å…± 3 ä¸ªï¼Œå…·ä½“å¦‚ä¸‹ï¼š Createï¼šç›´æŽ¥æ ¹æ®æ–¹æ³•åè¿›è¡Œåˆ›å»ºï¼Œè§„åˆ™æ˜¯æ ¹æ®æ–¹æ³•åç§°çš„æž„é€ è¿›è¡Œå°è¯•ï¼Œä¸€èˆ¬çš„æ–¹æ³•æ˜¯ä»Žæ–¹æ³•åä¸­åˆ é™¤ç»™å®šçš„ä¸€ç»„å·²çŸ¥å‰ç¼€ï¼Œå¹¶è§£æžè¯¥æ–¹æ³•çš„å…¶ä½™éƒ¨åˆ†ã€‚å¦‚æžœæ–¹æ³•åä¸ç¬¦åˆè§„åˆ™ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç†è§£ä¸ºï¼Œå³ä½¿é…ç½®äº† @Query ä¹Ÿæ˜¯æ²¡æœ‰ç”¨çš„ã€‚ USE_DECLARED_QUERYï¼šå£°æ˜Žæ–¹å¼åˆ›å»ºï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šå°è¯•æ‰¾åˆ°ä¸€ä¸ªå£°æ˜Žçš„æŸ¥è¯¢ï¼Œå¦‚æžœæ²¡æœ‰æ‰¾åˆ°å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¯ä»¥ç†è§£ä¸ºå¿…é¡»é…ç½® @Queryã€‚ CREATE_IF_NOT_FOUNDï¼šè¿™ä¸ªæ˜¯==é»˜è®¤çš„==ï¼Œé™¤éžæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ä»¥ä¸Š 2 ç§æ–¹å¼çš„å…¼å®¹ç‰ˆã€‚å…ˆç”¨å£°æ˜Žæ–¹å¼ï¼ˆ@Queryï¼‰è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æžœæ²¡æœ‰æ‰¾åˆ°ä¸Žæ–¹æ³•ç›¸åŒ¹é…çš„æŸ¥è¯¢ï¼Œé‚£ç”¨ Create çš„æ–¹æ³•ååˆ›å»ºè§„åˆ™åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢ï¼›è¿™ä¸¤è€…éƒ½ä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å°±ä¼šæŠ¥é”™ã€‚ ä»¥ Spring Boot é¡¹ç›®ä¸ºä¾‹ï¼Œæ›´æ”¹å…¶é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š 123456@EnableJpaRepositories(queryLookupStrategy= QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND)public class Example1Application &#123; public static void main(String[] args) &#123; SpringApplication.run(Example1Application.class, args); &#125;&#125; Defining Query Method è¯­æ³• å¸¦æŸ¥è¯¢åŠŸèƒ½çš„æ–¹æ³•åï¼šæŸ¥è¯¢ç­–ç•¥ï¼ˆå…³é”®å­—ï¼‰+ æŸ¥è¯¢å­—æ®µ + ä¸€äº›é™åˆ¶æ€§æ¡ä»¶ å…·æœ‰è¯­ä¹‰æ¸…æ™°ã€åŠŸèƒ½å®Œæ•´çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å®žé™…å·¥ä½œä¸­ 80% çš„ API æŸ¥è¯¢éƒ½å¯ä»¥ç®€å•å®žçŽ°ã€‚ ä¸¾ä¾‹è¯´æ˜Žï¼š 1234567891011121314interface PersonRepository extends Repository&lt;User, Long&gt; &#123; // and çš„æŸ¥è¯¢å…³ç³» List&lt;User&gt; findByEmailAddressAndLastname(EmailAddress emailAddress, String lastname); // åŒ…å« distinct åŽ»é‡ï¼Œor çš„ sql è¯­æ³• List&lt;User&gt; findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname); // æ ¹æ® lastname å­—æ®µæŸ¥è¯¢å¿½ç•¥å¤§å°å†™ List&lt;User&gt; findByLastnameIgnoreCase(String lastname); // æ ¹æ® lastname å’Œ firstname æŸ¥è¯¢ equal å¹¶ä¸”å¿½ç•¥å¤§å°å†™ List&lt;User&gt; findByLastnameAndFirstnameAllIgnoreCase(String lastname, String firstname); // å¯¹æŸ¥è¯¢ç»“æžœæ ¹æ® lastname æŽ’åºï¼Œæ­£åº List&lt;User&gt; findByLastnameOrderByFirstnameAsc(String lastname); // å¯¹æŸ¥è¯¢ç»“æžœæ ¹æ® lastname æŽ’åºï¼Œå€’åº List&lt;User&gt; findByLastnameOrderByFirstnameDesc(String lastname);&#125; å¸¸ç”¨çš„å…³é”®å­—åˆ—è¡¨ Keyword Sample JPQL snippet And findByLastnameAndFirstname â€¦ where x.lastname = ?1 and x.firstname = ?2 Or findByLastnameOrFirstname â€¦ where x.lastname = ?1 or x.firstname = ?2 Is, Equals findByFirstname findByFirstnameIs findByFirstnameEquals â€¦ where x.firstname = ?1 Between findByStartDateBetween â€¦ where x.startDate between ?1 and ?2 LessThan findByAgeLessThan â€¦ where x.age &lt; ?1 LessThanEqual findByAgeLessThanEqual â€¦ where x.age &lt;= ?1 GreaterThan findByAgeGreaterThan â€¦ where x.age &gt; ?1 GreaterThanEqual findByAgeGreaterThanEqual â€¦ where x.age &gt;= ?1 After findByStartDateAfter â€¦ where x.startDate &gt; ?1 Before findByStartDateBefore â€¦ where x.startDate &lt; ?1 IsNull, Null findByAge(Is)Null â€¦ where x.age is null IsNotNull, NotNull findByAge(Is)NotNull â€¦ where x.age not null Like findByFirstnameLike â€¦ where x.firstname like ?1 NotLike findByFirstnameNotLike â€¦ where x.firstname not like ?1 StartingWith findByFirstnameStartingWith â€¦ where x.firstname like ?1 (parameter bound with appended %) EndingWith findByFirstnameEndingWith â€¦ where x.firstname like ?1 (parameter bound with prepended %) Containing findByFirstnameContaining â€¦ where x.firstname like ?1 (parameter bound wrapped in %) OrderBy findByAgeOrderByLastnameDesc â€¦ where x.age = ?1 order by x.lastname desc Not findByLastnameNot â€¦ where x.lastname &lt;&gt; ?1 In findByAgeIn(Collection&lt;Age&gt; ages) â€¦ where x.age in ?1 NotIn findByAgeNotIn(Collection&lt;Age&gt; ages) â€¦ where x.age not in ?1 True findByActiveTrue() â€¦ where x.active = true False findByActiveFalse() â€¦ where x.active = false IgnoreCase findByFirstnameIgnoreCase â€¦ where UPPER(x.firstame) = UPPER(?1) ç»¼ä¸Šï¼Œæ€»ç»“ 3 ç‚¹ç»éªŒï¼š æ–¹æ³•åçš„è¡¨è¾¾å¼é€šå¸¸æ˜¯å®žä½“å±žæ€§è¿žæŽ¥è¿ç®—ç¬¦çš„ç»„åˆï¼Œå¦‚ Andã€orã€Betweenã€LessThanã€GreaterThanã€Like ç­‰å±žæ€§è¿žæŽ¥è¿ç®—è¡¨è¾¾å¼ï¼Œä¸åŒçš„æ•°æ®åº“ï¼ˆNoSQLã€MySQLï¼‰å¯èƒ½äº§ç”Ÿçš„æ•ˆæžœä¸ä¸€æ ·ï¼Œå¦‚æžœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æ‰“å¼€ SQL æ—¥å¿—è§‚å¯Ÿã€‚ IgnoreCase å¯ä»¥é’ˆå¯¹å•ä¸ªå±žæ€§ï¼ˆå¦‚ findByLastnameIgnoreCase(â€¦)ï¼‰ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹æŸ¥è¯¢æ¡ä»¶é‡Œé¢æ‰€æœ‰çš„å®žä½“å±žæ€§å¿½ç•¥å¤§å°å†™ï¼ˆæ‰€æœ‰å±žæ€§å¿…é¡»åœ¨ String æƒ…å†µä¸‹ï¼Œå¦‚ findByLastnameAndFirstnameAllIgnoreCase(â€¦)ï¼‰ã€‚ OrderBy å¯ä»¥åœ¨æŸäº›å±žæ€§çš„æŽ’åºä¸Šæä¾›æ–¹å‘ï¼ˆAsc æˆ– Descï¼‰ï¼Œç§°ä¸ºé™æ€æŽ’åºï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªæ–¹ä¾¿çš„å‚æ•° Sort å®žçŽ°æŒ‡å®šå­—æ®µçš„åŠ¨æ€æŽ’åºçš„æŸ¥è¯¢æ–¹æ³•ï¼ˆå¦‚ repository.findAll(Sort.by(Sort.Direction.ASC, â€œmyFieldâ€))ï¼‰ã€‚ ä¸Šè¿°è¡¨æ ¼è™½ç„¶å¤§å¤šæ˜¯ find å¼€å¤´çš„æ–¹æ³•ï¼Œä½†å…¶å®ž JPA è¿˜æ”¯æŒ readã€getã€queryã€streamã€countã€existsã€deleteã€remove ç­‰å‰ç¼€ï¼Œå¦‚å­—é¢æ„æ€ä¸€æ ·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ countã€deleteã€remove çš„ä¾‹å­ï¼Œå…¶ä»–å‰ç¼€å¯ä»¥ä¸¾ä¸€åä¸‰ã€‚å®žä¾‹ä»£ç å¦‚ä¸‹ï¼š 12345678interface UserRepository extends CrudRepository&lt;User, Long&gt; &#123; // æŸ¥è¯¢æ€»æ•° long countByLastname(String lastname); // æ ¹æ®ä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ é™¤æ“ä½œï¼Œå¹¶è¿”å›žåˆ é™¤è¡Œæ•° long deleteByLastname(String lastname); // æ ¹æ® Lastname åˆ é™¤ä¸€å † Userï¼Œå¹¶è¿”å›žåˆ é™¤çš„ User List&lt;User&gt; removeByLastname(String lastname);&#125; å…³é”®å­—éƒ½å®šä¹‰åœ¨ä¸‹é¢ä¸¤ä¸ªç±»é‡Œé¢ 12org.springframework.data.repository.query.parser.PartTreeorg.springframework.data.repository.query.parser.Part çœ‹æºç å°±å¯ä»¥çŸ¥é“æ¡†æž¶æ”¯æŒäº†å“ªäº›é€»è¾‘å…³é”®å­—ï¼Œæ¯”å¦‚ NotInã€Likeã€Inã€Exists ç­‰ï¼Œæœ‰çš„æ—¶å€™æ¯”æŸ¥æ–‡æ¡£å’Œä»»ä½•äººå†™çš„åšå®¢éƒ½å‡†ç¡®ã€è¿˜å¿«ã€‚ Sort æŽ’åºå’Œ Pageable åˆ†é¡µSort åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥å®žçŽ°åŠ¨æ€æŽ’åº 123public Sort(Direction direction, String... properties) &#123; this(direction, properties == null ? new ArrayList&lt;&gt;() : Arrays.asList(properties));&#125; Sort é‡Œé¢å†³å®šäº†æˆ‘ä»¬å“ªäº›å­—æ®µçš„æŽ’åºæ–¹å‘ï¼ˆASC æ­£åºã€DESC å€’åºï¼‰ Pageable åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥å®žçŽ°åˆ†é¡µæ•ˆæžœå’ŒåŠ¨æ€æŽ’åºåŒé‡æ•ˆæžœ Pageable çš„ Structureï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ–¹æ³•ä¸€ï¼šPageå…è®¸å°† org.springframework.data.domain.Pageable å®žä¾‹ä¼ é€’ç»™æŸ¥è¯¢æ–¹æ³•ï¼Œå°†åˆ†é¡µå‚æ•°æ·»åŠ åˆ°é™æ€å®šä¹‰çš„æŸ¥è¯¢ä¸­ï¼Œé€šè¿‡ Page è¿”å›žçš„ç»“æžœå¾—çŸ¥å¯ç”¨çš„å…ƒç´ å’Œé¡µé¢çš„æ€»æ•°ã€‚ è¿™ç§åˆ†é¡µæŸ¥è¯¢æ–¹æ³•å¯èƒ½æ˜¯æ˜‚è´µçš„ï¼ˆä¼šé»˜è®¤æ‰§è¡Œä¸€æ¡ count çš„ SQL è¯­å¥ï¼‰ï¼Œæ‰€ä»¥ç”¨çš„æ—¶å€™è¦è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨åœºæ™¯ã€‚ 1Page&lt;User&gt; findByLastname(String lastname, Pageable pageable); æ–¹æ³•äºŒï¼šSliceè¿”å›žç»“æžœæ˜¯ Sliceï¼Œå› ä¸ºåªçŸ¥é“æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ª Slice å¯ç”¨ï¼Œè€Œä¸çŸ¥é“ countï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¾ƒå¤§çš„ç»“æžœé›†æ—¶ï¼ŒåªçŸ¥é“æ•°æ®æ˜¯è¶³å¤Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨åœ¨ä¸šåŠ¡åœºæ™¯ä¸­æ—¶ä¸ç”¨å…³å¿ƒä¸€å…±æœ‰å¤šå°‘é¡µã€‚ 1Slice&lt;User&gt; findByLastname(String lastname, Pageable pageable); æ–¹æ³•ä¸‰ï¼šListå¦‚æžœåªéœ€è¦æŽ’åºï¼Œéœ€åœ¨ org.springframework.data.domain.Sort å‚æ•°ä¸­æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œæ­£å¦‚ä¸Šé¢çœ‹åˆ°çš„ï¼Œåªéœ€è¿”å›žä¸€ä¸ª List ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚ 1List&lt;User&gt; findByLastname(String lastname, Sort sort); æŽ’åºé€‰é¡¹ä¹Ÿé€šè¿‡ Pageable å®žä¾‹å¤„ç†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPage å°†ä¸ä¼šåˆ›å»ºæž„å»ºå®žé™…å®žä¾‹æ‰€éœ€çš„é™„åŠ å…ƒæ•°æ®ï¼ˆå³ä¸éœ€è¦è®¡ç®—å’ŒæŸ¥è¯¢åˆ†é¡µç›¸å…³æ•°æ®ï¼‰ï¼Œè€Œä»…ä»…ç”¨æ¥åšé™åˆ¶æŸ¥è¯¢ç»™å®šèŒƒå›´çš„å®žä½“ã€‚ 1List&lt;User&gt; findByLastname(String lastname, Pageable pageable); PageRequest é‡Œé¢æä¾›çš„å‡ ä¸ª of é™æ€æ–¹æ³•ï¼ˆå¤šæ€ï¼‰ï¼Œåˆ†åˆ«æž„å»ºé¡µç ã€é¡µé¢å¤§å°ã€æŽ’åºç­‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678//æŸ¥è¯¢useré‡Œé¢çš„lastname=jkçš„ç¬¬ä¸€é¡µï¼Œæ¯é¡µå¤§å°æ˜¯20æ¡ï¼›å¹¶ä¼šè¿”å›žä¸€å…±æœ‰å¤šå°‘é¡µçš„ä¿¡æ¯Page&lt;User&gt; users = userRepository.findByLastname("jk", PageRequest.of(1, 20));//æŸ¥è¯¢useré‡Œé¢çš„lastname=jkçš„ç¬¬ä¸€é¡µçš„20æ¡æ•°æ®ï¼Œä¸çŸ¥é“ä¸€å…±å¤šå°‘æ¡Slice&lt;User&gt; users = userRepository.findByLastname("jk", PageRequest.of(1, 20));//æŸ¥è¯¢å‡ºæ¥æ‰€æœ‰çš„useré‡Œé¢çš„lastname=jkçš„Useræ•°æ®ï¼Œå¹¶æŒ‰ç…§nameæ­£åºè¿”å›žListList&lt;User&gt; users = userRepository.findByLastname("jk", new Sort(Sort.Direction.ASC, "name"))//æŒ‰ç…§createdAtå€’åºï¼ŒæŸ¥è¯¢å‰ä¸€ç™¾æ¡Useræ•°æ®List&lt;User&gt; users = userRepository.findByLastname("jk", PageRequest.of(0, 100, Sort.Direction.DESC, "createdAt")); é™åˆ¶æŸ¥è¯¢ç»“æžœ First å’Œ Topæœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³ç›´æŽ¥æŸ¥è¯¢å‰å‡ æ¡æ•°æ®ï¼Œä¹Ÿä¸éœ€è¦åŠ¨æ€æŽ’åºï¼Œé‚£ä¹ˆå°±å¯ä»¥ç®€å•åœ°åœ¨æ–¹æ³•åå­—ä¸­ä½¿ç”¨ First å’Œ Top å…³é”®å­—ï¼Œæ¥é™åˆ¶è¿”å›žæ¡æ•°ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ userRepository é‡Œé¢å®šä¹‰çš„ä¸€äº›é™åˆ¶è¿”å›žç»“æžœçš„ä½¿ç”¨ã€‚åœ¨æŸ¥è¯¢æ–¹æ³•ä¸ŠåŠ é™åˆ¶æŸ¥è¯¢ç»“æžœçš„å…³é”®å­— First å’Œ Topã€‚ 12345User findFirstByOrderByLastnameAsc();User findTopByOrderByAgeDesc();List&lt;User&gt; findDistinctUserTop3ByLastname(String lastname, Pageable pageable);List&lt;User&gt; findFirst10ByLastname(String lastname, Sort sort);List&lt;User&gt; findTop10ByLastname(String lastname, Pageable pageable); å…¶ä¸­ï¼š æŸ¥è¯¢æ–¹æ³•åœ¨ä½¿ç”¨ First æˆ– Top æ—¶ï¼Œæ•°å€¼å¯ä»¥è¿½åŠ åˆ° First æˆ– Top åŽé¢ï¼ŒæŒ‡å®šè¿”å›žæœ€å¤§ç»“æžœçš„å¤§å°ï¼› å¦‚æžœæ•°å­—è¢«çœç•¥ï¼Œåˆ™å‡è®¾ç»“æžœå¤§å°ä¸º 1ï¼› é™åˆ¶è¡¨è¾¾å¼ä¹Ÿæ”¯æŒ Distinct å…³é”®å­—ï¼› å¦‚æžœå°† Pageable ä½œä¸ºå‚æ•°ï¼Œä»¥ Top å’Œ First åŽé¢çš„æ•°å­—ä¸ºå‡†ï¼Œå³åˆ†é¡µå°†åœ¨é™åˆ¶ç»“æžœä¸­åº”ç”¨ã€‚ @NonNullã€@NonNullApiã€@Nullableä»Ž Spring Data 2.0 å¼€å§‹ï¼ŒJPA æ–°å¢žäº†@NonNull @NonNullApi @Nullableï¼Œæ˜¯å¯¹ null çš„å‚æ•°å’Œè¿”å›žç»“æžœåšçš„æ”¯æŒã€‚ @NonNullApiï¼šåœ¨åŒ…çº§åˆ«ç”¨äºŽå£°æ˜Žå‚æ•°ï¼Œä»¥åŠè¿”å›žå€¼çš„é»˜è®¤è¡Œä¸ºæ˜¯ä¸æŽ¥å—æˆ–äº§ç”Ÿç©ºå€¼çš„ã€‚ @NonNullï¼šç”¨äºŽä¸èƒ½ä¸ºç©ºçš„å‚æ•°æˆ–è¿”å›žå€¼ï¼ˆåœ¨ @NonNullApi é€‚ç”¨çš„å‚æ•°å’Œè¿”å›žå€¼ä¸Šä¸éœ€è¦ï¼‰ã€‚ @Nullableï¼šç”¨äºŽå¯ä»¥ä¸ºç©ºçš„å‚æ•°æˆ–è¿”å›žå€¼ã€‚ æˆ‘åœ¨è‡ªå·±çš„ Repository æ‰€åœ¨ package çš„ package-info.java ç±»é‡Œé¢åšå¦‚ä¸‹å£°æ˜Žï¼š 12@org.springframework.lang.NonNullApipackage com.myrespository; myRepository ä¸‹é¢çš„ UserRepository å®žçŽ°å¦‚ä¸‹ï¼š 1234package com.myrespository; interface UserRepository extends Repository&lt;User, Long&gt; &#123; User getByEmailAddress(EmailAddress emailAddress); &#125; è¿™ä¸ªæ—¶å€™å½“ emailAddress å‚æ•°ä¸º null çš„æ—¶å€™å°±ä¼šæŠ›å¼‚å¸¸ï¼Œå½“è¿”å›žç»“æžœä¸º null çš„æ—¶å€™ä¹Ÿä¼šæŠ›å¼‚å¸¸ã€‚å› ä¸ºæˆ‘ä»¬åœ¨package çš„ package-info.javaé‡Œé¢æŒ‡å®šäº† NonNullApiï¼Œæ‰€æœ‰è¿”å›žç»“æžœå’Œå‚æ•°ä¸èƒ½ä¸º Nullã€‚ 12345//å½“æˆ‘ä»¬æ·»åŠ  @Nullable æ³¨è§£ä¹‹åŽï¼Œå‚æ•°å’Œè¿”å›žç»“æžœè¿™ä¸ªæ—¶å€™å°±éƒ½ä¼šå…è®¸ä¸º null äº†ï¼›@NullableUser findByEmailAddress(@Nullable EmailAddress emailAdress);//è¿”å›žç»“æžœå…è®¸ä¸º nullï¼Œå‚æ•°ä¸å…è®¸ä¸º null çš„æƒ…å†µOptional&lt;User&gt; findOptionalByEmailAddress(EmailAddress emailAddress); æ€è€ƒåœ¨å®žé™…å·¥ä½œä¸­ï¼Œä¹Ÿå¯ä»¥å°†æ–¹æ³•åï¼ˆéžå¸¸è¯­ä¹‰åŒ–çš„ repository é‡Œé¢æ‰€å®šä¹‰æ–¹æ³•å‘½åè§„èŒƒï¼‰çš„å¼ºåˆ¶çº¦å®šè§„èŒƒè¿ç”¨åˆ° controller å’Œ service å±‚ï¼Œè¿™æ ·å…¨éƒ¨ç»Ÿä¸€åŽï¼Œå¯ä»¥å‡å°‘å¾ˆå¤šçš„æ²Ÿé€šæˆæœ¬ã€‚Spring Data Common é‡Œé¢çš„ repository åŸºç±»ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥åº”ç”¨æŽ¨å¹¿åˆ° service å±‚å‘¢ï¼Ÿèƒ½å¦ä¹Ÿå»ºç«‹ä¸€ä¸ªè‡ªå·±çš„ baseServiceï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„å®žæˆ˜ä¾‹å­ï¼š 123456789101112131415161718192021222324252627public interface BaseService&lt;T, ID&gt; &#123; Class&lt;T&gt; getDomainClass(); &lt;S extends T&gt; S save(S entity); &lt;S extends T&gt; List&lt;S&gt; saveAll(Iterable&lt;S&gt; entities); void delete(T entity); void deleteById(ID id); void deleteAll(); void deleteAll(Iterable&lt;? extends T&gt; entities); void deleteInBatch(Iterable&lt;T&gt; entities); void deleteAllInBatch(); T getOne(ID id); &lt;S extends T&gt; Optional&lt;S&gt; findOne(Example&lt;S&gt; example); Optional&lt;T&gt; findById(ID id); List&lt;T&gt; findAll(); List&lt;T&gt; findAll(Sort sort); Page&lt;T&gt; findAll(Pageable pageable); &lt;S extends T&gt; List&lt;S&gt; findAll(Example&lt;S&gt; example); &lt;S extends T&gt; List&lt;S&gt; findAll(Example&lt;S&gt; example, Sort sort); &lt;S extends T&gt; Page&lt;S&gt; findAll(Example&lt;S&gt; example, Pageable pageable); List&lt;T&gt; findAllById(Iterable&lt;ID&gt; ids); long count(); &lt;S extends T&gt; long count(Example&lt;S&gt; example); &lt;S extends T&gt; boolean exists(Example&lt;S&gt; example); boolean existsById(ID id); void flush(); &lt;S extends T&gt; S saveAndFlush(S entity);&#125; æˆ‘ä»¬æ¨¡ä»¿ JpaRepository æŽ¥å£ä¹Ÿè‡ªå®šä¹‰äº†ä¸€ä¸ªè‡ªå·±çš„ BaseServiceï¼Œå£°æ˜Žäº†å¸¸ç”¨çš„ CRUDæ“ä½œã€‚å½“ç„¶äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥å»ºç«‹è‡ªå·±çš„ PagingAndSortingServiceã€ComplexityServiceã€SampleService ç­‰æ¥åˆ’åˆ†ä¸åŒçš„ serviceæŽ¥å£ï¼Œä¾›ä¸åŒç›®çš„ Service å­ç±»ç»§æ‰¿ã€‚ æˆ‘ä»¬å†æ¥æ¨¡ä»¿ä¸€ä¸ª SimpleJpaRepositoryï¼Œæ¥å®žçŽ°è‡ªå·±çš„ BaseService çš„å®žçŽ°ç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116public class BaseServiceImpl&lt;T, ID, R extends JpaRepository&lt;T, ID&gt;&gt; implements BaseService&lt;T, ID&gt; &#123; private static final Map&lt;Class, Class&gt; DOMAIN_CLASS_CACHE = new ConcurrentHashMap&lt;&gt;(); private final R repository; public BaseServiceImpl(R repository) &#123; this.repository = repository; &#125; @Override public Class&lt;T&gt; getDomainClass() &#123; Class thisClass = getClass(); Class&lt;T&gt; domainClass = DOMAIN_CLASS_CACHE.get(thisClass); if (Objects.isNull(domainClass)) &#123; domainClass = GenericsUtils.getGenericClass(thisClass, 0); DOMAIN_CLASS_CACHE.putIfAbsent(thisClass, domainClass); &#125; return domainClass; &#125; protected R getRepository() &#123; return repository; &#125; @Override public &lt;S extends T&gt; S save(S entity) &#123; return repository.save(entity); &#125; @Override public &lt;S extends T&gt; List&lt;S&gt; saveAll(Iterable&lt;S&gt; entities) &#123; return repository.saveAll(entities); &#125; @Override public void delete(T entity) &#123; repository.delete(entity); &#125; @Override public void deleteById(ID id) &#123; repository.deleteById(id); &#125; @Override public void deleteAll() &#123; repository.deleteAll(); &#125; @Override public void deleteAll(Iterable&lt;? extends T&gt; entities) &#123; repository.deleteAll(entities); &#125; @Override public void deleteInBatch(Iterable&lt;T&gt; entities) &#123; repository.deleteInBatch(entities); &#125; @Override public void deleteAllInBatch() &#123; repository.deleteAllInBatch(); &#125; @Override public T getOne(ID id) &#123; return repository.getOne(id); &#125; @Override public &lt;S extends T&gt; Optional&lt;S&gt; findOne(Example&lt;S&gt; example) &#123; return repository.findOne(example); &#125; @Override public Optional&lt;T&gt; findById(ID id) &#123; return repository.findById(id); &#125; @Override public List&lt;T&gt; findAll() &#123; return repository.findAll(); &#125; @Override public List&lt;T&gt; findAll(Sort sort) &#123; return repository.findAll(sort); &#125; @Override public Page&lt;T&gt; findAll(Pageable pageable) &#123; return repository.findAll(pageable); &#125; @Override public &lt;S extends T&gt; List&lt;S&gt; findAll(Example&lt;S&gt; example) &#123; return repository.findAll(example); &#125; @Override public &lt;S extends T&gt; List&lt;S&gt; findAll(Example&lt;S&gt; example, Sort sort) &#123; return repository.findAll(example, sort); &#125; @Override public &lt;S extends T&gt; Page&lt;S&gt; findAll(Example&lt;S&gt; example, Pageable pageable) &#123; return repository.findAll(example, pageable); &#125; @Override public List&lt;T&gt; findAllById(Iterable&lt;ID&gt; ids) &#123; return repository.findAllById(ids); &#125; @Override public long count() &#123; return repository.count(); &#125; @Override public &lt;S extends T&gt; long count(Example&lt;S&gt; example) &#123; return repository.count(example); &#125; @Override public &lt;S extends T&gt; boolean exists(Example&lt;S&gt; example) &#123; return repository.exists(example); &#125; @Override public boolean existsById(ID id) &#123; return repository.existsById(id); &#125; @Override public void flush() &#123; repository.flush(); &#125; @Override public &lt;S extends T&gt; S saveAndFlush(S entity) &#123; return repository.saveAndFlush(entity); &#125;&#125; ä»¥ä¸Šä»£ç å°±æ˜¯ BaseService å¸¸ç”¨çš„ CURL å®žçŽ°ä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œé¢å¤§éƒ¨åˆ†ä¹Ÿæ˜¯ç›´æŽ¥è°ƒç”¨ Repository æä¾›çš„æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç»§æ‰¿ BaseServiceImpl çš„æ—¶å€™éœ€è¦ä¼ é€’è‡ªå·±çš„ Repositoryï¼Œå¦‚ä¸‹é¢å®žä¾‹ä»£ç ï¼š 1234567@Servicepublic class UserServiceImpl extends BaseServiceImpl&lt;User, Long, UserRepository&gt; implements UserService &#123; public UserServiceImpl(UserRepository repository) &#123; super(repository); &#125; .....&#125;]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>Defining Query Methods</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PlantUMLè¯­æ³•]]></title>
    <url>%2F2020%2F09%2F21%2FPlantUML%E8%AF%AD%E6%B3%95%2F</url>
    <content type="text"><![CDATA[PlantUMLè¯­æ³•å®‰è£…å®˜æ–¹ç«™ç‚¹ éœ€è¦ java çŽ¯å¢ƒã€‚ éœ€è¦å®‰è£… Graphviz ä¾èµ– ä¸‹è½½ plantuml ä½¿ç”¨ IDEA æ¥åˆ›å»ºå’Œé¢„è§ˆ ä¸‹è½½ IDEA ç¼–è¾‘å™¨ æ‰“å¼€ Plugins æœç´¢ â€œplantumlâ€ï¼Œé€‰ä¸­ PlantUML integrationï¼Œç‚¹å‡»å®‰è£…å³å¯ é…ç½® PlantUML è„šæœ¬è¯­æ³•puml æ˜¯è„šæœ¬è¯­è¨€ï¼Œæ˜¯æŒ‰ç…§æ¢è¡Œæ¥è¯†åˆ«è¯­æ³•çš„ã€‚ ä¸€èˆ¬çš„è¡¨è¾¾è¯­å¥ä¸º: èŠ‚ç‚¹ è¿žæŽ¥ç¬¦å· èŠ‚ç‚¹ å…³é”®å­— èŠ‚ç‚¹æˆ–å†…å®¹ 123å¼€å§‹å…³é”®å­— å†…å®¹ç»“æŸå…³é”®å­— æ³¨æ„ç©ºæ ¼ç­‰éžå­—ç¬¦ä½œä¸ºèŠ‚ç‚¹å†…å®¹çš„ä½¿ç”¨ï¼Œæœ‰äº›å¤šå…³é”®å­—è¯­å¥ä¸­éœ€è¦ä½¿ç”¨åŒå¼•å·æ¥åŒ…å«å¸¦ç©ºæ ¼çš„è¯­å¥ æ´»åŠ¨å›¾ ( Activity Diagram )Simple Activityè¯­æ³•æ˜¯ : èŠ‚ç‚¹ ; ç»“æŸ 12345@startumltitle act_new_1:æ­¥éª¤ä¸€;:æ­¤å¤„æœ‰ä¸ªæ”¯æŒç®€å•çš„ mark è¯­æ³• **åŠ ç²—å­—ä½“**;@enduml Start / Stop å¼€å§‹å’Œç»“æŸå¼€å§‹ä½ç½®ä¸º start å¼€å§‹ï¼Œstop åœæ­¢ï¼Œend ç»“æŸ 1234567@startumltitle act_new_2start:æ­¥éª¤ä¸€;:mark è¯­æ³• **åŠ ç²—å­—ä½“**;stop@enduml Conditional æ¡ä»¶è¯­å¥æŽ§åˆ¶è¯­å¥çš„ä½¿ç”¨ï¼Œæ³¨æ„å†…å®¹ () çš„ä½¿ç”¨ 1234567891011@startumltitle act_new_3startif (æ˜¯å¦å·²ä¸‹è½½ graphviz?) then (æ˜¯) :æ‰§è¡Œ \ndiagrams;else (å¦) :éœ€è¦ä¸‹è½½ graphviz åŽæ‰èƒ½æ‰§è¡Œ __activity__ diagrams;endifstop@enduml Repeat loop å¾ªçŽ¯å¤„ç†ï¼ˆæŽ§åˆ¶è¯­å¥ï¼‰ä½¿ç”¨å…³é”®å­— repeatï¼Œrepeat while () æ¥å®žçŽ° 123456789@startumltitle act_new_4startrepeat :è¯»å–æ–‡ä»¶; :ç¼–è¯‘ diagrams;repeat while (æ›´å¤šï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ª?)stop@enduml While loop å¾ªçŽ¯æŽ§åˆ¶ä½¿ç”¨ while endwhile å¾ªçŽ¯æŽ§åˆ¶ 123456789@startumltitle act_new_5startwhile (æ‰§è¡Œæ¡ä»¶å…è®¸æ–‡ä»¶å­˜åœ¨?) :è¯»å–æ–‡ä»¶; :ç¼–è¯‘ diagrams;endwhilestop@enduml å¯ä»¥è¿½åŠ æ ‡ç­¾ 1234567891011@startumltitle act_new_6start:æ‰“å¼€æ–‡ä»¶;while (æ£€æŸ¥æ–‡ä»¶å¤§å° ?) is (æœ‰å†…å®¹) :è¯»å–æ–‡ä»¶; :ç¼–è¯‘ dia;endwhile (ç©º):å…³é—­æ–‡ä»¶;end@enduml Parallel processing å¹¶è¡Œå¤„ç†ä½¿ç”¨ fork å…³é”®å­—åˆ›å»ºå¹¶è¡Œå¤„ç† 1234567891011121314@startumltitle act_new_7startif (multiprocessor?) then (yes) fork :Treatment 1; fork again :Treatment 2; end forkelse (monoproc) :Treatment 1; :Treatment 2;endif@enduml Notes æ³¨é‡Š å•è¡Œæ³¨é‡Šä½¿ç”¨ note right|left å†…å®¹ï¼Œæ³¨æ„åŽé¢æ²¡æœ‰åˆ†å· å¤šè¡Œæ³¨é‡Šä½¿ç”¨ note right|left æ¢è¡Œ å†…å®¹ æ¢è¡Œ end noteçš„æ–¹å¼å¤„ç† 12345678910111213141516@startumltitle act_new_8start: æ­¥éª¤1;note left: This is a __NOTE__: æ­¥éª¤2;note right æ”¯æŒ mark ç¼–è¾‘è¯­æ³• This note is on several //lines// and can contain &lt;b&gt;HTML&lt;/b&gt; ==== * Calling the method &quot;&quot;foo()&quot;&quot; is prohibitedend notestop@enduml æ³¨æ„ mark å¹¶éž Markdown è¯­æ³•ï¼Œä»¥æ¡ˆä¾‹ä¸º b Color é¢œè‰²åœ¨å†’å·é’±å¯ä»¥è¿½åŠ  #åå…­è¿›åˆ¶ çš„é¢œè‰²ç¼–å·æˆ–è€…åç§° 123456789@startumltitle act_new_9start:è¿›ç¨‹å¼€å§‹;#red:è¯•ç€è¯»å–æ–‡ä»¶æ–‡ä»¶å¿…é¡»æœ‰å¯å†™æƒé™!;#AAAAAA:ç»“æŸè¿›ç¨‹;stop@enduml Complete example æ¡ˆä¾‹1234567891011121314151617181920212223242526272829303132@startumltitle act_new_10start:ClickServlet.handleRequest();:new page;if (Page.onSecurityCheck) then (true) #7c7c7c:Page.onInit(); if (isForward?) then (no) #red:Process controls; if (continue processing?) then (no) stop endif if (isPost?) then (yes) :Page.onPost(); else (no) :Page.onGet(); endif :Page.onRender(); endifelse (false)endifif (do redirect?) then (yes) :redirect process;else if (do forward?) then (yes) :Forward request; else (no) :Render page template; endifendifstop@enduml æ—¶åºå›¾ ( Sequence Diagram )åŸºæœ¬è¯­æ³• ä½¿ç”¨ èŠ‚ç‚¹ -&gt; èŠ‚ç‚¹: æè¿° -&gt; ä¸ºå®žçº¿ å¦‚æžœä½¿ç”¨è™šçº¿åˆ™ ç”¨ --&gt; ç®­å¤´çš„æ–¹å‘å¯ä»¥æ˜¯åŒå‘çš„ èŠ‚ç‚¹ &lt;-- èŠ‚ç‚¹ 1234567@startumltitle seq_1ç”¨æˆ· -&gt; å¹³å°: å‘é€ç™»å½•è¯·æ±‚å¹³å° --&gt; ç”¨æˆ·: éªŒè¯é€šè¿‡ç”¨æˆ· -&gt; å¹³å°: å¦ä¸€ä¸ªè¯·æ±‚ç”¨æˆ· &lt;-- å¹³å°: è¿”å›žéªŒè¯æ¶ˆæ¯@enduml Comments æ³¨é‡Šå†…éƒ¨æ³¨é‡Šä½¿ç”¨ &#39; å•å¼•å·æ¥å¼€å§‹ å•è¡Œæ³¨é‡Šï¼Œ å¤šè¡Œæ³¨é‡Šåˆ™ä½¿ç”¨ /&#39; å’Œ &#39;/ åŒ…æ‹¬ Declaring participant ï¼ˆè§’è‰²ï¼‰æä¾›äº†çš„å£°æ˜Žå‚åŠ è€… (è§’è‰²)ï¼Œæ¥ä¸°å¯Œå›¾å½¢ï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨ç®­å¤´ä¸¤è¾¹çš„å·²ç»éšå¼å£°æ˜Žäº†( participant )ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ participant èŠ‚ç‚¹ æ¥æ˜¾ç¤ºå£°æ˜Žè§’è‰²ï¼Œè¿™ç§çŠ¶å†µä¸»è¦æ˜¯ä¸ºäº†å£°æ˜Žè§’è‰²çš„é¡ºåºã€‚ actor boundary control entity database 123456789101112@startumltitle seq_2actor Foo1boundary Foo2control Foo3entity Foo4database Foo5Foo1 -&gt; Foo2 : To boundaryFoo1 -&gt; Foo3 : To controlFoo1 -&gt; Foo4 : To entityFoo1 -&gt; Foo5 : To database@enduml è¿½åŠ è‰²å½©æ¡ˆä¾‹ 1234567891011121314151617@startumltitle seq_3actor å®¢æˆ· #red&apos; å£°æ˜Žè§’è‰²çš„æ—¶å€™åœ¨åŽé¢å¯ä»¥è¿½åŠ é¢œè‰²&apos; æ³¨é‡Šå†…å®¹å¹¶ä¸ä¼šæ˜¾ç¤º&apos; The only difference between actor&apos; and participant is the drawingparticipant æœåŠ¡ç«¯participant &quot;I have a really\nlong name&quot; as L #99FF99/&apos; è¿™é‡Œä½¿ç”¨ `as` å…³é”®å­—å£°æ˜Žäº† L æ¥ä½œä¸ºåˆ«å ä½ ä¹Ÿå¯ä»¥è¿™æ ·å†™: participant L as &quot;I have a really\nlong name&quot; #99FF99 &apos;/æœåŠ¡ç«¯-&gt;å®¢æˆ·: è¯·æ±‚è®¤è¯å®¢æˆ·-&gt;æœåŠ¡ç«¯: Authentication Responseå®¢æˆ·-&gt;L: Log transaction@enduml Use non-letters in participants éžå­—ç¬¦å¤„ç†åœ¨å£°æ˜Žéžå­—æ¯çš„è§’è‰²çš„æ—¶å€™ä½¿ç”¨åŒå¼•å·å¤„ç† (åŒ…å«ç©ºæ ¼) 12345678@startumltitle seq_4æœåŠ¡ç«¯ -&gt; &quot;å®¢æˆ·()&quot; : Hello&quot;å®¢æˆ·()&quot; -&gt; &quot;This is very\nlong&quot; as Long&apos; You can also declare:&apos; &quot;å®¢æˆ·()&quot; -&gt; Long as &quot;This is very\nlong&quot;Long --&gt; &quot;å®¢æˆ·()&quot; : ok@enduml Message to Selfåœ¨ä»‹ç»è¿‡é•¿çš„å†…å®¹çš„æ—¶å€™ä½¿ç”¨ \n æ¥æ¢è¡Œ 1234@startumltitle seq_5æœåŠ¡ç«¯-&gt;æœåŠ¡ç«¯: This is a signal to self.\nIt also demonstrates\nmultiline \ntext@enduml Change arrow style ç®­å¤´æ ·å¼åœ¨æ—¶åºå›¾ä¸­å¯ä»¥ä½¿ç”¨å¤šç§æ ·å¼ï¼ŒåŸºäºŽä¸‹é¢çš„æ¡ˆä¾‹ï¼Œæ¥æ›¿æ¢é»˜è®¤çš„ç®­å¤´ æ€»ä½“æ¥è¯´ - è¡¨ç¤ºå®žçº¿ï¼Œ -- æ ‡è¯†è™šçº¿è€Œåœ¨åœ¨ä¸¤è¾¹çš„æ ‡è¯†ç®­å¤´çš„æ–¹å‘å’Œæ ·å¼ 123456789101112@startumltitle seq_6å®¢æˆ· -&gt; æœåŠ¡ç«¯å®¢æˆ· -&gt;&gt; æœåŠ¡ç«¯å®¢æˆ· -\ æœåŠ¡ç«¯å®¢æˆ· \\- æœåŠ¡ç«¯å®¢æˆ· //-- æœåŠ¡ç«¯å®¢æˆ· -&gt;o æœåŠ¡ç«¯å®¢æˆ· o\\-- æœåŠ¡ç«¯å®¢æˆ· &lt;-&gt; æœåŠ¡ç«¯å®¢æˆ· &lt;-&gt;o æœåŠ¡ç«¯@enduml Change arrow color ç®­å¤´è‰²å½©ä½¿ç”¨å…³é”®å­— autonumber æ¥è‡ªåŠ¨ä¸ºæ¶ˆæ¯ç”Ÿæˆç´¢å¼•æ•°å­— 123456@startumltitle seq_8autonumberå®¢æˆ· -&gt; æœåŠ¡ç«¯ : è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Authentication Response@enduml åœ¨ autonumber åŽå¯ä»¥è®¾å®š å¼€å§‹ä½ç½® æ¢¯åº¦ å‚æ•°åœ¨é»˜è®¤æƒ…å†µä¸‹ autonumber è‡ªåŠ¨è¿½åŠ äº† start å‚æ•°ï¼Œ åœ¨ä½¿ç”¨ stop å‚æ•°å¯ä»¥åœæ­¢è®¡æ•° 1234567891011121314@startumltitle seq_9autonumberå®¢æˆ· -&gt; æœåŠ¡ç«¯ : è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Authentication Responseautonumber stopå®¢æˆ· &lt;- æœåŠ¡ç«¯ : åœæ­¢autonumber 15å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Another è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Another authentication Responseautonumber 40 10å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Yet another è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Yet another authentication Response@enduml ä½ ä¹Ÿå¯ä»¥å¯¹æ•°å­—è¿›è¡Œæ ¼å¼åŒ–è¾“å‡ºï¼Œä¸º autonumber è¿½åŠ æ ¼å¼åŒ–ä½¿ç”¨å•å¼•å· &quot;æ ¼å¼&quot; ï¼Œå†…éƒ¨å¯ä»¥ä½¿ç”¨ HTML æ ‡è®°ï¼Œå¯ä»¥å‚çœ‹åŽé¢çš„ Formatting using HTML 123456789101112@startumltitle seq_10autonumber &quot;&lt;b&gt;[000]&lt;/b&gt;&quot;å®¢æˆ· -&gt; æœåŠ¡ç«¯ : è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Authentication Responseautonumber 15 &quot;&lt;b&gt;(&lt;u&gt;###&lt;/u&gt;)&quot;å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Another è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Another authentication Responseautonumber 40 10 &quot;&lt;font color=red&gt;&lt;b&gt;Message 0 &quot;å®¢æˆ· -&gt; æœåŠ¡ç«¯ : Yet another è¯·æ±‚è®¤è¯å®¢æˆ· &lt;- æœåŠ¡ç«¯ : Yet another authentication Response@enduml Splitting diagrams åˆ†å‰²ä¸ºå¤šä¸ªå›¾å½¢å…³é”®å­— newpage å¯ä»¥å°†åŒä¸€å¼ å›¾å½¢åˆ†å‰²ä¸ºå¤šä¸ªå›¾ï¼Œå¯ä»¥è¿½åŠ  æ ‡é¢˜å‚æ•° 1234567891011@startumltitle seq_11æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 1æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 2newpageæœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 3æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 4newpage ç¬¬ä¸‰ç« çš„æ ‡é¢˜\næœ€åŽä¸€é¡µæœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 5æœåŠ¡ç«¯ -&gt; å®¢æˆ· : message 6@enduml Grouping message åˆ†ç»„æ¶ˆæ¯æä¾›äº†ä¸€ä¸‹å‡ ç»„å…³é”®è¯ alt/else opt loop par break critical group, followed by a text to be displayed å…³é”®è¯åŽå¯ä»¥è¿½åŠ æ–‡æœ¬ï¼Œæ¥ä½œä¸ºå‰¯æ ‡é¢˜ä½¿ç”¨ end å…³é”®è¯æ¥è¡¨ç¤ºç»“æŸ 123456789101112131415161718@startumltitle seq_12æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯alt æˆåŠŸ å®¢æˆ· -&gt; æœåŠ¡ç«¯: è®¸å¯è®¤è¯else å¯è¯†åˆ«çš„æ­£å¸¸å¤±è´¥ å®¢æˆ· -&gt; æœåŠ¡ç«¯: è®¤è¯å¤±è´¥ group ç»„åç§° æœåŠ¡ç«¯ -&gt; æ—¥å¿—: attack start loop 1000 times æœåŠ¡ç«¯ -&gt; å®¢æˆ·: DNS Attack end æœåŠ¡ç«¯ -&gt; æ—¥å¿—: Log attack end endelse å…¶ä»–å¤±è´¥ å®¢æˆ· -&gt; æœåŠ¡ç«¯: é‡æ–°è¯·æ±‚end@enduml Notes on messageså•è¡Œæ³¨é‡Š12note right: å³ä¾§çš„å†…å®¹note left: å³ä¾§çš„å†…å®¹ å¤šè¡Œæ³¨é‡Š123note right:å¤šè¡Œå†…å®¹end note 12345678910111213@startumltitle seq_13æœåŠ¡ç«¯-&gt;å®¢æˆ· : hellonote left: this is a first noteå®¢æˆ·-&gt;æœåŠ¡ç«¯ : oknote right: this is another noteå®¢æˆ·-&gt;å®¢æˆ· : I am thinkingnote left a note can also be defined on several linesend note@enduml Some other notesofï¼Œover åŽè·Ÿä¸Šè§’è‰²ï¼ˆå‚ä¸Žè€…ï¼‰ï¼Œå¯ä»¥ç®¡ç†ï¼Œå…¶ä¸­ over å¯ä»¥è¦†ç›–åœ¨çº¿ä¸Š 1234567891011121314151617@startumltitle seq_14participant æœåŠ¡ç«¯participant å®¢æˆ·note left of æœåŠ¡ç«¯ #aqua æ˜¾ç¤º å·¦ä¾§ of æœåŠ¡ç«¯.end notenote right of æœåŠ¡ç«¯: æ˜¾ç¤ºåœ¨å³ä¾§ of æœåŠ¡ç«¯.note over æœåŠ¡ç«¯: over æ³¨é‡Šè¦†ç›–åœ¨æœåŠ¡ç«¯.note over æœåŠ¡ç«¯, å®¢æˆ· #FFAAAA: æ³¨é‡Š\n è¦†ç›–åœ¨ å®¢æˆ· å’Œ æœåŠ¡ç«¯.note over å®¢æˆ·, æœåŠ¡ç«¯ This is yet another example of a long note.end note@enduml Formatting using HTMLä½¿ç”¨ç±» html-tagï¼š &lt;b&gt; æ¥åŠ ç²—å­—ä½“ &lt;u&gt; or &lt;u:#AAAAAA&gt; or &lt;u:colorName&gt; è¾“å‡ºä¸‹åˆ’çº¿ &lt;i&gt; æ–œä½“å­—è¾“å‡º &lt;s&gt; or &lt;s:#AAAAAA&gt; or &lt;s:colorName&gt; for strike text &lt;w&gt; or&lt;w:#AAAAAA&gt;or&lt;w:colorName&gt;` for wave underline text &lt;color:#AAAAAA&gt; or &lt;color:colorName&gt; &lt;back:#AAAAAA&gt; or &lt;back:colorName&gt; for background color `size:nn to change font size &lt;img src=&quot;file&quot;&gt; or &lt;img:file&gt; : the file must be accessible by the filesystem &lt;img src=&quot;http://url&quot;&gt; or &lt;img:http://url&gt; : the URL must be available from the Internet example 1234567891011121314151617@startumltitle seq_15participant æœåŠ¡ç«¯participant &quot;The &lt;b&gt;Famous&lt;/b&gt; å®¢æˆ·&quot; as å®¢æˆ·æœåŠ¡ç«¯ -&gt; å®¢æˆ· : A &lt;i&gt;well formated&lt;/i&gt; messagenote right of æœåŠ¡ç«¯ This is &lt;back:cadetblue&gt;&lt;size:18&gt;displayed&lt;/size&gt;&lt;/back&gt; &lt;u&gt;left of&lt;/u&gt; æœåŠ¡ç«¯.end notenote left of å®¢æˆ· &lt;u:red&gt;This&lt;/u&gt; is &lt;color #118888&gt;displayed&lt;/color&gt; &lt;b&gt;&lt;color purple&gt;left of&lt;/color&gt; &lt;s:red&gt;æœåŠ¡ç«¯&lt;/strike&gt; å®¢æˆ·&lt;/b&gt;.end notenote over æœåŠ¡ç«¯, å®¢æˆ· &lt;w:#FF33FF&gt;This is hosted&lt;/w&gt; by &lt;img http://s.plantuml.com/logoc.png&gt;end note@enduml DividerIf you want, you can split a diagram using == separator to divide your diagram into logical steps 123456789@startumltitle seq_16== Initialisation ==æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯å®¢æˆ· --&gt; æœåŠ¡ç«¯: Authentication Response== Repetition ==æœåŠ¡ç«¯ -&gt; å®¢æˆ·: Another è¯·æ±‚è®¤è¯æœåŠ¡ç«¯ &lt;-- å®¢æˆ·: another authentication Response@enduml ReferenceYou can use reference in a diagram, using the keyword ref over 1234567891011@startumltitle seq_17participant æœåŠ¡ç«¯actor å®¢æˆ·ref over æœåŠ¡ç«¯, å®¢æˆ· : initæœåŠ¡ç«¯ -&gt; å®¢æˆ· : helloref over å®¢æˆ· This can be on several linesend ref@enduml DelayYou can use â€¦ to indicate a delay in the diagram. And it is also possible to put a message with this delay. 12345678@startumltitle seq_18æœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯...å®¢æˆ· --&gt; æœåŠ¡ç«¯: Authentication Response...5 minutes latter...å®¢æˆ· --&gt; æœåŠ¡ç«¯: Bye !@enduml Spaceå¯¹æ¶ˆæ¯ä½¿ç”¨ç©ºè¡Œ |||ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰åƒç´ é«˜åº¦ ||æ•°å­—|| 1234567891011@startumltitle seq_19æœåŠ¡ç«¯ -&gt; å®¢æˆ·: message 1å®¢æˆ· --&gt; æœåŠ¡ç«¯: ok|||æœåŠ¡ç«¯ -&gt; å®¢æˆ·: message 2å®¢æˆ· --&gt; æœåŠ¡ç«¯: ok||45||æœåŠ¡ç«¯ -&gt; å®¢æˆ·: message 3å®¢æˆ· --&gt; æœåŠ¡ç«¯: ok@enduml Lifeline Activation and Destruction ç”Ÿå‘½å‘¨æœŸä½¿ç”¨ activate è§’è‰² è¡¨ç¤ºå¼€å§‹ç”Ÿå‘½å‘¨æœŸï¼Œä½¿ç”¨ destory è§’è‰² æ ‡è¯†ç»“æŸå‘¨æœŸ å¼€å§‹å’Œç»“æŸå¿…é¡»æˆå¯¹çš„å­˜åœ¨ 12345678910111213141516@startumltitle seq_20participant UserUser -&gt; A: DoWorkactivate AA -&gt; B: &lt;&lt; createRequest &gt;&gt;activate BB -&gt; C: DoWorkactivate CC --&gt; B: WorkDonedestroy CB --&gt; A: RequestCreateddeactivate BA -&gt; User: Donedeactivate A@enduml ä¸ºè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ ‡è®°è‰²å½© ï¼Œå¯ä»¥è¿½åŠ è‰²å½©å‚æ•°ï¼Œ åœ¨ plantuml ä¸­è‰²å½©ä½¿ç”¨ #åå…­è¿›åˆ¶çš„è‰²å½©å€¼ æ¥è¡¨ç¤º 123456789101112131415@startumltitle seq_21participant UserUser -&gt; A: DoWorkactivate A #FFBBBBA -&gt; A: Internal callactivate A #DarkSalmonA -&gt; B: &lt;&lt; createRequest &gt;&gt;activate BB --&gt; A: RequestCreateddeactivate Bdeactivate AA -&gt; User: Donedeactivate A@enduml Participant creationYou can use the create keyword just before the first reception of a message to emphasize the fact that this message is actually creating this new object 123456789@startumlå®¢æˆ· -&gt; æœåŠ¡ç«¯ : hellocreate OtheræœåŠ¡ç«¯ -&gt; Other : newcreate control StringæœåŠ¡ç«¯ -&gt; Stringnote right : You can also put notes!æœåŠ¡ç«¯ --&gt; å®¢æˆ· : ok@enduml Incoming and outgoing messagesYou can use incoming or outgoing arrows if you want to focus on a part of the diagram. Use square brackets to denotate the left â€œ[â€œ or the right â€œ]â€ side of the diagram. 1234567891011@startuml[-&gt; A: DoWorkactivate AA -&gt; A: Internal callactivate AA -&gt;] : &lt;&lt; createRequest &gt;&gt;A&lt;--] : RequestCreateddeactivate A[&lt;- A: Donedeactivate A@enduml Stereotypes and SpotsIt is possible to add stereotypes to participants using &lt;&lt; and &gt;&gt;. In the stereotype, you can add a spotted character in a colored circle using the syntax (X,color) 12345@startumlparticipant &quot;Famous å®¢æˆ·&quot; as å®¢æˆ· &lt;&lt; Generated &gt;&gt;participant æœåŠ¡ç«¯ &lt;&lt; (C,#ADD1B2) Testable &gt;&gt;å®¢æˆ·-&gt;æœåŠ¡ç«¯: First message@enduml æˆ–è€… 12345@startumlparticipant å®¢æˆ· &lt;&lt; (C,#ADD1B2) &gt;&gt;participant æœåŠ¡ç«¯ &lt;&lt; (C,#ADD1B2) &gt;&gt;å®¢æˆ·-&gt;æœåŠ¡ç«¯: First message@enduml More information on titlesYou can use some HTML tags in the title. 12345@startumltitle &lt;u&gt;Simple&lt;/u&gt; communication exampleæœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯å®¢æˆ· -&gt; æœåŠ¡ç«¯: Authentication Response@enduml You can add newline using \n in the title description. 12345@startumltitle &lt;u&gt;Simple&lt;/u&gt; communication example\non several linesæœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯å®¢æˆ· -&gt; æœåŠ¡ç«¯: Authentication Response@enduml You can also define title on several lines using title and end title keywords. 123456789101112@startumltitle &lt;u&gt;Simple&lt;/u&gt; communication example on &lt;i&gt;several&lt;/i&gt; lines and using &lt;font color=red&gt;html&lt;/font&gt; This is hosted by &lt;img:sourceforge.jpg&gt;end titleæœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯å®¢æˆ· -&gt; æœåŠ¡ç«¯: Authentication Response@enduml 7.22. Participants engloberIt is possible to draw a box arround some participants, using box and end box commands. You can add an optional title or a optional background color, after the box keyword. 123456789@startumlbox &quot;Internal Service&quot; #LightBlue participant å®¢æˆ· participant æœåŠ¡ç«¯end boxparticipant Otherå®¢æˆ· -&gt; æœåŠ¡ç«¯ : helloæœåŠ¡ç«¯ -&gt; Other : hello@enduml 7.23. Removing FooterYou can use the hide footbox keywords to remove the footer of the diagram. 12345@startumlhide footboxtitle Footer removedæœåŠ¡ç«¯ -&gt; å®¢æˆ·: è¯·æ±‚è®¤è¯å®¢æˆ· --&gt; æœåŠ¡ç«¯: Authentication Response @enduml Skinparam You can use the skinparam command to change colors and fonts for the drawing. You can use this command : In the diagram definition, like any other commands, In an included file, In a configuration file, provided in the command line or the ANT task. 1234567891011121314151617181920212223242526272829303132333435363738394041424344@startumlskinparam backgroundColor #EEEBDCskinparam sequence &#123; ArrowColor DeepSkyBlue ActorBorderColor DeepSkyBlue LifeLineBorderColor blue LifeLineBackgroundColor #A9DCDF ParticipantBorderColor DeepSkyBlue ParticipantBackgroundColor DodgerBlue ParticipantFontName Impact ParticipantFontSize 17 ParticipantFontColor #A9DCDF ActorBackgroundColor aqua ActorFontColor DeepSkyBlue ActorFontSize 17 ActorFontName Aapex&#125;actor Userparticipant &quot;First Class&quot; as Aparticipant &quot;Second Class&quot; as Bparticipant &quot;Last Class&quot; as CUser -&gt; A: DoWorkactivate AA -&gt; B: Create Requestactivate BB -&gt; C: DoWorkactivate CC --&gt; B: WorkDonedestroy CB --&gt; A: Request Createddeactivate BA --&gt; User: Donedeactivate A@enduml å‚è€ƒèµ„æ–™PlantUMLè¯­æ³• PlantUMLè¯­æ³•]]></content>
      <categories>
        <category>UML</category>
      </categories>
      <tags>
        <tag>UML</tag>
        <tag>plantuml</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç»Ÿä¸€å»ºæ¨¡è¯­è¨€(UML)]]></title>
    <url>%2F2020%2F09%2F19%2FUML%2F</url>
    <content type="text"><![CDATA[ç»Ÿä¸€å»ºæ¨¡è¯­è¨€(UML)ä»€ä¹ˆæ˜¯æ¨¡åž‹æ¨¡åž‹æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„å®Œæ•´çš„æŠ½è±¡ã€‚äººä»¬å¯¹æŸä¸ªé¢†åŸŸç‰¹å®šé—®é¢˜çš„æ±‚è§£åŠè§£å†³æ–¹æ¡ˆï¼Œå¯¹å®ƒä»¬çš„ç†è§£å’Œè®¤è¯†éƒ½è•´å«åœ¨æ¨¡åž‹ä¸­ã€‚é€šå¸¸ï¼Œå¼€å‘ä¸€ä¸ªè®¡ç®—æœºç³»ç»Ÿæ˜¯ä¸ºäº†è§£å†³æŸä¸ªé¢†åŸŸç‰¹å®šé—®é¢˜ï¼Œé—®é¢˜çš„æ±‚è§£è¿‡ç¨‹ï¼Œå°±æ˜¯ä»Žé¢†åŸŸé—®é¢˜åˆ°è®¡ç®—æœºç³»ç»Ÿçš„æ˜ å°„ã€‚ ä¸ºä»€ä¹ˆè¦å»ºé€ æ¨¡åž‹ å»ºé€ ä¼ ç»Ÿæ¨¡åž‹çš„ç›®çš„ ä¸ºäº†è¯æ˜ŽæŸä»¶äº‹ç‰©èƒ½å¦å·¥ä½œ å‰æï¼šå»ºé€ æ¨¡åž‹çš„æˆæœ¬è¿œè¿œä½ŽäºŽå»ºé€ å®žç‰©çš„æˆæœ¬ é€ é£žæœº é€ é«˜æ¥¼ å»ºé€ è½¯ä»¶æ¨¡åž‹çš„ç›®çš„ ä¸ºäº†ä¸Žä»–äººæ²Ÿé€š ä¸ºäº†ä¿å­˜è½¯ä»¶è®¾è®¡çš„æœ€ç»ˆæˆæžœ å‰æï¼šé™¤éžæ¨¡åž‹æ¯”ä»£ç æ›´è¯´æ˜Žé—®é¢˜ é€šç”¨æ¨¡åž‹å…ƒç´ æ¨¡åž‹å…ƒç´ æ˜¯UMLæž„é€ ç³»ç»Ÿçš„å„ç§å…ƒç´ ï¼Œæ˜¯UMLæž„å»ºæ¨¡åž‹çš„åŸºæœ¬å•ä½ã€‚ åŸºå…ƒç´ æ˜¯ç”±UMLå®šä¹‰çš„æ¨¡åž‹å…ƒç´ ï¼Œå¦‚ï¼šç±»ã€ç»“ç‚¹ã€æž„ä»¶ã€æ³¨é‡Šã€å…³è”ã€ä¾èµ–å’Œæ³›åŒ–(ç»§æ‰¿)ç­‰ å…³è”å…³ç³»åˆ†ç±»ï¼š æ³›åŒ–(ç»§æ‰¿) - ç±»ä¸Žç±»ï¼ŒæŽ¥å£ä¸ŽæŽ¥å£çš„å…³ç³» å®žçŽ° - æ˜¯ä¸€ç§ç±»ä¸ŽæŽ¥å£çš„å…³ç³» ç»„åˆ - æ˜¯æ•´ä½“ä¸Žéƒ¨åˆ†ï¼Œæ˜¯â€œhas-aâ€å…³ç³»ï¼Œä½†éƒ¨åˆ†ä¸èƒ½ç¦»å¼€æ•´ä½“è€Œå•ç‹¬å­˜åœ¨ å…¬å¸å’Œéƒ¨é—¨æ˜¯æ•´ä½“å’Œéƒ¨åˆ†çš„å…³ç³»ï¼Œæ²¡æœ‰å…¬å¸å°±ä¸å­˜åœ¨éƒ¨é—¨ ä¹Ÿæ˜¯ä¸€ç§å…³è”å…³ç³»ï¼Œæ¯”èšåˆæ›´å¼ºå…³è” èšåˆ - æ˜¯æ•´ä½“ä¸Žéƒ¨åˆ†ï¼Œæ˜¯â€œcontains-aâ€å…³ç³»ï¼Œä¸”éƒ¨åˆ†å¯ä»¥ç¦»å¼€æ•´ä½“è€Œå•ç‹¬å­˜åœ¨ è½¦å’Œè½®èƒŽæ˜¯æ•´ä½“å’Œéƒ¨åˆ†çš„å…³ç³»ï¼Œè½®èƒŽç¦»å¼€è½¦ä»ç„¶å¯ä»¥å­˜åœ¨ ä¹Ÿæ˜¯ä¸€ç§å…³è”å…³ç³»ï¼Œæ˜¯å¼ºå…³è” å…³è” - æ˜¯ä¸€ç§æ‹¥æœ‰çš„å…³ç³»ï¼Œå®ƒä½¿ä¸€ä¸ªç±»çŸ¥é“å¦ä¸€ä¸ªç±»çš„å±žæ€§å’Œæ–¹æ³•ï¼Œ [ä»£ç è¡¨çŽ°] æˆå‘˜å˜é‡ ä¾èµ– - æ˜¯ä¸€ç§ä½¿ç”¨çš„å…³ç³»ï¼Œå³ä¸€ä¸ªç±»çš„å®žçŽ°éœ€è¦å¦ä¸€ä¸ªç±»çš„ååŠ©ï¼Œå°½é‡ä¸è¦åŒå‘ä¾èµ– [ä»£ç è¡¨çŽ°] å±€éƒ¨å˜é‡ã€æ–¹æ³•çš„å‚æ•°æˆ–è€…å¯¹é™æ€æ–¹æ³•çš„è°ƒç”¨ å„ç§å…³ç³»çš„å¼ºå¼±é¡ºåºï¼š æ³›åŒ– = å®žçŽ° &gt; ç»„åˆ &gt; èšåˆ &gt; å…³è” &gt; ä¾èµ– æž„é€ åž‹å…ƒç´ åœ¨åŸºå…ƒç´ çš„åŸºç¡€ä¸Šå¢žåŠ äº†æ–°çš„å®šä¹‰è€Œæž„é€ çš„æ–°çš„æ¨¡åž‹å…ƒç´ ï¼Œå…è®¸ç”¨æˆ·è‡ªå®šä¹‰ æž„é€ åž‹å…ƒç´ ç”¨æ‹¬åœ¨åŒå°–æ‹¬å·ã€Š ã€‹ä¸­çš„å­—ç¬¦ä¸²è¡¨ç¤º ç›®å‰UMLæä¾›äº†40å¤šä¸ªé¢„å®šä¹‰çš„æž„é€ åž‹å…ƒç´ ï¼Œå¦‚åŒ…å«ã€Šincludeã€‹ã€æ‰©å±•ã€Š Extend ã€‹ ä»€ä¹ˆæ˜¯UMLæ˜¯ä¸€ç§å¯¹è½¯ä»¶ç³»ç»Ÿ(æž¶æž„)è¿›è¡Œ==å¯è§†åŒ–å»ºæ¨¡==çš„è¯­è¨€ï¼Œä»¥å›¾å½¢çš„æ–¹å¼æè¿°äº†è½¯ä»¶çš„æ¦‚å¿µã€‚ UMLæœ‰ä»€ä¹ˆä½œç”¨ æè¿°æŸä¸ªé—®é¢˜é¢†åŸŸ æè¿°æž„æ€ä¸­çš„è½¯ä»¶è®¾è®¡ æè¿°å·²ç»å®Œæˆçš„è½¯ä»¶å®žçŽ° UMLå›¾çš„åˆ†ç±»é™æ€å›¾ é€šè¿‡æè¿°ç±»ã€å¯¹è±¡å’Œæ•°æ®ç»“æž„ä»¥åŠå®ƒä»¬ä¹‹é—´å­˜åœ¨çš„å…³ç³»ï¼Œæ¥æè¿°è½¯ä»¶è¦ç´ ä¸­ä¸å˜çš„é€»è¾‘ç»“æž„ã€‚ ç”¨ä¾‹å›¾ï¼ˆUse Case Diagramsï¼‰å¯¹è±¡å›¾ï¼ˆObject Diagramsï¼‰ç±»å›¾ï¼ˆClass Diagramsï¼‰ç»„ä»¶å›¾ï¼ˆComponent Diagramsï¼‰åŒ…å›¾ï¼ˆPackage Diagramsï¼‰éƒ¨ç½²å›¾ï¼ˆDeployment Diagramsï¼‰åŠ¨æ€å›¾ é€šè¿‡æç»˜æ‰§è¡Œæµç¨‹æˆ–è€…å®žä½“çŠ¶æ€å˜åŒ–çš„æ–¹å¼ï¼Œæ¥å±•ç¤ºè½¯ä»¶å®žä½“åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å˜åŒ–è¿‡ç¨‹ã€‚ åä½œå›¾ï¼ˆCollaboration Diagramsï¼‰åºåˆ—å›¾ï¼ˆSequence Diagramsï¼‰æ´»åŠ¨å›¾ï¼ˆActivity Diagramsï¼‰çŠ¶æ€å›¾ï¼ˆState Diagramsï¼‰]]></content>
      <categories>
        <category>æž¶æž„</category>
        <category>UML</category>
      </categories>
      <tags>
        <tag>æž¶æž„</tag>
        <tag>UML</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é¢å‘å¯¹è±¡è®¾è®¡åŽŸåˆ™]]></title>
    <url>%2F2020%2F09%2F16%2F%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99%2F</url>
    <content type="text"><![CDATA[é¢å‘å¯¹è±¡è®¾è®¡åŽŸåˆ™é¢å‘å¯¹è±¡è®¾è®¡ï¼ˆOODï¼šObject Oriented Designï¼‰çš„å…­å¤§è®¾è®¡åŽŸåˆ™ ç¼©å†™ è‹±æ–‡åç§° ä¸­æ–‡åç§° SRP Single Responsibility Principle å•ä¸€èŒè´£åŽŸåˆ™ OCP Open Close Principle å¼€é—­åŽŸåˆ™ LSP Liskov Substitution Principle é‡Œæ°æ›¿æ¢åŽŸåˆ™ ISP Interface Segregation Principle æŽ¥å£åˆ†ç¦»åŽŸåˆ™ DIP Dependency Inversion Principle ä¾èµ–å€’ç½®åŽŸåˆ™ LoD Law of Demeter ï¼ˆ Least Knowledge Principleï¼‰ è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆæœ€å°‘çŸ¥é“åŽŸåˆ™ï¼‰ å‰äº”ä¸ªè®¾è®¡åŽŸåˆ™å°±æ˜¯é€šå¸¸æ‰€è¯´çš„SOLIDï¼ˆä¸Šæ–¹è¡¨æ ¼ç¼©å†™çš„é¦–å­—æ¯ï¼Œä»Žä¸Šåˆ°ä¸‹ï¼‰ å¼€é—­åŽŸåˆ™ ( OCP )å®šä¹‰ ðŸ“Œ Software entities (classes, modules, functions, etc.) should be open for extension, but closed for modification. å³ï¼šä¸€ä¸ªè½¯ä»¶å®žä½“å¦‚ç±»ã€æ¨¡å—å’Œå‡½æ•°ç­‰åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ ä¸éœ€è¦ä¿®æ”¹è½¯ä»¶å®žä½“ï¼ˆç±»ã€æ¨¡å—ã€å‡½æ•°ç­‰ï¼‰ï¼Œå°±åº”è¯¥èƒ½å®žçŽ°åŠŸèƒ½çš„æ‰©å±• ä¼˜ç‚¹å¯ä»¥åœ¨ä¸æ”¹åŠ¨åŽŸæœ‰ä»£ç çš„å‰æä¸‹ç»™ç¨‹åºæ‰©å±•åŠŸèƒ½ã€‚å¢žåŠ äº†ç¨‹åºçš„å¯æ‰©å±•æ€§ï¼ŒåŒæ—¶ä¹Ÿé™ä½Žäº†ç¨‹åºçš„ç»´æŠ¤æˆæœ¬ã€‚ å®žçŽ°çš„æ–¹æ³•å…³é”®æ˜¯æŠ½è±¡ï¼Œé€šè¿‡å®žçŽ°é¢„å…ˆè®¾ç½®å¥½çš„æŠ½è±¡çš„æŽ¥å£ï¼ˆæŠ½è±¡ç±»ï¼‰æ¥å®žçŽ°æ–°çš„åŠŸèƒ½ã€‚ ç­–ç•¥æ¨¡å¼ ( Strategy Pattern )å®šä¹‰è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“ä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚ ä¼˜ç‚¹ ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è¯­å¥ ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç³»åˆ—çš„å¯ä¾›é‡ç”¨çš„ç®—æ³•æ—ï¼Œæ°å½“ä½¿ç”¨ç»§æ‰¿å¯ä»¥æŠŠç®—æ³•æ—çš„å…¬å…±ä»£ç è½¬ç§»åˆ°çˆ¶ç±»é‡Œé¢ï¼Œä»Žè€Œé¿å…é‡å¤çš„ä»£ç  ç­–ç•¥æ¨¡å¼å¯ä»¥æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸åŒå®žçŽ°ï¼Œå®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæ—¶é—´æˆ–ç©ºé—´è¦æ±‚é€‰æ‹©ä¸åŒçš„ ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŽŸåˆ™çš„å®Œç¾Žæ”¯æŒï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŽŸä»£ç çš„æƒ…å†µä¸‹ï¼Œçµæ´»å¢žåŠ æ–°ç®—æ³• ç­–ç•¥æ¨¡å¼æŠŠç®—æ³•çš„ä½¿ç”¨æ”¾åˆ°çŽ¯å¢ƒç±»ä¸­ï¼Œè€Œç®—æ³•çš„å®žçŽ°ç§»åˆ°å…·ä½“ç­–ç•¥ç±»ä¸­ï¼Œå®žçŽ°äº†äºŒè€…çš„åˆ†ç¦» ç¼ºç‚¹ å®¢æˆ·ç«¯å¿…é¡»ç†è§£æ‰€æœ‰ç­–ç•¥ç®—æ³•çš„åŒºåˆ«ï¼Œä»¥ä¾¿é€‚æ—¶é€‰æ‹©æ°å½“çš„ç®—æ³•ç±» ç­–ç•¥æ¨¡å¼é€ æˆå¾ˆå¤šçš„ç­–ç•¥ç±» å®žçŽ°ç»§æ‰¿å®žçŽ°å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¼ºåˆ¶å­ç±»å®žçŽ°è¯¥æ–¹æ³• è¿™ç§å®žçŽ°ï¼Œå¯¹çˆ¶ç±»å¯¹å­ç±»ä¸ä¸€å®šæ˜¯é€æ˜Žçš„ï¼Œå¦‚æžœçˆ¶ç±»æä¾›äº†é»˜è®¤çš„å®žçŽ°ï¼Œå­ç±»éœ€è¦äº†è§£å®žçŽ°çš„ç»†èŠ‚ï¼Œå†å†³å®šæ˜¯å¦é‡å†™ 123456789101112131415161718public abstract class Action &#123; // ä¹Ÿå¯ä»¥å°†è¯¥æ–¹æ³•è®¾ç½®æˆæŠ½è±¡æ–¹æ³•ï¼Œ å¼ºè¿«å­ç±»æ¥å®žçŽ°è¯¥æ–¹æ³• public void execute() &#123; // æä¾›ä¸€ä¸ªé»˜è®¤çš„å®žçŽ° &#125;&#125;public class ActionModelA extends Action &#123; public void execute() &#123; aStyleBrake();// A é£Žæ ¼çš„è¡Œä¸º &#125;&#125;public class ActionModelB extends Action &#123; public void execute() &#123; bStyleBrake(); // B é£Žæ ¼çš„è¡Œä¸º &#125;&#125; ç»„åˆå®žçŽ°è¿™ç§å®žçŽ°æ˜¯é€æ˜Žçš„ï¼Œåªéœ€è¦æ”¹å˜å¯¹è±¡çš„å¼•ç”¨å°±å¯ä»¥æ”¹å˜å…¶è¡Œä¸ºã€‚ 123456789101112131415161718192021222324252627public interface IBrakeBehavior &#123; void execute();&#125;public class AStyleBrake implements IBrakeBehavior &#123; public void execute() &#123; aStyleBrake(); // A é£Žæ ¼çš„è¡Œä¸º &#125;&#125;public class BStyleBrake implements IBrakeBehavior &#123; public void execute() &#123; bStyleBrake(); // B é£Žæ ¼çš„è¡Œä¸º &#125;&#125;public class Action &#123; protected IBrakeBehavior brakeBehavior; public void execute() &#123; brakeBehavior.execute(); &#125; public void setBrakeBehavior(final IBrakeBehavior brakeType) &#123; this.brakeBehavior = brakeType; &#125;&#125; æœ€åŽé€šè¿‡å·¥åŽ‚ç±»ï¼Œæ ¹æ®è¿è¡Œçš„å‚æ•°é€‰æ‹©å‡ºå¯¹åº”çš„å®žçŽ° 1Action action = ActionFactory.createAction(String parameters); action.execute(); åªæœ‰åœ¨ç­–ç•¥é€‰æ‹©é‡Œæœ‰æ¡ä»¶é€‰æ‹©è¯­å¥ï¼Œå…¶ä»–åœ°æ–¹ä¸å‡ºçŽ°ã€‚ å¦‚ä¸Šè¿°çš„createAction()æ–¹æ³• é€‚é…å™¨æ¨¡å¼ ( Adapter Pattern )å®šä¹‰å°†ä¸€ä¸ªç±»çš„æŽ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæŽ¥å£ï¼Œä½¿å¾—åŽŸæœ¬ç”±äºŽæŽ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œã€‚åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼š ç±»é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸Žé€‚é…è€…ä¹‹é—´æ˜¯ç»§æ‰¿ï¼ˆæˆ–å®žçŽ°ï¼‰å…³ç³» å¯¹è±¡é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨ä¸Žé€‚é…è€…ä¹‹é—´æ˜¯å…³è”å…³ç³» å‰è€…çš„è€¦åˆåº¦æ¯”åŽè€…é«˜ï¼Œä¸”è¦æ±‚å¼€å‘äº†è§£çŽ°æœ‰ç»„ä»¶åº“ä¸­çš„ç›¸å…³ç»„ä»¶çš„å†…éƒ¨ç»“æž„ï¼Œåº”ç”¨ç›¸å¯¹è¾ƒå°‘äº›ã€‚ ä¼˜ç‚¹ å°†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»è§£è€¦ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªé€‚é…å™¨ç±»æ¥é‡ç”¨çŽ°æœ‰çš„é€‚é…è€…ç±»ï¼Œè€Œæ— é¡»ä¿®æ”¹åŽŸæœ‰ä»£ç ã€‚ å¢žåŠ äº†ç±»çš„é€æ˜Žæ€§å’Œå¤ç”¨æ€§ï¼Œå°†å…·ä½“çš„å®žçŽ°å°è£…åœ¨é€‚é…è€…ç±»ä¸­ï¼Œå¯¹äºŽå®¢æˆ·ç«¯ç±»æ¥è¯´æ˜¯é€æ˜Žçš„ï¼Œè€Œä¸”æé«˜äº†é€‚é…è€…çš„å¤ç”¨æ€§ã€‚ çµæ´»æ€§å’Œæ‰©å±•æ€§éƒ½éžå¸¸å¥½ï¼Œé€šè¿‡ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›´æ¢é€‚é…å™¨ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸ä¿®æ”¹åŽŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šå¢žåŠ æ–°çš„é€‚é…å™¨ç±»ï¼Œå®Œå…¨ç¬¦åˆâ€œå¼€é—­åŽŸåˆ™â€ã€‚ ç±»é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š ç”±äºŽé€‚é…å™¨ç±»æ˜¯é€‚é…è€…ç±»çš„å­ç±»ï¼Œå› æ­¤å¯ä»¥åœ¨é€‚é…å™¨ç±»ä¸­ç½®æ¢ä¸€äº›é€‚é…è€…çš„æ–¹æ³•ï¼Œä½¿å¾—é€‚é…å™¨çš„çµæ´»æ€§æ›´å¼ºã€‚ å¯¹è±¡é€‚é…å™¨æ¨¡å¼ä¼˜ç‚¹ï¼š åŒä¸€ä¸ªé€‚é…å™¨å¯ä»¥æŠŠé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æŽ¥å£ã€‚ ç¼ºç‚¹ç±»é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š å¯¹äºŽ Java ç­‰ä¸æ”¯æŒå¤šé‡ç»§æ‰¿çš„è¯­è¨€ï¼Œä¸€æ¬¡æœ€å¤šåªèƒ½é€‚é…ä¸€ä¸ªé€‚é…è€…ç±»ï¼Œè€Œä¸”ç›®æ ‡æŠ½è±¡ç±»åªèƒ½ä¸ºæŠ½è±¡ç±»ï¼Œä¸èƒ½ä¸ºå…·ä½“ç±»ï¼Œå…¶ä½¿ç”¨æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œä¸èƒ½å°†ä¸€ä¸ªé€‚é…è€…ç±»å’Œå®ƒçš„å­ç±»éƒ½é€‚é…åˆ°ç›®æ ‡æŽ¥å£ã€‚ å¯¹è±¡é€‚é…å™¨æ¨¡å¼ç¼ºç‚¹ï¼š ä¸Žç±»é€‚é…å™¨æ¨¡å¼ç›¸æ¯”ï¼Œè¦æƒ³ç½®æ¢é€‚é…è€…ç±»çš„æ–¹æ³•å°±ä¸å®¹æ˜“ã€‚å¦‚æžœä¸€å®šè¦ç½®æ¢æŽ‰é€‚é…è€…ç±»çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹æ³•ï¼Œå°±åªå¥½å…ˆåšä¸€ä¸ªé€‚é…è€…ç±»çš„å­ç±»ï¼Œå°†é€‚é…è€…ç±»çš„æ–¹æ³•ç½®æ¢æŽ‰ï¼Œç„¶åŽå†æŠŠé€‚é…è€…ç±»çš„å­ç±»å½“åšçœŸæ­£çš„é€‚é…è€…è¿›è¡Œé€‚é…ï¼Œå®žçŽ°è¿‡ç¨‹è¾ƒä¸ºå¤æ‚ã€‚ å®žçŽ°è§’è‰² Targetï¼ˆç›®æ ‡æŠ½è±¡ç±»ï¼‰ï¼šç›®æ ‡æŠ½è±¡ç±»å®šä¹‰å®¢æˆ·æ‰€éœ€æŽ¥å£ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–æŽ¥å£ï¼Œä¹Ÿå¯ä»¥æ˜¯å…·ä½“ç±»ã€‚ Adapterï¼ˆé€‚é…å™¨ç±»ï¼‰ï¼šé€‚é…å™¨å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªæŽ¥å£ï¼Œä½œä¸ºä¸€ä¸ªè½¬æ¢å™¨ï¼Œå¯¹ Adaptee å’Œ Target è¿›è¡Œé€‚é…ï¼Œé€‚é…å™¨ç±»æ˜¯é€‚é…å™¨æ¨¡å¼çš„æ ¸å¿ƒï¼Œåœ¨å¯¹è±¡é€‚é…å™¨ä¸­ï¼Œå®ƒé€šè¿‡ç»§æ‰¿ Target å¹¶å…³è”ä¸€ä¸ª Adaptee å¯¹è±¡ä½¿äºŒè€…äº§ç”Ÿè”ç³»ã€‚ Adapteeï¼ˆé€‚é…è€…ç±»ï¼‰ï¼šé€‚é…è€…å³è¢«é€‚é…çš„è§’è‰²ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æŽ¥å£ï¼Œè¿™ä¸ªæŽ¥å£éœ€è¦é€‚é…ï¼Œé€‚é…è€…ç±»ä¸€èˆ¬æ˜¯ä¸€ä¸ªå…·ä½“ç±»ï¼ŒåŒ…å«äº†å®¢æˆ·å¸Œæœ›ä½¿ç”¨çš„ä¸šåŠ¡æ–¹æ³•ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ²¡æœ‰é€‚é…è€…ç±»çš„æºä»£ç ã€‚ ç±»é€‚é…å™¨é¦–å…ˆæœ‰ä¸€ä¸ªå·²å­˜åœ¨çš„å°†è¢«é€‚é…çš„ç±»ï¼š 12345public class Adaptee &#123; public void adapteeRequest() &#123; System.out.println("è¢«é€‚é…è€…çš„æ–¹æ³•"); &#125;&#125; å®šä¹‰ä¸€ä¸ªç›®æ ‡æŽ¥å£ï¼š 123public interface Target &#123; void request();&#125; å¦‚æžœé€šè¿‡ä¸€ä¸ªé€‚é…å™¨ç±»ï¼Œå®žçŽ° Target æŽ¥å£ï¼ŒåŒæ—¶ç»§æ‰¿äº† Adaptee ç±»ï¼Œç„¶åŽåœ¨å®žçŽ°çš„ request() æ–¹æ³•ä¸­è°ƒç”¨çˆ¶ç±»çš„ adapteeRequest() å³å¯å®žçŽ° 12345678public class Adapter extends Adaptee implements Target&#123; @Override public void request() &#123; //...ä¸€äº›æ“ä½œ... super.adapteeRequest(); //...ä¸€äº›æ“ä½œ... &#125;&#125; å¯¹è±¡é€‚é…å™¨å¯¹è±¡é€‚é…å™¨ä¸Žç±»é€‚é…å™¨ä¸åŒä¹‹å¤„åœ¨äºŽï¼Œç±»é€‚é…å™¨é€šè¿‡ç»§æ‰¿æ¥å®Œæˆé€‚é…ï¼Œå¯¹è±¡é€‚é…å™¨åˆ™æ˜¯é€šè¿‡å…³è”æ¥å®Œæˆï¼Œè¿™é‡Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ Adapter ç±»å³å¯å°†è½¬å˜ä¸ºå¯¹è±¡é€‚é…å™¨ 1234567891011public class Adapter implements Target&#123; // é€‚é…è€…æ˜¯å¯¹è±¡é€‚é…å™¨çš„ä¸€ä¸ªå±žæ€§ private Adaptee adaptee = new Adaptee(); @Override public void request() &#123; //... adaptee.adapteeRequest(); //... &#125;&#125; è§‚å¯Ÿè€…æ¨¡å¼ ï¼ˆ Observer Pattern ï¼‰ä¾èµ–å€’ç½®åŽŸåˆ™ï¼ˆ Dependency Inversion Principle ï¼‰ä¾èµ–å€’ç½®åŽŸåˆ™å®šä¹‰ ðŸ“ŒHigh level modules should not depend upon low level modules, Both should depend upon abstractions. Abstractions should not depend upon details. Details should depend upon abstractions ç¿»è¯‘è¿‡æ¥ï¼š é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½Žå±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡ æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ ç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ æŒ‰ç…§Javaçš„ç†è§£ï¼Œæ˜¯é¢å‘æŽ¥å£ç¼–ç¨‹ ä¾èµ–å€’ç½®åŽŸåˆ™ä½œç”¨é™ä½Žç±»é—´çš„è€¦åˆæ€§ç±»é—´çš„ä¾èµ–éƒ½æ˜¯é€šè¿‡æŽ¥å£å®Œæˆçš„ï¼ŒæŸä¸ªç±»çš„å®žçŽ°å˜äº†ï¼Œä¹Ÿä¸å½±å“ä¸Šæ¸¸ä»£ç ã€‚ å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£Žé™©å„å±‚çº§ï¼Œæ¨¡å—é—´éƒ½æ˜¯é€šè¿‡æŽ¥å£å®šä¹‰çš„çº¦æŸï¼Œåªè¦éƒ½éµå¾ªè¿™äº›çº¦æŸï¼Œèƒ½ç›¸åº”å‡å°‘äº†å¹¶è¡Œå¼€å‘çš„å†²çªã€‚ ä¾èµ–å€’ç½®çš„å®žçŽ°æ–¹æ³•æž„é€ å‡½æ•°ä¼ é€’ä¾èµ–å¯¹è±¡1234567891011public class Driver &#123; private Car car; public Driver(Car car) &#123; this.car = car; &#125; public void drive() &#123; this.car.run(); &#125;&#125; Setteræ–¹æ³•ä¼ é€’ä¾èµ–å¯¹è±¡1234567891011public class Driver &#123; private Car car; public void setCar(Car car) &#123; this.car = car; &#125; public void drive() &#123; this.car.run(); &#125;&#125; æŽ¥å£å£°æ˜Žä¾èµ–12345public class Driver &#123; public void drive(Car car) &#123; car.run(); &#125;&#125; å¥½èŽ±åžåŽŸåˆ™ donâ€™t call us, weâ€™ll call you å› ä¸ºåœ¨å¥½èŽ±åžï¼ŒæŠŠç®€åŽ†é€’äº¤ç»™æ¼”è‰ºå…¬å¸åŽå°±åªæœ‰å›žå®¶ç­‰å¾…ã€‚ç”±æ¼”è‰ºå…¬å¸å¯¹æ•´ä¸ªå¨±ä¹é¡¹çš„å®Œå…¨æŽ§åˆ¶ï¼Œæ¼”å‘˜åªèƒ½è¢«åŠ¨å¼çš„æŽ¥å—å…¬å¸çš„å·®ä½¿ï¼Œåœ¨éœ€è¦çš„çŽ¯èŠ‚ä¸­ï¼Œå®Œæˆè‡ªå·±çš„æ¼”å‡ºã€‚ ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¾èµ–å€’ç½®åŽŸåˆ™åˆè¢«ç§°ä¸ºå¥½èŽ±åžåŽŸåˆ™å¥½èŽ±åžæœ‰ä¸€ä¸ªè§’è‰²ï¼Œæ‰¾æ¼”å‘˜æ¥æ¼” å¥½èŽ±åžç›¸å½“äºŽé«˜å±‚ï¼Œæ¼”å‘˜ä»¬ç›¸å½“äºŽä½Žå±‚ï¼Œä»–ä»¬é—´çš„è”ç³»æ˜¯é€šè¿‡æŸä¸ªè§’è‰²ï¼Œ è¿™ä¸ªè§’è‰²ç”±å“ªä¸ªæ¼”å‘˜æ¥æ¼”éƒ½å¯ä»¥ï¼Œå¹¶ä¸ä¾èµ–äºŽå…·ä½“æŸä¸ªæ¼”å‘˜ï¼Œ æ•´ä¸ªæµç¨‹æœ‰ç‚¹åƒé¢å‘æŽ¥å£ç¼–ç¨‹ã€‚ ðŸ“Œä¸¤ä¸ªåŽŸåˆ™å¼ºè°ƒçš„ç‚¹åº”è¯¥æ˜¯ä¸ä¸€æ ·çš„ï¼ŒæŸ¥åˆ°çš„èµ„æ–™ç»™æˆ‘çš„æ„Ÿè§‰æ˜¯ï¼š å¥½èŽ±åžåŽŸåˆ™ï¼šå¼ºè°ƒçš„æ˜¯é«˜å±‚å¯¹åº•å±‚çš„ä¸»åŠ¨è°ƒç”¨ ä¾èµ–å€’ç½®åŽŸåˆ™ï¼šå¼ºè°ƒçš„æ˜¯é¢å‘æŽ¥å£ç¼–ç¨‹ æœ‰ç‚¹ç±»ä¼¼ï¼Œä½†åˆä¸å…¨æ˜¯ã€‚ é‡Œæ°æ›¿æ¢åŽŸåˆ™ï¼ˆï¼‰å•ä¸€èŒè´£åŽŸåˆ™ï¼ˆï¼‰æŽ¥å£éš”ç¦»åŽŸåˆ™ï¼ˆï¼‰]]></content>
      <categories>
        <category>æž¶æž„</category>
        <category>é¢å‘å¯¹è±¡è®¾è®¡åŽŸåˆ™</category>
      </categories>
      <tags>
        <tag>é¢å‘å¯¹è±¡è®¾è®¡åŽŸåˆ™</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•°æ®åº“ç´¢å¼•]]></title>
    <url>%2F2020%2F09%2F14%2F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95%2F</url>
    <content type="text"><![CDATA[æ•°æ®åº“ç´¢å¼•ä»€ä¹ˆæ˜¯ç´¢å¼•ï¼Ÿç´¢å¼•çš„ç±»åž‹æ•°æ®ç»“æž„è§’åº¦ B-Tree ç´¢å¼• hash ç´¢å¼• Full-test ç´¢å¼• R-Tree ç´¢å¼• ç‰©ç†å­˜å‚¨è§’åº¦cluster èšç°‡ç´¢å¼•ï¼ˆèšé›†ç´¢å¼•ï¼‰ï¼šç‰©ç†ç´¢å¼•ï¼Œä¸ŽåŸºè¡¨çš„ç‰©ç†é¡ºåºç›¸åŒï¼Œæ•°æ®å€¼çš„é¡ºåºæ€»æ˜¯æŒ‰ç…§é¡ºåºæŽ’åˆ— CREATE CLUSTERED INDEX mycolumn_cindex ON mytable(mycolumn) WITH ALLOW_DUP_ROW(å…è®¸æœ‰é‡å¤è®°å½•çš„èšç°‡ç´¢å¼•) éžèšç°‡ç´¢å¼•ï¼ˆç¾¤é›†ç´¢å¼•ï¼‰ï¼šCREATE UNCLUSTERED INDEX mycolumn_cindex ON mytable(mycolumn) é€»è¾‘è§’åº¦ å”¯ä¸€ç´¢å¼• CREATE UNIQUE INDEX myclumn_uindex ON mytable(mycolumn) ä¸»é”®ç´¢å¼•ï¼ˆä¸»ç´¢å¼•ï¼‰primary key (å¤)ç»„åˆç´¢å¼•ï¼ˆå¤šåˆ—ç´¢å¼•ï¼‰ï¼šCREATE INDEX mycolumn_index ON mytable (mycolumn1, mycolumn2) æ™®é€šç´¢å¼•ï¼ˆå•åˆ—ç´¢å¼•ï¼‰ï¼šCREATE INDEX mycolumn_index ON mytable (mycolumn) ç©ºé—´ç´¢å¼•ï¼š ç´¢å¼•çš„ä¼˜ç¼ºç‚¹ä¼˜ç‚¹ åˆ›å»ºå”¯ä¸€æ€§ç´¢å¼•ï¼Œä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ€§ å¤§å¤§åŠ å¿«æ•°æ®çš„æ£€ç´¢é€Ÿåº¦ â€“ æœ€ä¸»è¦çš„åŽŸå›  åŠ é€Ÿè¡¨å’Œè¡¨ä¹‹é—´çš„è¿žæŽ¥ åœ¨ä½¿ç”¨åˆ†ç»„å’ŒæŽ’åºå­å¥è¿›è¡Œæ•°æ®æ£€ç´¢æ—¶ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’ŒæŽ’åºçš„æ—¶é—´ é€šè¿‡ä½¿ç”¨ç´¢å¼•ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ä½¿ç”¨ä¼˜åŒ–éšè—å™¨ï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½ ç¼ºç‚¹ åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦è€—è´¹æ—¶é—´ï¼Œè¿™ç§æ—¶é—´éšç€æ•°æ®é‡çš„å¢žåŠ è€Œå¢žåŠ  ç´¢å¼•éœ€è¦å ç”¨æ•°æ®è¡¨ä»¥å¤–çš„ç‰©ç†å­˜å‚¨ç©ºé—´ï¼Œå¦‚æžœè¦å»ºç«‹èšç°‡ç´¢å¼•ï¼Œé‚£ä¹ˆéœ€è¦çš„ç©ºé—´å°±ä¼šæ›´å¤§ å½“å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢žåŠ ã€åˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•éœ€è¦è¢«é‡å»ºï¼Œé™ä½Žäº†æ•°æ®çš„ç»´æŠ¤é€Ÿåº¦ ç´¢å¼•çš„ä½¿ç”¨ å½“å­—æ®µçš„æ•°æ®æ›´æ–°é¢‘çŽ‡è¾ƒä½Žï¼ŒæŸ¥è¯¢ä½¿ç”¨é¢‘çŽ‡è¾ƒé«˜å¹¶ä¸”å­˜åœ¨å¤§é‡é‡å¤å€¼æ—¶ï¼Œå»ºè®®ä½¿ç”¨èšç°‡ç´¢å¼• ç»å¸¸åŒæ—¶å­˜å–å¤šåˆ—ï¼Œä¸”æ¯åˆ—éƒ½å«æœ‰é‡å¤å€¼å¯è€ƒè™‘å»ºç«‹ç»„åˆç´¢å¼• ç»„åˆç´¢å¼•çš„å‰å¯¼åˆ—ä¸€å®šå¥½æŽ§åˆ¶å¥½ï¼Œå¦åˆ™æ— æ³•èµ·åˆ°ç´¢å¼•çš„æ•ˆæžœã€‚å¦‚æžœæŸ¥è¯¢æ—¶å‰å¯¼åˆ—ä¸åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­åˆ™è¯¥ç»„åˆç´¢å¼•ä¸ä¼šè¢«ä½¿ç”¨ï¼Œå‰å¯¼åˆ—ä¸€å®šæ˜¯ä½¿ç”¨æœ€é¢‘ç¹çš„åˆ—ã€‚ æ•°æ®åº“ä¼˜åŒ–(ORACLE)SQLä½¿ç”¨ç´¢å¼•çš„ä¾‹å­123456789INDEX_COLUMN = ?INDEX_COLUMN &gt; ?INDEX_COLUMN &gt;= ?INDEX_COLUMN &lt; ?INDEX_COLUMN &lt;= ?INDEX_COLUMN between ? and ?INDEX_COLUMN in (?,?,...,?)INDEX_COLUMN like ?||'%' --ï¼ˆåŽå¯¼æ¨¡ç³ŠæŸ¥è¯¢ï¼‰T1.INDEX_COLUMN=T2.COLUMN1 --ï¼ˆä¸¤ä¸ªè¡¨é€šè¿‡ç´¢å¼•å­—æ®µå…³è”ï¼‰ SQLä¸ä½¿ç”¨ç´¢å¼•çš„ä¾‹å­1234567891011121314151617181920-- ä¸ç­‰äºŽæ“ä½œä¸èƒ½ä½¿ç”¨ç´¢å¼•INDEX_COLUMN &lt;&gt; ?INDEX_COLUMN not in (?,?,...,?)-- ç»è¿‡æ™®é€šè¿ç®—æˆ–å‡½æ•°è¿ç®—åŽçš„ç´¢å¼•å­—æ®µä¸èƒ½ä½¿ç”¨ç´¢å¼•function(INDEX_COLUMN) = ?INDEX_COLUMN + 1 = ?INDEX_COLUMN || 'a' = ?-- å«å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•INDEX_COLUMN like '%'||?INDEX_COLUMN like '%'||?||'%'-- B-TREEç´¢å¼•é‡Œä¸ä¿å­˜å­—æ®µä¸ºNULLå€¼è®°å½•ï¼Œå› æ­¤IS NULLä¸èƒ½ä½¿ç”¨ç´¢å¼•INDEX_COLUMN is null-- Oracleåœ¨åšæ•°å€¼æ¯”è¾ƒæ—¶éœ€è¦å°†ä¸¤è¾¹çš„æ•°æ®è½¬æ¢æˆåŒä¸€ç§æ•°æ®ç±»åž‹ï¼Œå¦‚æžœä¸¤è¾¹æ•°æ®ç±»åž‹ä¸åŒæ—¶ä¼šå¯¹å­—æ®µå€¼éšå¼è½¬æ¢ï¼Œç›¸å½“äºŽåŠ äº†ä¸€å±‚å‡½æ•°å¤„ç†ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨ç´¢å¼•ã€‚NUMBER_INDEX_COLUMN='12345'CHAR_INDEX_COLUMN=12345a.INDEX_COLUMN=a.COLUMN_1 å¸¸ç”¨ä¼˜åŒ–æ–¹æ³•ï¼ˆORACLEï¼‰whereå­å¥ä¸­çš„è¿žæŽ¥é¡ºåº WHERE å­å¥æ˜¯ä»Žä¸‹å¾€ä¸Šæ‰§è¡Œï¼Œç­›é€‰æŽ‰å†…å®¹æœ€å¤šçš„æ¡ä»¶å¿…é¡»å†™åœ¨ WHERE å­å¥çš„æœ«å°¾ï¼Œå°¤å…¶æ˜¯ä¸»é”®ID=?è¿™æ ·çš„æ¡ä»¶ã€‚ selectå­å¥ä¸­é¿å…ä½¿ç”¨ â€˜ * â€˜ oracleè§£æžè¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠ*ä¾æ¬¡è½¬æ¢ä¸ºæ‰€æœ‰åˆ—åï¼Œè¿™ä¸ªå·¥ä½œæ˜¯é€šè¿‡æŸ¥è¯¢æ•°æ®å­—å…¸æ¥å®Œæˆçš„ï¼Œ è¿™æ„å‘³ç€å°†è€—è´¹æ›´å¤šçš„æ—¶é—´ é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°WHEREå­å¥ä¸­ï¼Œå¦‚æžœç´¢å¼•åˆ—æ˜¯å‡½æ•°çš„ä¸€éƒ¨åˆ†ã€‚ä¼˜åŒ–å™¨å°†ä¸ä½¿ç”¨ç´¢å¼•è€Œä½¿ç”¨å…¨è¡¨æ‰«æ é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨NOTNOT ä¼šäº§ç”Ÿåœ¨å’Œåœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°ç›¸åŒçš„æ•ˆæžœã€‚ é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨IS NULLå’ŒIS NOT NULLé¿å…åœ¨ç´¢å¼•ä¸­ä½¿ç”¨ä»»ä½•å¯ä»¥ä¸ºç©ºçš„åˆ—ï¼Œoracle å°†æ— æ³•ä½¿ç”¨è¯¥ç´¢å¼• å¯¹äºŽå•åˆ—ç´¢å¼•ï¼Œå¦‚æžœåˆ—åŒ…å«ç©ºå€¼ï¼Œç´¢å¼•ä¸­å°†ä¸å­˜åœ¨æ­¤è®°å½• å¯¹äºŽå¤åˆç´¢å¼•ï¼Œå¦‚æžœæ¯ä¸ªåˆ—éƒ½ä¸ºç©ºï¼Œç´¢å¼•ä¸­åŒæ ·ä¸å­˜åœ¨æ­¤è®°å½• æ³¨æ„é€šé…ç¬¦%çš„å½±å“å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•ä¸èƒ½ä½¿ç”¨ç´¢å¼•INDEX_COLUMN like &#39;%&#39;||? åŽå¯¼æ¨¡ç³ŠæŸ¥è¯¢çš„Likeè¯­æ³•å¯ä»¥ä½¿ç”¨ç´¢å¼•INDEX_COLUMN like ?||&#39;%&#39; é¿å…æ”¹å˜ç´¢å¼•åˆ—çš„ç±»åž‹åœ¨åšæ•°å€¼æ¯”è¾ƒæ—¶éœ€è¦å°†ä¸¤è¾¹çš„æ•°æ®è½¬æ¢æˆåŒä¸€ç§æ•°æ®ç±»åž‹ï¼Œå¦‚æžœä¸¤è¾¹æ•°æ®ç±»åž‹ä¸åŒæ—¶ä¼šå¯¹å­—æ®µå€¼éšå¼è½¬æ¢ï¼Œç›¸å½“äºŽåŠ äº†ä¸€å±‚å‡½æ•°å¤„ç†ï¼Œå¯¼è‡´ä¸èƒ½ä½¿ç”¨ç´¢å¼•ã€‚ ç”¨(UNION)UNION ALLæ›¿æ¢OR (é€‚ç”¨äºŽç´¢å¼•åˆ—)é€šå¸¸æƒ…å†µä¸‹ï¼Œ ç”¨UNIONæ›¿æ¢WHEREå­å¥ä¸­çš„ORå°†ä¼šèµ·åˆ°è¾ƒå¥½çš„æ•ˆæžœï¼Œå¯¹ç´¢å¼•åˆ—ä½¿ç”¨ORå°†é€ æˆå…¨è¡¨æ‰«æã€‚ æ³¨æ„ï¼šä»¥ä¸Šè§„åˆ™åªé’ˆå¯¹å¤šä¸ªç´¢å¼•åˆ—æœ‰æ•ˆã€‚å¦‚æžœæœ‰columnæ²¡æœ‰è¢«ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•ˆçŽ‡å¯èƒ½ä¼šå› ä¸ºä½ æ²¡æœ‰é€‰æ‹©ORè€Œé™ä½Ž ç”¨UNION-ALL æ›¿æ¢UNION ( å¦‚æžœæœ‰å¯èƒ½çš„è¯)å½“ SQLè¯­å¥éœ€è¦UNIONä¸¤ä¸ªæŸ¥è¯¢ç»“æžœé›†åˆæ—¶ï¼Œè¿™ä¸¤ä¸ªç»“æžœé›†åˆä¼šä»¥UNION-ALLçš„æ–¹å¼è¢«åˆå¹¶ï¼Œ ç„¶åŽåœ¨è¾“å‡ºæœ€ç»ˆç»“æžœå‰è¿›è¡ŒæŽ’åºã€‚ å¦‚æžœç”¨UNION ALLæ›¿ä»£UNIONï¼Œ è¿™æ ·æŽ’åºå°±ä¸æ˜¯å¿…è¦äº†ï¼Œ æ•ˆçŽ‡å°±ä¼šå› æ­¤å¾—åˆ°æé«˜ã€‚ æ³¨æ„ï¼šUNION ALL å°†é‡å¤è¾“å‡ºä¸¤ä¸ªç»“æžœé›†åˆä¸­ç›¸åŒè®°å½• EXISTSæ›¿æ¢DISTINCTå¸¦æœ‰DISTINCTã€UNIONã€MINUSã€INTERSECTçš„SQLè¯­å¥ä¼šå¯åŠ¨SQLå¼•æ“Žæ‰§è¡Œè€—è´¹èµ„æºçš„æŽ’åº(SORT)åŠŸèƒ½ã€‚ DISTINCT éœ€è¦ä¸€æ¬¡æŽ’åºæ“ä½œï¼Œ è€Œå…¶ä»–çš„è‡³å°‘éœ€è¦æ‰§è¡Œä¸¤æ¬¡æŽ’åºã€‚ é€šå¸¸ï¼Œ å¸¦æœ‰UNIONã€MINUS ã€INTERSECTçš„SQLè¯­å¥éƒ½å¯ä»¥ç”¨å…¶ä»–æ–¹å¼é‡å†™ã€‚ åˆç†çš„ä½¿ç”¨EXISTSå’ŒINEXISTSï¼šé¦–å…ˆæ£€æŸ¥ä¸»æŸ¥è¯¢ï¼Œç„¶åŽè¿è¡Œå­æŸ¥è¯¢ç›´åˆ°å®ƒæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œè¿™å°±èŠ‚çœäº†æ—¶é—´ã€‚IN å­æŸ¥è¯¢ï¼šé¦–å…ˆç³»ç»Ÿå…ˆå°†ä¸»æŸ¥è¯¢æŒ‚èµ·ï¼Œç„¶åŽæ‰§è¡Œå­æŸ¥è¯¢ï¼Œå¹¶å°†èŽ·å¾—çš„ç»“æžœåˆ—è¡¨å­˜æ”¾åœ¨ä¸€ä¸ªåŠ äº†ç´¢å¼•çš„ä¸´æ—¶è¡¨ä¸­ã€‚å¾…å­æŸ¥è¯¢æ‰§è¡Œå®Œæ¯•ï¼Œå†æ‰§è¡Œä¸»æŸ¥è¯¢ã€‚è¿™ä¹Ÿå°±æ˜¯ä½¿ç”¨EXISTSæ¯”ä½¿ç”¨INé€šå¸¸æŸ¥è¯¢é€Ÿåº¦å¿«çš„åŽŸå› ã€‚ 12select * from A where exists(select 1 from B where A.id = B.id) ;select * from A where A.id in (select B.id from B) ; å½“å­æŸ¥è¯¢çš„è¡¨å¤§ï¼Œexists ä¼˜äºŽ inï¼› è¡¥å…… EXISTS(subquery) åªè¿”å›ž TRUE or FALSEï¼Œå®žé™…å®žè¡Œæ—¶ä¼šä¼˜åŒ–å­æŸ¥è¯¢çš„selectæ¸…å•ï¼Œå› æ­¤å­æŸ¥è¯¢é‡Œå†™ select * / select 1 / select â€˜Xâ€™ï¼Œæ²¡æœ‰ä»»ä½•åŒºåˆ« å¦‚æžœä¸¤ä¸ªè¡¨çš„å¤§å°ç›¸å½“ï¼Œexists å’Œ in å·®åˆ«ä¸å¤§ æ— è®ºå“ªä¸ªè¡¨å¤§ï¼Œnot exists éƒ½æ¯” not in è¦å¿«ï¼Œå› ä¸º not in å†…å¤–è¡¨éƒ½ä¸èµ°ç´¢å¼•ï¼›è€Œ not existsçš„å­æŸ¥è¯¢ä¾ç„¶å¯ä»¥ç”¨è¡¨çš„ç´¢å¼•]]></content>
      <categories>
        <category>ç´¢å¼•</category>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>ç´¢å¼•</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[String.join()]]></title>
    <url>%2F2020%2F09%2F10%2FStringJoiner%2F</url>
    <content type="text"><![CDATA[String.join() JDK8 é‡è½½äº†joinæ–¹æ³• SpringJoineræž„é€ å‡½æ•°è¯¦ç»†ä¿¡æ¯public StringJoiner (CharSequence delimiter, CharSequence prefixï¼ŒCharSequence suffix ) å‚æ•°ï¼š delimiter - æ·»åŠ åˆ°çš„æ¯ä¸ªå…ƒç´ ä¹‹é—´è¦ä½¿ç”¨çš„å­—ç¬¦åºåˆ— prefix - å¼€å¤´ä½¿ç”¨çš„å­—ç¬¦åºåˆ— suffix - æœ€åŽä½¿ç”¨çš„å­—ç¬¦åºåˆ— å¦‚æžœ prefixï¼Œdelimiter æˆ– suffix æ˜¯ null, åˆ™æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚ ä¸¾ä¾‹ï¼šå­—ç¬¦ä¸²&quot;[George:Sally:Fred]&quot;å¯ä»¥æž„é€ å¦‚ä¸‹: 123StringJoiner sj = new StringJoiner(":", "[", "]");sj.add("George").add("Sally").add("Fred");String desiredString = sj.toString();]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>String</tag>
        <tag>Join</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Transaction]]></title>
    <url>%2F2020%2F09%2F08%2FSpring%20Transaction%2F</url>
    <content type="text"><![CDATA[åªè¯»äº‹åŠ¡è®¾ç½® JDBC æŒ‡å®šåªè¯»äº‹åŠ¡çš„è®¾ç½®ï¼šconnection.setReadOnly(true) Hibernate åªè¯»äº‹åŠ¡çš„è®¾ç½®ï¼šsession.setFlushMode(FlushMode.NEVER) Spring åªè¯»äº‹åŠ¡è®¾ç½®ï¼š @Transactional(readOnly = true) &lt;tx:method name=&quot;search*&quot; read-only=&quot;true&quot; /&gt; read-only å¹¶ä¸æ˜¯æ‰€æœ‰æ•°æ®åº“éƒ½æ”¯æŒçš„ï¼Œä¸åŒçš„æ•°æ®åº“ä¸‹ä¼šæœ‰ä¸åŒçš„ç»“æžœï¼ˆä¾‹å¦‚ï¼šå¯¹ Mysql ç”Ÿæ•ˆï¼Œå¯¹ Oracle ä¸ç”Ÿæ•ˆï¼‰ã€‚ è®¾ç½®äº†read-only åŽï¼Œconnection éƒ½ä¼šè¢«èµ‹äºˆ read-onlyï¼ˆå¸Œæœ›æ•°æ®åº“é©±åŠ¨å¼€å¯åªè¯»ä¼˜åŒ–ï¼Œä¸ä¸€å®šç”Ÿæ•ˆï¼‰ ï¼Œä¸åº”è¯¥æŠŠ read-onlyä½œä¸ºæ‰“å¼€åªè¯»äº‹åŠ¡çš„åˆ¤æ–­ã€‚ åœ¨ORMæ¡†æž¶ä¸­ï¼Œè®¾ç½®äº†read-onlyä¼šèµ‹äºˆä¸€äº›é¢å¤–çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚åœ¨ Hibernate ä¸­ï¼Œä¼šè¢«ç¦æ­¢ flush ç­‰ã€‚ Oracle 11.2 çš„æ–‡æ¡£ä¸­è¡¨æ˜ŽOracle JDBC Driver ä¸æ”¯æŒ read-only connections]]></content>
      <categories>
        <category>Transaction</category>
      </categories>
      <tags>
        <tag>Transaction</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JDK å†…ç½®æ³¨è§£]]></title>
    <url>%2F2020%2F09%2F08%2FJDK%20%E5%86%85%E7%BD%AE%E6%B3%A8%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[@SuppressWarningsèŒƒå›´ï¼šç±»ã€å­—æ®µã€æ–¹æ³•ã€å‚æ•°ã€æž„é€ æ–¹æ³•ï¼Œä»¥åŠå±€éƒ¨å˜é‡ä¸Šã€‚ ä½œç”¨ï¼šå‘Šè¯‰ç¼–è¯‘å™¨å¿½ç•¥æŒ‡å®šçš„è­¦å‘Šï¼Œä¸ç”¨åœ¨ç¼–è¯‘å®ŒæˆåŽå‡ºçŽ°è­¦å‘Šä¿¡æ¯ã€‚ å‚æ•°ï¼š deprecationï¼šå¿½ç•¥è¿‡æ—¶ rawtypesï¼šå¿½ç•¥ç±»åž‹å®‰å…¨ unusedï¼šå¿½ç•¥ä¸ä½¿ç”¨ uncheckedï¼šå¿½ç•¥å®‰å…¨æ£€æŸ¥ nullï¼šå¿½ç•¥ç©ºæŒ‡é’ˆ allï¼šå¿½ç•¥æ‰€æœ‰ ä¾‹å­ï¼š@SuppressWarnings(&quot;unchecked&quot;, &quot;deprecation&quot;)]]></content>
      <categories>
        <category>æ³¨è§£</category>
      </categories>
      <tags>
        <tag>æ³¨è§£</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CAS]]></title>
    <url>%2F2020%2F09%2F06%2FCAS%E6%80%9D%E6%83%B3%2F</url>
    <content type="text"><![CDATA[CASä»€ä¹ˆæ˜¯CAS CAS å…¨ç§° compare and swap (æ¯”è¾ƒå¹¶æ›¿æ¢)ï¼Œæ˜¯ç”¨åœ¨çº¿ç¨‹å¹¶å‘ç®—æ³•é‡Œå¸¸è§çš„ä¸€ç§æ€æƒ³ CAS æ˜¯åŽŸå­æ“ä½œï¼Œä¿è¯å¹¶å‘å®‰å…¨ï¼Œä½†ä¸ä¿è¯å¹¶å‘åŒæ­¥ CASåŽŸç†CAS å°±æ˜¯å°†å†…å­˜å€¼æ›´æ–°ä¸ºéœ€è¦çš„å€¼æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæ¡ä»¶ï¼Œå†…å­˜å€¼å¿…é¡»ä¸ŽæœŸæœ›å€¼ç›¸åŒ æœŸæœ›å€¼ Eã€å†…å­˜å€¼Mã€æ›´æ–°å€¼Uï¼Œå½“E == Mçš„æ—¶å€™å°†Mæ›´æ–°ä¸ºU CASåº”ç”¨ æ•°æ®åº“å¸¸è§çš„ä¹è§‚é”å®žçŽ°æ–¹å¼ï¼Œä½¿ç”¨ç‰ˆæœ¬å·version JAVAé‡Œçš„åŽŸå­ç±» CASä¼˜ç¼ºç‚¹ä¼˜ç‚¹ç”¨æ¥å®žçŽ°éžé˜»å¡žçš„è½»é‡çº§çš„ä¹è§‚é”ï¼Œé€šè¿‡CPUæŒ‡ä»¤å®žçŽ°ï¼Œåœ¨èµ„æºç«žäº‰ä¸æ¿€çƒˆçš„æƒ…å†µä¸‹æ€§èƒ½é«˜ ç¼ºç‚¹ ABA é—®é¢˜ï¼šçº¿ç¨‹Cã€Dï¼Œçº¿ç¨‹Då°†Aä¿®æ”¹ä¸ºBåŽåˆä¿®æ”¹ä¸ºAï¼Œæ­¤æ—¶Cçº¿ç¨‹ä»¥ä¸ºAæ²¡æœ‰æ”¹å˜è¿‡ JAVAçš„åŽŸå­ç±»AtomicStampedReferenceï¼Œé€šè¿‡æŽ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯CASçš„æ­£ç¡®æ€§ï¼ˆå…¶ä»–æƒ…å†µä¹Ÿå¯ä»¥é€šè¿‡å¢žåŠ ç‰ˆæœ¬å·æ¥è§£å†³ABAé—®é¢˜ï¼‰ è‡ªæ—‹æ—¶é—´è¿‡é•¿(ä¸€ç›´ä¸èƒ½æ›´æ–°)ï¼Œæ¶ˆè€—CPUèµ„æºï¼Œ å¦‚æžœèµ„æºç«žäº‰æ¿€çƒˆï¼Œå¤šçº¿ç¨‹è‡ªæ—‹é•¿æ—¶é—´æ¶ˆè€—èµ„æº]]></content>
      <categories>
        <category>é”</category>
        <category>ä¹è§‚é”</category>
      </categories>
      <tags>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[JPAç”¨æ³•]]></title>
    <url>%2F2020%2F09%2F06%2FJPA%E7%94%A8%E6%B3%95%2F</url>
    <content type="text"><![CDATA[æŸ¥è¯¢ç”¨æ³•å®žä½“12345678910111213141516@Entity@Datapublic class Employee implements Serializable &#123; @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; // æ‹¥æœ‰çº§è”ç»´æŠ¤çš„ä¸€æ–¹ï¼Œå‚è€ƒhttp://westerly-lzh.github.io/cn/2014/12/JPA-CascadeType-Explaining/ @OneToOne(cascade = CascadeType.ALL) @JoinColumn(foreignKey = @ForeignKey(name = "none", value = ConstraintMode.NO_CONSTRAINT)) private EmployeeDetail detail; @ManyToOne(fetch = FetchType.LAZY) // è®¾ç½®å¤–é”®çš„é—®é¢˜ï¼Œå‚è€ƒhttp://mario1412.github.io/2016/06/27/JPA%E4%B8%AD%E5%B1%8F%E8%94%BD%E5%AE%9E%E4%BD%93%E9%97%B4%E5%A4%96%E9%94%AE/ @JoinColumn(name = "jobId", foreignKey = @ForeignKey(name = "none", value = ConstraintMode.NO_CONSTRAINT)) private Job job;&#125; 12345678910@Entity@Datapublic class EmployeeDetail implements Serializable &#123; @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; private String name; private String phone; private Integer age;&#125; 123456789101112131415@Entity@Datapublic class Job implements Serializable &#123; @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; private String name; // mappedBy åªæœ‰åœ¨åŒå‘å…³è”çš„æ—¶å€™è®¾ç½®ï¼Œè¡¨ç¤ºå…³ç³»ç»´æŠ¤çš„ä¸€ç«¯ï¼Œå¦åˆ™ä¼šç”Ÿæˆä¸­é—´è¡¨A_B @OneToMany(targetEntity = Employee.class, mappedBy = "job") // æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ @JoinColumn ä¸­çš„ @ForeignKey ä¸ç„¶ä¼šç”Ÿæˆå¤–é”® @org.hibernate.annotations.ForeignKey(name = "none") private Set&lt;Employee&gt; employees;&#125; Specification å¤æ‚æŸ¥è¯¢JPAå¤æ‚æŸ¥è¯¢æŽ¥å£ JpaSpecificationExecutor æŽ¥å£ï¼Œå¯ä»¥å®Œæˆå„ç§å¤æ‚æŸ¥è¯¢ï¼Œé…åˆ JAVA 8çš„æ–°ç‰¹æ€§ï¼Œä½¿ç”¨èµ·æ¥ç‰¹åˆ«çš„æ–¹ä¾¿ï¼Œä¸€èˆ¬ç”¨äºŽå•è¡¨çš„å¤æ‚æŸ¥è¯¢ã€‚ 1234567891011121314151617181920212223242526272829/* * @param search æŸ¥è¯¢å±žæ€§ * @param pageable åˆ†é¡µå’ŒæŽ’åº * @return åˆ†é¡µæ•°æ® */@Overridepublic Page&lt;Employee&gt; pageBySearch(EmployeeSearch search, Pageable pageable) &#123; return employeeDao.findAll((Specification&lt;Employee&gt;) (root, criteriaQuery, criteriaBuilder) -&gt; &#123; List&lt;Predicate&gt; predicates = new LinkedList&lt;&gt;(); Optional&lt;EmployeeSearch&gt; optional = Optional.ofNullable(search); // æ ¹æ® employee id æŸ¥è¯¢ optional.map(EmployeeSearch::getEmployeeId).ifPresent(id -&gt; &#123; predicates.add(criteriaBuilder.equal(root.get(Employee_.id), id)); &#125;); // æ ¹æ® employee detail name æ¨¡ç³ŠæŸ¥è¯¢ optional.map(EmployeeSearch::getEmployeeName).ifPresent(name -&gt; &#123; Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT); predicates.add(criteriaBuilder.like(join.get(EmployeeDetail_.name), "%" + name + "%")); &#125;); // æ ¹æ®èŒä½åæŸ¥è¯¢ optional.map(EmployeeSearch::getJobName).ifPresent(name -&gt; &#123; Join&lt;Employee, Job&gt; join = root.join(Employee_.job, JoinType.LEFT); predicates.add(criteriaBuilder.equal(join.get(Job_.name), name)); &#125;); Predicate[] array = new Predicate[predicates.size()]; return criteriaBuilder.and(predicates.toArray(array)); &#125;, pageable);&#125; æ³¨æ„ï¼š é’ˆå¯¹æœ‰å¤–é”®å…³è”çš„è¡¨çš„æŸ¥è¯¢æ¡ä»¶ï¼Œéœ€è¦ä½¿ç”¨å·¦è”æŽ¥ï¼›å¦‚ä¸Šé¢çš„ employee detail name æ¨¡ç³ŠæŸ¥è¯¢ å¦‚æžœç›´æŽ¥ get(Employee_.detail).get(EmployeeDetail_.name) ï¼Œå°±æ˜¯æ— æ¡ä»¶å†…è”ï¼Œç›¸å½“äºŽ cross joinï¼Œä¼šäº§ç”Ÿç¬›å¡å°”ç§¯ Criteria æŸ¥è¯¢æ™®é€šçš„æŸ¥è¯¢è¿”å›žç»“æžœç±»åž‹ï¼šentity / Object[] / tuple / DTO 12345678910111213141516171819202122232425@PersistenceContextprivate EntityManager em;/** * Search age gt or eq the parameter * * @param age * @return */@Overridepublic List&lt;Employee&gt; listByAge(Integer age) &#123; CriteriaBuilder cb = em.getCriteriaBuilder(); CriteriaQuery&lt;Employee&gt; query = cb.createQuery(Employee.class); // è®¾ç½®æŸ¥è¯¢æ ¹ï¼Œå¯ä»¥æ ¹æ®æŸ¥è¯¢çš„ç±»åž‹è®¾ç½®ä¸åŒçš„ å°±æ˜¯ Form è¯­å¥ åŽé¢çš„ entity Root&lt;Employee&gt; root = query.from(Employee.class); List&lt;Predicate&gt; predicates = new LinkedList&lt;&gt;(); // è¿žè¡¨æŸ¥è¯¢ä½¿ç”¨å·¦è¿žæŽ¥ Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT); predicates.add(cb.gt(join.get(EmployeeDetail_.age), age)); predicates.add(cb.equal(join.get(EmployeeDetail_.age), age)); // è®¾ç½®æŽ’åºè§„åˆ™ query.orderBy(cb.asc(root.get(Employee_.id))); query.where(predicates.toArray(new Predicate[predicates.size()])); return em.createQuery(query).getResultList();&#125; è¿”å›žDTOå¯¹è±¡å› ä¸ºä¸æ˜¯ä¸€ä¸ªEntityï¼Œåˆ™éœ€è¦åšä¸€äº›ç‰¹æ®Šçš„æ“ä½œ 12345678@Getter@Setter@AllArgsConstructor@NoArgsConstructorpublic class EmployeeResult &#123; private String name; private Integer age;&#125; 1234567891011121314151617181920/** * ä½¿ç”¨ æž„é€ å‡½æ•° è£…è½½æŸ¥è¯¢å‡ºæ¥çš„æ•°æ® * * @return */@Overridepublic List&lt;EmployeeResult&gt; findEmployee() &#123; CriteriaBuilder cb = em.getCriteriaBuilder(); CriteriaQuery&lt;EmployeeResult&gt; query = cb.createQuery(EmployeeResult.class); // è®¾ç½®æŸ¥è¯¢æ ¹ï¼Œå¯ä»¥æ ¹æ®æŸ¥è¯¢çš„ç±»åž‹è®¾ç½®ä¸åŒçš„ Root&lt;Employee&gt; root = query.from(Employee.class); Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT); // ä½¿ç”¨æž„é€ å‡½æ•° CriteriaBuilder.construct æ¥å®Œæˆè£…è½½æ•°æ® query.select(cb.construct(EmployeeResult.class, join.get(EmployeeDetail_.name), join.get(EmployeeDetail_.age))); // è®¾ç½®æŽ’åºè§„åˆ™ Order order = cb.asc(root.get(Employee_.id)); query.orderBy(order); TypedQuery typedQuery = em.createQuery(query); // TypedQueryæ‰§è¡ŒæŸ¥è¯¢ä¸ŽèŽ·å–å…ƒæ¨¡åž‹å®žä¾‹ return typedQuery.getResultList();&#125; query.select(CriteriaBuilder.construct()) è¿™ç§æ–¹å¼ å°±ç›¸å½“äºŽ 1234&gt; query.mutipleSelect(&gt; join.get(EmployeeDetail_.name), &gt; join.get(EmployeeDetail_.age));&gt; è€Œä¸”é¡ºåºå¿…é¡»å’ŒDTOçš„æž„é€ æ–¹æ³•çš„å‚æ•°é¡ºåºä¸€è‡´æ‰è¡Œ è¿”å›žObject[]1criteriaQuery.select(criteriaBuilder.array(root.get(xxx),join.get(xxx))); å…ƒæ¨¡åž‹æŸ¥è¯¢å…ƒæ¨¡åž‹å®žä¾‹é€šè¿‡è°ƒç”¨ EntityManager.getMetamodel æ–¹æ³•èŽ·å¾—ï¼ŒEntityType&lt;Employee&gt;çš„å…ƒæ¨¡åž‹å®žä¾‹é€šè¿‡è°ƒç”¨Metamodel.entity(Employee.class)è€ŒèŽ·å¾—ï¼Œå…¶è¢«ä¼ å…¥ CriteriaQuery.from èŽ·å¾—æŸ¥è¯¢æ ¹ 123Metamodel metamodel = em.getMetamodel();EntityType&lt;Employee&gt; Employee_ = metamodel.entity(Employee.class);Root&lt;Employee&gt; empRoot = criteriaQuery.from(Employee_); TupleæŸ¥è¯¢123456789101112131415161718/** * åˆ†ç»„ç»Ÿè®¡é‡åæ•°é‡ * @param name * @return */@Overridepublic List&lt;Tuple&gt; groupByName(String name) &#123; CriteriaBuilder cb = em.getCriteriaBuilder(); CriteriaQuery&lt;Tuple&gt; query = cb.createTupleQuery(); Root&lt;Employee&gt; root = query.from(Employee.class); Join&lt;Employee, EmployeeDetail&gt; join = root.join(Employee_.detail, JoinType.LEFT); query.groupBy(join.get(EmployeeDetail_.name)); if (name != null) &#123; query.having(cb.like(join.get(EmployeeDetail_.name), "%" + name + "%")); &#125; query.select(cb.tuple(join.get(EmployeeDetail_.name), cb.count(root))); return em.createQuery(query).getResultList();&#125; æè¿°ï¼šå¯¹äºŽBigDecimalè¿™ç§å¯¹è±¡åœ¨HQLé‡Œæ²¡æœ‰æž„é€ æ–¹æ³•çš„ã€‚å¯ä»¥ä½¿ç”¨æŸ¥è¯¢Objectå†å¼ºè½¬ 12345678public BigDecimal findRemainRefundableAmount(String orderNo) &#123; CriteriaBuilder builder = entityManager.getCriteriaBuilder(); // è¿”å›žå€¼ç±»åž‹è®¾ç½®ä¸ºObject CriteriaQuery&lt;Object&gt; query = builder.createQuery(Object.class); Root&lt;Account&gt; root = query.from(Account.class); // æŸ¥è¯¢çš„æ—¶å€™å†è¿›è¡Œå¼ºè½¬ return (BigDecimal) entityManager.createQuery(query).getSingleResult(); &#125; æŽ’åºå†™æ³•1ï¼šè¿™ç§å†™æ³•ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥æŽ’å…¶ä»–è¡¨çš„å­—æ®µï¼ˆuserRoot -&gt; accountRoot ï¼‰ 1criteriaQuery.orderBy(builder.desc(userRoot.get("createTime"))); å†™æ³•2ï¼šè¿™ç§ä¼˜ç‚¹ï¼Œå¯ä»¥å°†ç›´æŽ¥å°†å‚æ•°çš„Pageableé‡Œé¢çš„sortå¯¹è±¡ä¹‹é—´æŽ’åº 1criteriaQuery.orderBy(QueryUtils.toOrders(pageable.getSort(), userRoot, builder)); å†™æ³•3ï¼šæœ€å¸¸ç”¨çš„å†™æ³•ï¼Œå¯¹å¤šä¸ªå­—æ®µæŽ’åºList&lt;Order&gt; 1criteriaQuery.orderBy(orderList); æ›´æ–°å‚è€ƒèµ„æ–™JPA ä½¿ç”¨ Specification å¤æ‚æŸ¥è¯¢å’Œ Criteria æŸ¥è¯¢]]></content>
      <categories>
        <category>JPA</category>
      </categories>
      <tags>
        <tag>JPA</tag>
        <tag>Spring Data JPA</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[äº‹åŠ¡]]></title>
    <url>%2F2020%2F09%2F06%2F%E4%BA%8B%E5%8A%A1%2F</url>
    <content type="text"><![CDATA[äº‹åŠ¡ä»€ä¹ˆæ˜¯äº‹åŠ¡ æ‰€è°“çš„äº‹åŠ¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ“ä½œåºåˆ—ï¼Œè¿™äº›æ“ä½œè¦ä¹ˆéƒ½æ‰§è¡Œï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚ äº‹åŠ¡æ˜¯æ•°æ®åº“ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§çš„å•ä½ï¼Œåœ¨æ¯ä¸ªäº‹åŠ¡ç»“æŸæ—¶ï¼Œéƒ½èƒ½ä¿æŒæ•°æ®ä¸€è‡´æ€§ã€‚ äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§Atomic åŽŸå­æ€§ä¸åŒå¯¹è±¡ä¹‹é—´å¯¹äºŽåŽŸå­æ€§å®šä¹‰ä¸åŒï¼š äº‹åŠ¡æ€§æ•°æ®åº“(ACIDè¯­å¢ƒä¸‹)ï¼šåŽŸå­æ€§æ˜¯æŒ‡ä¸€ç»„å¯¹æ•°æ®åº“çš„æ”¹å˜ï¼Œè¦ä¹ˆæœ€ç»ˆæˆåŠŸæ‰§è¡Œå®Œæˆï¼Œè¦ä¸å°±å…¨éƒ¨å›žæ»šã€‚è¿™å°±è¦æ±‚æ•°æ®åº“ç³»ç»Ÿè¦å®žçŽ°æŸç§==å›žæ»šçš„æœºåˆ¶==ï¼Œæ¯”å¦‚redo/undo logã€‚ å¯¹äºŽæ”¯æŒå¹¶å‘çš„ç¼–ç¨‹è¯­è¨€(Javaã€C++ç­‰)ï¼šåŽŸå­æ€§æ˜¯æŒ‡ä¸€ç»„æŒ‡ä»¤è¢«æ‰§è¡Œæ—¶ï¼Œä¸å—å…¶ä»–æŒ‡ä»¤çš„å¹²æ‰°ã€‚æ¯”å¦‚â€ç»™ä¸€ä¸ªæ•´åž‹å˜é‡èµ‹å€¼æ˜¯åŽŸå­çš„â€œç­‰ç­‰ã€‚ ä¸€äº›NoSQLçš„æ•°æ®åº“(Redis)ï¼š äº‹åŠ¡çš„åŽŸå­æ€§çš„æ„æ€æ›´æŽ¥è¿‘äºŽâ€œä¸€ç»„æŒ‡ä»¤è¢«æ‰§è¡Œæ—¶ï¼Œä¸å—å…¶ä»–æŒ‡ä»¤çš„å¹²æ‰°â€ï¼Œè€Œä¸æ˜¯â€œå¯ä»¥å›žæ»šâ€ã€‚ Consistency ä¸€è‡´æ€§ä¸åŒçš„çŽ¯å¢ƒä¸‹æœ‰ç€ä¸åŒçš„å«ä¹‰ï¼š å¤šå‰¯æœ¬çš„ä¸€è‡´æ€§ ä¸€è‡´æ€§hash CAPç†è®ºçš„ä¸€è‡´æ€§ ACIDé‡Œçš„ä¸€è‡´æ€§ ACIDè¯­å¢ƒä¸‹çš„ä¸€è‡´æ€§AID éƒ½æ˜¯æ•°æ®åº“çš„ç‰¹å¾ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ•°æ®åº“çš„å…·ä½“å®žçŽ°ã€‚ä½†æ˜¯å”¯ç‹¬Cä¸ä¸€æ ·ï¼Œå®ƒéœ€è¦ä¾èµ–äºŽåº”ç”¨å±‚ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–äºŽå¼€å‘è€…çš„å…·ä½“å®žçŽ°ã€‚ è¿™é‡Œçš„ä¸€è‡´æ€§æ˜¯æŒ‡ç³»ç»Ÿä»Žä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ï¼Œè¿ç§»åˆ°å¦ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ã€‚ æ­£ç¡®çš„çŠ¶æ€ï¼šå°±æ˜¯å½“å‰çš„çŠ¶æ€æ»¡è¶³é¢„å®šçš„çº¦æŸï¼ˆä¸šåŠ¡ä¸Šçš„è¦æ±‚ï¼‰å°±å«åšæ­£ç¡®çš„çŠ¶æ€ã€‚ ä¸šåŠ¡çš„æ•°æ®ä¸€è‡´æ€§ä¸€èˆ¬ç”¨æ­£ç¡®çš„ä¸šåŠ¡ä»£ç  + å®šæ—¶ä»»åŠ¡ + æ•°æ®åº“è‡ªèº«çš„ç®€å•åˆæ³•æ€§é˜²æŠ¤ï¼ˆäº‹åŠ¡çš„AIDã€é”ç­‰ï¼‰ä¸€èµ·å®žçŽ°ã€‚ Isolation éš”ç¦»æ€§ä¸€ç»„å¯¹æ•°æ®åº“çš„å¹¶å‘ä¿®æ”¹äº’ç›¸ä¸å½±å“ã€‚ å¹¶å‘ä¿®æ”¹çš„æ˜¯äº’ä¸ç›¸å¹²çš„æ•°æ®ï¼Œæœ¬èº«å°±æ»¡è¶³éš”ç¦»çš„æ¡ä»¶ å¹¶å‘ä¿®æ”¹çš„æ˜¯ç›¸å…³è”çš„ï¼Œæˆ–è€…å°±æ˜¯åŒä¸€ä»½æ•°æ®ï¼Œå°±å¿…ç„¶ä¼šç›¸äº’å½±å“ã€‚ ä¿è¯éš”ç¦»æ€§çš„ä¸»è¦é—®é¢˜ä¸åœ¨äºŽéš”ç¦»æœ¬èº«ï¼šè€Œåœ¨äºŽå¦‚æžœå°†è¯»å–ä½œä¸ºå¯¹æ•°æ®ä¿®æ”¹çš„å‰ææ¡ä»¶ï¼Œä¹‹åŽåœ¨å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„ä¸€åˆ¹é‚£ï¼Œè¯»å–æ—¶çš„å‰ææ¡ä»¶è¿˜æ˜¯å¦æ»¡è¶³ã€‚æ¯•ç«Ÿè¯»å–å’Œå†™å…¥æ˜¯ä¸¤ä¸ªåˆ†å¼€çš„æŒ‡ä»¤ï¼Œè€Œåœ¨è¿™ä¸¤ä¸ªæŒ‡ä»¤ä¸­é—´å¯èƒ½å¤¹æ‚å…¶ä»–äº‹åŠ¡å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚ï¼ˆå¦‚ï¼šæ‰¾åˆ°å¯ç”¨çš„åº“å­˜ï¼Œæœ‰åˆ™æ‰£å‡ï¼Œæ²¡æœ‰åˆ™æç¤ºç¼ºè´§ï¼‰ ä¿æŒéš”ç¦»æ€§åšæ³•ï¼šä¿è¯å¯¹å…³è”æ•°æ®çš„ä¿®æ”¹ä¸²è¡ŒåŒ–(SERIALIZABLE) ï¼Œå¦‚ï¼šåŠ é”ï¼Œä½†æ˜¯é”å¯¹æ•°æ®åº“å¹¶å‘çš„æ€§èƒ½è´Ÿé¢å½±å“å¾ˆå¤§ï¼Œæ‰€ä»¥å‡ºçŽ°äº†å‡ ç§å¼±ä¸€äº›çš„éš”ç¦»æ€§ä¿è¯ READ UNCOMMITTED READ COMMITTED REPEATABLE READ Durability æŒä¹…æ€§æ˜¯æŒ‡å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œä¸€æ—¦å®Œæˆï¼Œè¯¥ç»“æžœå°±åº”å½“æ°¸è¿œä¸ä¸¢å¤±ã€‚ åœ¨çŽ°å®žå½“ä¸­ï¼Œ ä¸€èˆ¬é€šè¿‡æŒä¹…æ€§å­˜å‚¨è®¾å¤‡ï¼ˆæ¯”å¦‚ç£ç›˜/SSDï¼‰å†™å…¥å¹¶åˆ·æ–°æ¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§ã€‚ å¦‚æžœè§‰å¾—ä¸€ä¸ªèŠ‚ç‚¹ä¸é è°±ï¼Œå¯ä»¥å¢žåŠ å¤šä¸ªå‰¯æœ¬ï¼ˆreplicaï¼‰ä¸€èµ·æ¥ä¿è¯æŒä¹…ï¼› å¦‚æžœè§‰å¾—è¿™æ ·è¿˜ä¸å¤Ÿé è°±ï¼Œå¯ä»¥åœ¨ä¸åŒçš„åœ°ç†ä½ç½®çš„å¦ä¸€ä¸ªæ•°æ®ä¸­å¿ƒåšå¤‡ä»½ã€‚ å®žé™…ä¸Šç»å¯¹çš„æŒä¹…æ€§æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› ä¸ºæ•´ä¸ªå­˜å‚¨å±‚é¢æœ‰å¾ˆå¤šä¸ç¡®å®šå› ç´ ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿæœ¬èº«fsyncæŒ‡ä»¤å®žçŽ°æœ‰bugï¼Œç£ç›˜çš„å›ºä»¶æœ‰bugï¼Œä¾›ç”µå‡ºçŽ°é—®é¢˜é€ æˆæ•°æ®é”™ä¹±ï¼Œå¼‚æ­¥çš„æ•°æ®å¤åˆ¶æ²¡æœ‰ç”Ÿæ•ˆç­‰ç­‰ã€‚ æ‰€ä»¥åœ¨çŽ°å®žå½“ä¸­çš„æ•°æ®åº“ï¼Œåªèƒ½åœ¨å½“å‰æˆæœ¬å’ŒæŠ€æœ¯é™åˆ¶çš„çº¦æŸä¸‹ï¼Œå°½é‡ç»´æŒä¸€å®šç¨‹åº¦çš„æŒä¹…æ€§ã€‚ æ€»ç»“ï¼šäº‹åŠ¡æ€§æ•°æ®åº“å®žçŽ°çš„æ˜¯ æ”¯æŒæœªå®Œæˆçš„æ•°æ®ä¿®æ”¹å›žæ»šçš„æœºåˆ¶ï¼Œå¯¹åº”â€œåŽŸå­æ€§â€ åŠ›æ‰€èƒ½åŠçš„æ•°æ®åˆæ³•æ€§æ£€æŸ¥ï¼Œå¯¹åº”â€œä¸€è‡´æ€§â€ ä¿è¯æ•°æ®å¹¶å‘çš„ä¿®æ”¹çš„è§„åˆ™ï¼Œå¯¹åº”â€œéš”ç¦»æ€§â€ ä½¿ç”¨åŸºäºŽæŒä¹…åŒ–å­˜å‚¨ï¼ˆç£ç›˜ã€SSDï¼‰çš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨ï¼Œå¯¹åº”â€œæŒä¹…æ€§â€ äº‹åŠ¡éš”ç¦»çº§åˆ« Read uncommittedï¼šå³ä½¿ä¸€ä¸ªäº‹åŠ¡çš„æ›´æ–°è¯­å¥æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯åˆ«çš„äº‹åŠ¡å¯ä»¥è¯»åˆ°è¿™ä¸ªæ”¹å˜ï¼Œé¸¡è‚‹ä¸€èˆ¬çš„å­˜åœ¨ã€‚ Read committedï¼šä¸€ä¸ªäº‹åŠ¡èƒ½çœ‹åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€æ¡æ•°æ®è®°å½•å·²ç»æäº¤çš„ä¿®æ”¹ã€‚ Repeatable readï¼šä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡Œä¸¤æ¬¡æˆ–å¤šæ¬¡åŒæ ·çš„å¯¹äºŽæ•°æ®å†…å®¹çš„æŸ¥è¯¢ï¼Œå¾—åˆ°çš„ç»“æžœæ˜¯ä¸€æ ·çš„ï¼Œä½†ä¸ä¿è¯å¯¹äºŽæ•°æ®æ¡æ•°çš„æŸ¥è¯¢æ˜¯ä¸€æ ·çš„ã€‚ Serializableï¼šäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œä¸å…è®¸å¹¶å‘æ‰§è¡Œã€‚ Repeatable read ç¤ºä¾‹Repeatable Read çš„ç›´è§‚æ„Ÿè§‰ä»¿ä½›æ˜¯ç»™äº‹åŠ¡åšä¸€ä¸ªæ•´ä¸ªæ•°æ®åº“åšäº†ä¸€ä¸ªå¿«ç…§ï¼Œ æ‰€ä»¥å¾ˆå¤šæ—¶å€™è¿™ç§éš”ç¦»çº§åˆ«åˆè¢«ç§°ä¸ºSnapshot Isolationã€‚ äº‹åŠ¡A äº‹åŠ¡B get x (å¾—åˆ°0) set x = 1 commit get x (å¾—åˆ°0) commit â€œå¿«ç…§â€çš„åŠŸèƒ½åœ¨ä¸€äº›åœºæ™¯ä¸‹éžå¸¸é‡è¦ï¼Œå¦‚ï¼š æ•°æ®å¤‡ä»½ï¼šä¾‹å¦‚æ•°æ®åº“Sä»Žæ•°æ®åº“Mä¸­å¤åˆ¶æ•°æ®ï¼Œä½†æ˜¯åŒæ—¶Mæ•°æ®åº“åˆè¢«æŒç»­ä¿®æ”¹ã€‚Séœ€è¦æ‹¿åˆ°ä¸€ä¸ªMçš„æ•°æ®å¿«ç…§ï¼Œä½†æ˜¯åˆä¸èƒ½çœŸçš„æŠŠMç»™åœäº†ã€‚ æ•°æ®åˆæ³•æ€§æ£€æŸ¥ï¼šä¾‹å¦‚æœ‰ä¸¤å¼ æ•°æ®è¡¨ï¼Œä¸€å¼ è®°å½•äº†å½“æ—¶çš„äº¤æ˜“æ€»é¢ï¼Œå¦å¤–ä¸€å¼ è¡¨è®°å½•äº†æ¯ä¸ªäº¤æ˜“çš„é‡‘é¢ã€‚ ==é‚£ä¹ˆåœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æžœæ²¡æœ‰å¿«ç…§çš„å­˜åœ¨ï¼Œäº¤æ˜“é‡‘é¢çš„æ€»å’Œå¯èƒ½ä¸Žå½“æ—¶çš„äº¤æ˜“æ€»é¢å¯¹ä¸ä¸Šï¼Œ== ==å› ä¸ºéšç€æ£€æŸ¥äº‹åŠ¡çš„è¿›è¡Œï¼Œæ–°çš„äº¤æ˜“è®°å½•æ•°æ®ä¼šè¢«æäº¤ã€‚è¿™äº›æ–°çš„æäº¤ä¼šè¢«æ£€æŸ¥äº‹åŠ¡çœ‹åˆ°ã€‚== æ³¨æ„ï¼š å¦‚æžœæ˜¯åŸºäºŽMVCCçš„å®žçŽ°ï¼ŒRepeatable Readå¯ä»¥å®Œå…¨é¿å…å¹»è¯»ã€‚ æ— è®ºMySQLè¿˜æ˜¯PostgreSQLåœ¨Repeatable Readéš”ç¦»çº§åˆ«éƒ½ä¸ä¼šå‡ºçŽ°å¹»è¯»ã€‚ æ•°æ®åº“å¹¶å‘æ“ä½œäº§ç”Ÿçš„é—®é¢˜ä¸¢å¤±æ›´æ–°ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°é—®é¢˜æ­¤ç§æ›´æ–°ä¸¢å¤±æ˜¯å› ä¸ºå›žæ»šçš„åŽŸå› ï¼Œæ‰€ä»¥ä¹Ÿå«==å›žæ»šä¸¢å¤±==ã€‚ æ—¶é—´ å–æ¬¾äº‹åŠ¡A è½¬è´¦äº‹åŠ¡B T1 å¼€å§‹äº‹åŠ¡ T2 å¼€å§‹äº‹åŠ¡ T3 æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ T4 æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ T5 æ±‡å…¥100å…ƒæŠŠä½™é¢æ”¹ä¸º1100å…ƒ T6 æäº¤äº‹åŠ¡ T7 å–å‡º100å…ƒæŠŠä½™é¢æ”¹ä¸º900å…ƒ T8 æ’¤é”€äº‹åŠ¡ï¼Œä½™é¢æ¢å¤ä¸º1000 å…ƒï¼ˆä¸¢å¤±æ›´æ–°ï¼‰ æ³¨æ„ï¼š Aäº‹åŠ¡åœ¨æ’¤é”€æ—¶ï¼Œå°†Bäº‹åŠ¡å·²ç»è½¬å…¥è´¦æˆ·çš„é‡‘é¢ç»™æŠ¹åŽ»äº†ï¼Œæ­¤æ—¶ä½™é¢ä¸º1000å…ƒã€‚ ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜æ­¤ç§æ›´æ–°ä¸¢å¤±æ˜¯å› ä¸ºæ›´æ–°è¢«å…¶ä»–äº‹åŠ¡ç»™è¦†ç›–äº†ï¼Œä¹Ÿå¯ä»¥å«==è¦†ç›–ä¸¢å¤±==ã€‚ æ—¶é—´ è½¬è´¦äº‹åŠ¡A å–æ¬¾äº‹åŠ¡B T1 å¼€å§‹äº‹åŠ¡ T2 å¼€å§‹äº‹åŠ¡ T3 æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ T4 æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º1000å…ƒ T5 å–å‡º100å…ƒæŠŠä½™é¢æ”¹ä¸º900å…ƒ T6 æäº¤äº‹åŠ¡ T7 æ±‡å…¥100å…ƒ T8 æäº¤äº‹åŠ¡ï¼ŒæŠŠä½™é¢æ”¹ä¸º1100 å…ƒï¼ˆä¸¢å¤±æ›´æ–°ï¼‰ æ³¨æ„ï¼šAäº‹åŠ¡æŠŠBäº‹åŠ¡çš„é‡‘é¢ä¿®æ”¹äº†ï¼Œæ­¤æ—¶ä½™é¢ä¸º1100å…ƒã€‚ è„è¯»Aäº‹åŠ¡è¯»å–Bäº‹åŠ¡å°šæœªæäº¤çš„æ›´æ”¹æ•°æ®ï¼Œå¹¶åœ¨è¿™ä¸ªæ•°æ®çš„åŸºç¡€ä¸Šè¿›è¡Œæ“ä½œã€‚ æ—¶é—´ å‘˜å·¥äº‹åŠ¡A è€æ¿äº‹åŠ¡B T1 å¼€å§‹äº‹åŠ¡ T2 å¼€å§‹äº‹åŠ¡ T3 ç»™å‘˜å·¥è´¦æˆ·è½¬è´¦5000å…ƒ T4 æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º5000å…ƒ(è„è¯») T5 æäº¤äº‹åŠ¡ T6 æ’¤é”€äº‹åŠ¡ T7 å¼€å§‹äº‹åŠ¡ T8 ç»™å‘˜å·¥è´¦æˆ·è½¬è´¦2000å…ƒ T9 æäº¤äº‹åŠ¡ è§£é‡Š â€‹ å…¬å¸å‘å·¥èµ„äº†ï¼Œé¢†å¯¼æŠŠ5000å…ƒæ‰“åˆ°å‘˜å·¥çš„è´¦å·ä¸Šï¼Œä½†æ˜¯è¯¥äº‹åŠ¡å¹¶æœªæäº¤ï¼Œè€Œå‘˜å·¥æ­£å¥½åŽ»æŸ¥çœ‹è´¦æˆ·ï¼Œå‘çŽ°5000å…ƒå·¥èµ„åˆ°è´¦ã€‚ä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œé¢†å¯¼å‘çŽ°å‘ç»™å‘˜å·¥çš„å‘çš„å·¥èµ„é‡‘é¢ä¸å¯¹ï¼Œæ˜¯2000å…ƒï¼ŒäºŽæ˜¯å›žæ»šäº†äº‹åŠ¡ï¼Œä¿®æ”¹ä¸º2000åŽï¼Œå°†äº‹åŠ¡æäº¤ï¼Œæœ€åŽå‘˜å·¥å®žé™…çš„å·¥èµ„æ˜¯åªæœ‰ 2000å…ƒã€‚ ä¸å¯é‡å¤è¯»æ˜¯æŒ‡åœ¨Aäº‹åŠ¡å†…ï¼Œå¤šæ¬¡è¯»åŒä¸€æ•°æ®ï¼Œä½†æ˜¯ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®å†…å®¹ä¸ä¸€æ ·ã€‚ï¼ˆå³ä¸èƒ½è¯»åˆ°ç›¸åŒçš„æ•°æ®å†…å®¹ï¼‰ æ—¶é—´ å‘˜å·¥äº‹åŠ¡A å‘˜å·¥è€å©†äº‹åŠ¡B T1 å¼€å§‹äº‹åŠ¡ T2 å¼€å§‹äº‹åŠ¡ T3 å‡†å¤‡ä»˜æ¬¾ï¼ŒæŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º2000å…ƒ T4 ç½‘ä¸Šè½¬è´¦2000å…ƒ T5 æäº¤äº‹åŠ¡ T6 ä»˜æ¬¾ï¼ŒæŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸º0å…ƒï¼Œä»˜æ¬¾å¤±è´¥ T7 æäº¤äº‹åŠ¡ è§£é‡Š å‘˜å·¥æ‹¿ç€å·¥èµ„å¡åŽ»æ¶ˆè´¹ï¼Œç³»ç»Ÿè¯»å–åˆ°å¡é‡Œç¡®å®žæœ‰2000å…ƒï¼Œè€Œæ­¤æ—¶ä»–è€å©†ä¹Ÿæ­£å¥½åœ¨ç½‘ä¸Šè½¬è´¦ï¼ŒæŠŠå·¥èµ„å¡çš„2000å…ƒè½¬åˆ°å¦ä¸€è´¦æˆ·ï¼Œ å¹¶åœ¨å‘˜å·¥ä¹‹å‰æäº¤äº†äº‹åŠ¡ï¼Œå½“å‘˜å·¥è¿›è¡Œæ‰£æ¬¾æ—¶ï¼Œç³»ç»Ÿæ£€æŸ¥åˆ°å‘˜å·¥çš„å·¥èµ„å¡å·²ç»æ²¡æœ‰é’±ï¼Œæ‰£æ¬¾å¤±è´¥ã€‚ å¹»è¯»æ˜¯æŒ‡å½“äº‹åŠ¡ä¸æ˜¯ç‹¬ç«‹æ‰§è¡Œæ—¶å‘ç”Ÿçš„ä¸€ç§çŽ°è±¡ï¼ŒAäº‹åŠ¡å¯¹ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™ç§ä¿®æ”¹æ¶‰åŠåˆ°è¡¨ä¸­çš„å…¨éƒ¨æ•°æ®è¡Œã€‚åŒæ—¶ï¼ŒBäº‹åŠ¡ä¹Ÿä¿®æ”¹è¿™ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œè¿™ç§ä¿®æ”¹æ˜¯å‘è¡¨ä¸­æ’å…¥æˆ–åˆ é™¤ä¸€è¡Œæ•°æ®ã€‚é‚£ä¹ˆï¼Œæ“ä½œAäº‹åŠ¡çš„ç”¨æˆ·ä¼šå‘çŽ°è¡¨ä¸­è¿˜æœ‰å°šæœªè¢«ä¿®æ”¹çš„æ•°æ®è¡Œï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ã€‚ æ—¶é—´ å‘˜å·¥è€å©†äº‹åŠ¡A å‘˜å·¥äº‹åŠ¡B T1 å¼€å§‹äº‹åŠ¡ T2 å¼€å§‹äº‹åŠ¡ T3 æŸ¥è¯¢ä¿¡ç”¨å¡çš„æ¶ˆè´¹è®°å½•æ€»é¢ä¸º80å…ƒ T4 å®¢æˆ·åº”é…¬ï¼Œä¿¡ç”¨å¡ä»˜æ¬¾1000å…ƒ T5 æäº¤äº‹åŠ¡ T6 æ‰“å°ä¿¡ç”¨å¡è´¦å•ï¼Œæ€»é¢ä¸º1080å…ƒï¼ˆå¹»è¯»ï¼‰ T7 æäº¤äº‹åŠ¡ è§£é‡Š å‘˜å·¥è€å©†æ—¶å¸¸æŸ¥çœ‹å‘˜å·¥çš„ä¿¡ç”¨å¡æ¶ˆè´¹è®°å½•ã€‚æœ‰ä¸€å¤©ï¼Œå¥¹æ­£åœ¨æŸ¥è¯¢åˆ°å‘˜å·¥å½“æœˆä¿¡ç”¨å¡çš„æ€»æ¶ˆè´¹é‡‘é¢ ï¼ˆselect sum(amount) from transaction where month = æœ¬æœˆï¼‰ä¸º80å…ƒï¼Œè€Œå‘˜å·¥æ­¤æ—¶æ­£å¥½åº”é…¬å®ŒåŽåœ¨æ”¶é“¶å°ä¹°å•ï¼Œæ¶ˆè´¹äº†1000å…ƒï¼Œå³æ–°å¢žäº†ä¸€æ¡1000å…ƒçš„æ¶ˆè´¹è®°å½•ï¼ˆinsert transaction ... ï¼‰ï¼Œå¹¶æäº¤äº‹åŠ¡ï¼ŒéšåŽå‘˜å·¥è€å©†æ‰“å°å½“æœˆä¿¡ç”¨å¡ç« æ³•ï¼Œå´å‘çŽ°æ¶ˆè´¹æ€»é¢ä¸º1080å…ƒï¼Œå‘˜å·¥è€å©†å¾ˆè¯§å¼‚ï¼Œä»¥ä¸ºå‡ºçŽ°äº†å¹»è§‰ï¼Œå¹»è¯»å°±è¿™æ ·äº§ç”Ÿäº†ã€‚ å¹»è¯»å’Œä¸å¯é‡å¤è¯»å¼ºè°ƒçš„ç»´åº¦ä¸ä¸€æ ·: ä¸å¯é‡å¤è¯»æ˜¯æŒ‡Aæ“ä½œæ•°æ®æ—¶ï¼ŒBå¯ä»¥ä¿®æ”¹è¯¥è¡Œæ•°æ®ã€‚ å¹»è¯»æ˜¯æŒ‡Aæ“ä½œæ•°æ®æ—¶ï¼ŒBå¯ä»¥æ–°å¢ž/åˆ é™¤ä¸€æ¡æ•°æ®ï¼ˆæ˜¯å¯¹æ€»è®°å½•æ•°æœ‰å½±å“çš„ï¼‰ã€‚ éš”ç¦»çº§åˆ«å¯¹å¼‚å¸¸çš„æŽ§åˆ¶èƒ½åŠ› éš”ç¦»çº§åˆ«\å¹¶å‘é—®é¢˜ ç¬¬ä¸€ç±»æ›´æ–°ä¸¢å¤± è„è¯» ä¸å¯é‡å¤è¯» ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–° å¹»è¯» Read uncommitted Y Y Y Y Y Read committed N N Y Y Yï¼ˆMVVC-&gt; Nï¼‰ Repeatable read N N N Y Yï¼ˆMVVC-&gt; Nï¼‰ Serializable N N N N N å†™å‰æå›°å¢ƒä¸šåŠ¡ä»£ç ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼š å…ˆè¯»å–ä¸€æ®µçŽ°æœ‰çš„æ•°æ®ï¼› åœ¨è¿™ä¸ªæ•°æ®çš„åŸºç¡€ä¸Šåšé€»è¾‘åˆ¤æ–­æˆ–è€…è®¡ç®—ï¼› å°†è®¡ç®—çš„ç»“æžœå†™å›žæ•°æ®åº“ï¼› ç¬¬ä¸‰æ­¥çš„å†™å…¥ä¼šä¾èµ–ç¬¬ä¸€æ­¥çš„è¯»å–ã€‚è€Œä¸”åœ¨1å’Œ3ä¹‹é—´ï¼Œä¸ç®¡ä¸šåŠ¡ä»£ç ç¦»å¾—æœ‰å¤šè¿‘ï¼Œéƒ½æ— æ³•é¿å…å…¶ä»–äº‹åŠ¡çš„å¹¶å‘ä¿®æ”¹ã€‚å³ï¼šåœ¨å½“å‰äº‹åŠ¡è¯»å–è¿™æ®µæ•°æ®åŽï¼Œåˆæœ‰å¦ä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®ï¼Œè€Œå½“å‰äº‹åŠ¡å°†ç»“æžœå†™å›žæ•°æ®åº“ï¼Œä¼šé€ æˆå¦ä¸€ä¸ªäº‹åŠ¡çš„ä¿®æ”¹ä¸¢å¤±ã€‚ è¿™ä¸ªé—®é¢˜å°±æ˜¯åœ¨ä¿®æ”¹çš„äº‹åŠ¡åœ¨æäº¤æ—¶ï¼Œæ— æ³•ç¡®ä¿è¿™ä¸ªä¿®æ”¹çš„å‰ææ˜¯å¦è¿˜å¯é ã€‚è¿™ç§é—®é¢˜ç§°ä¹‹ä¸ºå†™å‰æå›°å¢ƒã€‚ Solution äº‹åŠ¡éš”ç¦»çº§åˆ«ç”¨Serializableï¼› åŠ æ‚²è§‚é”ï¼›å†™å…¥è¾ƒå¤šçš„æƒ…å†µ åŠ ä¹è§‚é”ï¼›è¯»å–è¾ƒå¤šçš„æƒ…å†µ]]></content>
      <categories>
        <category>äº‹åŠ¡</category>
      </categories>
      <tags>
        <tag>äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•°æ®åº“é”]]></title>
    <url>%2F2020%2F09%2F06%2F%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%81%2F</url>
    <content type="text"><![CDATA[æ•°æ®åº“é”é”çš„åˆ†ç±»æŒ‰èŽ·å–é”çš„æ–¹å¼ï¼š æŽ’ä»–é” å…±äº«é” æŒ‰ç³»ç»Ÿå¹¶å‘ï¼š æ‚²è§‚é” ä¹è§‚é” æŒ‰ä¿æŠ¤å¯¹è±¡ï¼š DMLé”ï¼š TXè¡Œé” TMè¡¨é” DDLé”ï¼š DDLæŽ’ä»–é” DDLå…±äº«é” DDLå¯åˆ†è§£è§£æžé” ç³»ç»Ÿé”ï¼š é—©é”Latch äº’æ–¥é”Mutexes å†…éƒ¨é”ï¼š å­—å…¸ç¼“å­˜é” æ–‡ä»¶å’Œæ—¥å¿—ç®¡ç†é” è¡¨ç©ºé—´å’Œæ’¤é”€æ®µé” ä¹è§‚é” å’Œ æ‚²è§‚é” æ˜¯ä¸€ç§æ€æƒ³ å®žçŽ°å½¢å¼å¯èƒ½ä¸ä¸€æ ·ï¼šå¦‚ Javaçš„åŽŸå­ç±»ï¼Œæ•°æ®åº“çš„versionå­—æ®µ æ‚²è§‚é”é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆæ‚²è§‚ï¼Œå®ƒå¯¹äºŽæ•°æ®è¢«å¤–ç•Œä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œè®¤ä¸ºæ•°æ®éšæ—¶ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ•´ä¸ªæ•°æ®å¤„ç†ä¸­éœ€è¦å°†æ•°æ®åŠ é”ã€‚æ‚²è§‚é”ä¸€èˆ¬éƒ½æ˜¯ä¾é å…³ç³»æ•°æ®åº“æä¾›çš„é”æœºåˆ¶ï¼Œäº‹å®žä¸Šå…³ç³»æ•°æ®åº“ä¸­çš„è¡Œé”ï¼Œè¡¨é”ä¸è®ºæ˜¯è¯»å†™é”éƒ½æ˜¯æ‚²è§‚é”ã€‚ æ‚²è§‚é”æŒ‰ç…§ä½¿ç”¨æ€§è´¨åˆ’åˆ†å…±äº«é”(Sé”) å¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶è¯»ï¼Œä½†ä¸èƒ½æœ‰å†™æ“ä½œ è¯»é”ï¼Œäº‹åŠ¡Aå¯¹å¯¹è±¡TåŠ Sé”ï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿåªèƒ½å¯¹TåŠ Sï¼Œç›´åˆ°Aé‡Šæ”¾Sé”ã€‚ æŽ’å®ƒé”(Xé”) åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ“ä½œï¼Œå…¶ä»–äº‹åŠ¡ç­‰å¾… å†™é”ï¼Œäº‹åŠ¡Aå¯¹å¯¹è±¡TåŠ Xé”ä»¥åŽï¼Œå…¶ä»–äº‹åŠ¡ä¸èƒ½å¯¹TåŠ ä»»ä½•é”ï¼Œåªæœ‰äº‹åŠ¡Aå¯ä»¥è¯»å†™å¯¹è±¡Tç›´åˆ°Aé‡Šæ”¾Xé”ã€‚ æ›´æ–°é”(Ué”)ç”¨æ¥é¢„å®šè¦å¯¹æ­¤å¯¹è±¡æ–½åŠ Xé”ï¼Œå®ƒå…è®¸å…¶ä»–äº‹åŠ¡è¯»ï¼Œä½†ä¸å…è®¸å†æ–½åŠ Ué”æˆ–Xé”ï¼›å½“è¢«è¯»å–çš„å¯¹è±¡å°†è¦è¢«æ›´æ–°æ—¶ï¼Œåˆ™å‡çº§ä¸ºXé”ï¼Œä¸»è¦æ˜¯ç”¨æ¥é˜²æ­¢æ­»é”çš„ã€‚å› ä¸ºä½¿ç”¨å…±äº«é”æ—¶ï¼Œä¿®æ”¹æ•°æ®çš„æ“ä½œåˆ†ä¸ºä¸¤æ­¥ï¼Œé¦–å…ˆèŽ·å¾—ä¸€ä¸ªå…±äº«é”ï¼Œè¯»å–æ•°æ®ï¼Œç„¶åŽå°†å…±äº«é”å‡çº§ä¸ºæŽ’å®ƒé”ï¼Œç„¶åŽå†æ‰§è¡Œä¿®æ”¹æ“ä½œã€‚è¿™æ ·å¦‚æžœåŒæ—¶æœ‰ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åŒæ—¶å¯¹ä¸€ä¸ªå¯¹è±¡ç”³è¯·äº†å…±äº«é”ï¼Œåœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œè¿™äº›äº‹åŠ¡éƒ½è¦å°†å…±äº«é”å‡çº§ä¸ºæŽ’å®ƒé”ã€‚è¿™äº›äº‹åŠ¡éƒ½ä¸ä¼šé‡Šæ”¾å…±äº«é”è€Œæ˜¯ä¸€ç›´ç­‰å¾…å¯¹æ–¹é‡Šæ”¾ï¼Œè¿™æ ·å°±é€ æˆäº†æ­»é”ã€‚å¦‚æžœä¸€ä¸ªæ•°æ®åœ¨ä¿®æ”¹å‰ç›´æŽ¥ç”³è¯·æ›´æ–°é”ï¼Œåœ¨æ•°æ®ä¿®æ”¹çš„æ—¶å€™å†å‡çº§ä¸ºæŽ’å®ƒé”ï¼Œå°±å¯ä»¥é¿å…æ­»é”ã€‚ æŽ’å®ƒé”å’Œå…±äº«é”çš„ç›¸å®¹çŸ©é˜µ T1\T2 X S - X N N Y S N Y Y - Y Y Y æ‚²è§‚é”æŒ‰ç…§ä½œç”¨èŒƒå›´åˆ’åˆ†è¡Œé” ä½œç”¨èŒƒå›´ï¼šè¡Œçº§åˆ« æ•°æ®åº“èƒ½å¤Ÿç¡®å®šé‚£äº›è¡Œéœ€è¦é”çš„æƒ…å†µä¸‹ä½¿ç”¨è¡Œé”ï¼Œå¦‚æžœä¸çŸ¥é“ä¼šå½±å“å“ªäº›è¡Œçš„æ—¶å€™å°±ä¼šä½¿ç”¨è¡¨é”ã€‚ ä¸¾ä¾‹ï¼š â€‹ ä¸€ä¸ªç”¨æˆ·è¡¨userï¼Œæœ‰ä¸»é”®idå’Œç”¨æˆ·ç”Ÿæ—¥birthdayå½“ä½ ä½¿ç”¨update â€¦ where id=?è¿™æ ·çš„è¯­å¥æ•°æ®åº“æ˜Žç¡®çŸ¥é“ä¼šå½±å“å“ªä¸€è¡Œï¼Œå®ƒå°±ä¼šä½¿ç”¨è¡Œé”ï¼Œå½“ä½ ä½¿ç”¨update â€¦ where birthday=?è¿™æ ·çš„çš„è¯­å¥çš„æ—¶å€™å› ä¸ºäº‹å…ˆä¸çŸ¥é“ä¼šå½±å“å“ªäº›è¡Œå°±å¯èƒ½ä¼šä½¿ç”¨è¡¨é”ã€‚ è¡¨é” ä½œç”¨èŒƒå›´ï¼šæ•´å¼ è¡¨ ä¹è§‚é”é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡è‡ªå·±æ“ä½œæ•°æ®çš„æ—¶å€™è®¤ä¸ºæ²¡æœ‰äººå›žæ¥ä¿®æ”¹å®ƒï¼Œæ‰€ä»¥ä¸åŽ»åŠ é”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåŽ»åˆ¤æ–­åœ¨æ­¤æœŸé—´æ•°æ®æœ‰æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œéœ€è¦ç”¨æˆ·è‡ªå·±åŽ»å®žçŽ°ã€‚ ä¸¤ç§é”çš„ä½¿ç”¨åœºæ™¯ ä¸¤ç§é”å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œä¸å¯è®¤ä¸ºä¸€ç§å¥½äºŽå¦ä¸€ç§ï¼Œåƒä¹è§‚é”é€‚ç”¨äºŽå†™æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼ˆå¤šè¯»åœºæ™¯ï¼‰ï¼Œå³å†²çªçœŸçš„å¾ˆå°‘å‘ç”Ÿçš„æ—¶å€™ï¼Œè¿™æ ·å¯ä»¥çœåŽ»äº†é”çš„å¼€é”€ï¼ŒåŠ å¤§äº†ç³»ç»Ÿçš„æ•´ä¸ªåžåé‡ã€‚ä½†å¦‚æžœæ˜¯å¤šå†™çš„æƒ…å†µï¼Œä¸€èˆ¬ä¼šç»å¸¸äº§ç”Ÿå†²çªï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸Šå±‚åº”ç”¨ä¼šä¸æ–­çš„è¿›è¡Œretryï¼Œè¿™æ ·åå€’æ˜¯é™ä½Žäº†æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€èˆ¬å¤šå†™çš„åœºæ™¯ä¸‹ç”¨æ‚²è§‚é”å°±æ¯”è¾ƒåˆé€‚ã€‚ ä¹è§‚é”å®žçŽ°æ–¹å¼ç‰ˆæœ¬å· å®žçŽ°ï¼šå®žä½“ä¸Šå¢žåŠ ç‰ˆæœ¬æ ‡è¯†ï¼Œæ•°æ®åº“ä¸Šè¡¨å¢žåŠ ä¸€ä¸ªversionå­—æ®µï¼›æ¯æ¬¡æ›´æ–°æŠŠè¿™ä¸ªå­—æ®µåŠ 1 åŽŸç†ï¼šè¯»æ•°æ®æ—¶æŠŠversionè¯»å‡ºæ¥ï¼Œåœ¨æ›´æ–°æ•°æ®æ—¶æ¯”è¾ƒversionï¼Œå¦‚æžœè¯»çš„versionæ²¡æœ‰å˜åŒ–å¯ä»¥æ›´æ–°äº†ï¼Œå¦‚æžœDBçš„versionæ¯”è¯»çš„versionå¤§ï¼Œè¯´æ˜Žæœ‰å…¶ä»–äº‹åŠ¡æ›´æ–°äº†è¯¥æ•°æ®ã€‚è¿™æ—¶å€™å¾—åˆ°ä¸€ä¸ªæ— æ³•æ›´æ–°çš„é€šçŸ¥ï¼Œç”¨æˆ·è‡ªè¡Œæ ¹æ®è¿™ä¸ªé€šçŸ¥æ¥å†³å®šæ€Žä¹ˆå¤„ç†ï¼Œæ¯”å¦‚é‡æ–°å¼€å§‹ä¸€éã€‚ å…³é”®ï¼šåˆ¤æ–­versionå’Œæ›´æ–°ä¸¤ä¸ªåŠ¨ä½œéœ€è¦ä½œä¸ºä¸€ä¸ªåŽŸå­å•å…ƒæ‰§è¡Œï¼Œå¦åˆ™åœ¨ä½ åˆ¤æ–­å¯ä»¥æ›´æ–°ï¼Œä½†æ˜¯åœ¨æ­£å¼æ›´æ–°å‰ï¼Œåˆæœ‰åˆ«çš„æ•°æ®ä¿®æ”¹äº†versionï¼Œè¿™ä¸ªæ—¶å€™ä½ çš„æ›´æ–°å°±ä¼šè¦†ç›–åˆ«çš„äº‹åŠ¡çš„æ›´æ–°ï¼Œé€ æˆç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°é—®é¢˜ã€‚ update â€¦ , version = version + 1 where â€¦ and version=&#39;old version&#39;;ï¼Œæ ¹æ®è¿”å›žç»“æžœæ˜¯0è¿˜æ˜¯éž0æ¥åˆ¤æ–­æ˜¯å¦æ›´æ–°æˆåŠŸã€‚ æ—¶é—´æˆ³ å’Œç‰ˆæœ¬å·åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯é€šè¿‡æ—¶é—´æˆ³æ¥åˆ¤æ–­è€Œå·²ï¼Œæ³¨æ„æ—¶é—´æˆ³è¦ä½¿ç”¨æ•°æ®åº“æœåŠ¡å™¨çš„æ—¶é—´æˆ³ä¸èƒ½æ˜¯ä¸šåŠ¡ç³»ç»Ÿçš„æ—¶é—´ å¾…æ›´æ–°å­—æ®µ å®žçŽ°ï¼šå’Œç‰ˆæœ¬å·æ–¹å¼ç›¸ä¼¼ï¼Œåªæ˜¯ä¸å¢žåŠ é¢å¤–å­—æ®µï¼Œç›´æŽ¥ä½¿ç”¨æœ‰æ•ˆæ•°æ®å­—æ®µåšç‰ˆæœ¬æŽ§åˆ¶ä¿¡æ¯ï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½æ— æ³•æ”¹å˜æ—§ç³»ç»Ÿçš„æ•°æ®åº“è¡¨ç»“æž„ã€‚ åŽŸç†ï¼šå‡å¦‚å¾…æ›´æ–°å­—æ®µå«countï¼Œå…ˆåŽ»è¯»å–è¿™ä¸ªcountï¼Œæ›´æ–°æ—¶åŽ»æ¯”è¾ƒæ•°æ®åº“ä¸­countçš„å€¼æ˜¯ä¸æ˜¯åŽŸæ¥è¯»å–çš„å€¼ï¼Œå¦‚æžœæ˜¯å°±æ›´æ–°ï¼Œå¦åˆ™æ›´æ–°å¤±è´¥ã€‚JAVAåŽŸå­ç±»åž‹å¯¹è±¡ï¼šå¦‚AtomicIntegerå°±æ˜¯è¿™ç§æ€æƒ³ã€‚ æ‰€æœ‰å­—æ®µ å’Œå¾…æ›´æ–°å­—æ®µç±»ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨æ‰€æœ‰å­—æ®µåšç‰ˆæœ¬æŽ§åˆ¶ä¿¡æ¯ï¼Œåªæœ‰æ‰€æœ‰å­—æ®µéƒ½æ²¡å˜åŒ–æ‰ä¼šæ‰§è¡Œæ›´æ–°ã€‚]]></content>
      <categories>
        <category>é”</category>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Vue Mixin]]></title>
    <url>%2F2020%2F08%2F25%2FVue%20Mixin%2F</url>
    <content type="text"><![CDATA[å‚è€ƒè¿žæŽ¥ å±€éƒ¨ mixinå½“å¤šä¸ªç»„ä»¶éƒ½éœ€è¦ç”¨åˆ°ç›¸åŒå¾—åˆ°æ–¹æ³•æˆ–è€…dataæœ‰ç›¸åŒçš„å±žæ€§ï¼Œå°±å¯ä»¥ä½¿ç”¨mixinè¿›è¡Œå°è£… éœ€è¦å°è£…çš„æ–¹æ³•å’Œå±žæ€§ â€“&gt; mixin.js ï¼ˆåå­—æ ¹æ®ä¸šåŠ¡å®šä¹‰ï¼‰ 1234567891011121314151617181920212223export default &#123; name: 'Mixin', data() &#123; return &#123; message: 'hello' &#125; &#125;, //å¯ä»¥æ·»åŠ é’©å­å‡½æ•° created() &#123; console.log('æˆ‘æ˜¯ mixins ä¸­çš„ created') &#125;, methods: &#123; show(num) &#123; console.log(num) // mixinsçš„å‡½æ•°å¯ä»¥æŽ¥æ”¶ç»„ä»¶ä¼ çš„å‚æ•°ã€‚ &#125;, foo() &#123; console.log('foo') &#125;, conflicting() &#123; console.log('from mixin') &#125; &#125;&#125; éœ€è¦ä½¿ç”¨mixin.jsé‡Œé¢çš„æ–¹æ³•å’Œå±žæ€§çš„vueæ–‡ä»¶ â€“&gt; test.vue 1234567891011121314151617181920212223242526272829303132333435&lt;template&gt; &lt;div/&gt;&lt;/template&gt;&lt;script&gt;import mixin from &apos;../mixins/mixin&apos; export default &#123; name: &apos;Test&apos;, mixins: [mixin], // è¿™é‡Œå¼•å…¥mixin.js data() &#123; return &#123; title: &apos;def&apos;, message: &apos;goodbye&apos; &#125; &#125;, created() &#123; console.log(&apos;æˆ‘æ˜¯Vueä¸­çš„created&apos;) console.log(this.$data) this.show(50); //å¯é€šè¿‡å‡½æ•°ä¼ å‚,æŠŠç»„ä»¶ä¸­éœ€è¦çš„å‚æ•°ä¼ ç»™mixinsè¿›è¡Œä½¿ç”¨ã€‚ &#125;, methods: &#123; bar() &#123; console.log(&apos;bar&apos;) &#125;, conflicting() &#123; console.log(&apos;from self&apos;) &#125; &#125;&#125;&lt;/script&gt;&lt;style lang=&quot;scss&quot; scoped&gt;&lt;/style&gt; æ³¨æ„ ç»„ä»¶ â€“&gt; test.vue æ··å…¥å¯¹è±¡ â€“&gt; mixin.js å½“ç»„ä»¶å’Œæ··å…¥å¯¹è±¡å«æœ‰åŒåé€‰é¡¹ï¼ˆå±žæ€§/æ–¹æ³•ï¼‰æ—¶ï¼Œè¿™äº›é€‰é¡¹å°†ä»¥æ°å½“çš„æ–¹å¼æ··åˆã€‚ æ¯”å¦‚ï¼Œæ•°æ®å¯¹è±¡åœ¨å†…éƒ¨ä¼šè¿›è¡Œæµ…åˆå¹¶ (ä¸€å±‚å±žæ€§æ·±åº¦)ï¼Œåœ¨å’Œç»„ä»¶çš„æ•°æ®å‘ç”Ÿå†²çªæ—¶ä»¥ç»„ä»¶æ•°æ®ä¼˜å…ˆã€‚ ä¸Šè¿°ä¾‹å­ï¼š 123456789101112131415161718&gt; data: &#123;&gt; return: &#123;&gt; title: 'def', // mixin.jså±žæ€§è£…è¿›ç»„ä»¶é‡Œé¢&gt; message: 'goodbye' // ä¸Žmixin.jsåŒåï¼Œç»„ä»¶ä¼˜å…ˆ&gt; &#125;&gt; &#125;,&gt; methods: &#123;&gt; show(num) &#123; // mixin.jsæ–¹æ³•è£…è¿›ç»„ä»¶é‡Œé¢&gt; console.log(num) &gt; &#125;, &gt; bar() &#123; // ä¸Žmixin.jsåŒåï¼Œç»„ä»¶ä¼˜å…ˆ&gt; console.log('bar')&gt; &#125;,&gt; conflicting() &#123; // ä¸Žmixin.jsåŒåï¼Œç»„ä»¶ä¼˜å…ˆ&gt; console.log('from self')&gt; &#125;, &gt; &#125;&gt; åŒåé’©å­å‡½æ•°å°†æ··åˆä¸ºä¸€ä¸ªæ•°ç»„ï¼Œéƒ½ä¼šè¢«è°ƒç”¨ã€‚ æ··å…¥å¯¹è±¡çš„é’©å­å°†åœ¨ç»„ä»¶è‡ªèº«é’©å­ä¹‹å‰è°ƒç”¨ã€‚ å€¼ä¸ºå¯¹è±¡çš„é€‰é¡¹ï¼Œä¾‹å¦‚ methods, components å’Œ directivesï¼Œå°†è¢«æ··åˆä¸ºåŒä¸€ä¸ªå¯¹è±¡ã€‚ ä¸¤ä¸ªå¯¹è±¡é”®åå†²çªæ—¶ï¼Œå–ç»„ä»¶å¯¹è±¡çš„é”®å€¼å¯¹ã€‚ å…¨å±€ mixin æ…Žç”¨: ä¸€æ—¦ä½¿ç”¨å…¨å±€æ··å…¥å¯¹è±¡ï¼Œå°†ä¼šå½±å“åˆ° æ‰€æœ‰ ä¹‹åŽåˆ›å»ºçš„ Vue å®žä¾‹ 1Vue.mixin(&#123;&#125;)]]></content>
      <categories>
        <category>Vue</category>
      </categories>
      <tags>
        <tag>Vue</tag>
        <tag>Mixin</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é˜²æŠ–åŠ¨]]></title>
    <url>%2F2020%2F08%2F20%2F%E9%98%B2%E6%8A%96%E5%8A%A8%2F</url>
    <content type="text"><![CDATA[å‚è€ƒçš„è¿žæŽ¥ ä»€ä¹ˆæ˜¯é˜²æŠ–æ‰€è°“é˜²æŠ–ï¼Œå°±æ˜¯æŒ‡è§¦å‘äº‹ä»¶åŽåœ¨nç§’å†…åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æžœåœ¨nç§’å†…è§¦å‘äº‹ä»¶çš„ï¼Œåˆ™ä¼šé‡æ–°è®¡ç®—å‡½æ•°æ‰§è¡Œäº‹ä»¶ é˜²æŠ–çš„ä¸¤ç§çŠ¶æ€ç«‹å³æ‰§è¡Œè§¦å‘äº‹ä»¶åŽå‡½æ•°ç«‹å³æ‰§è¡Œ éžç«‹å³æ‰§è¡Œè§¦å‘äº‹ä»¶åŽå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨nç§’åŽå¼€å§‹æ‰§è¡Œ é˜²æŠ–ä½¿ç”¨åœºæ™¯ é˜²æŠ–å‡½æ•°å¸¸ç”¨æ¥è¿›è¡Œå¤„ç†æŸäº›é¢‘ç¹è§¦å‘çš„è¯·æ±‚äº‹ä»¶ï¼ˆæˆ–è€…å‰ç«¯è®¡ç®—çš„äº‹ä»¶ï¼‰ windowæ»šåŠ¨æ¡äº‹ä»¶ scroll windowçš„resize é¼ æ ‡çš„mouse move ä¸‹æ‹‰æ¡†çš„è¿œç¨‹æ¨¡ç³Šæœç´¢ è¡¨å•ç»„ä»¶è¾“å…¥å†…å®¹éªŒè¯ é˜²æ­¢å¤šæ¬¡ç‚¹å‡»å¯¼è‡´è¡¨å•å¤šæ¬¡æäº¤ ç›®çš„ï¼šé™åˆ¶å‡½æ•°è§¦å‘é¢‘çŽ‡ï¼›å¯¹æ€§èƒ½ä¼˜åŒ–ï¼Œå‡å°‘æœåŠ¡å™¨è´Ÿæ‹…ï¼› å®žçŽ°æ ¸å¿ƒï¼šç»´æŠ¤ä¸€ä¸ªsetTimeoutï¼Œåœ¨å†·å´æ—¶é—´å†…å†æ¬¡è§¦å‘å‡½æ•°åˆ™æ¸…ç©ºåŽŸsetTimeouté‡æ–°è®¡ç®—ä¸€ä¸ªsetTimeoutæŽ¨å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ lodashçš„æ–¹æ³•1_.debounce(func, [wait=0], [options=&#123;&#125;]) å‚æ•° func (Function): è¦é˜²æŠ–åŠ¨çš„å‡½æ•°ã€‚ [wait=0] (number): éœ€è¦å»¶è¿Ÿçš„æ¯«ç§’æ•°ã€‚ [options={}] (Object): é€‰é¡¹å¯¹è±¡ã€‚ [options.leading=false] (boolean): æŒ‡å®šåœ¨å»¶è¿Ÿå¼€å§‹å‰è°ƒç”¨ã€‚ [options.maxWait] (number): è®¾ç½® func å…è®¸è¢«å»¶è¿Ÿçš„æœ€å¤§å€¼ã€‚ [options.trailing=true] (boolean): æŒ‡å®šåœ¨å»¶è¿Ÿç»“æŸåŽè°ƒç”¨ã€‚ è¿”å›ž(Function): è¿”å›žæ–°çš„ debouncedï¼ˆé˜²æŠ–åŠ¨ï¼‰å‡½æ•°ã€‚ ä¾‹å­12345678910111213141516// é¿å…çª—å£åœ¨å˜åŠ¨æ—¶å‡ºçŽ°æ˜‚è´µçš„è®¡ç®—å¼€é”€ã€‚jQuery(window).on('resize', _.debounce(calculateLayout, 150)); // å½“ç‚¹å‡»æ—¶ `sendMail` éšåŽå°±è¢«è°ƒç”¨ã€‚jQuery(element).on('click', _.debounce(sendMail, 300, &#123; 'leading': true, 'trailing': false&#125;)); // ç¡®ä¿ `batchLog` è°ƒç”¨1æ¬¡ä¹‹åŽï¼Œ1ç§’å†…ä¼šè¢«è§¦å‘ã€‚var debounced = _.debounce(batchLog, 250, &#123; 'maxWait': 1000 &#125;);var source = new EventSource('/stream');jQuery(source).on('message', debounced); // å–æ¶ˆä¸€ä¸ª trailing çš„é˜²æŠ–åŠ¨è°ƒç”¨jQuery(window).on('popstate', debounced.cancel);]]></content>
      <categories>
        <category>å‰ç«¯</category>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>lodash</tag>
        <tag>é˜²æ­¢å¤šæ¬¡æäº¤</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pageableåˆ†é¡µ]]></title>
    <url>%2F2020%2F08%2F19%2FPageable%2F</url>
    <content type="text"><![CDATA[JpaRepositoryæä¾›äº†ä¸¤ä¸ªå’Œåˆ†é¡µå’ŒæŽ’åºæœ‰å…³çš„æŸ¥è¯¢ List findAll(Sort sort): æŒ‰ç…§æŒ‡å®šé¡ºåºæŽ’åºè¿”å›žæ‰€æœ‰å®žä½“ List findAll(Pageable pageable): åˆ†é¡µæŸ¥è¯¢ SortSort å¯¹è±¡ç”¨æ¥æŒ‡ç¤ºæŽ’åºï¼Œé»˜è®¤é‡‡ç”¨å‡åºæŽ’åº Sort sort = new Sort(&quot;id&quot;); // id æ˜¯ å±žæ€§å Sort sort = new Sort(Direction.DESC,&quot;id&quot;); PagePageæŽ¥å£å¯ä»¥èŽ·å¾— å½“å‰é¡µé¢çš„è®°å½• æ€»é¡µæ•° æ€»è®°å½•æ•° æ˜¯å¦æœ‰ä¸Šä¸€é¡µæˆ–ä¸‹ä¸€é¡µç­‰ 123int getTotalPages() æ€»çš„é¡µæ•°long getTotalElements() è¿”å›žæ€»æ•°List getContent() è¿”å›žæ­¤æ¬¡æŸ¥è¯¢çš„ç»“æžœé›† Spring Data åˆ†é¡µæŸ¥è¯¢æ€»æ˜¯è¿”å›žPageå¯¹è±¡ PageablePageable æŽ¥å£ç”¨äºŽæž„é€ ç¿»é¡µæŸ¥è¯¢ï¼ŒPageRequest æ˜¯å…¶å®žçŽ°ç±»ï¼Œå®ƒä¸ä»…ä»…æ”¯æŒåˆ†é¡µï¼Œè¿˜æ”¯æŒæŽ’åº(å•å­—æ®µ/å¤šå­—æ®µå‡æ”¯æŒ) public static PageRequest of(int page, int size); public static PageRequest of(int page, int size, Sort sort); page: èµ·å§‹é¡µï¼Œä»Ž0å¼€å§‹ size: é¡µå¤§å°ï¼Œä¸€é¡µçš„è¡Œæ•° @PageableDefaultControllerå±‚å¯ä»¥ç›´æŽ¥ä½¿ç”¨PageableæŽ¥æ”¶å‚æ•°ï¼Œå¦‚æžœè¦è®¾ç½®é»˜è®¤å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ @PageableDefaultæ³¨è§£ å‚æ•°ä¾‹å­ï¼š 1@PageableDefault(page = 0, value = 6, sort = &#123;"createdTime"&#125;, direction = Sort.Direction.DESC) Pageable pageable RESTfulæŽ¥å£çš„ä¾‹å­ï¼š 1http://localhost:8882/api/v1/questionBanks/byEnterprise?sort=id%2Cdesc&amp;page=0&amp;size=2 è§£é‡Šï¼š apiæŽ¥å£æŽ’åºå­—æ®µåŽé¢ä¼ çš„æ˜¯[,asc/desc] ä¾‹å¦‚è¦æŽ’åºçš„æ˜¯idå±žæ€§ï¼Œåˆ™ id,desc å¦‚æžœæ˜¯å‡åºçš„è¯ï¼Œå¯ä»¥ç›´æŽ¥å†™å±žæ€§åã€‚ Orderå’ŒSortçš„è½¬æ¢ç”¨EntityManageræŸ¥è¯¢çš„æ—¶å€™ï¼ŒæŽ’åºçš„ç±»åž‹æ˜¯javax.persistence.criteria.Order æ‰€ä»¥éœ€è¦å°†Sortå¯¹è±¡è½¬æˆOrderå¯¹è±¡: 1List&lt;javax.persistence.criteria.Order&gt; QueryUtils.toOrders(Sort, Root, CriteriaBuilder) æ³¨æ„Springçš„web Pageableåˆ†é¡µï¼Œé¡µå¤§å°è®°å½•é»˜è®¤åªæ”¯æŒ2000ï¼Œå¦‚æžœè¦è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼š 12345spring: data: web: pageable: max-page-size: 10000 # è®¾ç½®é¡µå¤§å°]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
        <tag>pageable</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Wake On Lan é…ç½®è¿œç¨‹å¯åŠ¨ç”µè„‘]]></title>
    <url>%2F2020%2F07%2F04%2FWOL%E9%85%8D%E7%BD%AE%2F</url>
    <content type="text"><![CDATA[å‰æè¿œç¨‹æŽ§åˆ¶ç”µè„‘å¼€æœºã€‚ æœ¬äººç¬”è®°æœ¬æ˜¯åˆèµ·æ¥æ”¾åœ¨ä¹¦æž¶åŽé¢çš„ï¼Œæ¯æ¬¡å¼€æœºéƒ½è¦æŠŠå®ƒæ‹¿å‡ºæ¥æ‰“å¼€ï¼Œéžå¸¸éº»çƒ¦ï¼Œæ‰€ä»¥æƒ³è¦é€šè¿‡å…¶ä»–æ–¹å¼å”¤é†’ç”µè„‘ã€‚ è§£å†³æ€è·¯ ä½¿ç”¨Wake On Lané€šè¿‡ç½‘å¡æŽ§åˆ¶ç”µè„‘å¼€æœºã€‚ ä»€ä¹ˆæ˜¯Wake On Lan Wake-On-LAN ç®€ç§° WOLï¼Œæ˜¯ä¸€ç§ç”µæºç®¡ç†åŠŸèƒ½ï¼›å®ƒæ˜¯ç”±IBMå…¬å¸æå‡ºçš„ç½‘ç»œå”¤é†’æ ‡å‡†ï¼Œç›®å‰è¯¥æ ‡å‡†å·²è¢«å¤§å¤šæ•°ä¸»æ¿åŽ‚å•†æ”¯æŒã€‚æ”¯æŒè¯¥æ ‡å‡†çš„ä¸»æ¿å…è®¸ä»Žè¿œç¨‹é€šè¿‡ç½‘ç»œå”¤é†’è®¡ç®—æœºï¼Œä¹Ÿå°±æ˜¯è¿œç¨‹å¼€æœºã€‚ å¦‚ä½•å®žçŽ°è¿œç¨‹å¼€æœºæ‰“å¼€ä½ çš„ç½‘ç»œè®¾ç½®æ–¹å¼1ï¼šæˆ‘çš„ç”µè„‘-&gt;å³é”®-&gt;ç®¡ç†-&gt;è®¾å¤‡ç®¡ç†å™¨-&gt;ç½‘ç»œé€‚é…å™¨-&gt;æ‰¾åˆ°è‡ªå·±çš„ç½‘å¡-&gt;å³é”®-&gt;å±žæ€§ æ–¹å¼2ï¼šæ‰“å¼€ç½‘ç»œå’ŒInternetè®¾ç½®-&gt;ç½‘ç»œå…±äº«ä¸­å¿ƒ-&gt;æ›´æ”¹é€‚é…å™¨è®¾ç½®-&gt;æ‰¾åˆ°è‡ªå·±çš„ç½‘å¡-&gt;å³é”®-&gt;å±žæ€§-&gt;é…ç½® é€‰æ‹©ç½‘å¡å”¤é†’ è®¾ç½®é˜²ç«å¢™ç­–ç•¥é˜²ç«å¢™å’Œç½‘ç»œä¿æŠ¤-&gt; é«˜çº§è®¾ç½® åœ¨è·¯ç”±å™¨è®¾ç½®é‡Œå°†PCçš„MACåœ°å€å’Œç½‘çº¿çš„IPç»‘å®š PCå®‰è£…æµ‹è¯•è½¯ä»¶https://www.depicus.com/wake-on-lan/wake-on-lan-monitor ä¸‹è½½å®ŒæˆåŽæ‰“å¼€ï¼Œè®¾ç½®UDPç«¯å£ä¸ºåˆšæ‰è®¾ç½®çš„ç«¯å£å·9ï¼Œç‚¹å‡»Start æ‰‹æœºå®‰è£…WOLçš„è½¯ä»¶è¿™é‡Œæˆ‘Iphoneå®‰è£…çš„æ˜¯Wolow ç‚¹å‡»åŽï¼Œå¦‚æžœåˆšæ‰æ‰“å¼€çš„monitorè½¯ä»¶ï¼Œå‡ºçŽ°ä»¥ä¸‹çš„å†…å®¹ï¼Œç†è®ºä¸Šå·²ç»ä»£è¡¨èƒ½å¤Ÿè”é€šï¼Œå…³æœºåŽå¦‚æžœè¿˜æ˜¯æ²¡æœ‰å”¤é†’å¯èƒ½éœ€è¦æ‰¾ä¸‹å…¶ä»–åŽŸå› ã€‚ Wake On LanåŽŸç†Wake-On-LANçš„å®žçŽ°ï¼Œä¸»è¦æ˜¯å‘ç›®æ ‡ä¸»æœºå‘é€ç‰¹æ®Šæ ¼å¼çš„æ•°æ®åŒ…ï¼Œä¿—ç§°é­”æœ¯åŒ…ï¼ˆMagic Packetï¼‰ã€‚ Magic Packet æ ¼å¼çš„æ•°æ®åŒ…æ˜¯ç”± AMD å…¬å¸å¼€å‘æŽ¨å¹¿çš„æŠ€æœ¯ï¼Œè™½ç„¶å…¶å¹¶éžä¸–ç•Œå…¬è®¤çš„æ ‡å‡†ï¼Œä½†æ˜¯ä»ç„¶å—åˆ°å¾ˆå¤šç½‘å¡åˆ¶é€ å•†çš„æ”¯æŒï¼Œå› æ­¤è®¸å¤šå…·æœ‰ç½‘ç»œå”¤é†’åŠŸèƒ½çš„ç½‘å¡éƒ½èƒ½ä¸Žä¹‹å…¼å®¹ã€‚ Magic Packeté­”æ³•æ•°æ®åŒ…ï¼ˆMagic Packetï¼‰æ˜¯ä¸€ä¸ªå¹¿æ’­æ€§çš„å¸§ï¼ˆframeï¼‰ï¼Œé€šè¿‡ç«¯å£7æˆ–ç«¯å£9è¿›è¡Œå‘é€ï¼Œä¸”å¯ä»¥ç”¨æ— è¿žæŽ¥ï¼ˆConnectionless protocolï¼‰çš„é€šä¿¡åè®®ï¼ˆå¦‚UDPï¼‰æ¥ä¼ é€’ã€‚ åœ¨é­”æ³•æ•°æ®åŒ…å†…ï¼Œæ¯æ¬¡éƒ½ä¼šå…ˆæœ‰è¿žç»­6ä¸ªâ€FFâ€ï¼ˆåå…­è¿›åˆ¶ï¼Œæ¢ç®—æˆäºŒè¿›åˆ¶å³ï¼š11111111ï¼‰çš„æ•°æ®ï¼Œå³ï¼šFF FF FF FF FF FFï¼Œåœ¨è¿žç»­6ä¸ªâ€FFâ€åŽåˆ™å¼€å§‹å¸¦å‡ºMACåœ°å€ä¿¡æ¯ï¼ˆMACåœ°å€é‡å¤16æ¬¡ï¼‰ï¼Œæœ‰æ—¶è¿˜ä¼šå¸¦å‡º4å­—èŠ‚æˆ–6å­—èŠ‚çš„å¯†ç ï¼Œä¸€æ—¦ç»ç”±ç½‘å¡ä¾¦æµ‹ã€è§£è¯»ã€ç ”åˆ¤ï¼ˆå¹¿æ’­ï¼‰é­”æ³•æ•°æ®åŒ…çš„å†…å®¹ï¼Œå†…å®¹ä¸­çš„MACåœ°å€ã€å¯†ç è‹¥ä¸Žç”µè„‘è‡ªèº«çš„åœ°å€ã€å¯†ç å»åˆï¼Œå°±ä¼šå¼•å¯¼å”¤é†’ã€å¼€æœºçš„ç¨‹åºã€‚ Magic Packet é­”æœ¯æ•°æ®åŒ…çš„æ ¼å¼ä¸€èˆ¬çœ‹ä¸ŠåŽ»åƒä¸‹é¢è¿™ä¸ªæ ·å­ å‡è®¾MACåœ°å€ä¸ºï¼š00-00-00-00-00 åºå· MagicPacket 1 FF FF FF FF FF FF 2 00 00 00 00 00 00 3 00 00 00 00 00 00 4 00 00 00 00 00 00 5 00 00 00 00 00 00 6 00 00 00 00 00 00 7 00 00 00 00 00 00 8 00 00 00 00 00 00 9 00 00 00 00 00 00 10 00 00 00 00 00 00 11 00 00 00 00 00 00 12 00 00 00 00 00 00 13 00 00 00 00 00 00 14 00 00 00 00 00 00 15 00 00 00 00 00 00 16 00 00 00 00 00 00 17 00 00 00 00 00 00 é­”æ³•æ•°æ®åŒ…ï¼ˆMagic Packetï¼‰ç»“æž„ä¸Šéžå¸¸ç®€å•ã€‚ å…¶ä»–C#è¯­è¨€åŽ»å®žçŽ°ä¸€ä¸ªWakeOnLanè½¯ä»¶]]></content>
      <categories>
        <category>WOL</category>
      </categories>
      <tags>
        <tag>WOL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Security (ä¸€) æž¶æž„æ¡†æž¶-Componentã€Serviceã€Filteråˆ†æž]]></title>
    <url>%2F2020%2F05%2F30%2FSpring%20Security%20(%E4%B8%80)%20%E6%9E%B6%E6%9E%84%E6%A1%86%E6%9E%B6-Component%E3%80%81Service%E3%80%81Filter%E5%88%86%E6%9E%90%2F</url>
    <content type="text"><![CDATA[ã€è½¬è½½ã€‘ ä½œè€…ï¼šCcww é“¾æŽ¥ï¼šhttps://juejin.im/post/5d074dc1f265da1bce3dd10f Spring security ï¼ˆä¸€ï¼‰æž¶æž„æ¡†æž¶-Componentã€Serviceã€Filteråˆ†æž æƒ³è¦æ·±å…¥spring securityçš„authentication ï¼ˆèº«ä»½éªŒè¯ï¼‰å’Œaccess-controlï¼ˆè®¿é—®æƒé™æŽ§åˆ¶ï¼‰å·¥ä½œæµç¨‹ï¼Œå¿…é¡»æ¸…æ¥šspring securityçš„ä¸»è¦æŠ€æœ¯ç‚¹åŒ…æ‹¬å…³é”®æŽ¥å£ã€ç±»ä»¥åŠæŠ½è±¡ç±»å¦‚ä½•ååŒå·¥ä½œè¿›è¡Œauthentication å’Œaccess-controlçš„å®žçŽ°ã€‚ Spring Security è®¤è¯å’ŒæŽˆæƒæµç¨‹å¸¸è§è®¤è¯å’ŒæŽˆæƒæµç¨‹å¯ä»¥åˆ†æˆï¼š A user is prompted to log in with a username and password ï¼ˆç”¨æˆ·ç”¨è´¦å¯†ç ç™»å½•ï¼‰ The system (successfully) verifies that the password is correct for the usernameï¼ˆæ ¡éªŒå¯†ç æ­£ç¡®æ€§ï¼‰ The context information for that user is obtained (their list of roles and so on).ï¼ˆèŽ·å–ç”¨æˆ·ä¿¡æ¯contextï¼Œå¦‚æƒé™ï¼‰ A security context is established for the userï¼ˆä¸ºç”¨æˆ·åˆ›å»ºsecurity contextï¼‰ The user proceeds, potentially to perform some operation which is potentially protected by an access control mechanism which checks the required permissions for the operation against the current security context information.ï¼ˆè®¿é—®æƒé™æŽ§åˆ¶ï¼Œæ˜¯å¦å…·æœ‰è®¿é—®æƒé™ï¼‰ Spring Security è®¤è¯ä¸Šè¿°å‰ä¸‰ç‚¹ä¸ºspring securityè®¤è¯éªŒè¯çŽ¯èŠ‚ï¼š é€šå¸¸é€šè¿‡AbstractAuthenticationProcessingFilterè¿‡æ»¤å™¨å°†è´¦å·å¯†ç ç»„è£…æˆAuthenticationå®žçŽ°ç±»UsernamePasswordAuthenticationTokenï¼› å°†tokenä¼ é€’ç»™AuthenticationManageréªŒè¯æ˜¯å¦æœ‰æ•ˆï¼Œè€ŒAuthenticationManageré€šå¸¸ä½¿ç”¨ProviderManagerå®žçŽ°ç±»æ¥æ£€éªŒï¼› AuthenticationManagerè®¤è¯æˆåŠŸåŽå°†è¿”å›žä¸€ä¸ªæ‹¥æœ‰è¯¦ç»†ä¿¡æ¯çš„Authentication objectï¼ˆåŒ…æ‹¬æƒé™ä¿¡æ¯ï¼Œèº«ä»½ä¿¡æ¯ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œä½†å¯†ç é€šå¸¸ä¼šè¢«ç§»é™¤ï¼‰ï¼› é€šè¿‡SecurityContextHolder.getContext().getAuthentication().getPrincipal()å°†Authenticationè®¾ç½®åˆ°security contextä¸­ã€‚ Spring Security è®¿é—®æŽˆæƒ é€šè¿‡FilterSecurityInterceptorè¿‡æ»¤å™¨å…¥å£è¿›å…¥ï¼› FilterSecurityInterceptoré€šè¿‡å…¶ç»§æ‰¿çš„æŠ½è±¡ç±»AbstractSecurityInterceptorçš„beforeInvocation(Object object)æ–¹æ³•è¿›è¡Œè®¿é—®æŽˆæƒï¼Œå…¶ä¸­æ¶‰åŠäº†ç±»AuthenticationManagerã€AccessDecisionManagerã€SecurityMetadataSourceç­‰ã€‚ æ ¹æ®ä¸Šè¿°æè¿°çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æŽ¥ä¸‹æ¥ä¸»è¦åŽ»åˆ†æžå…¶ä¸­æ¶‰åŠçš„ä¸€ä¸‹Componentã€Serviceã€Filterã€‚ æ ¸å¿ƒç»„ä»¶ï¼ˆCore Component ï¼‰SecurityContextHolder SecurityContextHolderæä¾›å¯¹SecurityContextçš„è®¿é—®ï¼Œå­˜å‚¨security contextï¼ˆç”¨æˆ·ä¿¡æ¯ã€è§’è‰²æƒé™ç­‰ï¼‰ï¼Œè€Œä¸”å…¶å…·æœ‰ä¸‹åˆ—å‚¨å­˜ç­–ç•¥å³å·¥ä½œæ¨¡å¼ï¼š SecurityContextHolder.MODE_THREADLOCALï¼ˆé»˜è®¤ï¼‰ï¼šä½¿ç”¨ThreadLocalï¼Œä¿¡æ¯å¯ä¾›æ­¤çº¿ç¨‹ä¸‹çš„æ‰€æœ‰çš„æ–¹æ³•ä½¿ç”¨ï¼Œä¸€ç§ä¸Žçº¿ç¨‹ç»‘å®šçš„ç­–ç•¥ï¼Œæ­¤å¤©ç„¶å¾ˆé€‚åˆServlet Webåº”ç”¨ã€‚ SecurityContextHolder.MODE_GLOBALï¼šä½¿ç”¨äºŽç‹¬ç«‹åº”ç”¨ SecurityContextHolder.MODE_INHERITABLETHREADLOCALï¼šå…·æœ‰ç›¸åŒå®‰å…¨æ ‡ç¤ºçš„çº¿ç¨‹ ä¿®æ”¹SecurityContextHolderçš„å·¥ä½œæ¨¡å¼æœ‰ä¸¤ç§æ–¹æ³• : è®¾ç½®ä¸€ä¸ªç³»ç»Ÿå±žæ€§(system.properties) : spring.security.strategy; è°ƒç”¨SecurityContextHolderé™æ€æ–¹æ³•setStrategyName() åœ¨é»˜è®¤ThreadLocalç­–ç•¥ä¸­ï¼ŒSecurityContextHolderä¸ºé™æ€æ–¹æ³•èŽ·å–ç”¨æˆ·ä¿¡æ¯ä¸º: 123456Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal(); if (principal instanceof UserDetails) &#123; String username = ((UserDetails)principal).getUsername(); &#125; else &#123; String username = principal.toString(); &#125; ä½†æ˜¯ä¸€èˆ¬ä¸éœ€è¦è‡ªèº«åŽ»èŽ·å–ã€‚ å…¶ä¸­getAuthentication()è¿”å›žä¸€ä¸ªAuthenticationè®¤è¯ä¸»ä½“ï¼ŒæŽ¥ä¸‹æ¥åˆ†æžAuthenticationã€UserDetailsç»†èŠ‚ã€‚ Authentication Spring Securityä½¿ç”¨ä¸€ä¸ªAuthenticationå¯¹è±¡æ¥æè¿°å½“å‰ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯,å…¶åŒ…å«ç”¨æˆ·æ‹¥æœ‰çš„æƒé™ä¿¡æ¯åˆ—è¡¨ã€ç”¨æˆ·ç»†èŠ‚ä¿¡æ¯ï¼ˆèº«ä»½ä¿¡æ¯ã€è®¤è¯ä¿¡æ¯ï¼‰ã€‚Authenticationä¸ºè®¤è¯ä¸»ä½“åœ¨spring securityä¸­æ—¶æœ€é«˜çº§åˆ«èº«ä»½/è®¤è¯çš„æŠ½è±¡ï¼Œå¸¸è§çš„å®žçŽ°ç±»UsernamePasswordAuthenticationTokenã€‚AuthenticationæŽ¥å£æºç ï¼š 123456789101112public interface Authentication extends Principal, Serializable &#123; //æƒé™ä¿¡æ¯åˆ—è¡¨,é»˜è®¤GrantedAuthorityæŽ¥å£çš„ä¸€äº›å®žçŽ°ç±» Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); //å¯†ç ä¿¡æ¯ Object getCredentials(); //ç»†èŠ‚ä¿¡æ¯ï¼Œwebåº”ç”¨ä¸­çš„å®žçŽ°æŽ¥å£é€šå¸¸ä¸º WebAuthenticationDetailsï¼Œå®ƒè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’ŒsessionIdçš„å€¼ Object getDetails(); //é€šå¸¸è¿”å›žå€¼ä¸ºUserDetailså®žçŽ°ç±» Object getPrincipal(); boolean isAuthenticated(); void setAuthenticated(boolean var1) throws IllegalArgumentException;&#125; å‰é¢ä¸¤ä¸ªç»„ä»¶éƒ½æ¶‰åŠäº†UserDetailsï¼Œä»¥åŠGrantedAuthorityå…¶åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ2.3å°èŠ‚åˆ†æžã€‚ UserDetails&amp;GrantedAuthority UserDetailsæä¾›ä»Žåº”ç”¨ç¨‹åºçš„DAOæˆ–å…¶ä»–å®‰å…¨æ•°æ®æºæž„å»ºAuthenticationå¯¹è±¡æ‰€éœ€çš„ä¿¡æ¯ï¼ŒåŒ…å«GrantedAuthorityã€‚å…¶å®˜æ–¹å®žçŽ°ç±»ä¸ºUserï¼Œå¼€å‘è€…å¯ä»¥å®žçŽ°å…¶æŽ¥å£è‡ªå®šä¹‰UserDetailså®žçŽ°ç±»ã€‚å…¶æŽ¥å£æºç ï¼š 12345678910111213141516 public interface UserDetails extends Serializable &#123; Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); String getPassword(); String getUsername(); boolean isAccountNonExpired(); boolean isAccountNonLocked(); boolean isCredentialsNonExpired(); boolean isEnabled();&#125; UserDetailsä¸ŽAuthenticationæŽ¥å£åŠŸèƒ½ç±»ä¼¼ï¼Œå…¶å«ä¹‰æ˜¯Authenticationä¸ºç”¨æˆ·æäº¤çš„è®¤è¯å‡­è¯ï¼ˆè´¦å·å¯†ç ï¼‰ï¼› â€‹ UserDetailsä¸ºç³»ç»Ÿä¸­ç”¨æˆ·æ­£ç¡®è®¤è¯å‡­è¯ï¼› â€‹ UserDetailsServiceä¸­çš„loadUserByUsernameæ–¹æ³•èŽ·å–æ­£ç¡®çš„è®¤è¯å‡­è¯ï¼› å…¶ä¸­åœ¨getAuthorities()æ–¹æ³•ä¸­èŽ·å–åˆ°GrantedAuthorityåˆ—è¡¨æ˜¯ä»£è¡¨ç”¨æˆ·è®¿é—®åº”ç”¨ç¨‹åºæƒé™èŒƒå›´ï¼Œæ­¤ç±»æƒé™é€šå¸¸æ˜¯â€œrole(è§’è‰²ï¼‰â€ï¼Œä¾‹å¦‚ROLE_ADMINISTRATORæˆ–ROLE_HR_SUPERVISORï¼› â€‹ GrantedAuthorityæŽ¥å£å¸¸è§çš„å®žçŽ°ç±»SimpleGrantedAuthorityã€‚ æ ¸å¿ƒæœåŠ¡ç±»ï¼ˆCore Servicesï¼‰AuthenticationManagerã€ProviderManagerä»¥åŠAuthenticationProvider AuthenticationManageræ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæŽ¥å£ï¼Œæ˜¯è®¤è¯ä¸€åˆ‡çš„èµ·ç‚¹ã€‚ â€‹ å¸¸è§çš„è®¤è¯æµç¨‹éƒ½æ˜¯AuthenticationManagerå®žçŽ°ç±»ProviderManagerå¤„ç†ï¼Œè€Œä¸”ProviderManagerå®žçŽ°ç±»åŸºäºŽå§”æ‰˜è€…æ¨¡å¼ç»´æŠ¤AuthenticationProvider åˆ—è¡¨ç”¨äºŽä¸åŒçš„è®¤è¯æ–¹å¼ã€‚ä¾‹å¦‚ï¼š ä½¿ç”¨è´¦å·å¯†ç è®¤è¯æ–¹å¼DaoAuthenticationProviderå®žçŽ°ç±»ï¼ˆç»§æ‰¿äº†AbstractUserDetailsAuthenticationProvideæŠ½è±¡ç±»ï¼‰ï¼Œå…¶ä¸ºé»˜è®¤è®¤è¯æ–¹å¼ï¼Œè¿›è¡Œæ•°æ®åº“åº“èŽ·å–è®¤è¯æ•°æ®ä¿¡æ¯ã€‚ æ¸¸å®¢èº«ä»½ç™»å½•è®¤è¯æ–¹å¼AnonymousAuthenticationProviderå®žçŽ°ç±» ä»ŽcookiesèŽ·å–è®¤è¯æ–¹å¼RememberMeAuthenticationProviderå®žçŽ°ç±» ProviderManageræºç åˆ†æžï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123; Class&lt;? extends Authentication&gt; toTest = authentication.getClass(); AuthenticationException lastException = null; Authentication result = null; //AuthenticationProvideråˆ—è¡¨ä¾æ¬¡è®¤è¯ for (AuthenticationProvider provider : getProviders()) &#123; if (!provider.supports(toTest)) &#123; continue; &#125; try &#123; //æ¯ä¸ªAuthenticationProviderè¿›è¡Œè®¤è¯ result = provider.authenticate(authentication) if (result != null) &#123; copyDetails(authentication, result); break; &#125; &#125; .... catch (AuthenticationException e) &#123; lastException = e; &#125; &#125; //è¿›è¡Œçˆ¶ç±»AuthenticationProviderè¿›è¡Œè®¤è¯ if (result == null &amp;&amp; parent != null) &#123; // Allow the parent to try. try &#123; result = parent.authenticate(authentication); &#125; catch (AuthenticationException e) &#123; lastException = e; &#125; &#125; // å¦‚æžœæœ‰Authenticationä¿¡æ¯ï¼Œåˆ™ç›´æŽ¥è¿”å›ž if (result != null) &#123; if (eraseCredentialsAfterAuthentication &amp;&amp; (result instanceof CredentialsContainer)) &#123; //æ¸…é™¤å¯†ç  ((CredentialsContainer) result).eraseCredentials(); &#125; //å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶ eventPublisher.publishAuthenticationSuccess(result); return result; &#125; //å¦‚æžœéƒ½æ²¡è®¤è¯æˆåŠŸï¼ŒæŠ›å‡ºå¼‚å¸¸ if (lastException == null) &#123; lastException = new ProviderNotFoundException(messages.getMessage( "ProviderManager.providerNotFound", new Object[] &#123; toTest.getName() &#125;, "No AuthenticationProvider found for &#123;0&#125;")); &#125; prepareException(lastException, authentication); throw lastException;&#125; ProviderManager ä¸­çš„List&lt;AuthenticationProvider&gt;ï¼Œä¼šä¾ç…§æ¬¡åºåŽ»è®¤è¯ï¼› â€‹ é»˜è®¤ç­–ç•¥ä¸‹ï¼Œåªéœ€è¦é€šè¿‡ä¸€ä¸ªAuthenticationProviderçš„è®¤è¯ï¼Œå³å¯è¢«è®¤ä¸ºæ˜¯ç™»å½•æˆåŠŸï¼Œè€Œä¸”è®¤è¯æˆåŠŸåŽè¿”å›žä¸€ä¸ªAuthenticationå®žä½“ï¼Œå¹¶ä¸ºäº†å®‰å…¨ä¼šè¿›è¡Œæ¸…é™¤å¯†ç ã€‚ â€‹ å¦‚æžœæ‰€æœ‰è®¤è¯å™¨éƒ½æ— æ³•è®¤è¯æˆåŠŸï¼Œåˆ™ProviderManager ä¼šæŠ›å‡ºä¸€ä¸ªProviderNotFoundExceptionå¼‚å¸¸ã€‚ UserDetailsService UserDetailsServiceæŽ¥å£ä½œç”¨æ˜¯ä»Žç‰¹å®šçš„åœ°æ–¹èŽ·å–è®¤è¯çš„æ•°æ®æºï¼ˆè´¦å·ã€å¯†ç ï¼‰ã€‚å¦‚ä½•èŽ·å–åˆ°ç³»ç»Ÿä¸­æ­£ç¡®çš„è®¤è¯å‡­è¯ï¼Œé€šè¿‡loadUserByUsername(String username)èŽ·å–è®¤è¯ä¿¡æ¯ï¼Œè€Œä¸”å…¶åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š 1UserDetails loadUserByUsername(String username) throws UsernameNotFoundException; â€‹ UserDetailsServiceå¸¸è§çš„å®žçŽ°ç±» ä»Žæ•°æ®åº“èŽ·å–çš„JdbcDaoImplå®žçŽ°ç±»ï¼Œ ä»Žå†…å­˜ä¸­èŽ·å–çš„InMemoryUserDetailsManagerå®žçŽ°ç±»ï¼Œ â€¦. è‡ªå®šä¹‰UserDetailsServiceå®žçŽ°ç±»ï¼Œå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829public class CustomUserService implements UserDetailsService &#123; @Autowired //ç”¨æˆ·mapper private UserInfoMapper userInfoMapper; @Autowired //ç”¨æˆ·æƒé™mapper private PermissionInfoMapper permissionInfoMapper; @Override public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123; UserInfoDTO userInfo = userInfoMapper.getUserInfoByUserName(username); if (userInfo != null) &#123; List&lt;PermissionInfoDTO&gt; permissionInfoDTOS = permissionInfoMapper.findByAdminUserId(userInfo.getId()); List&lt;GrantedAuthority&gt; grantedAuthorityList = new ArrayList&lt;&gt;(); //ç»„è£…æƒé™GrantedAuthority object for (PermissionInfoDTO permissionInfoDTO : permissionInfoDTOS) &#123; if (permissionInfoDTO != null &amp;&amp; permissionInfoDTO.getPermissionName() != null) &#123; GrantedAuthority grantedAuthority = new SimpleGrantedAuthority( permissionInfoDTO.getPermissionName()); grantedAuthorityList.add(grantedAuthority); &#125; &#125; //è¿”å›žç”¨æˆ·ä¿¡æ¯ return new User(userInfo.getUserName(), userInfo.getPasswaord(), grantedAuthorityList); &#125;else &#123; //æŠ›å‡ºç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸ throw new UsernameNotFoundException("admin" + username + "do not exist"); &#125; &#125;&#125; AccessDecisionManager&amp;SecurityMetadataSource AccessDecisionManageræ˜¯ç”±AbstractSecurityInterceptorè°ƒç”¨ï¼Œè´Ÿè´£åšå‡ºæœ€ç»ˆçš„è®¿é—®æŽ§åˆ¶å†³ç­–ã€‚ AccessDecisionManageræŽ¥å£æºç ï¼š 123456//è®¿é—®æŽ§åˆ¶å†³ç­– void decide(Authentication authentication, Object secureObject,Collection&lt;ConfigAttribute&gt; attrs) throws AccessDeniedException; //æ˜¯å¦æ”¯æŒå¤„ç†ä¼ é€’çš„ConfigAttribute boolean supports(ConfigAttribute attribute); //ç¡®è®¤classæ˜¯å¦ä¸ºAccessDecisionManager boolean supports(Class clazz); SecurityMetadataSourceåŒ…å«ç€AbstractSecurityInterceptorè®¿é—®æŽˆæƒæ‰€éœ€çš„å…ƒæ•°æ®ï¼ˆåŠ¨æ€urlã€åŠ¨æ€æŽˆæƒæ‰€éœ€çš„æ•°æ®ï¼‰ï¼›åœ¨AbstractSecurityInterceptoræŽˆæƒæ¨¡å—ä¸­ç»“åˆAccessDecisionManagerè¿›è¡Œè®¿é—®æŽˆæƒï¼Œå…¶æ¶‰åŠäº†ConfigAttributeã€‚ SecurityMetadataSourceæŽ¥å£ï¼š 123456Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException;Collection&lt;ConfigAttribute&gt; getAllConfigAttributes();boolean supports(Class&lt;?&gt; clazz); æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰SecurityMetadataSourceæ•°æ®æºï¼Œå®žçŽ°æŽ¥å£FilterInvocationSecurityMetadataSourceã€‚ä¾‹ï¼š 123456789101112131415161718192021public class MyFilterSecurityMetadataSource implements FilterInvocationSecurityMetadataSource &#123; public List&lt;ConfigAttribute&gt; getAttributes(Object object) &#123; FilterInvocation fi = (FilterInvocation) object; String url = fi.getRequestUrl(); String httpMethod = fi.getRequest().getMethod(); List&lt;ConfigAttribute&gt; attributes = new ArrayList&lt;ConfigAttribute&gt;(); // Lookup your database (or other source) using this information and populate the // list of attributes return attributes; &#125; public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123; return null; &#125; public boolean supports(Class&lt;?&gt; clazz) &#123; return FilterInvocation.class.isAssignableFrom(clazz); &#125;&#125; PasswordEncoder ä¸ºäº†å­˜å‚¨å®‰å…¨ï¼Œä¸€èˆ¬è¦å¯¹å¯†ç è¿›è¡Œç®—æ³•åŠ å¯†ã€‚ Spring Securityæä¾›äº†åŠ å¯†PasswordEncoderæŽ¥å£ã€‚å…¶å®žçŽ°ç±»æœ‰ï¼š BCrypt hashç®—æ³•å®žçŽ°çš„BCryptPasswordEncoderï¼› SCrypt hashing ç®—æ³•å®žçŽ°çš„SCryptPasswordEncoderï¼› PasswordEncoderæŽ¥å£åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š 123456public interface PasswordEncoder &#123; //å¯†ç åŠ å¯† String encode(CharSequence rawPassword); //å¯†ç é…å¯¹ boolean matches(CharSequence rawPassword, String encodedPassword);&#125; æ ¸å¿ƒ Security è¿‡æ»¤å™¨ï¼ˆCore Security Filtersï¼‰FilterSecurityInterceptor FilterSecurityInterceptoræ˜¯Spring SecurityæŽˆæƒæ¨¡å—å…¥å£ï¼Œè¯¥ç±»æ ¹æ®è®¿é—®çš„ç”¨æˆ·çš„è§’è‰²ï¼Œæƒé™æŽˆæƒè®¿é—®é‚£äº›èµ„æºï¼ˆè®¿é—®ç‰¹å®šè·¯å¾„åº”è¯¥å…·å¤‡çš„æƒé™ï¼‰ã€‚ FilterSecurityInterceptorå°è£…FilterInvocationå¯¹è±¡è¿›è¡Œæ“ä½œï¼› â€‹ æ‰€æœ‰çš„è¯·æ±‚åˆ°äº†FilterSecurityInterceptorï¼Œå¦‚æžœè¿™ä¸ªfilterä¹‹å‰æ²¡æœ‰æ‰§è¡Œè¿‡çš„è¯ï¼Œé‚£ä¹ˆé¦–å…ˆæ‰§è¡Œå…¶çˆ¶ç±»AbstractSecurityInterceptoræä¾›çš„InterceptorStatusToken token = super.beforeInvocation(fi)ï¼Œè¯¥æ–¹æ³•ä¼šï¼š ä½¿ç”¨AuthenticationManagerèŽ·å–Authenticationä¸­ç”¨æˆ·è¯¦æƒ…ï¼› ä½¿ç”¨ConfigAttributeå°è£…å·²å®šä¹‰å¥½è®¿é—®æƒé™è¯¦æƒ…ï¼› ä½¿ç”¨AccessDecisionManager.decide()æ–¹æ³•è¿›è¡Œè®¿é—®æƒé™æŽ§åˆ¶ã€‚ FilterSecurityInterceptoræºç åˆ†æžï¼š 123456789101112131415161718192021222324public void invoke(FilterInvocation fi) throws IOException, ServletException &#123; if ((fi.getRequest() != null) &amp;&amp; (fi.getRequest().getAttribute(FILTER_APPLIED) != null) &amp;&amp; observeOncePerRequest) &#123; fi.getChain().doFilter(fi.getRequest(), fi.getResponse()); &#125; else &#123; // first time this request being called, so perform security checking if (fi.getRequest() != null &amp;&amp; observeOncePerRequest) &#123; fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE); &#125; //å›žè°ƒå…¶ç»§æ‰¿çš„æŠ½è±¡ç±»AbstractSecurityInterceptorçš„æ–¹æ³• InterceptorStatusToken token = super.beforeInvocation(fi); try &#123; fi.getChain().doFilter(fi.getRequest(), fi.getResponse()); &#125; finally &#123; super.finallyInvocation(token); &#125; super.afterInvocation(token, null); &#125;&#125; AbstractSecurityInterceptoræºç åˆ†æžï¼š 12345678910111213141516protected InterceptorStatusToken beforeInvocation(Object object) &#123; .... //èŽ·å–æ‰€æœ‰è®¿é—®æƒé™ï¼ˆurl-roleï¼‰å±žæ€§åˆ—è¡¨ï¼ˆå·²å®šä¹‰åœ¨æ•°æ®åº“æˆ–è€…å…¶ä»–åœ°æ–¹ï¼‰ Collection&lt;ConfigAttribute&gt; attributes = this.obtainSecurityMetadataSource() .getAttributes(object); .... //èŽ·å–è¯¥ç”¨æˆ·è®¿é—®ä¿¡æ¯ï¼ˆåŒ…æ‹¬urlï¼Œè®¿é—®æƒé™ï¼‰ Authentication authenticated = authenticateIfRequired(); // Attempt authorization try &#123; //è¿›è¡ŒæŽˆæƒè®¿é—® this.accessDecisionManager.decide(authenticated, object, attributes); &#125;catch ....&#125; UsernamePasswordAuthenticationFilter UsernamePasswordAuthenticationFilterä½¿ç”¨usernameå’Œpasswordè¡¨å•ç™»å½•ä½¿ç”¨çš„è¿‡æ»¤å™¨ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„è¿‡æ»¤å™¨ã€‚å…¶æºç ï¼š 123456789101112131415public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123; //èŽ·å–è¡¨å•ä¸­çš„ç”¨æˆ·åå’Œå¯†ç  String username = obtainUsername(request); String password = obtainPassword(request); ... username = username.trim(); //ç»„è£…æˆusername+passwordå½¢å¼çš„token UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken( username, password); // Allow subclasses to set the "details" property setDetails(request, authRequest); //äº¤ç»™å†…éƒ¨çš„AuthenticationManageråŽ»è®¤è¯ï¼Œå¹¶è¿”å›žè®¤è¯ä¿¡æ¯ return this.getAuthenticationManager().authenticate(authRequest);&#125; å…¶ä¸»è¦ä»£ç ä¸ºåˆ›å»ºUsernamePasswordAuthenticationTokençš„Authenticationå®žä½“ä»¥åŠè°ƒç”¨AuthenticationManagerè¿›è¡Œauthenticateè®¤è¯ï¼Œæ ¹æ®è®¤è¯ç»“æžœæ‰§è¡ŒsuccessfulAuthenticationæˆ–è€…unsuccessfulAuthenticationï¼Œæ— è®ºæˆåŠŸå¤±è´¥ï¼Œä¸€èˆ¬çš„å®žçŽ°éƒ½æ˜¯è½¬å‘æˆ–è€…é‡å®šå‘ç­‰å¤„ç†ï¼Œä¸å†ç»†ç©¶AuthenticationSuccessHandlerå’ŒAuthenticationFailureHandleã€‚è‹¥æœ‰å…´è¶£ï¼Œå¯ä»¥ç ”ç©¶ä¸€ä¸‹å…¶çˆ¶ç±»AbstractAuthenticationProcessingFilterè¿‡æ»¤å™¨ã€‚ AnonymousAuthenticationFilterAnonymousAuthenticationFilteræ˜¯åŒ¿åç™»å½•è¿‡æ»¤å™¨ï¼Œå®ƒä½äºŽå¸¸ç”¨çš„èº«ä»½è®¤è¯è¿‡æ»¤å™¨ï¼ˆå¦‚UsernamePasswordAuthenticationFilterã€BasicAuthenticationFilterã€RememberMeAuthenticationFilterï¼‰ä¹‹åŽï¼Œæ„å‘³ç€åªæœ‰åœ¨ä¸Šè¿°èº«ä»½è¿‡æ»¤å™¨æ‰§è¡Œå®Œæ¯•åŽï¼ŒSecurityContextä¾æ—§æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼ŒAnonymousAuthenticationFilterè¯¥è¿‡æ»¤å™¨æ‰ä¼šæœ‰æ„ä¹‰â€”â€”ç»™å½“å‰è¯·æ±‚ä¸€ä¸ªåŒ¿åèº«ä»½ã€‚ AnonymousAuthenticationFilteræºç åˆ†æžï¼š 123456789101112131415161718192021222324252627public class AnonymousAuthenticationFilter extends GenericFilterBean implements InitializingBean &#123; ... public AnonymousAuthenticationFilter(String key) &#123; this(key, "anonymousUser", AuthorityUtils.createAuthorityList("ROLE_ANONYMOUS")); &#125; ... public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException &#123; if (SecurityContextHolder.getContext().getAuthentication() == null) &#123; //åˆ›å»ºåŒ¿åç™»å½•Authenticationçš„ä¿¡æ¯ SecurityContextHolder.getContext().setAuthentication( createAuthentication((HttpServletRequest) req)); ... &#125; chain.doFilter(req, res); &#125; //åˆ›å»ºåŒ¿åç™»å½•Authenticationçš„ä¿¡æ¯æ–¹æ³• protected Authentication createAuthentication(HttpServletRequest request) &#123; AnonymousAuthenticationToken auth = new AnonymousAuthenticationToken(key, principal, authorities); auth.setDetails(authenticationDetailsSource.buildDetails(request)); return auth; &#125;&#125; SecurityContextPersistenceFilter SecurityContextPersistenceFilterçš„ä¸¤ä¸ªä¸»è¦ä½œç”¨ï¼š å½“Requestè¿‡æ¥æ—¶ï¼Œåˆ›å»ºSecurityContextå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯ å½“Requestç»“æŸæ—¶ï¼Œæ¸…ç©ºSecurityContextHolderã€‚ å°èŠ‚æ€»ç»“ï¼š. AbstractAuthenticationProcessingFilter:ä¸»è¦å¤„ç†ç™»å½•. FilterSecurityInterceptor:ä¸»è¦å¤„ç†é‰´æƒ]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Security (äºŒ) WebSecurityConfigurerå’Œfilterçš„é…ç½®]]></title>
    <url>%2F2020%2F05%2F30%2FSpring%20Security%20(%E4%BA%8C)%20WebSecurityConfigurer%E5%92%8Cfilter%E7%9A%84%E9%85%8D%E7%BD%AE%2F</url>
    <content type="text"><![CDATA[ã€è½¬è½½ã€‘ ä½œè€…ï¼šCcww é“¾æŽ¥ï¼šhttps://juejin.im/post/5d0b1eb35188252f921b1535 Spring Securityï¼ˆäºŒï¼‰â€“WebSecurityConfigureré…ç½®ä»¥åŠfilteré¡ºåº åœ¨è®¤è¯è¿‡ç¨‹å’Œè®¿é—®æŽˆæƒå‰å¿…é¡»äº†è§£spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬è¦æ±‚æ‰€æœ‰ç”¨æˆ·éƒ½ç»è¿‡èº«ä»½éªŒè¯ï¼Ÿ Spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬æƒ³è¦æ”¯æŒåŸºäºŽè¡¨å•çš„èº«ä»½éªŒè¯ï¼Ÿå› æ­¤å¿…é¡»äº†è§£WebSecurityConfigurerAdapteré…ç½®ç±»å¦‚ä½•å·¥ä½œçš„ã€‚è€Œä¸”ä¹Ÿå¿…é¡»äº†è§£æ¸…æ¥šfilterçš„é¡ºåºï¼Œæ‰èƒ½æ›´å¥½äº†è§£å…¶è°ƒç”¨å·¥ä½œæµç¨‹ã€‚ WebSecurityConfigurerAdapter åœ¨ä½¿ç”¨ WebSecurityConfigurerAdapter å‰ï¼Œå…ˆäº†è§£ Spring security configã€‚ Spring security config å…·æœ‰ä¸‰ä¸ªæ¨¡å—ï¼Œä¸€å…±æœ‰3ä¸ª builderï¼Œè®¤è¯ç›¸å…³çš„ AuthenticationManagerBuilder å’Œwebç›¸å…³çš„ WebSecurityã€HttpSecurityã€‚ AuthenticationManagerBuilderï¼šç”¨æ¥é…ç½®å…¨å±€çš„è®¤è¯ç›¸å…³çš„ä¿¡æ¯ï¼Œå…¶å®žå°±æ˜¯AuthenticationProviderå’ŒUserDetailsServiceï¼Œå‰è€…æ˜¯è®¤è¯æœåŠ¡æä¾›å•†ï¼ŒåŽè€…æ˜¯ç”¨æˆ·è¯¦æƒ…æŸ¥è¯¢æœåŠ¡ï¼› WebSecurityï¼š å…¨å±€è¯·æ±‚å¿½ç•¥è§„åˆ™é…ç½®ï¼ˆæ¯”å¦‚è¯´é™æ€æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´æ³¨å†Œé¡µé¢ï¼‰ã€å…¨å±€HttpFirewallé…ç½®ã€æ˜¯å¦debugé…ç½®ã€å…¨å±€SecurityFilterChainé…ç½®ã€privilegeEvaluatorã€expressionHandlerã€securityInterceptorï¼› HttpSecurityï¼šå…·ä½“çš„æƒé™æŽ§åˆ¶è§„åˆ™é…ç½®ã€‚ä¸€ä¸ªè¿™ä¸ªé…ç½®ç›¸å½“äºŽxmlé…ç½®ä¸­çš„ä¸€ä¸ªæ ‡ç­¾ã€‚å„ç§å…·ä½“çš„è®¤è¯æœºåˆ¶çš„ç›¸å…³é…ç½®ï¼ŒOpenIDLoginConfigurerã€AnonymousConfigurerã€FormLoginConfigurerã€HttpBasicConfigurerç­‰ã€‚ WebSecurityConfigurerAdapteræä¾›äº†ç®€æ´æ–¹å¼æ¥åˆ›å»ºWebSecurityConfigurerï¼Œå…¶ä½œä¸ºåŸºç±»ï¼Œå¯é€šè¿‡å®žçŽ°è¯¥ç±»è‡ªå®šä¹‰é…ç½®ç±»ï¼Œä¸»è¦é‡å†™è¿™ä¸‰ä¸ªæ–¹æ³•ï¼š 123protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;&#125;public void configure(WebSecurity web) throws Exception &#123;&#125;protected void configure(HttpSecurity httpSecurity) throws Exception &#123;&#125; è€Œä¸”å…¶è‡ªåŠ¨ä»ŽSpringFactoriesLoaderæŸ¥æ‰¾AbstractHttpConfigurerè®©æˆ‘ä»¬åŽ»æ‰©å±•ï¼Œæƒ³è¦å®žçŽ°å¿…é¡»åˆ›å»ºä¸€ä¸ªAbstractHttpConfigurerçš„æ‰©å±•ç±»ï¼Œå¹¶åœ¨classpathè·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶META-INF/spring.factoriesã€‚ä¾‹å¦‚ï¼š 1org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer = sample.MyClassThatExtendsAbstractHttpConfigurer å…¶æºç åˆ†æžï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980//1.initåˆå§‹åŒ–ï¼šèŽ·å–HttpSecurityå’Œé…ç½®FilterSecurityInterceptoræ‹¦æˆªå™¨åˆ°WebSecuritypublic void init(final WebSecurity web) throws Exception &#123; //èŽ·å–HttpSecurity final HttpSecurity http = getHttp(); //é…ç½®FilterSecurityInterceptoræ‹¦æˆªå™¨åˆ°WebSecurity web.addSecurityFilterChainBuilder(http).postBuildAction(new Runnable() &#123; public void run() &#123; FilterSecurityInterceptor securityInterceptor = http .getSharedObject(FilterSecurityInterceptor.class); web.securityInterceptor(securityInterceptor); &#125; &#125;); &#125; .....//2.èŽ·å–HttpSecurityçš„è¿‡ç¨‹ protected final HttpSecurity getHttp() throws Exception &#123; if (http != null) &#123; return http; &#125; DefaultAuthenticationEventPublisher eventPublisher = objectPostProcessor .postProcess(new DefaultAuthenticationEventPublisher()); localConfigureAuthenticationBldr.authenticationEventPublisher(eventPublisher); AuthenticationManager authenticationManager = authenticationManager(); authenticationBuilder.parentAuthenticationManager(authenticationManager); Map&lt;Class&lt;? extends Object&gt;, Object&gt; sharedObjects = createSharedObjects(); http = new HttpSecurity(objectPostProcessor, authenticationBuilder, sharedObjects); if (!disableDefaults) &#123; // é»˜è®¤çš„HttpSecurityçš„é…ç½® http //æ·»åŠ  CSRF æ”¯æŒï¼Œä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œé»˜è®¤å¯ç”¨ï¼Œç¦ç”¨csrf().disable() .csrf().and() //æ·»åŠ WebAsyncManagerIntegrationFilter .addFilter(new WebAsyncManagerIntegrationFilter()) //å…è®¸é…ç½®å¼‚å¸¸å¤„ç† .exceptionHandling().and() //å°†å®‰å…¨æ ‡å¤´æ·»åŠ åˆ°å“åº” .headers().and() //å…è®¸é…ç½®ä¼šè¯ç®¡ç† .sessionManagement().and() //HttpServletRequestä¹‹é—´çš„SecurityContextHolderåˆ›å»ºsecurityContextç®¡ç† .securityContext().and() //å…è®¸é…ç½®è¯·æ±‚ç¼“å­˜ .requestCache().and() //å…è®¸é…ç½®åŒ¿åç”¨æˆ· .anonymous().and() //HttpServletRequestdçš„æ–¹æ³•å’Œå±žæ€§æ³¨å†Œåœ¨SecurityContextä¸­ .servletApi().and() //ä½¿ç”¨é»˜è®¤ç™»å½•é¡µé¢ .apply(new DefaultLoginPageConfigurer&lt;&gt;()).and() //æä¾›æ³¨é”€æ”¯æŒ .logout(); // @formatter:on ClassLoader classLoader = this.context.getClassLoader(); List&lt;AbstractHttpConfigurer&gt; defaultHttpConfigurers = SpringFactoriesLoader.loadFactories(AbstractHttpConfigurer.class, classLoader); for(AbstractHttpConfigurer configurer : defaultHttpConfigurers) &#123; http.apply(configurer); &#125; &#125; configure(http); return http; &#125; ..... //3.å¯é‡å†™æ–¹æ³•å®žçŽ°è‡ªå®šä¹‰çš„HttpSecurity protected void configure(HttpSecurity http) throws Exception &#123; logger.debug("Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity)."); http .authorizeRequests() .anyRequest().authenticated() .and() .formLogin().and() .httpBasic(); &#125; ..... ä»Žæºç initåˆå§‹åŒ–æ¨¡å—ä¸­çš„â€œèŽ·å–HttpSecurityâ€å’Œâ€œé…ç½®FilterSecurityInterceptoræ‹¦æˆªå™¨åˆ°WebSecurityâ€ä¸­å¯ä»¥çœ‹å‡ºï¼Œæƒ³è¦spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬è¦æ±‚æ‰€æœ‰ç”¨æˆ·éƒ½ç»è¿‡èº«ä»½éªŒè¯ï¼Ÿ Spring Securityå¦‚ä½•çŸ¥é“æˆ‘ä»¬æƒ³è¦æ”¯æŒåŸºäºŽè¡¨å•çš„èº«ä»½éªŒè¯ï¼Ÿåªè¦é‡å†™protected void configure(HttpSecurity http) throws Exceptionæ–¹æ³•å³å¯ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ç†è§£HttpSecurityçš„æ–¹æ³•çš„ä½œç”¨ï¼Œå¦‚ä½•è¿›è¡Œé…ç½®ã€‚ä¸‹ä¸€èŠ‚æ¥è®¨è®ºHttpSecurityã€‚ HttpSecurity HttpSecurityåŸºäºŽWebçš„å®‰å…¨æ€§å…è®¸ä¸ºç‰¹å®šçš„httpè¯·æ±‚è¿›è¡Œé…ç½®ã€‚å…¶æœ‰å¾ˆå¤šæ–¹æ³•ï¼Œåˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„å¦‚ä¸‹è¡¨ï¼š æ–¹æ³• è¯´æ˜Ž ä½¿ç”¨æ¡ˆä¾‹ csrf() æ·»åŠ  CSRF æ”¯æŒï¼Œä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œé»˜è®¤å¯ç”¨ ç¦ç”¨ï¼šcsrf().disable() openidLogin() ç”¨äºŽåŸºäºŽ OpenId çš„éªŒè¯ openidLogin().permitAll(); authorizeRequests() å¼€å¯ä½¿ç”¨HttpServletRequestè¯·æ±‚çš„è®¿é—®é™åˆ¶ authorizeRequests().anyRequest().authenticated() formLogin() å¼€å¯è¡¨å•çš„èº«ä»½éªŒè¯ï¼Œå¦‚æžœæœªæŒ‡å®šFormLoginConfigurer#loginPage(String)ï¼Œåˆ™å°†ç”Ÿæˆé»˜è®¤ç™»å½•é¡µé¢ formLogin().loginPage(â€œ/authentication/loginâ€).failureUrl(â€œ/authentication/login?failedâ€) oauth2Login() å¼€å¯OAuth 2.0æˆ–OpenID Connect 1.0èº«ä»½éªŒè¯ authorizeRequests()..anyRequest().authenticated()..and().oauth2Login() rememberMe() å¼€å¯é…ç½®â€œè®°ä½æˆ‘â€çš„éªŒè¯ authorizeRequests().antMatchers(â€œ/**â€).hasRole(â€œUSERâ€).and().formLogin().permitAll().and().rememberMe() addFilter() æ·»åŠ è‡ªå®šä¹‰çš„filter addFilter(new CustomFilter()) addFilterAt() åœ¨æŒ‡å®šfilterç›¸åŒä½ç½®ä¸Šæ·»åŠ è‡ªå®šä¹‰filter addFilterAt(new CustomFilter(), UsernamePasswordAuthenticationFilter.class) addFilterAfter() åœ¨æŒ‡å®šfilterä½ç½®åŽæ·»åŠ è‡ªå®šä¹‰filter addFilterAfter(new CustomFilter(), UsernamePasswordAuthenticationFilter.class) requestMatchers() å¼€å¯é…ç½®HttpSecurityï¼Œä»…å½“RequestMatcherç›¸åŒ¹é…æ—¶å¼€å¯ requestMatchers().antMatchers(â€œ/api/**â€) antMatchers() å…¶å¯ä»¥ä¸ŽauthorizeRequests()ã€RequestMatcheråŒ¹é…ï¼Œå¦‚ï¼šrequestMatchers().antMatchers(â€œ/api/**â€) logout() æ·»åŠ é€€å‡ºç™»å½•æ”¯æŒã€‚å½“ä½¿ç”¨WebSecurityConfigurerAdapteræ—¶ï¼Œè¿™å°†è‡ªåŠ¨åº”ç”¨ã€‚é»˜è®¤æƒ…å†µæ˜¯ï¼Œè®¿é—®URLâ€/ logoutâ€ï¼Œä½¿HTTP Sessionæ— æ•ˆæ¥æ¸…é™¤ç”¨æˆ·ï¼Œæ¸…é™¤å·²é…ç½®çš„ä»»ä½•#rememberMe()èº«ä»½éªŒè¯ï¼Œæ¸…é™¤SecurityContextHolderï¼Œç„¶åŽé‡å®šå‘åˆ°â€/login?successâ€ logout().deleteCookies(â€œremoveâ€).invalidateHttpSession(false).logoutUrl(â€œ/custom-logoutâ€).logoutSuccessUrl(â€œ/logout-successâ€); HttpSecurityè¿˜æœ‰å¾ˆå¤šæ–¹æ³•ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼ŒåŽ»é…ç½®HttpSecurityã€‚ç”±äºŽå¤ªå¤šè¿™è¾¹å°±ä¸ä¸€ä¸€è¯´æ˜Žï¼Œæœ‰å…´è¶£å¯åŽ»ç ”ç©¶ã€‚ WebSecurityConfigurerAdapter ä½¿ç”¨WebSecurityConfigurerAdapterç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728@Configuration@EnableWebSecuritypublic class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123; @Autowired private MyFilterSecurityInterceptor myFilterSecurityInterceptor; protected void configure(HttpSecurity http) throws Exception &#123; http //request è®¾ç½® .authorizeRequests() //http.authorizeRequests() æ–¹æ³•ä¸­çš„è‡ªå®šä¹‰åŒ¹é… .antMatchers("/resources/**", "/signup", "/about").permitAll() // æŒ‡å®šæ‰€æœ‰ç”¨æˆ·è¿›è¡Œè®¿é—®æŒ‡å®šçš„url .antMatchers("/admin/**").hasRole("ADMIN") //æŒ‡å®šå…·æœ‰ç‰¹å®šæƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ç‰¹å®šç›®å½•ï¼ŒhasRole()æ–¹æ³•æŒ‡å®šç”¨æˆ·æƒé™ï¼Œä¸”ä¸éœ€å‰ç¼€ â€œROLE_â€œ .antMatchers("/db/**").access("hasRole('ADMIN') and hasRole('DBA')")// .anyRequest().authenticated() //ä»»ä½•è¯·æ±‚æ²¡åŒ¹é…çš„éƒ½éœ€è¦è¿›è¡ŒéªŒè¯ .and() //loginè®¾ç½® è‡ªå®šä¹‰ç™»å½•é¡µé¢ä¸”å…è®¸æ‰€æœ‰ç”¨æˆ·ç™»å½• .formLogin() .loginPage("/login") //The updated configuration specifies the location of the log in page æŒ‡å®šè‡ªå®šä¹‰ç™»å½•é¡µé¢ .permitAll(); // å…è®¸æ‰€æœ‰ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢. The formLogin().permitAll() æ–¹æ³• .and .logout() //logouts è®¾ç½® .logoutUrl("/my/logout") // æŒ‡å®šæ³¨é”€è·¯å¾„ .logoutSuccessUrl("/my/index") //æŒ‡å®šæˆåŠŸæ³¨é”€åŽè·³è½¬åˆ°æŒ‡å®šçš„é¡µé¢ .logoutSuccessHandler(logoutSuccessHandler) //æŒ‡å®šæˆåŠŸæ³¨é”€åŽå¤„ç†ç±» å¦‚æžœä½¿ç”¨äº†logoutSuccessHandler()çš„è¯ï¼Œ logoutSuccessUrl()å°±ä¼šå¤±æ•ˆ .invalidateHttpSession(true) // httpSessionæ˜¯å¦æœ‰æ•ˆæ—¶é—´ï¼Œå¦‚æžœä½¿ç”¨äº† SecurityContextLogoutHandlerï¼Œå…¶å°†è¢«è¦†ç›– .addLogoutHandler(logoutHandler) //åœ¨æœ€åŽå¢žåŠ é»˜è®¤çš„æ³¨é”€å¤„ç†ç±»LogoutHandler .deleteCookies(cookieNamesToClear);//æŒ‡å®šæ³¨é”€æˆåŠŸåŽremove cookies //å¢žåŠ åœ¨FilterSecurityInterceptorå‰æ·»åŠ è‡ªå®šä¹‰çš„myFilterSecurityInterceptor http.addFilterBefore(myFilterSecurityInterceptor, FilterSecurityInterceptor.class); &#125; NOTEï¼šæ­¤ç¤ºä¾‹åªä¾›å‚è€ƒ filter é¡ºåºSpring Security filteré¡ºåºï¼š Filter Class è¯´æ˜Ž ChannelProcessingFilter è®¿é—®åè®®æŽ§åˆ¶è¿‡æ»¤å™¨ï¼Œå¯èƒ½ä¼šå°†æˆ‘ä»¬é‡æ–°å®šå‘åˆ°å¦å¤–ä¸€ç§åè®®,ä»Žhttpè½¬æ¢æˆhttps SecurityContextPersistenceFilter åˆ›å»ºSecurityContextå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œrequestç»“æŸæ—¶æ¸…ç©ºSecurityContextHolder ConcurrentSessionFilter å¹¶å‘è®¿é—®æŽ§åˆ¶è¿‡æ»¤å™¨,ä¸»è¦åŠŸèƒ½ï¼šSessionRegistryä¸­èŽ·å–SessionInformationæ¥åˆ¤æ–­sessionæ˜¯å¦è¿‡æœŸï¼Œä»Žè€Œå®žçŽ°å¹¶å‘è®¿é—®æŽ§åˆ¶ã€‚ HeaderWriterFilter ç»™http responseæ·»åŠ ä¸€äº›Header CsrfFilter è·¨åŸŸè¿‡æ»¤å™¨ï¼Œè·¨ç«™è¯·æ±‚ä¼ªé€ ä¿æŠ¤Filter LogoutFilter å¤„ç†é€€å‡ºç™»å½•çš„Filter X509AuthenticationFilter æ·»åŠ X509é¢„æŽˆæƒå¤„ç†æœºåˆ¶æ”¯æŒ CasAuthenticationFilter è®¤è¯filterï¼Œç»è¿‡è¿™äº›è¿‡æ»¤å™¨åŽSecurityContextHolderä¸­å°†åŒ…å«ä¸€ä¸ªå®Œå…¨ç»„è£…å¥½çš„Authenticationå¯¹è±¡ï¼Œä»Žè€Œä½¿åŽç»­é‰´æƒèƒ½æ­£å¸¸æ‰§è¡Œ UsernamePasswordAuthenticationFilter è®¤è¯çš„filterï¼Œç»è¿‡è¿™äº›è¿‡æ»¤å™¨åŽSecurityContextHolderä¸­å°†åŒ…å«ä¸€ä¸ªå®Œå…¨ç»„è£…å¥½çš„Authenticationå¯¹è±¡ï¼Œä»Žè€Œä½¿åŽç»­é‰´æƒèƒ½æ­£å¸¸æ‰§è¡Œã€‚è¡¨å•è®¤è¯æ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªè®¤è¯æ–¹å¼ã€‚ BasicAuthenticationFilter è®¤è¯filterï¼Œç»è¿‡è¿™äº›è¿‡æ»¤å™¨åŽSecurityContextHolderä¸­å°†åŒ…å«ä¸€ä¸ªå®Œå…¨ç»„è£…å¥½çš„Authenticationå¯¹è±¡ï¼Œä»Žè€Œä½¿åŽç»­é‰´æƒèƒ½æ­£å¸¸æ‰§è¡Œ SecurityContextHolderAwareRequestFilter æ­¤è¿‡æ»¤å™¨å¯¹ServletRequestè¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ï¼Œä½¿å¾—requestå…·æœ‰æ›´åŠ ä¸°å¯Œçš„API JaasApiIntegrationFilter (JAAS)è®¤è¯æ–¹å¼filter RememberMeAuthenticationFilter è®°å¿†è®¤è¯å¤„ç†è¿‡æ»¤å™¨ï¼Œå³æ˜¯å¦‚æžœå‰é¢è®¤è¯è¿‡æ»¤å™¨æ²¡æœ‰å¯¹å½“å‰çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¯ç”¨äº†RememberMeåŠŸèƒ½ï¼Œä¼šä»Žcookieä¸­è§£æžå‡ºç”¨æˆ·ï¼Œå¹¶è¿›è¡Œè®¤è¯å¤„ç†ï¼Œä¹‹åŽåœ¨SecurityContextHolderä¸­å­˜å…¥ä¸€ä¸ªAuthenticationå¯¹è±¡ã€‚ AnonymousAuthenticationFilter åŒ¿åè®¤è¯å¤„ç†è¿‡æ»¤å™¨ï¼Œå½“SecurityContextHolderä¸­è®¤è¯ä¿¡æ¯ä¸ºç©º,åˆ™ä¼šåˆ›å»ºä¸€ä¸ªåŒ¿åç”¨æˆ·å­˜å…¥åˆ°SecurityContextHolderä¸­ SessionManagementFilter ä¼šè¯ç®¡ç†Filterï¼ŒæŒä¹…åŒ–ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Œå¯ä»¥ä¿å­˜åˆ°sessionä¸­ï¼Œä¹Ÿå¯ä»¥ä¿å­˜åˆ°cookieæˆ–è€…redisä¸­ ExceptionTranslationFilter å¼‚å¸¸å¤„ç†è¿‡æ»¤å™¨ï¼Œä¸»è¦æ‹¦æˆªåŽç»­è¿‡æ»¤å™¨ï¼ˆFilterSecurityInterceptorï¼‰æ“ä½œä¸­æŠ›å‡ºçš„å¼‚å¸¸ã€‚ FilterSecurityInterceptor å®‰å…¨æ‹¦æˆªè¿‡æ»¤å™¨ç±»ï¼ŒèŽ·å–å½“å‰è¯·æ±‚urlå¯¹åº”çš„ConfigAttributeï¼Œå¹¶è°ƒç”¨accessDecisionManagerè¿›è¡Œè®¿é—®æŽˆæƒå†³ç­–ã€‚ spring securityçš„é»˜è®¤filteré“¾: SecurityContextPersistenceFilter-&gt;HeaderWriterFilter-&gt;LogoutFilter-&gt;UsernamePasswordAuthenticationFilter-&gt;RequestCacheAwareFilter-&gt;SecurityContextHolderAwareRequestFilter-&gt;SessionManagementFilter-&gt;ExceptionTranslationFilter-&gt;FilterSecurityInterceptor åœ¨ä¸ŠèŠ‚æˆ‘ä»¬å·²åˆ†æžäº†æ ¸å¿ƒçš„filteræºç ä»¥åŠåŠŸèƒ½ã€‚å¯å›žçœ‹ä¸ŠèŠ‚æºç åˆ†æžæ›´åŠ æ·±å…¥çš„äº†è§£å„ä¸ªfilterå·¥ä½œåŽŸç†ã€‚ æ€»ç»“ï¼š åœ¨è®¤è¯å’Œè®¿é—®æŽˆæƒè¿‡ç¨‹å‰ï¼Œé¦–å…ˆå¿…é¡»è¿›è¡ŒWebSecurityConfigurerç¬¦åˆè‡ªèº«åº”ç”¨çš„security Configurerï¼Œä¹Ÿè¦æ¸…æ¥šfilteré“¾çš„å…ˆåŽé¡ºåºï¼Œæ‰èƒ½æ›´å¥½ç†è§£spring securityçš„å·¥ä½œåŽŸç†ä»¥åŠåœ¨é¡¹ç›®ä¸­å‡ºçŽ°çš„é—®é¢˜å®šä½ã€‚]]></content>
      <categories>
        <category>Spring Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åŒæºç­–ç•¥]]></title>
    <url>%2F2020%2F05%2F29%2F%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%2F</url>
    <content type="text"><![CDATA[ã€è½¬è½½ã€‘ ä½œè€…ï¼šlaixiangran é“¾æŽ¥ï¼šhttps://juejin.im/post/5ba1d4fe6fb9a05ce873d4ad ä»€ä¹ˆæ˜¯æµè§ˆå™¨åŒæºç­–ç•¥åŒæºç­–ç•¥ï¼ˆSame origin policyï¼‰æ˜¯ä¸€ç§çº¦å®šï¼Œå®ƒæ˜¯æµè§ˆå™¨æœ€æ ¸å¿ƒä¹Ÿæœ€åŸºæœ¬çš„å®‰å…¨åŠŸèƒ½ï¼Œå¦‚æžœç¼ºå°‘äº†åŒæºç­–ç•¥ï¼Œåˆ™æµè§ˆå™¨çš„æ­£å¸¸åŠŸèƒ½å¯èƒ½éƒ½ä¼šå—åˆ°å½±å“ã€‚å¯ä»¥è¯´ Web æ˜¯æž„å»ºåœ¨åŒæºç­–ç•¥åŸºç¡€ä¹‹ä¸Šçš„ï¼Œæµè§ˆå™¨åªæ˜¯é’ˆå¯¹åŒæºç­–ç•¥çš„ä¸€ç§å®žçŽ°ã€‚ å®ƒçš„æ ¸å¿ƒå°±åœ¨äºŽå®ƒè®¤ä¸ºè‡ªä»»ä½•ç«™ç‚¹è£…è½½çš„ä¿¡èµ–å†…å®¹æ˜¯ä¸å®‰å…¨çš„ã€‚å½“è¢«æµè§ˆå™¨åŠä¿¡åŠç–‘çš„è„šæœ¬è¿è¡Œåœ¨æ²™ç®±æ—¶ï¼Œå®ƒä»¬åº”è¯¥åªè¢«å…è®¸è®¿é—®æ¥è‡ªåŒä¸€ç«™ç‚¹çš„èµ„æºï¼Œè€Œä¸æ˜¯é‚£äº›æ¥è‡ªå…¶å®ƒç«™ç‚¹å¯èƒ½æ€€æœ‰æ¶æ„çš„èµ„æºã€‚ æ‰€è°“åŒæºæ˜¯æŒ‡ï¼šåŸŸåã€åè®®ã€ç«¯å£ç›¸åŒã€‚ ä¸‹è¡¨æ˜¯ç›¸å¯¹äºŽ http://www.laixiangran.cn/home/index.html çš„åŒæºæ£€æµ‹ç»“æžœï¼š URL ç»“æžœ åŽŸå›  http://www.laixiangran.cn/home/index.html æˆåŠŸ åŸŸåã€åè®®ã€ç«¯å£å‡ä¸åŒ https://www.laixiangran.cn/home/index.html å¤±è´¥ åè®®ä¸åŒ http://www.laixiangran.cn:8080/home/index.html å¤±è´¥ ç«¯å£ä¸åŒ http://www.laixiangran.cn/other/index.html å¤±è´¥ åŸŸåä¸åŒ å¦å¤–ï¼ŒåŒæºç­–ç•¥åˆåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š DOM åŒæºç­–ç•¥ï¼šç¦æ­¢å¯¹ä¸åŒæºé¡µé¢ DOM è¿›è¡Œæ“ä½œã€‚è¿™é‡Œä¸»è¦åœºæ™¯æ˜¯ iframe è·¨åŸŸçš„æƒ…å†µï¼Œä¸åŒåŸŸåçš„ iframe æ˜¯é™åˆ¶äº’ç›¸è®¿é—®çš„ã€‚ XMLHttpRequest åŒæºç­–ç•¥ï¼šç¦æ­¢ä½¿ç”¨ XHR å¯¹è±¡å‘ä¸åŒæºçš„æœåŠ¡å™¨åœ°å€å‘èµ· HTTP è¯·æ±‚ã€‚ ä¸ºä»€ä¹ˆè¦æœ‰è·¨åŸŸé™åˆ¶å› ä¸ºå­˜åœ¨æµè§ˆå™¨åŒæºç­–ç•¥ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰è·¨åŸŸé—®é¢˜ã€‚é‚£ä¹ˆæµè§ˆå™¨æ˜¯å‡ºäºŽä½•ç§åŽŸå› ä¼šæœ‰è·¨åŸŸçš„é™åˆ¶å‘¢ã€‚å…¶å®žä¸éš¾æƒ³åˆ°ï¼Œè·¨åŸŸé™åˆ¶ä¸»è¦çš„ç›®çš„å°±æ˜¯ä¸ºäº†ç”¨æˆ·çš„ä¸Šç½‘å®‰å…¨ã€‚ å¦‚æžœæµè§ˆå™¨æ²¡æœ‰åŒæºç­–ç•¥ï¼Œä¼šå­˜åœ¨ä»€ä¹ˆæ ·çš„å®‰å…¨é—®é¢˜å‘¢ã€‚ä¸‹é¢ä»Ž DOM åŒæºç­–ç•¥å’Œ XMLHttpRequest åŒæºç­–ç•¥æ¥ä¸¾ä¾‹è¯´æ˜Žï¼š å¦‚æžœæ²¡æœ‰ DOM åŒæºç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒåŸŸçš„ iframe ä¹‹é—´å¯ä»¥ç›¸äº’è®¿é—®ï¼Œé‚£ä¹ˆé»‘å®¢å¯ä»¥è¿™æ ·è¿›è¡Œæ”»å‡»ï¼š åšä¸€ä¸ªå‡ç½‘ç«™ï¼Œé‡Œé¢ç”¨ iframe åµŒå¥—ä¸€ä¸ªé“¶è¡Œç½‘ç«™ http://mybank.comã€‚ æŠŠ iframe å®½é«˜å•¥çš„è°ƒæ•´åˆ°é¡µé¢å…¨éƒ¨ï¼Œè¿™æ ·ç”¨æˆ·è¿›æ¥é™¤äº†åŸŸåï¼Œåˆ«çš„éƒ¨åˆ†å’Œé“¶è¡Œçš„ç½‘ç«™æ²¡æœ‰ä»»ä½•å·®åˆ«ã€‚ è¿™æ—¶å¦‚æžœç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œæˆ‘ä»¬çš„ä¸»ç½‘ç«™å¯ä»¥è·¨åŸŸè®¿é—®åˆ° http://mybank.com çš„ dom èŠ‚ç‚¹ï¼Œå°±å¯ä»¥æ‹¿åˆ°ç”¨æˆ·çš„è´¦æˆ·å¯†ç äº†ã€‚ å¦‚æžœæ²¡æœ‰ XMLHttpRequest åŒæºç­–ç•¥ï¼Œé‚£ä¹ˆé»‘å®¢å¯ä»¥è¿›è¡Œ CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ æ”»å‡»ï¼š ç”¨æˆ·ç™»å½•äº†è‡ªå·±çš„é“¶è¡Œé¡µé¢ http://mybank.comï¼Œhttp://mybank.com å‘ç”¨æˆ·çš„ cookie ä¸­æ·»åŠ ç”¨æˆ·æ ‡è¯†ã€‚ ç”¨æˆ·æµè§ˆäº†æ¶æ„é¡µé¢ http://evil.comï¼Œæ‰§è¡Œäº†é¡µé¢ä¸­çš„æ¶æ„ AJAX è¯·æ±‚ä»£ç ã€‚ http://evil.com å‘ http://mybank.com å‘èµ· AJAX HTTP è¯·æ±‚ï¼Œè¯·æ±‚ä¼šé»˜è®¤æŠŠ http://mybank.com å¯¹åº” cookie ä¹ŸåŒæ—¶å‘é€è¿‡åŽ»ã€‚ é“¶è¡Œé¡µé¢ä»Žå‘é€çš„ cookie ä¸­æå–ç”¨æˆ·æ ‡è¯†ï¼ŒéªŒè¯ç”¨æˆ·æ— è¯¯ï¼Œresponse ä¸­è¿”å›žè¯·æ±‚æ•°æ®ã€‚æ­¤æ—¶æ•°æ®å°±æ³„éœ²äº†ã€‚ è€Œä¸”ç”±äºŽ Ajax åœ¨åŽå°æ‰§è¡Œï¼Œç”¨æˆ·æ— æ³•æ„ŸçŸ¥è¿™ä¸€è¿‡ç¨‹ã€‚ å› æ­¤ï¼Œæœ‰äº†æµè§ˆå™¨åŒæºç­–ç•¥ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´å®‰å…¨çš„ä¸Šç½‘ã€‚ è·¨åŸŸçš„è§£å†³æ–¹æ³•ä»Žä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°äº†æµè§ˆå™¨åŒæºç­–ç•¥çš„ä½œç”¨ï¼Œä¹Ÿæ­£æ˜¯æœ‰äº†è·¨åŸŸé™åˆ¶ï¼Œæ‰ä½¿æˆ‘ä»¬èƒ½å®‰å…¨çš„ä¸Šç½‘ã€‚ä½†æ˜¯åœ¨å®žé™…ä¸­ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦çªç ´è¿™æ ·çš„é™åˆ¶ï¼Œå› æ­¤ä¸‹é¢å°†ä»‹ç»å‡ ç§è·¨åŸŸçš„è§£å†³æ–¹æ³•ã€‚ CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰CORSï¼ˆCross-origin resource sharingï¼Œè·¨åŸŸèµ„æºå…±äº«ï¼‰æ˜¯ä¸€ä¸ª W3C æ ‡å‡†ï¼Œå®šä¹‰äº†åœ¨å¿…é¡»è®¿é—®è·¨åŸŸèµ„æºæ—¶ï¼Œæµè§ˆå™¨ä¸ŽæœåŠ¡å™¨åº”è¯¥å¦‚ä½•æ²Ÿé€šã€‚CORS èƒŒåŽçš„åŸºæœ¬æ€æƒ³ï¼Œå°±æ˜¯ä½¿ç”¨è‡ªå®šä¹‰çš„ HTTP å¤´éƒ¨è®©æµè§ˆå™¨ä¸ŽæœåŠ¡å™¨è¿›è¡Œæ²Ÿé€šï¼Œä»Žè€Œå†³å®šè¯·æ±‚æˆ–å“åº”æ˜¯åº”è¯¥æˆåŠŸï¼Œè¿˜æ˜¯åº”è¯¥å¤±è´¥ã€‚ CORS éœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼ŒIE æµè§ˆå™¨ä¸èƒ½ä½ŽäºŽ IE10ã€‚ æ•´ä¸ª CORS é€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸Žã€‚å¯¹äºŽå¼€å‘è€…æ¥è¯´ï¼ŒCORS é€šä¿¡ä¸ŽåŒæºçš„ AJAX é€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘çŽ° AJAX è¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚ å› æ­¤ï¼Œå®žçŽ° CORS é€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®žçŽ°äº† CORS æŽ¥å£ï¼Œå°±å¯ä»¥è·¨æºé€šä¿¡ã€‚ æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéžç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚ åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±žäºŽç®€å•è¯·æ±‚ã€‚ è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š HEAD GET POST HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š Accept Accept-Language Content-Language Last-Event-ID Content-Typeï¼šåªé™äºŽä¸‰ä¸ªå€¼ application/x-www-form-urlencodedã€multipart/form-dataã€text/plain å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±žäºŽéžç®€å•è¯·æ±‚ã€‚ æµè§ˆå™¨å¯¹è¿™ä¸¤ç§è¯·æ±‚çš„å¤„ç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚ ç®€å•è¯·æ±‚ åœ¨è¯·æ±‚ä¸­éœ€è¦é™„åŠ ä¸€ä¸ªé¢å¤–çš„ Origin å¤´éƒ¨ï¼Œå…¶ä¸­åŒ…å«è¯·æ±‚é¡µé¢çš„æºä¿¡æ¯ï¼ˆåè®®ã€åŸŸåå’Œç«¯å£ï¼‰ï¼Œä»¥ä¾¿æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå¤´éƒ¨ä¿¡æ¯æ¥å†³å®šæ˜¯å¦ç»™äºˆå“åº”ã€‚ä¾‹å¦‚ï¼šOrigin: http://www.laixiangran.cn å¦‚æžœæœåŠ¡å™¨è®¤ä¸ºè¿™ä¸ªè¯·æ±‚å¯ä»¥æŽ¥å—ï¼Œå°±åœ¨ Access-Control-Allow-Origin å¤´éƒ¨ä¸­å›žå‘ç›¸åŒçš„æºä¿¡æ¯ï¼ˆå¦‚æžœæ˜¯å…¬å…±èµ„æºï¼Œå¯ä»¥å›žå‘ * ï¼‰ã€‚ä¾‹å¦‚ï¼šAccess-Control-Allow-Originï¼šhttp://www.laixiangran.cn æ²¡æœ‰è¿™ä¸ªå¤´éƒ¨æˆ–è€…æœ‰è¿™ä¸ªå¤´éƒ¨ä½†æºä¿¡æ¯ä¸åŒ¹é…ï¼Œæµè§ˆå™¨å°±ä¼šé©³å›žè¯·æ±‚ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä¼šå¤„ç†è¯·æ±‚ã€‚æ³¨æ„ï¼Œè¯·æ±‚å’Œå“åº”éƒ½ä¸åŒ…å« cookie ä¿¡æ¯ã€‚ å¦‚æžœéœ€è¦åŒ…å« cookie ä¿¡æ¯ï¼Œajax è¯·æ±‚éœ€è¦è®¾ç½® xhr çš„å±žæ€§ withCredentials ä¸º trueï¼ŒæœåŠ¡å™¨éœ€è¦è®¾ç½®å“åº”å¤´éƒ¨ Access-Control-Allow-Credentials: trueã€‚ éžç®€å•è¯·æ±‚æµè§ˆå™¨åœ¨å‘é€çœŸæ­£çš„è¯·æ±‚ä¹‹å‰ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ª Preflight è¯·æ±‚ç»™æœåŠ¡å™¨ï¼Œè¿™ç§è¯·æ±‚ä½¿ç”¨ OPTIONS æ–¹æ³•ï¼Œå‘é€ä¸‹åˆ—å¤´éƒ¨ï¼š Originï¼šä¸Žç®€å•çš„è¯·æ±‚ç›¸åŒã€‚ Access-Control-Request-Method: è¯·æ±‚è‡ªèº«ä½¿ç”¨çš„æ–¹æ³•ã€‚ Access-Control-Request-Headers: ï¼ˆå¯é€‰ï¼‰è‡ªå®šä¹‰çš„å¤´éƒ¨ä¿¡æ¯ï¼Œå¤šä¸ªå¤´éƒ¨ä»¥é€—å·åˆ†éš”ã€‚ ä¾‹å¦‚ï¼š 123Origin: http://www.laixiangran.cnAccess-Control-Request-Method: POSTAccess-Control-Request-Headers: NCZ å‘é€è¿™ä¸ªè¯·æ±‚åŽï¼ŒæœåŠ¡å™¨å¯ä»¥å†³å®šæ˜¯å¦å…è®¸è¿™ç§ç±»åž‹çš„è¯·æ±‚ã€‚æœåŠ¡å™¨é€šè¿‡åœ¨å“åº”ä¸­å‘é€å¦‚ä¸‹å¤´éƒ¨ä¸Žæµè§ˆå™¨è¿›è¡Œæ²Ÿé€šï¼š Access-Control-Allow-Originï¼šä¸Žç®€å•çš„è¯·æ±‚ç›¸åŒã€‚ Access-Control-Allow-Methods: å…è®¸çš„æ–¹æ³•ï¼Œå¤šä¸ªæ–¹æ³•ä»¥é€—å·åˆ†éš”ã€‚ Access-Control-Allow-Headers: å…è®¸çš„å¤´éƒ¨ï¼Œå¤šä¸ªæ–¹æ³•ä»¥é€—å·åˆ†éš”ã€‚ Access-Control-Max-Age: åº”è¯¥å°†è¿™ä¸ª Preflight è¯·æ±‚ç¼“å­˜å¤šé•¿æ—¶é—´ï¼ˆä»¥ç§’è¡¨ç¤ºï¼‰ã€‚ ä¾‹å¦‚ï¼š 1234Access-Control-Allow-Origin: http://www.laixiangran.cnAccess-Control-Allow-Methods: GET, POSTAccess-Control-Allow-Headers: NCZAccess-Control-Max-Age: 1728000 ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡ Preflight è¯·æ±‚å…è®¸è¯¥è¯·æ±‚ä¹‹åŽï¼Œä»¥åŽæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„ CORS è¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·äº†ã€‚ ä¼˜ç‚¹ CORS é€šä¿¡ä¸ŽåŒæºçš„ AJAX é€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ï¼Œå®¹æ˜“ç»´æŠ¤ã€‚ æ”¯æŒæ‰€æœ‰ç±»åž‹çš„ HTTP è¯·æ±‚ã€‚ ç¼ºç‚¹ å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ IE10 ä»¥ä¸‹çš„æµè§ˆå™¨ã€‚ ç¬¬ä¸€æ¬¡å‘é€éžç®€å•è¯·æ±‚æ—¶ä¼šå¤šä¸€æ¬¡è¯·æ±‚ã€‚ JSONP è·¨åŸŸç”±äºŽ script æ ‡ç­¾ä¸å—æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œå…è®¸è·¨åŸŸå¼•ç”¨èµ„æºã€‚å› æ­¤å¯ä»¥é€šè¿‡åŠ¨æ€åˆ›å»º script æ ‡ç­¾ï¼Œç„¶åŽåˆ©ç”¨ src å±žæ€§è¿›è¡Œè·¨åŸŸï¼Œè¿™ä¹Ÿå°±æ˜¯ JSONP è·¨åŸŸçš„åŸºæœ¬åŽŸç†ã€‚ ç›´æŽ¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜Ž JSONP å®žçŽ°è·¨åŸŸçš„æµç¨‹ï¼š 1234567891011121314// 1. å®šä¹‰ä¸€ä¸ª å›žè°ƒå‡½æ•° handleResponse ç”¨æ¥æŽ¥æ”¶è¿”å›žçš„æ•°æ®function handleResponse(data) &#123; console.log(data);&#125;;// 2. åŠ¨æ€åˆ›å»ºä¸€ä¸ª script æ ‡ç­¾ï¼Œå¹¶ä¸”å‘Šè¯‰åŽç«¯å›žè°ƒå‡½æ•°åå« handleResponsevar body = document.getElementsByTagName('body')[0];var script = document.gerElement('script');script.src = 'http://www.laixiangran.cn/json?callback=handleResponse';body.appendChild(script);// 3. é€šè¿‡ script.src è¯·æ±‚ `http://www.laixiangran.cn/json?callback=handleResponse`ï¼Œ// 4. åŽç«¯èƒ½å¤Ÿè¯†åˆ«è¿™æ ·çš„ URL æ ¼å¼å¹¶å¤„ç†è¯¥è¯·æ±‚ï¼Œç„¶åŽè¿”å›ž handleResponse(&#123;"name": "laixiangran"&#125;) ç»™æµè§ˆå™¨// 5. æµè§ˆå™¨åœ¨æŽ¥æ”¶åˆ° handleResponse(&#123;"name": "laixiangran"&#125;) ä¹‹åŽç«‹å³æ‰§è¡Œ ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ handleResponse æ–¹æ³•ï¼ŒèŽ·å¾—åŽç«¯è¿”å›žçš„æ•°æ®ï¼Œè¿™æ ·å°±å®Œæˆä¸€æ¬¡è·¨åŸŸè¯·æ±‚äº†ã€‚ ä¼˜ç‚¹ ä½¿ç”¨ç®€ä¾¿ï¼Œæ²¡æœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œç›®å‰æœ€æµè¡Œçš„ä¸€ç§è·¨åŸŸæ–¹æ³•ã€‚ ç¼ºç‚¹ åªæ”¯æŒ GET è¯·æ±‚ã€‚ ç”±äºŽæ˜¯ä»Žå…¶å®ƒåŸŸä¸­åŠ è½½ä»£ç æ‰§è¡Œï¼Œå› æ­¤å¦‚æžœå…¶ä»–åŸŸä¸å®‰å…¨ï¼Œå¾ˆå¯èƒ½ä¼šåœ¨å“åº”ä¸­å¤¹å¸¦ä¸€äº›æ¶æ„ä»£ç ã€‚ è¦ç¡®å®š JSONP è¯·æ±‚æ˜¯å¦å¤±è´¥å¹¶ä¸å®¹æ˜“ã€‚è™½ç„¶ HTML5 ç»™ script æ ‡ç­¾æ–°å¢žäº†ä¸€ä¸ª onerror äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä½†æ˜¯å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚ å›¾åƒ Ping è·¨åŸŸç”±äºŽ img æ ‡ç­¾ä¸å—æµè§ˆå™¨åŒæºç­–ç•¥çš„å½±å“ï¼Œå…è®¸è·¨åŸŸå¼•ç”¨èµ„æºã€‚å› æ­¤å¯ä»¥é€šè¿‡ img æ ‡ç­¾çš„ src å±žæ€§è¿›è¡Œè·¨åŸŸï¼Œè¿™ä¹Ÿå°±æ˜¯å›¾åƒ Ping è·¨åŸŸçš„åŸºæœ¬åŽŸç†ã€‚ ç›´æŽ¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥è¯´æ˜Žå›¾åƒ Ping å®žçŽ°è·¨åŸŸçš„æµç¨‹ï¼š 123456789var img = new Image();// é€šè¿‡ onload åŠ onerror äº‹ä»¶å¯ä»¥çŸ¥é“å“åº”æ˜¯ä»€ä¹ˆæ—¶å€™æŽ¥æ”¶åˆ°çš„ï¼Œä½†æ˜¯ä¸èƒ½èŽ·å–å“åº”æ–‡æœ¬img.onload = img.onerror = function() &#123; console.log("Done!");&#125;// è¯·æ±‚æ•°æ®é€šè¿‡æŸ¥è¯¢å­—ç¬¦ä¸²å½¢å¼å‘é€img.src = 'http://www.laixiangran.cn/test?name=laixiangran'; ä¼˜ç‚¹ ç”¨äºŽå®žçŽ°è·Ÿè¸ªç”¨æˆ·ç‚¹å‡»é¡µé¢æˆ–åŠ¨æ€å¹¿å‘Šæ›å…‰æ¬¡æ•°æœ‰è¾ƒå¤§çš„ä¼˜åŠ¿ã€‚ ç¼ºç‚¹ åªæ”¯æŒ GET è¯·æ±‚ã€‚ åªèƒ½æµè§ˆå™¨ä¸ŽæœåŠ¡å™¨çš„å•å‘é€šä¿¡ï¼Œå› ä¸ºæµè§ˆå™¨ä¸èƒ½è®¿é—®æœåŠ¡å™¨çš„å“åº”æ–‡æœ¬ã€‚ æœåŠ¡å™¨ä»£ç†æµè§ˆå™¨æœ‰è·¨åŸŸé™åˆ¶ï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸å­˜åœ¨è·¨åŸŸé—®é¢˜ï¼Œæ‰€ä»¥å¯ä»¥ç”±æœåŠ¡å™¨è¯·æ±‚æ‰€æœ‰åŸŸçš„èµ„æºå†è¿”å›žç»™å®¢æˆ·ç«¯ã€‚ æœåŠ¡å™¨ä»£ç†æ˜¯ä¸‡èƒ½çš„ã€‚ document.domain è·¨åŸŸå¯¹äºŽä¸»åŸŸåç›¸åŒï¼Œè€Œå­åŸŸåä¸åŒçš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨ document.domain æ¥è·¨åŸŸã€‚è¿™ç§æ–¹å¼éžå¸¸é€‚ç”¨äºŽ iframe è·¨åŸŸçš„æƒ…å†µã€‚ æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ªé¡µé¢ï¼Œå®ƒçš„åœ°å€æ˜¯ http://www.laixiangran.cn/a.htmlï¼Œåœ¨è¿™ä¸ªé¡µé¢é‡Œé¢æœ‰ä¸€ä¸ª iframeï¼Œå®ƒçš„ src æ˜¯ http://laixiangran.cn/b.htmlã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªé¡µé¢ä¸Žå®ƒé‡Œé¢çš„ iframe æ¡†æž¶æ˜¯ä¸åŒåŸŸçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯æ— æ³•é€šè¿‡åœ¨é¡µé¢ä¸­ä¹¦å†™ js ä»£ç æ¥èŽ·å– iframe ä¸­çš„ä¸œè¥¿çš„ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œdocument.domain å°±å¯ä»¥æ´¾ä¸Šç”¨åœºäº†ï¼Œæˆ‘ä»¬åªè¦æŠŠ http://www.laixiangran.cn/a.html å’Œ http://laixiangran.cn/b.html è¿™ä¸¤ä¸ªé¡µé¢çš„ document.domain éƒ½è®¾æˆç›¸åŒçš„åŸŸåå°±å¯ä»¥äº†ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œdocument.domain çš„è®¾ç½®æ˜¯æœ‰é™åˆ¶çš„ï¼Œæˆ‘ä»¬åªèƒ½æŠŠ document.domain è®¾ç½®æˆè‡ªèº«æˆ–æ›´é«˜ä¸€çº§çš„çˆ¶åŸŸï¼Œä¸”ä¸»åŸŸå¿…é¡»ç›¸åŒã€‚ä¾‹å¦‚ï¼ša.b.laixiangran.cn ä¸­æŸä¸ªæ–‡æ¡£çš„ document.domain å¯ä»¥è®¾æˆ a.b.laixiangran.cnã€b.laixiangran.cn ã€laixiangran.cn ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä½†æ˜¯ä¸å¯ä»¥è®¾æˆ c.a.b.laixiangran.cn ï¼Œå› ä¸ºè¿™æ˜¯å½“å‰åŸŸçš„å­åŸŸï¼Œä¹Ÿä¸å¯ä»¥è®¾æˆ baidu.comï¼Œå› ä¸ºä¸»åŸŸå·²ç»ä¸ç›¸åŒäº†ã€‚ ä¾‹å¦‚ï¼Œåœ¨é¡µé¢ http://www.laixiangran.cn/a.html ä¸­è®¾ç½®document.domainï¼š 1234567&lt;iframe src="http://laixiangran.cn/b.html" id="myIframe" onload="test()"&gt;&lt;script&gt; document.domain = 'laixiangran.cn'; // è®¾ç½®æˆä¸»åŸŸ function test() &#123; console.log(document.getElementById('myIframe').contentWindow); &#125;&lt;/script&gt; åœ¨é¡µé¢ http://laixiangran.cn/b.html ä¸­ä¹Ÿè®¾ç½® document.domainï¼Œè€Œä¸”è¿™ä¹Ÿæ˜¯å¿…é¡»çš„ï¼Œè™½ç„¶è¿™ä¸ªæ–‡æ¡£çš„ domain å°±æ˜¯ laixiangran.cnï¼Œä½†æ˜¯è¿˜æ˜¯å¿…é¡»æ˜¾å¼åœ°è®¾ç½® document.domain çš„å€¼ï¼š 123&lt;script&gt; document.domain = 'laixiangran.cn'; // document.domain è®¾ç½®æˆä¸Žä¸»é¡µé¢ç›¸åŒ&lt;/script&gt; è¿™æ ·ï¼Œhttp://www.laixiangran.cn/a.html å°±å¯ä»¥é€šè¿‡ js è®¿é—®åˆ° http://laixiangran.cn/b.html ä¸­çš„å„ç§å±žæ€§å’Œå¯¹è±¡äº†ã€‚ window.name è·¨åŸŸwindow å¯¹è±¡æœ‰ä¸ª name å±žæ€§ï¼Œè¯¥å±žæ€§æœ‰ä¸ªç‰¹å¾ï¼šå³åœ¨ä¸€ä¸ªçª—å£ï¼ˆwindowï¼‰çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œçª—å£è½½å…¥çš„æ‰€æœ‰çš„é¡µé¢ï¼ˆä¸ç®¡æ˜¯ç›¸åŒåŸŸçš„é¡µé¢è¿˜æ˜¯ä¸åŒåŸŸçš„é¡µé¢ï¼‰éƒ½æ˜¯å…±äº«ä¸€ä¸ª window.name çš„ï¼Œæ¯ä¸ªé¡µé¢å¯¹ window.name éƒ½æœ‰è¯»å†™çš„æƒé™ï¼Œwindow.name æ˜¯æŒä¹…å­˜åœ¨ä¸€ä¸ªçª—å£è½½å…¥è¿‡çš„æ‰€æœ‰é¡µé¢ä¸­çš„ï¼Œå¹¶ä¸ä¼šå› æ–°é¡µé¢çš„è½½å…¥è€Œè¿›è¡Œé‡ç½®ã€‚ é€šè¿‡ä¸‹é¢çš„ä¾‹å­ä»‹ç»å¦‚ä½•é€šè¿‡ window.name æ¥è·¨åŸŸèŽ·å–æ•°æ®çš„ã€‚ é¡µé¢ http://www.laixiangran.cn/a.html çš„ä»£ç ï¼š 123456789101112131415161718&lt;iframe src="http://laixiangran.cn/b.html" id="myIframe" onload="test()" style="display: none;"&gt;&lt;script&gt; // 2. iframeè½½å…¥ "http://laixiangran.cn/b.html é¡µé¢åŽä¼šæ‰§è¡Œè¯¥å‡½æ•° function test() &#123; var iframe = document.getElementById('myIframe'); // é‡ç½® iframe çš„ onload äº‹ä»¶ç¨‹åºï¼Œ // æ­¤æ—¶ç»è¿‡åŽé¢ä»£ç é‡ç½® src ä¹‹åŽï¼Œ // http://www.laixiangran.cn/a.html é¡µé¢ä¸Žè¯¥ iframe åœ¨åŒä¸€ä¸ªæºäº†ï¼Œå¯ä»¥ç›¸äº’è®¿é—®äº† iframe.onload = function() &#123; var data = iframe.contentWindow.name; // 4. èŽ·å– iframe é‡Œçš„ window.name console.log(data); // hello world! &#125;; // 3. é‡ç½®ä¸€ä¸ªä¸Ž http://www.laixiangran.cn/a.html é¡µé¢åŒæºçš„é¡µé¢ iframe.src = 'http://www.laixiangran.cn/c.html'; &#125;&lt;/script&gt; é¡µé¢ http://laixiangran.cn/b.html çš„ä»£ç ï¼š 1234&lt;script type="text/javascript"&gt; // 1. ç»™å½“å‰çš„ window.name è®¾ç½®ä¸€ä¸ª http://www.laixiangran.cn/a.html é¡µé¢æƒ³è¦å¾—åˆ°çš„æ•°æ®å€¼ window.name = "hello world!";&lt;/script&gt; location.hash è·¨åŸŸlocation.hash æ–¹å¼è·¨åŸŸï¼Œæ˜¯å­æ¡†æž¶ä¿®æ”¹çˆ¶æ¡†æž¶ src çš„ hash å€¼ï¼Œé€šè¿‡è¿™ä¸ªå±žæ€§è¿›è¡Œä¼ é€’æ•°æ®ï¼Œä¸”æ›´æ”¹ hash å€¼ï¼Œé¡µé¢ä¸ä¼šåˆ·æ–°ã€‚ä½†æ˜¯ä¼ é€’çš„æ•°æ®çš„å­—èŠ‚æ•°æ˜¯æœ‰é™çš„ã€‚ é¡µé¢ http://www.laixiangran.cn/a.html çš„ä»£ç ï¼š 123456789&lt;iframe src="http://laixiangran.cn/b.html" id="myIframe" onload="test()" style="display: none;"&gt;&lt;script&gt; // 2. iframeè½½å…¥ "http://laixiangran.cn/b.html é¡µé¢åŽä¼šæ‰§è¡Œè¯¥å‡½æ•° function test() &#123; // 3. èŽ·å–é€šè¿‡ http://laixiangran.cn/b.html é¡µé¢è®¾ç½® hash å€¼ var data = window.location.hash; console.log(data); &#125;&lt;/script&gt; é¡µé¢ http://laixiangran.cn/b.html çš„ä»£ç ï¼š 1234&lt;script type="text/javascript"&gt; // 1. è®¾ç½®çˆ¶é¡µé¢çš„ hash å€¼ parent.location.hash = "world";&lt;/script&gt; postMessage è·¨åŸŸwindow.postMessage(messageï¼ŒtargetOrigin) æ–¹æ³•æ˜¯ HTML5 æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥å‘å…¶å®ƒçš„ window å¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œæ— è®ºè¿™ä¸ª window å¯¹è±¡æ˜¯å±žäºŽåŒæºæˆ–ä¸åŒæºã€‚è¿™ä¸ªåº”è¯¥å°±æ˜¯ä»¥åŽè§£å†³ dom è·¨åŸŸé€šç”¨æ–¹æ³•äº†ã€‚ è°ƒç”¨ postMessage æ–¹æ³•çš„ window å¯¹è±¡æ˜¯æŒ‡è¦æŽ¥æ”¶æ¶ˆæ¯çš„é‚£ä¸€ä¸ª window å¯¹è±¡ï¼Œè¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•° message ä¸ºè¦å‘é€çš„æ¶ˆæ¯ï¼Œç±»åž‹åªèƒ½ä¸ºå­—ç¬¦ä¸²ï¼›ç¬¬äºŒä¸ªå‚æ•° targetOrigin ç”¨æ¥é™å®šæŽ¥æ”¶æ¶ˆæ¯çš„é‚£ä¸ª window å¯¹è±¡æ‰€åœ¨çš„åŸŸï¼Œå¦‚æžœä¸æƒ³é™å®šåŸŸï¼Œå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ *ã€‚ éœ€è¦æŽ¥æ”¶æ¶ˆæ¯çš„ window å¯¹è±¡ï¼Œå¯æ˜¯é€šè¿‡ç›‘å¬è‡ªèº«çš„ message äº‹ä»¶æ¥èŽ·å–ä¼ è¿‡æ¥çš„æ¶ˆæ¯ï¼Œæ¶ˆæ¯å†…å®¹å‚¨å­˜åœ¨è¯¥äº‹ä»¶å¯¹è±¡çš„ data å±žæ€§ä¸­ã€‚ é¡µé¢ http://www.laixiangran.cn/a.html çš„ä»£ç ï¼š 1234567891011&lt;iframe src="http://laixiangran.cn/b.html" id="myIframe" onload="test()" style="display: none;"&gt;&lt;script&gt; // 1. iframeè½½å…¥ "http://laixiangran.cn/b.html é¡µé¢åŽä¼šæ‰§è¡Œè¯¥å‡½æ•° function test() &#123; // 2. èŽ·å– http://laixiangran.cn/b.html é¡µé¢çš„ window å¯¹è±¡ï¼Œ // ç„¶åŽé€šè¿‡ postMessage å‘ http://laixiangran.cn/b.html é¡µé¢å‘é€æ¶ˆæ¯ var iframe = document.getElementById('myIframe'); var win = iframe.contentWindow; win.postMessage('æˆ‘æ˜¯æ¥è‡ª http://www.laixiangran.cn/a.html é¡µé¢çš„æ¶ˆæ¯', '*'); &#125;&lt;/script&gt; é¡µé¢ http://laixiangran.cn/b.html çš„ä»£ç ï¼š 1234567&lt;script type="text/javascript"&gt; // æ³¨å†Œ message äº‹ä»¶ç”¨æ¥æŽ¥æ”¶æ¶ˆæ¯ window.onmessage = function(e) &#123; e = e || event; // èŽ·å–äº‹ä»¶å¯¹è±¡ console.log(e.data); // é€šè¿‡ data å±žæ€§å¾—åˆ°å‘é€æ¥çš„æ¶ˆæ¯ &#125;&lt;/script&gt;]]></content>
      <categories>
        <category>åŒæºç­–ç•¥</category>
      </categories>
      <tags>
        <tag>åŒæºç­–ç•¥</tag>
        <tag>æµè§ˆå™¨</tag>
        <tag>CORF</tag>
        <tag>è·¨åŸŸ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[spring data jpa å¦‚ä½•å®žçŽ°åŠ¨æ€éƒ¨åˆ†æ›´æ–°]]></title>
    <url>%2F2019%2F12%2F08%2FSpringDataJpa%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E9%83%A8%E5%88%86%E6%9B%B4%E6%96%B0%2F</url>
    <content type="text"><![CDATA[åˆ›å»ºè¡¨ contact 12345678CREATE TABLE `contact` ( `id` int(32) NOT NULL AUTO_INCREMENT, `name` varchar(32) NOT NULL, `mobile` varchar(20) NOT NULL, `address` varchar(255), `create_time` datetime, PRIMARY KEY (`id`)); åˆ›å»ºå®žä½“ Contact 12345678910111213141516@Data@Entity(name = "contact")public class Contact &#123; @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Integer id; private String name; private String mobile; private String address; @Column(name = "create_time") private Date createTime;&#125; å‡è®¾å‰ç«¯ä¿®æ”¹äº†æŸä¸ªç”¨æˆ·çš„è”ç³»ç”µè¯ï¼Œéœ€è¦æ›´æ–°æ•°æ®åº“ä¸­æŸä¸ªç”¨æˆ·çš„è”ç³»ç”µè¯ï¼š å‰ç«¯çš„ json ï¼š 1234567&gt; &#123;&gt; "id": 1,&gt; "name": "å¼ ä¸‰",&gt; "mobile": "13522222222",&gt; "address": "å¹¿ä¸œçœ"&gt; &#125;&gt; åŽå°æ‰§è¡Œçš„ä»£ç ï¼š 1234&gt; if(contact.getId() != null)&#123;&gt; contactRepository.save(contact);&gt; &#125;&gt; å¦‚æžœç›´æŽ¥æ‰§è¡Œè¿™æ®µä»£ç ï¼Œä¼šæŠŠä¹‹å‰çš„create_timeä¿¡æ¯ç½®ä¸ºnull åŽŸå› ï¼šSpring Data Jpa å¯¹Entityçš„æ›´æ–°æ˜¯å¯¹ä¸»é”®ä»¥å¤–çš„æ‰€æœ‰å­—æ®µæ›´æ–°ï¼Œè€Œä¸æ˜¯ä¼ çš„å‚æ•°æ›´æ–°ï¼Œæ‰§è¡Œçš„sqlæ˜¯ï¼š 1update contact set name=?, mobile=?, address=?, create_time=? where id=? Spring Data Jpa saveæ–¹æ³•çš„æºç ï¼š 1234567891011@Transactional @Override public &lt;S extends T&gt; S save(S entity) &#123; if (entityInformation.isNew(entity)) &#123; em.persist(entity); return entity; &#125; else &#123; return em.merge(entity); &#125; &#125; Spring Data Jpa ä¼šä¾æ®ä¸»é”®å…ˆæ‰§è¡Œä¸€è¾¹æŸ¥è¯¢ï¼Œå¦‚æžœä¸å­˜åœ¨è¿™æ¡è®°å½•åˆ™æ‰§è¡Œæ’å…¥ï¼Œå¦‚æžœå­˜åœ¨åˆ™æ‰§è¡Œè¦†ç›–æ“ä½œã€‚ ä½†æ˜¯è¿™é‡Œå°±æœ‰é—®é¢˜äº†ï¼ŒSpring Data Jpa æ— æ³•ç†è§£å¼€å‘è€…çš„æ„å›¾ï¼Œ å³å¼€å‘è€…åˆ°åº•æ˜¯æƒ³ç”¨NULLå€¼è¦†ç›–åŽŸå€¼ï¼Œè¿˜æ˜¯æƒ³é‡åˆ°NULLå€¼è€Œå¿½ç•¥ã€‚ å¯¹äºŽéƒ¨åˆ†å­—æ®µæ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨@Queryå’Œ@Modifyæ³¨è§£æ‰‹å†™sqlæ¥è¿›è¡Œéƒ¨åˆ†æ›´æ–°ï¼Œ ä½†æ˜¯åŠ¨æ€æ›´æ–°æ— æ³•åšåˆ°ã€‚ ä»€ä¹ˆæ˜¯åŠ¨æ€æ›´æ–°? ä¸æ˜¯å¯¹æ•°æ®è®°å½•çš„æ‰€æœ‰å­—æ®µæ•´ä½“æ›´æ–°ï¼Œè€Œæ˜¯ç›´åˆ°è¿è¡Œæ—¶æ‰ç¡®å®šå“ªä¸ªæˆ–è€…å“ªäº›å­—æ®µä¼šè¢«æ›´æ–° å¦‚ï¼š åªæ›´æ”¹äº†mobileï¼Œæ‰§è¡Œçš„æ˜¯ï¼šupdate contact set mobile=? where id=? æ›´æ”¹äº†mobileå’Œaddressï¼Œæ‰§è¡Œçš„æ˜¯ï¼šupdate contact set mobile=?, address=? where id=? ä½¿ç”¨@DynamicUpdate åœ¨å®žä½“ç±»ä¸Šä½¿ç”¨æ³¨è§£@DynamicUpdateæ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£æ˜¯ç”±hibernateæä¾›çš„ è¿™æ—¶å°±å¯ä»¥å®žçŽ°åŠ¨æ€æ›´æ–°äº†ï¼Œåœ¨è¿è¡Œæ—¶ä¿®æ”¹å“ªäº›å­—æ®µï¼Œä¼šåŠ¨æ€ç”Ÿæˆå¯¹åº”çš„sqlï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨æ— æ³•ç†è§£å¼€å‘è€…å¯¹äºŽNULLå€¼çš„æ„å›¾ã€‚é»˜è®¤æ˜¯å¦‚æžœåŽŸå€¼ä¸ä¸º NULL , åˆ™ç”¨NULLå€¼è¦†ç›–ï¼Œå¦‚æžœæƒ³è¦å®žçŽ°ä¸è¦†ç›–åŽŸå€¼ï¼Œéœ€è¦è‡ªè¡Œå®žçŽ°æŽ¥å£æˆ–è€…å·¥å…·ç±»ã€‚]]></content>
      <categories>
        <category>Spring Data</category>
        <category>Spring Data Jpa</category>
      </categories>
      <tags>
        <tag>Spring Data Jpa</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[dockerå®‰è£…å¸¸ç”¨è½¯ä»¶]]></title>
    <url>%2F2019%2F12%2F07%2Fdocker%E5%AE%89%E8%A3%85%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[docker å®‰è£…å¸¸ç”¨è½¯ä»¶ å¦‚æžœé…ç½®å¼€æœºå¯åŠ¨ï¼šåŽé¢åŠ  --restart=always nginx ä¸‹è½½: docker pull nginx è¿è¡Œ: docker run --name nginx -p 80:80 -d docker.io/nginx é…ç½® nginx.conf è¿›å…¥ nginx å®¹å™¨: docker exec -it nginx /bin/bash è¿›å…¥ /etc/nginx ç›®å½•: cd /etc/nginx viæˆ–è€…vimç¼–è¾‘: vim nginx.conf PSï¼šå› ä¸ºnginxé‡Œé¢æ²¡æœ‰è‡ªå¸¦vimæˆ–è€…viï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œå®‰è£… åœ¨/etc/nginxç›®å½•ä¸‹ï¼š apt-get update æ›´æ–° apt-get install vim ä¸‹è½½ vim rediså•æœºç‰ˆ ä¸‹è½½: docker pull redis:latest è¿è¡Œ: docker run -itd --name redis -p 6379:6379 redis + --requirepass &quot;******&quot; (è¿è¡Œæ—¶å°±è®¾ç½®å¯†ç ) è¿›å…¥rediså®¹å™¨é‡Œé¢(å¯é€‰): docker exec -it redis /bin/bash è¿žæŽ¥redis(å¯é€‰): redis-cli æŸ¥çœ‹æ˜¯å¦æœ‰è®¾ç½®å¯†ç (å¯é€‰): config get requirepass è®¾ç½®å¯†ç (å¯é€‰): config set requirepass **** mysql ä¸‹è½½: docker pull mysql:latest è¿è¡Œ: docker run -itd --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql zookeeperå•æœºç‰ˆ ä¸‹è½½: docker pull zookeeper:latest è¿è¡Œ: docker run -d --name zookeeper -p 2181:2181 zookeeper è¿›å…¥zookeeperå®¹å™¨é‡Œé¢(å¯é€‰): docker exec -it zookeeper /bin/bash kafukaå•æœºç‰ˆ ä¸‹è½½: docker pull wurstmeister/kafka è¿è¡Œ: å…ˆè¿è¡Œzookeeper docker run -d --name zookeeper -p 2181:2181 zookeeper å†å¯åŠ¨kafuka 1docker run -d --name kafka -p 9092:9092 -e KAFKA_BROKER_ID=0 -e KAFKA_ZOOKEEPER_CONNECT=192.168.1.100:2181 -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.1.100:9092 -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 -t wurstmeister/kafka è§£é‡Šï¼š ä¸Šé¢çš„å‘½ä»¤ï¼Œä¸»è¦è®¾ç½®å››ä¸ªå‚æ•° KAFKA_BROKER_ID=0KAFKA_ZOOKEEPER_CONNECT=192.168.1.100:2181KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.1.100:9092KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092ä¸­é—´ä¸¤ä¸ªå‚æ•°çš„192.168.1.100æ”¹ä¸ºå®¿ä¸»æœºå™¨çš„IPåœ°å€ï¼Œå¦‚æžœä¸è¿™ä¹ˆè®¾ç½®ï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ¨åˆ«çš„æœºå™¨ä¸Šè®¿é—®ä¸åˆ°kafkaã€‚ æµ‹è¯•kafuka: è¿›å…¥å®¹å™¨: docker exec -it kafka /bin/bash è¿›å…¥kafkaæ‰€åœ¨ç›®å½•: cd opt/kafka_2.11-2.5.0/ å¯åŠ¨æ¶ˆæ¯å‘é€æ–¹: ./bin/kafka-console-producer.sh --broker-list localhost:9092 --topic mykafka å…‹éš†ä¼šè¯ è¿›å…¥kafkaæ‰€åœ¨ç›®å½•: cd opt/kafka_2.11-2.5.0/ å¯åŠ¨æ¶ˆæ¯æŽ¥æ”¶æ–¹: ./bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic mykafka --from-beginning mongo ä¸‹è½½å¹¶è¿è¡Œ: docker run -itd --name mongo -v /data/mongo/data:/data/db -p 27017:27017 mongo --auth æ³¨æ„ï¼šé»˜è®¤æ•°æ®æ˜¯å­˜åœ¨å®¹å™¨ç³»ç»Ÿçš„/data/dbç›®å½•ä¸‹çš„ â€“authæ˜¯å¼€å¯è®¤è¯ è®¾ç½®å¯†ç  è¿›å…¥å®¹å™¨: docker exec -it mongo bash è¿žæŽ¥åˆ°mongo: mongo æŸ¥çœ‹å½“å‰ç‰ˆæœ¬: db.version() åˆ‡æ¢åˆ°adminåº“: use admin åˆ›å»ºç®¡ç†å‘˜æƒé™ç”¨æˆ·: db.createUser({ user:&#39;admin&#39;,pwd:&#39;123456&#39;,roles:[ { role:&#39;userAdminAnyDatabase&#39;, db: &#39;admin&#39;}]}); è®¤è¯: db.auth(&#39;admin&#39;,&#39;123456&#39;); åˆ›å»ºæ™®é€šè¯»å†™ å¹¶æŒ‡å®šåº“ç”¨æˆ·: db.createUser({ user:&#39;user&#39;,pwd:&#39;123456&#39;,roles:[ { role:&#39;readWrite&#39;, db: &#39;testdb&#39;}]}); å¿…é¡»è¦åœ¨adminåº“è®¤è¯: db.auth(&#39;user&#39;,&#39;123456&#39;) åˆ‡æ¢åˆ°testdbåº“: use testdb æ’å…¥ä¸€æ¡æ•°æ®åˆ°personé›†åˆä¸­: db.person.insert({name:&#39;libai-go&#39;,age:18}) æŸ¥æ‰¾personé›†åˆæ‰€æœ‰æ•°æ®: db.person.find({}) elasticsearch åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒåŒä¸€ä¸ªç½‘ç»œçš„å†…çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡localhost:port é€šä¿¡ï¼Œæ–¹ä¾¿kibanaè®¿é—®es: docker network create somenetwork ä¸‹è½½å¹¶è¿è¡Œ: docker run -d --name elasticsearch --net somenetwork -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch kibana ä¸‹è½½å¹¶è¿è¡Œ: docker run -d --name kibana --net somenetwork -p 5601:5601 kibana:7.6.2]]></content>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[éƒ¨ç½²SpringbootæœåŠ¡åˆ°äº‘æœåŠ¡å™¨ä¸Š]]></title>
    <url>%2F2019%2F12%2F06%2F%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%2F</url>
    <content type="text"><![CDATA[éƒ¨ç½²ä¸€ä¸ªjavaæœåŠ¡å™¨åˆ°è‡ªå·±çš„äº‘æœåŠ¡å™¨ä¸Š ä»¥è…¾è®¯äº‘æœåŠ¡å™¨ä¸ºä¾‹ è®¾ç½®å®‰å…¨ç»„ï¼Œå¼€æ”¾ä¸€äº›å¸¸ç”¨ç«¯å£åœ¨èœå•é‡Œé€‰æ‹©å®‰å…¨ç»„é…ç½®ä¸€æ¡å®‰å…¨ç»„è§„åˆ™ï¼Œæ·»åŠ å®ŒåŽä¼šå¤šä¸€è¡Œè®°å½•ï¼š é€‰æ‹©æ·»åŠ è§„åˆ™ï¼Œè®¾ç½®å…¥ç«™è§„åˆ™å’Œå‡ºç«™è§„åˆ™ï¼š å°†è¿™ä¸ªå®‰å…¨ç»„è§„åˆ™å…³è”åˆ°è‡ªå·±çš„äº‘ä¸»æœºä¸Šï¼š ä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨å½“å¼€æ”¾å®Œ22ç«¯å£åŽï¼Œå°±å¯ä»¥åŽ»ç”Ÿæˆå…¬ç§é’¥ï¼ŒæŠŠç§é’¥ä¸‹è½½åŽï¼Œä½¿ç”¨xshellè®¿é—®äº‘æœåŠ¡å™¨çš„å…¬ç½‘IPï¼Œä¼šå‡ºçŽ°è¾“å…¥è´¦å·ï¼Œå¯†ç å’Œå¯†é’¥ã€‚æŠŠä¸‹è½½å¥½çš„å¯†é’¥åŠ è½½è¿›æ¥ï¼Œå°±å¯ä»¥ä½¿ç”¨xshellè®¿é—®äº†ã€‚ä»¥åŽå†è¯¦ç»†å†™ã€‚ã€‚ ä¸‹è½½å¿…è¦çš„è½¯ä»¶ PS: æš‚æ—¶è¿˜ä¸æ‡‚ä½¿ç”¨ docker éƒ¨ç½²æœåŠ¡ï¼Œæ‰€ä»¥ç”¨æœ€åŽŸå§‹çš„æ–¹å¼éƒ¨ç½² æˆ‘éƒ¨ç½²çš„æ˜¯springbooté¡¹ç›®ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ°javaçŽ¯å¢ƒï¼Œå…ˆå®‰è£…jdkã€‚ å®‰è£… JDKæŸ¥çœ‹æ˜¯å¦å·²ç»å®‰è£…äº†JDKwhereis javawhich java å¦‚æžœæœ‰jdkä¼šè¾“å‡ºæ‰€åœ¨ä½ç½®ï¼Œå¦‚æžœæ²¡æœ‰ä¸è¾“å‡ºï¼Œæˆ–è€…è¾“å‡ºæ‰¾ä¸åˆ° å¸è½½æ—§ç‰ˆæœ¬çš„JDKæ‰¾åˆ°JDKçš„ä½ç½®ï¼šrpm -qa | grep jdk æ ¹æ®ä½ç½®å¸è½½ï¼š å®‰è£…æƒ³è¦çš„JDKç‰ˆæœ¬æˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯ jdk8 ä¸‹è½½åœ°å€ ï¼Œä¸‹è½½ tar.gz æ ¼å¼çš„æ–‡ä»¶ ä¸‹è½½å®ŒåŽï¼Œä½¿ç”¨ xftp ä¸Šè½½åˆ°äº‘æœåŠ¡å™¨ä¸Šï¼Œæˆ‘è¿™é‡Œæ”¾åˆ°äº†/usr/local ã€‚ è§£åŽ‹åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸Šï¼š tar zxvf jdk8.tar.gz å°†è¯¥jdké…ç½®åˆ°çŽ¯å¢ƒå˜é‡ä¸ŠåŽ»ï¼š vi /etc/profile æ–‡ä»¶æœ«å°¾è¿½åŠ ï¼š 123456JAVA_HOME=/usr/local/jdk1.8.0_231JRE_HOME=/usr/local/jdk1.8.0_231/jrePATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/binCLASSPATH=:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/libexport JAVA_HOME JRE_HOME PATH CLASSPATH ä¿å­˜é€€å‡ºåŽï¼Œä½¿å…¶ç«‹å³ç”Ÿæ•ˆï¼š source /etc/profile åˆ›å»ºTest.javaæ–‡ä»¶: 12345public class Test &#123; public static void main(String[] args) &#123; System.out.println("hello world !"); &#125; &#125; ç¼–è¯‘å¹¶è¿è¡Œï¼Œå¦‚æžœè¾“å‡ºhello woldåˆ™é…ç½®å®Œæˆ javac Test.java java Test å®‰è£… Dockerå› ä¸ºæˆ‘çš„äº‘æœåŠ¡å™¨å®‰è£…çš„æ˜¯CentOs7 ï¼Œæ‰€ä»¥ä½¿ç”¨yumä¸‹è½½ å®‰è£… Dockerï¼š yum -y install docker å¯åŠ¨ Dockerï¼šsystemctl start docker éªŒè¯æ˜¯å¦æˆåŠŸï¼šdocker run hello-world å¦‚æžœè¾“å‡ºhello worldåˆ™æˆåŠŸ ä¸‹è½½æƒ³è¦è¿è¡Œçš„è½¯ä»¶æˆ‘è¿™é‡Œéœ€è¦ç”¨åˆ°Mysqlï¼šdocker pull mysql è¿è¡Œ mysqlï¼Œè¿™é‡Œæ²¡æœ‰è®¾ç½®å¤æ‚çš„å¯†ç ï¼šdocker run -itd --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 docker.io/mysql è¿›å…¥mysqlå®¹å™¨ï¼šdocker exec -it mysql /bin/bash è¾“å…¥è´¦å·ï¼šmysql -uroot -p è¾“å…¥å¯†ç ï¼š è¿›å…¥mysqlåŽï¼Œåˆ›å»ºæ•°æ®åº“å¹¶ä½¿ç”¨ï¼šcreate database mini; å’Œ use mini; é€€å‡ºmysqlå‘½ä»¤è¡Œæ¨¡å¼ï¼šexit é€€å‡º docker å®¹å™¨ï¼šexit maven æ‰“åŒ…ä½¿ç”¨å‘½ä»¤æˆ–è€…ideè¿›è¡Œæ‰“åŒ… å¦‚æžœäº‘ä¸Šçš„é…ç½®å’Œæœ¬åœ°çš„é…ç½®ä¸ä¸€æ ·ï¼Œå¯ä»¥æ‰“åŒ…åŽï¼Œè§£åŽ‹æ‰“å¼€ï¼Œç”¨äº‘ä¸Šçš„é…ç½®æ›¿æ¢æœ¬åœ°çš„é…ç½® åœ¨ xshell è¿è¡Œspringbootè¿›å…¥åˆ°springbooté¡¹ç›®å­˜æ”¾çš„ä½ç½®ï¼Œè¿è¡Œjava -jarå‘½ä»¤ ç›´æŽ¥ç”¨äº‘æœåŠ¡å™¨çš„å…¬ç½‘è®¿é—®è‡ªå·±å†™çš„api]]></content>
      <categories>
        <category>è¿ç»´</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>è¿ç»´</tag>
        <tag>äº‘æœåŠ¡å™¨</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Springç¼“å­˜æ³¨è§£]]></title>
    <url>%2F2019%2F12%2F04%2FSpring%E7%BC%93%E5%AD%98%E6%B3%A8%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[Spring 3.1 å¼•å…¥äº†åŸºäºŽæ³¨è§£çš„ç¼“å­˜æŠ€æœ¯ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå¯¹ç¼“å­˜ä½¿ç”¨çš„æŠ½è±¡ï¼Œé€šè¿‡åœ¨æ—¢æœ‰ä»£ç ä¸­æ·»åŠ å°‘é‡å®ƒå®šä¹‰çš„å„ç§æ³¨è§£ï¼Œå°±èƒ½å¤Ÿè¾¾åˆ°ç¼“å­˜æ–¹æ³•çš„è¿”å›žå¯¹è±¡çš„æ•ˆæžœã€‚ Spring çš„ç¼“å­˜æŠ€æœ¯è¿˜å…·å¤‡ç›¸å½“çš„çµæ´»æ€§ï¼Œä¸ä»…èƒ½å¤Ÿä½¿ç”¨ SpELï¼ˆSpring Expression Languageï¼‰æ¥å®šä¹‰ç¼“å­˜çš„ key å’Œå„ç§ conditionï¼Œè¿˜æä¾›å¼€ç®±å³ç”¨çš„ç¼“å­˜ä¸´æ—¶å­˜å‚¨æ–¹æ¡ˆã€‚ @Cacheable12]]></content>
      <categories>
        <category>æ³¨è§£</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>æ³¨è§£</tag>
        <tag>Spring</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[hexoå¸¸ç”¨å‘½ä»¤]]></title>
    <url>%2F2019%2F11%2F28%2Fhexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%2F</url>
    <content type="text"><![CDATA[å®‰è£…hexonpm install hexo -g æ›´æ–°ç‰ˆæœ¬ npm update hexo -g åˆå§‹åŒ–hexo init å‘½ä»¤&amp;ç®€å†™æ–°å»ºæ–‡ç« hexo new &quot;&lt;title&gt;&quot; === hexo n &quot;&lt;title&gt;&quot; æ–°å»ºè‰ç¨¿hexo new draft &quot;&lt;title&gt;&quot; === hexo n draft &quot;&lt;title&gt;&quot; è‰ç¨¿ç›¸å½“äºŽâ€œç§å¯†æ–‡ç« â€åŠŸèƒ½ã€‚ ä¼šåœ¨source/_draftsç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªè‰ç¨¿çš„markdownæ–‡ä»¶ã€‚ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶ä¸è¢«æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œé“¾æŽ¥ä¹Ÿè®¿é—®ä¸åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æžœä½ æƒ³æŠŠæŸä¸€ç¯‡æ–‡ç« ç§»é™¤æ˜¾ç¤ºï¼Œåˆä¸èˆå¾—åˆ é™¤ï¼Œå¯ä»¥æŠŠå®ƒç§»åŠ¨åˆ°_draftsç›®å½•ä¹‹ä¸­ã€‚ å¦‚æžœä½ å¸Œæœ›å¼ºè¡Œé¢„è§ˆè‰ç¨¿ï¼Œæ›´æ”¹é…ç½®æ–‡ä»¶ï¼šrender_drafts: true æˆ–è€…æœ¬åœ°é¢„è§ˆçš„å‘½ä»¤åŠ å‚æ•°ï¼šhexo server --drafts å°†è‰ç¨¿å‘å¸ƒæˆæ–‡ç« hexo publish &quot;&lt;title&gt;&quot; === hexo p &quot;&lt;title&gt;&quot; ç”Ÿæˆé™æ€ç½‘é¡µ hexo generate === hexo g æ¸…é™¤é¡µé¢ç¼“å­˜hexo clean æœ¬åœ°å¯åŠ¨hexoæœåŠ¡é¢„è§ˆï¼Œä¿®æ”¹å†…å®¹ä¼šæ›´æ–°é¡µé¢hexo server === hexo s hexo server -s #é™æ€æ¨¡å¼ hexo server -p 5000 #æ›´æ”¹ç«¯å£ hexo server -i 192.168.1.1 #è‡ªå®šä¹‰ IP éƒ¨ç½²åˆ°çº¿ä¸Šhexo deploy === hexo d ç»„åˆå‘½ä»¤ï¼Œå¯ä»¥é…ç½®åœ¨package.jsonä¸Š 12345&gt; "scripts": &#123;&gt; "localStart": "hexo clean &amp;&amp; hexo g &amp;&amp; hexo s ",&gt; "blogDeployee": "hexo clean &amp;&amp; hexo g &amp;&amp; hexo d "&gt; &#125;&gt;]]></content>
      <categories>
        <category>blog</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[springbootçš„properties]]></title>
    <url>%2F2019%2F09%2F30%2FSpringboot%E7%9A%84properties%2F</url>
    <content type="text"><![CDATA[SpringbootåŸºæœ¬çš„é…ç½®1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000100110021003100410051006100710081009101010111012101310141015101610171018101910201021102210231024102510261027102810291030103110321033103410351036103710381039104010411042104310441045104610471048104910501051105210531054105510561057105810591060106110621063106410651066106710681069107010711072107310741075107610771078107910801081108210831084108510861087108810891090109110921093109410951096109710981099110011011102110311041105110611071108110911101111111211131114111511161117111811191120112111221123112411251126112711281129113011311132113311341135113611371138113911401141114211431144114511461147114811491150115111521153115411551156115711581159116011611162116311641165116611671168116911701171117211731174117511761177117811791180118111821183118411851186118711881189119011911192119311941195119611971198119912001201120212031204120512061207120812091210121112121213121412151216121712181219122012211222122312241225122612271228122912301231123212331234123512361237123812391240124112421243124412451246124712481249125012511252125312541255125612571258125912601261126212631264126512661267126812691270127112721273127412751276127712781279128012811282128312841285128612871288128912901291129212931294129512961297129812991300130113021303130413051306130713081309131013111312131313141315131613171318131913201321132213231324132513261327132813291330133113321333133413351336133713381339134013411342134313441345134613471348134913501351135213531354135513561357135813591360136113621363136413651366136713681369137013711372137313741375137613771378137913801381138213831384138513861387138813891390139113921393139413951396139713981399140014011402140314041405140614071408140914101411141214131414141514161417141814191420142114221423142414251426142714281429143014311432143314341435143614371438143914401441144214431444144514461447144814491450145114521453145414551456145714581459146014611462146314641465146614671468146914701471147214731474147514761477147814791480148114821483148414851486148714881489149014911492149314941495149614971498149915001501150215031504150515061507150815091510151115121513151415151516151715181519152015211522152315241525152615271528152915301531153215331534153515361537153815391540154115421543154415451546154715481549155015511552155315541555155615571558155915601561# ===================================================================# COMMON SPRING BOOT PROPERTIES## This sample file is provided as a guideline. Do NOT copy it in its# entirety to your own application. ^^^# ===================================================================# ----------------------------------------# CORE PROPERTIES# ----------------------------------------debug=false # Enable debug logs.trace=false # Enable trace logs.# LOGGINGlogging.config= # Location of the logging configuration file. For instance, `classpath:logback.xml` for Logback.logging.exception-conversion-word=%wEx # Conversion word used when logging exceptions.logging.file= # Log file name (for instance, `myapp.log`). Names can be an exact location or relative to the current directory.logging.file.max-history=0 # Maximum of archive log files to keep. Only supported with the default logback setup.logging.file.max-size=10MB # Maximum log file size. Only supported with the default logback setup.logging.group.*= # Log groups to quickly change multiple loggers at the same time. For instance, `logging.level.db=org.hibernate,org.springframework.jdbc`.logging.level.*= # Log levels severity mapping. For instance, `logging.level.org.springframework=DEBUG`.logging.path= # Location of the log file. For instance, `/var/log`.logging.pattern.console= # Appender pattern for output to the console. Supported only with the default Logback setup.logging.pattern.dateformat=yyyy-MM-dd HH:mm:ss.SSS # Appender pattern for log date format. Supported only with the default Logback setup.logging.pattern.file= # Appender pattern for output to a file. Supported only with the default Logback setup.logging.pattern.level=%5p # Appender pattern for log level. Supported only with the default Logback setup.logging.register-shutdown-hook=false # Register a shutdown hook for the logging system when it is initialized.# AOPspring.aop.auto=true # Add @EnableAspectJAutoProxy.spring.aop.proxy-target-class=true # Whether subclass-based (CGLIB) proxies are to be created (true), as opposed to standard Java interface-based proxies (false).# IDENTITY (ContextIdApplicationContextInitializer)spring.application.name= # Application name.# ADMIN (SpringApplicationAdminJmxAutoConfiguration)spring.application.admin.enabled=false # Whether to enable admin features for the application.spring.application.admin.jmx-name=org.springframework.boot:type=Admin,name=SpringApplication # JMX name of the application admin MBean.# AUTO-CONFIGURATIONspring.autoconfigure.exclude= # Auto-configuration classes to exclude.# BANNERspring.banner.charset=UTF-8 # Banner file encoding.spring.banner.location=classpath:banner.txt # Banner text resource location.spring.banner.image.location=classpath:banner.gif # Banner image file location (jpg or png can also be used).spring.banner.image.width=76 # Width of the banner image in chars.spring.banner.image.height= # Height of the banner image in chars (default based on image height).spring.banner.image.margin=2 # Left hand image margin in chars.spring.banner.image.invert=false # Whether images should be inverted for dark terminal themes.# SPRING COREspring.beaninfo.ignore=true # Whether to skip search of BeanInfo classes.# SPRING CACHE (CacheProperties)spring.cache.cache-names= # Comma-separated list of cache names to create if supported by the underlying cache manager.spring.cache.caffeine.spec= # The spec to use to create caches. See CaffeineSpec for more details on the spec format.spring.cache.couchbase.expiration= # Entry expiration. By default the entries never expire. Note that this value is ultimately converted to seconds.spring.cache.ehcache.config= # The location of the configuration file to use to initialize EhCache.spring.cache.infinispan.config= # The location of the configuration file to use to initialize Infinispan.spring.cache.jcache.config= # The location of the configuration file to use to initialize the cache manager.spring.cache.jcache.provider= # Fully qualified name of the CachingProvider implementation to use to retrieve the JSR-107 compliant cache manager. Needed only if more than one JSR-107 implementation is available on the classpath.spring.cache.redis.cache-null-values=true # Allow caching null values.spring.cache.redis.key-prefix= # Key prefix.spring.cache.redis.time-to-live= # Entry expiration. By default the entries never expire.spring.cache.redis.use-key-prefix=true # Whether to use the key prefix when writing to Redis.spring.cache.type= # Cache type. By default, auto-detected according to the environment.# SPRING CONFIG - using environment property only (ConfigFileApplicationListener)spring.config.additional-location= # Config file locations used in addition to the defaults.spring.config.location= # Config file locations that replace the defaults.spring.config.name=application # Config file name.# HAZELCAST (HazelcastProperties)spring.hazelcast.config= # The location of the configuration file to use to initialize Hazelcast.# PROJECT INFORMATION (ProjectInfoProperties)spring.info.build.encoding=UTF-8 # File encoding.spring.info.build.location=classpath:META-INF/build-info.properties # Location of the generated build-info.properties file.spring.info.git.encoding=UTF-8 # File encoding.spring.info.git.location=classpath:git.properties # Location of the generated git.properties file.# JMXspring.jmx.default-domain= # JMX domain name.spring.jmx.enabled=true # Expose management beans to the JMX domain.spring.jmx.server=mbeanServer # MBeanServer bean name.spring.jmx.unique-names=false # Whether unique runtime object names should be ensured.# Email (MailProperties)spring.mail.default-encoding=UTF-8 # Default MimeMessage encoding.spring.mail.host= # SMTP server host. For instance, `smtp.example.com`.spring.mail.jndi-name= # Session JNDI name. When set, takes precedence over other Session settings.spring.mail.password= # Login password of the SMTP server.spring.mail.port= # SMTP server port.spring.mail.properties.*= # Additional JavaMail Session properties.spring.mail.protocol=smtp # Protocol used by the SMTP server.spring.mail.test-connection=false # Whether to test that the mail server is available on startup.spring.mail.username= # Login user of the SMTP server.# APPLICATION SETTINGS (SpringApplication)spring.main.allow-bean-definition-overriding=false # Whether bean definition overriding, by registering a definition with the same name as an existing definition, is allowed.spring.main.banner-mode=console # Mode used to display the banner when the application runs.spring.main.sources= # Sources (class names, package names, or XML resource locations) to include in the ApplicationContext.spring.main.web-application-type= # Flag to explicitly request a specific type of web application. If not set, auto-detected based on the classpath.# FILE ENCODING (FileEncodingApplicationListener)spring.mandatory-file-encoding= # Expected character encoding the application must use.# INTERNATIONALIZATION (MessageSourceProperties)spring.messages.always-use-message-format=false # Whether to always apply the MessageFormat rules, parsing even messages without arguments.spring.messages.basename=messages # Comma-separated list of basenames (essentially a fully-qualified classpath location), each following the ResourceBundle convention with relaxed support for slash based locations.spring.messages.cache-duration= # Loaded resource bundle files cache duration. When not set, bundles are cached forever. If a duration suffix is not specified, seconds will be used.spring.messages.encoding=UTF-8 # Message bundles encoding.spring.messages.fallback-to-system-locale=true # Whether to fall back to the system Locale if no files for a specific Locale have been found.spring.messages.use-code-as-default-message=false # Whether to use the message code as the default message instead of throwing a &quot;NoSuchMessageException&quot;. Recommended during development only.# OUTPUTspring.output.ansi.enabled=detect # Configures the ANSI output.# PID FILE (ApplicationPidFileWriter)spring.pid.fail-on-write-error= # Fails if ApplicationPidFileWriter is used but it cannot write the PID file.spring.pid.file= # Location of the PID file to write (if ApplicationPidFileWriter is used).# PROFILESspring.profiles.active= # Comma-separated list of active profiles. Can be overridden by a command line switch.spring.profiles.include= # Unconditionally activate the specified comma-separated list of profiles (or list of profiles if using YAML).# QUARTZ SCHEDULER (QuartzProperties)spring.quartz.auto-startup=true # Whether to automatically start the scheduler after initialization.spring.quartz.jdbc.comment-prefix=-- # Prefix for single-line comments in SQL initialization scripts.spring.quartz.jdbc.initialize-schema=embedded # Database schema initialization mode.spring.quartz.jdbc.schema=classpath:org/quartz/impl/jdbcjobstore/tables_@@platform@@.sql # Path to the SQL file to use to initialize the database schema.spring.quartz.job-store-type=memory # Quartz job store type.spring.quartz.overwrite-existing-jobs=false # Whether configured jobs should overwrite existing job definitions.spring.quartz.properties.*= # Additional Quartz Scheduler properties.spring.quartz.scheduler-name=quartzScheduler # Name of the scheduler.spring.quartz.startup-delay=0s # Delay after which the scheduler is started once initialization completes.spring.quartz.wait-for-jobs-to-complete-on-shutdown=false # Whether to wait for running jobs to complete on shutdown.# REACTOR (ReactorCoreProperties)spring.reactor.stacktrace-mode.enabled=false # Whether Reactor should collect stacktrace information at runtime.# SENDGRID (SendGridAutoConfiguration)spring.sendgrid.api-key= # SendGrid API key.spring.sendgrid.proxy.host= # SendGrid proxy host.spring.sendgrid.proxy.port= # SendGrid proxy port.# TASK EXECUTION (TaskExecutionProperties)spring.task.execution.pool.allow-core-thread-timeout=true # Whether core threads are allowed to time out. This enables dynamic growing and shrinking of the pool.spring.task.execution.pool.core-size=8 # Core number of threads.spring.task.execution.pool.keep-alive=60s # Time limit for which threads may remain idle before being terminated.spring.task.execution.pool.max-size= # Maximum allowed number of threads. If tasks are filling up the queue, the pool can expand up to that size to accommodate the load. Ignored if the queue is unbounded.spring.task.execution.pool.queue-capacity= # Queue capacity. An unbounded capacity does not increase the pool and therefore ignores the &quot;max-size&quot; property.spring.task.execution.thread-name-prefix=task- # Prefix to use for the names of newly created threads.# TASK SCHEDULING (TaskSchedulingProperties)spring.task.scheduling.pool.size=1 # Maximum allowed number of threads.spring.task.scheduling.thread-name-prefix=scheduling- # Prefix to use for the names of newly created threads.# ----------------------------------------# WEB PROPERTIES# ----------------------------------------# EMBEDDED SERVER CONFIGURATION (ServerProperties)server.address= # Network address to which the server should bind.server.compression.enabled=false # Whether response compression is enabled.server.compression.excluded-user-agents= # Comma-separated list of user agents for which responses should not be compressed.server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml # Comma-separated list of MIME types that should be compressed.server.compression.min-response-size=2KB # Minimum &quot;Content-Length&quot; value that is required for compression to be performed.server.connection-timeout= # Time that connectors wait for another HTTP request before closing the connection. When not set, the connector&apos;s container-specific default is used. Use a value of -1 to indicate no (that is, an infinite) timeout.server.error.include-exception=false # Include the &quot;exception&quot; attribute.server.error.include-stacktrace=never # When to include a &quot;stacktrace&quot; attribute.server.error.path=/error # Path of the error controller.server.error.whitelabel.enabled=true # Whether to enable the default error page displayed in browsers in case of a server error.server.http2.enabled=false # Whether to enable HTTP/2 support, if the current environment supports it.server.jetty.acceptors=-1 # Number of acceptor threads to use. When the value is -1, the default, the number of acceptors is derived from the operating environment.server.jetty.accesslog.append=false # Append to log.server.jetty.accesslog.date-format=dd/MMM/yyyy:HH:mm:ss Z # Timestamp format of the request log.server.jetty.accesslog.enabled=false # Enable access log.server.jetty.accesslog.extended-format=false # Enable extended NCSA format.server.jetty.accesslog.file-date-format= # Date format to place in log file name.server.jetty.accesslog.filename= # Log filename. If not specified, logs redirect to &quot;System.err&quot;.server.jetty.accesslog.locale= # Locale of the request log.server.jetty.accesslog.log-cookies=false # Enable logging of the request cookies.server.jetty.accesslog.log-latency=false # Enable logging of request processing time.server.jetty.accesslog.log-server=false # Enable logging of the request hostname.server.jetty.accesslog.retention-period=31 # Number of days before rotated log files are deleted.server.jetty.accesslog.time-zone=GMT # Timezone of the request log.server.jetty.max-http-post-size=200000B # Maximum size of the HTTP post or put content.server.jetty.selectors=-1 # Number of selector threads to use. When the value is -1, the default, the number of selectors is derived from the operating environment.server.max-http-header-size=8KB # Maximum size of the HTTP message header.server.port=8080 # Server HTTP port.server.server-header= # Value to use for the Server response header (if empty, no header is sent).server.use-forward-headers= # Whether X-Forwarded-* headers should be applied to the HttpRequest.server.servlet.context-parameters.*= # Servlet context init parameters.server.servlet.context-path= # Context path of the application.server.servlet.application-display-name=application # Display name of the application.server.servlet.jsp.class-name=org.apache.jasper.servlet.JspServlet # Class name of the servlet to use for JSPs.server.servlet.jsp.init-parameters.*= # Init parameters used to configure the JSP servlet.server.servlet.jsp.registered=true # Whether the JSP servlet is registered.server.servlet.session.cookie.comment= # Comment for the session cookie.server.servlet.session.cookie.domain= # Domain for the session cookie.server.servlet.session.cookie.http-only= # Whether to use &quot;HttpOnly&quot; cookies for session cookies.server.servlet.session.cookie.max-age= # Maximum age of the session cookie. If a duration suffix is not specified, seconds will be used.server.servlet.session.cookie.name= # Session cookie name.server.servlet.session.cookie.path= # Path of the session cookie.server.servlet.session.cookie.secure= # Whether to always mark the session cookie as secure.server.servlet.session.persistent=false # Whether to persist session data between restarts.server.servlet.session.store-dir= # Directory used to store session data.server.servlet.session.timeout=30m # Session timeout. If a duration suffix is not specified, seconds will be used.server.servlet.session.tracking-modes= # Session tracking modes.server.ssl.ciphers= # Supported SSL ciphers.server.ssl.client-auth= # Client authentication mode.server.ssl.enabled=true # Whether to enable SSL support.server.ssl.enabled-protocols= # Enabled SSL protocols.server.ssl.key-alias= # Alias that identifies the key in the key store.server.ssl.key-password= # Password used to access the key in the key store.server.ssl.key-store= # Path to the key store that holds the SSL certificate (typically a jks file).server.ssl.key-store-password= # Password used to access the key store.server.ssl.key-store-provider= # Provider for the key store.server.ssl.key-store-type= # Type of the key store.server.ssl.protocol=TLS # SSL protocol to use.server.ssl.trust-store= # Trust store that holds SSL certificates.server.ssl.trust-store-password= # Password used to access the trust store.server.ssl.trust-store-provider= # Provider for the trust store.server.ssl.trust-store-type= # Type of the trust store.server.tomcat.accept-count=100 # Maximum queue length for incoming connection requests when all possible request processing threads are in use.server.tomcat.accesslog.buffered=true # Whether to buffer output such that it is flushed only periodically.server.tomcat.accesslog.directory=logs # Directory in which log files are created. Can be absolute or relative to the Tomcat base dir.server.tomcat.accesslog.enabled=false # Enable access log.server.tomcat.accesslog.file-date-format=.yyyy-MM-dd # Date format to place in the log file name.server.tomcat.accesslog.pattern=common # Format pattern for access logs.server.tomcat.accesslog.prefix=access_log # Log file name prefix.server.tomcat.accesslog.rename-on-rotate=false # Whether to defer inclusion of the date stamp in the file name until rotate time.server.tomcat.accesslog.request-attributes-enabled=false # Set request attributes for the IP address, Hostname, protocol, and port used for the request.server.tomcat.accesslog.rotate=true # Whether to enable access log rotation.server.tomcat.accesslog.suffix=.log # Log file name suffix.server.tomcat.additional-tld-skip-patterns= # Comma-separated list of additional patterns that match jars to ignore for TLD scanning.server.tomcat.background-processor-delay=10s # Delay between the invocation of backgroundProcess methods. If a duration suffix is not specified, seconds will be used.server.tomcat.basedir= # Tomcat base directory. If not specified, a temporary directory is used.server.tomcat.internal-proxies=10\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\ 192\\.168\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\ 169\\.254\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\ 127\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\ 172\\.1[6-9]&#123;1&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\ 172\\.2[0-9]&#123;1&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;|\\ 172\\.3[0-1]&#123;1&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\ 0:0:0:0:0:0:0:1\\ ::1 # Regular expression that matches proxies that are to be trusted.server.tomcat.max-connections=10000 # Maximum number of connections that the server accepts and processes at any given time.server.tomcat.max-http-post-size=2MB # Maximum size of the HTTP post content.server.tomcat.max-swallow-size=2MB # Maximum amount of request body to swallow.server.tomcat.max-threads=200 # Maximum amount of worker threads.server.tomcat.min-spare-threads=10 # Minimum amount of worker threads.server.tomcat.port-header=X-Forwarded-Port # Name of the HTTP header used to override the original port value.server.tomcat.protocol-header= # Header that holds the incoming protocol, usually named &quot;X-Forwarded-Proto&quot;.server.tomcat.protocol-header-https-value=https # Value of the protocol header indicating whether the incoming request uses SSL.server.tomcat.redirect-context-root=true # Whether requests to the context root should be redirected by appending a / to the path.server.tomcat.remote-ip-header= # Name of the HTTP header from which the remote IP is extracted. For instance, `X-FORWARDED-FOR`.server.tomcat.resource.allow-caching=true # Whether static resource caching is permitted for this web application.server.tomcat.resource.cache-ttl= # Time-to-live of the static resource cache.server.tomcat.uri-encoding=UTF-8 # Character encoding to use to decode the URI.server.tomcat.use-relative-redirects= # Whether HTTP 1.1 and later location headers generated by a call to sendRedirect will use relative or absolute redirects.server.undertow.accesslog.dir= # Undertow access log directory.server.undertow.accesslog.enabled=false # Whether to enable the access log.server.undertow.accesslog.pattern=common # Format pattern for access logs.server.undertow.accesslog.prefix=access_log. # Log file name prefix.server.undertow.accesslog.rotate=true # Whether to enable access log rotation.server.undertow.accesslog.suffix=log # Log file name suffix.server.undertow.buffer-size= # Size of each buffer.server.undertow.direct-buffers= # Whether to allocate buffers outside the Java heap. The default is derived from the maximum amount of memory that is available to the JVM.server.undertow.eager-filter-init=true # Whether servlet filters should be initialized on startup.server.undertow.io-threads= # Number of I/O threads to create for the worker. The default is derived from the number of available processors.server.undertow.max-http-post-size=-1B # Maximum size of the HTTP post content. When the value is -1, the default, the size is unlimited.server.undertow.worker-threads= # Number of worker threads. The default is 8 times the number of I/O threads.# FREEMARKER (FreeMarkerProperties)spring.freemarker.allow-request-override=false # Whether HttpServletRequest attributes are allowed to override (hide) controller generated model attributes of the same name.spring.freemarker.allow-session-override=false # Whether HttpSession attributes are allowed to override (hide) controller generated model attributes of the same name.spring.freemarker.cache=false # Whether to enable template caching.spring.freemarker.charset=UTF-8 # Template encoding.spring.freemarker.check-template-location=true # Whether to check that the templates location exists.spring.freemarker.content-type=text/html # Content-Type value.spring.freemarker.enabled=true # Whether to enable MVC view resolution for this technology.spring.freemarker.expose-request-attributes=false # Whether all request attributes should be added to the model prior to merging with the template.spring.freemarker.expose-session-attributes=false # Whether all HttpSession attributes should be added to the model prior to merging with the template.spring.freemarker.expose-spring-macro-helpers=true # Whether to expose a RequestContext for use by Spring&apos;s macro library, under the name &quot;springMacroRequestContext&quot;.spring.freemarker.prefer-file-system-access=true # Whether to prefer file system access for template loading. File system access enables hot detection of template changes.spring.freemarker.prefix= # Prefix that gets prepended to view names when building a URL.spring.freemarker.request-context-attribute= # Name of the RequestContext attribute for all views.spring.freemarker.settings.*= # Well-known FreeMarker keys which are passed to FreeMarker&apos;s Configuration.spring.freemarker.suffix=.ftl # Suffix that gets appended to view names when building a URL.spring.freemarker.template-loader-path=classpath:/templates/ # Comma-separated list of template paths.spring.freemarker.view-names= # White list of view names that can be resolved.# GROOVY TEMPLATES (GroovyTemplateProperties)spring.groovy.template.allow-request-override=false # Whether HttpServletRequest attributes are allowed to override (hide) controller generated model attributes of the same name.spring.groovy.template.allow-session-override=false # Whether HttpSession attributes are allowed to override (hide) controller generated model attributes of the same name.spring.groovy.template.cache=false # Whether to enable template caching.spring.groovy.template.charset=UTF-8 # Template encoding.spring.groovy.template.check-template-location=true # Whether to check that the templates location exists.spring.groovy.template.configuration.*= # See GroovyMarkupConfigurerspring.groovy.template.content-type=text/html # Content-Type value.spring.groovy.template.enabled=true # Whether to enable MVC view resolution for this technology.spring.groovy.template.expose-request-attributes=false # Whether all request attributes should be added to the model prior to merging with the template.spring.groovy.template.expose-session-attributes=false # Whether all HttpSession attributes should be added to the model prior to merging with the template.spring.groovy.template.expose-spring-macro-helpers=true # Whether to expose a RequestContext for use by Spring&apos;s macro library, under the name &quot;springMacroRequestContext&quot;.spring.groovy.template.prefix= # Prefix that gets prepended to view names when building a URL.spring.groovy.template.request-context-attribute= # Name of the RequestContext attribute for all views.spring.groovy.template.resource-loader-path=classpath:/templates/ # Template path.spring.groovy.template.suffix=.tpl # Suffix that gets appended to view names when building a URL.spring.groovy.template.view-names= # White list of view names that can be resolved.# SPRING HATEOAS (HateoasProperties)spring.hateoas.use-hal-as-default-json-media-type=true # Whether application/hal+json responses should be sent to requests that accept application/json.# HTTP (HttpProperties)spring.http.converters.preferred-json-mapper= # Preferred JSON mapper to use for HTTP message conversion. By default, auto-detected according to the environment.spring.http.encoding.charset=UTF-8 # Charset of HTTP requests and responses. Added to the &quot;Content-Type&quot; header if not set explicitly.spring.http.encoding.enabled=true # Whether to enable http encoding support.spring.http.encoding.force= # Whether to force the encoding to the configured charset on HTTP requests and responses.spring.http.encoding.force-request= # Whether to force the encoding to the configured charset on HTTP requests. Defaults to true when &quot;force&quot; has not been specified.spring.http.encoding.force-response= # Whether to force the encoding to the configured charset on HTTP responses.spring.http.encoding.mapping= # Locale in which to encode mapping.spring.http.log-request-details=false # Whether logging of (potentially sensitive) request details at DEBUG and TRACE level is allowed.# MULTIPART (MultipartProperties)spring.servlet.multipart.enabled=true # Whether to enable support of multipart uploads.spring.servlet.multipart.file-size-threshold=0B # Threshold after which files are written to disk.spring.servlet.multipart.location= # Intermediate location of uploaded files.spring.servlet.multipart.max-file-size=1MB # Max file size.spring.servlet.multipart.max-request-size=10MB # Max request size.spring.servlet.multipart.resolve-lazily=false # Whether to resolve the multipart request lazily at the time of file or parameter access.# JACKSON (JacksonProperties)spring.jackson.date-format= # Date format string or a fully-qualified date format class name. For instance, `yyyy-MM-dd HH:mm:ss`.spring.jackson.default-property-inclusion= # Controls the inclusion of properties during serialization. Configured with one of the values in Jackson&apos;s JsonInclude.Include enumeration.spring.jackson.deserialization.*= # Jackson on/off features that affect the way Java objects are deserialized.spring.jackson.generator.*= # Jackson on/off features for generators.spring.jackson.joda-date-time-format= # Joda date time format string. If not configured, &quot;date-format&quot; is used as a fallback if it is configured with a format string.spring.jackson.locale= # Locale used for formatting.spring.jackson.mapper.*= # Jackson general purpose on/off features.spring.jackson.parser.*= # Jackson on/off features for parsers.spring.jackson.property-naming-strategy= # One of the constants on Jackson&apos;s PropertyNamingStrategy. Can also be a fully-qualified class name of a PropertyNamingStrategy subclass.spring.jackson.serialization.*= # Jackson on/off features that affect the way Java objects are serialized.spring.jackson.time-zone= # Time zone used when formatting dates. For instance, &quot;America/Los_Angeles&quot; or &quot;GMT+10&quot;.spring.jackson.visibility.*= # Jackson visibility thresholds that can be used to limit which methods (and fields) are auto-detected.# GSON (GsonProperties)spring.gson.date-format= # Format to use when serializing Date objects.spring.gson.disable-html-escaping= # Whether to disable the escaping of HTML characters such as &apos;&lt;&apos;, &apos;&gt;&apos;, etc.spring.gson.disable-inner-class-serialization= # Whether to exclude inner classes during serialization.spring.gson.enable-complex-map-key-serialization= # Whether to enable serialization of complex map keys (i.e. non-primitives).spring.gson.exclude-fields-without-expose-annotation= # Whether to exclude all fields from consideration for serialization or deserialization that do not have the &quot;Expose&quot; annotation.spring.gson.field-naming-policy= # Naming policy that should be applied to an object&apos;s field during serialization and deserialization.spring.gson.generate-non-executable-json= # Whether to generate non executable JSON by prefixing the output with some special text.spring.gson.lenient= # Whether to be lenient about parsing JSON that doesn&apos;t conform to RFC 4627.spring.gson.long-serialization-policy= # Serialization policy for Long and long types.spring.gson.pretty-printing= # Whether to output serialized JSON that fits in a page for pretty printing.spring.gson.serialize-nulls= # Whether to serialize null fields.# JERSEY (JerseyProperties)spring.jersey.application-path= # Path that serves as the base URI for the application. If specified, overrides the value of &quot;@ApplicationPath&quot;.spring.jersey.filter.order=0 # Jersey filter chain order.spring.jersey.init.*= # Init parameters to pass to Jersey through the servlet or filter.spring.jersey.servlet.load-on-startup=-1 # Load on startup priority of the Jersey servlet.spring.jersey.type=servlet # Jersey integration type.# SPRING LDAP (LdapProperties)spring.ldap.anonymous-read-only=false # Whether read-only operations should use an anonymous environment.spring.ldap.base= # Base suffix from which all operations should originate.spring.ldap.base-environment.*= # LDAP specification settings.spring.ldap.password= # Login password of the server.spring.ldap.urls= # LDAP URLs of the server.spring.ldap.username= # Login username of the server.# EMBEDDED LDAP (EmbeddedLdapProperties)spring.ldap.embedded.base-dn= # List of base DNs.spring.ldap.embedded.credential.username= # Embedded LDAP username.spring.ldap.embedded.credential.password= # Embedded LDAP password.spring.ldap.embedded.ldif=classpath:schema.ldif # Schema (LDIF) script resource reference.spring.ldap.embedded.port=0 # Embedded LDAP port.spring.ldap.embedded.validation.enabled=true # Whether to enable LDAP schema validation.spring.ldap.embedded.validation.schema= # Path to the custom schema.# MUSTACHE TEMPLATES (MustacheAutoConfiguration)spring.mustache.allow-request-override=false # Whether HttpServletRequest attributes are allowed to override (hide) controller generated model attributes of the same name.spring.mustache.allow-session-override=false # Whether HttpSession attributes are allowed to override (hide) controller generated model attributes of the same name.spring.mustache.cache=false # Whether to enable template caching.spring.mustache.charset=UTF-8 # Template encoding.spring.mustache.check-template-location=true # Whether to check that the templates location exists.spring.mustache.content-type=text/html # Content-Type value.spring.mustache.enabled=true # Whether to enable MVC view resolution for this technology.spring.mustache.expose-request-attributes=false # Whether all request attributes should be added to the model prior to merging with the template.spring.mustache.expose-session-attributes=false # Whether all HttpSession attributes should be added to the model prior to merging with the template.spring.mustache.expose-spring-macro-helpers=true # Whether to expose a RequestContext for use by Spring&apos;s macro library, under the name &quot;springMacroRequestContext&quot;.spring.mustache.prefix=classpath:/templates/ # Prefix to apply to template names.spring.mustache.request-context-attribute= # Name of the RequestContext attribute for all views.spring.mustache.suffix=.mustache # Suffix to apply to template names.spring.mustache.view-names= # White list of view names that can be resolved.# SPRING MVC (WebMvcProperties)spring.mvc.async.request-timeout= # Amount of time before asynchronous request handling times out.spring.mvc.contentnegotiation.favor-parameter=false # Whether a request parameter (&quot;format&quot; by default) should be used to determine the requested media type.spring.mvc.contentnegotiation.favor-path-extension=false # Whether the path extension in the URL path should be used to determine the requested media type.spring.mvc.contentnegotiation.media-types.*= # Map file extensions to media types for content negotiation. For instance, yml to text/yaml.spring.mvc.contentnegotiation.parameter-name= # Query parameter name to use when &quot;favor-parameter&quot; is enabled.spring.mvc.date-format= # Date format to use. For instance, `dd/MM/yyyy`.spring.mvc.dispatch-trace-request=false # Whether to dispatch TRACE requests to the FrameworkServlet doService method.spring.mvc.dispatch-options-request=true # Whether to dispatch OPTIONS requests to the FrameworkServlet doService method.spring.mvc.favicon.enabled=true # Whether to enable resolution of favicon.ico.spring.mvc.formcontent.filter.enabled=true # Whether to enable Spring&apos;s FormContentFilter.spring.mvc.hiddenmethod.filter.enabled=true # Whether to enable Spring&apos;s HiddenHttpMethodFilter.spring.mvc.ignore-default-model-on-redirect=true # Whether the content of the &quot;default&quot; model should be ignored during redirect scenarios.spring.mvc.locale= # Locale to use. By default, this locale is overridden by the &quot;Accept-Language&quot; header.spring.mvc.locale-resolver=accept-header # Define how the locale should be resolved.spring.mvc.log-resolved-exception=false # Whether to enable warn logging of exceptions resolved by a &quot;HandlerExceptionResolver&quot;, except for &quot;DefaultHandlerExceptionResolver&quot;.spring.mvc.message-codes-resolver-format= # Formatting strategy for message codes. For instance, `PREFIX_ERROR_CODE`.spring.mvc.pathmatch.use-registered-suffix-pattern=false # Whether suffix pattern matching should work only against extensions registered with &quot;spring.mvc.contentnegotiation.media-types.*&quot;.spring.mvc.pathmatch.use-suffix-pattern=false # Whether to use suffix pattern match (&quot;.*&quot;) when matching patterns to requests.spring.mvc.servlet.load-on-startup=-1 # Load on startup priority of the dispatcher servlet.spring.mvc.servlet.path=/ # Path of the dispatcher servlet.spring.mvc.static-path-pattern=/** # Path pattern used for static resources.spring.mvc.throw-exception-if-no-handler-found=false # Whether a &quot;NoHandlerFoundException&quot; should be thrown if no Handler was found to process a request.spring.mvc.view.prefix= # Spring MVC view prefix.spring.mvc.view.suffix= # Spring MVC view suffix.# SPRING RESOURCES HANDLING (ResourceProperties)spring.resources.add-mappings=true # Whether to enable default resource handling.spring.resources.cache.cachecontrol.cache-private= # Indicate that the response message is intended for a single user and must not be stored by a shared cache.spring.resources.cache.cachecontrol.cache-public= # Indicate that any cache may store the response.spring.resources.cache.cachecontrol.max-age= # Maximum time the response should be cached, in seconds if no duration suffix is not specified.spring.resources.cache.cachecontrol.must-revalidate= # Indicate that once it has become stale, a cache must not use the response without re-validating it with the server.spring.resources.cache.cachecontrol.no-cache= # Indicate that the cached response can be reused only if re-validated with the server.spring.resources.cache.cachecontrol.no-store= # Indicate to not cache the response in any case.spring.resources.cache.cachecontrol.no-transform= # Indicate intermediaries (caches and others) that they should not transform the response content.spring.resources.cache.cachecontrol.proxy-revalidate= # Same meaning as the &quot;must-revalidate&quot; directive, except that it does not apply to private caches.spring.resources.cache.cachecontrol.s-max-age= # Maximum time the response should be cached by shared caches, in seconds if no duration suffix is not specified.spring.resources.cache.cachecontrol.stale-if-error= # Maximum time the response may be used when errors are encountered, in seconds if no duration suffix is not specified.spring.resources.cache.cachecontrol.stale-while-revalidate= # Maximum time the response can be served after it becomes stale, in seconds if no duration suffix is not specified.spring.resources.cache.period= # Cache period for the resources served by the resource handler. If a duration suffix is not specified, seconds will be used.spring.resources.chain.cache=true # Whether to enable caching in the Resource chain.spring.resources.chain.compressed=false # Whether to enable resolution of already compressed resources (gzip, brotli).spring.resources.chain.enabled= # Whether to enable the Spring Resource Handling chain. By default, disabled unless at least one strategy has been enabled.spring.resources.chain.html-application-cache=false # Whether to enable HTML5 application cache manifest rewriting.spring.resources.chain.strategy.content.enabled=false # Whether to enable the content Version Strategy.spring.resources.chain.strategy.content.paths=/** # Comma-separated list of patterns to apply to the content Version Strategy.spring.resources.chain.strategy.fixed.enabled=false # Whether to enable the fixed Version Strategy.spring.resources.chain.strategy.fixed.paths=/** # Comma-separated list of patterns to apply to the fixed Version Strategy.spring.resources.chain.strategy.fixed.version= # Version string to use for the fixed Version Strategy.spring.resources.static-locations=classpath:/META-INF/resources/,classpath:/resources/,classpath:/static/,classpath:/public/ # Locations of static resources.# SPRING SESSION (SessionProperties)spring.session.store-type= # Session store type.spring.session.timeout= # Session timeout. If a duration suffix is not specified, seconds will be used.spring.session.servlet.filter-order=-2147483598 # Session repository filter order.spring.session.servlet.filter-dispatcher-types=async,error,request # Session repository filter dispatcher types.# SPRING SESSION HAZELCAST (HazelcastSessionProperties)spring.session.hazelcast.flush-mode=on-save # Sessions flush mode.spring.session.hazelcast.map-name=spring:session:sessions # Name of the map used to store sessions.# SPRING SESSION JDBC (JdbcSessionProperties)spring.session.jdbc.cleanup-cron=0 * * * * * # Cron expression for expired session cleanup job.spring.session.jdbc.initialize-schema=embedded # Database schema initialization mode.spring.session.jdbc.schema=classpath:org/springframework/session/jdbc/schema-@@platform@@.sql # Path to the SQL file to use to initialize the database schema.spring.session.jdbc.table-name=SPRING_SESSION # Name of the database table used to store sessions.# SPRING SESSION MONGODB (MongoSessionProperties)spring.session.mongodb.collection-name=sessions # Collection name used to store sessions.# SPRING SESSION REDIS (RedisSessionProperties)spring.session.redis.cleanup-cron=0 * * * * * # Cron expression for expired session cleanup job.spring.session.redis.flush-mode=on-save # Sessions flush mode.spring.session.redis.namespace=spring:session # Namespace for keys used to store sessions.# THYMELEAF (ThymeleafAutoConfiguration)spring.thymeleaf.cache=true # Whether to enable template caching.spring.thymeleaf.check-template=true # Whether to check that the template exists before rendering it.spring.thymeleaf.check-template-location=true # Whether to check that the templates location exists.spring.thymeleaf.enabled=true # Whether to enable Thymeleaf view resolution for Web frameworks.spring.thymeleaf.enable-spring-el-compiler=false # Enable the SpringEL compiler in SpringEL expressions.spring.thymeleaf.encoding=UTF-8 # Template files encoding.spring.thymeleaf.excluded-view-names= # Comma-separated list of view names (patterns allowed) that should be excluded from resolution.spring.thymeleaf.mode=HTML # Template mode to be applied to templates. See also Thymeleaf&apos;s TemplateMode enum.spring.thymeleaf.prefix=classpath:/templates/ # Prefix that gets prepended to view names when building a URL.spring.thymeleaf.reactive.chunked-mode-view-names= # Comma-separated list of view names (patterns allowed) that should be the only ones executed in CHUNKED mode when a max chunk size is set.spring.thymeleaf.reactive.full-mode-view-names= # Comma-separated list of view names (patterns allowed) that should be executed in FULL mode even if a max chunk size is set.spring.thymeleaf.reactive.max-chunk-size=0B # Maximum size of data buffers used for writing to the response.spring.thymeleaf.reactive.media-types= # Media types supported by the view technology.spring.thymeleaf.render-hidden-markers-before-checkboxes=false # Whether hidden form inputs acting as markers for checkboxes should be rendered before the checkbox element itself.spring.thymeleaf.servlet.content-type=text/html # Content-Type value written to HTTP responses.spring.thymeleaf.servlet.produce-partial-output-while-processing=true # Whether Thymeleaf should start writing partial output as soon as possible or buffer until template processing is finished.spring.thymeleaf.suffix=.html # Suffix that gets appended to view names when building a URL.spring.thymeleaf.template-resolver-order= # Order of the template resolver in the chain.spring.thymeleaf.view-names= # Comma-separated list of view names (patterns allowed) that can be resolved.# SPRING WEBFLUX (WebFluxProperties)spring.webflux.date-format= # Date format to use. For instance, `dd/MM/yyyy`.spring.webflux.hiddenmethod.filter.enabled=true # Whether to enable Spring&apos;s HiddenHttpMethodFilter.spring.webflux.static-path-pattern=/** # Path pattern used for static resources.# SPRING WEB SERVICES (WebServicesProperties)spring.webservices.path=/services # Path that serves as the base URI for the services.spring.webservices.servlet.init= # Servlet init parameters to pass to Spring Web Services.spring.webservices.servlet.load-on-startup=-1 # Load on startup priority of the Spring Web Services servlet.spring.webservices.wsdl-locations= # Comma-separated list of locations of WSDLs and accompanying XSDs to be exposed as beans.# ----------------------------------------# SECURITY PROPERTIES# ----------------------------------------# SECURITY (SecurityProperties)spring.security.filter.order=-100 # Security filter chain order.spring.security.filter.dispatcher-types=async,error,request # Security filter chain dispatcher types.spring.security.user.name=user # Default user name.spring.security.user.password= # Password for the default user name.spring.security.user.roles= # Granted roles for the default user name.# SECURITY OAUTH2 CLIENT (OAuth2ClientProperties)spring.security.oauth2.client.provider.*= # OAuth provider details.spring.security.oauth2.client.registration.*= # OAuth client registrations.# SECURITY OAUTH2 RESOURCE SERVER (OAuth2ResourceServerProperties)spring.security.oauth2.resourceserver.jwt.jwk-set-uri= # JSON Web Key URI to use to verify the JWT token.spring.security.oauth2.resourceserver.jwt.issuer-uri= # URI that an OpenID Connect Provider asserts as its Issuer Identifier.# ----------------------------------------# DATA PROPERTIES# ----------------------------------------# FLYWAY (FlywayProperties)spring.flyway.baseline-description=&lt;&lt; Flyway Baseline &gt;&gt; # Description to tag an existing schema with when applying a baseline.spring.flyway.baseline-on-migrate=false # Whether to automatically call baseline when migrating a non-empty schema.spring.flyway.baseline-version=1 # Version to tag an existing schema with when executing baseline.spring.flyway.check-location=true # Whether to check that migration scripts location exists.spring.flyway.clean-disabled=false # Whether to disable cleaning of the database.spring.flyway.clean-on-validation-error=false # Whether to automatically call clean when a validation error occurs.spring.flyway.connect-retries=0 # Maximum number of retries when attempting to connect to the database.spring.flyway.enabled=true # Whether to enable flyway.spring.flyway.encoding=UTF-8 # Encoding of SQL migrations.spring.flyway.group=false # Whether to group all pending migrations together in the same transaction when applying them.spring.flyway.ignore-future-migrations=true # Whether to ignore future migrations when reading the schema history table.spring.flyway.ignore-ignored-migrations=false # Whether to ignore ignored migrations when reading the schema history table.spring.flyway.ignore-missing-migrations=false # Whether to ignore missing migrations when reading the schema history table.spring.flyway.ignore-pending-migrations=false # Whether to ignore pending migrations when reading the schema history table.spring.flyway.init-sqls= # SQL statements to execute to initialize a connection immediately after obtaining it.spring.flyway.installed-by= # Username recorded in the schema history table as having applied the migration.spring.flyway.locations=classpath:db/migration # Locations of migrations scripts. Can contain the special &quot;&#123;vendor&#125;&quot; placeholder to use vendor-specific locations.spring.flyway.mixed=false # Whether to allow mixing transactional and non-transactional statements within the same migration.spring.flyway.out-of-order=false # Whether to allow migrations to be run out of order.spring.flyway.password= # Login password of the database to migrate.spring.flyway.placeholder-prefix=$&#123; # Prefix of placeholders in migration scripts.spring.flyway.placeholder-replacement=true # Perform placeholder replacement in migration scripts.spring.flyway.placeholder-suffix=&#125; # Suffix of placeholders in migration scripts.spring.flyway.placeholders= # Placeholders and their replacements to apply to sql migration scripts.spring.flyway.repeatable-sql-migration-prefix=R # File name prefix for repeatable SQL migrations.spring.flyway.schemas= # Scheme names managed by Flyway (case-sensitive).spring.flyway.skip-default-callbacks=false # Whether to skip default callbacks. If true, only custom callbacks are used.spring.flyway.skip-default-resolvers=false # Whether to skip default resolvers. If true, only custom resolvers are used.spring.flyway.sql-migration-prefix=V # File name prefix for SQL migrations.spring.flyway.sql-migration-separator=__ # File name separator for SQL migrations.spring.flyway.sql-migration-suffixes=.sql # File name suffix for SQL migrations.spring.flyway.table=flyway_schema_history # Name of the schema schema history table that will be used by Flyway.spring.flyway.target= # Target version up to which migrations should be considered.spring.flyway.url= # JDBC url of the database to migrate. If not set, the primary configured data source is used.spring.flyway.user= # Login user of the database to migrate.spring.flyway.validate-on-migrate=true # Whether to automatically call validate when performing a migration.# LIQUIBASE (LiquibaseProperties)spring.liquibase.change-log=classpath:/db/changelog/db.changelog-master.yaml # Change log configuration path.spring.liquibase.contexts= # Comma-separated list of runtime contexts to use.spring.liquibase.database-change-log-lock-table=DATABASECHANGELOGLOCK # Name of table to use for tracking concurrent Liquibase usage.spring.liquibase.database-change-log-table=DATABASECHANGELOG # Name of table to use for tracking change history.spring.liquibase.default-schema= # Default database schema.spring.liquibase.drop-first=false # Whether to first drop the database schema.spring.liquibase.enabled=true # Whether to enable Liquibase support.spring.liquibase.labels= # Comma-separated list of runtime labels to use.spring.liquibase.liquibase-schema= # Schema to use for Liquibase objects.spring.liquibase.liquibase-tablespace= # Tablespace to use for Liquibase objects.spring.liquibase.parameters.*= # Change log parameters.spring.liquibase.password= # Login password of the database to migrate.spring.liquibase.rollback-file= # File to which rollback SQL is written when an update is performed.spring.liquibase.test-rollback-on-update=false # Whether rollback should be tested before update is performed.spring.liquibase.url= # JDBC URL of the database to migrate. If not set, the primary configured data source is used.spring.liquibase.user= # Login user of the database to migrate.# COUCHBASE (CouchbaseProperties)spring.couchbase.bootstrap-hosts= # Couchbase nodes (host or IP address) to bootstrap from.spring.couchbase.bucket.name=default # Name of the bucket to connect to.spring.couchbase.bucket.password= # Password of the bucket.spring.couchbase.env.endpoints.key-value=1 # Number of sockets per node against the key/value service.spring.couchbase.env.endpoints.queryservice.min-endpoints=1 # Minimum number of sockets per node.spring.couchbase.env.endpoints.queryservice.max-endpoints=1 # Maximum number of sockets per node.spring.couchbase.env.endpoints.viewservice.min-endpoints=1 # Minimum number of sockets per node.spring.couchbase.env.endpoints.viewservice.max-endpoints=1 # Maximum number of sockets per node.spring.couchbase.env.ssl.enabled= # Whether to enable SSL support. Enabled automatically if a &quot;keyStore&quot; is provided unless specified otherwise.spring.couchbase.env.ssl.key-store= # Path to the JVM key store that holds the certificates.spring.couchbase.env.ssl.key-store-password= # Password used to access the key store.spring.couchbase.env.timeouts.connect=5000ms # Bucket connections timeouts.spring.couchbase.env.timeouts.key-value=2500ms # Blocking operations performed on a specific key timeout.spring.couchbase.env.timeouts.query=7500ms # N1QL query operations timeout.spring.couchbase.env.timeouts.socket-connect=1000ms # Socket connect connections timeout.spring.couchbase.env.timeouts.view=7500ms # Regular and geospatial view operations timeout.# DAO (PersistenceExceptionTranslationAutoConfiguration)spring.dao.exceptiontranslation.enabled=true # Whether to enable the PersistenceExceptionTranslationPostProcessor.# CASSANDRA (CassandraProperties)spring.data.cassandra.cluster-name= # Name of the Cassandra cluster.spring.data.cassandra.compression=none # Compression supported by the Cassandra binary protocol.spring.data.cassandra.connect-timeout= # Socket option: connection time out.spring.data.cassandra.consistency-level= # Queries consistency level.spring.data.cassandra.contact-points=localhost # Cluster node addresses.spring.data.cassandra.fetch-size= # Queries default fetch size.spring.data.cassandra.jmx-enabled=false # Whether to enable JMX reporting.spring.data.cassandra.keyspace-name= # Keyspace name to use.spring.data.cassandra.port= # Port of the Cassandra server.spring.data.cassandra.password= # Login password of the server.spring.data.cassandra.pool.heartbeat-interval=30s # Heartbeat interval after which a message is sent on an idle connection to make sure it&apos;s still alive. If a duration suffix is not specified, seconds will be used.spring.data.cassandra.pool.idle-timeout=120s # Idle timeout before an idle connection is removed. If a duration suffix is not specified, seconds will be used.spring.data.cassandra.pool.max-queue-size=256 # Maximum number of requests that get queued if no connection is available.spring.data.cassandra.pool.pool-timeout=5000ms # Pool timeout when trying to acquire a connection from a host&apos;s pool.spring.data.cassandra.read-timeout= # Socket option: read time out.spring.data.cassandra.repositories.type=auto # Type of Cassandra repositories to enable.spring.data.cassandra.serial-consistency-level= # Queries serial consistency level.spring.data.cassandra.schema-action=none # Schema action to take at startup.spring.data.cassandra.ssl=false # Enable SSL support.spring.data.cassandra.username= # Login user of the server.# DATA COUCHBASE (CouchbaseDataProperties)spring.data.couchbase.auto-index=false # Automatically create views and indexes.spring.data.couchbase.consistency=read-your-own-writes # Consistency to apply by default on generated queries.spring.data.couchbase.repositories.type=auto # Type of Couchbase repositories to enable.# ELASTICSEARCH (ElasticsearchProperties)spring.data.elasticsearch.cluster-name=elasticsearch # Elasticsearch cluster name.spring.data.elasticsearch.cluster-nodes= # Comma-separated list of cluster node addresses.spring.data.elasticsearch.properties.*= # Additional properties used to configure the client.spring.data.elasticsearch.repositories.enabled=true # Whether to enable Elasticsearch repositories.# DATA JDBCspring.data.jdbc.repositories.enabled=true # Whether to enable JDBC repositories.# DATA LDAPspring.data.ldap.repositories.enabled=true # Whether to enable LDAP repositories.# MONGODB (MongoProperties)spring.data.mongodb.authentication-database= # Authentication database name.spring.data.mongodb.database= # Database name.spring.data.mongodb.field-naming-strategy= # Fully qualified name of the FieldNamingStrategy to use.spring.data.mongodb.grid-fs-database= # GridFS database name.spring.data.mongodb.host= # Mongo server host. Cannot be set with URI.spring.data.mongodb.password= # Login password of the mongo server. Cannot be set with URI.spring.data.mongodb.port= # Mongo server port. Cannot be set with URI.spring.data.mongodb.repositories.type=auto # Type of Mongo repositories to enable.spring.data.mongodb.uri=mongodb://localhost/test # Mongo database URI. Cannot be set with host, port and credentials.spring.data.mongodb.username= # Login user of the mongo server. Cannot be set with URI.# DATA REDISspring.data.redis.repositories.enabled=true # Whether to enable Redis repositories.# NEO4J (Neo4jProperties)spring.data.neo4j.auto-index=none # Auto index mode.spring.data.neo4j.embedded.enabled=true # Whether to enable embedded mode if the embedded driver is available.spring.data.neo4j.open-in-view=true # Register OpenSessionInViewInterceptor. Binds a Neo4j Session to the thread for the entire processing of the request.spring.data.neo4j.password= # Login password of the server.spring.data.neo4j.repositories.enabled=true # Whether to enable Neo4j repositories.spring.data.neo4j.uri= # URI used by the driver. Auto-detected by default.spring.data.neo4j.username= # Login user of the server.# DATA REST (RepositoryRestProperties)spring.data.rest.base-path= # Base path to be used by Spring Data REST to expose repository resources.spring.data.rest.default-media-type= # Content type to use as a default when none is specified.spring.data.rest.default-page-size= # Default size of pages.spring.data.rest.detection-strategy=default # Strategy to use to determine which repositories get exposed.spring.data.rest.enable-enum-translation= # Whether to enable enum value translation through the Spring Data REST default resource bundle.spring.data.rest.limit-param-name= # Name of the URL query string parameter that indicates how many results to return at once.spring.data.rest.max-page-size= # Maximum size of pages.spring.data.rest.page-param-name= # Name of the URL query string parameter that indicates what page to return.spring.data.rest.return-body-on-create= # Whether to return a response body after creating an entity.spring.data.rest.return-body-on-update= # Whether to return a response body after updating an entity.spring.data.rest.sort-param-name= # Name of the URL query string parameter that indicates what direction to sort results.# SOLR (SolrProperties)spring.data.solr.host=http://127.0.0.1:8983/solr # Solr host. Ignored if &quot;zk-host&quot; is set.spring.data.solr.repositories.enabled=true # Whether to enable Solr repositories.spring.data.solr.zk-host= # ZooKeeper host address in the form HOST:PORT.# DATA WEB (SpringDataWebProperties)spring.data.web.pageable.default-page-size=20 # Default page size.spring.data.web.pageable.max-page-size=2000 # Maximum page size to be accepted.spring.data.web.pageable.one-indexed-parameters=false # Whether to expose and assume 1-based page number indexes.spring.data.web.pageable.page-parameter=page # Page index parameter name.spring.data.web.pageable.prefix= # General prefix to be prepended to the page number and page size parameters.spring.data.web.pageable.qualifier-delimiter=_ # Delimiter to be used between the qualifier and the actual page number and size properties.spring.data.web.pageable.size-parameter=size # Page size parameter name.spring.data.web.sort.sort-parameter=sort # Sort parameter name.# DATASOURCE (DataSourceAutoConfiguration &amp; DataSourceProperties)spring.datasource.continue-on-error=false # Whether to stop if an error occurs while initializing the database.spring.datasource.data= # Data (DML) script resource references.spring.datasource.data-username= # Username of the database to execute DML scripts (if different).spring.datasource.data-password= # Password of the database to execute DML scripts (if different).spring.datasource.dbcp2.*= # Commons DBCP2 specific settingsspring.datasource.driver-class-name= # Fully qualified name of the JDBC driver. Auto-detected based on the URL by default.spring.datasource.generate-unique-name=false # Whether to generate a random datasource name.spring.datasource.hikari.*= # Hikari specific settingsspring.datasource.initialization-mode=embedded # Initialize the datasource with available DDL and DML scripts.spring.datasource.jmx-enabled=false # Whether to enable JMX support (if provided by the underlying pool).spring.datasource.jndi-name= # JNDI location of the datasource. Class, url, username &amp; password are ignored when set.spring.datasource.name= # Name of the datasource. Default to &quot;testdb&quot; when using an embedded database.spring.datasource.password= # Login password of the database.spring.datasource.platform=all # Platform to use in the DDL or DML scripts (such as schema-$&#123;platform&#125;.sql or data-$&#123;platform&#125;.sql).spring.datasource.schema= # Schema (DDL) script resource references.spring.datasource.schema-username= # Username of the database to execute DDL scripts (if different).spring.datasource.schema-password= # Password of the database to execute DDL scripts (if different).spring.datasource.separator=; # Statement separator in SQL initialization scripts.spring.datasource.sql-script-encoding= # SQL scripts encoding.spring.datasource.tomcat.*= # Tomcat datasource specific settingsspring.datasource.type= # Fully qualified name of the connection pool implementation to use. By default, it is auto-detected from the classpath.spring.datasource.url= # JDBC URL of the database.spring.datasource.username= # Login username of the database.spring.datasource.xa.data-source-class-name= # XA datasource fully qualified name.spring.datasource.xa.properties= # Properties to pass to the XA data source.# JEST (Elasticsearch HTTP client) (JestProperties)spring.elasticsearch.jest.connection-timeout=3s # Connection timeout.spring.elasticsearch.jest.multi-threaded=true # Whether to enable connection requests from multiple execution threads.spring.elasticsearch.jest.password= # Login password.spring.elasticsearch.jest.proxy.host= # Proxy host the HTTP client should use.spring.elasticsearch.jest.proxy.port= # Proxy port the HTTP client should use.spring.elasticsearch.jest.read-timeout=3s # Read timeout.spring.elasticsearch.jest.uris=http://localhost:9200 # Comma-separated list of the Elasticsearch instances to use.spring.elasticsearch.jest.username= # Login username.# Elasticsearch REST clients (RestClientProperties)spring.elasticsearch.rest.password= # Credentials password. spring.elasticsearch.rest.uris=http://localhost:9200 # Comma-separated list of the Elasticsearch instances to use. spring.elasticsearch.rest.username= # Credentials username.# H2 Web Console (H2ConsoleProperties)spring.h2.console.enabled=false # Whether to enable the console.spring.h2.console.path=/h2-console # Path at which the console is available.spring.h2.console.settings.trace=false # Whether to enable trace output.spring.h2.console.settings.web-allow-others=false # Whether to enable remote access.# InfluxDB (InfluxDbProperties)spring.influx.password= # Login password.spring.influx.url= # URL of the InfluxDB instance to which to connect.spring.influx.user= # Login user.# JOOQ (JooqProperties)spring.jooq.sql-dialect= # SQL dialect to use. Auto-detected by default.# JDBC (JdbcProperties)spring.jdbc.template.fetch-size=-1 # Number of rows that should be fetched from the database when more rows are needed.spring.jdbc.template.max-rows=-1 # Maximum number of rows.spring.jdbc.template.query-timeout= # Query timeout. Default is to use the JDBC driver&apos;s default configuration. If a duration suffix is not specified, seconds will be used.# JPA (JpaBaseConfiguration, HibernateJpaAutoConfiguration)spring.data.jpa.repositories.bootstrap-mode=default # Bootstrap mode for JPA repositories.spring.data.jpa.repositories.enabled=true # Whether to enable JPA repositories.spring.jpa.database= # Target database to operate on, auto-detected by default. Can be alternatively set using the &quot;databasePlatform&quot; property.spring.jpa.database-platform= # Name of the target database to operate on, auto-detected by default. Can be alternatively set using the &quot;Database&quot; enum.spring.jpa.generate-ddl=false # Whether to initialize the schema on startup.spring.jpa.hibernate.ddl-auto= # DDL mode. This is actually a shortcut for the &quot;hibernate.hbm2ddl.auto&quot; property. Defaults to &quot;create-drop&quot; when using an embedded database and no schema manager was detected. Otherwise, defaults to &quot;none&quot;.spring.jpa.hibernate.naming.implicit-strategy= # Fully qualified name of the implicit naming strategy.spring.jpa.hibernate.naming.physical-strategy= # Fully qualified name of the physical naming strategy.spring.jpa.hibernate.use-new-id-generator-mappings= # Whether to use Hibernate&apos;s newer IdentifierGenerator for AUTO, TABLE and SEQUENCE.spring.jpa.mapping-resources= # Mapping resources (equivalent to &quot;mapping-file&quot; entries in persistence.xml).spring.jpa.open-in-view=true # Register OpenEntityManagerInViewInterceptor. Binds a JPA EntityManager to the thread for the entire processing of the request.spring.jpa.properties.*= # Additional native properties to set on the JPA provider.spring.jpa.show-sql=false # Whether to enable logging of SQL statements.# JTA (JtaAutoConfiguration)spring.jta.enabled=true # Whether to enable JTA support.spring.jta.log-dir= # Transaction logs directory.spring.jta.transaction-manager-id= # Transaction manager unique identifier.# ATOMIKOS (AtomikosProperties)spring.jta.atomikos.connectionfactory.borrow-connection-timeout=30 # Timeout, in seconds, for borrowing connections from the pool.spring.jta.atomikos.connectionfactory.ignore-session-transacted-flag=true # Whether to ignore the transacted flag when creating session.spring.jta.atomikos.connectionfactory.local-transaction-mode=false # Whether local transactions are desired.spring.jta.atomikos.connectionfactory.maintenance-interval=60 # Time, in seconds, between runs of the pool&apos;s maintenance thread.spring.jta.atomikos.connectionfactory.max-idle-time=60 # Time, in seconds, after which connections are cleaned up from the pool.spring.jta.atomikos.connectionfactory.max-lifetime=0 # Time, in seconds, that a connection can be pooled for before being destroyed. 0 denotes no limit.spring.jta.atomikos.connectionfactory.max-pool-size=1 # Maximum size of the pool.spring.jta.atomikos.connectionfactory.min-pool-size=1 # Minimum size of the pool.spring.jta.atomikos.connectionfactory.reap-timeout=0 # Reap timeout, in seconds, for borrowed connections. 0 denotes no limit.spring.jta.atomikos.connectionfactory.unique-resource-name=jmsConnectionFactory # Unique name used to identify the resource during recovery.spring.jta.atomikos.connectionfactory.xa-connection-factory-class-name= # Vendor-specific implementation of XAConnectionFactory.spring.jta.atomikos.connectionfactory.xa-properties= # Vendor-specific XA properties.spring.jta.atomikos.datasource.borrow-connection-timeout=30 # Timeout, in seconds, for borrowing connections from the pool.spring.jta.atomikos.datasource.concurrent-connection-validation=true # Whether to use concurrent connection validation.spring.jta.atomikos.datasource.default-isolation-level= # Default isolation level of connections provided by the pool.spring.jta.atomikos.datasource.login-timeout=0 # Timeout, in seconds, for establishing a database connection.spring.jta.atomikos.datasource.maintenance-interval=60 # Time, in seconds, between runs of the pool&apos;s maintenance thread.spring.jta.atomikos.datasource.max-idle-time=60 # Time, in seconds, after which connections are cleaned up from the pool.spring.jta.atomikos.datasource.max-lifetime=0 # Time, in seconds, that a connection can be pooled for before being destroyed. 0 denotes no limit.spring.jta.atomikos.datasource.max-pool-size=1 # Maximum size of the pool.spring.jta.atomikos.datasource.min-pool-size=1 # Minimum size of the pool.spring.jta.atomikos.datasource.reap-timeout=0 # Reap timeout, in seconds, for borrowed connections. 0 denotes no limit.spring.jta.atomikos.datasource.test-query= # SQL query or statement used to validate a connection before returning it.spring.jta.atomikos.datasource.unique-resource-name=dataSource # Unique name used to identify the resource during recovery.spring.jta.atomikos.datasource.xa-data-source-class-name= # Vendor-specific implementation of XAConnectionFactory.spring.jta.atomikos.datasource.xa-properties= # Vendor-specific XA properties.spring.jta.atomikos.properties.allow-sub-transactions=true # Specify whether sub-transactions are allowed.spring.jta.atomikos.properties.checkpoint-interval=500 # Interval between checkpoints, expressed as the number of log writes between two checkpoints.spring.jta.atomikos.properties.default-jta-timeout=10000ms # Default timeout for JTA transactions.spring.jta.atomikos.properties.default-max-wait-time-on-shutdown=9223372036854775807 # How long should normal shutdown (no-force) wait for transactions to complete.spring.jta.atomikos.properties.enable-logging=true # Whether to enable disk logging.spring.jta.atomikos.properties.force-shutdown-on-vm-exit=false # Whether a VM shutdown should trigger forced shutdown of the transaction core.spring.jta.atomikos.properties.log-base-dir= # Directory in which the log files should be stored.spring.jta.atomikos.properties.log-base-name=tmlog # Transactions log file base name.spring.jta.atomikos.properties.max-actives=50 # Maximum number of active transactions.spring.jta.atomikos.properties.max-timeout=300000ms # Maximum timeout that can be allowed for transactions.spring.jta.atomikos.properties.recovery.delay=10000ms # Delay between two recovery scans.spring.jta.atomikos.properties.recovery.forget-orphaned-log-entries-delay=86400000ms # Delay after which recovery can cleanup pending (&apos;orphaned&apos;) log entries.spring.jta.atomikos.properties.recovery.max-retries=5 # Number of retry attempts to commit the transaction before throwing an exception.spring.jta.atomikos.properties.recovery.retry-interval=10000ms # Delay between retry attempts.spring.jta.atomikos.properties.serial-jta-transactions=true # Whether sub-transactions should be joined when possible.spring.jta.atomikos.properties.service= # Transaction manager implementation that should be started.spring.jta.atomikos.properties.threaded-two-phase-commit=false # Whether to use different (and concurrent) threads for two-phase commit on the participating resources.spring.jta.atomikos.properties.transaction-manager-unique-name= # The transaction manager&apos;s unique name.# BITRONIXspring.jta.bitronix.connectionfactory.acquire-increment=1 # Number of connections to create when growing the pool.spring.jta.bitronix.connectionfactory.acquisition-interval=1 # Time, in seconds, to wait before trying to acquire a connection again after an invalid connection was acquired.spring.jta.bitronix.connectionfactory.acquisition-timeout=30 # Timeout, in seconds, for acquiring connections from the pool.spring.jta.bitronix.connectionfactory.allow-local-transactions=false # Whether the transaction manager should allow mixing XA and non-XA transactions.spring.jta.bitronix.connectionfactory.apply-transaction-timeout=false # Whether the transaction timeout should be set on the XAResource when it is enlisted.spring.jta.bitronix.connectionfactory.automatic-enlisting-enabled=true # Whether resources should be enlisted and delisted automatically.spring.jta.bitronix.connectionfactory.cache-producers-consumers=true # Whether producers and consumers should be cached.spring.jta.bitronix.connectionfactory.class-name= # Underlying implementation class name of the XA resource.spring.jta.bitronix.connectionfactory.defer-connection-release=true # Whether the provider can run many transactions on the same connection and supports transaction interleaving.spring.jta.bitronix.connectionfactory.disabled=false # Whether this resource is disabled, meaning it&apos;s temporarily forbidden to acquire a connection from its pool.spring.jta.bitronix.connectionfactory.driver-properties= # Properties that should be set on the underlying implementation.spring.jta.bitronix.connectionfactory.ignore-recovery-failures=false # Whether recovery failures should be ignored.spring.jta.bitronix.connectionfactory.max-idle-time=60 # Time, in seconds, after which connections are cleaned up from the pool.spring.jta.bitronix.connectionfactory.max-pool-size=0 # Maximum size of the pool. 0 denotes no limit.spring.jta.bitronix.connectionfactory.min-pool-size=0 # Minimum size of the pool.spring.jta.bitronix.connectionfactory.password= # Password to use to connect to the JMS provider.spring.jta.bitronix.connectionfactory.share-transaction-connections=false # Whether connections in the ACCESSIBLE state can be shared within the context of a transaction.spring.jta.bitronix.connectionfactory.test-connections=false # Whether connections should be tested when acquired from the pool.spring.jta.bitronix.connectionfactory.two-pc-ordering-position=1 # Position that this resource should take during two-phase commit (always first is Integer.MIN_VALUE, always last is Integer.MAX_VALUE).spring.jta.bitronix.connectionfactory.unique-name=jmsConnectionFactory # Unique name used to identify the resource during recovery.spring.jta.bitronix.connectionfactory.use-tm-join=true # Whether TMJOIN should be used when starting XAResources.spring.jta.bitronix.connectionfactory.user= # User to use to connect to the JMS provider.spring.jta.bitronix.datasource.acquire-increment=1 # Number of connections to create when growing the pool.spring.jta.bitronix.datasource.acquisition-interval=1 # Time, in seconds, to wait before trying to acquire a connection again after an invalid connection was acquired.spring.jta.bitronix.datasource.acquisition-timeout=30 # Timeout, in seconds, for acquiring connections from the pool.spring.jta.bitronix.datasource.allow-local-transactions=false # Whether the transaction manager should allow mixing XA and non-XA transactions.spring.jta.bitronix.datasource.apply-transaction-timeout=false # Whether the transaction timeout should be set on the XAResource when it is enlisted.spring.jta.bitronix.datasource.automatic-enlisting-enabled=true # Whether resources should be enlisted and delisted automatically.spring.jta.bitronix.datasource.class-name= # Underlying implementation class name of the XA resource.spring.jta.bitronix.datasource.cursor-holdability= # Default cursor holdability for connections.spring.jta.bitronix.datasource.defer-connection-release=true # Whether the database can run many transactions on the same connection and supports transaction interleaving.spring.jta.bitronix.datasource.disabled=false # Whether this resource is disabled, meaning it&apos;s temporarily forbidden to acquire a connection from its pool.spring.jta.bitronix.datasource.driver-properties= # Properties that should be set on the underlying implementation.spring.jta.bitronix.datasource.enable-jdbc4-connection-test=false # Whether Connection.isValid() is called when acquiring a connection from the pool.spring.jta.bitronix.datasource.ignore-recovery-failures=false # Whether recovery failures should be ignored.spring.jta.bitronix.datasource.isolation-level= # Default isolation level for connections.spring.jta.bitronix.datasource.local-auto-commit= # Default auto-commit mode for local transactions.spring.jta.bitronix.datasource.login-timeout= # Timeout, in seconds, for establishing a database connection.spring.jta.bitronix.datasource.max-idle-time=60 # Time, in seconds, after which connections are cleaned up from the pool.spring.jta.bitronix.datasource.max-pool-size=0 # Maximum size of the pool. 0 denotes no limit.spring.jta.bitronix.datasource.min-pool-size=0 # Minimum size of the pool.spring.jta.bitronix.datasource.prepared-statement-cache-size=0 # Target size of the prepared statement cache. 0 disables the cache.spring.jta.bitronix.datasource.share-transaction-connections=false # Whether connections in the ACCESSIBLE state can be shared within the context of a transaction.spring.jta.bitronix.datasource.test-query= # SQL query or statement used to validate a connection before returning it.spring.jta.bitronix.datasource.two-pc-ordering-position=1 # Position that this resource should take during two-phase commit (always first is Integer.MIN_VALUE, and always last is Integer.MAX_VALUE).spring.jta.bitronix.datasource.unique-name=dataSource # Unique name used to identify the resource during recovery.spring.jta.bitronix.datasource.use-tm-join=true # Whether TMJOIN should be used when starting XAResources.spring.jta.bitronix.properties.allow-multiple-lrc=false # Whether to allow multiple LRC resources to be enlisted into the same transaction.spring.jta.bitronix.properties.asynchronous2-pc=false # Whether to enable asynchronously execution of two phase commit.spring.jta.bitronix.properties.background-recovery-interval-seconds=60 # Interval in seconds at which to run the recovery process in the background.spring.jta.bitronix.properties.current-node-only-recovery=true # Whether to recover only the current node.spring.jta.bitronix.properties.debug-zero-resource-transaction=false # Whether to log the creation and commit call stacks of transactions executed without a single enlisted resource.spring.jta.bitronix.properties.default-transaction-timeout=60 # Default transaction timeout, in seconds.spring.jta.bitronix.properties.disable-jmx=false # Whether to enable JMX support.spring.jta.bitronix.properties.exception-analyzer= # Set the fully qualified name of the exception analyzer implementation to use.spring.jta.bitronix.properties.filter-log-status=false # Whether to enable filtering of logs so that only mandatory logs are written.spring.jta.bitronix.properties.force-batching-enabled=true # Whether disk forces are batched.spring.jta.bitronix.properties.forced-write-enabled=true # Whether logs are forced to disk.spring.jta.bitronix.properties.graceful-shutdown-interval=60 # Maximum amount of seconds the TM waits for transactions to get done before aborting them at shutdown time.spring.jta.bitronix.properties.jndi-transaction-synchronization-registry-name= # JNDI name of the TransactionSynchronizationRegistry.spring.jta.bitronix.properties.jndi-user-transaction-name= # JNDI name of the UserTransaction.spring.jta.bitronix.properties.journal=disk # Name of the journal. Can be &apos;disk&apos;, &apos;null&apos;, or a class name.spring.jta.bitronix.properties.log-part1-filename=btm1.tlog # Name of the first fragment of the journal.spring.jta.bitronix.properties.log-part2-filename=btm2.tlog # Name of the second fragment of the journal.spring.jta.bitronix.properties.max-log-size-in-mb=2 # Maximum size in megabytes of the journal fragments.spring.jta.bitronix.properties.resource-configuration-filename= # ResourceLoader configuration file name.spring.jta.bitronix.properties.server-id= # ASCII ID that must uniquely identify this TM instance. Defaults to the machine&apos;s IP address.spring.jta.bitronix.properties.skip-corrupted-logs=false # Skip corrupted transactions log entries.spring.jta.bitronix.properties.warn-about-zero-resource-transaction=true # Whether to log a warning for transactions executed without a single enlisted resource.# EMBEDDED MONGODB (EmbeddedMongoProperties)spring.mongodb.embedded.features=sync_delay # Comma-separated list of features to enable.spring.mongodb.embedded.storage.database-dir= # Directory used for data storage.spring.mongodb.embedded.storage.oplog-size= # Maximum size of the oplog.spring.mongodb.embedded.storage.repl-set-name= # Name of the replica set.spring.mongodb.embedded.version=3.5.5 # Version of Mongo to use.# REDIS (RedisProperties)spring.redis.cluster.max-redirects= # Maximum number of redirects to follow when executing commands across the cluster.spring.redis.cluster.nodes= # Comma-separated list of &quot;host:port&quot; pairs to bootstrap from.spring.redis.database=0 # Database index used by the connection factory.spring.redis.url= # Connection URL. Overrides host, port, and password. User is ignored. Example: redis://user:password@example.com:6379spring.redis.host=localhost # Redis server host.spring.redis.jedis.pool.max-active=8 # Maximum number of connections that can be allocated by the pool at a given time. Use a negative value for no limit.spring.redis.jedis.pool.max-idle=8 # Maximum number of &quot;idle&quot; connections in the pool. Use a negative value to indicate an unlimited number of idle connections.spring.redis.jedis.pool.max-wait=-1ms # Maximum amount of time a connection allocation should block before throwing an exception when the pool is exhausted. Use a negative value to block indefinitely.spring.redis.jedis.pool.min-idle=0 # Target for the minimum number of idle connections to maintain in the pool. This setting only has an effect if it is positive.spring.redis.lettuce.pool.max-active=8 # Maximum number of connections that can be allocated by the pool at a given time. Use a negative value for no limit.spring.redis.lettuce.pool.max-idle=8 # Maximum number of &quot;idle&quot; connections in the pool. Use a negative value to indicate an unlimited number of idle connections.spring.redis.lettuce.pool.max-wait=-1ms # Maximum amount of time a connection allocation should block before throwing an exception when the pool is exhausted. Use a negative value to block indefinitely.spring.redis.lettuce.pool.min-idle=0 # Target for the minimum number of idle connections to maintain in the pool. This setting only has an effect if it is positive.spring.redis.lettuce.shutdown-timeout=100ms # Shutdown timeout.spring.redis.password= # Login password of the redis server.spring.redis.port=6379 # Redis server port.spring.redis.sentinel.master= # Name of the Redis server.spring.redis.sentinel.nodes= # Comma-separated list of &quot;host:port&quot; pairs.spring.redis.ssl=false # Whether to enable SSL support.spring.redis.timeout= # Connection timeout.# TRANSACTION (TransactionProperties)spring.transaction.default-timeout= # Default transaction timeout. If a duration suffix is not specified, seconds will be used.spring.transaction.rollback-on-commit-failure= # Whether to roll back on commit failures.# ----------------------------------------# INTEGRATION PROPERTIES# ----------------------------------------# ACTIVEMQ (ActiveMQProperties)spring.activemq.broker-url= # URL of the ActiveMQ broker. Auto-generated by default.spring.activemq.close-timeout=15s # Time to wait before considering a close complete.spring.activemq.in-memory=true # Whether the default broker URL should be in memory. Ignored if an explicit broker has been specified.spring.activemq.non-blocking-redelivery=false # Whether to stop message delivery before re-delivering messages from a rolled back transaction. This implies that message order is not preserved when this is enabled.spring.activemq.password= # Login password of the broker.spring.activemq.send-timeout=0ms # Time to wait on message sends for a response. Set it to 0 to wait forever.spring.activemq.user= # Login user of the broker.spring.activemq.packages.trust-all= # Whether to trust all packages.spring.activemq.packages.trusted= # Comma-separated list of specific packages to trust (when not trusting all packages).spring.activemq.pool.block-if-full=true # Whether to block when a connection is requested and the pool is full. Set it to false to throw a &quot;JMSException&quot; instead.spring.activemq.pool.block-if-full-timeout=-1ms # Blocking period before throwing an exception if the pool is still full.spring.activemq.pool.enabled=false # Whether a JmsPoolConnectionFactory should be created, instead of a regular ConnectionFactory.spring.activemq.pool.idle-timeout=30s # Connection idle timeout.spring.activemq.pool.max-connections=1 # Maximum number of pooled connections.spring.activemq.pool.max-sessions-per-connection=500 # Maximum number of pooled sessions per connection in the pool.spring.activemq.pool.time-between-expiration-check=-1ms # Time to sleep between runs of the idle connection eviction thread. When negative, no idle connection eviction thread runs.spring.activemq.pool.use-anonymous-producers=true # Whether to use only one anonymous &quot;MessageProducer&quot; instance. Set it to false to create one &quot;MessageProducer&quot; every time one is required.# ARTEMIS (ArtemisProperties)spring.artemis.embedded.cluster-password= # Cluster password. Randomly generated on startup by default.spring.artemis.embedded.data-directory= # Journal file directory. Not necessary if persistence is turned off.spring.artemis.embedded.enabled=true # Whether to enable embedded mode if the Artemis server APIs are available.spring.artemis.embedded.persistent=false # Whether to enable persistent store.spring.artemis.embedded.queues= # Comma-separated list of queues to create on startup.spring.artemis.embedded.server-id= # Server ID. By default, an auto-incremented counter is used.spring.artemis.embedded.topics= # Comma-separated list of topics to create on startup.spring.artemis.host=localhost # Artemis broker host.spring.artemis.mode= # Artemis deployment mode, auto-detected by default.spring.artemis.password= # Login password of the broker.spring.artemis.pool.block-if-full=true # Whether to block when a connection is requested and the pool is full. Set it to false to throw a &quot;JMSException&quot; instead.spring.artemis.pool.block-if-full-timeout=-1ms # Blocking period before throwing an exception if the pool is still full.spring.artemis.pool.enabled=false # Whether a JmsPoolConnectionFactory should be created, instead of a regular ConnectionFactory.spring.artemis.pool.idle-timeout=30s # Connection idle timeout.spring.artemis.pool.max-connections=1 # Maximum number of pooled connections.spring.artemis.pool.max-sessions-per-connection=500 # Maximum number of pooled sessions per connection in the pool.spring.artemis.pool.time-between-expiration-check=-1ms # Time to sleep between runs of the idle connection eviction thread. When negative, no idle connection eviction thread runs.spring.artemis.pool.use-anonymous-producers=true # Whether to use only one anonymous &quot;MessageProducer&quot; instance. Set it to false to create one &quot;MessageProducer&quot; every time one is required.spring.artemis.port=61616 # Artemis broker port.spring.artemis.user= # Login user of the broker.# SPRING BATCH (BatchProperties)spring.batch.initialize-schema=embedded # Database schema initialization mode.spring.batch.job.enabled=true # Execute all Spring Batch jobs in the context on startup.spring.batch.job.names= # Comma-separated list of job names to execute on startup (for instance, `job1,job2`). By default, all Jobs found in the context are executed.spring.batch.schema=classpath:org/springframework/batch/core/schema-@@platform@@.sql # Path to the SQL file to use to initialize the database schema.spring.batch.table-prefix= # Table prefix for all the batch meta-data tables.# SPRING INTEGRATION (IntegrationProperties)spring.integration.jdbc.initialize-schema=embedded # Database schema initialization mode.spring.integration.jdbc.schema=classpath:org/springframework/integration/jdbc/schema-@@platform@@.sql # Path to the SQL file to use to initialize the database schema.# JMS (JmsProperties)spring.jms.cache.consumers=false # Whether to cache message consumers.spring.jms.cache.enabled=true # Whether to cache sessions.spring.jms.cache.producers=true # Whether to cache message producers.spring.jms.cache.session-cache-size=1 # Size of the session cache (per JMS Session type).spring.jms.jndi-name= # Connection factory JNDI name. When set, takes precedence to others connection factory auto-configurations.spring.jms.listener.acknowledge-mode= # Acknowledge mode of the container. By default, the listener is transacted with automatic acknowledgment.spring.jms.listener.auto-startup=true # Start the container automatically on startup.spring.jms.listener.concurrency= # Minimum number of concurrent consumers.spring.jms.listener.max-concurrency= # Maximum number of concurrent consumers.spring.jms.pub-sub-domain=false # Whether the default destination type is topic.spring.jms.template.default-destination= # Default destination to use on send and receive operations that do not have a destination parameter.spring.jms.template.delivery-delay= # Delivery delay to use for send calls.spring.jms.template.delivery-mode= # Delivery mode. Enables QoS (Quality of Service) when set.spring.jms.template.priority= # Priority of a message when sending. Enables QoS (Quality of Service) when set.spring.jms.template.qos-enabled= # Whether to enable explicit QoS (Quality of Service) when sending a message.spring.jms.template.receive-timeout= # Timeout to use for receive calls.spring.jms.template.time-to-live= # Time-to-live of a message when sending. Enables QoS (Quality of Service) when set.# APACHE KAFKA (KafkaProperties)spring.kafka.admin.client-id= # ID to pass to the server when making requests. Used for server-side logging.spring.kafka.admin.fail-fast=false # Whether to fail fast if the broker is not available on startup.spring.kafka.admin.properties.*= # Additional admin-specific properties used to configure the client.spring.kafka.admin.ssl.key-password= # Password of the private key in the key store file.spring.kafka.admin.ssl.key-store-location= # Location of the key store file.spring.kafka.admin.ssl.key-store-password= # Store password for the key store file.spring.kafka.admin.ssl.key-store-type= # Type of the key store.spring.kafka.admin.ssl.protocol= # SSL protocol to use.spring.kafka.admin.ssl.trust-store-location= # Location of the trust store file.spring.kafka.admin.ssl.trust-store-password= # Store password for the trust store file.spring.kafka.admin.ssl.trust-store-type= # Type of the trust store.spring.kafka.bootstrap-servers= # Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Applies to all components unless overridden.spring.kafka.client-id= # ID to pass to the server when making requests. Used for server-side logging.spring.kafka.consumer.auto-commit-interval= # Frequency with which the consumer offsets are auto-committed to Kafka if &apos;enable.auto.commit&apos; is set to true.spring.kafka.consumer.auto-offset-reset= # What to do when there is no initial offset in Kafka or if the current offset no longer exists on the server.spring.kafka.consumer.bootstrap-servers= # Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for consumers.spring.kafka.consumer.client-id= # ID to pass to the server when making requests. Used for server-side logging.spring.kafka.consumer.enable-auto-commit= # Whether the consumer&apos;s offset is periodically committed in the background.spring.kafka.consumer.fetch-max-wait= # Maximum amount of time the server blocks before answering the fetch request if there isn&apos;t sufficient data to immediately satisfy the requirement given by &quot;fetch-min-size&quot;.spring.kafka.consumer.fetch-min-size= # Minimum amount of data the server should return for a fetch request.spring.kafka.consumer.group-id= # Unique string that identifies the consumer group to which this consumer belongs.spring.kafka.consumer.heartbeat-interval= # Expected time between heartbeats to the consumer coordinator.spring.kafka.consumer.key-deserializer= # Deserializer class for keys.spring.kafka.consumer.max-poll-records= # Maximum number of records returned in a single call to poll().spring.kafka.consumer.properties.*= # Additional consumer-specific properties used to configure the client.spring.kafka.consumer.ssl.key-password= # Password of the private key in the key store file.spring.kafka.consumer.ssl.key-store-location= # Location of the key store file.spring.kafka.consumer.ssl.key-store-password= # Store password for the key store file.spring.kafka.consumer.ssl.key-store-type= # Type of the key store.spring.kafka.consumer.ssl.protocol= # SSL protocol to use.spring.kafka.consumer.ssl.trust-store-location= # Location of the trust store file.spring.kafka.consumer.ssl.trust-store-password= # Store password for the trust store file.spring.kafka.consumer.ssl.trust-store-type= # Type of the trust store.spring.kafka.consumer.value-deserializer= # Deserializer class for values.spring.kafka.jaas.control-flag=required # Control flag for login configuration.spring.kafka.jaas.enabled=false # Whether to enable JAAS configuration.spring.kafka.jaas.login-module=com.sun.security.auth.module.Krb5LoginModule # Login module.spring.kafka.jaas.options= # Additional JAAS options.spring.kafka.listener.ack-count= # Number of records between offset commits when ackMode is &quot;COUNT&quot; or &quot;COUNT_TIME&quot;.spring.kafka.listener.ack-mode= # Listener AckMode. See the spring-kafka documentation.spring.kafka.listener.ack-time= # Time between offset commits when ackMode is &quot;TIME&quot; or &quot;COUNT_TIME&quot;.spring.kafka.listener.client-id= # Prefix for the listener&apos;s consumer client.id property.spring.kafka.listener.concurrency= # Number of threads to run in the listener containers.spring.kafka.listener.idle-event-interval= # Time between publishing idle consumer events (no data received).spring.kafka.listener.log-container-config= # Whether to log the container configuration during initialization (INFO level).spring.kafka.listener.monitor-interval= # Time between checks for non-responsive consumers. If a duration suffix is not specified, seconds will be used.spring.kafka.listener.no-poll-threshold= # Multiplier applied to &quot;pollTimeout&quot; to determine if a consumer is non-responsive.spring.kafka.listener.poll-timeout= # Timeout to use when polling the consumer.spring.kafka.listener.type=single # Listener type.spring.kafka.producer.acks= # Number of acknowledgments the producer requires the leader to have received before considering a request complete.spring.kafka.producer.batch-size= # Default batch size.spring.kafka.producer.bootstrap-servers= # Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for producers.spring.kafka.producer.buffer-memory= # Total memory size the producer can use to buffer records waiting to be sent to the server.spring.kafka.producer.client-id= # ID to pass to the server when making requests. Used for server-side logging.spring.kafka.producer.compression-type= # Compression type for all data generated by the producer.spring.kafka.producer.key-serializer= # Serializer class for keys.spring.kafka.producer.properties.*= # Additional producer-specific properties used to configure the client.spring.kafka.producer.retries= # When greater than zero, enables retrying of failed sends.spring.kafka.producer.ssl.key-password= # Password of the private key in the key store file.spring.kafka.producer.ssl.key-store-location= # Location of the key store file.spring.kafka.producer.ssl.key-store-password= # Store password for the key store file.spring.kafka.producer.ssl.key-store-type= # Type of the key store.spring.kafka.producer.ssl.protocol= # SSL protocol to use.spring.kafka.producer.ssl.trust-store-location= # Location of the trust store file.spring.kafka.producer.ssl.trust-store-password= # Store password for the trust store file.spring.kafka.producer.ssl.trust-store-type= # Type of the trust store.spring.kafka.producer.transaction-id-prefix= # When non empty, enables transaction support for producer.spring.kafka.producer.value-serializer= # Serializer class for values.spring.kafka.properties.*= # Additional properties, common to producers and consumers, used to configure the client.spring.kafka.ssl.key-password= # Password of the private key in the key store file.spring.kafka.ssl.key-store-location= # Location of the key store file.spring.kafka.ssl.key-store-password= # Store password for the key store file.spring.kafka.ssl.key-store-type= # Type of the key store.spring.kafka.ssl.protocol= # SSL protocol to use.spring.kafka.ssl.trust-store-location= # Location of the trust store file.spring.kafka.ssl.trust-store-password= # Store password for the trust store file.spring.kafka.ssl.trust-store-type= # Type of the trust store.spring.kafka.streams.application-id= # Kafka streams application.id property; default spring.application.name.spring.kafka.streams.auto-startup=true # Whether or not to auto-start the streams factory bean.spring.kafka.streams.bootstrap-servers= # Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for streams.spring.kafka.streams.cache-max-size-buffering= # Maximum memory size to be used for buffering across all threads.spring.kafka.streams.client-id= # ID to pass to the server when making requests. Used for server-side logging.spring.kafka.streams.properties.*= # Additional Kafka properties used to configure the streams.spring.kafka.streams.replication-factor= # The replication factor for change log topics and repartition topics created by the stream processing application.spring.kafka.streams.ssl.key-password= # Password of the private key in the key store file.spring.kafka.streams.ssl.key-store-location= # Location of the key store file.spring.kafka.streams.ssl.key-store-password= # Store password for the key store file.spring.kafka.streams.ssl.key-store-type= # Type of the key store.spring.kafka.streams.ssl.protocol= # SSL protocol to use.spring.kafka.streams.ssl.trust-store-location= # Location of the trust store file.spring.kafka.streams.ssl.trust-store-password= # Store password for the trust store file.spring.kafka.streams.ssl.trust-store-type= # Type of the trust store.spring.kafka.streams.state-dir= # Directory location for the state store.spring.kafka.template.default-topic= # Default topic to which messages are sent.# RABBIT (RabbitProperties)spring.rabbitmq.addresses= # Comma-separated list of addresses to which the client should connect.spring.rabbitmq.cache.channel.checkout-timeout= # Duration to wait to obtain a channel if the cache size has been reached.spring.rabbitmq.cache.channel.size= # Number of channels to retain in the cache.spring.rabbitmq.cache.connection.mode=channel # Connection factory cache mode.spring.rabbitmq.cache.connection.size= # Number of connections to cache.spring.rabbitmq.connection-timeout= # Connection timeout. Set it to zero to wait forever.spring.rabbitmq.dynamic=true # Whether to create an AmqpAdmin bean.spring.rabbitmq.host=localhost # RabbitMQ host.spring.rabbitmq.listener.direct.acknowledge-mode= # Acknowledge mode of container.spring.rabbitmq.listener.direct.auto-startup=true # Whether to start the container automatically on startup.spring.rabbitmq.listener.direct.consumers-per-queue= # Number of consumers per queue.spring.rabbitmq.listener.direct.default-requeue-rejected= # Whether rejected deliveries are re-queued by default.spring.rabbitmq.listener.direct.idle-event-interval= # How often idle container events should be published.spring.rabbitmq.listener.direct.missing-queues-fatal=false # Whether to fail if the queues declared by the container are not available on the broker.spring.rabbitmq.listener.direct.prefetch= # Maximum number of unacknowledged messages that can be outstanding at each consumer.spring.rabbitmq.listener.direct.retry.enabled=false # Whether publishing retries are enabled.spring.rabbitmq.listener.direct.retry.initial-interval=1000ms # Duration between the first and second attempt to deliver a message.spring.rabbitmq.listener.direct.retry.max-attempts=3 # Maximum number of attempts to deliver a message.spring.rabbitmq.listener.direct.retry.max-interval=10000ms # Maximum duration between attempts.spring.rabbitmq.listener.direct.retry.multiplier=1 # Multiplier to apply to the previous retry interval.spring.rabbitmq.listener.direct.retry.stateless=true # Whether retries are stateless or stateful.spring.rabbitmq.listener.simple.acknowledge-mode= # Acknowledge mode of container.spring.rabbitmq.listener.simple.auto-startup=true # Whether to start the container automatically on startup.spring.rabbitmq.listener.simple.concurrency= # Minimum number of listener invoker threads.spring.rabbitmq.listener.simple.default-requeue-rejected= # Whether rejected deliveries are re-queued by default.spring.rabbitmq.listener.simple.idle-event-interval= # How often idle container events should be published.spring.rabbitmq.listener.simple.max-concurrency= # Maximum number of listener invoker threads.spring.rabbitmq.listener.simple.missing-queues-fatal=true # Whether to fail if the queues declared by the container are not available on the broker and/or whether to stop the container if one or more queues are deleted at runtime.spring.rabbitmq.listener.simple.prefetch= # Maximum number of unacknowledged messages that can be outstanding at each consumer.spring.rabbitmq.listener.simple.retry.enabled=false # Whether publishing retries are enabled.spring.rabbitmq.listener.simple.retry.initial-interval=1000ms # Duration between the first and second attempt to deliver a message.spring.rabbitmq.listener.simple.retry.max-attempts=3 # Maximum number of attempts to deliver a message.spring.rabbitmq.listener.simple.retry.max-interval=10000ms # Maximum duration between attempts.spring.rabbitmq.listener.simple.retry.multiplier=1 # Multiplier to apply to the previous retry interval.spring.rabbitmq.listener.simple.retry.stateless=true # Whether retries are stateless or stateful.spring.rabbitmq.listener.simple.transaction-size= # Number of messages to be processed between acks when the acknowledge mode is AUTO. If larger than prefetch, prefetch will be increased to this value.spring.rabbitmq.listener.type=simple # Listener container type.spring.rabbitmq.password=guest # Login to authenticate against the broker.spring.rabbitmq.port=5672 # RabbitMQ port.spring.rabbitmq.publisher-confirms=false # Whether to enable publisher confirms.spring.rabbitmq.publisher-returns=false # Whether to enable publisher returns.spring.rabbitmq.requested-heartbeat= # Requested heartbeat timeout; zero for none. If a duration suffix is not specified, seconds will be used.spring.rabbitmq.ssl.algorithm= # SSL algorithm to use. By default, configured by the Rabbit client library.spring.rabbitmq.ssl.enabled=false # Whether to enable SSL support.spring.rabbitmq.ssl.key-store= # Path to the key store that holds the SSL certificate.spring.rabbitmq.ssl.key-store-password= # Password used to access the key store.spring.rabbitmq.ssl.key-store-type=PKCS12 # Key store type.spring.rabbitmq.ssl.trust-store= # Trust store that holds SSL certificates.spring.rabbitmq.ssl.trust-store-password= # Password used to access the trust store.spring.rabbitmq.ssl.trust-store-type=JKS # Trust store type.spring.rabbitmq.ssl.validate-server-certificate=true # Whether to enable server side certificate validation.spring.rabbitmq.ssl.verify-hostname=true # Whether to enable hostname verification.spring.rabbitmq.template.default-receive-queue= # Name of the default queue to receive messages from when none is specified explicitly.spring.rabbitmq.template.exchange= # Name of the default exchange to use for send operations.spring.rabbitmq.template.mandatory= # Whether to enable mandatory messages.spring.rabbitmq.template.receive-timeout= # Timeout for `receive()` operations.spring.rabbitmq.template.reply-timeout= # Timeout for `sendAndReceive()` operations.spring.rabbitmq.template.retry.enabled=false # Whether publishing retries are enabled.spring.rabbitmq.template.retry.initial-interval=1000ms # Duration between the first and second attempt to deliver a message.spring.rabbitmq.template.retry.max-attempts=3 # Maximum number of attempts to deliver a message.spring.rabbitmq.template.retry.max-interval=10000ms # Maximum duration between attempts.spring.rabbitmq.template.retry.multiplier=1 # Multiplier to apply to the previous retry interval.spring.rabbitmq.template.routing-key= # Value of a default routing key to use for send operations.spring.rabbitmq.username=guest # Login user to authenticate to the broker.spring.rabbitmq.virtual-host= # Virtual host to use when connecting to the broker.# ----------------------------------------# ACTUATOR PROPERTIES# ----------------------------------------# MANAGEMENT HTTP SERVER (ManagementServerProperties)management.server.add-application-context-header=false # Add the &quot;X-Application-Context&quot; HTTP header in each response.management.server.address= # Network address to which the management endpoints should bind. Requires a custom management.server.port.management.server.port= # Management endpoint HTTP port (uses the same port as the application by default). Configure a different port to use management-specific SSL.management.server.servlet.context-path= # Management endpoint context-path (for instance, `/management`). Requires a custom management.server.port.management.server.ssl.ciphers= # Supported SSL ciphers.management.server.ssl.client-auth= # Client authentication mode.management.server.ssl.enabled=true # Whether to enable SSL support.management.server.ssl.enabled-protocols= # Enabled SSL protocols.management.server.ssl.key-alias= # Alias that identifies the key in the key store.management.server.ssl.key-password= # Password used to access the key in the key store.management.server.ssl.key-store= # Path to the key store that holds the SSL certificate (typically a jks file).management.server.ssl.key-store-password= # Password used to access the key store.management.server.ssl.key-store-provider= # Provider for the key store.management.server.ssl.key-store-type= # Type of the key store.management.server.ssl.protocol=TLS # SSL protocol to use.management.server.ssl.trust-store= # Trust store that holds SSL certificates.management.server.ssl.trust-store-password= # Password used to access the trust store.management.server.ssl.trust-store-provider= # Provider for the trust store.management.server.ssl.trust-store-type= # Type of the trust store.# CLOUDFOUNDRYmanagement.cloudfoundry.enabled=true # Whether to enable extended Cloud Foundry actuator endpoints.management.cloudfoundry.skip-ssl-validation=false # Whether to skip SSL verification for Cloud Foundry actuator endpoint security calls.# ENDPOINTS GENERAL CONFIGURATIONmanagement.endpoints.enabled-by-default= # Whether to enable or disable all endpoints by default.# ENDPOINTS JMX CONFIGURATION (JmxEndpointProperties)management.endpoints.jmx.domain=org.springframework.boot # Endpoints JMX domain name. Fallback to &apos;spring.jmx.default-domain&apos; if set.management.endpoints.jmx.exposure.include=* # Endpoint IDs that should be included or &apos;*&apos; for all.management.endpoints.jmx.exposure.exclude= # Endpoint IDs that should be excluded or &apos;*&apos; for all.management.endpoints.jmx.static-names= # Additional static properties to append to all ObjectNames of MBeans representing Endpoints.# ENDPOINTS WEB CONFIGURATION (WebEndpointProperties)management.endpoints.web.exposure.include=health,info # Endpoint IDs that should be included or &apos;*&apos; for all.management.endpoints.web.exposure.exclude= # Endpoint IDs that should be excluded or &apos;*&apos; for all.management.endpoints.web.base-path=/actuator # Base path for Web endpoints. Relative to server.servlet.context-path or management.server.servlet.context-path if management.server.port is configured.management.endpoints.web.path-mapping= # Mapping between endpoint IDs and the path that should expose them.# ENDPOINTS CORS CONFIGURATION (CorsEndpointProperties)management.endpoints.web.cors.allow-credentials= # Whether credentials are supported. When not set, credentials are not supported.management.endpoints.web.cors.allowed-headers= # Comma-separated list of headers to allow in a request. &apos;*&apos; allows all headers.management.endpoints.web.cors.allowed-methods= # Comma-separated list of methods to allow. &apos;*&apos; allows all methods. When not set, defaults to GET.management.endpoints.web.cors.allowed-origins= # Comma-separated list of origins to allow. &apos;*&apos; allows all origins. When not set, CORS support is disabled.management.endpoints.web.cors.exposed-headers= # Comma-separated list of headers to include in a response.management.endpoints.web.cors.max-age=1800s # How long the response from a pre-flight request can be cached by clients. If a duration suffix is not specified, seconds will be used.# AUDIT EVENTS ENDPOINT (AuditEventsEndpoint)management.endpoint.auditevents.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.auditevents.enabled=true # Whether to enable the auditevents endpoint.# BEANS ENDPOINT (BeansEndpoint)management.endpoint.beans.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.beans.enabled=true # Whether to enable the beans endpoint.# CACHES ENDPOINT (CachesEndpoint)management.endpoint.caches.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.caches.enabled=true # Whether to enable the caches endpoint.# CONDITIONS REPORT ENDPOINT (ConditionsReportEndpoint)management.endpoint.conditions.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.conditions.enabled=true # Whether to enable the conditions endpoint.# CONFIGURATION PROPERTIES REPORT ENDPOINT (ConfigurationPropertiesReportEndpoint, ConfigurationPropertiesReportEndpointProperties)management.endpoint.configprops.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.configprops.enabled=true # Whether to enable the configprops endpoint.management.endpoint.configprops.keys-to-sanitize=password,secret,key,token,.*credentials.*,vcap_services,sun.java.command # Keys that should be sanitized. Keys can be simple strings that the property ends with or regular expressions.# ENVIRONMENT ENDPOINT (EnvironmentEndpoint, EnvironmentEndpointProperties)management.endpoint.env.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.env.enabled=true # Whether to enable the env endpoint.management.endpoint.env.keys-to-sanitize=password,secret,key,token,.*credentials.*,vcap_services,sun.java.command # Keys that should be sanitized. Keys can be simple strings that the property ends with or regular expressions.# FLYWAY ENDPOINT (FlywayEndpoint)management.endpoint.flyway.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.flyway.enabled=true # Whether to enable the flyway endpoint.# HEALTH ENDPOINT (HealthEndpoint, HealthEndpointProperties)management.endpoint.health.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.health.enabled=true # Whether to enable the health endpoint.management.endpoint.health.roles= # Roles used to determine whether or not a user is authorized to be shown details. When empty, all authenticated users are authorized.management.endpoint.health.show-details=never # When to show full health details.# HEAP DUMP ENDPOINT (HeapDumpWebEndpoint)management.endpoint.heapdump.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.heapdump.enabled=true # Whether to enable the heapdump endpoint.# HTTP TRACE ENDPOINT (HttpTraceEndpoint)management.endpoint.httptrace.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.httptrace.enabled=true # Whether to enable the httptrace endpoint.# INFO ENDPOINT (InfoEndpoint)info= # Arbitrary properties to add to the info endpoint.management.endpoint.info.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.info.enabled=true # Whether to enable the info endpoint.# INTEGRATION GRAPH ENDPOINT (IntegrationGraphEndpoint)management.endpoint.integrationgraph.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.integrationgraph.enabled=true # Whether to enable the integrationgraph endpoint.# JOLOKIA ENDPOINT (JolokiaProperties)management.endpoint.jolokia.config.*= # Jolokia settings. Refer to the documentation of Jolokia for more details.management.endpoint.jolokia.enabled=true # Whether to enable the jolokia endpoint.# LIQUIBASE ENDPOINT (LiquibaseEndpoint)management.endpoint.liquibase.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.liquibase.enabled=true # Whether to enable the liquibase endpoint.# LOG FILE ENDPOINT (LogFileWebEndpoint, LogFileWebEndpointProperties)management.endpoint.logfile.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.logfile.enabled=true # Whether to enable the logfile endpoint.management.endpoint.logfile.external-file= # External Logfile to be accessed. Can be used if the logfile is written by output redirect and not by the logging system itself.# LOGGERS ENDPOINT (LoggersEndpoint)management.endpoint.loggers.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.loggers.enabled=true # Whether to enable the loggers endpoint.# REQUEST MAPPING ENDPOINT (MappingsEndpoint)management.endpoint.mappings.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.mappings.enabled=true # Whether to enable the mappings endpoint.# METRICS ENDPOINT (MetricsEndpoint)management.endpoint.metrics.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.metrics.enabled=true # Whether to enable the metrics endpoint.# PROMETHEUS ENDPOINT (PrometheusScrapeEndpoint)management.endpoint.prometheus.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.prometheus.enabled=true # Whether to enable the prometheus endpoint.# SCHEDULED TASKS ENDPOINT (ScheduledTasksEndpoint)management.endpoint.scheduledtasks.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.scheduledtasks.enabled=true # Whether to enable the scheduledtasks endpoint.# SESSIONS ENDPOINT (SessionsEndpoint)management.endpoint.sessions.enabled=true # Whether to enable the sessions endpoint.# SHUTDOWN ENDPOINT (ShutdownEndpoint)management.endpoint.shutdown.enabled=false # Whether to enable the shutdown endpoint.# THREAD DUMP ENDPOINT (ThreadDumpEndpoint)management.endpoint.threaddump.cache.time-to-live=0ms # Maximum time that a response can be cached.management.endpoint.threaddump.enabled=true # Whether to enable the threaddump endpoint.# HEALTH INDICATORSmanagement.health.db.enabled=true # Whether to enable database health check.management.health.cassandra.enabled=true # Whether to enable Cassandra health check.management.health.couchbase.enabled=true # Whether to enable Couchbase health check.management.health.defaults.enabled=true # Whether to enable default health indicators.management.health.diskspace.enabled=true # Whether to enable disk space health check.management.health.diskspace.path= # Path used to compute the available disk space.management.health.diskspace.threshold=10MB # Minimum disk space that should be available.management.health.elasticsearch.enabled=true # Whether to enable Elasticsearch health check.management.health.elasticsearch.indices= # Comma-separated index names.management.health.elasticsearch.response-timeout=100ms # Time to wait for a response from the cluster.management.health.influxdb.enabled=true # Whether to enable InfluxDB health check.management.health.jms.enabled=true # Whether to enable JMS health check.management.health.ldap.enabled=true # Whether to enable LDAP health check.management.health.mail.enabled=true # Whether to enable Mail health check.management.health.mongo.enabled=true # Whether to enable MongoDB health check.management.health.neo4j.enabled=true # Whether to enable Neo4j health check.management.health.rabbit.enabled=true # Whether to enable RabbitMQ health check.management.health.redis.enabled=true # Whether to enable Redis health check.management.health.solr.enabled=true # Whether to enable Solr health check.management.health.status.http-mapping= # Mapping of health statuses to HTTP status codes. By default, registered health statuses map to sensible defaults (for example, UP maps to 200).management.health.status.order=DOWN,OUT_OF_SERVICE,UP,UNKNOWN # Comma-separated list of health statuses in order of severity.# HTTP TRACING (HttpTraceProperties)management.trace.http.enabled=true # Whether to enable HTTP request-response tracing.management.trace.http.include=request-headers,response-headers,cookies,errors # Items to be included in the trace.# INFO CONTRIBUTORS (InfoContributorProperties)management.info.build.enabled=true # Whether to enable build info.management.info.defaults.enabled=true # Whether to enable default info contributors.management.info.env.enabled=true # Whether to enable environment info.management.info.git.enabled=true # Whether to enable git info.management.info.git.mode=simple # Mode to use to expose git information.# METRICSmanagement.metrics.distribution.maximum-expected-value.*= # Maximum value that meter IDs starting-with the specified name are expected to observe.management.metrics.distribution.minimum-expected-value.*= # Minimum value that meter IDs starting-with the specified name are expected to observe.management.metrics.distribution.percentiles.*= # Specific computed non-aggregable percentiles to ship to the backend for meter IDs starting-with the specified name.management.metrics.distribution.percentiles-histogram.*= # Whether meter IDs starting with the specified name should publish percentile histograms.management.metrics.distribution.sla.*= # Specific SLA boundaries for meter IDs starting-with the specified name. The longest match wins.management.metrics.enable.*= # Whether meter IDs starting-with the specified name should be enabled. The longest match wins, the key `all` can also be used to configure all meters.management.metrics.export.appoptics.api-token= # AppOptics API token.management.metrics.export.appoptics.batch-size=500 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.appoptics.connect-timeout=5s # Connection timeout for requests to this backend.management.metrics.export.appoptics.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.appoptics.host-tag=instance # Tag that will be mapped to &quot;@host&quot; when shipping metrics to AppOptics.management.metrics.export.appoptics.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.appoptics.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.appoptics.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.appoptics.uri=https://api.appoptics.com/v1/measurements # URI to ship metrics to.management.metrics.export.atlas.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.atlas.config-refresh-frequency=10s # Frequency for refreshing config settings from the LWC service.management.metrics.export.atlas.config-time-to-live=150s # Time to live for subscriptions from the LWC service.management.metrics.export.atlas.config-uri=http://localhost:7101/lwc/api/v1/expressions/local-dev # URI for the Atlas LWC endpoint to retrieve current subscriptions.management.metrics.export.atlas.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.atlas.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.atlas.eval-uri=http://localhost:7101/lwc/api/v1/evaluate # URI for the Atlas LWC endpoint to evaluate the data for a subscription.management.metrics.export.atlas.lwc-enabled=false # Whether to enable streaming to Atlas LWC.management.metrics.export.atlas.meter-time-to-live=15m # Time to live for meters that do not have any activity. After this period the meter will be considered expired and will not get reported.management.metrics.export.atlas.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.atlas.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.atlas.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.atlas.uri=http://localhost:7101/api/v1/publish # URI of the Atlas server.management.metrics.export.datadog.api-key= # Datadog API key.management.metrics.export.datadog.application-key= # Datadog application key. Not strictly required, but improves the Datadog experience by sending meter descriptions, types, and base units to Datadog.management.metrics.export.datadog.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.datadog.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.datadog.descriptions=true # Whether to publish descriptions metadata to Datadog. Turn this off to minimize the amount of metadata sent.management.metrics.export.datadog.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.datadog.host-tag=instance # Tag that will be mapped to &quot;host&quot; when shipping metrics to Datadog.management.metrics.export.datadog.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.datadog.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.datadog.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.datadog.uri=https://app.datadoghq.com # URI to ship metrics to. If you need to publish metrics to an internal proxy en-route to Datadog, you can define the location of the proxy with this.management.metrics.export.dynatrace.api-token= # Dynatrace authentication token.management.metrics.export.dynatrace.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.dynatrace.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.dynatrace.device-id= # ID of the custom device that is exporting metrics to Dynatrace.management.metrics.export.dynatrace.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.dynatrace.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.dynatrace.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.dynatrace.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.dynatrace.technology-type=java # Technology type for exported metrics. Used to group metrics under a logical technology name in the Dynatrace UI.management.metrics.export.dynatrace.uri= # URI to ship metrics to. Should be used for SaaS, self managed instances or to en-route through an internal proxy.management.metrics.export.elastic.auto-create-index=true # Whether to create the index automatically if it does not exist.management.metrics.export.elastic.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.elastic.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.elastic.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.elastic.host=http://localhost:9200 # Host to export metrics to.management.metrics.export.elastic.index=metrics # Index to export metrics to.management.metrics.export.elastic.index-date-format=yyyy-MM # Index date format used for rolling indices. Appended to the index name, preceded by a &apos;-&apos;.management.metrics.export.elastic.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.elastic.password= # Login password of the Elastic server.management.metrics.export.elastic.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.elastic.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.elastic.timestamp-field-name=@timestamp # Name of the timestamp field.management.metrics.export.elastic.user-name= # Login user of the Elastic server.management.metrics.export.ganglia.addressing-mode=multicast # UDP addressing mode, either unicast or multicast.management.metrics.export.ganglia.duration-units=milliseconds # Base time unit used to report durations.management.metrics.export.ganglia.enabled=true # Whether exporting of metrics to Ganglia is enabled.management.metrics.export.ganglia.host=localhost # Host of the Ganglia server to receive exported metrics.management.metrics.export.ganglia.port=8649 # Port of the Ganglia server to receive exported metrics.management.metrics.export.ganglia.protocol-version=3.1 # Ganglia protocol version. Must be either 3.1 or 3.0.management.metrics.export.ganglia.rate-units=seconds # Base time unit used to report rates.management.metrics.export.ganglia.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.ganglia.time-to-live=1 # Time to live for metrics on Ganglia. Set the multi-cast Time-To-Live to be one greater than the number of hops (routers) between the hosts.management.metrics.export.graphite.duration-units=milliseconds # Base time unit used to report durations.management.metrics.export.graphite.enabled=true # Whether exporting of metrics to Graphite is enabled.management.metrics.export.graphite.host=localhost # Host of the Graphite server to receive exported metrics.management.metrics.export.graphite.port=2004 # Port of the Graphite server to receive exported metrics.management.metrics.export.graphite.protocol=pickled # Protocol to use while shipping data to Graphite.management.metrics.export.graphite.rate-units=seconds # Base time unit used to report rates.management.metrics.export.graphite.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.graphite.tags-as-prefix= # For the default naming convention, turn the specified tag keys into part of the metric prefix.management.metrics.export.humio.api-token= # Humio API token.management.metrics.export.humio.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.humio.connect-timeout=5s # Connection timeout for requests to this backend.management.metrics.export.humio.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.humio.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.humio.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.humio.repository=sandbox # Name of the repository to publish metrics to.management.metrics.export.humio.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.humio.tags.*= # Humio tags describing the data source in which metrics will be stored. Humio tags are a distinct concept from Micrometer&apos;s tags. Micrometer&apos;s tags are used to divide metrics along dimensional boundaries.management.metrics.export.humio.uri=https://cloud.humio.com # URI to ship metrics to. If you need to publish metrics to an internal proxy en-route to Humio, you can define the location of the proxy with this.management.metrics.export.influx.auto-create-db=true # Whether to create the Influx database if it does not exist before attempting to publish metrics to it.management.metrics.export.influx.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.influx.compressed=true # Whether to enable GZIP compression of metrics batches published to Influx.management.metrics.export.influx.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.influx.consistency=one # Write consistency for each point.management.metrics.export.influx.db=mydb # Tag that will be mapped to &quot;host&quot; when shipping metrics to Influx.management.metrics.export.influx.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.influx.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.influx.password= # Login password of the Influx server.management.metrics.export.influx.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.influx.retention-duration= # Time period for which Influx should retain data in the current database.management.metrics.export.influx.retention-shard-duration= # Time range covered by a shard group.management.metrics.export.influx.retention-policy= # Retention policy to use (Influx writes to the DEFAULT retention policy if one is not specified).management.metrics.export.influx.retention-replication-factor= # How many copies of the data are stored in the cluster.management.metrics.export.influx.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.influx.uri=http://localhost:8086 # URI of the Influx server.management.metrics.export.influx.user-name= # Login user of the Influx server.management.metrics.export.jmx.domain=metrics # Metrics JMX domain name.management.metrics.export.jmx.enabled=true # Whether exporting of metrics to JMX is enabled.management.metrics.export.jmx.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.kairos.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.kairos.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.kairos.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.kairos.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.kairos.password= # Login password of the KairosDB server.management.metrics.export.kairos.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.kairos.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.kairos.uri= localhost:8080/api/v1/datapoints # URI of the KairosDB server.management.metrics.export.kairos.user-name= # Login user of the KairosDB server.management.metrics.export.newrelic.account-id= # New Relic account ID.management.metrics.export.newrelic.api-key= # New Relic API key.management.metrics.export.newrelic.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.newrelic.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.newrelic.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.newrelic.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.newrelic.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.newrelic.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.newrelic.uri=https://insights-collector.newrelic.com # URI to ship metrics to.management.metrics.export.prometheus.descriptions=true # Whether to enable publishing descriptions as part of the scrape payload to Prometheus. Turn this off to minimize the amount of data sent on each scrape.management.metrics.export.prometheus.enabled=true # Whether exporting of metrics to Prometheus is enabled.management.metrics.export.prometheus.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.prometheus.pushgateway.base-url=localhost:9091 # Base URL for the Pushgateway.management.metrics.export.prometheus.pushgateway.enabled=false # Enable publishing via a Prometheus Pushgateway.management.metrics.export.prometheus.pushgateway.grouping-key= # Grouping key for the pushed metrics.management.metrics.export.prometheus.pushgateway.job= # Job identifier for this application instance.management.metrics.export.prometheus.pushgateway.push-rate=1m # Frequency with which to push metrics.management.metrics.export.prometheus.pushgateway.shutdown-operation= # Operation that should be performed on shutdown.management.metrics.export.signalfx.access-token= # SignalFX access token.management.metrics.export.signalfx.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.signalfx.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.signalfx.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.signalfx.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.signalfx.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.signalfx.source= # Uniquely identifies the app instance that is publishing metrics to SignalFx. Defaults to the local host name.management.metrics.export.signalfx.step=10s # Step size (i.e. reporting frequency) to use.management.metrics.export.signalfx.uri=https://ingest.signalfx.com # URI to ship metrics to.management.metrics.export.simple.enabled=true # Whether, in the absence of any other exporter, exporting of metrics to an in-memory backend is enabled.management.metrics.export.simple.mode=cumulative # Counting mode.management.metrics.export.simple.step=1m # Step size (i.e. reporting frequency) to use.management.metrics.export.statsd.enabled=true # Whether exporting of metrics to StatsD is enabled.management.metrics.export.statsd.flavor=datadog # StatsD line protocol to use.management.metrics.export.statsd.host=localhost # Host of the StatsD server to receive exported metrics.management.metrics.export.statsd.max-packet-length=1400 # Total length of a single payload should be kept within your network&apos;s MTU.management.metrics.export.statsd.polling-frequency=10s # How often gauges will be polled. When a gauge is polled, its value is recalculated and if the value has changed (or publishUnchangedMeters is true), it is sent to the StatsD server.management.metrics.export.statsd.port=8125 # Port of the StatsD server to receive exported metrics.management.metrics.export.statsd.publish-unchanged-meters=true # Whether to send unchanged meters to the StatsD server.management.metrics.export.wavefront.api-token= # API token used when publishing metrics directly to the Wavefront API host.management.metrics.export.wavefront.batch-size=10000 # Number of measurements per request to use for this backend. If more measurements are found, then multiple requests will be made.management.metrics.export.wavefront.connect-timeout=1s # Connection timeout for requests to this backend.management.metrics.export.wavefront.enabled=true # Whether exporting of metrics to this backend is enabled.management.metrics.export.wavefront.global-prefix= # Global prefix to separate metrics originating from this app&apos;s white box instrumentation from those originating from other Wavefront integrations when viewed in the Wavefront UI.management.metrics.export.wavefront.num-threads=2 # Number of threads to use with the metrics publishing scheduler.management.metrics.export.wavefront.read-timeout=10s # Read timeout for requests to this backend.management.metrics.export.wavefront.source= # Unique identifier for the app instance that is the source of metrics being published to Wavefront. Defaults to the local host name.management.metrics.export.wavefront.step=10s # Step size (i.e. reporting frequency) to use.management.metrics.export.wavefront.uri=https://longboard.wavefront.com # URI to ship metrics to.management.metrics.use-global-registry=true # Whether auto-configured MeterRegistry implementations should be bound to the global static registry on Metrics.management.metrics.tags.*= # Common tags that are applied to every meter.management.metrics.web.client.max-uri-tags=100 # Maximum number of unique URI tag values allowed. After the max number of tag values is reached, metrics with additional tag values are denied by filter.management.metrics.web.client.requests-metric-name=http.client.requests # Name of the metric for sent requests.management.metrics.web.server.auto-time-requests=true # Whether requests handled by Spring MVC, WebFlux or Jersey should be automatically timed.management.metrics.web.server.max-uri-tags=100 # Maximum number of unique URI tag values allowed. After the max number of tag values is reached, metrics with additional tag values are denied by filter.management.metrics.web.server.requests-metric-name=http.server.requests # Name of the metric for received requests.# ----------------------------------------# DEVTOOLS PROPERTIES# ----------------------------------------# DEVTOOLS (DevToolsProperties)spring.devtools.add-properties=true # Whether to enable development property defaults.spring.devtools.livereload.enabled=true # Whether to enable a livereload.com-compatible server.spring.devtools.livereload.port=35729 # Server port.spring.devtools.restart.additional-exclude= # Additional patterns that should be excluded from triggering a full restart.spring.devtools.restart.additional-paths= # Additional paths to watch for changes.spring.devtools.restart.enabled=true # Whether to enable automatic restart.spring.devtools.restart.exclude=META-INF/maven/**,META-INF/resources/**,resources/**,static/**,public/**,templates/**,**/*Test.class,**/*Tests.class,git.properties,META-INF/build-info.properties # Patterns that should be excluded from triggering a full restart.spring.devtools.restart.log-condition-evaluation-delta=true # Whether to log the condition evaluation delta upon restart.spring.devtools.restart.poll-interval=1s # Amount of time to wait between polling for classpath changes.spring.devtools.restart.quiet-period=400ms # Amount of quiet time required without any classpath changes before a restart is triggered.spring.devtools.restart.trigger-file= # Name of a specific file that, when changed, triggers the restart check. If not specified, any classpath file change triggers the restart.# REMOTE DEVTOOLS (RemoteDevToolsProperties)spring.devtools.remote.context-path=/.~~spring-boot!~ # Context path used to handle the remote connection.spring.devtools.remote.proxy.host= # The host of the proxy to use to connect to the remote application.spring.devtools.remote.proxy.port= # The port of the proxy to use to connect to the remote application.spring.devtools.remote.restart.enabled=true # Whether to enable remote restart.spring.devtools.remote.secret= # A shared secret required to establish a connection (required to enable remote support).spring.devtools.remote.secret-header-name=X-AUTH-TOKEN # HTTP header used to transfer the shared secret.# ----------------------------------------# TESTING PROPERTIES# ----------------------------------------spring.test.database.replace=any # Type of existing DataSource to replace.spring.test.mockmvc.print=default # MVC Print option.]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>Springboot</tag>
        <tag>Properties</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[RestTemplateæŽ¥æ”¶æ³›åž‹å‚æ•°]]></title>
    <url>%2F2019%2F09%2F28%2FRestTemplate%E6%8E%A5%E6%94%B6%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0%2F</url>
    <content type="text"><![CDATA[å‰æä½¿ç”¨restTemplateçš„postForObjectç­‰æ–¹æ³•ä¸èƒ½æ­£ç¡®æŽ¥æ”¶é™¤äº†Stringçš„å…¶ä»–æ³›åž‹çš„å‚æ•° å¦‚ï¼šMap&lt;String, UserDTO&gt;ï¼›List&lt;UserDTO&gt;ä¸­çš„UserDTOä¼šè‡ªåŠ¨ç”¨LinkedHashMapæŽ¥æ”¶ï¼Œä»Žè€Œå˜æˆ Map&lt;String, LinkedHashMap&gt; å’Œ List&lt;LinkedHashMap&gt;ï¼Œå¯¼è‡´æŽ¥æ”¶ç«¯ä¸èƒ½æ­£ç¡®æŽ¥æ”¶å‚æ•° è§£å†³æ–¹æ³•ä½¿ç”¨ParameterizedTypeReference&lt;T&gt;æŒ‡å®šæ³›åž‹ï¼Œå°±å¯ä»¥æ­£ç¡®æŽ¥æ”¶æ•°æ®äº† ä¾‹å­1123ParameterizedTypeReference&lt;Map&lt;String, UserDTO&gt;&gt; typeRef = new ParameterizedTypeReference&lt;Map&lt;String, UserDTO&gt;&gt;() &#123;&#125;; ResponseEntity&lt;Map&lt;String, UserDTO&gt;&gt; responseEntity = restTemplate.exchange(requestUrl, HttpMethod.POST, new HttpEntity&lt;&gt;(params), typeRef); Map&lt;String, UserDTO&gt; list = responseEntity.getBody(); ä¾‹å­2123ParameterizedTypeReference&lt;List&lt;UserDTO&gt;&gt; typeRef = new ParameterizedTypeReference&lt;List&lt;UserDTO&gt;&gt;() &#123;&#125;; ResponseEntity&lt;List&lt;UserDTO&gt;&gt; responseEntity = restTemplate.exchange(requestUrl, HttpMethod.POST, new HttpEntity&lt;&gt;(params), typeRef); List&lt;UserDTO&gt; list = responseEntity.getBody();]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>RestTemplate</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Springbootçš„@Conditionalæ³¨è§£]]></title>
    <url>%2F2019%2F09%2F20%2FSpringboot%E7%9A%84%40Conditional%E6%B3%A8%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[@Conditional å®˜æ–¹æ–‡æ¡£å®šä¹‰ï¼šâ€œIndicates that a component is only eligible for registration when all specified conditions matchâ€ï¼Œæ„æ€æ˜¯åªæœ‰æ»¡è¶³ä¸€äº›åˆ—æ¡ä»¶ä¹‹åŽæ‰åˆ›å»ºbeanã€‚ æ‰€ä»¥Springbootåˆ©ç”¨@Conditionalæ³¨è§£æ¥ç¡®å®šæ˜¯å¦è¦åŠ è½½è¯¥å®žä¾‹ å®šä¹‰12345678910111213package org.springframework.context.annotation;import java.lang.annotation.Documented;import java.lang.annotation.ElementType;import java.lang.annotation.Retention;import java.lang.annotation.RetentionPolicy;import java.lang.annotation.Target;@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)@Retention(RetentionPolicy.RUNTIME)@Documentedpublic @interface Conditional &#123; Class&lt;? extends Condition&gt;[] value();&#125; ä½¿ç”¨çš„ä½ç½®: ç±»çº§åˆ«å¯ä»¥æ”¾åœ¨æ³¨æ ‡è¯†æœ‰@Componentï¼ˆåŒ…å«@Configurationï¼‰çš„ç±»ä¸Š ä½œä¸ºä¸€ä¸ªmeta-annotationï¼Œç»„æˆè‡ªå®šä¹‰æ³¨è§£ æ–¹æ³•çº§åˆ«å¯ä»¥æ”¾åœ¨æ ‡è¯†ç”±@Beançš„æ–¹æ³•ä¸Š @Conditionalæ‹“å±•æ³¨è§£ @ConditionalOnBean: å½“ä¸”ä»…å½“Springbootå®¹å™¨å­˜åœ¨æŒ‡å®šçš„bean classes and/or bean namesï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®žä¾‹ã€‚ @ConditionalOnMissingBean: å½“ä¸”ä»…å½“Springbootå®¹å™¨ä¸å­˜åœ¨æŒ‡å®šçš„bean classes and/or bean namesï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®žä¾‹ @ConditionalOnClassï¼šå’Œ@ConditionalOnBeanç±»ä¼¼ï¼Œå½“classpathä¸­å­˜åœ¨æŒ‡å®šçš„classæˆ–className @ConditionalOnMissingClassï¼šå’Œ@ConditionalOnMissingBeanç±»ä¼¼ï¼Œå½“classpathä¸­å­˜åœ¨æŒ‡å®šçš„classæˆ–className @ConditionalOnPropertyï¼šå½“ä¸”ä»…å½“application.properties/application.ymlå­˜åœ¨æŒ‡å®šçš„é…ç½®é¡¹æ—¶ï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®žä¾‹ @ConditionalOnJavaï¼šæŒ‡å®šJDKçš„ç‰ˆæœ¬ @ConditionalOnExpressionï¼šè¡¨è¾¾å¼ç”¨${..}=falseç­‰æ¥è¡¨ç¤º @ConditionalOnJndiï¼šJNDIå­˜åœ¨è¯¥é¡¹æ—¶åˆ›å»º @ConditionalOnResourceï¼šåœ¨classpathä¸‹å­˜åœ¨æŒ‡å®šçš„resourceæ—¶åˆ›å»º @ConditionalOnSingleCandidate å½“å®¹å™¨ä¸­æŒ‡å®šçš„classä»…å­˜åœ¨ä¸€ä¸ªbeançš„æ—¶å€™ï¼Œæ‰åˆ›å»ºæ³¨è§£æ‰€ä¿®é¥°çš„å®žä¾‹ @ConditionalOnWebApplicationï¼šåœ¨webçŽ¯å¢ƒä¸‹åˆ›å»º]]></content>
      <categories>
        <category>Springboot</category>
      </categories>
      <tags>
        <tag>Springboot</tag>
        <tag>Annotation</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Stringçš„å¸¸è§é—®é¢˜]]></title>
    <url>%2F2019%2F09%2F06%2FString%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[åŒå¼•å·å’Œæž„é€ å™¨ä¸¤ç§å½¢å¼åˆ›å»ºå­—ç¬¦ä¸²çš„åŒºåˆ«ä¾‹å­11234String a = "abcd";String b = "abcd";System.out.println(a == b); // TrueSystem.out.println(a.equals(b)); // True a == b ç»“æžœä¸º trueï¼Œæ˜¯å› ä¸º a å’Œ b éƒ½æŒ‡å‘ æ–¹æ³•åŒº(method area) åŒä¸€ä¸ªå­—ç¬¦ä¸²æ–‡å­—ï¼Œå†…å­˜å¼•ç”¨æ˜¯åŒä¸€ä¸ªã€‚ å½“å¤šæ¬¡åˆ›å»ºç›¸åŒçš„å­—ç¬¦ä¸²æ–‡å­—æ—¶ï¼Œåªå­˜å‚¨æ¯ä¸ªä¸åŒå­—ç¬¦ä¸²å€¼çš„ä¸€ä¸ªå‰¯æœ¬ã€‚è¿™ä¸ªå«åšå­—ç¬¦ä¸²ç•™é©»/ç•™ç”¨ï¼ŒJava ä¸­æ‰€æœ‰ç¼–è¯‘æœŸå­—ç¬¦ä¸²å¸¸é‡éƒ½ä¼šè¢«è‡ªåŠ¨ç•™é©»ã€‚ ä¾‹å­21234String c = new String("abcd");String d = new String("abcd");System.out.println(c == d); // FalseSystem.out.println(c.equals(d)); // True c==d ç»“æžœä¸º falseï¼Œå› ä¸º c å’Œ d çš„å¼•ç”¨æŒ‡å‘å †ä¸­ä¸åŒçš„å¯¹è±¡ï¼Œä¸åŒçš„å¯¹è±¡è‚¯å®šæœ‰ä¸åŒçš„å†…å­˜å¼•ç”¨ ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œç”¨å›¾å½¢æ¥ç†è§£çš„è¯æ˜¯ï¼š ä¸€ä¸ªæ˜¯åœ¨æ–¹æ³•åŒºï¼Œä¸€ä¸ªæ˜¯åœ¨å †ä¸­ï¼Œ è¿™æ˜¯JVMæ¨¡åž‹çš„ä¸¤ä¸ªä¸åŒçš„åŒºåŸŸã€‚ JVMæ¨¡åž‹çš„å›¾ï¼š æ‰€æœ‰newçš„å¯¹è±¡éƒ½åœ¨Heapä¸­ã€‚ è¿è¡ŒæœŸå­—ç¬¦ä¸²ç•™é©»1234String c = new String("abcd").intern();String d = new String("abcd").intern();System.out.println(c == d); // TrueSystem.out.println(c.equals(d)); // True c == d ç»“æžœä¸º trueï¼Œ intern (è‹±æ–‡æœ‰æ‹˜ç•™ï¼Œè½¯ç¦çš„æ„æ€)çš„ä½œç”¨äº†ï¼Œé€šè¿‡è°ƒç”¨ intern()æ–¹æ³•ï¼Œå°±å¥½æ¯”æŠŠåˆ›å»ºçš„å­—ç¬¦ä¸²æ‹˜ç•™åœ¨æ–¹æ³•åŒºä¸€æ ·äº† åœ¨é¢è¯•æ—¶ç”šè‡³è¿˜ä¼šé—®ä½ ä¸‹é¢ä»£ç åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ 1String d = new String("abcd") å¦‚æžœæ–¹æ³•åŒºé‡Œæœ‰&quot;abcd&quot;ï¼Œ åˆ™åªåˆ›å»ºä¸€ä¸ªnew Stringå¯¹è±¡ å¦‚æžœæ–¹æ³•åŒºé‡Œæ²¡æœ‰&quot;abcd&quot;ï¼Œåˆ™åˆ›å»ºä¸¤ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ ä¸€ä¸ªæ˜¯æ–¹æ³•åŒºçš„&quot;abcd&quot; ä¸€ä¸ªæ˜¯å †çš„new String(&quot;abcd&quot;) æ‰€ä»¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ²¡å¿…è¦ä½¿ç”¨æž„é€ å™¨åˆ›å»ºå¯¹è±¡ï¼Œå› ä¸ºè¿™å¾ˆå¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé¢å¤–çš„æ²¡ç”¨çš„å¯¹è±¡ã€‚ ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼š 12String s = "abcd";s = s.concat("ef"); å½“åœ¨å­—ç¬¦ä¸² s åŽé¢æ‹¼æŽ¥å­—ç¬¦ä¸²&quot;ef&quot;æ—¶ï¼Œä¼šåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°† s çš„å¼•ç”¨æŒ‡å‘æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œç”±äºŽ String åˆ›å»ºçš„æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œæ‰€ä»¥ String ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¸ä¼šæ”¹å˜å®ƒè‡ªèº«ï¼Œè€Œæ˜¯è¿”å›žä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²(å¿«æ‰“å¼€ä½ çš„ IDEï¼Œçœ‹çœ‹æ˜¯å¦æ¯ä¸ªæ“ä½œString çš„æ–¹æ³•æœ€åŽéƒ½æ˜¯è¿”å›žæœ‰ return new String å­—æ ·)ï¼Œåˆ°è¿™é‡Œä½ åº”è¯¥ç†è§£äº†ä¸€ä¸ªé“ç†: å¦‚æžœéœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²è¢«ä¿®æ”¹ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿ç”¨ StringBuffer æˆ–è€… StringBuilderï¼Œå¦åˆ™ï¼Œç”±äºŽæ¯æ¬¡æ“ä½œå­—ç¬¦ä¸²éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œæ—§çš„å¯¹è±¡ä¸ä¼šæœ‰å¼•ç”¨æŒ‡å‘å®ƒï¼Œè¿™æ ·æˆ‘ä»¬ä¼šæµªè´¹å¾ˆå¤šåžƒåœ¾å›žæ”¶çš„æ—¶é—´ ä¸ºä»€ä¹ˆ String ç±»è¢« final ä¿®é¥°å­—ç¬¦ä¸²æ± çš„éœ€æ±‚å­—ç¬¦ä¸²æ± (String intern pool) æ˜¯æ–¹æ³•åŒºä¸­çš„ä¸€ä¸ªç‰¹æ®Šå­˜å‚¨åŒºåŸŸã€‚å½“åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æžœè¯¥å­—ç¬¦ä¸²å·²ç»å­˜åœ¨äºŽæ± ä¸­ï¼Œé‚£ä¹ˆè¿”å›žçŽ°æœ‰å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ã€‚æ‰€ä»¥è¯´ï¼Œå¦‚æžœä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆæ”¹å˜ä¸€ä¸ªå¼•ç”¨çš„å€¼ï¼Œå°†å¯¼è‡´åŽŸæœ¬æŒ‡å‘è¯¥å€¼çš„å¼•ç”¨èŽ·å–åˆ°é”™è¯¯çš„å€¼ã€‚ ç¼“å­˜ hashcodeå­—ç¬¦ä¸²çš„hashcodeåœ¨Javaä¸­ç»å¸¸ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨HashMapæˆ–HashSetä¸­ã€‚ä¸å¯å˜ä¿è¯hashcodeå§‹ç»ˆæ˜¯ç›¸åŒçš„ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸æ‹…å¿ƒæ›´æ”¹çš„æƒ…å†µä¸‹å…‘çŽ°å®ƒã€‚è¿™æ„å‘³ç€ï¼Œä¸éœ€è¦æ¯æ¬¡ä½¿ç”¨hashcodeæ—¶éƒ½è®¡ç®—å®ƒã€‚è¿™æ ·æ›´æœ‰æ•ˆçŽ‡ã€‚æ‰€ä»¥ä½ ä¼šåœ¨ String ç±»ä¸­çœ‹åˆ°ä¸‹é¢çš„æˆå‘˜å˜é‡çš„å®šä¹‰: 12/** Cache the hash code for the string */private int hash; // Default to 0 å®‰å…¨æ€§Stringè¢«å¹¿æ³›ç”¨ä½œè®¸å¤šjavaç±»çš„å‚æ•°ï¼Œä¾‹å¦‚ç½‘ç»œè¿žæŽ¥ã€æ‰“å¼€æ–‡ä»¶ç­‰ã€‚å¦‚æžœå­—ç¬¦ä¸²ä¸æ˜¯ä¸å¯å˜çš„ï¼Œè¿žæŽ¥æˆ–æ–‡ä»¶å°†è¢«æ›´æ”¹ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨å¨èƒã€‚è¯¥æ–¹æ³•è®¤ä¸ºå®ƒè¿žæŽ¥åˆ°ä¸€å°æœºå™¨ä¸Šï¼Œä½†å®žé™…ä¸Šå¹¶æ²¡æœ‰ã€‚å¯å˜å­—ç¬¦ä¸²ä¹Ÿå¯èƒ½å¯¼è‡´åå°„ä¸­çš„å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå‚æ•°æ˜¯å­—ç¬¦ä¸²ã€‚ ä¸å¯å˜å¯¹è±¡å¤©ç”Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ç”±äºŽä¸å¯å˜å¯¹è±¡ä¸èƒ½è¢«æ›´æ”¹ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´è‡ªç”±å…±äº«ã€‚è¿™æ¶ˆé™¤äº†åŒæ­¥çš„éœ€æ±‚ã€‚ æ€»ä¹‹ï¼Œå‡ºäºŽæ•ˆçŽ‡å’Œå®‰å…¨æ€§çš„è€ƒè™‘ï¼ŒString è¢«è®¾è®¡ä¸ºä¸å¯å˜çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å¯å˜ç±»æ˜¯é¦–é€‰çš„åŽŸå› ã€‚ é™„åŠ è¯´æ˜Žå…³äºŽä¸å¯å˜å¯¹è±¡å’Œä¸å¯å˜å¼•ç”¨æ€»æ˜¯æžä¸æ¸…æ¥š 1final User user = new User(); ä¸Šé¢çš„ä»£ç æŒ‡çš„æ˜¯ user å¼•ç”¨ä¸èƒ½è¢«æ›´æ”¹æŒ‡å‘å†…å­˜çš„å…¶ä»–åœ°å€ï¼Œä½†æ˜¯ç”±äºŽ User æ˜¯å¯å˜å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ user çš„ setter æ–¹æ³•ä¿®æ”¹å…¶å±žæ€§]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>String</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Springè‡ªå®šä¹‰æ³¨è§£]]></title>
    <url>%2F2019%2F09%2F05%2FSpring%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[å‰æ åœ¨ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¼šä½¿ç”¨å¾ˆå¤šçš„æ³¨è§£ï¼Œä½†æ˜¯æ¡†æž¶è‡ªæœ‰çš„æ³¨è§£å¹¶ä¸æ˜¯æ€»èƒ½æ»¡è¶³æˆ‘ä»¬å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šè‡ªå®šä¹‰æ³¨è§£æ¥æ»¡è¶³éœ€æ±‚ã€‚æ ¹æ®æ³¨è§£ä½¿ç”¨çš„ä½ç½®ï¼Œåˆ†æˆå­—æ®µæ³¨è§£ã€æ–¹æ³•ã€ç±»æ³¨è§£æ¥ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰æ³¨è§£ã€‚ å­—æ®µæ³¨è§£ å­—æ®µæ³¨è§£ä¸€èˆ¬æ˜¯ç”¨äºŽæ ¡éªŒå­—æ®µæ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå…¶ä¸­hibernate-validateä¾èµ–å°±æä¾›äº†å¾ˆå¤šå¸¸ç”¨çš„æ ¡éªŒæ³¨è§£ ï¼Œå¦‚@NotNullã€@Rangeç­‰ï¼Œå¯ä»¥è§£å†³å¸¸è§çš„ä¸šåŠ¡åœºæ™¯ã€‚ç„¶è€Œå¦‚æžœæƒ³è¦æ ¡éªŒè·Ÿä¸šåŠ¡å¼ºç›¸å…³çš„éœ€æ±‚ï¼Œé‚£ä¹ˆå·²æœ‰çš„æ³¨è§£å°±ä¸æ»¡è¶³äº†ã€‚ä¾‹å¦‚ï¼šä¼ å…¥çš„å‚æ•°éœ€è¦åˆ¤æ–­æ˜¯å¦åœ¨æŒ‡å®šçš„Stringé›†åˆä¸­ï¼ˆä¸šåŠ¡æžšä¸¾é›†åˆä¹Ÿå¯ï¼‰ã€‚ è‡ªå®šä¹‰æ³¨è§£@Check123456789101112131415161718192021//åªå…è®¸ç”¨åœ¨ç±»çš„å­—æ®µä¸Š@Target(&#123; ElementType.FIELD&#125;) //æ³¨è§£ä¿ç•™åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åå°„èŽ·å¾—å®šä¹‰åœ¨æŸä¸ªç±»ä¸Šçš„æ‰€æœ‰æ³¨è§£@Retention(RetentionPolicy.RUNTIME) //æŒ‡å®šä¸Žæ³¨è§£å…³è”çš„éªŒè¯å™¨@Constraint(validatedBy = ParamConstraintValidated.class)public @interface Check &#123; /** * åˆæ³•çš„å‚æ•°å€¼ **/ String[] paramValues(); /** * æç¤ºä¿¡æ¯ **/ String message() default "å‚æ•°ä¸ä¸ºæŒ‡å®šå€¼"; Class&lt;?&gt;[] groups() default &#123;&#125;; Class&lt;? extends Payload&gt;[] payload() default &#123;&#125;;&#125; @Target å®šä¹‰æ³¨è§£çš„ä½¿ç”¨ä½ç½®ï¼Œç”¨æ¥è¯´æ˜Žè¯¥æ³¨è§£å¯ä»¥è¢«å£°æ˜Žåœ¨é‚£äº›å…ƒç´ ä¸Šã€‚ ElementType.TYPEï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜Žåœ¨ä¸€ä¸ªç±»ä¸Šã€‚ ElementType.FIELDï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜Žåœ¨ä¸€ä¸ªç±»çš„å­—æ®µä¸Šã€‚ ElementType.METHODï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜Žåœ¨ä¸€ä¸ªç±»çš„æ–¹æ³•ä¸Šã€‚ ElementType.PARAMETERï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½è¢«å£°æ˜Žåœ¨ä¸€ä¸ªæ–¹æ³•å‚æ•°ä¸Šã€‚ ElementType.CONSTRUCTORï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½å£°æ˜Žåœ¨ä¸€ä¸ªç±»çš„æž„é€ æ–¹æ³•ä¸Šã€‚ ElementType.LOCAL_VARIABLEï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½å£°æ˜Žåœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸Šã€‚ ElementType.ANNOTATION_TYPEï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½å£°æ˜Žåœ¨ä¸€ä¸ªæ³¨è§£ç±»åž‹ä¸Šã€‚ ElementType.PACKAGEï¼šè¯´æ˜Žè¯¥æ³¨è§£åªèƒ½å£°æ˜Žåœ¨ä¸€ä¸ªåŒ…åä¸Š @Constraint é€šè¿‡ä½¿ç”¨validatedByæ¥æŒ‡å®šä¸Žæ³¨è§£å…³è”çš„éªŒè¯å™¨ @Retentionç”¨æ¥è¯´æ˜Žè¯¥æ³¨è§£ç±»çš„ç”Ÿå‘½å‘¨æœŸã€‚ RetentionPolicy.SOURCE: æ³¨è§£åªä¿ç•™åœ¨æºæ–‡ä»¶ä¸­ RetentionPolicy.CLASS : æ³¨è§£ä¿ç•™åœ¨classæ–‡ä»¶ä¸­ï¼Œåœ¨åŠ è½½åˆ°JVMè™šæ‹Ÿæœºæ—¶ä¸¢å¼ƒ RetentionPolicy.RUNTIME: æ³¨è§£ä¿ç•™åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡åå°„èŽ·å¾—å®šä¹‰åœ¨æŸä¸ªç±»ä¸Šçš„æ‰€æœ‰æ³¨è§£ã€‚ å®šä¹‰å¤„ç†@Checkçš„éªŒè¯å™¨ç±»éªŒè¯å™¨ç±»éœ€è¦å®žçŽ°ConstraintValidatoræ³›åž‹æŽ¥å£ ç¬¬ä¸€ä¸ªæ³›åž‹å‚æ•°ç±»åž‹ï¼šæ ¡éªŒçš„æ³¨è§£ã€‚ ç¬¬äºŒä¸ªæ³›åž‹å‚æ•°Objectï¼šæ ¡éªŒå­—æ®µç±»åž‹ã€‚ éœ€è¦å®žçŽ°initializeå’ŒisValidæ–¹æ³•ï¼ŒisValidæ–¹æ³•ä¸ºæ ¡éªŒé€»è¾‘ï¼Œinitializeæ–¹æ³•åˆå§‹åŒ–å·¥ä½œ 1234567891011121314151617181920public class ParamConstraintValidated implements ConstraintValidator&lt;Check, Object&gt; &#123; /** * åˆæ³•çš„å‚æ•°å€¼ï¼Œä»Žæ³¨è§£ä¸­èŽ·å– * */ private List&lt;String&gt; paramValues; @Override public void initialize(Check constraintAnnotation) &#123; //åˆå§‹åŒ–æ—¶èŽ·å–æ³¨è§£ä¸Šçš„å€¼ paramValues = Arrays.asList(constraintAnnotation.paramValues()); &#125; public boolean isValid(Object o, ConstraintValidatorContext constraintValidatorContext) &#123; if (paramValues.contains(o)) &#123; return true; &#125; //ä¸åœ¨æŒ‡å®šçš„å‚æ•°åˆ—è¡¨ä¸­ return false; &#125;&#125; ä½¿ç”¨æ–¹å¼å®šä¹‰ä¸€ä¸ªå®žä½“ç±»ï¼Œå¯¹sexå­—æ®µåŠ æ ¡éªŒï¼Œå…¶å€¼å¿…é¡»ä¸ºwomanæˆ–è€…man 1234567891011121314@Getter@Setterpublic class User &#123; /** * å§“å * */ private String name; /** * æ€§åˆ« man or women * */ @Check(paramValues = &#123;"man", "woman"&#125;) private String sex;&#125; æµ‹è¯•åœ¨éœ€è¦æ£€éªŒçš„å¯¹è±¡ä¸ŠåŠ ä¸Š@Validatedæ³¨è§£ 1234567@RestController("/api/test")public class TestController &#123; @PostMapping public Object test(@Validated @RequestBody User user) &#123; return "hello world"; &#125;&#125; æ–¹æ³•ã€ç±»æ³¨è§£ åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°è¿‡è¿™æ ·çš„éœ€æ±‚ï¼Œå¦‚åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·çš„æ‰èƒ½è®¿é—®è¿™ä¸ªç±»ä¸­çš„æ–¹æ³•æˆ–æŸä¸ªå…·ä½“çš„æ–¹æ³•ã€æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™å…ˆä¸ä»Žæ•°æ®åº“æŸ¥æ‰¾ï¼Œå…ˆä»Žguava cacheä¸­æŸ¥æ‰¾ï¼Œåœ¨ä»ŽredisæŸ¥æ‰¾ï¼Œæœ€åŽæŸ¥æ‰¾mysqlï¼ˆå¤šçº§ç¼“å­˜ï¼‰ã€‚ è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ³¨è§£åŽ»å®Œæˆè¿™ä¸ªè¦æ±‚ï¼š ç¬¬ä¸€ä¸ªåœºæ™¯ï¼šå®šä¹‰ç±»ä¼¼Spring Securityä¸‹çš„@PreAuthorizeä¸€æ ·çš„åŠŸèƒ½çš„æƒé™æ ¡éªŒçš„æ³¨è§£ 123&gt; - @PreAuthorize("hasRole('ADMIN')") &gt; - @PreAuthorize("hasAuthority('ADMIN')")&gt; ç¬¬äºŒä¸ªåœºæ™¯ï¼šå®šä¹‰ç±»ä¼¼Spring-data-redisä¸‹çš„@Cacheableçš„æ³¨è§£ æƒé™æ³¨è§£è‡ªå®šä¹‰æ³¨è§£@PermissionCheckè¯¥æ³¨è§£çš„ä½œç”¨èŒƒå›´ä¸ºç±»æˆ–è€…æ–¹æ³•ä¸Š 12345678@Target(&#123; ElementType.METHOD, ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)public @interface PermissionCheck &#123; /** * èµ„æºkey * */ String resourceKey();&#125; å®šä¹‰å¤„ç†@PermissionCheckçš„æ‹¦æˆªå™¨ç±»12345678910111213141516171819202122232425262728293031323334353637383940public class PermissionCheckInterceptor extends HandlerInterceptorAdapter &#123; /** * å¤„ç†å™¨å¤„ç†ä¹‹å‰è°ƒç”¨ */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123; HandlerMethod handlerMethod = (HandlerMethod)handler; PermissionCheck permission = findPermissionCheck(handlerMethod); //å¦‚æžœæ²¡æœ‰æ·»åŠ æƒé™æ³¨è§£åˆ™ç›´æŽ¥è·³è¿‡å…è®¸è®¿é—® if (permission == null) &#123; return true; &#125; //èŽ·å–æ³¨è§£ä¸­çš„å€¼ String resourceKey = permission.resourceKey(); //TODO æƒé™æ ¡éªŒä¸€èˆ¬éœ€è¦èŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡æŸ¥è¯¢æ•°æ®åº“è¿›è¡Œæƒé™æ ¡éªŒ //TODO è¿™é‡Œåªè¿›è¡Œç®€å•æ¼”ç¤ºï¼Œå¦‚æžœresourceKeyä¸ºtestKeyåˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™ä¸é€šè¿‡ return "testKey".equals(resourceKey); &#125; /** * æ ¹æ®handlerMethodè¿”å›žæ³¨è§£ä¿¡æ¯ * * @param handlerMethod æ–¹æ³•å¯¹è±¡ * @return PermissionCheckæ³¨è§£ */ private PermissionCheck findPermissionCheck(HandlerMethod handlerMethod) &#123; //åœ¨æ–¹æ³•ä¸Šå¯»æ‰¾æ³¨è§£ PermissionCheck permission = handlerMethod.getMethodAnnotation(PermissionCheck.class); if (permission == null) &#123; //åœ¨ç±»ä¸Šå¯»æ‰¾æ³¨è§£ permission = handlerMethod.getBeanType().getAnnotation(PermissionCheck.class); &#125; return permission; &#125;&#125; æµ‹è¯•12345@GetMapping("/api/test")@PermissionCheck(resourceKey = "test")public Object testPermissionCheck() &#123; return "hello world";&#125; ç¼“å­˜æ³¨è§£è‡ªå®šä¹‰æ³¨è§£@CustomCache12345678@Target(&#123; ElementType.METHOD, ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)public @interface CustomCache &#123; /** * ç¼“å­˜çš„keyå€¼ * */ String key();&#125; å®šä¹‰å¤„ç† @CustomCacheçš„åˆ‡é¢ç±»12345678910111213141516171819202122232425262728293031323334@Aspect@Componentpublic class CustomCacheAspect &#123; /** * åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ³¨è§£è¿›è¡Œå¤„ç† * * @param pjd * @param customCache æ³¨è§£ * @return è¿”å›žä¸­çš„å€¼ * */ @Around("@annotation(com.test.annotation.CustomCache)") public Object dealProcess(ProceedingJoinPoint pjd, CustomCache customCache) &#123; Object result = null; if (customCache.key() == null) &#123; //TODO throw error &#125; //TODO ä¸šåŠ¡åœºæ™¯ä¼šæ¯”è¿™ä¸ªå¤æ‚çš„å¤šï¼Œä¼šæ¶‰åŠå‚æ•°çš„è§£æžå¦‚keyå¯èƒ½æ˜¯#&#123;id&#125;è¿™äº›ï¼Œæ•°æ®æŸ¥è¯¢ //TODO è¿™é‡Œåšç®€å•æ¼”ç¤ºï¼Œå¦‚æžœkeyä¸ºtestKeyåˆ™è¿”å›žhello world if ("testKey".equals(customCache.key())) &#123; return "hello word"; &#125; //æ‰§è¡Œç›®æ ‡æ–¹æ³• try &#123; result = pjd.proceed(); &#125; catch (Throwable throwable) &#123; throwable.printStackTrace(); &#125; return result; &#125;&#125; å› ä¸ºç¼“å­˜æ³¨è§£éœ€è¦åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æœ‰è¿”å›žå€¼ï¼Œæ‰€ä»¥æ²¡æœ‰é€šè¿‡æ‹¦æˆªå™¨å¤„ç†è¿™ä¸ªæ³¨è§£ï¼Œè€Œæ˜¯é€šè¿‡ä½¿ç”¨åˆ‡é¢åœ¨æ‰§è¡Œæ–¹æ³•ä¹‹å‰å¯¹æ³¨è§£è¿›è¡Œå¤„ç†ã€‚å¦‚æžœæ³¨è§£æ²¡æœ‰è¿”å›žå€¼ï¼Œå°†ä¼šè¿”å›žæ–¹æ³•ä¸­çš„å€¼ã€‚ æµ‹è¯•12345@GetMapping("/api/cache")@CustomCache(key = "test")public Object testCustomCache() &#123; return "don't hit cache";&#125;]]></content>
      <categories>
        <category>æ³¨è§£</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>æ³¨è§£</tag>
        <tag>Spring</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[lambdaè¡¨è¾¾å¼Collectors.toMapå½“valueä¸ºnullæ—¶æŠ¥é”™]]></title>
    <url>%2F2019%2F08%2F26%2Flambda%E8%A1%A8%E8%BE%BE%E5%BC%8FCollectors-toMap%E5%BD%93value%E4%B8%BAnull%E6%97%B6%E6%8A%A5%E9%94%99%2F</url>
    <content type="text"><![CDATA[åŽŸå›  Map.mergeæ–¹æ³•åˆå¹¶æ—¶ï¼Œmergeä¸å…è®¸valueä¸ºnullå¯¼è‡´çš„ æºç å¦‚ä¸‹12345678910111213default V merge(K key, V value, BiFunction&lt;? super V, ? super V, ? extends V&gt; remappingFunction) &#123; Objects.requireNonNull(remappingFunction); Objects.requireNonNull(value); V oldValue = get(key); V newValue = (oldValue == null) ? value : remappingFunction.apply(oldValue, value); if (newValue == null) &#123; remove(key); &#125; else &#123; put(key, newValue); &#125; return newValue; &#125; è§£å†³çš„åŠžæ³•123456fundsSerials.stream() .collect( Collectors.toMap( FundsSerial::getSerialNo, fundsSerial -&gt; Optional.of(fundsSerial).map(FundsSerial::getOrderNo).orElse(""), (k1, k2) -&gt; k2)); ä½¿ç”¨ï¼šOptional.of(fundsSerial) æˆ–è€… Optional.ofNullable(fundsSerial) è½¬æˆ optional å¯¹è±¡ï¼Œ ç„¶åŽä½¿ç”¨orElse()ï¼Œæ¢æˆé»˜è®¤å€¼ã€‚]]></content>
      <categories>
        <category>JDK</category>
        <category>JDK8</category>
      </categories>
      <tags>
        <tag>lambda</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å°†jaråŒ…è®¾ç½®æˆwindowsçš„service]]></title>
    <url>%2F2019%2F08%2F25%2F%E5%B0%86jar%E5%8C%85%E6%B3%A8%E5%86%8C%E6%88%90windows%E7%9A%84%E6%9C%8D%E5%8A%A1%2F</url>
    <content type="text"><![CDATA[å‰æ åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶ä¼šéœ€è¦è‡ªå®šä¹‰ä¸€äº›æœåŠ¡å¯åŠ¨ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨åœ¨å‘½ä»¤è¡Œçª—å£ä¸­è¿è¡Œå‘½ä»¤ï¼Œè€Œä¸”ä¼šæœ‰ä¸€ä¸ªçª—å£åœ¨ä»»åŠ¡æ é‡Œï¼Œå¤ªéº»çƒ¦äº†ã€‚ ä¾‹å¦‚ï¼Œæˆ‘éœ€è¦éƒ¨ç½²ä¸€ä¸ªJrebelçš„æ³¨å†Œå™¨ï¼Œideaæ‰å¯ä»¥æ¿€æ´»JrebelæˆåŠŸï¼Œæ‰€ä»¥æƒ³æ³¨å†Œæˆä¸€ä¸ªæœåŠ¡ï¼Œå¼€æœºåŽè‡ªåŠ¨å¯åŠ¨æœåŠ¡ï¼Œä¸éœ€è¦å†æ“ä½œä»»ä½•ä¸œè¥¿ã€‚ å‡†å¤‡JaråŒ…è‡ªè¡Œå‡†å¤‡éœ€è¦æ³¨å†ŒæˆæœåŠ¡çš„jaråŒ…ã€‚å¦‚æžœæ˜¯Javaç¨‹åºçš„è¯ï¼Œmavenæ‰“åŒ…æˆjarå³å¯ã€‚ è¿™é‡Œæˆ‘éœ€è¦ä¸€ä¸ªJrebelçš„æ³¨å†Œå™¨çš„JaråŒ…ã€‚ JrebelLicenseServiceä¸‹è½½åœ°å€ ä¸‹è½½winswwinswæ˜¯ä¸€æ¬¾å¯å°†å¯æ‰§è¡Œç¨‹åºå®‰è£…æˆWindows Serviceçš„å¼€æºå·¥å…·ã€‚winswä¸‹è½½åœ°å€ åªéœ€è¦ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶(.exe)å’Œé…ç½®æ–‡ä»¶(.xml)ï¼Œé…ç½®æ–‡ä»¶æ˜¯ä¸ºäº†å‚è€ƒéœ€è¦é…ç½®ä»€ä¹ˆï¼Œåˆ°æ—¶ç›´æŽ¥åœ¨ä¸Šé¢æ”¹å³å¯ã€‚ sample-minimal.xml: æœ€å°é…ç½® sample-allOptions.xmlï¼š å¯é€‰æ‹©çš„é…ç½® é…ç½®é…ç½®æœåŠ¡æ‰€éœ€è¦çš„æ–‡ä»¶ é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹Jrebelã€‚ å°†ä¸‹è½½å¥½çš„JrebelBrainsLicenseServerforJava-1.0-SNAPSHOT-jar-with-dependencies.jaræ”¹åä¸ºJrebel.jarï¼Œå¹¶å¤åˆ¶è¿›åŽ»ã€‚ å°†ä¸‹è½½å¥½çš„WinSW.NET4.exeæ”¹åä¸ºJrebel.exeï¼Œå¹¶å¤åˆ¶è¿›åŽ»ã€‚ å› ä¸ºæˆ‘ä¸éœ€è¦ç‰¹åˆ«å¤æ‚çš„é…ç½®ï¼Œæ‰€ä»¥ä½¿ç”¨sample-minimal.xmlå³å¯ï¼Œæ”¹åä¸ºJrebel.xmlï¼Œå¹¶å¤åˆ¶è¿›åŽ»ã€‚ å¦‚å›¾æ‰€ç¤ºï¼š ä¿®æ”¹é…ç½®æ–‡ä»¶ä¿®æ”¹Jrebel.xmlçš„å†…å®¹ï¼š 12345678910111213141516171819202122232425262728&lt;configuration&gt; &lt;!-- æœåŠ¡ID: å¯åŠ¨ã€å…³é—­ã€åˆ é™¤æœåŠ¡æ—¶ï¼Œéƒ½æ˜¯é€šè¿‡IDæ¥æ“ä½œçš„ --&gt; &lt;id&gt;JrebelService&lt;/id&gt; &lt;!-- æœåŠ¡åç§°, ç”¨äºŽæ˜¾ç¤º --&gt; &lt;name&gt;JrebelService&lt;/name&gt; &lt;!-- æœåŠ¡æè¿° --&gt; &lt;description&gt;This service is Jrebel License Service&lt;/description&gt; &lt;!-- è‹¥é…ç½®äº†javaçŽ¯å¢ƒå˜é‡ï¼Œç›´æŽ¥å†™æˆâ€œjavaâ€å°±è¡Œ; --&gt; &lt;!-- ä¹Ÿå¯ä»¥å†™æˆè¿™æ ·æ¥æŒ‡å®šä½¿ç”¨çš„jdkç‰ˆæœ¬: C:\Program Files\Java\jdk8\jre\bin\java --&gt; &lt;executable&gt;java&lt;/executable&gt; &lt;!-- å¯åŠ¨å‚æ•° --&gt; &lt;!-- jaråŒ…ä¸åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹å¯ä»¥ä½¿ç”¨è¿™ç§å†™æ³•: G:\Jrebel\Jrebel.jar--&gt; &lt;arguments&gt;-jar Jrebel.jar -p 8081&lt;/arguments&gt; &lt;!-- è®¾ç½®å¼€æœºå¯åŠ¨ --&gt; &lt;startmode&gt;Automatic&lt;/startmode&gt; &lt;!-- æ—¥å¿—é…ç½® --&gt; &lt;!-- logpathæŒ‡å®šåœ¨å“ªä¸ªæ–‡ä»¶ä¸‹è®°å½•logï¼Œè¿™é‡Œæ˜¯åœ¨åŒçº§ç›®å½•ä¸‹åˆ›å»ºlogsæ–‡ä»¶å¤¹å­˜æ”¾log --&gt; &lt;logpath&gt;logs&lt;/logpath&gt; &lt;logmode&gt;rotate&lt;/logmode&gt; &lt;/configuration&gt; æ³¨å†ŒæœåŠ¡ å·²ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å‘½ä»¤è¡Œã€‚ è¿›å…¥åˆ°(.exe)ç›®å½•ä¸‹ï¼Œå³D:\Jrebelã€‚å¦‚æžœå°†è¯¥è·¯å¾„é…ç½®åœ¨Pathè·¯å¾„ä¸‹ï¼Œåˆ™è¿™æ­¥çœç•¥ã€‚ è¾“å…¥ Jrebel install å³å¯æ³¨å†ŒæœåŠ¡ã€‚ æœåŠ¡æ³¨å†ŒæˆåŠŸåŽï¼Œä½¿ç”¨net start JrebelServiceè¿è¡Œè¯¥æœåŠ¡ã€‚ è¿™æ ·å°±å®Œæˆäº†ã€‚ å¯èƒ½ç¢°åˆ°çš„é—®é¢˜â€œæ— æ³•å°†XXXXé¡¹è¯†åˆ«ä¸º cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜ åœ¨è¿™æ¬¡æœåŠ¡ä¸­å‡ºçŽ°çš„è¯ï¼Œåº”è¯¥æ˜¯æŠ¥ï¼šâ€œæ— æ³•å°†Jrebel.exeé¡¹è¯†åˆ«ä¸º cmdletã€å‡½æ•°ã€è„šæœ¬æ–‡ä»¶æˆ–å¯è¿è¡Œç¨‹åºçš„åç§°â€çš„é—®é¢˜ è§£å†³æ–¹æ³•ï¼š ç¬¬ä¸€ç§æ–¹å¼ï¼šéœ€è¦åœ¨æœ‰Jrebel.exeçš„ç›®å½•ä¸‹æ‰§è¡Œè¯¥å‘½ä»¤ã€‚ ç¬¬äºŒç§æ–¹å¼ï¼šå°†Jrebel.exeæ‰€åœ¨ç›®å½•é…ç½®åœ¨Pathè·¯å¾„ä¸‹ã€‚ FATAL - WMI Operation failure: AccessDenied è¿™ä¸ªæ˜¯å› ä¸ºæ²¡æœ‰ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½è¿è¡ŒJrebelå‘½ä»¤ï¼Œç”¨ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å‘½ä»¤è¡Œå³å¯ã€‚ å‡çº§è™½ç„¶æ˜¯æˆåŠŸé…ç½®å¥½äº†æœåŠ¡ï¼Œä½†æ˜¯å…³é—­æœåŠ¡ï¼Œæ³¨é”€æœåŠ¡ï¼Œéƒ½éœ€è¦é‡æ–°åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œå‘½ä»¤ï¼Œä¹Ÿæ˜¯å¾ˆéº»çƒ¦çš„ã€‚æ‰€ä»¥å¯ä»¥ç¼–å†™batæ–‡ä»¶æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚ è¿™é‡Œä¸»è¦æ˜¯å››ä¸ªå‘½ä»¤ï¼š Jrebel install net start JrebelService net stop JrebelService Jrebel uninstall æ‰€ä»¥éœ€è¦åˆ›å»ºå››ä¸ªbatæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ Jrebel_install.bat å¯¹åº”å‘½ä»¤ Jrebel install Jrebel_start.bat å¯¹åº”å‘½ä»¤ net start JrebelService Jrebel_stop.bat å¯¹åº”å‘½ä»¤ net stop JrebelService Jrebel_uninstall.bat å¯¹åº”å‘½ä»¤ net stop JrebelService å’Œ Jrebel uninstall ä½†æ˜¯è¿™æ ·è¿˜ä¸è¡Œï¼Œå› ä¸ºè¿™äº›æœåŠ¡å‘½ä»¤éœ€è¦ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ‰æœ‰æ•ˆã€‚ æ‰€ä»¥éœ€è¦åœ¨æ¯ä¸ªbatæ–‡ä»¶é‡Œé¢å¼€å¤´åŠ ä¸Šè¿™æ®µå‘½ä»¤ç”¨äºŽç”³è¯·ç®¡ç†å‘˜æƒé™ï¼š 1234567891011121314@echo off&gt;nul 2&gt;&amp;1 "%SYSTEMROOT%\system32\cacls.exe" "%SYSTEMROOT%\system32\config\system"if '%errorlevel%' NEQ '0' (goto UACPrompt) else ( goto gotAdmin ):UACPromptecho Set UAC = CreateObject^("Shell.Application"^) &gt; "%temp%\getadmin.vbs"echo UAC.ShellExecute "%~s0", "", "", "runas", 1 &gt;&gt; "%temp%\getadmin.vbs""%temp%\getadmin.vbs"exit /B:gotAdminif exist "%temp%\getadmin.vbs" ( del "%temp%\getadmin.vbs" )pushd "%CD%"cd /D "%~dp0" å…¶ä¸­ä¸€ä¸ªç¤ºä¾‹ï¼š è¿™æ ·å°±å¯ä»¥åŒå‡»æ‰§è¡Œbatæ–‡ä»¶ï¼Œå¿«é€Ÿæ³¨å†ŒæœåŠ¡ï¼Œå¯åŠ¨æœåŠ¡ï¼Œåœæ­¢æœåŠ¡å’Œæ³¨é”€æœåŠ¡ã€‚]]></content>
      <categories>
        <category>å¼€å‘çŽ¯å¢ƒ</category>
      </categories>
      <tags>
        <tag>windows</tag>
        <tag>jar</tag>
        <tag>Jrebel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Windowså®‰è£…nvmç®¡ç†nodeå’Œnpm]]></title>
    <url>%2F2019%2F08%2F24%2Fwindows%E5%AE%89%E8%A3%85nvm%E7%AE%A1%E7%90%86node%E5%92%8Cnpm%2F</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯nvm nvmæ˜¯nodeJSçš„ç‰ˆæœ¬ç®¡ç†å™¨ï¼Œå¯ä»¥è¿è¡Œåœ¨å¤šç§æ“ä½œç³»ç»Ÿä¸Šã€‚nvm for windows æ˜¯ä½¿ç”¨goè¯­è¨€ç¼–å†™çš„è½¯ä»¶ã€‚ ä¸‹è½½nvm-windowsä¸‹è½½åœ°å€ å¦‚å›¾æ‰€ç¤ºï¼š nvm-noinstall.zipï¼š å…å®‰è£…ç‰ˆæœ¬ï¼Œä½†æ˜¯ä½¿ç”¨ä¹‹å‰éœ€è¦é…ç½®çŽ¯å¢ƒå˜é‡ nvm-setup.zipï¼šå®‰è£…åŒ…ï¼Œä¸‹è½½ä¹‹åŽç‚¹å‡»å®‰è£…ï¼Œæ— éœ€é…ç½®å°±å¯ä»¥ä½¿ç”¨ã€‚ Source code(zip)ï¼šzipåŽ‹ç¼©çš„æºç  Sourc code(tar.gz)ï¼štar.gzçš„æºç ï¼Œä¸€èˆ¬ç”¨äºŽUnixç³»ç»Ÿ æ£€æµ‹æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼Œæ‰“å¼€å‘½ä»¤è¡Œçª—å£ä¸­è¾“å…¥nvm å¦‚æžœå‡ºçŽ°nvmç‰ˆæœ¬å·å’Œä¸€ç³»åˆ—å¸®åŠ©æŒ‡ä»¤ï¼Œåˆ™è¯´æ˜Žnvmå®‰è£…æˆåŠŸã€‚ å¦åˆ™ï¼Œå¯èƒ½ä¼šæç¤ºnvm: command not found ä½¿ç”¨nvm for windowsæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œåœ¨æŽ§åˆ¶å°è¾“å…¥nvm,å°±å¯ä»¥çœ‹åˆ°å®ƒçš„å‘½ä»¤ç”¨æ³•ã€‚ åŸºæœ¬å‘½ä»¤ nvm arch [32|64] ï¼š æ˜¾ç¤ºnodeæ˜¯è¿è¡Œåœ¨32ä½è¿˜æ˜¯64ä½æ¨¡å¼ã€‚å‚æ•°å¯æŒ‡å®š32æˆ–64æ¥è¦†ç›–é»˜è®¤ä½“ç³»ç»“æž„ã€‚ nvm install &lt;version&gt; [arch]ï¼š è¯¥å¯ä»¥æ˜¯node.jsç‰ˆæœ¬æˆ–æœ€æ–°ç¨³å®šç‰ˆæœ¬latestã€‚ï¼ˆå¯é€‰[arch]ï¼‰æŒ‡å®šå®‰è£…32ä½æˆ–64ä½ç‰ˆæœ¬ï¼ˆé»˜è®¤ä¸ºç³»ç»Ÿarchï¼‰ã€‚è®¾ç½®[arch]ä¸ºallä»¥å®‰è£…32å’Œ64ä½ç‰ˆæœ¬ã€‚åœ¨å‘½ä»¤åŽé¢æ·»åŠ --insecure ï¼Œå¯ä»¥ç»•è¿‡è¿œç«¯ä¸‹è½½æœåŠ¡å™¨çš„SSLéªŒè¯ã€‚ nvm list [available]ï¼š åˆ—å‡ºå·²ç»å®‰è£…çš„node.jsç‰ˆæœ¬ã€‚å¯é€‰çš„availableï¼Œæ˜¾ç¤ºå¯ä¸‹è½½ç‰ˆæœ¬çš„éƒ¨åˆ†åˆ—è¡¨ã€‚è¿™ä¸ªå‘½ä»¤å¯ä»¥ç®€å†™ä¸ºnvm ls [available]ã€‚ nvm onï¼š å¯ç”¨node.jsç‰ˆæœ¬ç®¡ç†ã€‚ nvm offï¼š ç¦ç”¨node.jsç‰ˆæœ¬ç®¡ç†(ä¸å¸è½½ä»»ä½•ä¸œè¥¿) nvm proxy [url]ï¼š è®¾ç½®ç”¨äºŽä¸‹è½½çš„ä»£ç†ã€‚ç•™[url]ç©ºç™½ï¼Œä»¥æŸ¥çœ‹å½“å‰çš„ä»£ç†ã€‚è®¾ç½®[url]ä¸ºnoneåˆ é™¤ä»£ç†ã€‚ nvm node_mirror [url]ï¼šè®¾ç½®nodeé•œåƒï¼Œé»˜è®¤ä¸ºhttps://nodejs.org/dist/.ã€‚æˆ‘å»ºè®®è®¾ç½®ä¸ºæ·˜å®çš„é•œåƒhttps://npm.taobao.org/mirrors/node/ nvm npm_mirror [url]ï¼šè®¾ç½®npmé•œåƒï¼Œé»˜è®¤ä¸ºhttps://github.com/npm/npm/archive/ã€‚æˆ‘å»ºè®®è®¾ç½®ä¸ºæ·˜å®çš„é•œåƒhttps://npm.taobao.org/mirrors/npm/ nvm uninstall &lt;version&gt;ï¼š å¸è½½æŒ‡å®šç‰ˆæœ¬çš„nodejsã€‚ nvm use [version] [arch]ï¼š åˆ‡æ¢åˆ°ä½¿ç”¨æŒ‡å®šçš„nodejsç‰ˆæœ¬ã€‚å¯ä»¥æŒ‡å®š32/64ä½[arch]ã€‚nvm use &lt;arch&gt;å°†ç»§ç»­ä½¿ç”¨æ‰€é€‰ç‰ˆæœ¬ï¼Œä½†æ ¹æ®æä¾›çš„å€¼åˆ‡æ¢åˆ°32/64ä½æ¨¡å¼çš„&lt;arch&gt; nvm root [path]ï¼š è®¾ç½® nvm å­˜å‚¨node.jsä¸åŒç‰ˆæœ¬çš„ç›®å½• ,å¦‚æžœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨å½“å‰ç›®å½•ã€‚ nvm versionï¼š æ˜¾ç¤ºå½“å‰è¿è¡Œçš„nvmç‰ˆæœ¬ï¼Œå¯ä»¥ç®€å†™ä¸ºnvm v å®‰è£…æŸä¸ªç‰ˆæœ¬çš„nodeè¿™é‡Œæˆ‘å®‰è£…çš„æ˜¯v12.9.0 nvm install 12.9.0 nvm use 12.9.0 é…ç½®çŽ¯å¢ƒå˜é‡æ ¹æ®å®‰è£…nvmæ—¶ï¼Œé€‰æ‹©çš„nodeçš„åœ°å€ï¼Œå¤åˆ¶åˆ°ç³»ç»ŸPathè·¯å¾„ä¸‹ æ–¹ä¾¿å¯ä»¥åœ¨å…¨å±€ä½¿ç”¨ï¼Œä»¥åŠåœ¨git bashä¸­ä½¿ç”¨ æ³¨æ„ï¼š å®‰è£…å®ŒåŽï¼Œgit bashå¯èƒ½ä¼šæç¤º node: command not found æˆ–è€… npm: command not found é‡å¯ä¸€ä¸‹å°±å¥½äº†ã€‚]]></content>
      <categories>
        <category>å¼€å‘çŽ¯å¢ƒ</category>
      </categories>
      <tags>
        <tag>windows</tag>
        <tag>nvm</tag>
        <tag>node</tag>
        <tag>npm</tag>
      </tags>
  </entry>
</search>
