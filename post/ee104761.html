<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>计算机网络通关之Web 技术-流媒体技术 | Leo's notes</title><meta name="keywords" content="计算机网络"><meta name="author" content="Leo Liu"><meta name="copyright" content="Leo Liu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="流媒体技术：直播网站是如何实现的？ 现在的年轻人基本都爱刷 B 站和抖音，空闲时间还喜欢去看看大厂面试、热门技术分享直播，以及各类游戏直播。不知道你有没有思考过，我们每天看到的这么多音视频内容，是如何从采集端，最终呈现到我们的手机 App 上的？如果公司要提供直播服务，那么你可以出技术方案吗？为了应对这些应用场景，我们就以“直播网站是如何实现的”，来系统聊聊直播、点播、视频网站等基于流媒体技术的应">
<meta property="og:type" content="article">
<meta property="og:title" content="计算机网络通关之Web 技术-流媒体技术">
<meta property="og:url" content="https://liule8.github.io/post/ee104761.html">
<meta property="og:site_name" content="Leo&#39;s notes">
<meta property="og:description" content="流媒体技术：直播网站是如何实现的？ 现在的年轻人基本都爱刷 B 站和抖音，空闲时间还喜欢去看看大厂面试、热门技术分享直播，以及各类游戏直播。不知道你有没有思考过，我们每天看到的这么多音视频内容，是如何从采集端，最终呈现到我们的手机 App 上的？如果公司要提供直播服务，那么你可以出技术方案吗？为了应对这些应用场景，我们就以“直播网站是如何实现的”，来系统聊聊直播、点播、视频网站等基于流媒体技术的应">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2021-10-04T07:33:45.000Z">
<meta property="article:modified_time" content="2021-10-16T05:06:47.915Z">
<meta property="article:author" content="Leo Liu">
<meta property="article:tag" content="计算机网络">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liule8.github.io/post/ee104761"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-16 05:06:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">428</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">84</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">51</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Leo's notes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">计算机网络通关之Web 技术-流媒体技术</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-10-04T07:33:45.000Z" title="发表于 2021-10-04 07:33:45">2021-10-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-16T05:06:47.915Z" title="更新于 2021-10-16 05:06:47">2021-10-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="计算机网络通关之Web 技术-流媒体技术"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>流媒体技术：直播网站是如何实现的？</h1>
<p>现在的年轻人基本都爱刷 B 站和抖音，空闲时间还喜欢去看看大厂面试、热门技术分享直播，以及各类游戏直播。不知道你有没有思考过，我们每天看到的这么多音视频内容，是如何从采集端，最终呈现到我们的手机 App 上的？如果公司要提供直播服务，那么你可以出技术方案吗？为了应对这些应用场景，我们就以“<strong>直播网站是如何实现的</strong>”，来系统聊聊直播、点播、视频网站等基于流媒体技术的应用是怎么回事。</p>
<h2 id="流媒体">流媒体</h2>
<p>在流媒体技术不发达的时代，数据往往是以单个文件的形式存在的。比如说十多年前人们要从互联网上看一部电影，他就需要把这个电影文件下载到本地来看。当时十多 k 每秒的网速，要想下载一个电影，往往需要花费一整个晚上。</p>
<p><strong>今天我们将所有的数据都抽象成了流</strong>，文件的格式也发生了变化。那么如何将一个视频抽象成流呢？其实就是传输一部分即可播放一部分。在实际的操作当中，我们设计了一种类似目录的格式，将音视频数据进行切片，这部分能力利用现有的工具 <code>FFmpeg</code> 就可以轻松做到。在你的机器上装一个 <code>FFmpeg</code>，然后利用这条指令处理一个 MP4 文件，就可以生成很多切片和一个目录文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -c:v libx264 -c:a aac -strict -2 -f hls output.m3u8</span><br></pre></td></tr></table></figure>
<p>上面将<code>input.mp4</code>切割成HTTP Live Streaming 可以播放的切片（大多数浏览器中的播放器都可以播放）。最终会生成大量的切片文件，比如说每个 256k，以及一个目录文件 output.m3u8。</p>
<p>下图展示的是用 <code>FFmpeg</code> 在我的机器上对 <code>input.mp4</code> 操作生成的文件清单：</p>
<p><img src="http://image.leonote.cn/20211004073757.png" alt="image-20211004073756931"></p>
<p>m3u8 文件是目录，它记录了每个视频切片文件（ts）对应的视频时间范围。用户播放视频的时候，会先下载 m3u8 文件。当用户调整视频播放滑块选择播放时间时，播放器就根据 m3u8 的内容下载对应的 ts 文件。</p>
<h2 id="基于流媒体的架构">基于流媒体的架构</h2>
<p>了解了上面最基本的原理，我们来思考一个基础架构。如下图所示：</p>
<p><img src="http://image.leonote.cn/20211004073921.png" alt="image-20211004073921187"></p>
<p>视频录制完成后，可能是 MP4 等格式。首先，我们将视频上传到服务器进行编码，产生上面提到的切片文件。切片文件存储到流媒体服务器中，当用户需要的时候，就从流媒体服务器中读取视频目录（上面的 m3u8 文件），然后在各个端播放。进行编码的时候，可以根据不同的清晰度编码多个版本，来应对用户在不同网络环境的情况。</p>
<h3 id="直播">直播</h3>
<p>从这个角度出发去思考，直播技术仍然可以复用上面的这套架构。录制端不断上传视频内容，视频内容编码后流媒体服务器负责分发。如果观看人数较多，可以使用 CDN 回源到流媒体服务器。对于直播，m3u8 文件可以看作一个动态的文件，能够不断产生新的数据。因此直播技术中，可以考虑将获取 m3u8 文件设计成一个接口，不断由播放器请求新的 m3u8 文件。</p>
<blockquote>
<p>从直播平台的角度上来讲，CDN在直播系统中主要用来<strong>解决对于网络带宽小、用户访问量大、网点分布不均导致用户访问速度慢的问题</strong>，要想实现直播是需要进行<strong>推流，再由CDN分发视频内容</strong>，CDN在全球的遍布，方便了整个CDN网络对所有节点用户的服务，并且不会受到地域的限制，用户不管在哪里，都会有最近的CDN网络站点对其服务，保证用户接受信息的速度和质量</p>
</blockquote>
<h3 id="其他音视频网站">其他音视频网站</h3>
<p>对于其他音视频网站架构也是类似的，将视频编码后（含切片）然后利用 CDN 分发目录和切片文件，就可以播放了。</p>
<h2 id="视频的编码和解码">视频的编码和解码</h2>
<p>因为通常视频文件较大，因此在传输前通常需要压缩。另外，在播放前还需要解码。视频的压缩技术并非普通的文件压缩技术，而是针对视频的特征进行特别处理的压缩技术。</p>
<p>你可以将流畅的视频理解成连续播放的图片，这也是视频呈现的原理，主要依靠的是人类视觉的残留效应。视频的压缩算法也是如此，本质上是对图片的压缩。因为视频的前一个画面和后一个画面衔接紧密，如果把它们看作两张图片，这两张图片中往往只有部分内容发生了变化。另外，在连续的多张图片中，也会有重复出现的事物，比如说一座桥、一间教室都可能多次出现。因此，视频压缩可以根据这些特性进行抽象。</p>
<p>对视频进行压缩的时候，视频文件格式也和压缩算法息息相关，我们统称为视频的编码。视频需要编码，包括如何描述目录、如何描述切片、如何存储声音，这些都是编码要考虑的。一个完整的解决方案，我们称为一套视频的编码。比如说 H264 就是国际标准化组织在推广的一种编码格式。当然，所有特性的核心是在减少视频体积（网络传输）的基础上，尽可能地提供更高的画质；另一方面就是要尽可能减少中间编码/解码的时间成本（机器资源）。</p>
<h3 id="宏块">宏块</h3>
<p>这里顺带提一个非常重要的概念，就是<strong>宏块</strong>。</p>
<p>在包括 H264 的很多视频编码技术中，都有一个叫作宏块的概念。宏块，就是将画面分成大小不等的区域。比如说 8x8、16x16 等。</p>
<p>当播放两个连续的画面的时候，你可以理解成两张图片。但是如果基于图片分析，那么播放的就是很多个宏块。在这连续的两帧画面中，并不是所有的宏块都发生了变化。特别是当你看一些教学 PPT 的讲稿时，视频前后两帧的宏块基本没有发生变化。因此往往相同画质、相同时长的教学视频体积会远小于电影视频的体积。</p>
<p>如果你感兴趣具体的压缩算法可以自己去查资料了解一下，参考分组、帧、预测帧等概念。</p>
<h2 id="点到点视频技术">点到点视频技术</h2>
<p>接下来我们讨论下点到点视频技术。</p>
<p>在视频会议、面对面聊天等场景下，我们还需点到点的视频技术。理论上说，这个时候可以复用之前提到的架构。</p>
<p><img src="http://image.leonote.cn/20211004075305.png" alt="image-20211004075305123"></p>
<p>一个客户端将自己本地录制的视频用二进制上传，在服务端编码然后分发到另一个端。数据在另一个端解码并播放。</p>
<p>这样做的缺点是链路较长，于是在实际操作的过程中如果是 1 对 1 的视频聊天，可以考虑实现点到点的服务。</p>
<p><img src="http://image.leonote.cn/20211004075343.png" alt="image-20211004075343833"></p>
<p>不过事情并没有那么简单，因为不同的主机可能在不同的私有网络。比如 Host1 在百度的办公室，Host2 是某位百度的合作伙伴。如下图所示：</p>
<p><img src="http://image.leonote.cn/20211004075623.png" alt="image-20211004075623366"></p>
<p>你会发现如整个设计中需要一个 NAT 路由器，这样客户的数据才能回传到百度内网的机器。而实际情况并没有这么简单，在 NAT 通信中，往往需要在内网的主机发起连接。这个时候 NAT 模块识别发起的端口并记录。换句话说，如果某客户的机器是公网 IP，那么百度内部的主机可以找到这个客户，找到之后，双方建立连接。但是某位客户如果想主动发起向百度内网某台机器的连接，这其实是做不到的。</p>
<p>像下图这种两个主机都在内网中，都需要 NAT 的场景，其实是无法通信的：</p>
<p><img src="http://image.leonote.cn/20211004075927.png" alt="image-20211004075927363"></p>
<p>上图这种情况，百度内网发起连接，对方的 NAT 路由会因为自己内网的机器没有发起过请求而拒绝；反之，如果客户发起请求，会被百度的 NAT 拒绝。这种情况类似于多线程中的“死锁”问题，无法解决。这个时候，就需要一台第三方服务器作为 NAT 模块的辅助功能，帮助双方的 NAT 模块设置本地数据，让双方的 NAT 模块都认为对方已经和自己发起过通信。这个解决方案也叫作 <strong>NAT 穿透（NAT 穿墙）</strong>。</p>
<p>举个例子：在著名的 WebRTC 协议中，可以提供网页版的在线 1 对 1 聊天，对于多数家庭到家庭的网络来说，是可以正常工作的。如果当你需要连接两个内网的机器，这个时候就需要自己架设第三方服务，或者使用某个收费的第三方服务。</p>
<p>对于在线会议的场景，如果人数较少的情况下，仍然可以使用点到点技术，只不过传输量会随着人数的上升而呈爆发式增长。所以在人数较多的时候，就需要更多的优化策略。当然，其中一种方案就是放弃点到点技术，而直接采用类似直播架构的中心化服务。另一种策略就是利用边缘计算，让距离相近的参会者利用共同的离自己最近的服务器交换数据。</p>
<h2 id="总结">总结</h2>
<p>我们探讨了流媒体技术。流媒体，就是把多媒体数据抽象成为流进行传输。视频本质上是一张张图片在播放，因此非常适合流传输。要知道，流是随着时间产生的数据。通常在一个网络中，等价成本下吞吐量、丢包率和延迟 3 者不能兼得。也就是说，像直播这种吞吐量非常大的视频应用，可能就要牺牲延迟。比如之前 B 站直播没有优化前，用户看到的直播画面会比真实的时间会慢近半分钟。</p>
<p>另一方面，像在线会议这类对延迟要求较高的场景，就可能需要降低视频质量，或者部署边缘服务。如果是内网视频会议，或者跨地区的公司视频会议，很容易找到边缘节点帮助交换数据和计算；如果是来自天南地北的用户，那么就需要投入更多成本。对于社交网站而言，需要维护几个人同时语音、视频聊天，因为人数较少，就可以使用点对点技术（但是要解决 NAT 穿墙的问题）。</p>
<p><strong>尝试来回答面试题目：直播网站是如何实现的？</strong></p>
<p>【解析】一个直播网站通常会有下面 5 个部分组成。</p>
<ul>
<li>
<p>录制端：负责录制直播视频，用流的形式上传。</p>
</li>
<li>
<p>计算集群：专门负责编码上传的流数据，然后进行压缩、转码、切片等工作。</p>
</li>
<li>
<p>对象存储：存储原始视频和转码后的视频（相当于 CDN 的源，回源用）。</p>
</li>
<li>
<p>CDN：将转码后的内容分发到离用户较近的节点，方便用户获取。</p>
</li>
<li>
<p>直播 App：给用户看直播时使用。</p>
</li>
</ul>
<h2 id="思考题">思考题</h2>
<p>写一张网页，用 WebRTC 实现点到点通信。</p>
<h3 id="其他解答">其他解答</h3>
<blockquote>
<p>这里找到了一份 Github 上的源代码：<a target="_blank" rel="noopener" href="https://github.com/ScaleDrone/webrtc%E3%80%82">https://github.com/ScaleDrone/webrtc。</a></p>
<p><img src="http://image.leonote.cn/20211004083317.png" alt="image-20211004083317086"></p>
<p>在 WebRTC 的网络世界中，视频传输可以走点到点服务。客户端被称作 Peer，Peer 的数据直接传送给另一个 Peer，我们也称作<strong>P2P 网络</strong>。在<strong>P2P 网络中，要解决 NAT 穿墙问题，WebRTC 设计了一个网络的抽象框架被称作交互式网络建立连接（Interactive Connectivity Establishment， ICE）</strong>，图中的 STUN 是 ICE 的一个实现。</p>
<p>对于一个 P2P 网络中的 Peer，它每次要接入这个 P2P 网络会获得一个身份，这个身份就包括它的 IP 地址、端口使用的协议等，这个身份被抽象成了一个对象——Candidate（候选人）。当候选人创建一个 P2P 连接的时候，它会获得候选人的身份。但这个时候，它还没有发起任何真实的数据连接。此时它必须知道另一个人的身份，才能够进行通信。</p>
<p><strong>P2P 网络本身不具备传输身份的能力，因此这个时候需要另一个第三方网络提供身份的交换</strong>。代码中的这个第三方服务就是 ScaleDrone。当用户加入聊天室，会先创建连接：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pc = <span class="keyword">new</span> RTCPeerConnection(...)</span><br></pre></td></tr></table></figure>
<p>接下来会触发<code>onicecanddiate</code>事件获得候选人（Candidate）身份：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pc.onicecandidate = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (event.candidate) &#123;</span><br><span class="line">     <span class="comment">// 通过ScaleDrone分发身份</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>在实际的代码操作中，代码将获得的身份（event.candiate）直接发送到了 ScaleDrone 提供的某个聊天室中去，这样聊天室的其他用户就会拿到这个身份。</p>
<p>当有新用户进入聊天室后，ScaleDrone 会广播新用户的身份：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">room.on(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">message, client</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Message was sent by us</span></span><br><span class="line">  <span class="keyword">if</span> (client.id === drone.clientId) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (message.sdp) &#123;</span><br><span class="line">    <span class="comment">// This is called after receiving an offer or answer from another peer</span></span><br><span class="line">    pc.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(message.sdp), <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// When receiving an offer lets answer it</span></span><br><span class="line">      <span class="keyword">if</span> (pc.remoteDescription.type === <span class="string">&#x27;offer&#x27;</span>) &#123;</span><br><span class="line">        pc.createAnswer().then(localDescCreated).catch(onError);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, onError);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.candidate) &#123;</span><br><span class="line">    <span class="comment">// Add the new ICE candidate to our connections remote description</span></span><br><span class="line">    pc.addIceCandidate(</span><br><span class="line">      <span class="keyword">new</span> RTCIceCandidate(message.candidate), onSuccess, onError</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这个时候，用户彼此都会将对方加入自己的候选人列表：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pc.addIceCandidate(</span><br><span class="line">  <span class="keyword">new</span> RTCIceCandidate(message.candidate), onSuccess, onError</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>加入之后，如果远程候选人录制了视频，WebRTC 的 ontract 事件就会收到视频的数据流，也就是下面这段程序：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pc.ontrack = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> stream = event.streams[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (!remoteVideo.srcObject || remoteVideo.srcObject.id !== stream.id) &#123;</span><br><span class="line">    remoteVideo.srcObject = stream;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这份代码的优势是不需要提供中转的流媒体服务器，就可以完成点到点的视频通信。同理，如果是多人视频，也可以用同样的方法实现。这段程序中需要两个第三方的服务：</p>
<ol>
<li>
<p>基于 ICE 标准提供 P2P 网络的服务（提供 NAT 穿透能力），这个可以使用 STUN；</p>
</li>
<li>
<p>第三方聊天室服务，用于实现聊天的具体逻辑和交换身份。</p>
</li>
</ol>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Leo Liu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://liule8.github.io/post/ee104761.html">https://liule8.github.io/post/ee104761.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://liule8.github.io" target="_blank">Leo's notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/27c4fbe1.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">计算机网络通关之Web 技术-爬虫和反爬虫</div></div></a></div><div class="next-post pull-right"><a href="/post/4764a1e7.html"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">计算机网络通关之Web 技术-HTTP 协议</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/462e1124.html" title="计算机网络通关之Web 技术-DNS 域名解析系统"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-03</div><div class="title">计算机网络通关之Web 技术-DNS 域名解析系统</div></div></a></div><div><a href="/post/4764a1e7.html" title="计算机网络通关之Web 技术-HTTP 协议"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-04</div><div class="title">计算机网络通关之Web 技术-HTTP 协议</div></div></a></div><div><a href="/post/cbe8db1a.html" title="计算机网络通关之Web 技术-内容分发网络"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-03</div><div class="title">计算机网络通关之Web 技术-内容分发网络</div></div></a></div><div><a href="/post/27c4fbe1.html" title="计算机网络通关之Web 技术-爬虫和反爬虫"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-04</div><div class="title">计算机网络通关之Web 技术-爬虫和反爬虫</div></div></a></div><div><a href="/post/4b2a9439.html" title="计算机网络通关之互联网和传输层协议-TCP 为什么握手是 3 次、挥手是 4 次?"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-30</div><div class="title">计算机网络通关之互联网和传输层协议-TCP 为什么握手是 3 次、挥手是 4 次?</div></div></a></div><div><a href="/post/4c972dc0.html" title="计算机网络通关之互联网和传输层协议-TCP 为什么要粘包和拆包?"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-30</div><div class="title">计算机网络通关之互联网和传输层协议-TCP 为什么要粘包和拆包?</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Leo Liu</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">428</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">84</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">51</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/liule8"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/LIULE8" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:leo.liu.scau@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">这里是公告</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">流媒体技术：直播网站是如何实现的？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%AA%92%E4%BD%93"><span class="toc-number">1.1.</span> <span class="toc-text">流媒体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B5%81%E5%AA%92%E4%BD%93%E7%9A%84%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">基于流媒体的架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%92%AD"><span class="toc-number">1.2.1.</span> <span class="toc-text">直播</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%9F%B3%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99"><span class="toc-number">1.2.2.</span> <span class="toc-text">其他音视频网站</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E7%9A%84%E7%BC%96%E7%A0%81%E5%92%8C%E8%A7%A3%E7%A0%81"><span class="toc-number">1.3.</span> <span class="toc-text">视频的编码和解码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8F%E5%9D%97"><span class="toc-number">1.3.1.</span> <span class="toc-text">宏块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E5%88%B0%E7%82%B9%E8%A7%86%E9%A2%91%E6%8A%80%E6%9C%AF"><span class="toc-number">1.4.</span> <span class="toc-text">点到点视频技术</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83%E9%A2%98"><span class="toc-number">1.6.</span> <span class="toc-text">思考题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%A7%A3%E7%AD%94"><span class="toc-number">1.6.1.</span> <span class="toc-text">其他解答</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/da59c978.html" title="Java并发编程(二)"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java并发编程(二)"/></a><div class="content"><a class="title" href="/post/da59c978.html" title="Java并发编程(二)">Java并发编程(二)</a><time datetime="2021-12-06T20:31:07.000Z" title="发表于 2021-12-06 20:31:07">2021-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/a50eaa86.html" title="数据结构与算法之高级篇-位图"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之高级篇-位图"/></a><div class="content"><a class="title" href="/post/a50eaa86.html" title="数据结构与算法之高级篇-位图">数据结构与算法之高级篇-位图</a><time datetime="2021-12-06T19:59:30.000Z" title="发表于 2021-12-06 19:59:30">2021-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/accf4e02.html" title="数据结构与算法之高级篇-最短路径"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之高级篇-最短路径"/></a><div class="content"><a class="title" href="/post/accf4e02.html" title="数据结构与算法之高级篇-最短路径">数据结构与算法之高级篇-最短路径</a><time datetime="2021-12-04T13:03:30.000Z" title="发表于 2021-12-04 13:03:30">2021-12-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/4233c11f.html" title="数据结构与算法之高级篇-拓扑排序"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之高级篇-拓扑排序"/></a><div class="content"><a class="title" href="/post/4233c11f.html" title="数据结构与算法之高级篇-拓扑排序">数据结构与算法之高级篇-拓扑排序</a><time datetime="2021-12-04T12:25:30.000Z" title="发表于 2021-12-04 12:25:30">2021-12-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/c24b527c.html" title="数据结构与算法之基础篇-动态规划实战"><img src="/images/posts/cover/dataStructuresAndAlgorithms.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构与算法之基础篇-动态规划实战"/></a><div class="content"><a class="title" href="/post/c24b527c.html" title="数据结构与算法之基础篇-动态规划实战">数据结构与算法之基础篇-动态规划实战</a><time datetime="2021-12-02T19:39:46.000Z" title="发表于 2021-12-02 19:39:46">2021-12-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Leo Liu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', '', 'katex-wrap')
  })
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>