<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring Security (一) 架构框架-Component、Service、Filter分析 | Leo's notes</title><meta name="keywords" content="Spring,Spring Security"><meta name="author" content="Leo Liu"><meta name="copyright" content="Leo Liu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="【转载】 作者：Ccww 链接：https:&#x2F;&#x2F;juejin.im&#x2F;post&#x2F;5d074dc1f265da1bce3dd10f  Spring security （一）架构框架-Component、Service、Filter分析想要深入spring security的authentication （身份验证）和access-control（访问权限控制）工作流程，必须清楚spring secu">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Security (一) 架构框架-Component、Service、Filter分析">
<meta property="og:url" content="https://liule8.github.io/post/448cdc3a.html">
<meta property="og:site_name" content="Leo&#39;s notes">
<meta property="og:description" content="【转载】 作者：Ccww 链接：https:&#x2F;&#x2F;juejin.im&#x2F;post&#x2F;5d074dc1f265da1bce3dd10f  Spring security （一）架构框架-Component、Service、Filter分析想要深入spring security的authentication （身份验证）和access-control（访问权限控制）工作流程，必须清楚spring secu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-05-30T12:47:26.000Z">
<meta property="article:modified_time" content="2021-10-16T05:06:48.953Z">
<meta property="article:author" content="Leo Liu">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="Spring Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liule8.github.io/post/448cdc3a"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-16 05:06:48'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/images/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">347</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">46</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Leo's notes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Security (一) 架构框架-Component、Service、Filter分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-05-30T12:47:26.000Z" title="发表于 2020-05-30 12:47:26">2020-05-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-10-16T05:06:48.953Z" title="更新于 2021-10-16 05:06:48">2021-10-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/">Spring</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Spring/Spring-Security/">Spring Security</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring Security (一) 架构框架-Component、Service、Filter分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>【转载】</p>
<p>作者：Ccww</p>
<p>链接：<a target="_blank" rel="noopener" href="https://juejin.im/post/5d074dc1f265da1bce3dd10f">https://juejin.im/post/5d074dc1f265da1bce3dd10f</a></p>
</blockquote>
<h1 id="Spring-security-（一）架构框架-Component、Service、Filter分析"><a href="#Spring-security-（一）架构框架-Component、Service、Filter分析" class="headerlink" title="Spring security （一）架构框架-Component、Service、Filter分析"></a>Spring security （一）架构框架-Component、Service、Filter分析</h1><pre><code>想要深入spring security的authentication （身份验证）和access-control（访问权限控制）工作流程，必须清楚spring security的主要技术点包括关键接口、类以及抽象类如何协同工作进行authentication 和access-control的实现。</code></pre><h2 id="Spring-Security-认证和授权流程"><a href="#Spring-Security-认证和授权流程" class="headerlink" title="Spring Security 认证和授权流程"></a>Spring Security 认证和授权流程</h2><p>常见认证和授权流程可以分成：</p>
<ol>
<li>A user is prompted to log in with a username and password （用户用账密码登录）</li>
<li>The system (successfully) verifies that the password is correct for the username（校验密码正确性）</li>
<li>The context information for that user is obtained (their list of roles and so on).（获取用户信息context，如权限）</li>
<li>A security context is established for the user（为用户创建security context）</li>
<li>The user proceeds, potentially to perform some operation which is potentially protected by an access control mechanism which checks the required permissions for the operation against the current security context information.（访问权限控制，是否具有访问权限）</li>
</ol>
<h3 id="Spring-Security-认证"><a href="#Spring-Security-认证" class="headerlink" title="Spring Security 认证"></a>Spring Security 认证</h3><p>上述前三点为spring security认证验证环节：</p>
<ol>
<li>通常通过<code>AbstractAuthenticationProcessingFilter</code>过滤器将账号密码组装成Authentication实现类<code>UsernamePasswordAuthenticationToken</code>；</li>
<li>将token传递给AuthenticationManager验证是否有效，而AuthenticationManager通常使用<code>ProviderManager</code>实现类来检验；</li>
<li><code>AuthenticationManager</code>认证成功后将返回一个拥有详细信息的Authentication object（包括权限信息，身份信息，细节信息，但密码通常会被移除）；</li>
<li>通过<code>SecurityContextHolder.getContext().getAuthentication().getPrincipal()</code>将Authentication设置到security context中。</li>
</ol>
<h3 id="Spring-Security-访问授权"><a href="#Spring-Security-访问授权" class="headerlink" title="Spring Security 访问授权"></a>Spring Security 访问授权</h3><ol>
<li>通过<code>FilterSecurityInterceptor</code>过滤器入口进入；</li>
<li><code>FilterSecurityInterceptor</code>通过其继承的抽象类AbstractSecurityInterceptor的<code>beforeInvocation(Object object)</code>方法进行访问授权，其中涉及了类<code>AuthenticationManager</code>、<code>AccessDecisionManager</code>、<code>SecurityMetadataSource</code>等。</li>
</ol>
<p>根据上述描述的过程，我们接下来主要去分析其中涉及的一下Component、Service、Filter。</p>
<h2 id="核心组件（Core-Component-）"><a href="#核心组件（Core-Component-）" class="headerlink" title="核心组件（Core Component ）"></a>核心组件（Core Component ）</h2><h3 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h3><pre><code>`SecurityContextHolder`提供对`SecurityContext`的访问，存储security context（用户信息、角色权限等），而且其具有下列储存策略即工作模式：</code></pre><ol>
<li><code>SecurityContextHolder.MODE_THREADLOCAL</code>（默认）：使用<code>ThreadLocal</code>，信息可供此线程下的所有的方法使用，一种与线程绑定的策略，此天然很适合Servlet Web应用。</li>
<li><code>SecurityContextHolder.MODE_GLOBAL</code>：使用于独立应用</li>
<li><code>SecurityContextHolder.MODE_INHERITABLETHREADLOCAL</code>：具有相同安全标示的线程</li>
</ol>
<p>修改<code>SecurityContextHolder</code>的工作模式有两种方法 :</p>
<ol>
<li>设置一个系统属性(system.properties) : spring.security.strategy;</li>
<li>调用<code>SecurityContextHolder</code>静态方法<code>setStrategyName()</code></li>
</ol>
<p>在默认<code>ThreadLocal</code>策略中，<code>SecurityContextHolder</code>为静态方法获取用户信息为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal(); </span><br><span class="line"><span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails) &#123;      </span><br><span class="line">     String username = ((UserDetails)principal).getUsername();  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     String username = principal.toString();     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是一般不需要自身去获取。 其中<code>getAuthentication()</code>返回一个<code>Authentication</code>认证主体，接下来分析<code>Authentication</code>、<code>UserDetails</code>细节。</p>
<h3 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h3><pre><code>Spring Security使用一个`Authentication`对象来描述当前用户的相关信息,其包含用户拥有的权限信息列表、用户细节信息（身份信息、认证信息）。`Authentication`为认证主体在spring security中时最高级别身份/认证的抽象，常见的实现类`UsernamePasswordAuthenticationToken`。`Authentication`接口源码：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123; </span><br><span class="line">    <span class="comment">//权限信息列表,默认GrantedAuthority接口的一些实现类</span></span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); </span><br><span class="line">    <span class="comment">//密码信息</span></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//细节信息，web应用中的实现接口通常为 WebAuthenticationDetails，它记录了访问者的ip地址和sessionId的值</span></span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//通常返回值为UserDetails实现类</span></span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面两个组件都涉及了UserDetails，以及GrantedAuthority其到底是什么呢？2.3小节分析。</p>
<h3 id="UserDetails-amp-GrantedAuthority"><a href="#UserDetails-amp-GrantedAuthority" class="headerlink" title="UserDetails&amp;GrantedAuthority"></a>UserDetails&amp;GrantedAuthority</h3><pre><code>UserDetails提供从应用程序的DAO或其他安全数据源构建Authentication对象所需的信息，包含GrantedAuthority。其官方实现类为User，开发者可以实现其接口自定义UserDetails实现类。其接口源码：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">     <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>UserDetails与Authentication接口功能类似，其含义是Authentication为用户提交的认证凭证（账号密码）；</code></pre><p>​        UserDetails为系统中用户正确认证凭证；</p>
<p>​        UserDetailsService中的loadUserByUsername方法获取正确的认证凭证；</p>
<pre><code>其中在getAuthorities()方法中获取到GrantedAuthority列表是代表用户访问应用程序权限范围，此类权限通常是“role(角色）”，例如`ROLE_ADMINISTRATOR`或`ROLE_HR_SUPERVISOR`；</code></pre><p>​        GrantedAuthority接口常见的实现类SimpleGrantedAuthority。</p>
<h2 id="核心服务类（Core-Services）"><a href="#核心服务类（Core-Services）" class="headerlink" title="核心服务类（Core Services）"></a>核心服务类（Core Services）</h2><h3 id="AuthenticationManager、ProviderManager以及AuthenticationProvider"><a href="#AuthenticationManager、ProviderManager以及AuthenticationProvider" class="headerlink" title="AuthenticationManager、ProviderManager以及AuthenticationProvider"></a>AuthenticationManager、ProviderManager以及AuthenticationProvider</h3><pre><code>`AuthenticationManager`是认证相关的核心接口，是认证一切的起点。</code></pre><p>​         <strong><em>常见的认证流程都是AuthenticationManager实现类ProviderManager处理</em></strong>，而且ProviderManager实现类基于委托者模式维护<code>AuthenticationProvider</code> 列表用于不同的认证方式。例如：</p>
<ol>
<li>使用<strong>账号密码</strong>认证方式<code>DaoAuthenticationProvider</code>实现类（继承了AbstractUserDetailsAuthenticationProvide抽象类），其为默认认证方式，进行数据库库获取认证数据信息。</li>
<li><strong>游客</strong>身份登录认证方式<code>AnonymousAuthenticationProvider</code>实现类</li>
<li>从<strong>cookies</strong>获取认证方式<code>RememberMeAuthenticationProvider</code>实现类</li>
</ol>
<p><code>ProviderManager</code>源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">	Class&lt;? extends Authentication&gt; toTest = authentication.getClass();</span><br><span class="line">	AuthenticationException lastException = <span class="keyword">null</span>;</span><br><span class="line">	Authentication result = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//AuthenticationProvider列表依次认证</span></span><br><span class="line">	<span class="keyword">for</span> (AuthenticationProvider provider : getProviders()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!provider.supports(toTest)) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//每个AuthenticationProvider进行认证</span></span><br><span class="line">			result = provider.authenticate(authentication)</span><br><span class="line">			<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">				copyDetails(authentication, result);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		....</span><br><span class="line">		<span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">			lastException = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//进行父类AuthenticationProvider进行认证</span></span><br><span class="line">	<span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// Allow the parent to try.</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			result = parent.authenticate(authentication);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">			lastException = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	   <span class="comment">// 如果有Authentication信息，则直接返回</span></span><br><span class="line">	<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (eraseCredentialsAfterAuthentication</span><br><span class="line">				&amp;&amp; (result <span class="keyword">instanceof</span> CredentialsContainer)) &#123;</span><br><span class="line">				<span class="comment">//清除密码</span></span><br><span class="line">			((CredentialsContainer) result).eraseCredentials();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//发布登录成功事件</span></span><br><span class="line">		eventPublisher.publishAuthenticationSuccess(result);</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">//如果都没认证成功，抛出异常</span></span><br><span class="line">	<span class="keyword">if</span> (lastException == <span class="keyword">null</span>) &#123;</span><br><span class="line">		lastException = <span class="keyword">new</span> ProviderNotFoundException(messages.getMessage(</span><br><span class="line">				<span class="string">&quot;ProviderManager.providerNotFound&quot;</span>,</span><br><span class="line">				<span class="keyword">new</span> Object[] &#123; toTest.getName() &#125;,</span><br><span class="line">				<span class="string">&quot;No AuthenticationProvider found for &#123;0&#125;&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	prepareException(lastException, authentication);</span><br><span class="line">	<span class="keyword">throw</span> lastException;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<pre><code>ProviderManager 中的`List&lt;AuthenticationProvider&gt;`，会**依照次序**去认证；</code></pre><p>​         默认策略下，只需要通过一个<code>AuthenticationProvider</code>的认证，即可被认为是登录成功，而且认证成功后返回一个<code>Authentication</code>实体，并为了安全会进行清除密码。</p>
<p>​        如果所有认证器都无法认证成功，则ProviderManager 会抛出一个<code>ProviderNotFoundException</code>异常。</p>
<h3 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h3><pre><code>UserDetailsService接口作用是从特定的地方获取认证的数据源（账号、密码）。如何获取到系统中正确的认证凭证，通过`loadUserByUsername(String username)`获取认证信息，而且其只有一个方法：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;  </span><br></pre></td></tr></table></figure>

<p>​    UserDetailsService常见的实现类</p>
<ol>
<li>从数据库获取的JdbcDaoImpl实现类，</li>
<li>从内存中获取的InMemoryUserDetailsManager实现类，</li>
<li>….</li>
<li>自定义UserDetailsService实现类，如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="comment">//用户mapper</span></span><br><span class="line"> <span class="keyword">private</span> UserInfoMapper userInfoMapper;</span><br><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="comment">//用户权限mapper</span></span><br><span class="line"> <span class="keyword">private</span> PermissionInfoMapper permissionInfoMapper;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">    UserInfoDTO userInfo = userInfoMapper.getUserInfoByUserName(username);</span><br><span class="line">    <span class="keyword">if</span> (userInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;PermissionInfoDTO&gt; permissionInfoDTOS = permissionInfoMapper.findByAdminUserId(userInfo.getId());</span><br><span class="line">        List&lt;GrantedAuthority&gt; grantedAuthorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//组装权限GrantedAuthority object</span></span><br><span class="line">        <span class="keyword">for</span> (PermissionInfoDTO permissionInfoDTO : permissionInfoDTOS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionInfoDTO != <span class="keyword">null</span> &amp;&amp; permissionInfoDTO.getPermissionName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                GrantedAuthority grantedAuthority = <span class="keyword">new</span> SimpleGrantedAuthority(</span><br><span class="line">                        permissionInfoDTO.getPermissionName());</span><br><span class="line">                grantedAuthorityList.add(grantedAuthority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回用户信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(userInfo.getUserName(), userInfo.getPasswaord(), grantedAuthorityList);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//抛出用户不存在异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">&quot;admin&quot;</span> + username + <span class="string">&quot;do not exist&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<h3 id="AccessDecisionManager-amp-SecurityMetadataSource"><a href="#AccessDecisionManager-amp-SecurityMetadataSource" class="headerlink" title="AccessDecisionManager&amp;SecurityMetadataSource"></a>AccessDecisionManager&amp;SecurityMetadataSource</h3><pre><code>AccessDecisionManager是由AbstractSecurityInterceptor调用，负责做出最终的访问控制决策。</code></pre><p>AccessDecisionManager接口源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//访问控制决策</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object secureObject,Collection&lt;ConfigAttribute&gt; attrs)</span> <span class="keyword">throws</span> AccessDeniedException</span>;</span><br><span class="line"> <span class="comment">//是否支持处理传递的ConfigAttribute</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span></span>;</span><br><span class="line"> <span class="comment">//确认class是否为AccessDecisionManager</span></span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class clazz)</span></span>;</span><br></pre></td></tr></table></figure>

<pre><code>SecurityMetadataSource包含着AbstractSecurityInterceptor访问授权所需的元数据（动态url、动态授权所需的数据）；在AbstractSecurityInterceptor授权模块中结合AccessDecisionManager进行访问授权，其涉及了ConfigAttribute。 </code></pre><p>SecurityMetadataSource接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object object)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们还可以自定义SecurityMetadataSource数据源，实现接口FilterInvocationSecurityMetadataSource。例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFilterSecurityMetadataSource</span> <span class="keyword">implements</span> <span class="title">FilterInvocationSecurityMetadataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        FilterInvocation fi = (FilterInvocation) object;</span><br><span class="line">        String url = fi.getRequestUrl();</span><br><span class="line">        String httpMethod = fi.getRequest().getMethod();</span><br><span class="line">        List&lt;ConfigAttribute&gt; attributes = <span class="keyword">new</span> ArrayList&lt;ConfigAttribute&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lookup your database (or other source) using this information and populate the</span></span><br><span class="line">        <span class="comment">// list of attributes</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation.class.isAssignableFrom(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h3><pre><code>为了存储安全，一般要对密码进行算法加密。</code></pre><p>Spring Security提供了加密<code>PasswordEncoder</code>接口。其实现类有：</p>
<ol>
<li><p>BCrypt hash算法实现的<code>BCryptPasswordEncoder</code>；</p>
</li>
<li><p>SCrypt hashing 算法实现的<code>SCryptPasswordEncoder</code>；</p>
</li>
</ol>
<p>PasswordEncoder接口只有两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="comment">//密码加密</span></span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span>;</span><br><span class="line">    <span class="comment">//密码配对</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="核心-Security-过滤器（Core-Security-Filters）"><a href="#核心-Security-过滤器（Core-Security-Filters）" class="headerlink" title="核心 Security 过滤器（Core Security Filters）"></a>核心 Security 过滤器（Core Security Filters）</h2><h3 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a>FilterSecurityInterceptor</h3><pre><code>`FilterSecurityInterceptor`是Spring Security**授权模块入口**，该类根据访问的用户的角色，权限授权访问那些资源（访问特定路径应该具备的权限）。
`FilterSecurityInterceptor`封装`FilterInvocation`对象进行操作；</code></pre><p>​           所有的请求到了<code>FilterSecurityInterceptor</code>，如果这个filter之前没有执行过的话，那么首先执行其父类<code>AbstractSecurityInterceptor</code>提供的<code>InterceptorStatusToken token = super.beforeInvocation(fi)</code>，该方法会：</p>
<ol>
<li>使用AuthenticationManager获取Authentication中用户详情；</li>
<li>使用ConfigAttribute封装已定义好访问权限详情；</li>
<li>使用AccessDecisionManager.decide()方法进行访问权限控制。</li>
</ol>
<p><code>FilterSecurityInterceptor</code>源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((fi.getRequest() != <span class="keyword">null</span>)</span><br><span class="line">			&amp;&amp; (fi.getRequest().getAttribute(FILTER_APPLIED) != <span class="keyword">null</span>)</span><br><span class="line">			&amp;&amp; observeOncePerRequest) &#123;</span><br><span class="line">		fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// first time this request being called, so perform security checking</span></span><br><span class="line">		<span class="keyword">if</span> (fi.getRequest() != <span class="keyword">null</span> &amp;&amp; observeOncePerRequest) &#123;</span><br><span class="line">			fi.getRequest().setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//回调其继承的抽象类AbstractSecurityInterceptor的方法</span></span><br><span class="line">		InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">super</span>.finallyInvocation(token);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractSecurityInterceptor源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">	....</span><br><span class="line">	<span class="comment">//获取所有访问权限（url-role）属性列表（已定义在数据库或者其他地方）</span></span><br><span class="line">	Collection&lt;ConfigAttribute&gt; attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource()</span><br><span class="line">			.getAttributes(object);</span><br><span class="line">	....</span><br><span class="line">	<span class="comment">//获取该用户访问信息（包括url，访问权限）</span></span><br><span class="line">	Authentication authenticated = authenticateIfRequired();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attempt authorization</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    <span class="comment">//进行授权访问</span></span><br><span class="line">		<span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</span><br><span class="line">	&#125;<span class="keyword">catch</span></span><br><span class="line">	....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="UsernamePasswordAuthenticationFilter"><a href="#UsernamePasswordAuthenticationFilter" class="headerlink" title="UsernamePasswordAuthenticationFilter"></a>UsernamePasswordAuthenticationFilter</h3><pre><code>`UsernamePasswordAuthenticationFilter`使用username和password表单登录使用的过滤器，也是**最常用的**过滤器。其源码：</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">    HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">     <span class="comment">//获取表单中的用户名和密码</span></span><br><span class="line">     String username = obtainUsername(request);</span><br><span class="line">     String password = obtainPassword(request);</span><br><span class="line">     ...</span><br><span class="line">     username = username.trim();</span><br><span class="line">     <span class="comment">//组装成username+password形式的token</span></span><br><span class="line">     UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">     username, password);</span><br><span class="line">     <span class="comment">// Allow subclasses to set the &quot;details&quot; property</span></span><br><span class="line">     setDetails(request, authRequest);</span><br><span class="line">     <span class="comment">//交给内部的AuthenticationManager去认证，并返回认证信息</span></span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<pre><code>其主要代码为创建`UsernamePasswordAuthenticationToken`的Authentication实体以及调用AuthenticationManager进行authenticate认证，根据认证结果执行successfulAuthentication或者unsuccessfulAuthentication，无论成功失败，一般的实现都是转发或者重定向等处理，不再细究AuthenticationSuccessHandler和AuthenticationFailureHandle。若有兴趣，可以研究一下其父类AbstractAuthenticationProcessingFilter过滤器。</code></pre><h3 id="AnonymousAuthenticationFilter"><a href="#AnonymousAuthenticationFilter" class="headerlink" title="AnonymousAuthenticationFilter"></a>AnonymousAuthenticationFilter</h3><p><code>AnonymousAuthenticationFilter</code>是匿名登录过滤器，它位于常用的身份认证过滤器（如UsernamePasswordAuthenticationFilter、BasicAuthenticationFilter、RememberMeAuthenticationFilter）之后，意味着只有在上述身份过滤器执行完毕后，SecurityContext依旧没有用户信息，AnonymousAuthenticationFilter该过滤器才会有意义——给<strong>当前请求</strong>一个匿名身份。</p>
<p> AnonymousAuthenticationFilter源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnonymousAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">	<span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AnonymousAuthenticationFilter</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">this</span>(key, <span class="string">&quot;anonymousUser&quot;</span>, AuthorityUtils.createAuthorityList(<span class="string">&quot;ROLE_ANONYMOUS&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">		    <span class="comment">//创建匿名登录Authentication的信息</span></span><br><span class="line">	    	SecurityContextHolder.getContext().setAuthentication(</span><br><span class="line">			    	createAuthentication((HttpServletRequest) req));</span><br><span class="line">		    		...</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    chain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建匿名登录Authentication的信息方法</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Authentication <span class="title">createAuthentication</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">	    AnonymousAuthenticationToken auth = <span class="keyword">new</span> AnonymousAuthenticationToken(key,</span><br><span class="line">			principal, authorities);</span><br><span class="line">	    auth.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">	    <span class="keyword">return</span> auth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SecurityContextPersistenceFilter"><a href="#SecurityContextPersistenceFilter" class="headerlink" title="SecurityContextPersistenceFilter"></a>SecurityContextPersistenceFilter</h3><pre><code>SecurityContextPersistenceFilter的两个主要作用：</code></pre><ol>
<li>当Request过来时，创建SecurityContext安全上下文信息</li>
<li>当Request结束时，清空SecurityContextHolder。</li>
</ol>
<h2 id="小节总结："><a href="#小节总结：" class="headerlink" title="小节总结："></a>小节总结：</h2><p>. AbstractAuthenticationProcessingFilter:主要处理登录<br>. FilterSecurityInterceptor:主要处理鉴权</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Leo Liu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://liule8.github.io/post/448cdc3a.html">https://liule8.github.io/post/448cdc3a.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://liule8.github.io" target="_blank">Leo's notes</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring/">Spring</a><a class="post-meta__tags" href="/tags/Spring-Security/">Spring Security</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/d80a5efb.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring Security (二) WebSecurityConfigurer和filter的配置</div></div></a></div><div class="next-post pull-right"><a href="/post/72e5cf06.html"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">同源策略</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/d80a5efb.html" title="Spring Security (二) WebSecurityConfigurer和filter的配置"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-30</div><div class="title">Spring Security (二) WebSecurityConfigurer和filter的配置</div></div></a></div><div><a href="/post/2ce024a1.html" title="Spring Security之OAuth2与微服务-令牌拓展"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-30</div><div class="title">Spring Security之OAuth2与微服务-令牌拓展</div></div></a></div><div><a href="/post/706341e5.html" title="Spring Security之OAuth2与微服务-开放协议"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-27</div><div class="title">Spring Security之OAuth2与微服务-开放协议</div></div></a></div><div><a href="/post/5b88b24b.html" title="Spring Security之OAuth2与微服务-授权体系"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-29</div><div class="title">Spring Security之OAuth2与微服务-授权体系</div></div></a></div><div><a href="/post/996ec62b.html" title="Spring Security之OAuth2与微服务-案例实战(一)"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-31</div><div class="title">Spring Security之OAuth2与微服务-案例实战(一)</div></div></a></div><div><a href="/post/365f5d49.html" title="Spring Security之OAuth2与微服务-案例实战(二)"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-31</div><div class="title">Spring Security之OAuth2与微服务-案例实战(二)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/images/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Leo Liu</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">347</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">82</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">46</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/liule8"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/LIULE8" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:leo.liu.scau@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">这里是公告</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-security-%EF%BC%88%E4%B8%80%EF%BC%89%E6%9E%B6%E6%9E%84%E6%A1%86%E6%9E%B6-Component%E3%80%81Service%E3%80%81Filter%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">Spring security （一）架构框架-Component、Service、Filter分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Security-%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">Spring Security 认证和授权流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Security-%E8%AE%A4%E8%AF%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">Spring Security 认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Security-%E8%AE%BF%E9%97%AE%E6%8E%88%E6%9D%83"><span class="toc-number">1.1.2.</span> <span class="toc-text">Spring Security 访问授权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%EF%BC%88Core-Component-%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">核心组件（Core Component ）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContextHolder"><span class="toc-number">1.2.1.</span> <span class="toc-text">SecurityContextHolder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication"><span class="toc-number">1.2.2.</span> <span class="toc-text">Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDetails-amp-GrantedAuthority"><span class="toc-number">1.2.3.</span> <span class="toc-text">UserDetails&amp;GrantedAuthority</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E7%B1%BB%EF%BC%88Core-Services%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">核心服务类（Core Services）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AuthenticationManager%E3%80%81ProviderManager%E4%BB%A5%E5%8F%8AAuthenticationProvider"><span class="toc-number">1.3.1.</span> <span class="toc-text">AuthenticationManager、ProviderManager以及AuthenticationProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDetailsService"><span class="toc-number">1.3.2.</span> <span class="toc-text">UserDetailsService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AccessDecisionManager-amp-SecurityMetadataSource"><span class="toc-number">1.3.3.</span> <span class="toc-text">AccessDecisionManager&amp;SecurityMetadataSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PasswordEncoder"><span class="toc-number">1.3.4.</span> <span class="toc-text">PasswordEncoder</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83-Security-%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%88Core-Security-Filters%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">核心 Security 过滤器（Core Security Filters）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FilterSecurityInterceptor"><span class="toc-number">1.4.1.</span> <span class="toc-text">FilterSecurityInterceptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UsernamePasswordAuthenticationFilter"><span class="toc-number">1.4.2.</span> <span class="toc-text">UsernamePasswordAuthenticationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AnonymousAuthenticationFilter"><span class="toc-number">1.4.3.</span> <span class="toc-text">AnonymousAuthenticationFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContextPersistenceFilter"><span class="toc-number">1.4.4.</span> <span class="toc-text">SecurityContextPersistenceFilter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E8%8A%82%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">小节总结：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/45d4b33f.html" title="趣学设计模式之设计模式-装饰模式"><img src="/images/posts/cover/designPatterns.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="趣学设计模式之设计模式-装饰模式"/></a><div class="content"><a class="title" href="/post/45d4b33f.html" title="趣学设计模式之设计模式-装饰模式">趣学设计模式之设计模式-装饰模式</a><time datetime="2021-11-02T20:26:16.000Z" title="发表于 2021-11-02 20:26:16">2021-11-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/7c2227c6.html" title="趣学设计模式之设计模式-组合模式"><img src="/images/posts/cover/designPatterns.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="趣学设计模式之设计模式-组合模式"/></a><div class="content"><a class="title" href="/post/7c2227c6.html" title="趣学设计模式之设计模式-组合模式">趣学设计模式之设计模式-组合模式</a><time datetime="2021-11-02T19:38:06.000Z" title="发表于 2021-11-02 19:38:06">2021-11-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/f597d888.html" title="趣学设计模式之设计模式-桥接模式"><img src="/images/posts/cover/designPatterns.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="趣学设计模式之设计模式-桥接模式"/></a><div class="content"><a class="title" href="/post/f597d888.html" title="趣学设计模式之设计模式-桥接模式">趣学设计模式之设计模式-桥接模式</a><time datetime="2021-11-02T19:11:14.000Z" title="发表于 2021-11-02 19:11:14">2021-11-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/dc094afa.html" title="趣学设计模式之设计模式-适配器模式"><img src="/images/posts/cover/designPatterns.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="趣学设计模式之设计模式-适配器模式"/></a><div class="content"><a class="title" href="/post/dc094afa.html" title="趣学设计模式之设计模式-适配器模式">趣学设计模式之设计模式-适配器模式</a><time datetime="2021-11-01T20:29:55.000Z" title="发表于 2021-11-01 20:29:55">2021-11-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/32082cb7.html" title="趣学设计模式之设计模式-原型模式"><img src="/images/posts/cover/designPatterns.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="趣学设计模式之设计模式-原型模式"/></a><div class="content"><a class="title" href="/post/32082cb7.html" title="趣学设计模式之设计模式-原型模式">趣学设计模式之设计模式-原型模式</a><time datetime="2021-11-01T20:09:58.000Z" title="发表于 2021-11-01 20:09:58">2021-11-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Leo Liu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>